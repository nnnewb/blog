---
title: gokit æ¶æ„ä¹‹æˆ‘è§
slug: my-opinion-of-gokit-architecture
date: 2022-03-02 12:30:00
categories:
- golang
tags:
- gokit
- golang
- å¾®æœåŠ¡
---



## å‰è¨€

è¿™æ˜¯çœ‹äº† [Go kit: the road ahead](https://github.com/go-kit/kit/issues/843) ä¹‹åï¼Œå¯¹ go kit è¿™å¥—æŠ½è±¡çš„ä¸€äº›æƒ³æ³•ã€‚ä¸»è¦æ˜¯å…³äº endpoint æ˜¯å¦æœ‰å¿…è¦ã€generic ä¼šå¦‚ä½•å½±å“ go kit çš„æ¶æ„ã€go kit çš„ä»£ç ç”Ÿæˆè¿™äº›é—®é¢˜ã€‚

## endpoint æŠ½è±¡å±‚æ˜¯å¦å¿…è¦å­˜åœ¨

æˆ‘çš„çœ‹æ³•æ˜¯éœ€è¦ã€‚åŸå› ä¸‹é¢åˆ†æã€‚

ä¸€ä¸ªæ²¡æœ‰é¢å¤–åŠŸèƒ½çš„ Endpoint å…¶å®æ˜¯èµ·åˆ°äº†æŠŠè¯·æ±‚ç±»å‹é€‚é…åˆ° Go å‡½æ•°ç­¾åçš„ä½œç”¨ã€‚[stringsvc](http://gokit.io/examples/stringsvc.html#endpoints) å®ç°å¦‚ä¸‹ã€‚

```go
import (
	"context"
	"github.com/go-kit/kit/endpoint"
)

func makeUppercaseEndpoint(svc StringService) endpoint.Endpoint {
	return func(_ context.Context, request interface{}) (interface{}, error) {
		req := request.(uppercaseRequest)
		v, err := svc.Uppercase(req.S)
		if err != nil {
			return uppercaseResponse{v, err.Error()}, nil
		}
		return uppercaseResponse{v, ""}, nil
	}
}

func makeCountEndpoint(svc StringService) endpoint.Endpoint {
	return func(_ context.Context, request interface{}) (interface{}, error) {
		req := request.(countRequest)
		v := svc.Count(req.S)
		return countResponse{v}, nil
	}
}
```

å¯¹äºå†™è¿‡ rpcx æˆ–è€… gRPC çš„æœ‹å‹æ¥è¯´ï¼ŒEndpoint æ›´åƒæ˜¯ä¸ªè„±è£¤å­æ”¾å±çš„å°è£…ã€‚åªè¦æŠŠæ¥å£å‚æ•°çº¦å®šæˆ `func (ctx context.Context, req interface{}) (interface{}, error)` ä¸å°±å®Œäº†ï¼Ÿä¼ è¾“å±‚æ”¶åˆ°çš„è¯·æ±‚è§£ç æˆæœ¬åœ°æ•°æ®ç±»å‹ï¼Œç„¶åæŒ‰çº¦å®šä¼ å…¥ï¼Œå°±ä¸‡äº‹å¤§å‰äº†ã€‚

ç©ºå£æ— å‡­ï¼Œä¸å¦‚çœ‹çœ‹å¦‚æœä¸è¦ endpointï¼Œå®é™…ç¼–å†™çš„ä»£ç ä¼šå˜æˆä»€ä¹ˆæ ·ã€‚

åƒæ˜¯ go kit æä¾›çš„è¿™ç§å¸®åŠ©å‡½æ•°ï¼š

```go
uppercaseHandler := httptransport.NewServer(
    makeUppercaseEndpoint(svc),
    decodeUppercaseRequest,
    encodeResponse,
)

countHandler := httptransport.NewServer(
    makeCountEndpoint(svc),
    decodeCountRequest,
    encodeResponse,
)
```

å¯èƒ½å°±ä¼šå˜æˆè¿™æ ·ï¼š

```go
uppercaseHandler := httptransport.NewServer(
    svc.Uppercase,
    decodeUppercaseRequest,
    encodeResponse,
)

countHandler := httptransport.NewServer(
    svc.Count,
    decodeCountRequest,
    encodeResponse,
)
```

å½“ç„¶ï¼Œä¸ºäº†è®© Go è¯­è¨€çš„ç±»å‹ç³»ç»Ÿå¼€å¿ƒï¼Œè¿™é‡Œçš„ `svc.Uppercase` å’Œ `svc.Count` å¾—æ˜¯ä¸€æ ·çš„ç­¾åï¼Œæˆ–è€…ç”¨ `interface{}` åšå½¢å‚ï¼Œåˆæˆ–è€…è€ƒè™‘è¿˜æ²¡æœ‰å‘å¸ƒçš„æ³›å‹èƒ½ä¸èƒ½æ”¯æŒã€‚

çœ‹èµ·æ¥æ˜¯èˆ’æœäº†å¾ˆå¤šå¯¹å§ï¼ŸEndpoint æ²¡äº†ã€‚ä½†è¿˜æœ‰ä¸ªé—®é¢˜ï¼šä¸­é—´ä»¶ã€‚è¦æ€ä¹ˆå®ç°é€šç”¨çš„ä¸­é—´ä»¶ï¼Œåº”ç”¨åœ¨æ¯ä¸ªåŸæœ¬åº”è¯¥æ˜¯ Endpoint çš„åœ°æ–¹ï¼Ÿ

ä¾‹å¦‚åœ¨å¾®æœåŠ¡ç³»ç»Ÿé‡Œå¾ˆå¸¸è§çš„åˆ†å¸ƒå¼è·Ÿè¸ªã€metricsæ”¶é›†ï¼Œæ— è®ºæœ€ç»ˆé‡‡ç”¨çš„æ˜¯ opentracingã€opencecusã€opentelemetry è¿˜æ˜¯ zipkinã€prometheusï¼Œè·Ÿè¸ªè°ƒç”¨é“¾è·¯æ˜¯ä¸€ä¸ªå¾ˆåŸºæœ¬çš„å¯è§‚æµ‹æ€§è¦æ±‚ã€‚å½“ç„¶ï¼Œä½ å¯ä»¥è¯´ç”¨ linkerd ä¸€ç±»çš„ service mesh è§£å†³æ–¹æ¡ˆï¼ˆè™½ç„¶æˆ‘è§‰å¾—ä¸èƒ½æ›¿ä»£ä¸Šé¢æåˆ°çš„è¿™äº›ä¸œè¥¿ï¼‰ï¼Œä½†ä¹Ÿåº”è¯¥æœ‰æ‰€è­¦æƒ•ï¼šæˆ‘ä»¬æ˜¯ä¸æ˜¯è¿˜æœ‰éœ€è¦åœ¨æ¯ä¸ªæ¥å£ä¸Šéƒ½æ‰§è¡Œã€å’Œä¼ è¾“å±‚æ— å…³çš„ä»£ç ï¼Ÿå¯¹ï¼Œè¿˜æœ‰èº«ä»½éªŒè¯å’Œé‰´æƒå·¥ä½œã€‚è¿˜æœ‰å—ï¼Ÿ

å½“ç„¶ï¼Œä¹Ÿä¸æ˜¯è„±ç¦»äº† Endpoint å°±åˆ«æ— ä»–æ³•ï¼Œåªæ˜¯åœ¨éœ€è¦çš„æ—¶å€™ï¼Œæˆ‘æƒ³æ€»è¿˜æ˜¯ä¼šæœ‰æ„æ— æ„æŠ½è±¡å‡ºä¸€ä¸ªç±»ä¼¼ endpoint çš„å±‚çº§â€”â€”å¯èƒ½éšè—åœ¨ service ä¸­é—´ä»¶é‡Œï¼Œä¹Ÿå¯èƒ½äº¤ç»™äº†ä¼ è¾“å±‚ã€‚å¯èƒ½å†™å¾—æ›´å¥½ï¼Œä¹Ÿå¯èƒ½åˆæ˜¯åœ¨å †å±å±±ã€‚ç»éªŒå‘Šè¯‰æˆ‘åœ¨ä¸€ä¸ªéœ€è¦é•¿æœŸæ”¯æŒçš„ç³»ç»Ÿé‡Œï¼Œäººæ˜¯é ä¸ä½çš„ï¼Œä½†è§„èŒƒå¯ä»¥ã€‚endpoint å¹¶æ²¡æœ‰ç‰ºç‰²å¤šå°‘ç¼–ç ä¸Šçš„è‡ªç”±åº¦ï¼Œä½†ä¸€å®šç¨‹åº¦ä¸Šé¿å…äº†æ½œåœ¨çš„å †å±å¯èƒ½ï¼Œæˆ‘è§‰å¾—å®Œå…¨å¯ä»¥æ¥å—ã€‚

## generic ä¼šå¦‚ä½•å½±å“ go kit æ¶æ„

æˆ‘ç›´è¯´ï¼ŒGo çš„æ³›å‹ï¼ˆbeta1ï¼‰å°±æ˜¯ä¸€æ³¡ç‹—å±ï¼Œæˆ‘å‘æ¥ä¸å–œæ¬¢ Go å›¢é˜Ÿçš„å“å‘³ï¼Œä» slice å’Œ interface{} æ³„éœ²è¯­è¨€çš„å®ç°ç»†èŠ‚åˆ°å…¶ä»–æ›´ç¦»è°±çš„ä¸œè¥¿ã€‚ä½†ç°åœ¨ Go æ³›å‹è¿˜æ²¡æœ‰æ­£å¼å…¬å¸ƒï¼ˆé¢„æœŸå°±åœ¨æœ¬æœˆï¼‰ï¼Œç°åœ¨æˆ‘ä¹Ÿæ²¡ä»€ä¹ˆå¥½è¯„è®ºçš„ã€‚

generic ä¼šå½±å“ go kit çš„æ¶æ„å—ï¼Ÿæˆ‘çš„çœ‹æ³•æ˜¯ä¸ä¼šã€‚æ³›å‹ä¹Ÿè®¸èƒ½æå¤§å¸®åŠ©å„ç§å®¹å™¨ç±»å‹ã€è¿­ä»£å™¨ä¹‹ç±»é¥±å— `interface{}` æŠ˜ç£¨çš„ç»„ä»¶ï¼Œä½†æ˜¯ go kit ç”¨å¾—ä¸Šæ³›å‹çš„åœ°æ–¹å…¶å®ä¸å¤šã€‚å°‘æ•°å¸¸è§çš„ `interface{}` åœºåˆï¼Œéƒ½æ˜¯åœ¨ä»ä¸€ä¸ªç±»å‹é€‚é…åˆ°å¦ä¸€ä¸ªç±»å‹ï¼Œä»£ç ç¼–å†™è€…æ¸…æ¥šè‡ªå·±è¦å¤„ç†çš„ä¸¤ä¸ªç±»å‹ï¼Œä½† go kit ä¸çŸ¥é“ã€‚

```go
func makeUppercaseEndpoint(svc StringService) endpoint.Endpoint {
	return func(_ context.Context, request interface{}) (interface{}, error) {
		req := request.(uppercaseRequest)
		v, err := svc.Uppercase(req.S)
		if err != nil {
			return uppercaseResponse{v, err.Error()}, nil
		}
		return uppercaseResponse{v, ""}, nil
	}
}
```

è¿™éƒ¨åˆ†é€‚é…ä»£ç å¦‚æœæŠŠ `interface{}` æ›¿æ¢æˆå…·ä½“çš„ `uppercaseRequest` å’Œ `uppercaseResponse` çš„è¯ï¼Œå°±éœ€è¦ go kit æä¾›æ³›å‹å½¢å¼çš„ Endpoint æ¥å£äº†ï¼Œåƒæ˜¯è¿™æ ·ï¼š

```go
type Endpoint[RequestType,ResponseType] = func(context.Context, RequestType) (ResponseType, error)
```

ä¸Šé¢çš„ä»£ç æœ‰æ•ˆæ— æ•ˆå…ˆä¸è¯´ï¼Œæˆ‘è®°å¾—åœ¨ beta1 å°è¯•æ³›å‹çš„æ—¶å€™å‘ç° Go åœ¨æ¨æ–­ç±»å‹çš„æ—¶å€™å­˜åœ¨é—®é¢˜ï¼Œè¿™ä¸ª `RequestType` å’Œ `ResponseType` åœ¨å®é™…ç”¨çš„æ—¶å€™æ€•æ˜¯è¦å†™ä¸æ­¢ä¸€æ¬¡ã€‚åˆæ˜¯ Go ç‰¹è‰²çš„å•°å—¦ã€‚

å¯å³ä¾¿æ˜¯è¿™æ ·ææ€•è¿˜æœ‰é—®é¢˜ï¼Œå¦‚æœä¿®æ”¹äº† `Endpoint` çš„ç­¾åï¼Œé‚£ä¹ˆ `endpoint.Middleware` ææ€•ä¹Ÿè¦æ³›å‹åŒ–ï¼ŒåŸæ¥çš„æ‰€æœ‰ä¸­é—´ä»¶åº“ï¼Œ`trace`ã€`auth`ã€`metrics` å¯èƒ½ä¹Ÿå¾—åšæ³›å‹åŒ–æ”¹é€ ã€‚å¯¹ä¸€ä¸ªå·²ç»æ·±åº¦å¼€å‘è¿‡çš„ç³»ç»Ÿæ¥è¯´ï¼Œä¸ºäº†è¿™ä¸€ç‚¹ç±»å‹æ£€æŸ¥çš„å¥½å¤„ä»˜å‡ºå¦‚æ­¤ä»£ä»·ææ€•æ˜¯ä¸èƒ½æ¥å—çš„ã€‚

æ€»è€Œè¨€ä¹‹ï¼Œæˆ‘çš„è§‚ç‚¹æ˜¯ Generic å¯èƒ½å¸¦æ¥å˜åŒ–ï¼Œä½†æ ¹æœ¬ä¸Šçš„å‡ ä¸ªæŠ½è±¡ä¸å¤§å¯èƒ½è·Ÿç€é‡æ„ï¼Œè¿™æ˜¯ç”± go kit æ€§è´¨å†³å®šçš„ã€‚

## go kit ä»£ç ç”Ÿæˆ

ä½†å‡¡è·Ÿç€ go kit å†™è¿‡ä¸€ä¸ª stringsvc çš„äººéƒ½ä¼šæ„Ÿè§‰åˆ° go kit æœ‰å¤šå°‘æ ·æ¿ä»£ç ï¼Œé€‚é…ä¼ è¾“å±‚éœ€è¦ç¼–å†™ encode/decodeï¼Œæœ¬åœ°ç»“æ„è½¬å‡½æ•°ç­¾åæ‰€éœ€çš„å‚æ•°åˆè¦ä¸€æ¬¡è½¬æ¢ï¼Œä¼ è¾“å±‚åè®®ç›‘å¬ã€æ³¨å†Œ`Handler`ã€å®¢æˆ·ç«¯è¿æ¥éƒ½è¦è‡ªå·±ç¼–å†™ä»£ç ï¼Œæ„é€ å’Œæ³¨å†Œ `Endpoint` å¤æ‚æ€§æ— éæ˜¯ä» `func main` ç§»åŠ¨åˆ° `transport` æˆ–è€…åè¿‡æ¥ï¼Œå°½ç®¡å¾ˆçƒ¦ï¼Œä½†åˆæ— æ³•æ ¹æœ¬ä¸Šæ¶ˆé™¤ã€‚

å¦‚æœæ˜¯ C++ ææ€•ä¼šæœ‰æ¨¡æ¿å…ƒç¼–ç¨‹å¤§ä½¬æ™’è‡ªå·±çš„ `template`ï¼Œä½† Go åŸºæœ¬æ²¡æœ‰ç¼–è¯‘æ—¶å’Œè¿è¡Œæ—¶çš„å…ƒç¼–ç¨‹èƒ½åŠ›ã€‚å”¯ä¸€æ¯”è¾ƒæ“…é•¿çš„å°±åªæœ‰ä¸ªä»£ç ç”Ÿæˆäº†ã€‚Go æä¾›çš„ `ast/parser` åŒ…å¾ˆèµï¼Œåˆ«çš„è¯­è¨€å°‘æœ‰æä¾›è¿™ä¹ˆæ–¹ä¾¿çš„æ¥å£çš„ã€‚

go kit çš„ä»£ç ç”Ÿæˆï¼Œä»ç›®å‰ä½“éªŒä¸­æ„Ÿå—æ¥çœ‹ï¼Œä¸»è¦æ˜¯éœ€è¦ä¸‹é¢çš„åŠŸèƒ½ï¼š

1. ä» `interface` å®šä¹‰ç”Ÿæˆå¯¹åº”çš„ `makeEndpoint` å‡½æ•°å’Œè¯·æ±‚/å“åº”ç»“æ„ä½“ã€‚è¿™éƒ¨åˆ†ä»£ç åŸºæœ¬æ²¡ä»€ä¹ˆç‰¹åˆ«çš„ã€‚ 
2. ä» `interface` å®šä¹‰ç”Ÿæˆå¯¹åº”çš„ `transport` åŒ…ï¼Œå¯ä»¥è‡ªå·±é€‰æ‹©åè®®ã€‚ä¸»è¦è§£å†³ encode/decode æ‰‹å†™éº»çƒ¦çš„é—®é¢˜ã€‚
3. ä» `interface` å®šä¹‰ç”ŸæˆæœåŠ¡æ„é€ å’Œå¯åŠ¨ä»£ç ï¼Œåº”ç”¨å¯ä»¥è‡ªå·±æ„é€ ï¼Œä½† `endpoint` çš„æ„é€ å’Œ `middleware` çš„åº”ç”¨å°±å¯ä»¥ä¸ç”¨è‡ªå·±å†™äº†ã€‚

è¿™ä¸‰å¤„çš„æ ·æ¿ä»£ç æœ€å¤šï¼Œè€Œä¸”ä»£ç æœ¬èº«å¹¶ä¸ç‰¹åˆ«ï¼Œéƒ½æ˜¯ç®€å•åœ°å¯¹ç±»å‹è¿›è¡Œé€‚é…ï¼Œæ‰‹å†™å®Œå…¨æ˜¯æµªè´¹æ—¶é—´ï¼Œè¿˜ä¼šå¼•å…¥äººä¸ºçš„ä¸ç¡®å®šæ€§ï¼Œä¸å¦‚è®©æœºå™¨æå®šã€‚ç›®å‰è€ƒå¯Ÿè¿‡çš„ [kit](https://github.com/GrantZheng/kit) å®ç°äº†å…¶ä¸­ä¸€å¤§éƒ¨åˆ†ï¼Œä½† transport æ”¯æŒå¤ªå°‘ï¼Œä¹Ÿæ²¡æœ‰ç”Ÿæˆæ³¨å†Œ endpoint çš„ä»£ç ï¼Œä¾ç„¶å­˜åœ¨å¾ˆå¤šæ‰‹å†™çš„æ ·æ¿ä»£ç ã€‚æˆ‘ç®€å•çœ‹äº†ä¸‹å®ç°ï¼Œç”¨ [jennifer](https://github.com/dave/jennifer) ç”Ÿæˆä»£ç å¥½æ˜¯æŒºå¥½ï¼Œå°±æ˜¯ go ä»£ç æ˜¾å¾—æœ‰ç‚¹ä¹± ...

æˆ‘å¯»æ€å¯¹ generator ç®€å•é‡æ„ä¸‹å®ç°å…³æ³¨ç‚¹åˆ†ç¦»çš„è¯ï¼Œè¿˜æ˜¯èƒ½æ»¡è¶³ä¸Šé¢æåˆ°çš„è¿™äº›ä¸œè¥¿çš„ã€‚æœ€å¥½çš„æƒ…å†µæ˜¯å®šä¹‰å¥½ interface ä¹‹åï¼Œç”Ÿæˆä»£ç ï¼Œç¼–å†™ä¸»å‡½æ•°ï¼Œå°±èƒ½ç›´æ¥è¿è¡Œäº†ã€‚åŒæ—¶åˆä¸ä¼¤å®³ go kit æ¶æ„æœ¬èº«çš„æ‰©å±•æ€§å’Œå¯å®šåˆ¶æ€§ã€‚

## æ€»ç»“

![go kitæ¶æ„çš„æœåŠ¡](image-20220302154943857.png)

è›®å–œæ¬¢ go kit é¡¹ç›®ä½œè€…çš„ä¸€å¥è¯ï¼š

![issueæˆªå›¾](image-20220302155216922.png)

> Honestly the best way to "use" Go kit is to cop it's architectural model and not actually import any of its packages at all ğŸ˜‰

å…¶å®æˆ‘ä¹Ÿæƒ³æŠŠè¿™å¥—æ¶æ„æ¬è¿›é¡¹ç›®é‡Œï¼Œå¯æƒœæ¡ä»¶ä¸å…è®¸ï¼Œè¿˜æœ‰æ›´ä¸¥é‡çš„é—®é¢˜è¦å¤„ç†ï¼Œåªèƒ½å…ˆçœ¼é¦‹ä¸€ä¸‹ï¼Œå¸æ”¶ä¸‹ç²¾ç¥ã€‚