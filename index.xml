<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>weakptr's ç¬”è®°</title><link>https://nnnewb.github.io/blog/</link><description>Recent content on weakptr's ç¬”è®°</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Mon, 14 Mar 2022 12:30:00 +0800</lastBuildDate><atom:link href="https://nnnewb.github.io/blog/index.xml" rel="self" type="application/rss+xml"/><item><title>è®°ä¸€æ¬¡MySQL JOINä¼˜åŒ–</title><link>https://nnnewb.github.io/blog/p/note-of-mysql-join-optimize/</link><pubDate>Mon, 14 Mar 2022 12:30:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/note-of-mysql-join-optimize/</guid><description>&lt;img src="https://nnnewb.github.io/blog/p/note-of-mysql-join-optimize/image-20220314150141759.png" alt="Featured image of post è®°ä¸€æ¬¡MySQL JOINä¼˜åŒ–" />&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>é•¿è¯çŸ­è¯´ï¼Œè¿™ä¸ªæ€§èƒ½é—®é¢˜æ˜¯ä¸Šå‘¨ä¿®ä¸€ä¸ªbugçš„æ—¶å€™ä¼å›¾å·æ‡’å¼•å…¥çš„ã€‚å› ä¸º xorm åœ¨è¿æ¥æŸ¥è¯¢çš„æ—¶å€™æ¨¡å‹ç»“æ„å¿…é¡»æ˜¯å’Œ &lt;code>join&lt;/code> çš„é¡ºåºä¿æŒä¸€è‡´ï¼Œä¸­é—´è¿˜ä¸èƒ½æœ‰é—æ¼ï¼Œä¸ç„¶æŸ¥è¯¢ç»“æœå¡«å……åˆ°ç»“æ„é‡Œçš„æ—¶å€™å°±ä¼šé”™ä½ã€‚&lt;/p>
&lt;p>è€Œä¸šåŠ¡é‡Œè¿™ä¸ªæ¡ä»¶åˆæ˜¯å¯é€‰çš„â€”â€”ç”¨æˆ·ä¸ä¼ çš„æ—¶å€™ä¸éœ€è¦ &lt;code>INNER JOIN&lt;/code>ï¼›ä½†ä¸ºäº†è®© xorm å¼€å¿ƒï¼ŒåŒæ—¶å°½é‡åˆ«æŠŠæ•´ä¸ªå‡½æ•°ç­¾åå’Œè¿”å›ç±»å‹éƒ½æ”¹äº†æŠŠå½±å“èŒƒå›´æå¤ªå¤§ï¼Œæ‰€ä»¥å°±å·äº†ä¸ªæ‡’ï¼šæ—¢ç„¶ xorm è¦ &lt;code>JOIN&lt;/code> ï¼Œé‚£å°± &lt;code>LEFT JOIN&lt;/code>åŠ ä¸ªæ’å‡çš„æ¡ä»¶å‘—ã€‚äºæ˜¯å°±é¡ºæ‰‹å†™ä¸‹äº†ä¸‹é¢çš„ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="k">LEFT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">JOIN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tbl&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ON&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;lt;&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ²¡å•¥é—®é¢˜å¯¹å§ï¼Ÿæˆ‘å½“æ—¶ä¹Ÿè¿™ä¹ˆæƒ³çš„ã€‚&lt;/p>
&lt;h2 id="é—®é¢˜">é—®é¢˜&lt;/h2>
&lt;p>å¥½äº†ï¼Œé—®é¢˜æ¥äº†ã€‚å…ˆæŠŠæ•´ä¸ª SQLå†™ä¸‹æ¥ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">INNER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">JOIN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">b&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ON&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">resource_id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">LEFT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">JOIN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">c&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ON&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;lt;&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">LEFT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">JOIN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">d&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ON&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">resource_id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">resource_id&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">LEFT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">JOIN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ON&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">resource_id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">resource_id&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">result&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AND&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">resource_type&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">limit&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">offset&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ•´ä¸ªæŸ¥è¯¢çš„å®é™…è€—æ—¶æ˜¯ &lt;strong>919ms&lt;/strong>ã€‚&lt;/p>
&lt;p>&lt;em>why ?&lt;/em>&lt;/p>
&lt;h2 id="æ€§èƒ½åˆ†æ">æ€§èƒ½åˆ†æ&lt;/h2>
&lt;p>æŸ¥è¯¢æ…¢äº†ç¬¬ä¸€ååº”è¿˜æ˜¯æ˜¯ä¸æ˜¯æ²¡ç´¢å¼•ï¼Œäºæ˜¯å…ˆçœ‹çœ‹ &lt;code>explain&lt;/code> çš„ç»“æœã€‚&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>id&lt;/th>
&lt;th>select_type&lt;/th>
&lt;th>table&lt;/th>
&lt;th>partitions&lt;/th>
&lt;th>type&lt;/th>
&lt;th>possible_keys&lt;/th>
&lt;th>key&lt;/th>
&lt;th>key_len&lt;/th>
&lt;th>ref&lt;/th>
&lt;th>rows&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>SIMPLE&lt;/td>
&lt;td>a&lt;/td>
&lt;td>&lt;/td>
&lt;td>ALL&lt;/td>
&lt;td>IDX_a_resource_id&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>456&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>SIMPLE&lt;/td>
&lt;td>b&lt;/td>
&lt;td>&lt;/td>
&lt;td>eq_ref&lt;/td>
&lt;td>PRIMARY&lt;/td>
&lt;td>PRIMARY&lt;/td>
&lt;td>8&lt;/td>
&lt;td>a.resource_id&lt;/td>
&lt;td>1&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>SIMPLE&lt;/td>
&lt;td>d&lt;/td>
&lt;td>&lt;/td>
&lt;td>ref&lt;/td>
&lt;td>IDX_d_resource_id&lt;/td>
&lt;td>IDX_d_resource_id&lt;/td>
&lt;td>8&lt;/td>
&lt;td>a.resource_id&lt;/td>
&lt;td>1&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>SIMPLE&lt;/td>
&lt;td>e&lt;/td>
&lt;td>&lt;/td>
&lt;td>ref&lt;/td>
&lt;td>IDX_e_resource_id&lt;/td>
&lt;td>IDX_e_resource_id&lt;/td>
&lt;td>9&lt;/td>
&lt;td>a.resource_id&lt;/td>
&lt;td>1&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>SIMPLE&lt;/td>
&lt;td>c&lt;/td>
&lt;td>&lt;/td>
&lt;td>ALL&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>6405&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>é©±åŠ¨è¡¨æ˜¯ &lt;code>a&lt;/code>ï¼Œåšäº†å…¨è¡¨æ‰«æï¼Œä½†æ•°æ®é‡å¾ˆå°ï¼Œåªæœ‰400å¤šè¡Œã€‚ä½†è¿™ä¸ªè¡¨æ˜¯åªå¢çš„ï¼Œå…¨è¡¨æ‰«æè¿˜æ˜¯ä¸å¤ªå¯¹åŠ²ï¼Œäºæ˜¯çœ‹äº†çœ¼ç´¢å¼•ï¼Œå‘ç° &lt;code>result&lt;/code> æ²¡æœ‰ç´¢å¼•â€”â€”ä½†è¿™ä¸ªå­—æ®µåŒºåˆ†åº¦ä¸ç®—å¾ˆé«˜ï¼Œåªæœ‰4ä¸ªæšä¸¾å€¼ã€‚&lt;/p>
&lt;p>ç½‘ä¸Šéšä¾¿æœçš„åšå®¢çœ‹åˆ°åˆ—åŒºåˆ†åº¦è®¡ç®—å¯ä»¥ç”¨ &lt;code>SELECT count(distinct col)/count(*) FROM tbl&lt;/code> æ¥è®¡ç®—ï¼ŒåŒºåˆ†åº¦è¶Šæ¥è¿‘ 1 åˆ™ç´¢å¼•æ•ˆæœè¶Šå¥½ã€‚&lt;code>result&lt;/code>çš„åŒºåˆ†åº¦åªæœ‰&lt;code>0.0088&lt;/code>ï¼Œä¸ªäººæ„Ÿè§‰åŒºåˆ«ä¸å¤§ã€‚è¿™ç§æƒ…å†µä¸‹ä½¿ç”¨resultç´¢å¼•æ»¤å‡ºæ¥çš„ç»“æœé›†ä¼šæ¯”è¾ƒå¤§ï¼Œå›è¡¨æŸ¥è¯¢æ¬¡æ•°è¿‡å¤šçš„è¯è¿˜ä¸å¦‚å°±éå†ä¸€éåŸè¡¨ã€‚&lt;/p>
&lt;p>æƒ³å½’æƒ³ï¼Œä½†è¿˜æ˜¯è€å®åŠ ä¸Šäº† &lt;code>result&lt;/code> ç´¢å¼•ï¼Œå† &lt;code>explain&lt;/code> äº†ä¸€æ¬¡ï¼Œç»“æœæ˜¯ &lt;code>possible keys&lt;/code> é‡Œå¤šäº† &lt;code>IDX_a_result&lt;/code>ï¼Œä½†æœ€ &lt;code>type&lt;/code> è¿˜æ˜¯ &lt;code>ALL&lt;/code>ï¼Œè¯´æ˜ç¡®å®å’Œ &lt;code>result&lt;/code> å­—æ®µæœ‰æ²¡æœ‰ç´¢å¼•æ²¡å…³ç³»ã€‚&lt;/p>
&lt;p>å†æ¥ç€çœ‹ä¸‹é¢ï¼Œå…¶ä»–è¡¨åŸºæœ¬ä¸æ˜¯ä¸»é”®å°±æ˜¯äºŒçº§ç´¢å¼•ï¼Œå”¯ç‹¬ &lt;code>c&lt;/code> è¡¨ç‰¹ç«‹ç‹¬è¡Œâ€”â€”ä¹Ÿæ˜¯&lt;code>ALL&lt;/code>ã€‚ä½†è¿™ä¸ªè¡¨çš„ &lt;code>JOIN&lt;/code> å­å¥æ˜¯è¿™æ ·çš„ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="k">LEFT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">JOIN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">c&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ON&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;lt;&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ä¸ºå•¥è¦éå†ï¼Ÿ&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 126;
flex-basis: 302px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/note-of-mysql-join-optimize/image-20220314135914892.png" data-size="304x241">
&lt;img src="https://nnnewb.github.io/blog/blog/p/note-of-mysql-join-optimize/image-20220314135914892.png"
width="304"
height="241"
srcset="https://nnnewb.github.io/blog/blog/p/note-of-mysql-join-optimize/image-20220314135914892_hu2478642e4d59f16d974ad0b870af7dc5_11307_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/note-of-mysql-join-optimize/image-20220314135914892_hu2478642e4d59f16d974ad0b870af7dc5_11307_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="æ‰§è¡Œè®¡åˆ’">
&lt;/a>
&lt;figcaption>æ‰§è¡Œè®¡åˆ’&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>ä½†çœ‹åˆ° cost åªæœ‰ 87.68ï¼Œåˆæ¾äº†å£æ°”ï¼Œå¯èƒ½åªæ˜¯ &lt;code>explain&lt;/code> è¾“å‡ºä¸å¯¹å§ï¼Œæ€ä¹ˆæƒ³ &lt;code>ON 1 &amp;lt;&amp;gt; 1&lt;/code> è¿™æ ·çš„æ¡ä»¶ä¹Ÿåº”è¯¥æ˜¯å¸¸æ•°æ—¶é—´å†…å®Œæˆã€‚&lt;/p>
&lt;p>åˆ°è¿™é‡Œï¼Œæ€è·¯å·²ç»å®Œå…¨èµ°æ­ªäº†ï¼Œå¼€å§‹è§‰å¾—æ˜¯ä¸æ˜¯ç£ç›˜ IO æˆ–è€…ç½‘ç»œ IO ä¸Šæœ‰ç“¶é¢ˆï¼Ÿ&lt;/p>
&lt;h3 id="sysstat-å·¥å…·">sysstat å·¥å…·&lt;/h3>
&lt;p>è¿™é‡Œä»‹ç»ä¸‹ä¸€ä¸ªå¾ˆå¥½ç”¨çš„ Linux ä¸‹æ€§èƒ½åˆ†æå·¥å…·ï¼Œ&lt;a class="link" href="https://github.com/sysstat/sysstat" target="_blank" rel="noopener"
>sysstat&lt;/a>ã€‚å¤§éƒ¨åˆ†å‘è¡Œç‰ˆéƒ½å¯ä»¥ç›´æ¥ç”¨å†…ç½®åŒ…ç®¡ç†å™¨å®‰è£…ï¼Œå¦‚ Debian/Ubuntu å¯ä»¥ç”¨ &lt;code>apt-get install sysstat&lt;/code> å®‰è£…ã€‚&lt;/p>
&lt;p>&lt;code>sysstat&lt;/code> åŒ…å«äº†å„ç§åœ¨Unixã€Linuxç¯å¢ƒä¸‹é€šç”¨çš„å·¥å…·ï¼Œæ¥ç›‘è§†ç³»ç»Ÿæ€§èƒ½å’Œä½¿ç”¨æƒ…å†µã€‚è¿™é‡Œé¢æœ‰å¾ˆå¤šå¥½ç”¨çš„å·¥å…·æ¯”å¦‚ &lt;code>sar&lt;/code>ã€&lt;code>iostat&lt;/code>ã€&lt;code>pidstat&lt;/code>ã€‚&lt;/p>
&lt;p>å®‰è£…&lt;code>sysstat&lt;/code>ä¹‹åè¿˜éœ€è¦é…ç½®ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">sudo dpkg-reconfigure sysstat
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶åé€‰ &lt;code>yes&lt;/code> æ¥å¯ç”¨å®šæ—¶ä»»åŠ¡è‡ªåŠ¨æ”¶é›†æ•°æ®åˆ° &lt;code>/var/log/sysstat&lt;/code> ï¼Œè¿™æ · &lt;code>sar&lt;/code> å°±å¯ä»¥å¯¼å‡ºæŠ¥å‘Šäº†ã€‚&lt;/p>
&lt;p>&lt;code>sar&lt;/code> æ˜¯ä¸€ä¸ªç»¼åˆæ€§çš„å·¥å…·ï¼Œå¯ä»¥æ”¶é›†ã€å¯¼å‡ºã€ä¿å­˜ç³»ç»Ÿæ´»åŠ¨æ•°æ®ï¼Œæ”¶é›†çš„æ•°æ®åŒ…æ‹¬ï¼šI/Oã€CPUã€ç‰©ç†å†…å­˜/Hugepage/Swapã€è™šæ‹Ÿå†…å­˜ã€è¿›ç¨‹åˆ›å»ºã€ä¸­æ–­ã€ç½‘ç»œæ¥å£ã€socketã€ç­‰ç­‰&amp;hellip;éå¸¸å…¨é¢ï¼ŒåŸºæœ¬èƒ½æƒ³åˆ°çš„éƒ½æœ‰ã€‚&lt;/p>
&lt;p>æ”¾åœ¨è¿™ä¸ªåœºæ™¯é‡Œï¼Œç”¨ &lt;code>sar&lt;/code> å¯ä»¥çœ‹åˆ°è¿è¡ŒæŸ¥è¯¢æ—¶çš„ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š&lt;code>sudo sar -bd 1&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">14æ—¶48åˆ†14ç§’ tps rtps wtps dtps bread/s bwrtn/s bdscd/s
14æ—¶48åˆ†15ç§’ 40.00 1.00 39.00 0.00 8.00 312.00 0.00
14æ—¶48åˆ†14ç§’ DEV tps rkB/s wkB/s dkB/s areq-sz aqu-sz await %util
14æ—¶48åˆ†15ç§’ dev7-0 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00
14æ—¶48åˆ†15ç§’ dev7-1 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00
14æ—¶48åˆ†15ç§’ dev7-2 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00
14æ—¶48åˆ†15ç§’ dev7-3 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00
14æ—¶48åˆ†15ç§’ dev7-4 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00
14æ—¶48åˆ†15ç§’ dev7-5 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00
14æ—¶48åˆ†15ç§’ dev7-6 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00
14æ—¶48åˆ†15ç§’ dev7-7 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00
14æ—¶48åˆ†15ç§’ dev8-0 40.00 4.00 156.00 0.00 4.00 0.00 0.20 2.00
14æ—¶48åˆ†15ç§’ dev253-0 42.00 4.00 156.00 0.00 3.81 0.00 0.00 2.00
14æ—¶48åˆ†15ç§’ dev7-8 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00
14æ—¶48åˆ†15ç§’ dev7-9 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸èƒ½è¯´æ¯«æ— æ³¢åŠ¨ï¼Œä½†æ˜¾ç„¶å’Œç“¶é¢ˆåº”è¯¥æ‰¯ä¸ä¸Šå…³ç³»äº†ã€‚ä½†å‡ºäºè°¨æ…è€ƒè™‘ï¼Œè¿˜æ˜¯ç”¨ &lt;code>pidstat&lt;/code> æŒ‡å®šäº† &lt;code>mysqld&lt;/code> è¿›ç¨‹çš„ PID æ¥è§‚å¯Ÿã€‚è¿™é‡Œå¤šå˜´ä¸€å¥ï¼ŒMySQL æ˜¯ç”¨ kubernetes éƒ¨ç½²åœ¨åŠå…¬å®¤çš„æœåŠ¡å™¨ä¸Šçš„ï¼Œæˆ‘å¾—æä¸€å˜´ &lt;code>sysstat&lt;/code> æ˜¯åœ¨å®¿ä¸»æœºä¸Šç›´æ¥è¿è¡Œè€Œä¸æ˜¯å®¹å™¨é‡Œâ€”â€”è¿™å¾—è¯´åˆ°å®¹å™¨éš”ç¦»çš„åŸç†ï¼Œ&lt;code>namespace&lt;/code>å’Œ&lt;code>cgroup&lt;/code>ï¼Œåœ¨å¤–å±‚&lt;code>namespace&lt;/code>ä¸‹æ˜¯å¯ä»¥çœ‹åˆ°å†…å±‚&lt;code>namespace&lt;/code>çš„è¿›ç¨‹çš„ï¼Œä½†å†…å±‚çš„&lt;code>namespace&lt;/code>çœ‹ä¸åˆ°å¤–å±‚ï¼Œæ˜¯å•å‘çš„éš”ç¦»ã€‚æ‰€ä»¥å¯ä»¥ç›´æ¥åœ¨å®¿ä¸»æœºä¸Šç”¨ &lt;code>ps&lt;/code> çœ‹åˆ° &lt;code>pause&lt;/code> å®¹å™¨çš„è¿›ç¨‹ä»¥åŠ &lt;code>mysqld&lt;/code> è¿™ç§å®¹å™¨é‡Œçš„è¿›ç¨‹ï¼Œä¹Ÿå¯ä»¥æ”¶é›†åˆ°å„ç§ä½¿ç”¨ç‡ä¿¡æ¯â€”â€”å› ä¸ºå…±äº«å®¿ä¸»æœºçš„å†…æ ¸å˜›ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">pidstat -d -p &lt;span class="m">11404&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">14æ—¶57åˆ†19ç§’ UID PID kB_rd/s kB_wr/s kB_ccwr/s iodelay Command
14æ—¶57åˆ†20ç§’ 999 11404 -1.00 -1.00 -1.00 0 mysqld
14æ—¶57åˆ†21ç§’ 999 11404 -1.00 -1.00 -1.00 0 mysqld
14æ—¶57åˆ†22ç§’ 999 11404 -1.00 -1.00 -1.00 0 mysqld
14æ—¶57åˆ†23ç§’ 999 11404 -1.00 -1.00 -1.00 0 mysqld
14æ—¶57åˆ†24ç§’ 999 11404 -1.00 -1.00 -1.00 0 mysqld
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™å°±åªèƒ½è¯´æ¯«æ— æ³¢åŠ¨äº†ï¼Œè¯´é‚£ä¹ˆå¤šï¼Œå¹¶æ²¡æœ‰åµç”¨ã€‚&lt;/p>
&lt;h2 id="è½¬æŠ˜">è½¬æŠ˜&lt;/h2>
&lt;p>ä¸€ä¸Šåˆå‡ ä¹éƒ½èŠ±è´¹åœ¨è¿™ä¸ªæŸ¥è¯¢ä¸Šï¼Œç»ˆäºåœ¨ä¸€æ¬¡èƒ¡ä¹±åˆ†æä¸­æ³¨æ„åˆ° CPU ä½¿ç”¨ç‡ä¸åŒå¯»å¸¸ï¼š&lt;code>pidstat -p 11404 -d 1&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">15æ—¶01åˆ†01ç§’ UID PID %usr %system %guest %wait %CPU CPU Command
15æ—¶01åˆ†02ç§’ 999 11404 0.00 0.00 0.00 0.00 0.00 1 mysqld
15æ—¶01åˆ†03ç§’ 999 11404 0.00 0.00 0.00 0.00 0.00 1 mysqld
15æ—¶01åˆ†04ç§’ 999 11404 0.00 0.00 0.00 0.00 0.00 1 mysqld
15æ—¶01åˆ†05ç§’ 999 11404 0.00 0.00 0.00 0.00 0.00 1 mysqld
15æ—¶01åˆ†06ç§’ 999 11404 6.00 0.00 0.00 0.00 6.00 1 mysqld
15æ—¶01åˆ†07ç§’ 999 11404 39.00 0.00 0.00 0.00 39.00 1 mysqld
15æ—¶01åˆ†08ç§’ 999 11404 52.00 0.00 0.00 0.00 52.00 1 mysqld
15æ—¶01åˆ†09ç§’ 999 11404 65.00 0.00 0.00 0.00 65.00 1 mysqld
15æ—¶01åˆ†10ç§’ 999 11404 53.00 0.00 0.00 0.00 53.00 1 mysqld
15æ—¶01åˆ†11ç§’ 999 11404 66.00 0.00 0.00 0.00 66.00 6 mysqld
15æ—¶01åˆ†12ç§’ 999 11404 85.00 0.00 0.00 0.00 85.00 6 mysqld
15æ—¶01åˆ†13ç§’ 999 11404 5.00 0.00 0.00 0.00 5.00 6 mysqld
15æ—¶01åˆ†14ç§’ 999 11404 0.00 0.00 0.00 0.00 0.00 6 mysqld
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 243;
flex-basis: 585px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/note-of-mysql-join-optimize/image-20220314150141759.png" data-size="756x310">
&lt;img src="https://nnnewb.github.io/blog/blog/p/note-of-mysql-join-optimize/image-20220314150141759.png"
width="756"
height="310"
srcset="https://nnnewb.github.io/blog/blog/p/note-of-mysql-join-optimize/image-20220314150141759_hu8ccdbbcbbb5906798b24061f7093764d_181309_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/note-of-mysql-join-optimize/image-20220314150141759_hu8ccdbbcbbb5906798b24061f7093764d_181309_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="è¿™å½©è‰²è¾“å‡ºæ˜¯çœŸèˆ’æœ">
&lt;/a>
&lt;figcaption>è¿™å½©è‰²è¾“å‡ºæ˜¯çœŸèˆ’æœ&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>åœ¨è¿è¡ŒæŸ¥è¯¢æ—¶ï¼ŒCPUä½¿ç”¨ç‡é£™å‡åˆ°äº†50%~85%ï¼Œä¸€ä¸ªç®€å•çš„æŸ¥è¯¢å‡ ä¹è·‘æ»¡äº†ä¸€ä¸ªæ ¸å¿ƒï¼Ÿå¦‚æœ ctrl+enter æŒ‰å¾—ç¨å¾®å‹¤å¿«ä¸€ç‚¹ï¼Œè¿™ä¸ªä½¿ç”¨ç‡æœ€é«˜èƒ½è·‘åˆ° 105% â€”â€”è¿™è¿˜æ˜¯å› ä¸ºæˆ‘åœ¨ kubernetes åªç»™äº† 1 CPU çš„é…é¢çš„ç¼˜æ•…ã€‚äºæ˜¯ç“¶é¢ˆç»ˆäºæš´éœ²äº†å‡ºæ¥ï¼šCPUã€‚è¿™è°èƒ½æƒ³åˆ°å‘¢ã€‚&lt;/p>
&lt;p>å†å›è¿‡å¤´åˆ†ææŸ¥è¯¢ï¼Œç»“åˆä¸€ä¸‹è„‘å­é‡Œæ²‰ç¡å·²ä¹…çš„è®°å¿†+è°·æ­Œä¸€ä¸‹ï¼Œé—®é¢˜ç»ˆäºæµ®å‡ºæ°´é¢ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 126;
flex-basis: 302px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/note-of-mysql-join-optimize/image-20220314135914892.png" data-size="304x241">
&lt;img src="https://nnnewb.github.io/blog/blog/p/note-of-mysql-join-optimize/image-20220314135914892.png"
width="304"
height="241"
srcset="https://nnnewb.github.io/blog/blog/p/note-of-mysql-join-optimize/image-20220314135914892_hu2478642e4d59f16d974ad0b870af7dc5_11307_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/note-of-mysql-join-optimize/image-20220314135914892_hu2478642e4d59f16d974ad0b870af7dc5_11307_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="æ‰§è¡Œè®¡åˆ’">
&lt;/a>
&lt;figcaption>æ‰§è¡Œè®¡åˆ’&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å¯¹ï¼Œ&lt;code>nested_loop#5&lt;/code>ï¼ŒMySQL çš„æ‰§è¡Œè®¡åˆ’å¿ å®åæ˜ äº†å®é™…åšçš„äº‹æƒ…ã€‚MySQL çœŸå°±ï¼Œå¯¹ç€ &lt;code>LEFT JOIN ... ON 1 &amp;lt;&amp;gt; 1&lt;/code> è¿™ä¸ªæ¡ä»¶ï¼Œåœ¨åµŒå¥—å¾ªç¯é‡Œï¼Œåšäº†ä¸ªå…¨è¡¨æ‰«æ&amp;hellip;&amp;hellip;&lt;/p>
&lt;p>æ‰€è°“&lt;code>nested_loop&lt;/code>ï¼Œå°±æ˜¯&lt;code>for range { for range {}}&lt;/code> è¿™æ ·çš„æ‰§è¡Œè·¯å¾„ï¼Œç®€å•åœ°æŠŠ &lt;code>Rows&lt;/code> ä¹˜ä¸€ä¸‹å°±èƒ½å¾—åˆ°å®é™…å¤„ç†äº†å¤šå°‘è¡Œï¼š&lt;code>6450*456=2920680&lt;/code>ï¼Œä¸€å…± 292 ä¸‡è¡Œï¼Œéš¾æ€ª CPU ä½¿ç”¨ç‡ä¼šå¦‚æ­¤ä¹‹é«˜ï¼Œéš¾æ€ªæ•°æ®é‡è¿™ä¹ˆå°çš„ä¸¤ä¸ªè¡¨åšæŸ¥è¯¢å±…ç„¶ä¼šèŠ±è´¹æ¥è¿‘1sçš„æ—¶é—´ã€‚&lt;/p>
&lt;h2 id="è§£å†³">è§£å†³&lt;/h2>
&lt;p>çŸ¥é“äº†ç“¶é¢ˆï¼Œæ‰¾åˆ°äº†é€ æˆç“¶é¢ˆçš„ä»£ç ï¼Œé‚£ä¹ˆåº”è¯¥å°±å¥½è§£å†³äº†â€”â€”è¯è™½å¦‚æ­¤ï¼Œè¦æˆ‘ç»™å‡ºè§£å†³åŠæ³•çš„è¯ç¡®å®å°±æ˜¯ä¸€å¥è¯çš„äº‹æƒ…ï¼Œä½†ä¸ºäº†æ‰¾å‡ºè¿™ä¸ªè§£å†³åŠæ³•åè€Œæµªè´¹äº†ä¸å°‘æ—¶é—´ã€‚&lt;/p>
&lt;p>å›é¡¾é€ æˆé—®é¢˜çš„ &lt;code>JOIN&lt;/code> å­å¥ï¼Œ&lt;code>LEFT JOIN ... ON 1 &amp;lt;&amp;gt; 1&lt;/code>ï¼Œ&lt;code>1 &amp;lt;&amp;gt; 1&lt;/code> æ˜¯æ’å‡æ¡ä»¶ï¼Œä½† MySQL å¯¹è¿™ä¸ªæ¡ä»¶é€‰æ‹©äº†å…¨è¡¨æ‰«æè¿™ç§å®Œå…¨æ— æ³•ç†è§£çš„å¤„ç†æ–¹å¼ã€‚&lt;/p>
&lt;p>è¡Œï¼Œé‚£æˆ‘ç›´æ¥æ”¹æˆ &lt;code>ON FALSE&lt;/code>ï¼Œæ€»ä¸è‡³äºè¿ &lt;code>FALSE&lt;/code> ä¹Ÿèƒ½ç»™ä¸ªå…¨è¡¨æ‰«æçš„æ‰§è¡Œè®¡åˆ’å§ï¼Ÿå¯¹ï¼Œè¿˜çœŸèƒ½ï¼ŒMySQL çœŸæœ‰ä½ çš„&amp;hellip;&lt;/p>
&lt;p>éšåè¿˜è¯•äº† &lt;code>0 &amp;gt; 1&lt;/code>ã€&lt;code>1 &amp;lt; 0&lt;/code>ã€&lt;code>1=2&lt;/code>ã€&lt;code>1 is null&lt;/code> ç­‰ç­‰æ¡ä»¶ï¼Œæ— ä¸€ä¾‹å¤– MySQL çš„æ‰§è¡Œè®¡åˆ’éƒ½æ˜¯ nested_loop + å…¨è¡¨æ‰«æï¼Œå°±åœ¨å¿«æ”¾å¼ƒçš„æ—¶å€™å¶ç„¶æƒ³åˆ°æ—¢ç„¶è¯´ä»€ä¹ˆéƒ½è¦æ‰«è¡¨ï¼Œé‚£æˆ‘è®© MySQL æ‰«å°±æ˜¯äº†ï¼Œç»™ä¸ªæœ‰ç´¢å¼•çš„å­—æ®µè®© MySQL ä¸è¦å…¨è¡¨æ‰«æï¼Œä¹Ÿèƒ½æ”¹å–„å¾ˆå¤šå§ï¼Ÿç„¶åå°±éšæ‰‹å†™ä¸‹ &lt;code>c.id=-1&lt;/code>ã€‚&lt;/p>
&lt;p>ç„¶å MySQL çš„æ‰§è¡Œè®¡åˆ’å°±ä»å…¨è¡¨æ‰«æå˜æˆäº†å¸¸æ•°æ—¶é—´&amp;hellip;çœŸæœ‰ä½ çš„å•Š MySQLï¼&lt;/p>
&lt;p>åˆè¯•äº†ä¸‹ &lt;code>c.id is null&lt;/code> åŒæ ·ä¹Ÿæ˜¯å¸¸æ•°æ—¶é—´ï¼Œæ‰€ä»¥MySQLçŠ¯å‚»çš„åŸå› æ˜¯ä¼˜åŒ–å™¨æ²¡è€ƒè™‘åˆ°æœ‰æˆ‘è¿™æ ·çš„ &lt;strong>èªï¼ˆè‡­ï¼‰æ˜ï¼ˆå‚»ï¼‰äººï¼ˆBï¼‰&lt;/strong> ä¼šå¾€æ¡ä»¶é‡Œå†™ä¸ª FALSE æ˜¯å§&amp;hellip;çœŸæœ‰ä½ çš„å•Š MySQLï¼&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;ol start="0">
&lt;li>ä¸è¦å¿½ç•¥ explain ç»™å‡ºçš„çº¿ç´¢ã€‚&lt;/li>
&lt;li>æ³¨æ„ &lt;code>nested_loop&lt;/code>ï¼Œ&lt;code>join&lt;/code> çš„æ¡ä»¶ä¸èƒ½å¤ªå®½æ³›ï¼Œå¦åˆ™éå†çš„æ•°æ®é‡ä¼šçˆ†ç‚¸æ€§å¢é•¿ï¼Œåæœå°±æ˜¯æŸ¥è¯¢æ—¶é—´éšéšä¾¿ä¾¿ç¿»å‡ ç™¾å€ã€‚
&lt;ol>
&lt;li>æœ€é«˜æ•ˆçš„ &lt;code>join&lt;/code> å½“ç„¶æ˜¯ç›´æ¥èµ°ä¸»é”®ï¼ŒæŸ¥ä¸€ä¸ªå…ƒç´ ï¼Œèšç°‡ç´¢å¼•ï¼Œä¸ç”¨å›è¡¨ï¼ŒæŸ¥è¯¢æ—¶é—´å¤æ‚åº¦ä¸å˜ã€‚&lt;/li>
&lt;li>æ¬¡ä¸€çº§çš„èµ°äºŒçº§ç´¢å¼•ï¼ŒæŸ¥ä¸€ä¸ªå…ƒç´ ï¼Œå›è¡¨ä¸€æ¬¡ä¹Ÿå°±å®Œäº†ï¼ŒæŸ¥è¯¢æ—¶é—´å¤æ‚åº¦ä¸å˜ã€‚&lt;/li>
&lt;li>å†æ¬¡ä¸€çº§çš„ç´¢å¼•åŒºåˆ†åº¦ä¸è¶³1ï¼ŒæŸ¥æ‰¾å‡ºæ¥å¤šä¸ªå…ƒç´ ï¼Œå›è¡¨å¤šæ¬¡ï¼ŒåµŒå¥—å¾ªç¯çš„è¯ä¼šæˆå€æ”¾å¤§é©±åŠ¨è¡¨çš„æ—¶é—´å¤æ‚åº¦ã€‚&lt;/li>
&lt;li>æœ€å·®çš„æƒ…å†µï¼Œç´¢å¼•åŒºåˆ†åº¦å¤ªå·®æˆ–è€…æ²¡ç´¢å¼•ï¼Œè¢«è¿«åµŒå¥—å¾ªç¯+å…¨è¡¨æ‰«æï¼Œä¹Ÿå°±æ˜¯æˆ‘ç¢°åˆ°çš„æƒ…å†µï¼Œç”Ÿäº§ä¸‹è´Ÿè½½æä¸Šæ¥ä¸€ç‚¹å°±å¤§æ¦‚ç‡è¦GGã€‚&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>MySQL çš„ä¼˜åŒ–å™¨éœ€è¦åœ¨æ¡ä»¶é‡Œç»™ä¸ªåˆ—ï¼Œå°±ç®—æ˜¯æ’çœŸæˆ–è€…æ’å‡çš„æ¡ä»¶ï¼Œä¹Ÿä¸€å®šè¦ç»™ä¸ªåˆ—ï¼Œä¸ç„¶MySQLå°±ä¼šè·Ÿä¸ªå‚»é€¼ä¸€æ ·é€‰æ‹©å…¨è¡¨æ‰«æã€‚
&lt;ol>
&lt;li>æˆ‘çš„ç¯å¢ƒæ˜¯ MySQL 5.7.33ï¼ŒInnoDB 5.7.33ï¼ŒMySQL Community Serverï¼Œæ–°ç‰ˆæœ¬ MySQL ä¸çŸ¥é“æœ‰æ²¡æœ‰è§£å†³ã€‚&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>&lt;code>sysstat&lt;/code> è¿™å¥—å·¥å…·å¾ˆå¥½ç”¨ï¼Œå¦‚æœæ²¡æŠŠå¯è§‚æµ‹æ€§çš„åŸºç¡€è®¾æ–½(å„ç§&lt;code>reporter&lt;/code>+&lt;code>prometheus&lt;/code>+&lt;code>grafana&lt;/code>)æå¥½çš„è¯ï¼Œ&lt;code>sysstat&lt;/code> å€¼å¾—æ‹¥æœ‰ã€‚&lt;/li>
&lt;/ol></description></item><item><title>gokit æ¶æ„ä¹‹æˆ‘è§</title><link>https://nnnewb.github.io/blog/p/my-opinion-of-gokit-architecture/</link><pubDate>Wed, 02 Mar 2022 12:30:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/my-opinion-of-gokit-architecture/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>è¿™æ˜¯çœ‹äº† &lt;a class="link" href="https://github.com/go-kit/kit/issues/843" target="_blank" rel="noopener"
>Go kit: the road ahead&lt;/a> ä¹‹åï¼Œå¯¹ go kit è¿™å¥—æŠ½è±¡çš„ä¸€äº›æƒ³æ³•ã€‚ä¸»è¦æ˜¯å…³äº endpoint æ˜¯å¦æœ‰å¿…è¦ã€generic ä¼šå¦‚ä½•å½±å“ go kit çš„æ¶æ„ã€go kit çš„ä»£ç ç”Ÿæˆè¿™äº›é—®é¢˜ã€‚&lt;/p>
&lt;h2 id="endpoint-æŠ½è±¡å±‚æ˜¯å¦å¿…è¦å­˜åœ¨">endpoint æŠ½è±¡å±‚æ˜¯å¦å¿…è¦å­˜åœ¨&lt;/h2>
&lt;p>æˆ‘çš„çœ‹æ³•æ˜¯éœ€è¦ã€‚åŸå› ä¸‹é¢åˆ†æã€‚&lt;/p>
&lt;p>ä¸€ä¸ªæ²¡æœ‰é¢å¤–åŠŸèƒ½çš„ Endpoint å…¶å®æ˜¯èµ·åˆ°äº†æŠŠè¯·æ±‚ç±»å‹é€‚é…åˆ° Go å‡½æ•°ç­¾åçš„ä½œç”¨ã€‚&lt;a class="link" href="http://gokit.io/examples/stringsvc.html#endpoints" target="_blank" rel="noopener"
>stringsvc&lt;/a> å®ç°å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;context&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/go-kit/kit/endpoint&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">makeUppercaseEndpoint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">svc&lt;/span> &lt;span class="nx">StringService&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">endpoint&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Endpoint&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">_&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">request&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">req&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">request&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="nx">uppercaseRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">svc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Uppercase&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">S&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">uppercaseResponse&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">()},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">uppercaseResponse&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">makeCountEndpoint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">svc&lt;/span> &lt;span class="nx">StringService&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">endpoint&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Endpoint&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">_&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">request&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">req&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">request&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="nx">countRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">svc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Count&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">S&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">countResponse&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯¹äºå†™è¿‡ rpcx æˆ–è€… gRPC çš„æœ‹å‹æ¥è¯´ï¼ŒEndpoint æ›´åƒæ˜¯ä¸ªè„±è£¤å­æ”¾å±çš„å°è£…ã€‚åªè¦æŠŠæ¥å£å‚æ•°çº¦å®šæˆ &lt;code>func (ctx context.Context, req interface{}) (interface{}, error)&lt;/code> ä¸å°±å®Œäº†ï¼Ÿä¼ è¾“å±‚æ”¶åˆ°çš„è¯·æ±‚è§£ç æˆæœ¬åœ°æ•°æ®ç±»å‹ï¼Œç„¶åæŒ‰çº¦å®šä¼ å…¥ï¼Œå°±ä¸‡äº‹å¤§å‰äº†ã€‚&lt;/p>
&lt;p>ç©ºå£æ— å‡­ï¼Œä¸å¦‚çœ‹çœ‹å¦‚æœä¸è¦ endpointï¼Œå®é™…ç¼–å†™çš„ä»£ç ä¼šå˜æˆä»€ä¹ˆæ ·ã€‚&lt;/p>
&lt;p>åƒæ˜¯ go kit æä¾›çš„è¿™ç§å¸®åŠ©å‡½æ•°ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">uppercaseHandler&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">httptransport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewServer&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nf">makeUppercaseEndpoint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">svc&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">decodeUppercaseRequest&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">encodeResponse&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="nx">countHandler&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">httptransport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewServer&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nf">makeCountEndpoint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">svc&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">decodeCountRequest&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">encodeResponse&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯èƒ½å°±ä¼šå˜æˆè¿™æ ·ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">uppercaseHandler&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">httptransport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewServer&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">svc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Uppercase&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">decodeUppercaseRequest&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">encodeResponse&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="nx">countHandler&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">httptransport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewServer&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">svc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Count&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">decodeCountRequest&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">encodeResponse&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å½“ç„¶ï¼Œä¸ºäº†è®© Go è¯­è¨€çš„ç±»å‹ç³»ç»Ÿå¼€å¿ƒï¼Œè¿™é‡Œçš„ &lt;code>svc.Uppercase&lt;/code> å’Œ &lt;code>svc.Count&lt;/code> å¾—æ˜¯ä¸€æ ·çš„ç­¾åï¼Œæˆ–è€…ç”¨ &lt;code>interface{}&lt;/code> åšå½¢å‚ï¼Œåˆæˆ–è€…è€ƒè™‘è¿˜æ²¡æœ‰å‘å¸ƒçš„æ³›å‹èƒ½ä¸èƒ½æ”¯æŒã€‚&lt;/p>
&lt;p>çœ‹èµ·æ¥æ˜¯èˆ’æœäº†å¾ˆå¤šå¯¹å§ï¼ŸEndpoint æ²¡äº†ã€‚ä½†è¿˜æœ‰ä¸ªé—®é¢˜ï¼šä¸­é—´ä»¶ã€‚è¦æ€ä¹ˆå®ç°é€šç”¨çš„ä¸­é—´ä»¶ï¼Œåº”ç”¨åœ¨æ¯ä¸ªåŸæœ¬åº”è¯¥æ˜¯ Endpoint çš„åœ°æ–¹ï¼Ÿ&lt;/p>
&lt;p>ä¾‹å¦‚åœ¨å¾®æœåŠ¡ç³»ç»Ÿé‡Œå¾ˆå¸¸è§çš„åˆ†å¸ƒå¼è·Ÿè¸ªã€metricsæ”¶é›†ï¼Œæ— è®ºæœ€ç»ˆé‡‡ç”¨çš„æ˜¯ opentracingã€opencecusã€opentelemetry è¿˜æ˜¯ zipkinã€prometheusï¼Œè·Ÿè¸ªè°ƒç”¨é“¾è·¯æ˜¯ä¸€ä¸ªå¾ˆåŸºæœ¬çš„å¯è§‚æµ‹æ€§è¦æ±‚ã€‚å½“ç„¶ï¼Œä½ å¯ä»¥è¯´ç”¨ linkerd ä¸€ç±»çš„ service mesh è§£å†³æ–¹æ¡ˆï¼ˆè™½ç„¶æˆ‘è§‰å¾—ä¸èƒ½æ›¿ä»£ä¸Šé¢æåˆ°çš„è¿™äº›ä¸œè¥¿ï¼‰ï¼Œä½†ä¹Ÿåº”è¯¥æœ‰æ‰€è­¦æƒ•ï¼šæˆ‘ä»¬æ˜¯ä¸æ˜¯è¿˜æœ‰éœ€è¦åœ¨æ¯ä¸ªæ¥å£ä¸Šéƒ½æ‰§è¡Œã€å’Œä¼ è¾“å±‚æ— å…³çš„ä»£ç ï¼Ÿå¯¹ï¼Œè¿˜æœ‰èº«ä»½éªŒè¯å’Œé‰´æƒå·¥ä½œã€‚è¿˜æœ‰å—ï¼Ÿ&lt;/p>
&lt;p>å½“ç„¶ï¼Œä¹Ÿä¸æ˜¯è„±ç¦»äº† Endpoint å°±åˆ«æ— ä»–æ³•ï¼Œåªæ˜¯åœ¨éœ€è¦çš„æ—¶å€™ï¼Œæˆ‘æƒ³æ€»è¿˜æ˜¯ä¼šæœ‰æ„æ— æ„æŠ½è±¡å‡ºä¸€ä¸ªç±»ä¼¼ endpoint çš„å±‚çº§â€”â€”å¯èƒ½éšè—åœ¨ service ä¸­é—´ä»¶é‡Œï¼Œä¹Ÿå¯èƒ½äº¤ç»™äº†ä¼ è¾“å±‚ã€‚å¯èƒ½å†™å¾—æ›´å¥½ï¼Œä¹Ÿå¯èƒ½åˆæ˜¯åœ¨å †å±å±±ã€‚ç»éªŒå‘Šè¯‰æˆ‘åœ¨ä¸€ä¸ªéœ€è¦é•¿æœŸæ”¯æŒçš„ç³»ç»Ÿé‡Œï¼Œäººæ˜¯é ä¸ä½çš„ï¼Œä½†è§„èŒƒå¯ä»¥ã€‚endpoint å¹¶æ²¡æœ‰ç‰ºç‰²å¤šå°‘ç¼–ç ä¸Šçš„è‡ªç”±åº¦ï¼Œä½†ä¸€å®šç¨‹åº¦ä¸Šé¿å…äº†æ½œåœ¨çš„å †å±å¯èƒ½ï¼Œæˆ‘è§‰å¾—å®Œå…¨å¯ä»¥æ¥å—ã€‚&lt;/p>
&lt;h2 id="generic-ä¼šå¦‚ä½•å½±å“-go-kit-æ¶æ„">generic ä¼šå¦‚ä½•å½±å“ go kit æ¶æ„&lt;/h2>
&lt;p>æˆ‘ç›´è¯´ï¼ŒGo çš„æ³›å‹ï¼ˆbeta1ï¼‰å°±æ˜¯ä¸€æ³¡ç‹—å±ï¼Œæˆ‘å‘æ¥ä¸å–œæ¬¢ Go å›¢é˜Ÿçš„å“å‘³ï¼Œä» slice å’Œ interface{} æ³„éœ²è¯­è¨€çš„å®ç°ç»†èŠ‚åˆ°å…¶ä»–æ›´ç¦»è°±çš„ä¸œè¥¿ã€‚ä½†ç°åœ¨ Go æ³›å‹è¿˜æ²¡æœ‰æ­£å¼å…¬å¸ƒï¼ˆé¢„æœŸå°±åœ¨æœ¬æœˆï¼‰ï¼Œç°åœ¨æˆ‘ä¹Ÿæ²¡ä»€ä¹ˆå¥½è¯„è®ºçš„ã€‚&lt;/p>
&lt;p>generic ä¼šå½±å“ go kit çš„æ¶æ„å—ï¼Ÿæˆ‘çš„çœ‹æ³•æ˜¯ä¸ä¼šã€‚æ³›å‹ä¹Ÿè®¸èƒ½æå¤§å¸®åŠ©å„ç§å®¹å™¨ç±»å‹ã€è¿­ä»£å™¨ä¹‹ç±»é¥±å— &lt;code>interface{}&lt;/code> æŠ˜ç£¨çš„ç»„ä»¶ï¼Œä½†æ˜¯ go kit ç”¨å¾—ä¸Šæ³›å‹çš„åœ°æ–¹å…¶å®ä¸å¤šã€‚å°‘æ•°å¸¸è§çš„ &lt;code>interface{}&lt;/code> åœºåˆï¼Œéƒ½æ˜¯åœ¨ä»ä¸€ä¸ªç±»å‹é€‚é…åˆ°å¦ä¸€ä¸ªç±»å‹ï¼Œä»£ç ç¼–å†™è€…æ¸…æ¥šè‡ªå·±è¦å¤„ç†çš„ä¸¤ä¸ªç±»å‹ï¼Œä½† go kit ä¸çŸ¥é“ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">makeUppercaseEndpoint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">svc&lt;/span> &lt;span class="nx">StringService&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">endpoint&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Endpoint&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">_&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">request&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">req&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">request&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="nx">uppercaseRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">svc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Uppercase&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">S&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">uppercaseResponse&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">()},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">uppercaseResponse&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™éƒ¨åˆ†é€‚é…ä»£ç å¦‚æœæŠŠ &lt;code>interface{}&lt;/code> æ›¿æ¢æˆå…·ä½“çš„ &lt;code>uppercaseRequest&lt;/code> å’Œ &lt;code>uppercaseResponse&lt;/code> çš„è¯ï¼Œå°±éœ€è¦ go kit æä¾›æ³›å‹å½¢å¼çš„ Endpoint æ¥å£äº†ï¼Œåƒæ˜¯è¿™æ ·ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Endpoint&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">RequestType&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nx">ResponseType&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">RequestType&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ResponseType&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸Šé¢çš„ä»£ç æœ‰æ•ˆæ— æ•ˆå…ˆä¸è¯´ï¼Œæˆ‘è®°å¾—åœ¨ beta1 å°è¯•æ³›å‹çš„æ—¶å€™å‘ç° Go åœ¨æ¨æ–­ç±»å‹çš„æ—¶å€™å­˜åœ¨é—®é¢˜ï¼Œè¿™ä¸ª &lt;code>RequestType&lt;/code> å’Œ &lt;code>ResponseType&lt;/code> åœ¨å®é™…ç”¨çš„æ—¶å€™æ€•æ˜¯è¦å†™ä¸æ­¢ä¸€æ¬¡ã€‚åˆæ˜¯ Go ç‰¹è‰²çš„å•°å—¦ã€‚&lt;/p>
&lt;p>å¯å³ä¾¿æ˜¯è¿™æ ·ææ€•è¿˜æœ‰é—®é¢˜ï¼Œå¦‚æœä¿®æ”¹äº† &lt;code>Endpoint&lt;/code> çš„ç­¾åï¼Œé‚£ä¹ˆ &lt;code>endpoint.Middleware&lt;/code> ææ€•ä¹Ÿè¦æ³›å‹åŒ–ï¼ŒåŸæ¥çš„æ‰€æœ‰ä¸­é—´ä»¶åº“ï¼Œ&lt;code>trace&lt;/code>ã€&lt;code>auth&lt;/code>ã€&lt;code>metrics&lt;/code> å¯èƒ½ä¹Ÿå¾—åšæ³›å‹åŒ–æ”¹é€ ã€‚å¯¹ä¸€ä¸ªå·²ç»æ·±åº¦å¼€å‘è¿‡çš„ç³»ç»Ÿæ¥è¯´ï¼Œä¸ºäº†è¿™ä¸€ç‚¹ç±»å‹æ£€æŸ¥çš„å¥½å¤„ä»˜å‡ºå¦‚æ­¤ä»£ä»·ææ€•æ˜¯ä¸èƒ½æ¥å—çš„ã€‚&lt;/p>
&lt;p>æ€»è€Œè¨€ä¹‹ï¼Œæˆ‘çš„è§‚ç‚¹æ˜¯ Generic å¯èƒ½å¸¦æ¥å˜åŒ–ï¼Œä½†æ ¹æœ¬ä¸Šçš„å‡ ä¸ªæŠ½è±¡ä¸å¤§å¯èƒ½è·Ÿç€é‡æ„ï¼Œè¿™æ˜¯ç”± go kit æ€§è´¨å†³å®šçš„ã€‚&lt;/p>
&lt;h2 id="go-kit-ä»£ç ç”Ÿæˆ">go kit ä»£ç ç”Ÿæˆ&lt;/h2>
&lt;p>ä½†å‡¡è·Ÿç€ go kit å†™è¿‡ä¸€ä¸ª stringsvc çš„äººéƒ½ä¼šæ„Ÿè§‰åˆ° go kit æœ‰å¤šå°‘æ ·æ¿ä»£ç ï¼Œé€‚é…ä¼ è¾“å±‚éœ€è¦ç¼–å†™ encode/decodeï¼Œæœ¬åœ°ç»“æ„è½¬å‡½æ•°ç­¾åæ‰€éœ€çš„å‚æ•°åˆè¦ä¸€æ¬¡è½¬æ¢ï¼Œä¼ è¾“å±‚åè®®ç›‘å¬ã€æ³¨å†Œ&lt;code>Handler&lt;/code>ã€å®¢æˆ·ç«¯è¿æ¥éƒ½è¦è‡ªå·±ç¼–å†™ä»£ç ï¼Œæ„é€ å’Œæ³¨å†Œ &lt;code>Endpoint&lt;/code> å¤æ‚æ€§æ— éæ˜¯ä» &lt;code>func main&lt;/code> ç§»åŠ¨åˆ° &lt;code>transport&lt;/code> æˆ–è€…åè¿‡æ¥ï¼Œå°½ç®¡å¾ˆçƒ¦ï¼Œä½†åˆæ— æ³•æ ¹æœ¬ä¸Šæ¶ˆé™¤ã€‚&lt;/p>
&lt;p>å¦‚æœæ˜¯ C++ ææ€•ä¼šæœ‰æ¨¡æ¿å…ƒç¼–ç¨‹å¤§ä½¬æ™’è‡ªå·±çš„ &lt;code>template&lt;/code>ï¼Œä½† Go åŸºæœ¬æ²¡æœ‰ç¼–è¯‘æ—¶å’Œè¿è¡Œæ—¶çš„å…ƒç¼–ç¨‹èƒ½åŠ›ã€‚å”¯ä¸€æ¯”è¾ƒæ“…é•¿çš„å°±åªæœ‰ä¸ªä»£ç ç”Ÿæˆäº†ã€‚Go æä¾›çš„ &lt;code>ast/parser&lt;/code> åŒ…å¾ˆèµï¼Œåˆ«çš„è¯­è¨€å°‘æœ‰æä¾›è¿™ä¹ˆæ–¹ä¾¿çš„æ¥å£çš„ã€‚&lt;/p>
&lt;p>go kit çš„ä»£ç ç”Ÿæˆï¼Œä»ç›®å‰ä½“éªŒä¸­æ„Ÿå—æ¥çœ‹ï¼Œä¸»è¦æ˜¯éœ€è¦ä¸‹é¢çš„åŠŸèƒ½ï¼š&lt;/p>
&lt;ol>
&lt;li>ä» &lt;code>interface&lt;/code> å®šä¹‰ç”Ÿæˆå¯¹åº”çš„ &lt;code>makeEndpoint&lt;/code> å‡½æ•°å’Œè¯·æ±‚/å“åº”ç»“æ„ä½“ã€‚è¿™éƒ¨åˆ†ä»£ç åŸºæœ¬æ²¡ä»€ä¹ˆç‰¹åˆ«çš„ã€‚&lt;/li>
&lt;li>ä» &lt;code>interface&lt;/code> å®šä¹‰ç”Ÿæˆå¯¹åº”çš„ &lt;code>transport&lt;/code> åŒ…ï¼Œå¯ä»¥è‡ªå·±é€‰æ‹©åè®®ã€‚ä¸»è¦è§£å†³ encode/decode æ‰‹å†™éº»çƒ¦çš„é—®é¢˜ã€‚&lt;/li>
&lt;li>ä» &lt;code>interface&lt;/code> å®šä¹‰ç”ŸæˆæœåŠ¡æ„é€ å’Œå¯åŠ¨ä»£ç ï¼Œåº”ç”¨å¯ä»¥è‡ªå·±æ„é€ ï¼Œä½† &lt;code>endpoint&lt;/code> çš„æ„é€ å’Œ &lt;code>middleware&lt;/code> çš„åº”ç”¨å°±å¯ä»¥ä¸ç”¨è‡ªå·±å†™äº†ã€‚&lt;/li>
&lt;/ol>
&lt;p>è¿™ä¸‰å¤„çš„æ ·æ¿ä»£ç æœ€å¤šï¼Œè€Œä¸”ä»£ç æœ¬èº«å¹¶ä¸ç‰¹åˆ«ï¼Œéƒ½æ˜¯ç®€å•åœ°å¯¹ç±»å‹è¿›è¡Œé€‚é…ï¼Œæ‰‹å†™å®Œå…¨æ˜¯æµªè´¹æ—¶é—´ï¼Œè¿˜ä¼šå¼•å…¥äººä¸ºçš„ä¸ç¡®å®šæ€§ï¼Œä¸å¦‚è®©æœºå™¨æå®šã€‚ç›®å‰è€ƒå¯Ÿè¿‡çš„ &lt;a class="link" href="https://github.com/GrantZheng/kit" target="_blank" rel="noopener"
>kit&lt;/a> å®ç°äº†å…¶ä¸­ä¸€å¤§éƒ¨åˆ†ï¼Œä½† transport æ”¯æŒå¤ªå°‘ï¼Œä¹Ÿæ²¡æœ‰ç”Ÿæˆæ³¨å†Œ endpoint çš„ä»£ç ï¼Œä¾ç„¶å­˜åœ¨å¾ˆå¤šæ‰‹å†™çš„æ ·æ¿ä»£ç ã€‚æˆ‘ç®€å•çœ‹äº†ä¸‹å®ç°ï¼Œç”¨ &lt;a class="link" href="https://github.com/dave/jennifer" target="_blank" rel="noopener"
>jennifer&lt;/a> ç”Ÿæˆä»£ç å¥½æ˜¯æŒºå¥½ï¼Œå°±æ˜¯ go ä»£ç æ˜¾å¾—æœ‰ç‚¹ä¹± &amp;hellip;&lt;/p>
&lt;p>æˆ‘å¯»æ€å¯¹ generator ç®€å•é‡æ„ä¸‹å®ç°å…³æ³¨ç‚¹åˆ†ç¦»çš„è¯ï¼Œè¿˜æ˜¯èƒ½æ»¡è¶³ä¸Šé¢æåˆ°çš„è¿™äº›ä¸œè¥¿çš„ã€‚æœ€å¥½çš„æƒ…å†µæ˜¯å®šä¹‰å¥½ interface ä¹‹åï¼Œç”Ÿæˆä»£ç ï¼Œç¼–å†™ä¸»å‡½æ•°ï¼Œå°±èƒ½ç›´æ¥è¿è¡Œäº†ã€‚åŒæ—¶åˆä¸ä¼¤å®³ go kit æ¶æ„æœ¬èº«çš„æ‰©å±•æ€§å’Œå¯å®šåˆ¶æ€§ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 78;
flex-basis: 189px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/my-opinion-of-gokit-architecture/image-20220302154943857.png" data-size="420x533">
&lt;img src="https://nnnewb.github.io/blog/blog/p/my-opinion-of-gokit-architecture/image-20220302154943857.png"
width="420"
height="533"
srcset="https://nnnewb.github.io/blog/blog/p/my-opinion-of-gokit-architecture/image-20220302154943857_hu9cb516ff1b199527543c48b61b9d85b3_16922_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/my-opinion-of-gokit-architecture/image-20220302154943857_hu9cb516ff1b199527543c48b61b9d85b3_16922_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="go kitæ¶æ„çš„æœåŠ¡">
&lt;/a>
&lt;figcaption>go kitæ¶æ„çš„æœåŠ¡&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>è›®å–œæ¬¢ go kit é¡¹ç›®ä½œè€…çš„ä¸€å¥è¯ï¼š&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 416;
flex-basis: 1000px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/my-opinion-of-gokit-architecture/image-20220302155216922.png" data-size="917x220">
&lt;img src="https://nnnewb.github.io/blog/blog/p/my-opinion-of-gokit-architecture/image-20220302155216922.png"
width="917"
height="220"
srcset="https://nnnewb.github.io/blog/blog/p/my-opinion-of-gokit-architecture/image-20220302155216922_hu9feb75af39e108f8eeb86c8e5ed70db9_25876_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/my-opinion-of-gokit-architecture/image-20220302155216922_hu9feb75af39e108f8eeb86c8e5ed70db9_25876_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="issueæˆªå›¾">
&lt;/a>
&lt;figcaption>issueæˆªå›¾&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;blockquote>
&lt;p>Honestly the best way to &amp;ldquo;use&amp;rdquo; Go kit is to cop it&amp;rsquo;s architectural model and not actually import any of its packages at all ğŸ˜‰&lt;/p>
&lt;/blockquote>
&lt;p>å…¶å®æˆ‘ä¹Ÿæƒ³æŠŠè¿™å¥—æ¶æ„æ¬è¿›é¡¹ç›®é‡Œï¼Œå¯æƒœæ¡ä»¶ä¸å…è®¸ï¼Œè¿˜æœ‰æ›´ä¸¥é‡çš„é—®é¢˜è¦å¤„ç†ï¼Œåªèƒ½å…ˆçœ¼é¦‹ä¸€ä¸‹ï¼Œå¸æ”¶ä¸‹ç²¾ç¥ã€‚&lt;/p></description></item><item><title>go-kit ç¬”è®°</title><link>https://nnnewb.github.io/blog/p/go-kit-note/</link><pubDate>Tue, 01 Mar 2022 12:30:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/go-kit-note/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>åˆæ­¥çœ‹äº†ä¸‹ gokit çš„æ¡ˆä¾‹ &lt;code>stringsvc&lt;/code>å’Œ&lt;code>apigateway&lt;/code>ï¼Œè®°å½•ä¸€ä¸‹å¯¹ gokit çš„æ˜ åƒã€‚&lt;/p>
&lt;h2 id="gokitå®šä½">gokitå®šä½&lt;/h2>
&lt;blockquote>
&lt;p>&lt;strong>Go kit&lt;/strong> is a &lt;strong>programming toolkit&lt;/strong> for building microservices (or elegant monoliths) in Go. We solve common problems in distributed systems and application architecture so you can focus on delivering business value.&lt;/p>
&lt;p>Go has emerged as the language of the server, but it remains underrepresented in so-called &amp;ldquo;modern enterprise&amp;rdquo; companies like Facebook, Twitter, Netflix, and SoundCloud. Many of these organizations have turned to JVM-based stacks for their business logic, owing in large part to libraries and ecosystems that directly support their microservice architectures.&lt;/p>
&lt;p>To reach its next level of success, Go needs more than simple primitives and idioms. It needs a comprehensive toolkit, for coherent distributed programming in the large. Go kit is a set of packages and best practices, which provide a comprehensive, robust, and trustable way of building microservices for organizations of any size.&lt;/p>
&lt;/blockquote>
&lt;p>gokit å¤§æ¦‚ç®—æ˜¯æ¡†æ¶ï¼Œå› ä¸ºå’Œ gokit æ‰“äº¤é“åŸºæœ¬ç¦»ä¸å¼€ gokit å®šä¹‰çš„å‡ ä¸ªæ¥å£ç±»å‹ã€‚ç”¨ gokit å¼€å‘æœåŠ¡çš„å¯å®šåˆ¶æ€§å¾ˆå¼ºï¼Œå‡ ä¹æ¯ä¸ªç»†èŠ‚éƒ½å¯ä»¥æ§åˆ¶ã€‚&lt;/p>
&lt;p>è€Œå®é™…ä¸Šæ‰‹ä½“éªŒä¸‹æ¥ï¼Œç¼ºç‚¹å¤§æ¦‚å°±æ˜¯æµ·é‡çš„æ ·æ¿ä»£ç ï¼Œå®ç°ä¸€ä¸ªæœåŠ¡éœ€è¦å¤§é‡çš„é€‚é…ä»£ç æ¥æ§åˆ¶ Endpoint ã€‚åˆå› ä¸º Go è¯­è¨€è¡¨ç°åŠ›ä¸è¶³ï¼Œä¹Ÿæ²¡æœ‰è¿è¡Œæ—¶å…ƒç¼–ç¨‹çš„èƒ½åŠ›ï¼Œè¿™äº›æ ·æ¿ä»£ç åªèƒ½é ä»£ç ç”Ÿæˆæ¥è§£å†³ã€‚&lt;/p>
&lt;p>è¿˜å¥½ gokit è‡ªå·±ä¹ŸçŸ¥é“ï¼Œåœ¨ä»“åº“é¦–é¡µå°±æä¾›äº†å¾ˆå¤šä»£ç ç”Ÿæˆå™¨çš„é“¾æ¥ã€‚&lt;/p>
&lt;p>ç”¨ gokit è¿˜æœ‰ä¸€ä¸ªå¥½å¤„æ˜¯ä¸€å®šç¨‹åº¦ä¸Šé¿å…æŠ€æœ¯æ ˆç»‘å®šåœ¨æŸä¸ªç‰¹å®šå¹³å°æˆ–è€…æ¡†æ¶ä¸Šï¼Œæ¯•ç«Ÿ gokit æ¯”èµ·æ¡†æ¶ï¼Œæ›´åƒæ˜¯ä¸€ä¸ªå·¥å…·ç®±ï¼Œç»„ä»¶ä¹‹é—´æ²¡æœ‰ç‰¹åˆ«çš„ä¾èµ–å…³ç³»ï¼Œé¡ºæ‰‹å°±ç”¨ï¼Œä¸é¡ºæ‰‹å¯ä»¥æ¢ä¸ªé”¤å­ã€‚&lt;/p>
&lt;h2 id="æ¡†æ¶æ­å»º">æ¡†æ¶æ­å»º&lt;/h2>
&lt;h3 id="é¸Ÿç°">é¸Ÿç°&lt;/h3>
&lt;p>gokit ç¼–å†™çš„æœåŠ¡æœ‰å‡ ä¸ªåŸºæœ¬å…ƒç´ ï¼Œè¿™äº›åŸºæœ¬å…ƒç´ éƒ½æ˜¯å›´ç»• &lt;strong>Endpoint&lt;/strong> æ¥å£è½¬çš„ï¼Œgokit è‡ªå·±æŠŠ Endpoint ç§°ä¸º &lt;em>æ„å»ºæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çš„åŸºæœ¬å—&lt;/em> ã€‚&lt;/p>
&lt;p>å‡ ä¸ªåŸºæœ¬å…ƒç´ æ˜¯ï¼š&lt;/p>
&lt;ul>
&lt;li>æœåŠ¡æ¥å£å®šä¹‰ &lt;code>type StringService interface { /*...*/ }&lt;/code>&lt;/li>
&lt;li>åº”ç”¨çº§ä¸­é—´ä»¶å®šä¹‰ &lt;code>type AppMiddleware struct {} // implement StringService&lt;/code>&lt;/li>
&lt;li>ä¼ è¾“å±‚æ¥å£å®šä¹‰ï¼ŒåŒ…æ‹¬ &lt;code>Endpoint&lt;/code> å®šä¹‰ã€åºåˆ—åŒ–ã€æœåŠ¡å‘ç°ç­‰&lt;/li>
&lt;li>ä¼ è¾“å±‚ä¸­é—´ä»¶å®šä¹‰ï¼Œ&lt;code>type Middleware func(Endpoint) Endpoint&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>æ­¤å¤–è¿˜æœ‰ä¸€äº›å¯é€‰çš„ç»„ä»¶ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>tracing&lt;/code>ï¼Œåˆ†å¸ƒå¼è·Ÿè¸ª&lt;/li>
&lt;li>&lt;code>ratelimit&lt;/code>ï¼Œé™æµ&lt;/li>
&lt;li>&lt;code>metrics&lt;/code>ï¼ŒæŒ‡æ ‡æ”¶é›†&lt;/li>
&lt;li>&lt;code>log&lt;/code>ï¼Œæ—¥å¿—æ”¶é›†&lt;/li>
&lt;li>&lt;code>circuitbreaker&lt;/code>ï¼Œç†”æ–­&lt;/li>
&lt;li>&lt;code>auth&lt;/code>ï¼Œèº«ä»½è®¤è¯&lt;/li>
&lt;/ul>
&lt;p>æˆ‘è‡ªå·±æ•´çš„ç›®å½•ç»“æ„å¦‚ä¸‹ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 91;
flex-basis: 220px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220228155029310.png" data-size="234x255">
&lt;img src="https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220228155029310.png"
width="234"
height="255"
srcset="https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220228155029310_hu1b61ce4442b934d4130680e952a0c52e_9034_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220228155029310_hu1b61ce4442b934d4130680e952a0c52e_9034_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="ç›®å½•ç»“æ„">
&lt;/a>
&lt;figcaption>ç›®å½•ç»“æ„&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æœåŠ¡æœ¬è´¨æ˜¯ä¸€ç³»åˆ—æ¥å£çš„é›†åˆï¼Œgokit çš„ tutorial ä¸­å°†æœåŠ¡æŠ½è±¡æˆäº†ä¸€ä¸ª &lt;code>interface&lt;/code> ï¼Œåœ¨è¿™ä¸ªæ¥å£ä¸Šç”¨æˆ·å¯ä»¥æä¾›ä¸åŒå®ç°ã€‚åƒæ˜¯æœåŠ¡ç«¯ã€å®¢æˆ·ç«¯ã€ä¸­é—´ä»¶ï¼Œä¸ç®¡ä¼ è¾“å±‚æ€ä¹ˆå®šä¹‰ï¼Œæœ€ç»ˆå®ç°çš„éƒ½æ˜¯è¿™ä¸ªæ¥å£ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">StringService&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">Uppercase&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">Count&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¾®æœåŠ¡çš„å¼€å‘è€…æä¾›è¿™ä¸ªæ¥å£çš„å®ç°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">StringServiceImpl&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">StringServiceImpl&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Uppercase&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">arg&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">arg&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">strings&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ToUpper&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">arg&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">StringServiceImpl&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Count&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">arg&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">arg&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶åé€šè¿‡æŸç§ä¼ è¾“å±‚åè®®æš´éœ²ç»™è°ƒç”¨æ–¹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">MakeUppercaseEndpoint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">svc&lt;/span> &lt;span class="nx">stringsvc1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">StringService&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">endpoint&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Endpoint&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">request&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">req&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">request&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="nx">UppercaseRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">svc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Uppercase&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">S&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">UppercaseResponse&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">V&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// ... ç•¥
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">logger&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewLogfmtLogger&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stderr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">svc&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">stringsvc1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">StringServiceImpl&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">uppercase&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">transport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">MakeUppercaseEndpoint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">svc&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">uppercaseHandler&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">httptransport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewServer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">uppercase&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">transport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DecodeUppercaseRequest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">transport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">EncodeResponse&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Handle&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/uppercase&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">uppercaseHandler&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">count&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">transport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">MakeCountEndpoint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">svc&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">countHandler&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">httptransport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewServer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">count&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">transport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DecodeCountRequest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">transport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">EncodeResponse&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Handle&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/count&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">countHandler&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">logger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;msg&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;HTTP&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;addr&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;:8080&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">logger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;err&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ListenAndServe&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;:8080&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸€ä¸ªç®€å•çš„æœåŠ¡æä¾›æ–¹éœ€è¦åšçš„å°±æ˜¯è¿™äº›ã€‚ä¸‹é¢å…·ä½“çœ‹çœ‹å…¶ä¸­æ¶‰åŠçš„æ¦‚å¿µã€‚&lt;/p>
&lt;h3 id="endpoint-è§£æ">endpoint è§£æ&lt;/h3>
&lt;p>ä¸€ä¸ªæœ€ç®€å•çš„æœåŠ¡ &lt;code>Endpoint&lt;/code> å®šä¹‰å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;context&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;encoding/json&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;net/http&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;os&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;strings&amp;#34;&lt;/span>
&lt;span class="nx">httptransport&lt;/span> &lt;span class="s">&amp;#34;github.com/go-kit/kit/transport/http&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/go-kit/log&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">uppercaseRequest&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">S&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;s,omitempty&amp;#34;`&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">uppercaseResponse&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">S&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;s,omitempty&amp;#34;`&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">logger&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewLogfmtLogger&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stderr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Handle&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/uppercase&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">httptransport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewServer&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="c1">// endpoint å®šä¹‰
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">request&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">response&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">req&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">request&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="nx">uppercaseRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">S&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">uppercaseResponse&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">uppercaseResponse&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">strings&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ToUpper&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">S&lt;/span>&lt;span class="p">)},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="c1">// è¯·æ±‚ decoder
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">r&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">request&lt;/span> &lt;span class="nx">uppercaseRequest&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">json&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewDecoder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Body&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">request&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">request&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="c1">// å“åº” encoder
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">w&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ResponseWriter&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">response&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">json&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewEncoder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">w&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Encode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">response&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="p">))&lt;/span>
&lt;span class="nx">logger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;msg&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;HTTP&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;addr&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;:8080&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">logger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;err&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ListenAndServe&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;:8080&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>Endpoint&lt;/code> æœ¬è´¨æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œç±»å‹ç­¾åå¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// Endpoint is the fundamental building block of servers and clients.
&lt;/span>&lt;span class="c1">// It represents a single RPC method.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Endpoint&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">request&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">response&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>Endpoint&lt;/code> æŠ½è±¡äº† RPC è°ƒç”¨ï¼Œéšè—äº†è°ƒç”¨å¯¹è±¡æ˜¯â€œæœ¬åœ°â€è¿˜æ˜¯â€œè¿œç¨‹â€çš„ã€‚åƒæ˜¯ä¸Šé¢çš„æ¡ˆä¾‹é‡Œï¼Œ&lt;code>Endpoint&lt;/code> èƒŒåæ˜¯æœ¬åœ°çš„ä»£ç ã€‚è€Œåœ¨å®¢æˆ·ç«¯ä½¿ç”¨&lt;code>Endpoint&lt;/code>æ—¶ï¼Œ&lt;code>Endpoint&lt;/code>çš„èƒŒåå¾€å¾€æ˜¯ä¼ è¾“å±‚ä»£ç ï¼Œå‘èµ·äº†ä¸€æ¬¡è¿œç¨‹è°ƒç”¨ã€‚&lt;/p>
&lt;p>&lt;code>Endpoint&lt;/code> æœ¬èº«ä¸åšè¯·æ±‚/å“åº”çš„ç¼–è§£ç å·¥ä½œï¼Œè¿›å…¥ &lt;code>Endpoint&lt;/code> çš„éƒ½æ˜¯å·²ç»å‡†å¤‡å¥½çš„ç»“æ„åŒ–æ•°æ®ã€‚&lt;/p>
&lt;h3 id="endpointmiddleware-è§£æ">endpoint.Middleware è§£æ&lt;/h3>
&lt;p>&lt;code>endpoint.Middleware&lt;/code> æ˜¯åœ¨ &lt;code>Endpoint&lt;/code> ä¸ŠåŒ…è£…çš„ä¸­é—´ä»¶ï¼Œç­¾åå¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// Middleware is a chainable behavior modifier for endpoints.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Middleware&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Endpoint&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">Endpoint&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å’Œ &lt;code>gin&lt;/code> ä¹‹ç±»çš„æ¡†æ¶ä¸­é—´ä»¶ä½“ç³»å¾ˆç›¸ä¼¼ï¼Œéƒ½æ˜¯åŸºäºé«˜é˜¶å‡½æ•°çš„æ–¹å¼ã€‚ä¸€ä¸ªç®€å•çš„æ—¥å¿—ä¸­é—´ä»¶å®ç°å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;context&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/go-kit/kit/endpoint&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/go-kit/log&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">LoggingMiddleware&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">logger&lt;/span> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Logger&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">endpoint&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Middleware&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">next&lt;/span> &lt;span class="nx">endpoint&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Endpoint&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">endpoint&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Endpoint&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">request&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">logger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;msg&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;calling endpoint&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">logger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;msg&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;called endpoint&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nf">next&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">request&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åƒè¿™æ ·å®šä¹‰çš„ä¸­é—´ä»¶ç”¨æ³•ä¹Ÿå¾ˆç®€å•ï¼Œä»¥ &lt;code>Endpoint&lt;/code> ä¸ºå‚æ•°è°ƒç”¨å³å¯ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nf">LoggingMiddleware&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">With&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">logger&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;method&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;method-name&amp;#34;&lt;/span>&lt;span class="p">))(&lt;/span>&lt;span class="nx">endpoint&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¯´èµ·è¿™ä¸ªæˆ‘å°±æ€€å¿µ python çš„è£…é¥°å™¨ã€‚&lt;/p>
&lt;h3 id="åº”ç”¨ä¸­é—´ä»¶">åº”ç”¨ä¸­é—´ä»¶&lt;/h3>
&lt;p>åº”ç”¨ä¸­é—´ä»¶ä¸ç®—æ˜¯ gokit çš„ä¸€éƒ¨åˆ†ï¼Œgokit çš„ç¤ºä¾‹ä¸­ç»™å‡ºäº†&lt;a class="link" href="http://gokit.io/examples/stringsvc.html#application-logging" target="_blank" rel="noopener"
>åº”ç”¨çº§ä¸­é—´ä»¶çš„åšæ³•&lt;/a>ã€‚å®è¯è¯´æˆ‘ä¸å–œæ¬¢ã€‚&lt;/p>
&lt;p>æ‰€è°“çš„åº”ç”¨ä¸­é—´ä»¶åšæ³•å…¶å®å°±æ˜¯å†å®šä¹‰ä¸€ä¸ªç»“æ„ï¼Œå®ç°ä½ çš„æœåŠ¡æ¥å£ï¼Œç„¶ååœ¨å®ç°çš„æœåŠ¡æ¥å£é‡ŒåŠ ä¸Šéœ€è¦çš„ä¸­é—´ä»¶ä»£ç ã€‚&lt;/p>
&lt;p>å¦‚æœè¦è¯´æœ‰ä»€ä¹ˆå¥½å¤„çš„è¯ï¼Œå°±æ˜¯æ»¡è¶³äº†ç±»å‹çº¦æŸï¼Œå…å»äº†ç”¨ &lt;code>reflect&lt;/code>ã€‚&lt;code>Endpoint&lt;/code>ä¸€çº§çš„ä¸­é—´ä»¶åªèƒ½æ‹¿åˆ°ä¸€ä¸ª &lt;code>request interface{}&lt;/code> ï¼Œä½†ä¸‹é¢è¿™æ ·å†™çš„è¯ï¼Œå‚æ•°å°±æ˜¯å·²ç»å¡«å¥½çš„äº†ï¼ŒæœåŠ¡å®ç°é‡Œæ‹¿åˆ°ä»€ä¹ˆå‚æ•°è¿™ä¸ªä¸­é—´ä»¶å°±æ‹¿åˆ°ä»€ä¹ˆå‚æ•°ã€‚ä½†é—®é¢˜ä¹Ÿå¾ˆæ˜æ˜¾â€”â€”ä¸ºäº†æ»¡è¶³ &lt;code>type Service interface&lt;/code> çš„çº¦æŸï¼Œè¿™æ ·çš„ä¸­é—´ä»¶å¿…é¡»æŠŠæœåŠ¡çš„æ‰€æœ‰æ¥å£éƒ½å†™ä¸ª stub ã€‚å°±ç®—æ˜¯ç”¨ç¼–è¾‘å™¨çš„ &lt;code>generate interface stubs&lt;/code> åŠŸèƒ½ä¹Ÿæ²¡æ³•ç›´æ¥å¸®ä½ å¡«å¥½è½¬å‘å‚æ•°çš„ä»£ç å•Š&amp;hellip;&lt;/p>
&lt;p>æˆ‘è‡ªå·±å€’æ˜¯æŠ˜è…¾å‡ºä¸€ä¸ªæœ‰ç‚¹æ€ªçš„è§£æ³•ï¼Œåˆ©ç”¨ go çš„ embed å­—æ®µå’ŒåŠ¨æ€åˆ†å‘æœºåˆ¶ï¼Œéƒ¨åˆ†å®ç°äº†æœ‰ç»§æ‰¿çš„è¯­è¨€é‡Œçš„ override ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;play/stringsvc1&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/go-kit/log&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">LoggingMiddleware&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">stringsvc1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">StringService&lt;/span> &lt;span class="c1">// LoggingMiddleware è‡ªå·±æ²¡æœ‰å®ç°å…¨éƒ¨çš„ stringsvc1.StringService æ¥å£ï¼Œä½†è¿™ä¸ª embed å­—æ®µå®ç°äº†
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Logger&lt;/span> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Logger&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// è¿™ä¸ªå®ç°è¦†ç›–æ‰äº†ç»“æ„é‡Œçš„ stringsvc1.StringService.Uppercase æš´éœ²çš„å®ç°
&lt;/span>&lt;span class="c1">// ç„¶åå†…éƒ¨åˆä½¿ç”¨äº† `.StringService.Uppercase` è¿™ç§è¯­æ³•æ¥è°ƒç”¨ç»“æ„é‡Œçš„
&lt;/span>&lt;span class="c1">// stringsvc1.StringService.Uppercase å®ç°
&lt;/span>&lt;span class="c1">// å°±åƒæ˜¯æœ‰ç»§æ‰¿çš„è¯­è¨€é‡Œå­ç±»é€šè¿‡ super() æˆ–è€… ParentClass::Uppercase è¿™æ ·çš„æ–¹å¼è°ƒç”¨çˆ¶ç±»å®ç°ä¸€æ ·ã€‚
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">LoggingMiddleware&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Uppercase&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Logger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;msg&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;call endpoint&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;arg&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Logger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;msg&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;called endpoint&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;arg&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">StringService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Uppercase&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>é€šè¿‡è¿™ç§åŠæ³•å€’æ˜¯å®ç°äº†åº”ç”¨çº§çš„ç‰¹å®šæ¥å£ä¸­é—´ä»¶ã€‚ä½†è¿˜è¦å¦å¤–å®šä¹‰ä¸€ä¸ª &lt;code>struct&lt;/code> ä¹Ÿæ¯”è¾ƒéº»çƒ¦ã€‚&lt;/p>
&lt;p>è´´ä¸€ä¸‹ç¤ºä¾‹é‡Œçš„ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// middleware.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">loggingMiddleware&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">logger&lt;/span> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Logger&lt;/span>
&lt;span class="nx">next&lt;/span> &lt;span class="nx">StringService&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">mw&lt;/span> &lt;span class="nx">loggingMiddleware&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Uppercase&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">output&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">begin&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Time&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">mw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">logger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Log&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;method&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;uppercase&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s">&amp;#34;input&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s">&amp;#34;output&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">output&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s">&amp;#34;err&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s">&amp;#34;took&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Since&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">begin&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="p">}(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Now&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="nx">output&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">mw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">next&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Uppercase&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// main.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;os&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/go-kit/kit/log&amp;#34;&lt;/span>
&lt;span class="nx">httptransport&lt;/span> &lt;span class="s">&amp;#34;github.com/go-kit/kit/transport/http&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">logger&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewLogfmtLogger&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stderr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">svc&lt;/span> &lt;span class="nx">StringService&lt;/span>
&lt;span class="nx">svc&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">stringService&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">svc&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">loggingMiddleware&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">logger&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">svc&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="nx">uppercaseHandler&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">httptransport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewServer&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nf">makeUppercaseEndpoint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">svc&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å®¢æˆ·ç«¯å®ç°">å®¢æˆ·ç«¯å®ç°&lt;/h3>
&lt;p>å®¢æˆ·ç«¯å®ç°å¯ä»¥å¾ˆç®€å•ï¼ŒåŒæ ·æœ‰å¾ˆå¼ºçš„æ‰©å±•æ€§ã€‚æ¯”å¦‚è¯´å¯ä»¥ç»“åˆæœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€é¢‘ç‡é™åˆ¶ã€ç†”æ–­å™¨å®ç°ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„å®¢æˆ·ç«¯ã€‚&lt;/p>
&lt;p>å…ˆä»ç®€å•çš„å¼€å§‹ã€‚ä¸€èˆ¬è€ƒè™‘å®¢æˆ·ç«¯å®ç°çš„è¯ï¼Œä¼šå‡†å¤‡ä¸€ä¸ªç‰¹æ®Šçš„ç»“æ„æ¥ä¿å­˜æœåŠ¡çš„ &lt;code>Endpoint&lt;/code>ï¼Œå†å¯¹è¿™ä¸ªç»“æ„å®ç°æœåŠ¡å®šä¹‰çš„æ¥å£ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// https://github.com/go-kit/examples/blob/master/addsvc/pkg/addendpoint/set.go
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// Set collects all of the endpoints that compose an add service. It&amp;#39;s meant to
&lt;/span>&lt;span class="c1">// be used as a helper struct, to collect all of the endpoints into a single
&lt;/span>&lt;span class="c1">// parameter.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Set&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">SumEndpoint&lt;/span> &lt;span class="nx">endpoint&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Endpoint&lt;/span>
&lt;span class="nx">ConcatEndpoint&lt;/span> &lt;span class="nx">endpoint&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Endpoint&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Sum implements the service interface, so Set may be used as a service.
&lt;/span>&lt;span class="c1">// This is primarily useful in the context of a client library.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="nx">Set&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Sum&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">b&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">resp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SumEndpoint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">SumRequest&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">A&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">B&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">})&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">response&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">resp&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="nx">SumResponse&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">response&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">V&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">response&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// ... ç•¥
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ä¹ˆåšçš„å¥½å¤„æ˜¯å¯ä»¥åƒæ˜¯è°ƒç”¨ Go æ–¹æ³•ä¸€æ ·å»è°ƒç”¨ RPC å‡½æ•°ï¼Œæ¯”èµ· &lt;code>grpc&lt;/code> ä¸€ç±»çš„è°ƒç”¨æ–¹å¼æ¥è¯´æ›´ç›´è§‚äº†ã€‚&lt;/p>
&lt;p>å®¢æˆ·ç«¯çš„ &lt;code>Endpoint&lt;/code> çš„æ„é€ æ–¹å¼å’ŒæœåŠ¡å™¨ä¸ä¸€æ ·ï¼Œéšè—åœ¨ &lt;code>Endpoint&lt;/code> èƒŒåçš„ä¸æ˜¯æœ¬åœ°ä»£ç ï¼Œè€Œæ˜¯ä¸€ä¸ªç½‘ç»œè¯·æ±‚ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// Each individual endpoint is an http/transport.Client (which implements
&lt;/span>&lt;span class="c1">// endpoint.Endpoint) that gets wrapped with various middlewares. If you
&lt;/span>&lt;span class="c1">// made your own client library, you&amp;#39;d do this work there, so your server
&lt;/span>&lt;span class="c1">// could rely on a consistent set of client behavior.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">var&lt;/span> &lt;span class="nx">sumEndpoint&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">httptransport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewClient&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;POST&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nf">copyURL&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">u&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;/sum&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">encodeHTTPGenericRequest&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">decodeHTTPSumResponse&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">).&lt;/span>&lt;span class="nf">Endpoint&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>github.com/go-kit/kit/transport&lt;/code> è¿™ä¸ªåŒ…æä¾›äº†å¾ˆå¤šæœ‰ç”¨çš„åŠ©æ‰‹å‡½æ•°æ¥å¸®åŠ©æ„é€  &lt;code>Endpoint&lt;/code> ï¼Œä»¥åŠé»åˆæœåŠ¡ç«¯çš„ &lt;code>Endpoint&lt;/code> åˆ°ä¼ è¾“å±‚ä»£ç ã€‚ï¼ˆPSï¼šè¯·å›é¡¾å‰æ–‡ä¸­ä½¿ç”¨çš„ &lt;code>httptransport.NewServer&lt;/code>ï¼‰&lt;/p>
&lt;h3 id="æœåŠ¡å‘ç°">æœåŠ¡å‘ç°&lt;/h3>
&lt;p>å‚è€ƒ &lt;a class="link" href="https://github.com/go-kit/examples/blob/master/apigateway/main.go" target="_blank" rel="noopener"
>apigateway&lt;/a> çš„ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// Each method gets constructed with a factory. Factories take an
&lt;/span>&lt;span class="c1">// instance string, and return a specific endpoint. In the factory we
&lt;/span>&lt;span class="c1">// dial the instance string we get from Consul, and then leverage an
&lt;/span>&lt;span class="c1">// addsvc client package to construct a complete service. We can then
&lt;/span>&lt;span class="c1">// leverage the addsvc.Make{Sum,Concat}Endpoint constructors to convert
&lt;/span>&lt;span class="c1">// the complete service to specific endpoint.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">var&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">tags&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">passingOnly&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;span class="nx">endpoints&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">addendpoint&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Set&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">instancer&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">consulsd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewInstancer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">client&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">logger&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;addsvc&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">tags&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">passingOnly&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="nx">factory&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">addsvcFactory&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">addendpoint&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MakeSumEndpoint&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">tracer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">zipkinTracer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">logger&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">endpointer&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">sd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewEndpointer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">instancer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">factory&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">logger&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">balancer&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">lb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewRoundRobin&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">endpointer&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">retry&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">lb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Retry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">retryMax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">retryTimeout&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">balancer&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">endpoints&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SumEndpoint&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">retry&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 161;
flex-basis: 387px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220228171821569.png" data-size="925x573">
&lt;img src="https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220228171821569.png"
width="925"
height="573"
srcset="https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220228171821569_hude2acf9d66679c44454b1c6e5dc1473c_66465_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220228171821569_hude2acf9d66679c44454b1c6e5dc1473c_66465_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="ç¤ºæ„å›¾">
&lt;/a>
&lt;figcaption>ç¤ºæ„å›¾&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æ€»å¾—æ¥è¯´ï¼Œgo kit çš„æœåŠ¡å‘ç°æœºåˆ¶é å®¢æˆ·ç«¯ä»¥ç‰¹å®šçš„æ–¹å¼æ„é€  &lt;code>Endpoint&lt;/code> ï¼Œè¿™å’Œåå‘ä»£ç†æˆ–è€… side-car ä»£ç†å®ç°çš„æœåŠ¡å‘ç°ä¸ä¸€æ ·ã€‚&lt;/p>
&lt;p>æ¯”å¦‚è¯´ kubernetes çš„ ClusterIP åŸºäº kube-proxyï¼Œåç«¯æœ‰å¤šä¸ª POD çš„æ—¶å€™ kube-proxy ä¼šè‡ªåŠ¨è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œä½†ç®—æ³•æ˜¯ kube-proxy å®ç°å†³å®šçš„ï¼Œä¸å¯ä¾èµ–ã€‚&lt;/p>
&lt;p>å†æ¯”å¦‚ nginx ä¹Ÿèƒ½ä¸€å®šç¨‹åº¦å®ç°æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ã€‚&lt;/p>
&lt;p>å†æ¯”å¦‚ï¼Œlinkerd è¿™æ ·çš„ service meshï¼Œéä¾µå…¥ï¼Œæä¾›è´Ÿè½½å‡è¡¡ã€æœåŠ¡å‘ç°ã€é‡è¯•è¿™äº›åŠŸèƒ½ã€‚&lt;/p>
&lt;p>go kit çš„å·¥å…·ç®±é‡Œæä¾›çš„æ˜¯å®¢æˆ·ç«¯çš„è´Ÿè½½å‡è¡¡æœºåˆ¶ã€‚ä¸Šå›¾é‡Œçš„ä»£ç å¯ä»¥ç”¨ä¸‹å›¾è¡¨ç¤ºã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 91;
flex-basis: 220px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220228172730622.png" data-size="574x626">
&lt;img src="https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220228172730622.png"
width="574"
height="626"
srcset="https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220228172730622_hu7c2f12e783b3c572c3387446a921feeb_14775_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220228172730622_hu7c2f12e783b3c572c3387446a921feeb_14775_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="è´Ÿè½½å‡è¡¡">
&lt;/a>
&lt;figcaption>è´Ÿè½½å‡è¡¡&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;h3 id="å¤šä¼ è¾“å±‚å®ç°">å¤šä¼ è¾“å±‚å®ç°&lt;/h3>
&lt;p>è¿™é‡Œå°è¯•å®ç° &lt;code>http&lt;/code> å’Œ &lt;code>grpc&lt;/code> ä¸¤ç§ rpc ä¼ è¾“å±‚åè®®ã€‚é¦–å…ˆä¸ºäº†ä¿è¯æœ€å¤§åŒ–å¤ç”¨ä»£ç ï¼Œåœ¨ &lt;code>http&lt;/code> å®ç°ä¸­å®šä¹‰çš„ç»“æ„å’Œ endpoint è‚¯å®šæ˜¯è¦å¤ç”¨èµ·æ¥çš„ï¼Œä¸ç„¶æ¯ä¸ªä¼ è¾“å±‚éƒ½æ¥ä¸€æ¬¡çš„è¯æ²¡codegenéå¾—æ‰‹æŒ‡æ•²æ–­ä¸å¯ã€‚&lt;/p>
&lt;p>å…ˆæå– &lt;code>makeXXXEndpoint&lt;/code> ä»£ç å’Œ &lt;code>XXXRequest&lt;/code> è¿™æ ·çš„ç»“æ„åˆ°å•ç‹¬çš„æ–‡ä»¶é‡Œã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 184;
flex-basis: 443px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220301115635464.png" data-size="1920x1040">
&lt;img src="https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220301115635464.png"
width="1920"
height="1040"
srcset="https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220301115635464_hu2db5290091178b734e80b60459e1fef9_216608_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220301115635464_hu2db5290091178b734e80b60459e1fef9_216608_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="æå–å®šä¹‰">
&lt;/a>
&lt;figcaption>æå–å®šä¹‰&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æ€è·¯ä¸Šéƒ¨åˆ†å‚è€ƒçš„ gokit æ¡ˆä¾‹ä¸­ &lt;code>addsvc&lt;/code>ï¼Œ&lt;a class="link" href="https://github.com/go-kit/examples/blob/master/addsvc/README.md" target="_blank" rel="noopener"
>é“¾æ¥&lt;/a>ã€‚&lt;/p>
&lt;p>proto æ–‡ä»¶å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-protobuf" data-lang="protobuf">&lt;span class="c1">// play/stringsvc/transport/pb/stringsvc.proto
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">syntax&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;proto3&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">option&lt;/span> &lt;span class="n">go_package&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;play/stringsvc/transport/pb&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="kd">message&lt;/span> &lt;span class="nc">UppercaseRequest&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="n">s&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="kd">message&lt;/span> &lt;span class="nc">UppercaseResponse&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="n">v&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="kd">message&lt;/span> &lt;span class="nc">CountRequest&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="n">s&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="kd">message&lt;/span> &lt;span class="nc">CountResponse&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="kt">int32&lt;/span> &lt;span class="n">n&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="kd">service&lt;/span> &lt;span class="n">StringService&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="k">rpc&lt;/span> &lt;span class="n">Uppercase&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">UppercaseRequest&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">UppercaseResponse&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="k">rpc&lt;/span> &lt;span class="n">Count&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">CountRequest&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">CountResponse&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶åä½¿ç”¨ protoc ç”Ÿæˆ go æºç ï¼Œå…·ä½“å‚è€ƒ &lt;a class="link" href="https://www.grpc.io/docs/languages/go/quickstart/" target="_blank" rel="noopener"
>gRPC çš„å®˜æ–¹æ–‡æ¡£&lt;/a>ã€‚ç»§ç»­ä¸‹ä¸€æ­¥ä¹‹å‰è¦å…ˆäº†è§£ go è¯­è¨€çš„ gRPC æœåŠ¡æ¡†æ¶åœ¨ä¸€èˆ¬æƒ…å†µä¸‹æ€ä¹ˆå®ç°ã€‚åŒæ ·å»ºè®®ç›´æ¥çœ‹æ–‡æ¡£ã€‚ç®€å•è¯´å°±æ˜¯å†™ä¸€ä¸ªç»“æ„ï¼Œå®ç° protoc æ ¹æ®ä½ çš„ proto æ–‡ä»¶ç”Ÿæˆçš„æ¥å£ï¼Œæœ€åè°ƒç”¨æ³¨å†Œæ–¹æ³•æŠŠä½ çš„å®ç°æ³¨å†Œåˆ° gRPC æœåŠ¡å™¨ä¸Šå°±å¯ä»¥äº†ã€‚&lt;/p>
&lt;p>å†è€ƒè™‘è¯·æ±‚è¿›å…¥æˆ‘ä»¬çš„æœåŠ¡ä»£ç è¦ç»è¿‡çš„æµç¨‹ï¼ŒgRPC æ¥å£çš„å®ç°è¦åšäº‹æƒ…å…¶å®å°±æ˜¯æŠŠ proto å®šä¹‰çš„ç»“æ„è½¬æ¢æˆæˆ‘ä»¬ä¹‹å‰å®šä¹‰çš„ç»“æ„ï¼Œå†è°ƒç”¨ä¹‹å‰å®šä¹‰çš„ &lt;code>Endpoint&lt;/code> ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 89;
flex-basis: 214px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220301134821969.png" data-size="437x488">
&lt;img src="https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220301134821969.png"
width="437"
height="488"
srcset="https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220301134821969_huf9fd1139fbbfdafdb0f01166b9d50a9e_18354_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220301134821969_huf9fd1139fbbfdafdb0f01166b9d50a9e_18354_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="gRPCä½œä¸ºä¼ è¾“å±‚åè®®çš„äº¤äº’æµç¨‹">
&lt;/a>
&lt;figcaption>gRPCä½œä¸ºä¼ è¾“å±‚åè®®çš„äº¤äº’æµç¨‹&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å…¶ä¸­å¯¹è¯·æ±‚ç¼–è§£ç æ˜¯ä¸ªå¾ˆæ— èŠçš„è¿‡ç¨‹ï¼Œå­—æ®µä¸€ä¸€èµ‹å€¼å³å¯ã€‚endpoint ç»§ç»­å¤ç”¨å…ˆå‰ http çš„ç‰ˆæœ¬ã€‚gRPC å®ç°æ¯”è¾ƒå–å·§ï¼Œæˆ‘ä»¬æŠŠæ‰€æœ‰ &lt;code>Endpoint&lt;/code> æ”¾åˆ°ä¸€ä¸ªç»“æ„é‡Œä¿å­˜ï¼Œç„¶åå®ç° gRPC çš„æ¥å£ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;context&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;play/stringsvc&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;play/stringsvc/transport/pb&amp;#34;&lt;/span>
&lt;span class="nx">grpctransport&lt;/span> &lt;span class="s">&amp;#34;github.com/go-kit/kit/transport/grpc&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">set&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">*&lt;/span>&lt;span class="nx">pb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">UnimplementedStringServiceServer&lt;/span>
&lt;span class="nx">uppercase&lt;/span> &lt;span class="nx">grpctransport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Handler&lt;/span>
&lt;span class="nx">count&lt;/span> &lt;span class="nx">grpctransport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Handler&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewGRPCServer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">svc&lt;/span> &lt;span class="nx">stringsvc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">StringService&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">set&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">set&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">uppercase&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">grpctransport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewServer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nf">MakeUppercaseEndpoint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">svc&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">decodeUppercaseRequestGRPC&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">encodeUppercaseResponseGRPC&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">count&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">grpctransport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewServer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nf">MakeCountEndpoint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">svc&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">decodeCountRequestGRPC&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">encodeCountResponseGRPC&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">set&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Uppercase&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">pb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">UppercaseRequest&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">pb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">UppercaseResponse&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">resp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">uppercase&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ServeGRPC&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">resp&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">pb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">UppercaseResponse&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">set&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Count&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">pb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CountRequest&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">pb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CountResponse&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">resp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">count&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ServeGRPC&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">resp&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">pb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CountResponse&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œåˆ©ç”¨äº†ä¸€ä¸ª &lt;code>github.com/go-kit/kit/transport/grpc&lt;/code> çš„å¸®åŠ©ç»“æ„ï¼Œ&lt;code>grpctransport.NewServer&lt;/code> åˆ›å»ºçš„ &lt;code>grpctransport.Server&lt;/code>ã€‚è¿™ä¸ªç»“æ„çš„ç”¨é€”å’Œ &lt;code>httptransport.NewServer&lt;/code>ä¸€æ ·ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªé€‚é…å™¨ï¼ŒæŠŠ gRPC çš„è¾“å…¥é€‚é…åˆ°æˆ‘ä»¬å®šä¹‰çš„æœåŠ¡æ¥å£ã€‚ç†è®ºä¸Šæ¥è¯´ä¸ç”¨è¿™ç©æ„å„¿ä¹Ÿæ²¡äº‹ï¼Œä½†å®ç°ä»£ç é‡Œå°±è¦æ˜¾å¼è°ƒç”¨ &lt;code>Decode&lt;/code>å’Œ&lt;code>Encode&lt;/code>ã€‚ä»è§£è€¦çš„è§’åº¦æ¥è¯´è¿™ç§è®¾è®¡ä¼šæ›´å¥½ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>ä¹‹æ‰€ä»¥è¯´ gokit å¤§æ¦‚ç®—æ˜¯æ¡†æ¶ï¼Œæ˜¯å› ä¸º gokit æä¾›çš„è¿™äº›å·¥å…·å…¶å®æœ‰ä¸€å¥—è‡ªå·±çš„æœ€ä½³å®è·µï¼Œä½†å¹¶ä¸å¼ºè¿«éµå¾ªã€‚æ¯”å¦‚ transport å¹¶ä¸æ˜¯ä¸€å®šè¦ç”¨ gokit çš„ transport ï¼Œå®Œå…¨å¯ä»¥è‡ªå·±å†™ &lt;code>http.Handler&lt;/code> ï¼ŒæŠŠ encode/decode å†™åˆ°ä¸€èµ·ã€‚ä¹Ÿå¯ä»¥æŠŠå…¶ä»–æ–¹å¼ç¼–å†™çš„ RPC å°è£…æˆ &lt;code>Endpoint&lt;/code>ï¼Œè·å¾— gokit æä¾›çš„ä¸€ç³»åˆ—æ”¯æŒã€‚&lt;/p>
&lt;p>gokit æä¾›äº†å¾ˆå¤šæœ‰ç”¨çš„å·¥å…·ï¼Œè§£å†³ä¸€äº›è¯¸å¦‚æœåŠ¡å‘ç°ã€ç†”æ–­å™¨ã€åˆ†å¸ƒå¼è·Ÿè¸ªå’Œå¯è§‚æµ‹æ€§è¿™æ ·çš„é—®é¢˜ã€‚gokit çš„æ¡ˆä¾‹ä»£ç ç¤ºèŒƒçš„å®è·µæ–¹å¼ä¹Ÿå¾ˆæœ‰å¯å‘æ€§ã€‚&lt;/p></description></item><item><title>gRPC-Gateway ç”¨ä½œå¤šä¸ª gRPC æœåŠ¡çš„ç½‘å…³</title><link>https://nnnewb.github.io/blog/p/grpc-gateway-used-as-multiple-grpc-server-gateway/</link><pubDate>Wed, 23 Feb 2022 17:30:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/grpc-gateway-used-as-multiple-grpc-server-gateway/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒAPIç½‘å…³æ˜¯å¾®æœåŠ¡æ¶æ„çš„é‡è¦ç»„ä»¶ï¼Œèµ·åˆ°ä¸€ä¸ªæ•´æµè¿‡æ»¤çš„ä½œç”¨ã€‚è™½ç„¶ gRPC-Gateway è¦å•¥æ²¡å•¥ï¼Œå’Œ API ç½‘å…³çš„æ¨¡å¼ä¹Ÿæ‰¯ä¸ä¸Šå¤ªå¤šå…³ç³»ï¼Œä½†æ€»ä¹‹å…ˆèµ·ä¸ªé«˜è°ƒã€‚&lt;/p>
&lt;p>ç„¶åå°±æ˜¯çœŸæ­£é‡åˆ°çš„é—®é¢˜äº†ã€‚åœ¨æ—§çš„æ¶æ„é‡Œï¼ŒgRPC-Gateway çš„ç”¨æ³•ï¼Œæ˜¯å¯¹æ¯ä¸ªéœ€è¦æš´éœ² HTTP æœåŠ¡çš„ gRPC æœåŠ¡éƒ½èµ·ä¸€ä¸ªå¯¹åº”çš„ gRPC-Gateway ã€‚æœ€æ—©çš„åšæ³•æ˜¯ gRPC-Gateway æœåŠ¡å•ç‹¬ä½œä¸ºä¸€ä¸ª POD ï¼ŒgRPC æœåŠ¡å®ç°ä¹Ÿå•ç‹¬ä¸€ä¸ª POD ã€‚åæ¥æˆ‘æ”¹æˆäº† Gateway å’Œ æœåŠ¡åœ¨åŒä¸€ä¸ª POD å†…ï¼Œèµ·ä¸¤ä¸ª container ã€‚&lt;/p>
&lt;p>ä¹‹å‰çš„åšæ³•éƒ½å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ gRPC-Gateway è¦åˆ†é…å°‘é‡çš„ CPU å’Œå†…å­˜é…é¢ï¼Œè™½ç„¶æ¯ä¸ª gRPC-Gateway æœåŠ¡åˆ†åˆ°çš„å†…å­˜å’ŒCPUéƒ½å¾ˆå°‘ï¼Œä½†æ¶ä¸ä½æœåŠ¡å¤šï¼Œå†…å­˜å’Œ CPU çš„é…é¢éƒ½å ç”¨äº†ä¸å°‘ï¼Œå®é™…ç”¨åˆ°çš„å°‘å¾—å¯æ€œï¼Œå¤§éƒ¨åˆ†é…é¢éƒ½æ˜¯æµªè´¹ã€‚&lt;/p>
&lt;p>ä¸‹é¢å…·ä½“åˆ†æä¸‹æ€ä¹ˆæŠŠ gateway å•ç‹¬æå–æˆä¸€ä¸ª PODï¼Œç»™æ‰€æœ‰ gRPC æœåŠ¡å½“ç½‘å…³ï¼ŒåŒæ—¶ä¿æŒè´Ÿè½½å‡è¡¡å‘æŒ¥ä½œç”¨ï¼Œæä¾›æ— ç¼æ‰©å®¹ã€‚&lt;/p>
&lt;h2 id="å®ç°ç½‘å…³">å®ç°ç½‘å…³&lt;/h2>
&lt;h3 id="å®˜æ–¹demo">å®˜æ–¹demo&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// Create a client connection to the gRPC server we just started
&lt;/span>&lt;span class="c1">// This is where the gRPC-Gateway proxies the requests
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">conn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">grpc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">DialContext&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Background&lt;/span>&lt;span class="p">(),&lt;/span>
&lt;span class="s">&amp;#34;0.0.0.0:8080&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">grpc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithBlock&lt;/span>&lt;span class="p">(),&lt;/span>
&lt;span class="nx">grpc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithTransportCredentials&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">insecure&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewCredentials&lt;/span>&lt;span class="p">()),&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatalln&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Failed to dial server:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">gwmux&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">runtime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewServeMux&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="c1">// Register Greeter
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">helloworldpb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RegisterGreeterHandler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Background&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">gwmux&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatalln&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Failed to register gateway:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">gwServer&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Server&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Addr&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;:8090&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Handler&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">gwmux&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Serving gRPC-Gateway on http://0.0.0.0:8090&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatalln&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">gwServer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ListenAndServe&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ ¸å¿ƒé€»è¾‘åœ¨è¿™ä¸¤è¡Œï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">gwmux&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">runtime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewServeMux&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="c1">// Register Greeter
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">helloworldpb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RegisterGreeterHandler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Background&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">gwmux&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatalln&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Failed to register gateway:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>gwmux&lt;/code>æ˜¯ gRPC-Gateway çš„è¿è¡Œæ—¶ &lt;code>mux&lt;/code> å®ä¾‹ï¼Œå¯ä»¥ç†è§£æˆè·¯ç”±ã€‚ æ ‡å‡†åº“çš„ &lt;code>http&lt;/code> åŒ…ä¹Ÿæœ‰è‡ªå·±çš„ &lt;code>mux&lt;/code> ï¼Œä½† gRPC-Gateway é¡¹ç›®è‡ªå·±å®ç°äº†ä¸€ä¸ªã€‚çœ‹åˆ° &lt;code>gwmux&lt;/code>åº”è¯¥å°±èƒ½æƒ³åˆ°è¿™è‚¯å®šæ˜¯æ³¨å†Œè·¯ç”±ï¼Œç†è®ºä¸Šæ¥è¯´â€”â€”å¦‚æœä½ æœ‰å¤šä¸ª gRPC æœåŠ¡ï¼Œè€Œä¸” url æ²¡æœ‰å†²çªçš„è¯ï¼Œæ³¨å†Œå¤šä¸ªæœåŠ¡åˆ°è·¯ç”±ä¸Šåº”è¯¥æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚&lt;/p>
&lt;p>æ‰€ä»¥å‰©ä¸‹çš„é—®é¢˜å°±æ˜¯è¿™ä¸ª &lt;code>RegisterGreeterHandler&lt;/code> å†…æ˜¯ä¸æ˜¯æˆ‘ä»¬é¢„æœŸçš„é‚£æ ·ï¼Œç±»ä¼¼ &lt;code>mux&lt;/code> æ³¨å†Œè·¯ç”±çš„ç”¨æ³•ï¼Ÿ&lt;/p>
&lt;h3 id="registerxxxhandlerclient-å®ç°">RegisterXXXHandlerClient å®ç°&lt;/h3>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 914;
flex-basis: 2194px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/grpc-gateway-used-as-multiple-grpc-server-gateway/image-20220222154718918.png" data-size="1207x132">
&lt;img src="https://nnnewb.github.io/blog/blog/p/grpc-gateway-used-as-multiple-grpc-server-gateway/image-20220222154718918.png"
width="1207"
height="132"
srcset="https://nnnewb.github.io/blog/blog/p/grpc-gateway-used-as-multiple-grpc-server-gateway/image-20220222154718918_huae7e9726eb83dcb6808b9604bde89ea7_31321_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/grpc-gateway-used-as-multiple-grpc-server-gateway/image-20220222154718918_huae7e9726eb83dcb6808b9604bde89ea7_31321_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="RegisterXXXHandlerClientå®ç°">
&lt;/a>
&lt;figcaption>RegisterXXXHandlerClientå®ç°&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>é¡ºç€ &lt;code>RegisterXXXHandler&lt;/code>å¾ˆå¿«å°±èƒ½æ‰¾åˆ°å®ç°ï¼Œ&lt;code>RegisterXXXHandlerClient&lt;/code>ã€‚&lt;code>Handle&lt;/code>çš„ç”¨æ³•æ­£å¦‚é¢„æœŸçš„é‚£æ ·ï¼Œæ˜¯ä¸€ä¸ªç±»ä¼¼ &lt;code>http.ServeMux&lt;/code> çš„å¯¹è±¡ã€‚å¤„ç†å‡½æ•°é‡Œçš„é€»è¾‘å¾ˆæ¸…æ™°ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 277;
flex-basis: 666px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/grpc-gateway-used-as-multiple-grpc-server-gateway/image-20220222155630463.png" data-size="1167x420">
&lt;img src="https://nnnewb.github.io/blog/blog/p/grpc-gateway-used-as-multiple-grpc-server-gateway/image-20220222155630463.png"
width="1167"
height="420"
srcset="https://nnnewb.github.io/blog/blog/p/grpc-gateway-used-as-multiple-grpc-server-gateway/image-20220222155630463_hu5863f8bc3c05d0c34f00482d4fdc41e8_65629_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/grpc-gateway-used-as-multiple-grpc-server-gateway/image-20220222155630463_hu5863f8bc3c05d0c34f00482d4fdc41e8_65629_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="HandleFunc">
&lt;/a>
&lt;figcaption>HandleFunc&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å‡½æ•°ä½“å¯ä»¥ç®€å•åˆ’åˆ†æˆä¸¤éƒ¨åˆ†ï¼š&lt;/p>
&lt;ul>
&lt;li>æ„é€ å’Œå‘é€è¯·æ±‚
&lt;ul>
&lt;li>æ ¹æ®è¯·æ±‚çš„ &lt;code>Content-Type&lt;/code> é€‰æ‹© &lt;code>Marshaler&lt;/code> ã€‚&lt;/li>
&lt;li>æ„é€ è¯·æ±‚ä¸Šä¸‹æ–‡ï¼Œä»HTTPè¯·æ±‚é‡Œæå–&lt;code>grpc-metadata&lt;/code>å¼€å¤´çš„å…ƒæ•°æ®åˆ° &lt;code>context&lt;/code> é‡Œã€‚&lt;/li>
&lt;li>&lt;code>request_XXX_0&lt;/code> ååºåˆ—åŒ– HTTP è¯·æ±‚ä½“åˆ° protobuf ç”Ÿæˆçš„ç»“æ„ï¼Œå¹¶å‘é€è¯·æ±‚ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>æ„é€ å’Œè¿”å›å“åº”
&lt;ul>
&lt;li>ä»å“åº”å…ƒæ•°æ®é‡Œæ„é€ ä¸Šä¸‹æ–‡&lt;/li>
&lt;li>æ„é€ å’Œè¿”å› HTTP å“åº”&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>æ•´ä¸ªæµç¨‹æ˜¯æ— çŠ¶æ€ä¹Ÿå’Œ &lt;code>gwmux&lt;/code> æœ¬èº«æ— ç»‘å®šçš„ã€‚æ¢è¨€ä¹‹ï¼Œç†è®ºä¸Šæ¥è¯´å®Œå…¨å¯ä»¥æŠŠæ‰€æœ‰ gRPC-Gateway ç”Ÿæˆçš„ &lt;code>Register&lt;/code> å‡½æ•°æ³¨å†Œåˆ°åŒä¸€ä¸ª &lt;code>gwmux&lt;/code> ä¸Šã€‚&lt;/p>
&lt;h3 id="backendå’Œæ³¨å†Œ">Backendå’Œæ³¨å†Œ&lt;/h3>
&lt;p>å‡ºäºæ¸…æ™°åŒ–çš„è€ƒè™‘ï¼ŒGateway æœåŠ¡çš„æ„é€ è¿‡ç¨‹æˆ‘å†™æˆäº† Builder æ¨¡å¼ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">registerHandlerFn&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">mux&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">runtime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ServeMux&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">conn&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">grpc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ClientConn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">GRPCBackend&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">RegisterHandlerFunc&lt;/span> &lt;span class="nx">registerHandlerFn&lt;/span>
&lt;span class="nx">BackendAddr&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">DonviewGRPCGatewayServer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Serve&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">mux&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">runtime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewServeMux&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">muxOptions&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">backend&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">backends&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">conn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">grpc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">DialContext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">TODO&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">backend&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">BackendAddr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">dialOptions&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">backend&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RegisterHandlerFunc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">TODO&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">mux&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">handler&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Handler&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">mux&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">wrapperFn&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">httpHandlerWrappers&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">handler&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">wrapperFn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">handler&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ListenAndServe&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;0.0.0.0:%d&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">port&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">handler&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰€æœ‰ gRPC åç«¯è¢«æ³¨å†Œåˆ° &lt;code>s.backends&lt;/code> ï¼Œåœ¨å¼€å§‹æœåŠ¡çš„æ—¶å€™è°ƒç”¨ &lt;code>Serve&lt;/code> å‡½æ•°ï¼ŒæŠŠ gRPC æœåŠ¡æ³¨å†Œåˆ° &lt;code>mux&lt;/code> é‡Œã€‚å› ä¸ºäº‹å‰ç¡®ä¿äº†æœåŠ¡è·¯ç”±ä¸ä¼šé‡å ï¼Œç†è®ºä¸Šæ¥è¯´æ³¨å†Œå®Œå°±èƒ½ç”¨ã€‚&lt;/p>
&lt;h2 id="è´Ÿè½½å‡è¡¡">è´Ÿè½½å‡è¡¡&lt;/h2>
&lt;p>æœ€åˆçš„æ¶æ„é‡Œï¼Œä¸€ä¸ª gRPC-Gateway æœåŠ¡å¯¹åº”ä¸€ä¸ª gRPC æœåŠ¡ï¼Œè¯·æ±‚è¿›å…¥æœåŠ¡çš„è¿‡ç¨‹æ˜¯ä»äº‘æœåŠ¡æä¾›å•†çš„ LB =&amp;gt; kubernetes service (load balancer) =&amp;gt; gateway =&amp;gt; ClusterIP =&amp;gt; gRPC Server ã€‚&lt;/p>
&lt;p>åæ¥æ”¹æˆä¸€ä¸ª POD åŒ…å« gateway å’Œ gRPC ä¸¤ä¸ª container åï¼Œgateway è®¿é—® gRPC æœåŠ¡å°±ä¸åœ¨ç»è¿‡ ClusterIP è¿™ä¸€å±‚ä»£ç†äº†ï¼Œè·¯å¾„å˜æˆäº‘æœåŠ¡å•†çš„ LB =&amp;gt; kubernetes service (load balancer) =&amp;gt; gateway =&amp;gt; gRPC Server ã€‚&lt;/p>
&lt;p>æœ€åæ˜¯ç°åœ¨çš„ç‰ˆæœ¬ï¼Œç½‘å…³ç»Ÿä¸€æˆä¸€ä¸ªå®¹å™¨ï¼Œè·¯å¾„å’Œä¸Šè¿°ä¸€æ ·ã€‚&lt;/p>
&lt;p>ä¸‰è€…çš„åŒºåˆ«åœ¨äºè´Ÿè½½å‡è¡¡çš„æ—¶æœºã€‚Kubernetes çš„ ClusterIP æ˜¯åŒæ ·å…·å¤‡è´Ÿè½½å‡è¡¡èƒ½åŠ›çš„ï¼Œæœ€åˆæ¶æ„ä¸­è´Ÿè½½å‡è¡¡ä¸€å…±è¿›è¡Œäº†ä¸‰æ¬¡ï¼Œä»äº‘æœåŠ¡å•†çš„LBåˆ°ä¸»æœºç«¯å£ï¼ˆkubernetesï¼‰ï¼Œkuberneteså†æ¬¡è´Ÿè½½å‡è¡¡ï¼Œè½¬å‘åˆ° gatewayã€‚gatewayå†ç»ç”± ClusterIP è½¬å‘è‡³ gRPC æœåŠ¡ï¼Œæ¯ä¸€æ¬¡è½¬å‘éƒ½ç»å†ä¸€æ¬¡è´Ÿè½½å‡è¡¡ï¼Œåˆ†åˆ«æä¾›äº†è™šæ‹Ÿä¸»æœºçš„æ‰©å®¹èƒ½åŠ›ã€gatewayæœåŠ¡çš„æ‰©å®¹èƒ½åŠ›ã€gRPCæœåŠ¡çš„æ‰©å®¹èƒ½åŠ›ã€‚&lt;/p>
&lt;p>ç¬¬äºŒç‰ˆä¿®æ”¹å»æ‰äº† gateway åˆ° gRPC æœåŠ¡çš„è´Ÿè½½å‡è¡¡ï¼Œå˜æˆäº†ç›´è¿ï¼Œå»¶è¿Ÿè¡¨ç°ä¸Šç†è®ºä¸Šæ¥è¯´ä¼šæœ‰æ”¹å–„ï¼Œä½†æˆ‘æ²¡åšè¿‡åŸºå‡†æµ‹è¯•ï¼Œæ‰€ä»¥è¿™ä¸ªâ€œç†è®ºä¸Šâ€ä¹Ÿåªæ˜¯å‡­æ„Ÿè§‰è¯´ã€‚ä½†å¯ä»¥æ˜ç¡®çš„æ˜¯ gateway ä¼šé¢å¤–å æ®èµ„æºé…é¢ï¼Œé€ æˆæµªè´¹ï¼Œä¸å¥½è¯´å€¼ä¸å€¼ï¼Œä¸ªäººæ„Ÿè§‰æ²¡å¤ªå¤§æ„ä¹‰ã€‚&lt;/p>
&lt;p>ç¬¬ä¸‰ç‰ˆï¼Œç»Ÿä¸€äº† gatewayï¼Œè¿˜æ˜¯ä¸‰æ¬¡è´Ÿè½½å‡è¡¡ã€‚ä¸è¿‡Gatewayå¯¹èµ„æºé…é¢çš„ä½¿ç”¨æ•ˆç‡ä¼šæ›´å¥½ä¸€ç‚¹ï¼Œä¾ç„¶ä¿æŒäº†ä¸»æœºã€gatewayã€gRPC æœåŠ¡çš„å¯ä¼¸ç¼©æ€§ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 24;
flex-basis: 59px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/grpc-gateway-used-as-multiple-grpc-server-gateway/image-20220222165344894.png" data-size="176x714">
&lt;img src="https://nnnewb.github.io/blog/blog/p/grpc-gateway-used-as-multiple-grpc-server-gateway/image-20220222165344894.png"
width="176"
height="714"
srcset="https://nnnewb.github.io/blog/blog/p/grpc-gateway-used-as-multiple-grpc-server-gateway/image-20220222165344894_huca7a171cf394f94ea2cc15092e42ada3_10452_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/grpc-gateway-used-as-multiple-grpc-server-gateway/image-20220222165344894_huca7a171cf394f94ea2cc15092e42ada3_10452_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="ä¸‰æ¬¡LB">
&lt;/a>
&lt;figcaption>ä¸‰æ¬¡LB&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>å•ä»ç†è®ºä¸Šæ¥è¯´è¿™æ ·è®¾è®¡åº”è¯¥æ˜¯ OK çš„ï¼Œä½†æ˜¯ gRPC-Gateway å®˜æ–¹å¯¹è´Ÿè½½å‡è¡¡æ²¡æœ‰è¯´æ³•ï¼Œå¯¹èƒ½ä¸èƒ½æ³¨å†Œå¤šä¸ª gRPC æœåŠ¡åˆ°ä¸€ä¸ª &lt;code>mux&lt;/code> ä¸Šä¹Ÿæ²¡æœ‰å®˜æ–¹çš„æ–‡æ¡£è¯´æ˜ï¼Œå¾ˆéš¾è¯´è¿™å¸®äººèƒ½ä¸èƒ½ä¿è¯å‘åå…¼å®¹ï¼Œä¸‡ä¸€ä¹‹åçš„ç‰ˆæœ¬ä¸æ”¯æŒæ³¨å†Œåˆ°ä¸€ä¸ª &lt;code>mux&lt;/code> ä¸Šäº†ï¼Œåˆ°æ—¶å€™æ”¹èµ·æ¥å°±éº»çƒ¦äº†ï¼Œæ¯”è¾ƒåçš„æƒ…å†µå°±æ˜¯ä½ å¾—è‡ªå·±å†™ä¸€ä¸ª &lt;code>protoc-gen-gateway&lt;/code> è¿™æ ·çš„ç©æ„å„¿æ¥ç”Ÿæˆä¸€ä¸ªè‡ªå·±çš„ç½‘å…³ã€‚&lt;/p>
&lt;p>æ­¤å¤–è¿˜æœ‰ä¸€ä¸ªç¼ºé™·ï¼ŒgRPC-Gateway åˆ° gRPC Server çš„è´Ÿè½½å‡è¡¡ç”± Kubernetes ClusterIP æä¾›ï¼Œä½†æ˜¯ &lt;a class="link" href="https://stackoverflow.com/questions/49888133/kubernetes-service-cluster-ip-how-is-this-internally-load-balanced-across-diffe" target="_blank" rel="noopener"
>ClusterIP çš„è´Ÿè½½å‡è¡¡ç®—æ³•æ˜¯ Round Robin/Random&lt;/a> ï¼Œå¹¶ä¸æ”¯æŒæ ¹æ®è´Ÿè½½æˆ–å…¶ä»–ç»´åº¦çš„æµ‹é‡æ•°æ®æ¥å†³å®šå¦‚ä½•å‡è¡¡è´Ÿè½½ï¼Œæœªæ¥å¦‚æœéœ€è¦æ ¹æ®è´Ÿè½½æƒ…å†µåˆ†å‘è¯·æ±‚ï¼Œå¯èƒ½è¿˜å¾—åœ¨ç½‘å…³åˆ° gRPC æœåŠ¡ä¹‹é—´åŠ ä¸ªè´Ÿè½½å‡è¡¡ç»„ä»¶ï¼Œå†æä¾›ä¸€ä¸ªæœåŠ¡å‘ç°/æ³¨å†Œä¸­å¿ƒæ¥å¸®åŠ©è°ƒåº¦ã€‚&lt;/p></description></item><item><title>protogenä»£ç ç”Ÿæˆ</title><link>https://nnnewb.github.io/blog/p/protogen-code-generation/</link><pubDate>Mon, 21 Feb 2022 16:32:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/protogen-code-generation/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>æœ€å¤§çš„é—®é¢˜å…¶å®æ˜¯ proto ç›´æ¥ç”Ÿæˆçš„ swagger ä¸å¥½ç”¨ï¼Œè¿‡å»çš„ gRPC å†™æ³•åªåœ¨æœåŠ¡ç«¯ï¼Œå®¢æˆ·ç«¯æ²¡äº«å—åˆ°é™æ€ç±»å‹å®šä¹‰çš„æ¥å£çš„å¿«ä¹ï¼Œè€Œä¸”æ‰‹å·¥å†™çš„æ–‡æ¡£è¿˜æœ‰ä¸€å †å¾ˆæ— è¯­çš„é—®é¢˜ï¼Œæ•´ä¸ªç³»ç»Ÿç»´æŠ¤èµ·æ¥è›‹ç–¼æ— æ¯”ã€‚&lt;/p>
&lt;p>åæ¥è§£å†³åŠæ³•ä¹Ÿç®€å•ï¼Œä»£ç ç”Ÿæˆï¼Œç¼ºä»€ä¹ˆç”Ÿæˆä»€ä¹ˆï¼Œå…ˆåç»å†äº†ç”¨ &lt;code>go&lt;/code> + protoè§£æå†™æ”¹æˆç”¨ &lt;code>typescript&lt;/code> å†™ï¼Œå†æ”¹å› &lt;code>go&lt;/code> + &lt;code>protogen&lt;/code>ï¼Œä¸€ç•ªæŠ˜è…¾ä¸‹æ¥æœ€åè¿˜æ˜¯ç”¨ &lt;code>protogen&lt;/code> æœ€ç®€å•èˆ’æœã€‚&lt;/p>
&lt;p>è¿™ç¯‡åšå®¢ä¸»è¦å°±æ˜¯ä»‹ç»ä¸‹ &lt;code>protogen&lt;/code> é…ä¸Š go æ¨¡æ¿èƒ½åšåˆ°çš„äº‹æƒ…ã€‚&lt;/p>
&lt;h2 id="protogenä»‹ç»">&lt;code>protogen&lt;/code>ä»‹ç»&lt;/h2>
&lt;p>&lt;code>protogen&lt;/code>çš„å®˜æ–¹æ–‡æ¡£åœ¨&lt;a class="link" href="https://pkg.go.dev/google.golang.org/protobuf/compiler/protogen" target="_blank" rel="noopener"
>è¿™é‡Œ&lt;/a>ï¼Œ&lt;code>protogen&lt;/code>æ˜¯googleå®˜æ–¹&lt;code>protoc-gen-go&lt;/code>æ’ä»¶ä½¿ç”¨çš„æ”¯æŒåº“ï¼Œä»£ç æ‰˜ç®¡åœ¨&lt;a class="link" href="https://github.com/protocolbuffers/protobuf-go" target="_blank" rel="noopener"
>github.com/protocolbuffers/protobuf-go&lt;/a> ã€‚å¯ä»¥é€šè¿‡ &lt;a class="link" href="https://github.com/protocolbuffers/protobuf-go/blob/master/cmd/protoc-gen-go/main.go" target="_blank" rel="noopener"
>&lt;code>protoc-gen-go&lt;/code> çš„ &lt;code>main&lt;/code> åŒ…ä»£ç &lt;/a> åˆçª¥é—¨å¾„ã€‚&lt;/p>
&lt;p>ä¸è¿‡åœ¨å¼€å§‹å‰ï¼Œè¿˜å¾—å…ˆäº†è§£ä¸‹ &lt;code>protoc&lt;/code> æ’ä»¶æ˜¯æ€ä¹ˆå·¥ä½œçš„ã€‚ä»å®˜æ–¹æ–‡æ¡£&lt;a class="link" href="https://developers.google.com/protocol-buffers/docs/reference/other" target="_blank" rel="noopener"
>other languages and plugins&lt;/a>æ‘˜å½•å¦‚ä¸‹ã€‚&lt;/p>
&lt;blockquote>
&lt;p>&lt;code>protoc&lt;/code>, the Protocol Buffers Compiler, can be extended to support new languages via plugins. &lt;strong>A plugin is just a program which reads a&lt;/strong> &lt;code>CodeGeneratorRequest&lt;/code> &lt;strong>protocol buffer from standard input and then writes a&lt;/strong> &lt;code>CodeGeneratorResponse&lt;/code> &lt;strong>protocol buffer to standard output.&lt;/strong> These message types are defined in &lt;code>plugin.proto&lt;/code>. We recommend that all third-party code generators be written as plugins, as this allows all generators to provide a consistent interface and share a single parser implementation.&lt;/p>
&lt;/blockquote>
&lt;p>ç®€å•åœ°è¯´ï¼Œ&lt;code>protoc&lt;/code>æ’ä»¶ä»&lt;code>stdin&lt;/code>è¯»å–ä¸€ä¸ª&lt;code>protobuf&lt;/code>æ¶ˆæ¯ï¼Œå¾€&lt;code>stdout&lt;/code>å†™ä¸€ä¸ª&lt;code>protobuf&lt;/code>æ¶ˆæ¯ã€‚æŠŠ&lt;code>protoc&lt;/code>æ’ä»¶ç†è§£æˆæœåŠ¡å™¨ï¼Œ&lt;code>protoc&lt;/code>å‘é€è¯·æ±‚ï¼Œæ’ä»¶è¿”å›å“åº”ï¼Œäº¤äº’è¿‡ç¨‹ä¸ç»è¿‡ç½‘ç»œï¼Œè€Œæ˜¯æ ‡å‡†è¾“å…¥/è¾“å‡ºï¼Œå°±è¿™æ ·ã€‚&lt;/p>
&lt;p>æˆ‘ä¹Ÿä¸æƒ³è§£é‡Šä¸ºä»€ä¹ˆä¸ä»é›¶å¼€å§‹å†™äº†ã€‚&lt;code>protogen&lt;/code>æä¾›äº†ç›¸å½“å®Œå–„çš„å°è£…ï¼Œå¾ˆè½»æ¾å°±å¯ä»¥å†™å‡ºä¸€ä¸ªå®Œæ•´çš„ &lt;code>protoc&lt;/code> æ’ä»¶ã€‚&lt;/p>
&lt;h3 id="helloworld">HelloWorld&lt;/h3>
&lt;p>å…ˆæ¥ä¸ªæƒ¯ä¾‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;log&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;flags&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;google.golang.org/protobuf/compiler/protogen&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetFlags&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetPrefix&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;protoc-gen-hello: &amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">flags&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FlagSet&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Options&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">ParamFunc&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">flags&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Set&lt;/span>&lt;span class="p">}.&lt;/span>&lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Gen&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">Gen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">plugin&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Plugin&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Hello world&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»€ä¹ˆä¹Ÿä¸ç”Ÿæˆï¼Œå°±åªæ˜¯è¾“å‡ºä¸€å¥ Hello worldã€‚&lt;/p>
&lt;h3 id="ç®€å•ç”Ÿæˆ">ç®€å•ç”Ÿæˆ&lt;/h3>
&lt;p>ä¸€ä¸ªç®€å•çš„&lt;code>proto&lt;/code>æ–‡ä»¶ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-protobuf" data-lang="protobuf">&lt;span class="n">syntax&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;proto3&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">option&lt;/span> &lt;span class="n">go_package&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;play/proto&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="kd">message&lt;/span> &lt;span class="nc">Hello&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="kd">message&lt;/span> &lt;span class="nc">World&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="n">greeting&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="kd">service&lt;/span> &lt;span class="n">greeter&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="k">rpc&lt;/span> &lt;span class="n">SayHello&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Hello&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">World&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¾“å‡ºæ–‡ä»¶é‡Œæ‰€æœ‰çš„ç»“æ„ã€æœåŠ¡ã€RPCæ–¹æ³•åç§°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;flag&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;log&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;google.golang.org/protobuf/compiler/protogen&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetFlags&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetPrefix&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;protoc-gen-hello: &amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">flags&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FlagSet&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Options&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">ParamFunc&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">flags&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Set&lt;/span>&lt;span class="p">}.&lt;/span>&lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Gen&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">Gen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">plugin&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Plugin&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">filename&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">plugin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FileToGenerate&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">file&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">plugin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FilesByPath&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">filename&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">msg&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Messages&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;message: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">msg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Desc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">FullName&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">svc&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Services&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;service: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">svc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Desc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">FullName&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">method&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">svc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Methods&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;method: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">method&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Desc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">FullName&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹å‡ºæ¥ä½¿ç”¨éå¸¸ç®€å•ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯ &lt;code>message&lt;/code> æ˜¯å¯ä»¥åµŒå¥—çš„ï¼Œ&lt;code>message&lt;/code>å†…è¿˜èƒ½å®šä¹‰&lt;code>message&lt;/code>å’Œ&lt;code>enum&lt;/code>ï¼Œä¸Šé¢çš„ä¾‹å­æ²¡æœ‰å¤„ç†ã€‚&lt;/p>
&lt;p>æ¥ä¸‹æ¥æˆ‘ä»¬æŠŠå‘½ä»¤è¡Œè¾“å‡ºæ”¹æˆè¾“å‡ºåˆ°æ–‡ä»¶ï¼Œè®©ç¨‹åºæœ‰ç‚¹å®é™…ç”¨é€”ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;flag&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;log&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;path&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;strings&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;google.golang.org/protobuf/compiler/protogen&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetFlags&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetPrefix&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;protoc-gen-hello: &amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">flags&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FlagSet&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Options&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">ParamFunc&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">flags&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Set&lt;/span>&lt;span class="p">}.&lt;/span>&lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Gen&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">Gen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">plugin&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Plugin&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">filename&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">plugin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FileToGenerate&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">g&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">plugin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewGeneratedFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">strings&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ReplaceAll&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">path&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Base&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">filename&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="s">&amp;#34;.proto&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;.md&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;# API æ–‡æ¡£&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;## ç»“æ„å®šä¹‰&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">file&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">plugin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FilesByPath&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">filename&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">msg&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Messages&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;message: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">msg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Desc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">FullName&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;### &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">msg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Desc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Name&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">svc&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Services&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;## æœåŠ¡ &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">svc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Desc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">FullName&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;service: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">svc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Desc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">FullName&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">method&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">svc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Methods&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;method: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">method&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Desc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">FullName&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;### æ¥å£ &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">method&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Desc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Name&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ³¨æ„ä½¿ç”¨äº† &lt;code>plugin.NewGeneratedFile&lt;/code>è€Œä¸æ˜¯ç›´æ¥&lt;code>os.Open&lt;/code>ï¼Œå› ä¸ºè¿™æ˜¯&lt;code>protoc&lt;/code>æ’ä»¶çš„çº¦å®šä¹‹ä¸€ã€‚&lt;code>protoc&lt;/code>æ’ä»¶ç³»ç»Ÿå…è®¸æ’ä»¶æä¾›&lt;code>insert point&lt;/code>ï¼Œè®©åˆ«çš„æ’ä»¶ä¿®æ”¹æ’ä»¶ç”Ÿæˆçš„ä»£ç ã€‚ä¸è¿‡ç›®å‰æˆ‘ä»¬æ²¡æœ‰è¿™ç§åŠŸèƒ½ï¼Œä½†éµå¾ªçº¦å®šçš„æ–¹å¼æ¥ç¼–å†™ä»£ç æ€»æ˜¯æ²¡åå¤„çš„ã€‚&lt;/p>
&lt;p>ä»£ç é‡Œä¼šæœ‰å¾ˆå¤šæ²¡çœ‹æ‡‚çš„ä¸œè¥¿ï¼Œæ¯”å¦‚ &lt;code>Desc&lt;/code> ï¼Œå…¶å®æ˜¯&lt;code>Descriptor&lt;/code>çš„ç¼©å†™ã€‚&lt;code>Descriptor&lt;/code>æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œæˆ‘è‡ªå·±çš„ç²—æš´ç†è§£å°±æ˜¯&lt;code>Descriptor&lt;/code>â€œæè¿°â€å¯¹è±¡çš„ç»“æ„å’Œå±æ€§ï¼Œå€ŸåŠ©&lt;code>Descriptor&lt;/code>æ¥è®¿é—®å’Œä¿®æ”¹å¯¹è±¡ã€‚å¬èµ·æ¥åƒæ˜¯åå°„ï¼Œç”¨èµ·æ¥ä¹Ÿæ˜¯åå°„çš„æ„Ÿè§‰ã€‚åœ¨ Python é‡Œä¹Ÿæœ‰ä¸ª &lt;code>descriptor&lt;/code>ï¼Œ&lt;a class="link" href="https://docs.python.org/3/howto/descriptor.html" target="_blank" rel="noopener"
>Descriptor HowTo Guide&lt;/a>ï¼Œå’Œè¿™é‡Œçš„&lt;code>Descriptor&lt;/code>æœ‰ç›¸ä¼¼çš„åœ°æ–¹ï¼Œä»…ä¾›å‚è€ƒã€‚&lt;/p>
&lt;h3 id="æ¨¡æ¿åŒ–">æ¨¡æ¿åŒ–&lt;/h3>
&lt;p>è™½ç„¶ä¹Ÿèƒ½ç›´æ¥åœ¨ä»£ç é‡Œç”¨ &lt;code>g.P&lt;/code> å®Œæˆç”Ÿæˆå·¥ä½œï¼Œä½†æ˜¯æœªå…éº»çƒ¦ã€‚&lt;code>g.P&lt;/code>è¿™ä¸ªæ¥å£å®è¯è¯´æˆ‘è§‰å¾—ä¸è¡Œï¼Œæ€ä¹ˆä¸å®ç°ä¸€ä¸ª&lt;code>StringWriter&lt;/code>ã€‚&lt;/p>
&lt;p>è¿™é‡Œç”¨æ¨¡æ¿æœ€å¤§çš„å¥½å¤„æ˜¯èƒ½è½»æ¾åœ°å®Œæˆä¸€å¤§å †å­—ç¬¦ä¸²æ‹¼æ¥æ··åˆä¸€äº›ç®€å•çš„é€»è¾‘çš„æƒ…å†µï¼Œå¦‚æœç”¨ go ä»£ç å®ç°ä¼šéå¸¸å•°å—¦ã€‚&lt;/p>
&lt;p>å…ˆå±•ç¤ºä¸‹æˆ‘ä½¿ç”¨çš„æ¨¡æ¿ï¼Œä»£ç å¤ªç½—å—¦å°±ä¸è´´äº†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-markdown" data-lang="markdown">{{ define &amp;#34;message-link&amp;#34; -}}
{{ if .Message -}}
../../../{{ .Message.ParentFile.Path | base | replace &amp;#34;.proto&amp;#34; &amp;#34;&amp;#34; }}/types/{{ .Message.FullName | toString | replace &amp;#34;.&amp;#34; &amp;#34;_&amp;#34;}}/
{{- else if .Enum -}}
../../../{{ .Enum.ParentFile.Path | base | replace &amp;#34;.proto&amp;#34; &amp;#34;&amp;#34; }}/types/{{ .Enum.FullName | toString | replace &amp;#34;.&amp;#34; &amp;#34;_&amp;#34; }}/
{{- end }}
{{- end -}}
{{ define &amp;#34;message&amp;#34; -}}
&lt;span class="gs">**JSON:**&lt;/span>
&lt;span class="s">```json
&lt;/span>&lt;span class="s">&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="err">{&lt;/span> &lt;span class="err">.Desc&lt;/span> &lt;span class="err">|&lt;/span> &lt;span class="err">GenerateExample&lt;/span> &lt;span class="p">}&lt;/span>&lt;span class="err">}&lt;/span>
&lt;span class="s">```&lt;/span>
&lt;span class="gs">**å­—æ®µè¯´æ˜:**&lt;/span>
|å­—æ®µ|ç±»å‹|è¯´æ˜|
|----|----|----|
{{ range .Fields -}}
|`{{- .Desc.Name }}`|[`{{ template &amp;#34;field-type&amp;#34; .Desc }}`]({{template &amp;#34;message-link&amp;#34; .Desc }})|{{ .Comments | InlineMarkdownDocString | default &amp;#34;*æ­¤å­—æ®µæ²¡æœ‰æ–‡æ¡£æ³¨é‡Š*&amp;#34;}}|
{{ end }}
{{- end -}}
&lt;span class="gh"># {{ .Desc.FullName | toString | replace &amp;#34;.&amp;#34; &amp;#34;_&amp;#34; }}
&lt;/span>&lt;span class="gh">&lt;/span>
{{ template &amp;#34;message&amp;#34; . }}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ€ç»ˆç”Ÿæˆç»“æœå°±åƒæ˜¯è¿™æ ·ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 192;
flex-basis: 462px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/protogen-code-generation/image-20220221161802205.png" data-size="778x404">
&lt;img src="https://nnnewb.github.io/blog/blog/p/protogen-code-generation/image-20220221161802205.png"
width="778"
height="404"
srcset="https://nnnewb.github.io/blog/blog/p/protogen-code-generation/image-20220221161802205_hu2efbed3d0c9645c8b3aebafcdc662339_25912_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/protogen-code-generation/image-20220221161802205_hu2efbed3d0c9645c8b3aebafcdc662339_25912_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="ç”Ÿæˆç»“æœ">
&lt;/a>
&lt;figcaption>ç”Ÿæˆç»“æœ&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>æœ¬èº«æ˜¯ä¸ªå¾ˆç®€å•çš„ä¸œè¥¿ã€‚åŸå…ˆç”¨è§£æprotoæ–‡ä»¶è¯­æ³•æ ‘å†ç”Ÿæˆæ–‡æ¡£çš„æ–¹æ³•ä¸æ˜¯ä¸è¡Œï¼Œä½†ä¸€æ¥ç¬¬ä¸‰æ–¹çš„è§£æåº“ç»å¸¸æœ‰ä¸æ”¯æŒçš„è¯­æ³•å’Œå¥‡æ€ªçš„bugï¼Œ&lt;code>protoc&lt;/code>æœ¬èº«åˆæ˜¯äº‹å®æ ‡å‡†ï¼Œå®˜æ–¹çš„ DSL Specification æ–‡æ¡£å°±æ˜¯ä¸ªåºŸç‰©æ–‡æ¡£ï¼Œè¿ &lt;code>option(http) {}&lt;/code> è¿™æ ·çš„éƒ½ç®—æ˜¯ specification ä¹‹å¤–ï¼Œè¿˜æœ‰ &lt;code>optional&lt;/code> åœ¨ proto3 è¿˜èƒ½ç”¨ä¹‹ç±»çš„è®©äººæƒ³éª‚å‚»é€¼çš„é—®é¢˜ã€‚&lt;/p>
&lt;p>åæ¥æ”¹æˆäº† &lt;code>typescript&lt;/code> + &lt;code>protobuf.js&lt;/code> ï¼Œå®˜æ–¹æ”¯æŒçš„ç¨³å®šæ€§ä¸€ä¸‹å­å°±å¥½å¤šäº†ï¼Œä½†è¿™ä¸ªè·‘èµ·æ¥æ€§èƒ½å®åœ¨æœ‰ç‚¹æ‹‰ï¼Œè€Œä¸” ts ç‰ˆæœ¬ç”¨äº† &lt;code>ejs&lt;/code> ä½œä¸ºæ¨¡æ¿å¼•æ“ï¼Œ&lt;code>ejs&lt;/code>çš„æ ‡ç­¾å†™èµ·æ¥ç½—å—¦åˆ°ä¸è¡Œï¼Œå†…åµŒ js çš„å†™æ³•ä¸€æ—¶çˆ½ï¼Œçˆ½å®Œè‡ªå·±éƒ½å¿«çœ‹ä¸æ‡‚å†™äº†ä»€ä¹ˆç©æ„å„¿äº†ã€‚&lt;/p>
&lt;p>æœ€åæ¢å› &lt;code>go&lt;/code>+&lt;code>protogen&lt;/code>ï¼Œä¸€ä¸‹å­å°±èˆ’æœå¤šäº†ã€‚&lt;/p></description></item><item><title>åˆ†æ”¯é¢„æµ‹å¯¹æ‰§è¡Œæ•ˆç‡å’Œå®‰å…¨çš„å½±å“</title><link>https://nnnewb.github.io/blog/p/how-branch-prediction-effects-executoin-performance-and-security/</link><pubDate>Wed, 16 Feb 2022 16:00:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/how-branch-prediction-effects-executoin-performance-and-security/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>è¿˜æ˜¯ä» &lt;em>Igor Ostrvsky&lt;/em> çš„åšå®¢é‡Œå‘ç°çš„ä¸€ç¯‡æœ‰æ„æ€çš„æ–‡ç« ï¼Œ&lt;a class="link" href="http://igoro.com/archive/fast-and-slow-if-statements-branch-prediction-in-modern-processors/" target="_blank" rel="noopener"
>Fast and slow if-statements: branch prediction in modern processors&lt;/a> å¼€å§‹ã€‚&lt;/p>
&lt;h2 id="åˆ†æ”¯é¢„æµ‹å¯¹æ€§èƒ½çš„å½±å“">åˆ†æ”¯é¢„æµ‹å¯¹æ€§èƒ½çš„å½±å“&lt;/h2>
&lt;h3 id="ä»‹ç»">ä»‹ç»&lt;/h3>
&lt;p>&lt;a class="link" href="https://zh.wikipedia.org/wiki/%E5%88%86%E6%94%AF%E9%A0%90%E6%B8%AC%E5%99%A8" target="_blank" rel="noopener"
>åˆ†æ”¯é¢„æµ‹å™¨ - Wikipedia&lt;/a> æˆ‘ç›´æ¥æŠ„ä¸€æ®µã€‚&lt;/p>
&lt;blockquote>
&lt;p>åœ¨&lt;a class="link" href="https://zh.wikipedia.org/wiki/%e9%9b%bb%e8%85%a6%e6%9e%b6%e6%a7%8b" target="_blank" rel="noopener"
>è®¡ç®—æœºä½“ç³»ç»“æ„&lt;/a>ä¸­ï¼Œ&lt;strong>åˆ†æ”¯é¢„æµ‹å™¨&lt;/strong>ï¼ˆè‹±è¯­ï¼šBranch predictorï¼‰æ˜¯ä¸€ç§&lt;a class="link" href="https://zh.wikipedia.org/wiki/%e6%95%b8%e4%bd%8d%e9%9b%bb%e8%b7%af" target="_blank" rel="noopener"
>æ•°å­—ç”µè·¯&lt;/a>ï¼Œåœ¨åˆ†æ”¯æŒ‡ä»¤æ‰§è¡Œç»“æŸä¹‹å‰çŒœæµ‹å“ªä¸€è·¯&lt;a class="link" href="https://zh.wikipedia.org/wiki/%e5%88%86%e6%94%af_%28%e8%a8%88%e7%ae%97%e6%a9%9f%e7%a7%91%e5%ad%b8%29" target="_blank" rel="noopener"
>åˆ†æ”¯&lt;/a>å°†ä¼šè¢«æ‰§è¡Œï¼Œä»¥æé«˜å¤„ç†å™¨çš„&lt;a class="link" href="https://zh.wikipedia.org/wiki/%e6%8c%87%e4%bb%a4%e6%b5%81%e6%b0%b4%e7%ba%bf" target="_blank" rel="noopener"
>æŒ‡ä»¤æµæ°´çº¿&lt;/a>çš„æ€§èƒ½ã€‚ä½¿ç”¨åˆ†æ”¯é¢„æµ‹å™¨çš„ç›®çš„ï¼Œåœ¨äºæ”¹å–„&lt;a class="link" href="https://zh.wikipedia.org/wiki/%e6%8c%87%e4%bb%a4%e7%ae%a1%e7%b7%9a%e5%8c%96" target="_blank" rel="noopener"
>æŒ‡ä»¤æµæ°´çº¿&lt;/a>çš„æµç¨‹ï¼Œå°±åƒä¸€å®¶å…¬å¸çš„å‘˜å·¥æå‰é¢„æµ‹å…¬å¸æ‰€éœ€è¦çš„ä¸œè¥¿ï¼Œå³äº¤ä»˜ä¸åŒå•ä½è¿›è¡Œå‡†å¤‡å·¥ä½œï¼Œè€Œé‚£å„ä¸ªéƒ¨é—¨ä¹‹é—´çš„ç­‰å¾…äº¤åŠçš„æ—¶é—´å¤§å¤§åœ°ç¼©çŸ­ï¼Œæ•´ä¸ªå…¬å¸çš„æ•ˆç‡å°±ä¼šæé«˜äº†ã€‚ç°ä»£ä½¿ç”¨&lt;a class="link" href="https://zh.wikipedia.org/wiki/%e6%8c%87%e4%bb%a4%e7%ae%a1%e7%b7%9a%e5%8c%96" target="_blank" rel="noopener"
>æŒ‡ä»¤æµæ°´çº¿&lt;/a>å¤„ç†å™¨çš„æ€§èƒ½èƒ½å¤Ÿæé«˜ï¼Œåˆ†æ”¯é¢„æµ‹å™¨å¯¹äºç°ä»Šçš„æŒ‡ä»¤æµæ°´çº¿å¾®å¤„ç†å™¨è·å¾—é«˜æ€§èƒ½æ˜¯éå¸¸å…³é”®çš„æŠ€æœ¯ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>ç°ä»£ CPU çš„åˆ†æ”¯é¢„æµ‹æ²¡æœ‰ &lt;em>Igor Ostrvsky&lt;/em> çš„åšå®¢é‡Œå†™çš„åˆ†æ”¯é¢„æµ‹å™¨é‚£ä¹ˆå‚»äº†ï¼Œå®é™…ä¸Šï¼Œé‚£ç¯‡åšå®¢é‡Œçš„ä»£ç åœ¨ i5-6600 çš„ç¯å¢ƒä¸‹è·‘èµ·æ¥ï¼Œ&lt;code>TTFF&lt;/code>æˆ–è€…&lt;code>TTTTFFFF&lt;/code>ç”šè‡³æ¯”&lt;code>TTTT&lt;/code>è¿˜è¦å¿«ã€‚é‚£ç¯‡åšå®¢åˆ›ä½œäº 2010 å¹´ï¼Œ è€Œ Skylake æ¶æ„åœ¨ 2015 å¹´æ›¿ä»£ Broadwell æ¶æ„ï¼Œè€Œç°åœ¨æ˜¯ 2022å¹´ï¼Œ Intel å·²ç»å‘å¸ƒäº† GoldenCove ï¼ŒAMD ä¹Ÿè¦å‘ Zen 4äº†ã€‚å†…å®¹è¿‡æ—¶ä¸å¯é¿å…ã€‚&lt;/p>
&lt;p>æ‰€ä»¥è¿™ç¯‡åšå®¢ä¸»è¦è¿˜æ˜¯èŠä¸€ä¸‹åˆ†æ”¯é¢„æµ‹å¯¹æ€§èƒ½çš„å½±å“ï¼Œä½†å¤§æ¦‚æ€»ç»“ä¸å‡º Igor Ostrvsky çš„åšå®¢é‡Œçš„è§„å¾‹ã€‚é¡ºå¸¦ä¸€æï¼Œä¸è¦éšä¾¿é’ˆå¯¹åˆ†æ”¯é¢„æµ‹ä¼˜åŒ–ï¼Œè¦æ˜¯æœ‰äººçœ‹äº† Igor Ostrvsky é‚£ç¯‡åšå®¢è´¹äº†è€å¤§åŠŸå¤«ä¼˜åŒ–æˆè¿ç»­ T/F åˆ†æ”¯ï¼Œæ¢ä¸Šæ–° CPU ä¹‹åæ€§èƒ½è¿˜å€’é€€è¿™èƒ½æ‰¾è°è¯´ç†å»ã€‚é’ˆå¯¹å¾®æ¶æ„åˆ†æ”¯é¢„æµ‹å¤±è´¥å›é€€åšä¼˜åŒ–æˆ‘è¿˜åœ¨çˆ†æ ˆä¸Šçœ‹åˆ°ä¸ªå›ç­”å¾ˆæœ‰æ„æ€ï¼Œ&lt;a class="link" href="https://stackoverflow.com/questions/49932119/avoid-stalling-pipeline-by-calculating-conditional-early" target="_blank" rel="noopener"
>avoid stalling pipeline by calculating conditional early&lt;/a> ï¼Œå¾ˆéš¾æƒ³åˆ°è¿˜èƒ½ç”¨è¿™ç§åŠæ³•æ¦¨å¹² CPU çš„æ¯ä¸€æ»´æ€§èƒ½ã€‚&lt;/p>
&lt;h3 id="åŸºå‡†æµ‹è¯•">åŸºå‡†æµ‹è¯•&lt;/h3>
&lt;p>è¿™ä¸ªåŸºå‡†æµ‹è¯•çš„ä¸»è¦ç›®çš„æ˜¯ä½“ç°å‡ºåˆ†æ”¯é¢„æµ‹å¤±è´¥å¯¹æ‰§è¡Œæ—¶é—´çš„å½±å“ï¼Œæµ‹è¯•æ–¹æ³•æ˜¯å–‚ 10MB çš„éšæœº T/F ï¼Œä¸º T æ—¶è®¡æ•°å™¨ +1ã€‚é™¤äº†è¾“å…¥æ•°æ®å¤–æµ‹è¯•ä»£ç ä¸€æ ·ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;iostream&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;functional&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;chrono&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdlib.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;vector&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;cstdlib&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="k">using&lt;/span> &lt;span class="k">namespace&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">using&lt;/span> &lt;span class="k">namespace&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">chrono&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">benchmark&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="n">string&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">uint32_t&lt;/span> &lt;span class="n">loops&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">function&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">fn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">milliseconds&lt;/span> &lt;span class="n">sum&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="n">ms&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">lowest&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="n">ms&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">highest&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="n">ms&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">loops&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">start&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">system_clock&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">now&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="n">fn&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">stop&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">system_clock&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">now&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">d&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">duration_cast&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">milliseconds&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stop&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">start&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">sum&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">d&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">lowest&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">lowest&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="n">ms&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="nl">d&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">min&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">lowest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">d&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">highest&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">max&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">highest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">d&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">cout&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">cout&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34; avg: &amp;#34;&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">sum&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">loops&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34;ms&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">cout&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34; best: &amp;#34;&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">lowest&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34;ms&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">cout&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34; worst: &amp;#34;&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">highest&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34;ms&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">cout&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34; total: &amp;#34;&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">sum&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34;ms&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">cout&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">endl&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">srand&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">duration_cast&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">seconds&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">system_clock&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">now&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="n">time_since_epoch&lt;/span>&lt;span class="p">()).&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">());&lt;/span>
&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">always_true&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">unpredictable&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">always_true&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">resize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1024&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">1024&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">unpredictable&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">resize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1024&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">1024&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">auto&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nl">i&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">unpredictable&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">rand&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">benchmark&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;always true&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">always_true&lt;/span>&lt;span class="p">]()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">sum&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">auto&lt;/span> &lt;span class="nl">i&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">always_true&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">sum&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">});&lt;/span>
&lt;span class="n">benchmark&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;unpredictable&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">unpredictable&lt;/span>&lt;span class="p">]()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">sum&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">auto&lt;/span> &lt;span class="nl">i&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">unpredictable&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">sum&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">});&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½¿ç”¨ clang++ ç¼–è¯‘&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="c1"># clang version 13.0.0&lt;/span>
&lt;span class="c1"># Target: x86_64-pc-windows-msvc&lt;/span>
&lt;span class="c1"># Thread model: posix&lt;/span>
&lt;span class="c1"># InstalledDir: C:\Program Files\LLVM\bin&lt;/span>
clang++.exe -m32 -O0 -g -std&lt;span class="o">=&lt;/span>c++20 .&lt;span class="se">\b&lt;/span>ranch-prediction-1.cpp -o branch-prediction-1.exe
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç»Ÿè®¡å¹³å‡ã€æœ€ä½³ã€æœ€å·®è€—æ—¶ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">always true avg: 120ms best: 116ms worst: 246ms total: 12056ms
unpredictable avg: 191ms best: 184ms worst: 265ms total: 19115ms
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°ï¼Œæ•°æ®é‡ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œè¾“å…¥æ•°æ®æ˜¯éšæœº T/F çš„å¹³å‡è€—æ—¶æ¯”æ€»ä¸ºçœŸçš„è€—æ—¶é«˜å‡º 50%ï¼Œæ€»è€—æ—¶å¤šå‡º 7 ç§’å·¦å³ï¼ˆå·®ä¸å¤šä¹Ÿæ˜¯50%å¤šä¸€ç‚¹ï¼‰ã€‚å¯æƒ³è€ŒçŸ¥ï¼Œå¦‚æœè¾“å…¥æ•°æ®æ›´æœ‰è§„å¾‹ï¼ˆæ¯”å¦‚å‰åŠæ®µéƒ½æ˜¯TååŠæ®µéƒ½æ˜¯Fï¼‰ï¼Œæ•°æ®é‡ä¸å˜çš„æƒ…å†µä¸‹ï¼Œæ€§èƒ½ä¹Ÿä¼šæœ‰ç›¸å½“ä¸é”™çš„æé«˜ã€‚&lt;/p>
&lt;p>é¡ºä¾¿æˆ‘è¿˜è¦è¯´ä¸€ä¸‹è¿™ä¸ªåŸºå‡†æµ‹è¯•ä¸å¤Ÿå¥½ï¼Œåº”è¯¥æ¯ä¸ªæµ‹è¯•å¾ªç¯éƒ½ç”Ÿæˆä¸€æ¬¡éšæœºæ•°è¾“å…¥çš„ã€‚&lt;/p>
&lt;h3 id="åˆ†æ”¯é¢„æµ‹æ‰®æ¼”çš„è§’è‰²">åˆ†æ”¯é¢„æµ‹æ‰®æ¼”çš„è§’è‰²&lt;/h3>
&lt;p>è¿™è¿˜å¾—ä»CPUæ‰§è¡ŒæŒ‡ä»¤çš„è¿‡ç¨‹è¯´èµ·ã€‚è¿™é‡ŒèŠçš„ CPU æ‰§è¡Œä¸€æ¡æŒ‡ä»¤éœ€è¦ç»è¿‡ä¸‹é¢çš„æ­¥éª¤ï¼Œç§°ä½œæµæ°´çº¿ã€‚è®¡ç®—æœºç»„æˆåŸç†è¯¾åº”è¯¥æœ‰è¯´ã€‚&lt;/p>
&lt;ul>
&lt;li>å–æŒ‡ (fetch)&lt;/li>
&lt;li>è¯‘ç  (decode)&lt;/li>
&lt;li>æ‰§è¡Œ (ç®—æ•°æŒ‡ä»¤èµ° ALU)&lt;/li>
&lt;li>è®¿é—®ä¸»å­˜ (Load/Store)&lt;/li>
&lt;li>å†™å›&lt;/li>
&lt;/ul>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 212;
flex-basis: 509px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/how-branch-prediction-effects-executoin-performance-and-security/1365470-20181201231438070-1210623531.png" data-size="1237x583">
&lt;img src="https://nnnewb.github.io/blog/blog/p/how-branch-prediction-effects-executoin-performance-and-security/1365470-20181201231438070-1210623531.png"
width="1237"
height="583"
srcset="https://nnnewb.github.io/blog/blog/p/how-branch-prediction-effects-executoin-performance-and-security/1365470-20181201231438070-1210623531_hud9ed14138f8676bf12375622c7bab6ae_181582_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/how-branch-prediction-effects-executoin-performance-and-security/1365470-20181201231438070-1210623531_hud9ed14138f8676bf12375622c7bab6ae_181582_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="å•å‘¨æœŸå¤„ç†å™¨å’Œæµæ°´çº¿å¤„ç†å™¨">
&lt;/a>
&lt;figcaption>å•å‘¨æœŸå¤„ç†å™¨å’Œæµæ°´çº¿å¤„ç†å™¨&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æ›´ç®€åŒ–ä¸€ç‚¹çš„è¯å¯ä»¥æŠŠALUç®—æ•°è¿ç®—å’Œè®¿å­˜éƒ½ç®—ä½œæŒ‡ä»¤çš„â€œæ‰§è¡Œâ€é˜¶æ®µï¼ŒCPUå°±æ˜¯åœ¨ä¸æ–­å¾ªç¯æ‰§è¡Œè¿™å››ä¸ªåŠ¨ä½œã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 104;
flex-basis: 250px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/how-branch-prediction-effects-executoin-performance-and-security/500pxPipeline_4_stage_svg.png" data-size="500x479">
&lt;img src="https://nnnewb.github.io/blog/blog/p/how-branch-prediction-effects-executoin-performance-and-security/500pxPipeline_4_stage_svg.png"
width="500"
height="479"
srcset="https://nnnewb.github.io/blog/blog/p/how-branch-prediction-effects-executoin-performance-and-security/500pxPipeline_4_stage_svg_hu15edc282cd853d13d1b62dfc619067e7_33080_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/how-branch-prediction-effects-executoin-performance-and-security/500pxPipeline_4_stage_svg_hu15edc282cd853d13d1b62dfc619067e7_33080_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="4é˜¶æ®µæµæ°´çº¿">
&lt;/a>
&lt;figcaption>4é˜¶æ®µæµæ°´çº¿&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æµæ°´çº¿å¤„ç†å™¨ä¸ºäº†å……åˆ†åˆ©ç”¨ç¡¬ä»¶ï¼Œåœ¨è¯‘ç ä¸Šä¸€æ¡æŒ‡ä»¤æ—¶ï¼Œå°±å¼€å§‹å–æŒ‡ä¸‹ä¸€æ¡æŒ‡ä»¤äº†ï¼Œæ‰§è¡Œé€Ÿåº¦å¯ä»¥æ˜¯å•å‘¨æœŸå¤„ç†å™¨çš„å¾ˆå¤šå€ã€‚æ˜¾ç„¶æµæ°´çº¿è¶Šé•¿ï¼Œæ¯ä¸ªé˜¶æ®µçš„è€—æ—¶è¶ŠçŸ­ï¼Œæ•´ä½“æ‰§è¡Œçš„æ•ˆç‡å°±è¶Šé«˜ã€‚&lt;/p>
&lt;p>å¦‚æœæŒ‡ä»¤ä¸€ç›´æŒ‰é¡ºåºæ‰§è¡Œï¼Œæµæ°´çº¿åªè¦ä¸æ–­åŠ é•¿åŠ å¿«å°±èƒ½è·å¾—æ›´é«˜çš„æ€§èƒ½ï¼Œä½†â€œåˆ†æ”¯â€æ‰“ç ´äº†è¿™ä¸ªç¾æ¢¦ã€‚ä¸€ä¸ªç®€çŸ­çš„ä¾‹å­å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nl">loop:&lt;/span>
&lt;span class="nf">inc&lt;/span> &lt;span class="no">eax&lt;/span>
&lt;span class="nf">cmp&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="no">ebx&lt;/span>
&lt;span class="nf">jne&lt;/span> &lt;span class="no">loop&lt;/span>
&lt;span class="nf">call&lt;/span> &lt;span class="no">exit&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>CPU ä» &lt;code>cmp eax,ebx&lt;/code> å¼€å§‹ï¼Œå–æŒ‡ &lt;code>jne loop&lt;/code>ã€‚è¯‘ç  &lt;code>jne loop&lt;/code> æ—¶ï¼Œé—®é¢˜æ¥äº†ï¼Œæ¥ä¸‹æ¥æ˜¯å–æŒ‡ &lt;code>call exit&lt;/code> è¿˜æ˜¯ &lt;code>inc eax&lt;/code>ï¼Ÿ&lt;/p>
&lt;p>æ­¤æ—¶æˆ‘ä»¬è¿˜ä¸çŸ¥é“ &lt;code>cmp eax,ebx&lt;/code> çš„ç»“æœï¼ŒCPU èƒ½åšçš„äº‹æƒ…åªæœ‰ï¼šå‚»ç­‰(stall)ï¼Œæˆ–è€…çŒœæµ‹ä¸‹ä¸€æ¡è¦æ‰§è¡Œçš„æŒ‡ä»¤æ˜¯ä»€ä¹ˆ(predict)ã€‚&lt;/p>
&lt;p>ç°ä»£å¤„ç†å™¨çš„æµæ°´çº¿é•¿åº¦å¯ä»¥è¾¾åˆ°å‡ åï¼Œå¦‚æœ CPU é‡åˆ°éœ€è¦ä¸Šä¸€æ¡æŒ‡ä»¤çš„ç»“æœæ¥ç»§ç»­ä¸‹ä¸€æ¡æŒ‡ä»¤å°±å¼€å§‹ç­‰ï¼Œé‚£ä¹ˆæµæ°´çº¿å°±ä¸å¾—ä¸é—²ç½®åˆ°ä¸Šä¸€æ¡æŒ‡ä»¤å®Œæˆï¼Œç»“æœå°±æ˜¯åˆ†æ”¯æŒ‡ä»¤çš„ä»£ä»·ä¼šæ˜¯å…¶ä»–æŒ‡ä»¤çš„å‡ åå€ï¼Œå¯¹å¾ªç¯è¯­å¥æ¥è¯´æ˜¯ä¸ªå™©è€—ã€‚&lt;/p>
&lt;p>å½±å“æµæ°´çº¿æ•ˆç‡çš„è¿˜æœ‰å…¶ä»–å…ƒç´ ï¼Œæ¯”å¦‚è¯´ä¸Šé¢çš„ å–å€¼-è¯‘ç -æ‰§è¡Œ-å†™å› è¿‡ç¨‹é‡Œï¼Œå››ä¸ªé˜¶æ®µçš„æ‰§è¡Œé€Ÿåº¦ä¹Ÿæ˜¯ä¸åŒçš„ã€‚é€šå¸¸å–å€¼å’Œè¯‘ç çš„é€Ÿåº¦æ›´æ…¢ï¼Œæ‰§è¡Œå†™å›æ›´å¿«ã€‚å¦‚ä½•å°½å¯èƒ½è®©æ¯ä¸ªæ‰§è¡Œå•å…ƒéƒ½ä¸æµªè´¹æ—¶é—´ç­‰å¾…ï¼Œä¹Ÿæ˜¯ä¸ªéš¾é¢˜ã€‚&lt;/p>
&lt;p>å…³äºæµæ°´çº¿ï¼Œ&lt;a class="link" href="https://plantegg.github.io/2021/05/16/Perf_IPC%E4%BB%A5%E5%8F%8ACPU%E5%88%A9%E7%94%A8%E7%8E%87/" target="_blank" rel="noopener"
>Perf IPC ä»¥åŠ CPU åˆ©ç”¨ç‡&lt;/a> è¿™ç¯‡æ–‡ç« æ„Ÿè§‰ä¸é”™ã€‚&lt;/p>
&lt;p>ç»§ç»­è¯´ã€‚æ—¢ç„¶è®©æµæ°´çº¿é€€åŒ–åˆ°å•å‘¨æœŸä¸å¯å–ï¼Œé‚£å°±ççŒœä¸€ä¸ªï¼Œå…ˆæŠŠæµæ°´çº¿å¡«æ»¡å†è¯´å‘—ï¼Œåæ­£ä¸ä¼šæ¯”å‚»ç­‰æ›´å·®äº†ã€‚äºæ˜¯å°±æœ‰äº†åˆ†æ”¯é¢„æµ‹å™¨ï¼šè™½ç„¶æ˜¯ççŒœï¼Œä½†å°½å¯èƒ½çŒœå¾—å‡†ä¸€ç‚¹æ€»æ²¡åå¤„ã€‚&lt;/p>
&lt;h3 id="å‡å°‘åˆ†æ”¯é¢„æµ‹å¤±è´¥çš„æŸå¤±">å‡å°‘åˆ†æ”¯é¢„æµ‹å¤±è´¥çš„æŸå¤±&lt;/h3>
&lt;p>å®è¯è¯´æˆ‘ä¸ç¡®å®šè¿™ä¸ªä»£ä»·æœ‰å¤šå¤§ï¼Œå› ä¸ºæ²¡æ³•æ§åˆ¶å¤±è´¥ç‡ï¼Œä¸çŸ¥é“ç°åœ¨æ­£åœ¨ç”¨çš„ CPU çš„åˆ†æ”¯é¢„æµ‹å™¨æ˜¯æ€ä¹ˆå·¥ä½œçš„ã€‚&lt;/p>
&lt;p>ç›´æ¥æ„é€ éšæœºçš„ T/F åºåˆ—æ˜¯ä¸€ç§åŠæ³•ï¼Œå‰é¢çš„åŸºå‡†æµ‹è¯•å·²ç»éªŒè¯äº†éšæœº T/F å¹²æ‰°åˆ†æ”¯é¢„æµ‹ä¼šäº§ç”Ÿæ¥è¿‘ 50% çš„å¤šä½™å¼€é”€ã€‚é‚£ä¹ˆæœ‰æ²¡æœ‰åŠæ³•é™ä½åˆ†æ”¯é¢„æµ‹å¤±è´¥çš„æŸå¤±å‘¢ï¼Ÿæ€ä¹ˆè®© CPU æ›´æ—©å‘ç°åˆ°åˆ†æ”¯é¢„æµ‹å¤±è´¥ï¼Œå‡å°‘è¦æŠ›å¼ƒã€æ¸…ç©ºçš„æµæ°´çº¿é•¿åº¦ï¼Ÿ&lt;/p>
&lt;p>å‚è€ƒå‰é¢çˆ†æ ˆçš„é“¾æ¥ &lt;a class="link" href="https://stackoverflow.com/questions/49932119/avoid-stalling-pipeline-by-calculating-conditional-early" target="_blank" rel="noopener"
>avoid stalling pipeline by calculating conditional early&lt;/a> ï¼Œæˆ‘ç®€å•å†™ä¸€ä¸ªåŸºå‡†æµ‹è¯•çœ‹çœ‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;iostream&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;functional&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;chrono&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;vector&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;cstdlib&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;random&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="k">using&lt;/span> &lt;span class="k">namespace&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">using&lt;/span> &lt;span class="k">namespace&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">chrono&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">milliseconds&lt;/span> &lt;span class="nf">time_it&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">function&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">fn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">start&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">system_clock&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">now&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="n">fn&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">stop&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">system_clock&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">now&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">duration_cast&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">milliseconds&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stop&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">start&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">benchmark&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="n">string&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">uint32_t&lt;/span> &lt;span class="n">loops&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">function&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">fn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">milliseconds&lt;/span> &lt;span class="n">sum&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="n">ms&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">lowest&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="n">ms&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">highest&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="n">ms&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">loops&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">d&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">time_it&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fn&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">sum&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">d&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">lowest&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">lowest&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="n">ms&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="nl">d&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">min&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">lowest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">d&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">highest&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">max&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">highest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">d&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">cout&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">cout&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34; avg: &amp;#34;&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">sum&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">loops&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34;ms&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">cout&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34; best: &amp;#34;&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">lowest&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34;ms&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">cout&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34; worst: &amp;#34;&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">highest&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34;ms&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">cout&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34; total: &amp;#34;&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">sum&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34;ms&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">cout&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">endl&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">typedef&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="nc">my_node&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">my_node&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">next&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">my_node&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">next&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">nullptr&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="n">my_node&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">typedef&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="nc">my_list&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">length&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">my_node&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">head&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">my_node&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">last&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">my_list&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="n">length&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">head&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">nullptr&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">last&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">nullptr&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">append&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">head&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="k">nullptr&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">head&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">my_node&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="n">last&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">head&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">last&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">next&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">my_node&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="n">last&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">last&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">next&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">length&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="n">my_list&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">sum_sentinel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">my_list&lt;/span> &lt;span class="n">list&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">sum&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">auto&lt;/span> &lt;span class="n">cur&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">list&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">head&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">cur&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="k">nullptr&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">cur&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">cur&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">next&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">sum&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">cur&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">sum_counter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">my_list&lt;/span> &lt;span class="n">list&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">sum&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">my_node&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">cur&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">list&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">head&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">list&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">length&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">cur&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">cur&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">next&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">sum&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">cur&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">my_list&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">lists&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">lists&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">resize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10000000&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">random_device&lt;/span> &lt;span class="n">rd&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">mt19937&lt;/span> &lt;span class="n">gen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rd&lt;/span>&lt;span class="p">());&lt;/span>
&lt;span class="n">uniform_int_distribution&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">dist&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">auto&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nl">list&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">lists&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">node_count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">dist&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">gen&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">node_count&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">list&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">benchmark&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;sentinel&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">lists&lt;/span>&lt;span class="p">]()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">auto&lt;/span> &lt;span class="nl">list&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">lists&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">sum_sentinel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">list&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">});&lt;/span>
&lt;span class="n">benchmark&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;counter&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">lists&lt;/span>&lt;span class="p">]()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">auto&lt;/span> &lt;span class="nl">list&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">lists&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">sum_counter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">list&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">});&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¾“å‡ºç»“æœ&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">sentinel avg: 471ms best: 470ms worst: 502ms total: 47178ms
counter avg: 407ms best: 402ms worst: 512ms total: 40726ms
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ç®€ç›´æ˜¯é»‘é­”æ³•ï¼&lt;code>sum_counter&lt;/code>æ˜æ˜¾éœ€è¦æ‰§è¡Œæ›´å¤šçš„æŒ‡ä»¤ï¼Œä½†æ‰§è¡Œé€Ÿåº¦æ¯”æŒ‡ä»¤æ›´å°‘çš„&lt;code>sum_sentinel&lt;/code>å¹³å‡å¿«70msï¼&lt;/p>
&lt;p>é€ æˆæ…¢çš„åŸå› æ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºåˆ†æ”¯é¢„æµ‹å¤±è´¥ï¼Œæˆ‘ä»¬ä»¥ä¸Šé¢çš„4é˜¶æ®µæµæ°´çº¿æ¥åˆ†æï¼Œå‡è®¾æ¯ä¸ªé˜¶æ®µè¦ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œç­‰CPUå‘ç°å–é”™äº†æŒ‡ä»¤ï¼ˆæ¯”å¦‚è¯‘ç å®Œäº†&lt;code>add&lt;/code>ï¼Œå‘ç°&lt;code>cur!=nullptr&lt;/code>æ˜¯Fï¼‰ï¼Œäºæ˜¯æµªè´¹äº†ä¸¤ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚è¿™è¢«ç§°ä¸º &lt;em>front end bubble&lt;/em> ã€‚å‚è€ƒ cloud flare çš„è¿™ç¯‡åšå®¢ï¼Œ&lt;a class="link" href="https://blog.cloudflare.com/branch-predictor/" target="_blank" rel="noopener"
>branch predictor&lt;/a> ã€‚è¿™ä¸ª &lt;em>front end&lt;/em> æŒ‡çš„æ˜¯ CPU å¾®æ¶æ„ä¸­æµæ°´çº¿çš„å‰ç«¯ï¼Œå½¢è±¡åœ°çœ‹ï¼Œæµæ°´çº¿å°±åƒæ˜¯ä¸€èŠ‚ä¸€èŠ‚çš„æ°´ç®¡ï¼ŒæŒ‡ä»¤å¡«æ»¡æ¯ä¸€èŠ‚æ°´ç®¡ï¼Œæµå‘ä¸‹ä¸€èŠ‚ã€‚åˆ†æ”¯é¢„æµ‹å¤±è´¥å°±åƒæ˜¯ä¸­é—´ä¸€èŠ‚æ°´ç®¡çªç„¶ç©ºäº†ï¼Œåé¢çš„æŒ‡ä»¤ç»§ç»­æ¨ç€ç©ºæ°”ï¼ˆé¢„æµ‹é”™è¯¯çš„æŒ‡ä»¤ï¼‰å¾€å‰èµ°ï¼Œå°±æˆäº†æ°´ç®¡é‡Œçš„ä¸€ä¸ªæ³¡æ³¡ã€‚&lt;/p>
&lt;p>ä½† &lt;code>sum_counter&lt;/code> å¿«çš„åŸå› æ›´ç¥å¥‡ï¼šå› ä¸ºæŒ‡ä»¤æ’åˆ—çš„é¡ºåºï¼Œè®©åˆ†æ”¯é¢„æµ‹ä¾èµ–çš„æŒ‡ä»¤æ›´æ—©è¿›å…¥æµæ°´çº¿ï¼Œå› æ­¤åˆ†æ”¯æŒ‡ä»¤è¿›å…¥æµæ°´çº¿åï¼Œåˆ†æ”¯é¢„æµ‹ä¼šæ›´å¿«å‘ç°é¢„æµ‹é”™è¯¯ã€‚è§ä¸‹é¢çš„æ±‡ç¼–ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="err">&amp;lt;&lt;/span>&lt;span class="nf">sum_sentinel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="no">list_head&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">&amp;gt;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nf">test&lt;/span> &lt;span class="no">rsi&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="no">rsi&lt;/span>
&lt;span class="nf">je&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="no">fe&lt;/span> &lt;span class="err">&amp;lt;&lt;/span>&lt;span class="no">sum_sentinel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="no">list_head&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">0x1e&lt;/span>&lt;span class="err">&amp;gt;&lt;/span>
&lt;span class="nf">xor&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="no">eax&lt;/span>
&lt;span class="nl">loop:&lt;/span>
&lt;span class="nf">add&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="no">DWORD&lt;/span> &lt;span class="no">PTR&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">rsi&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; --- 1
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">mov&lt;/span> &lt;span class="no">rsi&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="no">QWORD&lt;/span> &lt;span class="no">PTR&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">rsi&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">0x8&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; --- 2
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">test&lt;/span> &lt;span class="no">rsi&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="no">rsi&lt;/span> &lt;span class="c">; --- 3
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">jne&lt;/span> &lt;span class="no">loop&lt;/span> &lt;span class="c">; --- 4
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">cdqe&lt;/span> &lt;span class="c">; --- 5
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">ret&lt;/span> &lt;span class="c">; --- 6
&lt;/span>&lt;span class="c">&lt;/span>
&lt;span class="err">&amp;lt;&lt;/span>&lt;span class="nf">sum_counter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="no">list_head&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">&amp;gt;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nf">test&lt;/span> &lt;span class="no">edi&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="no">edi&lt;/span>
&lt;span class="nf">jle&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="no">d0&lt;/span> &lt;span class="err">&amp;lt;&lt;/span>&lt;span class="no">sum_counter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="no">list_head&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">0x20&lt;/span>&lt;span class="err">&amp;gt;&lt;/span>
&lt;span class="nf">xor&lt;/span> &lt;span class="no">edx&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="no">edx&lt;/span>
&lt;span class="nf">xor&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="no">eax&lt;/span>
&lt;span class="nl">loop:&lt;/span>
&lt;span class="nf">add&lt;/span> &lt;span class="no">edx&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">0x1&lt;/span> &lt;span class="c">; --- 1
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">add&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="no">DWORD&lt;/span> &lt;span class="no">PTR&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">rsi&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; --- 2
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">mov&lt;/span> &lt;span class="no">rsi&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="no">QWORD&lt;/span> &lt;span class="no">PTR&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">rsi&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">0x8&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; --- 3
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">cmp&lt;/span> &lt;span class="no">edi&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="no">edx&lt;/span> &lt;span class="c">; --- 4
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">jne&lt;/span> &lt;span class="no">loop&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="c">; --- 5
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">cdqe&lt;/span> &lt;span class="c">; --- 6
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">ret&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æƒ³è±¡æœ‰ä¸€é¢— CPU æœ‰ 5 çº§æµæ°´çº¿ï¼ˆ&lt;code>IF&lt;/code>ã€&lt;code>ID&lt;/code>ã€&lt;code>EX&lt;/code>ã€&lt;code>MEM&lt;/code>ã€&lt;code>WB&lt;/code>ï¼‰ï¼Œå¦‚ä¸Šæ ‡æ³¨çš„é¡ºåºæ‰§è¡Œã€‚&lt;/p>
&lt;p>åœ¨ &lt;code>sum_sentinel&lt;/code> ä¸­ï¼Œå¼€å§‹å¯¹ (5) å–æŒ‡æ—¶ï¼Œ(1)æ‰å®Œæˆå†™å›ã€‚å¯¹(6)å–æŒ‡æ—¶ï¼Œ(2)æ‰å†™å›ã€‚ç­‰åˆ°(3)å†™å›ï¼ŒCPUæ‰å‘ç°é”™è¯¯ï¼Œäºæ˜¯ä»(4)å¾€åçš„4çº§æµæ°´çº¿å…¨éƒ¨ä½œåºŸæ¸…ç©ºï¼Œç©ºæ³¡å½¢æˆã€‚æŒ‰æ¯ä¸€çº§1å‘¨æœŸç®—çš„è¯ï¼Œå°±æµªè´¹äº†4ä¸ªå‘¨æœŸã€‚&lt;/p>
&lt;p>åœ¨&lt;code>sum_counter&lt;/code>ä¸­ï¼Œå¯¹(5)å–æŒ‡æ—¶ï¼Œ(1)å·²ç»å†™å›ã€‚(4)ä¾èµ–çš„å¯„å­˜å™¨æ•°æ®å°±ç»ªï¼Œç«‹åˆ»å°±èƒ½ç¡®å®šåˆ†æ”¯é¢„æµ‹ç»“æœæ­£ç¡®ä¸å¦ï¼Œæ²¡æœ‰æµªè´¹æ—¶é’Ÿå‘¨æœŸã€‚&lt;/p>
&lt;p>â€”â€”ä»¥ä¸Šéƒ½æ˜¯æƒ³è±¡ä¸­çš„ CPU ï¼Œæƒ³è±¡ä¸­çš„æµæ°´çº¿ï¼Œå®é™…ä¸Šçš„æµæ°´çº¿åœ¨å“ªä¸ªé˜¶æ®µæ‰èƒ½å‘ç°åˆ†æ”¯é¢„æµ‹é”™è¯¯ï¼Œæ¸…ç©ºæµæ°´çº¿ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“ã€‚è¿™é‡Œèƒ½æå‡ºçš„ä¸€ä¸ªè®ºç‚¹å°±æ˜¯ï¼šå°½æ—©è®©åˆ†æ”¯ä¾èµ–çš„æ•°æ®å°±ç»ªï¼Œå°½å¿«è®© CPU å‘ç°é¢„æµ‹ç»“æœä¸æ­£ç¡®ï¼Œ&lt;strong>å¯èƒ½å¯ä»¥&lt;/strong>é™ä½åˆ†æ”¯é¢„æµ‹å¤±è´¥çš„æŸå¤±ã€‚è¯ä¸èƒ½è¯´æ»¡ã€‚è€Œä¸”é’ˆå¯¹åˆ†æ”¯é¢„æµ‹å™¨åšä¼˜åŒ–ä¸å€¼å¾—ï¼ŒIgor Ostrvsky çš„åšå®¢å‰è½¦ä¹‹é‰´åœ¨é‚£é‡Œï¼Œè¿‡å‡ å¹´æ–°æ¶æ„ CPU åˆ†æ”¯é¢„æµ‹å™¨è¯´ä¸å®šå°±ä¸æ˜¯è¿™ä¸ªè§„å¾‹äº†ä¹Ÿä¸ä¸€å®šã€‚&lt;/p>
&lt;h2 id="åˆ†æ”¯é¢„æµ‹å¯¹å®‰å…¨çš„å½±å“">åˆ†æ”¯é¢„æµ‹å¯¹å®‰å…¨çš„å½±å“&lt;/h2>
&lt;h3 id="spectre">spectre&lt;/h3>
&lt;p>ä¹Ÿè®¸æœ‰äººä¼šæƒ³CPUå’Œå®‰å…¨æœ‰ä»€ä¹ˆå…³ç³»ï¼Œè¿™ä¸æ˜¯æç¬‘å—ã€‚ä½†å®é™…ä¸Šå¯¹ CPU æ¼æ´çš„åˆ©ç”¨æ—©å·²æœ‰ä¹‹ï¼Œå¯¹ç°ä»£ CPU é«˜æ•ˆè¿è¡Œçš„é‡è¦ç‰¹æ€§ï¼šç¼“å­˜ã€ä¹±åºæ‰§è¡Œã€åˆ†æ”¯é¢„æµ‹è¿›è¡Œæ”»å‡»ã€‚è¿‘äº›å¹´æœ€è‘—åçš„å°±æœ‰ &lt;a class="link" href="https://meltdownattack.com/meltdown.pdf" target="_blank" rel="noopener"
>Meltdown&lt;/a> å’Œ &lt;a class="link" href="https://spectreattack.com/spectre.pdf" target="_blank" rel="noopener"
>Spectre&lt;/a> ã€‚&lt;/p>
&lt;p>åœ¨ &lt;a class="link" href="https://spectreattack.com/spectre.pdf" target="_blank" rel="noopener"
>Spectre Attacks: Exploiting Speculative Execution&lt;/a> è®ºæ–‡é‡Œè¿™æ ·å†™é“ï¼š&lt;/p>
&lt;blockquote>
&lt;p>Modern processors use branch prediction and speculative execution to maximize performance. For example, if the destination of a branch depends on a memory value that is in the process of being read, CPUs will try to guess the destination and attempt to execute ahead. When the memory value finally arrives, the CPU either discards or commits the speculative computation. Speculative logic is unfaithful in how it executes, can access the victimâ€™s memory and registers, and can perform operations with measurable side effects.&lt;/p>
&lt;/blockquote>
&lt;p>ç°ä»£å¤„ç†å™¨ä½¿ç”¨åˆ†æ”¯é¢„æµ‹å’Œæ¨æµ‹æ‰§è¡Œæ¥æœ€å¤§åŒ–æ€§èƒ½ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœç¡®å®šç›®æ ‡åˆ†æ”¯ä¾èµ–äºè¯»å–å†…å­˜é‡Œçš„å€¼ï¼ŒCPUä¼šåœ¨æ‰§è¡Œå‰çŒœæµ‹å…¶ç›®æ ‡ã€‚å½“å†…å­˜é‡Œçš„å€¼æŠµè¾¾CPUï¼ŒCPUè¦ä¹ˆæŠ›å¼ƒï¼Œè¦ä¹ˆæäº¤æ¨æµ‹æ‰§è¡Œçš„ç»“æœã€‚è€Œæ¨æµ‹æ‰§è¡Œçš„é€»è¾‘æ˜¯ä¸å®‰å…¨çš„ï¼Œå¯èƒ½è®¿é—®åˆ°å—å®³ç¨‹åºçš„å†…å­˜å’Œå¯„å­˜å™¨ï¼Œæ‰§è¡Œæœ‰æ˜æ˜¾å‰¯ä½œç”¨çš„æ“ä½œã€‚&lt;/p>
&lt;p>Meltdown å’Œ Spectre çš„åˆ©ç”¨æ–¹å¼å¾ˆç±»ä¼¼ï¼Œåˆ©ç”¨ä¹±åºæ‰§è¡Œæˆ–åˆ†æ”¯é¢„æµ‹è®© CPU åŠ è½½ä¸€å—ä¸å±äºè‡ªå·±çš„å†…å­˜åˆ°ç¼“å­˜ï¼Œè€Œ CPU å‘ç°åˆ†æ”¯é¢„æµ‹å¤±è´¥æˆ–ä¹±åºæ‰§è¡Œæ— æ•ˆæ—¶ï¼Œå¹¶ä¸ä¼šæŠ›å¼ƒè¿™å—ç¼“å­˜ã€‚ä¹‹åå†é€šè¿‡ç¬æ€æŒ‡ä»¤åˆ›å»ºä¸€ä¸ªæ—è·¯ï¼Œå–å¾—ç¼“å­˜é‡Œçš„æ•°æ®ï¼Œå°±æˆåŠŸåˆ©ç”¨CPUç»•å¼€äº†éš”ç¦»æœºåˆ¶ï¼Œéæ³•è¯»å–åˆ°äº†ä»»æ„ä¸€å—å†…å­˜ã€‚&lt;/p>
&lt;p>&lt;a class="link" href="https://razorpay.com/blog/meltdown-paper-summary/" target="_blank" rel="noopener"
>meltdown paper summary&lt;/a> å¯ä»¥è¯»ä¸€ä¸‹ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>å°±æ˜¯èŠå¤©ï¼Œæˆ‘ä¹Ÿä¸æ•¢è¯´å†™å¾—æœ‰å¤šå°‘å¯¹ï¼Œå†™åšå®¢çš„è¿‡ç¨‹é‡Œä¸œæŸ¥è¥¿æ‰¾ï¼Œæœ€åå†™å®Œæœ‰ä¸ªåŸºæœ¬æ˜ åƒå°±å¾ˆå¼€å¿ƒäº†ã€‚&lt;/p>
&lt;p>åˆ†æ”¯é¢„æµ‹å¯¹æ€§èƒ½æœ‰å½±å“ï¼Œæ¯”èµ· cache line çš„å½±å“æ›´å°ï¼Œè€Œä¸”ä¼˜åŒ–ä»·å€¼ä¸å¤§ï¼Œç‰¹æ„åšä¼˜åŒ–åè€Œå¯èƒ½åœ¨æœªæ¥ç ¸è‡ªå·±è„šè¶¾å¤´ã€‚ä½†åˆ†æ”¯é¢„æµ‹åˆç¡®å®åœ¨ç°ä»£cpué‡Œèµ·åˆ°äº†ç›¸å½“é‡è¦çš„ä½œç”¨ï¼Œæµæ°´çº¿é€ å¾—å†é•¿ï¼Œåˆ†æ”¯é¢„æµ‹æ¬¡æ¬¡éƒ½é”™ï¼Œé‚£å†é•¿çš„æµæ°´çº¿ä¹Ÿå’Œå•å‘¨æœŸæ²¡å•¥åŒºåˆ«ã€‚&lt;/p>
&lt;p>è¿™ç¯‡æ„Ÿè§‰æ²¡å•¥å¥½æ€»ç»“çš„ï¼Œåæ­£å†™å®Œæ˜¯å¯¹è®¡ç®—æœºäº†è§£æ›´æ·±äº†ä¸€ç‚¹å°±å¯¹å•¦ã€‚&lt;/p></description></item><item><title>CPUç¼“å­˜ã€ç¼ºé¡µå’Œä¼ªå…±äº«</title><link>https://nnnewb.github.io/blog/p/cpu-cache-page-fault-and-false-sharing/</link><pubDate>Tue, 15 Feb 2022 17:11:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/cpu-cache-page-fault-and-false-sharing/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>çœ‹Bæ ‘çš„æ—¶å€™å‘ç°å¯¹ç¼“å­˜è¿˜æ˜¯ä¸å¤Ÿäº†è§£ï¼Œä½† cache line åˆå¾ˆç¥å¥‡ã€‚è¦æ˜¯æœ‰äº›æ¯”è¾ƒåƒCPUçš„ä»£ç æ”¹ä¸€ä¸‹ç»“æ„å’Œè®¿é—®æ–¹å¼å•¥çš„å°±èƒ½ç™½å«–ä¸ª50%æ€§èƒ½æå‡é‚£å²‚ä¸æ˜¯ç¾å“‰ã€‚ç»“åˆä¸‹é¢çš„å‚è€ƒæ–‡ç« å¤§æ¦‚èŠä¸€ä¸‹ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;a class="link" href="http://igoro.com/archive/gallery-of-processor-cache-effects/" target="_blank" rel="noopener"
>Gallery of Processor Cache Effects&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="ç¼“å­˜è¡Œ">ç¼“å­˜è¡Œ&lt;/h2>
&lt;h3 id="ä»‹ç»">ä»‹ç»&lt;/h3>
&lt;p>é¦–å…ˆï¼Œç¼“å­˜è¡Œ&lt;strong>ä¸æ˜¯&lt;/strong>â€œè¡Œâ€ï¼Œè¿™æ˜¯å¯¹ &lt;em>cache line&lt;/em> çš„ç›´è¯‘ï¼Œ&lt;em>cache line&lt;/em> å’Œ &lt;em>cache block&lt;/em> æ˜¯åŒä¹‰çš„ï¼Œå¿½ç•¥è¿™ä¸ªâ€œè¡Œâ€å­—å³å¯ã€‚&lt;/p>
&lt;p>cache line æŒ‡çš„æ˜¯ CPU é«˜é€Ÿç¼“å­˜ï¼ˆL1~L3ï¼‰ä¸­çš„ä¸€ä¸ªç¼“å­˜å—ï¼Œé€šå¸¸å¤§å°åœ¨ 32/64/128 bytes ï¼Œç°åœ¨å¸¸è§çš„åº”è¯¥æ˜¯ 64 bytes ã€‚cache line ä¹‹æ‰€ä»¥é‡è¦ï¼Œæ˜¯å› ä¸ºè¿™æ˜¯ CPU è®¿é—®ä¸»å­˜çš„å¿…ç»ä¹‹è·¯ï¼Œé¢‘ç¹è®¿é—®ä¸»å­˜æ•°æ®çš„åœºåˆï¼Œæˆ–è€…å¹¶å‘ç¼–ç¨‹æ—¶ï¼Œcache line çš„å½±å“è¿˜æ˜¯ä¸å®¹å¿½è§†çš„ã€‚&lt;/p>
&lt;h3 id="ç®€å•çš„åŸºå‡†æµ‹è¯•">ç®€å•çš„åŸºå‡†æµ‹è¯•&lt;/h3>
&lt;p>å…‰æ˜¯è¯´ cache line å¤šé‡è¦æ²¡æœ‰åµç”¨ï¼Œå†™ä¸ª demo çœ‹çœ‹ cache line çš„å½±å“æ›´ç›´è§‚ã€‚æ¥ä¸€ä¸ªæœ€ç®€å•ä¸è¿‡çš„å•é“¾è¡¨éå†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;chrono&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;cstddef&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;functional&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;iostream&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;iterator&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;ostream&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;string&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="k">using&lt;/span> &lt;span class="k">namespace&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">using&lt;/span> &lt;span class="k">namespace&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">chrono&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">typedef&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="nc">_data&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">struct&lt;/span> &lt;span class="nc">_data&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">next&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="n">mydata&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">time_it&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">string&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">function&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">fn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">start&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">system_clock&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">now&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="n">fn&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">stop&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">system_clock&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">now&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="n">cout&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">name&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34;: &amp;#34;&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">duration_cast&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">milliseconds&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stop&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">start&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34;ms&amp;#34;&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">endl&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ä¸€æ¬¡åˆ†é…ï¼Œå†…å­˜è¿ç»­
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">auto&lt;/span> &lt;span class="n">list1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">mydata&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1024&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">1024&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">64&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">cur&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">list1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">1024&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">1024&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">64&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">cur&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">next&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">list1&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="n">cur&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">cur&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">next&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">list1&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1024&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">1024&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">next&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// åˆ†åˆ«åˆ†é…ï¼Œå†…å­˜ä¸è¿ç»­
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">auto&lt;/span> &lt;span class="n">list2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">mydata&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">cur2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">list2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">1024&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">1024&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">64&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">cur2&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">next&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">mydata&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="n">cur2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">cur2&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">next&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// éå†è¿ç»­çš„é“¾è¡¨
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">time_it&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;first&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="p">]()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">auto&lt;/span> &lt;span class="n">ptr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">list1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">ptr&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">ptr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ptr&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">next&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">ptr&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">*=&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">});&lt;/span>
&lt;span class="c1">// éå†ä¸è¿ç»­çš„é“¾è¡¨
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">time_it&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;second&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="p">]()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">auto&lt;/span> &lt;span class="n">ptr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">list2&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">ptr&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">ptr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ptr&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">next&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">ptr&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">*=&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">});&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸ºäº†ä½“ç°å‡ºå·®å¼‚ï¼Œä¸€å…±éå†äº† &lt;code>1024*1024*64&lt;/code>ä¸ªå…ƒç´ ï¼Œæ¯ä¸ªå…ƒç´  8 ä¸ªå­—èŠ‚ï¼Œä¸€å…±æ˜¯512Mæ•°æ®ã€‚&lt;/p>
&lt;p>ç»“æœå¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">weakptr î‚° æ•°æ®ç»“æ„ î‚° â™¥ 09:42 î‚° clang++.exe -m32 -O2 main.cpp -o main.exe
î‚¶weakptr î‚° æ•°æ®ç»“æ„ î‚° â™¥ 09:43 î‚° ./main.exe
first: 2ms
second: 239ms
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ç”¨äº†&lt;code>O2&lt;/code>çº§åˆ«ä¼˜åŒ–çš„æƒ…å†µä¸‹ï¼Œéå†è¿ç»­åˆ†é…å’Œä¸è¿ç»­åˆ†é…çš„é“¾è¡¨æ—¶ï¼Œé€Ÿåº¦ç›¸å·®è¾¾åˆ°äº†æƒŠäººçš„ä¸€ç™¾å¤šå€ã€‚&lt;/p>
&lt;p>æ˜¯&lt;code>O2&lt;/code>ä¼˜åŒ–æ‰äº†ç¬¬ä¸€ç§è¿ç»­åˆ†é…çš„é“¾è¡¨éå†å—ï¼Ÿ&lt;code>-O0&lt;/code> ç¦æ­¢ä¼˜åŒ–çœ‹çœ‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">î‚¶weakptr î‚° æ•°æ®ç»“æ„ î‚° â™¥ 09:44 î‚° clang++.exe -m32 -O0 main.cpp -o main.exe
î‚¶weakptr î‚° æ•°æ®ç»“æ„ î‚° â™¥ 09:45 î‚° ./main.exe
first: 3ms
second: 262ms
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¹¶æ²¡æœ‰ä»»ä½•æ”¹å–„ã€‚&lt;/p>
&lt;p>å› ä¸ºè€ƒè™‘æ˜¯å’Œå†…å­˜ç›¸å…³ï¼Œå½±å“å†…å­˜è®¿é—®æ€§èƒ½çš„å› ç´ å¯ä»¥å¾ˆè‡ªç„¶æƒ³åˆ°ç¼“å­˜å’Œç¼ºé¡µè¿™ä¸¤æ¡ã€‚&lt;/p>
&lt;p>ç¼“å­˜æŒ‡çš„æ˜¯ cache lineï¼Œä¸€èˆ¬è¯´ false sharing çš„æ—¶å€™æåŠ  padding å¯¹é½æ¯”è¾ƒå¤šã€‚å¦ä¸€ä¸ªæƒ…å†µå°±æ˜¯éå†çš„æ—¶å€™ï¼Œå¦‚æœæ•°æ®æ¯”è¾ƒå¯†é›†ï¼Œé‚£ä»ä¸»å­˜åˆ·æ–° cache line å°±ä¼šæ›´å°‘ï¼Œç¼“å­˜åˆ©ç”¨æ›´å……åˆ†ã€‚æ‰€ä»¥åƒæ˜¯æ•°ç»„è¿™æ ·çš„è¿ç»­å†…å­˜éå†é€Ÿåº¦é€šå¸¸è¿œæ¯”é“¾è¡¨ä¹‹ç±»çš„ç»“æ„å¿«ã€‚&lt;/p>
&lt;p>ç¼ºé¡µåˆæ˜¯å¦ä¸€ä¸ªé—®é¢˜ï¼Œç¼ºé¡µå¼‚å¸¸å‘ç”Ÿçš„å‡ ä¸ªå¸¸è§åœºæ™¯åŒ…æ‹¬ï¼šç¬¬ä¸€æ¬¡è®¿é—®åˆ†é…å¥½çš„å†…å­˜ï¼Œè®¿é—®è¢«äº¤æ¢åˆ°ç¡¬ç›˜ä¸Šçš„å†…å­˜ï¼Œ&lt;code>mmap&lt;/code> ï¼Œä»¥åŠ&lt;code>SIGSEGV&lt;/code>ç­‰æƒ…å†µã€‚ä¸€èˆ¬æ¥è¯´çš„è¯ï¼Œè¿ç»­çš„å†…å­˜åˆ†é…ä¸‹ä¸€æ¬¡ç¼ºé¡µå¯ä»¥å¾—åˆ°è¿ç»­çš„Nä¸ªå…ƒç´ ï¼Œä¸è¿ç»­çš„åˆ†é…ç¬¬ä¸€æ¬¡è®¿é—®Nä¸ªå…ƒç´ ï¼Œæœ€åçš„æƒ…å†µä¸‹å¯èƒ½å°±è¦Næ¬¡ç¼ºé¡µå¼‚å¸¸ã€‚&lt;/p>
&lt;h3 id="ç¼ºé¡µå¼‚å¸¸">ç¼ºé¡µå¼‚å¸¸&lt;/h3>
&lt;p>å…ˆçœ‹ç¼ºé¡µã€‚è¿™é‡Œä½¿ç”¨å¾®è½¯çš„ Process Explorer æ¥è§‚å¯Ÿ Page Fault çš„å‡ºç°æƒ…å†µã€‚ä¸ºäº†æœ‰æ•ˆè§‚å¯Ÿåˆ°page faultå‘ç”Ÿï¼Œæˆ‘ä¿®æ”¹äº†ä¸€ä¸‹ä»£ç ï¼Œåœ¨ &lt;code>time_it&lt;/code> å‡½æ•°é‡Œæ·»åŠ ä¸Šäº†ç®€å•çš„ page fault è§‚æµ‹ã€‚&lt;/p>
&lt;p>&lt;em>æç¤ºï¼Œä¹Ÿå¯ä»¥ç”¨ Process Explorer ç­‰å·¥å…·è§‚æµ‹ç¨‹åºè¿è¡Œæ—¶çš„ Page Fault æ•°é‡ï¼Œä½†ç›´æ¥åœ¨ä»£ç é‡ŒåµŒå…¥è§‚æµ‹è¿˜æ˜¯æœ€å‡†ç¡®çš„ã€‚å¦‚æœæœ‰æ›´å¥½ç”¨çš„æ€§èƒ½åˆ†æå·¥å…·çš„è¯å½“ç„¶æ›´å¥½ã€‚&lt;/em>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="n">DWORD&lt;/span> &lt;span class="nf">getPageFaultCount&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">proc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">GetCurrentProcess&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="n">PROCESS_MEMORY_COUNTERS&lt;/span> &lt;span class="n">counters&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">GetProcessMemoryInfo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">proc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">counters&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">counters&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">FALSE&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">cerr&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34;GetProcessMemoryInfo failed, error &amp;#34;&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">GetLastError&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">endl&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">counters&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">PageFaultCount&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">time_it&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="n">string&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">function&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">fn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">before&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">getPageFaultCount&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">start&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">system_clock&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">now&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="n">fn&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">stop&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">system_clock&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">now&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">after&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">getPageFaultCount&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="n">cout&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">name&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34;: &amp;#34;&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">duration_cast&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">milliseconds&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stop&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">start&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34;ms, page fault count: &amp;#34;&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">after&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">before&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">endl&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶åå¯¹ä¸¤ä¸ªç”¨ä¾‹è¿›è¡Œæµ‹è¯•ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">initialization-1: 337ms, page fault count: 131329
initialization-2: 3591ms, page fault count: 265660
iteration-1: 3ms, page fault count: 0
iteration-2: 294ms, page fault count: 0
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°ï¼Œåœ¨é“¾è¡¨çš„åˆå§‹åŒ–é˜¶æ®µï¼Œéè¿ç»­åˆ†é…çš„é“¾è¡¨äº§ç”Ÿäº†è¿ç»­åˆ†é…çš„é“¾è¡¨å·®ä¸å¤šä¸¤å€çš„ page faultï¼Œè€—æ—¶æ¥è¿‘åå€â€”â€”æˆ‘è¿˜å¾—æ¾„æ¸…ä¸€ä¸‹è¿™ä¸æ˜¯åœ¨æš—ç¤ºåå€çš„è€—æ—¶éƒ½æ˜¯ page fault é€ æˆçš„ï¼Œä½† page fault åœ¨å…¶ä¸­ä¹Ÿæ¶ˆè€—äº†ä¸€éƒ¨åˆ†èµ„æºæ€»å½’æ˜¯æ¯«æ— ç–‘é—®çš„ã€‚&lt;/p>
&lt;p>ä½†éšåçš„è¿­ä»£é˜¶æ®µé‡Œå¹¶æ²¡æœ‰æ–°çš„ page fault äº§ç”Ÿï¼Œå› ä¸º ä¸¤æ¬¡ 512M çš„åˆ†é…å†åŠ ä¸Šå¾ªç¯newï¼Œå †ç»´æŠ¤æŒ‡é’ˆçš„å¼€é”€ï¼Œå·®ä¸å¤š1.5Gï¼Œè¿˜æ²¡æœ‰è€—å°½å¯ç”¨å†…å­˜ã€‚&lt;/p>
&lt;p>æ’é™¤ page fault çš„å½±å“åï¼Œç°åœ¨è€ƒè™‘å¦ä¸€ä¸ªå½±å“å› ç´ ï¼šç¼“å­˜ã€‚&lt;/p>
&lt;h3 id="ç¼“å­˜è¡Œ-1">ç¼“å­˜è¡Œ&lt;/h3>
&lt;p>å…³äºç¼“å­˜çš„åˆ†æè¿™é‡Œä½¿ç”¨äº† Intel VTune Profiler ä½œä¸ºåˆ†æå·¥å…·ï¼Œæ¥æå–ç¼“å­˜å‘½ä¸­æƒ…å†µã€‚ä¸ºäº†è®©VTuneæŠ“å–æ›´å¤šä¿¡æ¯æ¥åˆ†æï¼Œå¯¹benchmarkä»£ç å†æ¬¡ä¿®æ”¹ï¼Œéå†ä¸€æ¬¡æ”¹æˆéå†100æ¬¡ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">time_it&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;iteration-2&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">list2&lt;/span>&lt;span class="p">]()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">auto&lt;/span> &lt;span class="n">ptr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">list2&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">ptr&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">ptr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ptr&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">next&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">ptr&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">*=&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">});&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¹¶å°†è¿ç»­å†…å­˜åˆ†é…å’Œä¸è¿ç»­åˆ†é…åˆ†æˆ&lt;code>benchmark1.cpp&lt;/code>å’Œ&lt;code>benchmark2.cpp&lt;/code>ï¼Œåˆ†åˆ«ç”¨&lt;code>-m32 -O0 -g&lt;/code> å‚æ•°ç¼–è¯‘ï¼Œæ”¾è¿› VTune åˆ†æå†…å­˜è®¿é—®æ€§èƒ½ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 152;
flex-basis: 366px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215141503328.png" data-size="507x332">
&lt;img src="https://nnnewb.github.io/blog/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215141503328.png"
width="507"
height="332"
srcset="https://nnnewb.github.io/blog/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215141503328_hu3571708b5c5bc5793cda86111950dfc6_32684_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215141503328_hu3571708b5c5bc5793cda86111950dfc6_32684_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="benchmark1">
&lt;/a>
&lt;figcaption>benchmark1&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 162;
flex-basis: 388px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215141525825.png" data-size="551x340">
&lt;img src="https://nnnewb.github.io/blog/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215141525825.png"
width="551"
height="340"
srcset="https://nnnewb.github.io/blog/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215141525825_hu652bea774cd469a5f99b0baeb69059e1_36904_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215141525825_hu652bea774cd469a5f99b0baeb69059e1_36904_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="benchmark2">
&lt;/a>
&lt;figcaption>benchmark2&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>è§‚å¯Ÿå›¾ä¸­çš„ LLC Miss Count å¯ä»¥å‘ç°ï¼ŒBenchmark2 çš„ç¼“å­˜æœªå‘½ä¸­æ¬¡æ•°è¿œå¤§äº benchmark1 ï¼Œå¹³å‡æ—¶å»¶ Average Latency é«˜å‡º 13 ä¸ªcycles ã€‚è¿™å¦‚ä½•å½±å“æ€§èƒ½å‘¢ï¼Ÿç»§ç»­è§‚å¯Ÿä¸‹å›¾ Bottom-up ä¸­çš„åˆ†æã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 1288;
flex-basis: 3092px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215141832599.png" data-size="1559x121">
&lt;img src="https://nnnewb.github.io/blog/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215141832599.png"
width="1559"
height="121"
srcset="https://nnnewb.github.io/blog/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215141832599_huaeb1369d8df5f047d5d55e74be805100_32485_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215141832599_huaeb1369d8df5f047d5d55e74be805100_32485_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="benchmark1">
&lt;/a>
&lt;figcaption>benchmark1&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 1716;
flex-basis: 4119px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215141933956.png" data-size="1562x91">
&lt;img src="https://nnnewb.github.io/blog/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215141933956.png"
width="1562"
height="91"
srcset="https://nnnewb.github.io/blog/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215141933956_hu1b3074ff876521e620d7b28b0f9399ed_27911_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215141933956_hu1b3074ff876521e620d7b28b0f9399ed_27911_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="benchmark2">
&lt;/a>
&lt;figcaption>benchmark2&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>èƒ½å‘ç°ï¼Œåœ¨benchmark1ï¼ˆè¿ç»­åˆ†é…é“¾è¡¨éå†æµ‹è¯•ï¼‰ä¸­ï¼Œåˆå§‹åŒ–è€—æ—¶å’Œéå†è€—æ—¶ç›¸ä»¿ï¼Œéƒ½åœ¨300mså·¦å³ã€‚åˆå§‹åŒ–è€—æ—¶å¯èƒ½ä¸»è¦æ¥è‡ªç¼ºé¡µï¼Œæ¯æ¬¡éå†æ•´ä¸ªé“¾è¡¨ä»…3mså·¦å³ï¼ŒLLC Miss Count ä¸º 0ã€‚è¿™è¯´æ˜ç¼“å­˜å®Œç¾åœ°å‘æŒ¥äº†ä½œç”¨ã€‚&lt;/p>
&lt;p>åœ¨ benchmark2 ï¼ˆå¾ªç¯åˆ†é…èŠ‚ç‚¹ï¼Œä¸è¿ç»­ï¼‰ä¸­ï¼Œåˆå§‹åŒ–è€—æ—¶1.4ç§’ï¼Œ100æ¬¡éå†è€—æ—¶26.461ç§’ï¼Œè€Œä¸”æ³¨æ„ï¼ŒLLC Miss Count é«˜è¾¾ 47,603,332 ã€‚å°†è¿™ä¸ªæ•°å­—é™¤ä»¥å¾ªç¯æ¬¡æ•°ï¼Œå¤§çº¦ç­‰äºæ¯ä¸ªèŠ‚ç‚¹è®¿é—®éƒ½ä¼šäº§ç”Ÿ 0.7 ä¸ª LLC Miss ã€‚&lt;/p>
&lt;p>ä¸ºä»€ä¹ˆä¼šå‘ç”Ÿè¿™ç§äº‹ï¼Ÿ&lt;/p>
&lt;p>benchmark1 ä¸€æ¬¡ new å‡ºè¿ç»­çš„ &lt;code>1024 * 1024 * 64&lt;/code> ä¸ªå…ƒç´ ï¼Œæ¯ä¸ªå…ƒç´  8 ä¸ªå­—èŠ‚ï¼Œè¿ç»­æ’åˆ—ï¼Œè€Œä¸”æ„é€ é“¾è¡¨æ—¶æ˜¯æŒ‰é¡ºåºå¤´å°¾ç›¸è¿çš„ã€‚æ‰€ä»¥éå† benchmark1 çš„é“¾è¡¨æ—¶ï¼Œå¡«å……å¥½çš„ cache line (è®¾ä¸º 64å­—èŠ‚)ä¸€å…±æœ‰8ä¸ªé“¾è¡¨å…ƒç´ ä¸”è¿ç»­ï¼Œé¢„å–æœºåˆ¶åŒæ—¶æ‹¿äº†ä¸‹ä¸€ä¸ª cache line ï¼Œå› æ­¤ CPU å‡ ä¹ä¸ç”¨å‚»ç­‰ä¸»å­˜ç»™æ•°æ®ï¼Œåªéœ€è¦ä¸æ–­ä¸€ä¸ª cache line æ¥ä¸€ä¸ª cache line è¯»å†™å³å¯ï¼Œæ•ˆç‡æé«˜ã€‚&lt;/p>
&lt;p>è€Œ benchmark2 ç›¸åï¼Œå› ä¸ºé“¾è¡¨ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ç‹¬ç«‹åˆ†é…çš„ï¼Œä¾æ® allocator ç®—æ³•ä¸åŒè¡¨ç°ä¼šæœ‰åŒºåˆ«ï¼Œä½†æ¯”è¾ƒæ˜ç¡®çš„æ˜¯å…ƒç´ ä¸å¤§å¯èƒ½æ˜¯åœ¨å†…å­˜ä¸­è¿ç»­åˆ†é…ã€‚åœ¨éå†é“¾è¡¨æ—¶ï¼Œå–ä¸‹ä¸€ä¸ªé“¾è¡¨å…ƒç´  &lt;code>cur=cur-&amp;gt;next &lt;/code> åï¼Œ&lt;code>cur&lt;/code> æŒ‡å‘çš„åœ°å€å¤§æ¦‚ç‡å¹¶ä¸åœ¨å·²ç¼“å­˜çš„ cache line ä¸­ï¼Œå› æ­¤æ¯æ¬¡å¾ªç¯é‡Œ CPU éƒ½ä¸å¾—ä¸ä»ä¸»å­˜å–æ•°ã€‚å¯æ˜¯ä¸»å­˜å–æ•°æ˜¯L1/L2 ç¼“å­˜å–æ•°è€—æ—¶çš„æˆç™¾ä¸Šåƒå€ï¼Œæ•ˆç‡æä½ã€‚&lt;/p>
&lt;h3 id="ä¼ªå…±äº«">ä¼ªå…±äº«&lt;/h3>
&lt;p>ç»§ç»­ä¹‹å‰å†è¯´è¯´ä¼ªå…±äº«ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;cstddef&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;iostream&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;thread&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;functional&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;chrono&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="k">using&lt;/span> &lt;span class="k">namespace&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">using&lt;/span> &lt;span class="k">namespace&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">chrono&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">time_it&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="n">string&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">function&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">fn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">start&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">system_clock&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">now&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="n">fn&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">stop&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">system_clock&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">now&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="n">cout&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">name&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34;: &amp;#34;&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">duration_cast&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">milliseconds&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stop&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">start&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34;ms&amp;#34;&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">endl&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">f&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">10000000&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">*&lt;/span>&lt;span class="n">data&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">time_it&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;iteration&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[]()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">b&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">c&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">d&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kr">thread&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">threads&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">new&lt;/span> &lt;span class="kr">thread&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="k">new&lt;/span> &lt;span class="kr">thread&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">b&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="k">new&lt;/span> &lt;span class="kr">thread&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="k">new&lt;/span> &lt;span class="kr">thread&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">d&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="p">};&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">auto&lt;/span> &lt;span class="nl">t&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">threads&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">t&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">});&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¾ç„¶æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„ benchmarkï¼Œè¾“å‡ºå¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">iteration: 172ms
iteration: 176ms
iteration: 181ms
iteration: 177ms
iteration: 182ms
iteration: 179ms
... ç•¥
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸€ä¸ªéå¸¸ç®€å•çš„æ“ä½œï¼Œ4çº¿ç¨‹æ— é”ï¼Œæ—  &lt;code>volatile&lt;/code> é€’å¢ä¸åŒçš„å››ä¸ªå˜é‡ï¼Œå‡ ä¹çœ‹ä¸å‡ºæœ‰ä»€ä¹ˆçº¦æŸå¯¼è‡´æ€§èƒ½ä½ä¸‹çš„é—®é¢˜ã€‚æˆ‘ä»¬é€šè¿‡ Intel VTune æ¥çœ‹çœ‹ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 196;
flex-basis: 471px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215163719690.png" data-size="1453x740">
&lt;img src="https://nnnewb.github.io/blog/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215163719690.png"
width="1453"
height="740"
srcset="https://nnnewb.github.io/blog/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215163719690_hu046c5a587cbc915571865660d4965e46_142205_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215163719690_hu046c5a587cbc915571865660d4965e46_142205_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="false sharing - intel VTune">
&lt;/a>
&lt;figcaption>false sharing - intel VTune&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 196;
flex-basis: 471px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215163847953.png" data-size="1453x740">
&lt;img src="https://nnnewb.github.io/blog/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215163847953.png"
width="1453"
height="740"
srcset="https://nnnewb.github.io/blog/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215163847953_hu63d8a1f13a9b918520d7739e38733940_101530_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215163847953_hu63d8a1f13a9b918520d7739e38733940_101530_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="stall">
&lt;/a>
&lt;figcaption>stall&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å¯ä»¥çœ‹åˆ°ï¼ŒVTune æç¤ºCPUèŠ±è´¹äº†å¤§é‡æ—¶é—´åœ¨å‚»ç­‰ cache line å†™å…¥ä¸»å­˜ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 1775;
flex-basis: 4261px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215164012789.png" data-size="1101x62">
&lt;img src="https://nnnewb.github.io/blog/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215164012789.png"
width="1101"
height="62"
srcset="https://nnnewb.github.io/blog/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215164012789_hua004026a68d2e492c13f4a22525e40fe_14051_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215164012789_hua004026a68d2e492c13f4a22525e40fe_14051_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="hot spot">
&lt;/a>
&lt;figcaption>hot spot&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å‡½æ•° f å‡ºç°äº†æµ·é‡çš„ loads/store æ“ä½œã€‚&lt;/p>
&lt;p>åœ¨å‰æ–‡ä¸­æˆ‘ä»¬èŠäº† cache line çš„ä½œç”¨ï¼Œè¿™é‡Œä¹Ÿèƒ½çœ‹åˆ° LLC Miss ä¸º 0ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆè¿è¡Œæ€§èƒ½ä¼šè¿™ä¹ˆå·®å‘¢ï¼Ÿ&lt;/p>
&lt;p>è¿™ä¸ªé—®é¢˜è¿˜å¾—å›åˆ° cache line ä¸Šã€‚åœ¨å¤šæ ¸ç³»ç»Ÿä¸­ï¼Œcache line è¿˜è¦æ±‚ &lt;strong>ä¸€è‡´æ€§&lt;/strong> ï¼Œä¸€æ—¦å†™ cache line ä¸­çš„ä»»æ„å­—èŠ‚ï¼Œéƒ½ä¼šè®© &lt;strong>æ•´ä¸ª&lt;/strong> cache line æ ‡è®°ä¸ºå¤±æ•ˆã€‚åœ¨åŸºå‡†æµ‹è¯•ä»£ç é‡Œï¼Œå››ä¸ª int å˜é‡è¢«è¿ç»­åˆ†é…åœ¨æ ˆä¸Šï¼Œä¹Ÿå°±æ˜¯è¯´ cache line ææœ‰å¯èƒ½å°†è¿™å››ä¸ªå˜é‡ä¸­çš„å¤šä¸ªä¿å­˜åœ¨åŒä¸€ cache line å†…ã€‚ä»»æ„ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†å…¶ä¸­ä¸€ä¸ªå˜é‡ï¼Œéƒ½ä¼šå¯¼è‡´ cache line è¢«æ ‡ä¸ºå¤±æ•ˆï¼Œå…¶ä»–çº¿ç¨‹æˆ–æ ¸å¿ƒæƒ³è¦è®¿é—®è¿™å››ä¸ªå˜é‡ä¹‹ä¸€éƒ½ä¸å¾—ä¸ä»ä¸»å­˜é‡æ–°å–æ•°ã€‚&lt;/p>
&lt;p>è¿™ä¹ˆåšçš„åŸå› æ˜¯ä¸ºäº†ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚CPU0 ä¿®æ”¹äº† cache line ä¸­çš„æ•°æ®ï¼Œè¿˜æ²¡æœ‰å†™å›ä¸»å­˜ï¼Œå…¶ä»– CPU éƒ½ä¸æ¸…æ¥š CPU0 åšäº†ä»€ä¹ˆä¿®æ”¹ï¼Œåªèƒ½ç­‰å¾… CPU0 å†™å›ä¸»å­˜ï¼ˆæˆ–è€…L3ï¼‰ï¼Œå†é‡æ–°ä»ä¸»å­˜ï¼ˆæˆ–L3ï¼‰å–æ•°ã€‚ä½†æˆ‘ä»¬éƒ½çŸ¥é“aã€bã€cã€då¹¶ä¸æ˜¯å…±äº«çš„ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½åªè®¿é—®è‡ªå·±çš„é‚£ä¸ªå˜é‡ã€‚è¿™ç§é—®é¢˜è¢«ç§°ä½œ&lt;strong>ä¼ªå…±äº«&lt;/strong>ã€‚&lt;/p>
&lt;p>åœ¨ VTune ä¸­çš„è¡¨ç°ï¼Œå°±æ˜¯ä¸Šå›¾ä¸­æµ·é‡çš„ Loads/Stores æ“ä½œã€‚&lt;/p>
&lt;p>å¦‚ä½•è§£å†³å‘¢ï¼Ÿ&lt;/p>
&lt;p>å¾ˆç®€å•ï¼Œè®©æ¯ä¸ªçº¿ç¨‹è¦æ“ä½œçš„å˜é‡å¡«æ»¡æ•´ä¸ª cache lineï¼Œé˜²æ­¢å› ä¸ºcache line é‡Œæ··å…¥å’Œå…¶ä»–çº¿ç¨‹è¦ä¿®æ”¹çš„å˜é‡é€ æˆä¼ªå…±äº«ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="k">typedef&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kt">int8_t&lt;/span> &lt;span class="n">_before&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">60&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="kt">int32_t&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kt">int8_t&lt;/span> &lt;span class="n">_after&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">60&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">f&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">10000000&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">data&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">time_it&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;iteration&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[]()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">value&lt;/span> &lt;span class="n">a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="n">b&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="n">c&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="n">d&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">};&lt;/span>
&lt;span class="kr">thread&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">threads&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">new&lt;/span> &lt;span class="kr">thread&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="k">new&lt;/span> &lt;span class="kr">thread&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">b&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="k">new&lt;/span> &lt;span class="kr">thread&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="k">new&lt;/span> &lt;span class="kr">thread&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">d&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="p">};&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">auto&lt;/span> &lt;span class="nl">t&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">threads&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">t&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">});&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å°†åŸæœ¬çš„ int æ”¹æˆå‰åå„æœ‰ 60 å­—èŠ‚å¡«å……çš„ç»“æ„ï¼ˆå‰60å­—èŠ‚é˜²æ­¢ value æ··å…¥åˆ«äººçš„ cache lineï¼Œå60å­—èŠ‚é˜²æ­¢valueåçš„å˜é‡æ··å…¥cache lineï¼Œ124å­—èŠ‚ï¼Œå¯¹é½å128å­—èŠ‚ï¼‰ã€‚è¿™ä¸ªè§£å†³æ–¹æ³•æ˜¯å…¸å‹çš„ &lt;strong>ç”¨ç©ºé—´æ¢æ—¶é—´&lt;/strong> ã€‚å†æ¬¡è¿è¡ŒåŸºå‡†æµ‹è¯•ï¼Œå¯ä»¥çœ‹åˆ°è¿è¡Œæ—¶é—´ç¼©çŸ­äº†æ•°å€ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">iteration: 15ms
iteration: 21ms
iteration: 20ms
iteration: 18ms
iteration: 20ms
iteration: 22ms
iteration: 20ms
iteration: 19ms
iteration: 20ms
iteration: 20ms
... ç•¥
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="cache-line-åŸç†">cache line åŸç†&lt;/h3>
&lt;p>Intel åœ¨ 2016 å¹´å‘è¡¨çš„ä¸€ç¯‡æ–‡ç« ï¼Œ&lt;a class="link" href="https://www.intel.com/content/www/us/en/developer/articles/technical/how-memory-is-accessed.html" target="_blank" rel="noopener"
>How Memory Is Accessed&lt;/a>è¿™æ ·å†™é“ã€‚&lt;/p>
&lt;blockquote>
&lt;p>Programming modern computers rarely requires an understanding of underlying hardware and software; consequently, most programmers do not know how the memory subsystem works.&lt;/p>
&lt;p>However, such lack of knowledge can ultimately produce a 10x or worse slowdown in application performance â€“ especially since the arrival of &lt;a class="link" href="http://software.intel.com/en-us/articles/what-s-new-about-modern-hardware" target="_blank" rel="noopener"
>new hardware technologies&lt;/a>.&lt;/p>
&lt;p>&amp;hellip;&lt;/p>
&lt;p>The accesses propagating through the memory subsystem are a combination of a specific request and the needed physical addresses and, perhaps, data.&lt;/p>
&lt;p>Data moves around most of the memory subsystem in 64-byte quantities called &lt;em>cache lines&lt;/em>. A &lt;em>cache entry&lt;/em>, which is some transistors that can store a physical address and a cache line, is filled when a cache line is copied into it. Pages are evenly divided into cache lines â€“ the first 64 bytes of a 4096-byte page is a cache line, with the 64 bytes stored together in a cache entry; the next 64 bytes is the next cache line, etc.&lt;/p>
&lt;p>Each cache line may:&lt;/p>
&lt;ul>
&lt;li>Not be cached&lt;/li>
&lt;li>Occupy an entry in one cache&lt;/li>
&lt;li>Be duplicated in several caches&lt;/li>
&lt;/ul>
&lt;p>Cores, I/O devices, and other devices send requests to caches to either read or write a cache entry for a physical address. The lowest six bits of the physical address are not sent â€“ they are used by the core to select the bytes within the cache line. The core sends separate requests for each cache line it needs.&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Reads&lt;/strong> â€“ If a cache has the requested physical address in a cache entry, the cache returns the data. If not, the cache requests the data from deeper in the memory subsystem and evicts some cache entry to make room. If the evicted cache entry has been modified, it must be written to the deeper memory subsystem as part of this eviction. This means a stream of reads may slow down because an earlier set of writes must be pushed deeper into the memory subsystem. A small queue of written data buffers the communication from the sender to the receiver.&lt;/li>
&lt;li>&lt;strong>Writes&lt;/strong> â€“ If the cache does not have the cache line in a cache entry, the cache reads it from deeper in the memory subsystem. It evicts some other physical address from its cache entry to make room for this cache line. The read is necessary to get all the 64 bytes, because the write is probably changing only some of them. The first time a cache entry is written, the cache entries of this physical address in all other caches are invalidated. This action makes the first write on a cache entry more expensive than later writes.&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>CPUè®¿é—®ä¸»å­˜æ—¶å¹¶ä¸æ˜¯ç›´æ¥ä»ä¸»å­˜å–æ•°ï¼Œè€Œæ˜¯å…ˆè¯»å…¥é«˜é€Ÿç¼“å­˜ï¼Œä¹Ÿå°±æ˜¯åœ¨CPUçš„è§„æ ¼è¯´æ˜ä¸­æåˆ°çš„ L1/L2/L3 ç¼“å­˜ã€‚è€Œä¸”ï¼ŒCPUä¹Ÿä¸ä¼šå‚»ä¹ä¹åœ°åªä»ä¸»å­˜å–ä¸€ä¸ªå­—èŠ‚ã€4ä¸ªå­—èŠ‚æˆ–8ä¸ªå­—èŠ‚ï¼Œè€Œæ˜¯å–æ›´å¤šæ•°æ®æ”¾å…¥ç¼“å­˜ã€‚&lt;/p>
&lt;p>ä¸ºä»€ä¹ˆï¼Ÿå› ä¸º &lt;em>å±€éƒ¨æ€§åŸç†&lt;/em> ã€‚CPUè®¾è®¡è€…å‡è®¾ç¨‹åºè®¿é—®ä¸€ä¸ªåœ°å€ï¼Œåˆ™å¾ˆå¿«ä¹Ÿä¼šè®¿é—®è¿™ä¸ªåœ°å€é™„è¿‘çš„å…¶ä»–åœ°å€ã€‚&lt;/p>
&lt;p>è¿™å„¿æœ‰ä¸ªè¡¨æ ¼ &lt;em>Numbers everyone should know&lt;/em>ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext"> 0.5 ns - CPU L1 dCACHE reference
1 ns - speed-of-light (a photon) travel a 1 ft (30.5cm) distance
5 ns - CPU L1 iCACHE Branch mispredict
7 ns - CPU L2 CACHE reference
71 ns - CPU cross-QPI/NUMA best case on XEON E5-46*
100 ns - MUTEX lock/unlock
100 ns - own DDR MEMORY reference
135 ns - CPU cross-QPI/NUMA best case on XEON E7-*
202 ns - CPU cross-QPI/NUMA worst case on XEON E7-*
325 ns - CPU cross-QPI/NUMA worst case on XEON E5-46*
10,000 ns - Compress 1K bytes with Zippy PROCESS
20,000 ns - Send 2K bytes over 1 Gbps NETWORK
250,000 ns - Read 1 MB sequentially from MEMORY
500,000 ns - Round trip within a same DataCenter
10,000,000 ns - DISK seek
10,000,000 ns - Read 1 MB sequentially from NETWORK
30,000,000 ns - Read 1 MB sequentially from DISK
150,000,000 ns - Send a NETWORK packet CA -&amp;gt; Netherlands
| | | |
| | | ns|
| | us|
| ms|
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…·ä½“æ•°å­—ä¾èµ–äºå…·ä½“çš„ç¡¬ä»¶å¹³å°ï¼Œè¿™ä¸ªè¡¨æ ¼å¯ä»¥å¯¹è®¿é—®é€Ÿåº¦å»ºç«‹å¤§æ¦‚çš„æ˜ åƒã€‚å½“ L1/L2 ç¼“å­˜æœªå‘½ä¸­ï¼ŒCPUä¸å¾—ä¸ç»§ç»­å‘æ›´è¿œã€å»¶æ—¶æ›´é•¿çš„è®¾å¤‡å¯»æ±‚æ•°æ®ï¼Œæ¯ä¸ª LLC Miss éƒ½æ„å‘³ç€ CPU ä¸å¾—ä¸èŠ±ä¸Šæˆç™¾ä¸Šåƒå€çš„æ—¶é—´ç­‰å¾…å¡«å…… cache lineã€‚è€Œ LLC Miss å‡ºç°çš„é¢‘ç‡è¶Šé«˜ï¼Œåˆ™æ„å‘³ç€ CPU æ‰§è¡Œçš„æ•ˆç‡è¶Šä½â€”â€”ç»å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨ç­‰å¾…ä¸»å­˜çš„æ•°æ®ã€‚&lt;/p>
&lt;p>æ›´ç³Ÿç³•çš„æ˜¯ï¼Œæœ‰æ—¶å€™ CPU çœŸçš„å°±æ˜¯å‚»ç­‰(stall)ï¼Œä¸ä¸“é—¨åˆ†æç”šè‡³éƒ½ä¸çŸ¥é“ç¨‹åºæ ¹æœ¬æ²¡è·‘å‡ºåº”æœ‰çš„é€Ÿåº¦ã€‚&lt;/p>
&lt;blockquote>
&lt;p>Modern cores use both &lt;a class="link" href="https://en.wikipedia.org/wiki/Out-of-order_execution" target="_blank" rel="noopener"
>out-of-order execution&lt;/a> and &lt;a class="link" href="https://en.wikipedia.org/wiki/Hyper-threading" target="_blank" rel="noopener"
>hyperthreading&lt;/a> to find and to do something useful while other instructions wait for data to be fetched.&lt;/p>
&lt;p>If nothing useful can be done, the core stalls. Unfortunately, the OS is almost unaware of the stall: the application appears to be running, and it is hard to tell if the application is slower than it should be. You need tools to examine &lt;a class="link" href="https://en.wikipedia.org/wiki/Hardware_performance_counter" target="_blank" rel="noopener"
>hardware performance counters&lt;/a> to see stall details.&lt;/p>
&lt;/blockquote>
&lt;p>å›é¡¾åŸºå‡†æµ‹è¯•ä»£ç ï¼Œä»…ä»…æ˜¯è¿ç»­åˆ†é…å†…å­˜å°±å¯ä»¥è·å¾—ç™¾å€çš„æ€§èƒ½æ”¹å–„ï¼Œè¶…å€¼ã€‚&lt;/p>
&lt;p>å¼•ç”¨å‰æ–‡æ¥ç»™ cache line å°èŠ‚ç»“å°¾ï¼š&lt;/p>
&lt;blockquote>
&lt;p>However, such lack of knowledge can ultimately produce a 10x or worse slowdown in application performance â€“ especially since the arrival of &lt;a class="link" href="http://software.intel.com/en-us/articles/what-s-new-about-modern-hardware" target="_blank" rel="noopener"
>new hardware technologies&lt;/a>.&lt;/p>
&lt;/blockquote>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>ä»€ä¹ˆæ˜¯ cache lineï¼Ÿ&lt;/p>
&lt;blockquote>
&lt;p>Data moves around most of the memory subsystem in 64-byte quantities called &lt;em>cache lines&lt;/em>.&lt;/p>
&lt;/blockquote>
&lt;p>cache line å¦‚ä½•å½±å“æ€§èƒ½ï¼Ÿ&lt;/p></description></item><item><title>Bæ ‘</title><link>https://nnnewb.github.io/blog/p/b-tree/</link><pubDate>Mon, 14 Feb 2022 10:53:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/b-tree/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>Bæ ‘å’ŒBæ ‘çš„å˜ä½“ï¼ˆB+æ ‘ï¼‰å› ä¸ºå¯¹ç£ç›˜IO/ç¼“å­˜å‹å¥½çš„åŸå› ï¼Œå¸¸è¢«ç”¨åšæ•°æ®åº“ç´¢å¼•å’Œæ–‡ä»¶ç³»ç»Ÿçš„æ•°æ®ç»“æ„ã€‚&lt;/p>
&lt;p>è¿™ç¯‡åšå®¢ä¸»è¦æ˜¯å†™ä¸€ä¸‹Bæ ‘å¦‚ä½•æ’å…¥å’Œæœç´¢ï¼ŒèŠ‚ç‚¹åˆ†è£‚æœºåˆ¶ä»¥åŠå¦‚ä½•è‡ªå¹³è¡¡ã€‚&lt;/p>
&lt;h2 id="èŠ‚ç‚¹ç»“æ„">èŠ‚ç‚¹ç»“æ„&lt;/h2>
&lt;p>Bæ ‘å’Œä¸€èˆ¬çš„äºŒå‰æœç´¢æ ‘åœ¨èŠ‚ç‚¹ç»“æ„ä¸Šæœ‰å¾ˆå¤§åŒºåˆ«ã€‚Bæ ‘æ˜¯ä¸€ç§å¤šè·¯æœç´¢æ ‘ï¼ŒBæ ‘çš„èŠ‚ç‚¹å¯ä»¥æœ‰å¤šä¸ªåç»§èŠ‚ç‚¹ï¼Œä¸€ä¸ªèŠ‚ç‚¹ä¼šä¿å­˜å¤šä¸ªé”®ã€‚å•ä¸ªèŠ‚ç‚¹æœ€å¤šä¿å­˜Mä¸ªé”®çš„Bæ ‘ç§°ä½œMé˜¶Bæ ‘ã€‚&lt;/p>
&lt;p>ä¸€ä¸ªç®€å•çš„ B æ ‘èŠ‚ç‚¹ç»“æ„å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">class&lt;/span> &lt;span class="nc">BTreeNode&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">parent&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s1">&amp;#39;BTreeNode&amp;#39;&lt;/span>
&lt;span class="n">entries&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">List&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="n">children&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">List&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;BTreeNode&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Bæ ‘è¦æ±‚é™¤æ ¹èŠ‚ç‚¹å¤–ï¼Œæ¯ä¸ªèŠ‚ç‚¹æœ€å°‘åŒ…å«&lt;code>M/2&lt;/code>ä¸ªå…ƒç´ ï¼Œéå¶å­èŠ‚ç‚¹çš„ &lt;code>children&lt;/code> æ•°é‡æ˜¯ &lt;code>len(entries)+1&lt;/code>ã€‚æ ¹èŠ‚ç‚¹ä¸è¦æ±‚æœ€å°‘å…ƒç´ æ•°é‡ï¼Œå…¶ä»–çº¦æŸä¸å˜ã€‚&lt;/p>
&lt;h2 id="æ’å…¥èŠ‚ç‚¹">æ’å…¥èŠ‚ç‚¹&lt;/h2>
&lt;p>Bæ ‘è¦æ±‚æ–°çš„é”®åªèƒ½åœ¨å¶å­èŠ‚ç‚¹ä¸Šæ’å…¥ã€‚å¦‚æœå¶å­èŠ‚ç‚¹çš„é”®æ•°é‡è¶…è¿‡äº†ä¸Šé™&lt;code>M&lt;/code>ï¼Œåˆ™å¶å­èŠ‚ç‚¹æ‰§è¡Œ &lt;strong>åˆ†è£‚&lt;/strong> æ“ä½œï¼Œå°†é”®åˆ†æˆä¸‰éƒ¨åˆ†ï¼šä¸­ä½æ•°ï¼Œå°äºä¸­ä½æ•°çš„éƒ¨åˆ†ï¼Œå¤§äºä¸­ä½æ•°çš„éƒ¨åˆ†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="c1"># åˆ†è£‚å‰&lt;/span>
&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="c1"># åˆ†è£‚å&lt;/span>
&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">],&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">,[&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸­ä½æ•°æ’å…¥çˆ¶èŠ‚ç‚¹ï¼Œå°äºä¸­ä½æ•°çš„éƒ¨åˆ†æˆ–å¤§äºä¸­ä½æ•°çš„éƒ¨åˆ†åˆ›å»ºæ–°çš„å­èŠ‚ç‚¹ï¼Œæ’å…¥çˆ¶çº§èŠ‚ç‚¹ã€‚ä»¥æ’å…¥å…ƒç´  1-7 ä¸ºä¾‹ï¼Œå›¾ç¤ºå¦‚ä¸‹ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 245;
flex-basis: 589px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/b-tree/image-20220214113130112.png" data-size="526x214">
&lt;img src="https://nnnewb.github.io/blog/blog/p/b-tree/image-20220214113130112.png"
width="526"
height="214"
srcset="https://nnnewb.github.io/blog/blog/p/b-tree/image-20220214113130112_hu5b12e769ccfd98fac492b0d669d71565_6441_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/b-tree/image-20220214113130112_hu5b12e769ccfd98fac492b0d669d71565_6441_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="å…ƒç´ 1-6">
&lt;/a>
&lt;figcaption>å…ƒç´ 1-6&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 271;
flex-basis: 650px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/b-tree/image-20220214113110231.png" data-size="580x214">
&lt;img src="https://nnnewb.github.io/blog/blog/p/b-tree/image-20220214113110231.png"
width="580"
height="214"
srcset="https://nnnewb.github.io/blog/blog/p/b-tree/image-20220214113110231_hu367bf5992fa3acb17c83fa3ae5854998_8699_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/b-tree/image-20220214113110231_hu367bf5992fa3acb17c83fa3ae5854998_8699_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="æ’å…¥å…ƒç´ 7">
&lt;/a>
&lt;figcaption>æ’å…¥å…ƒç´ 7&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å¯¹äºä¸­ä½æ•°åœ¨ &lt;code>entries&lt;/code> ä¸­é—´çš„æƒ…å†µä¸ä¼šæ›´éº»çƒ¦ï¼Œåªè¦è®°ä½æ–°èŠ‚ç‚¹ä¿å­˜çš„éƒ½æ˜¯å¤§äºä¸­ä½æ•°çš„éƒ¨åˆ†ï¼Œåœ¨&lt;code>entries&lt;/code>æ’å…¥é”®ä¹‹åï¼Œæ‰¾åˆ°å¯¹åº”çš„&lt;code>children&lt;/code>ä¸‹æ ‡æ’å…¥å³å¯ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">def&lt;/span> &lt;span class="nf">add_child&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">entry&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">child&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;éå¶å­èŠ‚ç‚¹æ·»åŠ æ–°å…ƒç´ 
&lt;/span>&lt;span class="s2">
&lt;/span>&lt;span class="s2"> Args:
&lt;/span>&lt;span class="s2"> entry (int): æ–°å…ƒç´ 
&lt;/span>&lt;span class="s2"> child (BTreeNode): åˆ†è£‚å‡ºçš„æ–°å­©å­
&lt;/span>&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;span class="c1"># éå†å¯»æ‰¾æ¯”æ–° entry æ›´å¤§çš„å…ƒç´ ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æ–° entry æ·»åŠ åˆ°æœ€å&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">v&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">enumerate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">entries&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="n">v&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">entry&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">children&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">insert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">child&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">entries&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">insert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">entry&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">grow&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">entries&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">children&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">child&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">grow&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å®Œæ•´ä»£ç ä¼šåœ¨æ–‡æœ«ç»™å‡ºã€‚&lt;/p>
&lt;h2 id="è‡ªå¹³è¡¡">è‡ªå¹³è¡¡&lt;/h2>
&lt;p>Bæ ‘æ˜¯ä¸€ç§è‡ªå¹³è¡¡æ ‘ï¼ŒBæ ‘åšåˆ°è‡ªå¹³è¡¡çš„æ–¹å¼æ¯”è¾ƒç‰¹åˆ«ã€‚ä¸‹é¢çš„å†…å®¹éƒ½æ˜¯æˆ‘ä¸ªäººå¯¹Bæ ‘çš„ç†è§£ï¼Œåè§è­¦å‘Šã€‚&lt;/p>
&lt;p>ä¸€èˆ¬çš„äºŒå‰æœç´¢æ ‘æ’å…¥å…ƒç´ æ—¶ï¼Œä¼šæŠŠå…ƒç´ æ’å…¥åˆ°å¶å­èŠ‚ç‚¹ä¸Šï¼Œå¶å­èŠ‚ç‚¹å°±å˜æˆäº†ä¸­é—´èŠ‚ç‚¹ï¼Œå­æ ‘ä¼šéšç€æ’å…¥çš„å…ƒç´ å¢é•¿è€Œå˜é«˜ï¼Œäºæ˜¯åœ¨å­æ ‘ä¹‹é—´å‡ºç°ä¸å¹³è¡¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€èˆ¬çš„äºŒå‰æœç´¢æ ‘ç”Ÿé•¿æ–¹å‘æ˜¯å‘ä¸‹ï¼Œå¾€å¶å­æ–¹å‘æ‰©å±•ã€‚&lt;/p>
&lt;p>ä½†Bæ ‘æ­£å¥½ç›¸åï¼šå¶å­èŠ‚ç‚¹ä¸ä¼šå˜æˆä¸­é—´èŠ‚ç‚¹ï¼Œåªä¼šåˆ†è£‚å…„å¼ŸèŠ‚ç‚¹ï¼Œå‘çˆ¶çº§èŠ‚ç‚¹æ’å…¥é”®ã€‚è€Œçˆ¶çº§èŠ‚ç‚¹ä¹Ÿä¼šå› ä¸ºé”®è¶…è¿‡&lt;code>M&lt;/code>è€Œåˆ†è£‚ï¼Œä¸€ç›´åˆ°æ ¹èŠ‚ç‚¹ã€‚æ ¹èŠ‚ç‚¹åˆ†è£‚åˆ™ä¼šäº§ç”Ÿæ–°çš„æ ¹ï¼ŒåŸæ¥çš„æ ¹å˜æˆä¸¤ä¸ªå…„å¼ŸèŠ‚ç‚¹ï¼Œæ ‘çš„é«˜åº¦éšä¹‹ä¸Šå‡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒBæ ‘çš„ç”Ÿé•¿é«˜åº¦æ˜¯å‘ä¸Šçš„ï¼Œæ’å…¥æ“ä½œå¯¹æ ‘é«˜åº¦çš„å½±å“æœ€ç»ˆä½“ç°ä¸ºæ ¹èŠ‚ç‚¹çš„åˆ†è£‚ã€‚&lt;/p>
&lt;p>åˆ é™¤èŠ‚ç‚¹çš„è§„åˆ™ä¹Ÿè®¾è®¡ä¸ºä¿æŒè¿™ä¸€ç‰¹æ€§ï¼Œåˆ é™¤é”®å¯¹æ ‘é«˜åº¦çš„å½±å“æœ€ç»ˆä¼šä½“ç°ä¸ºæ ¹èŠ‚ç‚¹å’Œå­èŠ‚ç‚¹åˆå¹¶ï¼Œä½¿å¾—æ ‘é«˜åº¦é™ä½ã€‚&lt;/p>
&lt;h2 id="æœç´¢">æœç´¢&lt;/h2>
&lt;p>Bæ ‘çš„æœç´¢å’ŒäºŒå‰æœç´¢æ ‘å·®ä¸å¤šï¼Œä¸åŒçš„æ˜¯èŠ‚ç‚¹ä¼šè¡¨ç¤ºå¤šä¸ªé”®ï¼Œæ‰€ä»¥äºŒå‰æœç´¢æ ‘ä¸­çš„æ¯”è¾ƒæ“ä½œä¼šå˜æˆåœ¨å¤šä¸ªé”®é‡ŒæŸ¥æ‰¾å€¼ï¼Œå¹¶åœ¨ä¸­é—´èŠ‚ç‚¹æ²¡æ‰¾åˆ°çš„æ—¶å€™é€’å½’æœç´¢å­èŠ‚ç‚¹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python"> &lt;span class="k">def&lt;/span> &lt;span class="nf">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">entry&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="nb">bool&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">v&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">enumerate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">entries&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="n">v&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">entry&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">True&lt;/span>
&lt;span class="c1"># å¦‚æœæ²¡æ‰¾åˆ°ï¼Œè€Œä¸”å½“å‰å…ƒç´ æ¯”æœç´¢å€¼è¦å¤§äº†&lt;/span>
&lt;span class="c1"># å°±ä»å°äºå½“å‰å…ƒç´ çš„å­èŠ‚ç‚¹é‡Œé€’å½’æœç´¢&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">children&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="n">v&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">entry&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">children&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1"># æ²¡æœ‰æ¯”æœç´¢çš„é”®å¤§çš„å€¼ï¼Œåˆ™ä»æœ«å°¾çš„å­èŠ‚ç‚¹ï¼ˆå¤§äºæœ¬èŠ‚ç‚¹å…¨éƒ¨é”®ï¼‰é€’å½’æœç´¢&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">children&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">children&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">False&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="åˆ†è£‚å’Œéœ€è¦æ³¨æ„çš„é—®é¢˜">åˆ†è£‚å’Œéœ€è¦æ³¨æ„çš„é—®é¢˜&lt;/h2>
&lt;p>åˆ†è£‚èŠ‚ç‚¹å†™èµ·æ¥å¾ˆç®€å•ï¼Œæ¯” AVL æ—‹è½¬è¦å¥½æ‡‚å¾ˆå¤šã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python"> &lt;span class="k">def&lt;/span> &lt;span class="nf">grow&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="c1"># æ£€æŸ¥å’Œå¤„ç†åˆ†è£‚&lt;/span>
&lt;span class="c1"># B-Tree çš„å¢é•¿æ–¹å‘æ˜¯æ¨ªå‘+çºµå‘ï¼Œæ¨ªå‘æ˜¯æ‰©å±•å…„å¼ŸèŠ‚ç‚¹ï¼Œçºµå‘æ˜¯å¾€æ ¹èŠ‚ç‚¹æ–¹å‘ç”Ÿé•¿&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">entries&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">MAXIMUM_ENTRIES&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">middle&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">entries&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">MIDDLE_ENTRY_IDX&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="n">split_entries&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">entries&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">MIDDLE_ENTRY_IDX&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">:]&lt;/span>
&lt;span class="n">split_children&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">children&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">MIDDLE_CHILD_IDX&lt;/span>&lt;span class="p">:]&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">entries&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">entries&lt;/span>&lt;span class="p">[:&lt;/span>&lt;span class="n">MIDDLE_ENTRY_IDX&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">children&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">children&lt;/span>&lt;span class="p">[:&lt;/span>&lt;span class="n">MIDDLE_CHILD_IDX&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="n">split_node&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">BTreeNode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parent&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">split_node&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">entries&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">split_entries&lt;/span>
&lt;span class="n">split_node&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">children&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">split_children&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="n">child&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">split_children&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">child&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">split_node&lt;/span>
&lt;span class="c1"># ä¸­é—´èŠ‚ç‚¹åˆ†è£‚çš„æƒ…å†µ&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parent&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parent&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">add_child&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">middle&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">split_node&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="c1"># æ ¹èŠ‚ç‚¹åˆ†è£‚ï¼Œç”Ÿæˆæ–°çš„æ ¹èŠ‚ç‚¹&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">BTreeNode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">split_node&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parent&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parent&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">children&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">split_node&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parent&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">entries&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">middle&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸»è¦æ³¨æ„ï¼š&lt;/p>
&lt;ol>
&lt;li>é€‰æ‹©åˆé€‚çš„ä¸­ä½æ•°ã€‚å¦‚æœ&lt;code>M&lt;/code>æ˜¯å¥‡æ•°ï¼Œ&lt;code>M+1&lt;/code>é™¤äºŒæ²¡æœ‰ä½™æ•°ï¼Œä¹Ÿé€‰ä¸å‡ºä¸­ä½æ•°ã€‚&lt;/li>
&lt;li>æ–°èŠ‚ç‚¹ï¼ˆ&lt;code>split_node&lt;/code>å’Œ&lt;code>split_children&lt;/code>ï¼‰éƒ½éœ€è¦é‡æ–°è°ƒæ•´&lt;code>parent&lt;/code>å±æ€§ï¼Œä¸è¦æ¼äº†ã€‚&lt;/li>
&lt;li>ä¸­é—´èŠ‚ç‚¹çš„åˆ†è£‚è¦å‘ä¸Šæ·»åŠ ä¸€ä¸ª&lt;code>entry&lt;/code>å’Œ&lt;code>child&lt;/code>ï¼Œåˆ†åˆ«è¡¨ç¤ºé”®å’Œå¤§äºè¿™ä¸ªé”®çš„èŠ‚ç‚¹ã€‚
&lt;ol>
&lt;li>è¿™æ˜¯ä¸ªé€’å½’è¿‡ç¨‹ï¼Œä¸Šçº§èŠ‚ç‚¹ä¹Ÿå¯èƒ½å‘ç”Ÿåˆ†è£‚ï¼Œä¸€ç›´åˆ°æ ¹åˆ†è£‚ã€‚&lt;/li>
&lt;li>è¿™ä¸ªè¿‡ç¨‹ä¼šä¿ç•™åŸèŠ‚ç‚¹ï¼ˆ&lt;code>self&lt;/code>ï¼‰ï¼Œå¯ä»¥ç†è§£ä¸º&lt;code>children&lt;/code>çš„ä¸‹æ ‡&lt;code>i&lt;/code>è¡¨ç¤º&lt;code>children[i]&lt;/code>è¿™æ£µå­æ ‘æ‰€æœ‰é”®å°äº&lt;code>entries[i]&lt;/code>ã€‚&lt;code>children[-1]&lt;/code>æ²¡æœ‰å¯¹åº”çš„&lt;code>entries&lt;/code>ä¸‹æ ‡ï¼Œè¡¨ç¤ºçš„æ˜¯å¤§äºèŠ‚ç‚¹æ‰€æœ‰é”®çš„å­æ ‘ï¼Œç›¸å½“äºæ˜¯äºŒå‰æœç´¢æ ‘ä¸­çš„å³å­æ ‘ã€‚&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>æ ¹èŠ‚ç‚¹åˆ†è£‚ä¼šå¯¼è‡´æ ‘çš„æ ¹å‘ç”Ÿæ”¹å˜ï¼Œå®Œæˆæ’å…¥æ“ä½œåéœ€è¦é‡æ–°ç¡®å®šæ ¹èŠ‚ç‚¹æŒ‡é’ˆï¼Œä¸ç„¶ä¼šå¯¼è‡´æœç´¢å‡ºé”™æˆ–å†æ¬¡åˆ†è£‚çš„æ—¶å€™å¾€é”™è¯¯çš„èŠ‚ç‚¹æ·»åŠ é”®ï¼Œç ´åæœç´¢æ ‘çš„æ€§è´¨ã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="bæ ‘æ€§èƒ½">Bæ ‘æ€§èƒ½&lt;/h2>
&lt;p>Bæ ‘çš„æ€§èƒ½ä¼˜åŠ¿æ¥è‡ªæ ‘çš„é«˜åº¦å¢é•¿ç›¸å¯¹æ¯”è¾ƒæ…¢ï¼Œé€‰æ‹©åˆé€‚çš„é˜¶å¯ä»¥å‡å°‘ç£ç›˜IOæ¬¡æ•°ã€‚å¦å¤–å°±æ˜¯ä¸€ä¸ªèŠ‚ç‚¹åŒ…å«å¤šä¸ªé”®ï¼Œæé«˜é”®çš„å‚¨å­˜å¯†åº¦ï¼Œæ›´ç¬¦åˆå±€éƒ¨æ€§åŸç†ï¼Œç›¸å¯¹äºäºŒå‰æœç´¢æ ‘æ¥è¯´å¯¹CPUç¼“å­˜ä¹Ÿæ›´è¾ƒå‹å¥½ã€‚&lt;/p>
&lt;p>å¯¹è¿™ä¸ªåœºæ™¯æˆ‘èƒ½æƒ³åˆ°çš„å‡ ä¸ªå…³é”®å› ç´ ä¸»è¦æœ‰ï¼š&lt;/p>
&lt;ul>
&lt;li>å†…å­˜ç¼“å­˜ã€‚å°½å¯èƒ½æ¦¨å¹²å¯ç”¨çš„å†…å­˜ï¼Œé¿å…é¢‘ç¹è¿›è¡Œç£ç›˜IOã€‚&lt;/li>
&lt;li>å±€éƒ¨æ€§åŸç†ã€‚&lt;/li>
&lt;/ul>
&lt;p>å…¶ä¸­å±€éƒ¨æ€§åŸç†åˆåˆ†å‡ é¡¹ã€‚&lt;/p>
&lt;p>ä¸€ä¸ªæ˜¯å†…å­˜çš„åˆ†é¡µæœºåˆ¶ï¼Œåœ¨å†…å­˜ç´§å¼ çš„æƒ…å†µä¸‹å¦‚æœèŠ‚ç‚¹é›†åˆå¤§å°ä¸æ˜¯ä¸€é¡µçš„æ•´æ•°å€çš„è¯ï¼Œä¼šäº§ç”Ÿæ›´å¤šçš„ç¼ºé¡µå¼‚å¸¸ï¼Œé€ æˆæ›´é¢‘ç¹åœ°è¯»ç›˜ï¼ˆè€ƒè™‘ä½¿ç”¨äº†äº¤æ¢åˆ†åŒºæˆ– windows é¡µæ–‡ä»¶ï¼Œåˆæˆ–è€… &lt;code>mmap&lt;/code> ç­‰æ–¹å¼è¯»å–ï¼‰ã€‚&lt;/p>
&lt;p>å¦ä¸€ä¸ªæ˜¯CPUçš„é«˜é€Ÿç¼“å­˜ï¼Œå¦‚æœç»“æ„å¡«ä¸æ»¡æˆ–è€…è¶…å‡ºcache line å¤§å°çš„è¯éƒ½ä¼šæœ‰å½±å“ã€‚&lt;/p>
&lt;p>å½“ç„¶ï¼Œæœ€åè¿˜æ˜¯å…·ä½“é—®é¢˜å…·ä½“åˆ†æã€‚ç»™è¿™ç¯‡åšå®¢æ‰¾èµ„æ–™çš„æ—¶å€™çœ‹åˆ°çš„è¿™ç¯‡æ–‡ç« å¾ˆä¸é”™ &lt;a class="link" href="http://igoro.com/archive/gallery-of-processor-cache-effects/" target="_blank" rel="noopener"
>gallery of processor cache effects&lt;/a>ï¼ŒæŒºå–œæ¬¢çš„ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>bæ ‘æ˜¯å¤šè·¯æœç´¢æ ‘ã€‚&lt;/p>
&lt;p>bæ ‘æ’å…¥èŠ‚ç‚¹æ€»æ˜¯åœ¨å¶å­ï¼Œbæ ‘å‘æ ¹æ–¹å‘ç”Ÿé•¿ã€‚&lt;/p>
&lt;p>bæ ‘é€šè¿‡èŠ‚ç‚¹åˆ†è£‚å’Œåˆå¹¶å®ç°è‡ªå¹³è¡¡ã€‚&lt;/p>
&lt;p>bæ ‘æœç´¢å’Œä¸€èˆ¬çš„äºŒå‰æœç´¢æ ‘å·®åˆ«ä¸å¤§ã€‚&lt;/p>
&lt;p>ä»¥åŠbæ ‘æ€§èƒ½ä¼˜åŠ¿æ¥è‡ªæ ‘æ›´çŸ®ï¼ŒèŠ‚ç‚¹æ›´å°‘ï¼Œé”®æ›´é›†ä¸­ï¼Œç¬¦åˆå±€éƒ¨æ€§åŸç†ï¼Œå‡å°‘ç£ç›˜ioæ¬¡æ•°ï¼Œåˆé€‚çš„é˜¶è®©ç»“æ„å¯¹ç¼“å­˜æ›´å‹å¥½ã€‚&lt;/p></description></item><item><title>AVLæ ‘</title><link>https://nnnewb.github.io/blog/p/avl-tree/</link><pubDate>Fri, 11 Feb 2022 15:07:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/avl-tree/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>è¿˜è®°å¾—å¾ˆä¹…ä»¥å‰å­¦æ•°æ®ç»“æ„åªçœ‹åˆ°äºŒå‰æ ‘ï¼Œè®²åˆ°å¹³è¡¡ï¼Œä½†å¹³è¡¡æ–¹æ³•å½“æ—¶çœ‹çº¸è´¨ä¹¦æ‰‹å¤´ä¹Ÿæ²¡æœ‰å®éªŒç¯å¢ƒï¼Œåæ¥å°±æ²¡ç»§ç»­å­¦ä¸‹å»ã€‚ç°åœ¨æœ‰é—²å°±é‡æ–°æ¡èµ·æ¥å­¦ä¸€ä¸‹ã€‚å…ˆä»AVLæ ‘ç»§ç»­çœ‹ã€‚&lt;/p>
&lt;h2 id="avlæ ‘">AVLæ ‘&lt;/h2>
&lt;p>AVL æ ‘æ˜¯ä»¥æå‡ºè€…åå­—å‘½åçš„ï¼ŒAdelson-Velskii &amp;amp; Landisï¼Œä¿„å›½äººï¼Œåæ¥ç§»å±…ä»¥è‰²åˆ—ã€‚äººæ€ä¹ˆæ ·ä¸ç®¡å•¦ã€‚&lt;/p>
&lt;p>AVL æ ‘æ˜¯ä¸€ç§å¹³è¡¡äºŒå‰æ ‘ï¼Œå·¦å³å­æ ‘é«˜åº¦å·®ä¸è¶…è¿‡1ã€‚ä¿æŒå¹³è¡¡çš„æ–¹æ³•æ˜¯æ¯æ¬¡æ’å…¥æ•°æ®çš„æ—¶å€™å‘ç°å­æ ‘ä¸å¹³è¡¡ï¼Œå°±æŠŠè¾ƒé«˜çš„å­æ ‘æå‡ä¸ºæ ¹ï¼ŒæŠŠæ ¹å˜æˆæ–°çš„æ ¹çš„å­æ ‘ï¼ŒæŠŠè¾ƒé«˜çš„å­æ ‘å˜çŸ®ï¼Œè¾ƒçŸ®çš„å­æ ‘å˜é«˜ï¼Œå®ç°å¹³è¡¡ã€‚è¿™ä¸ªè¿‡ç¨‹è¢«å«åšæ—‹è½¬ï¼Œä¸‹é¢ä»‹ç»æ—‹è½¬ã€‚&lt;/p>
&lt;h2 id="å·¦æ—‹è½¬å³æ—‹è½¬">å·¦æ—‹è½¬/å³æ—‹è½¬&lt;/h2>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 357;
flex-basis: 858px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/avl-tree/640.webp" data-size="1080x302">
&lt;img src="https://nnnewb.github.io/blog/blog/p/avl-tree/640.webp"
width="1080"
height="302"
srcset="https://nnnewb.github.io/blog/blog/p/avl-tree/640_hue4f2eb0b84b4ee9edbff095635b31765_16328_480x0_resize_q75_h2_box_2.webp 480w, https://nnnewb.github.io/blog/blog/p/avl-tree/640_hue4f2eb0b84b4ee9edbff095635b31765_16328_1024x0_resize_q75_h2_box_2.webp 1024w"
loading="lazy"
alt="å³æ—‹è½¬">
&lt;/a>
&lt;figcaption>å³æ—‹è½¬&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 407;
flex-basis: 978px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/avl-tree/640-16445510501782.webp" data-size="1080x265">
&lt;img src="https://nnnewb.github.io/blog/blog/p/avl-tree/640-16445510501782.webp"
width="1080"
height="265"
srcset="https://nnnewb.github.io/blog/blog/p/avl-tree/640-16445510501782_hu6ffc1b8ea7f9226d8e679d85cbb8998e_14524_480x0_resize_q75_h2_box_2.webp 480w, https://nnnewb.github.io/blog/blog/p/avl-tree/640-16445510501782_hu6ffc1b8ea7f9226d8e679d85cbb8998e_14524_1024x0_resize_q75_h2_box_2.webp 1024w"
loading="lazy"
alt="å·¦æ—‹è½¬">
&lt;/a>
&lt;figcaption>å·¦æ—‹è½¬&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å·¦æ—‹è½¬å’Œå³æ—‹è½¬çš„é€»è¾‘æ˜¯ä¸€æ ·çš„ã€‚å¦‚æœå³å­æ ‘æ¯”å·¦å­æ ‘é«˜ï¼Œå°±æŠŠå³å­æ ‘æå‡æˆæ ¹ã€‚å¦‚æœå·¦å­æ ‘æ¯”å³å­æ ‘é«˜ï¼Œå°±æŠŠå·¦å­æ ‘æå‡æˆæ ¹ã€‚æå‡å³å­æ ‘å«å·¦æ—‹è½¬ï¼Œæå‡å·¦å­æ ‘å«å³æ—‹è½¬ã€‚&lt;/p>
&lt;p>æŠŠå­æ ‘æå‡æˆæ ¹ä¼šæœ‰ç‚¹éº»çƒ¦ã€‚æ¯”å¦‚å³å­æ ‘æå‡ä¸ºæ ¹ï¼ŒåŸæ¥çš„æ ¹å’Œå·¦å­æ ‘æ€ä¹ˆåŠï¼Ÿæˆ‘ä»¬å¹¶ä¸æƒ³é‡æ–°å¹³è¡¡æ ‘çš„æ—¶å€™æŠŠæ•´ä¸ªå·¦å­æ ‘éƒ½åˆ æ‰ï¼Œé‚£åŸæ¥çš„æ ¹å’Œå·¦å­æ ‘å°±å¿…é¡»æ’å›æ–°çš„æ ‘é‡Œã€‚&lt;/p>
&lt;p>æˆ‘ä»¬çŸ¥é“å³å­æ ‘çš„ key è‚¯å®šæ¯”æ ¹å’Œå·¦å­æ ‘æ‰€æœ‰èŠ‚ç‚¹å¤§ï¼Œæ‰€ä»¥æ ¹è¦æ’å›æ ‘çš„è¯ï¼Œä¸€ä¸ªå¾ˆç›´æ¥çš„æƒ³æ³•å°±æ˜¯æŠŠæ—§çš„æ ¹æ¥åˆ°å³å­æ ‘å·¦ä¸‹è§’çš„å¶å­èŠ‚ç‚¹ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 125;
flex-basis: 301px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/avl-tree/image-20220211115435552.png" data-size="442x352">
&lt;img src="https://nnnewb.github.io/blog/blog/p/avl-tree/image-20220211115435552.png"
width="442"
height="352"
srcset="https://nnnewb.github.io/blog/blog/p/avl-tree/image-20220211115435552_hudaf66137716a342688a9fcb78a9ab8fa_32310_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/avl-tree/image-20220211115435552_hudaf66137716a342688a9fcb78a9ab8fa_32310_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="æ—§çš„æ ¹æ’å›æ–°æ ¹">
&lt;/a>
&lt;figcaption>æ—§çš„æ ¹æ’å›æ–°æ ¹&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>çš„ç¡®ï¼Œè¿™æ ·ä¿æŒäº†äºŒå‰æœç´¢æ ‘çš„ç‰¹å¾ï¼Œä½†æ–°çš„æ ‘ä¾ç„¶ä¸å¹³è¡¡ï¼šèŠ‚ç‚¹5çš„å·¦å­æ ‘é«˜åº¦2ï¼Œå³å­æ ‘é«˜åº¦0ï¼Œé«˜åº¦å·®è¶…è¿‡äº†1ã€‚ç¨å¾®æƒ³æƒ³å°±çŸ¥é“ï¼Œæ—§çš„æ ¹å’Œå·¦å­æ ‘ç›´æ¥æ¥åˆ°å·¦ä¸‹è§’å¶å­èŠ‚ç‚¹çš„è¯ï¼Œä¼šè®©åŸæœ¬å¹³è¡¡çš„æ–°æ ‘å·¦å­æ ‘é«˜åº¦å¢åŠ ï¼Œè¿›è€Œå¤±å»å¹³è¡¡ã€‚&lt;/p>
&lt;p>è§£å†³æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œä¸è¦æŠŠæ—§çš„æ ‘æ¥åˆ°æ–°çš„æ ‘æœ€å°å€¼ä¸Šï¼Œè€Œæ˜¯æŠŠæ–°æ ‘çš„å·¦å­æ ‘ï¼Œç§»æ¤æˆæ—§æ ‘çš„å³å­æ ‘ï¼Œå†æŠŠæ—§æ ‘ç§»æ¤æˆæ–°æ ‘çš„å·¦å­æ ‘ã€‚è¿™æ ·ä¸€æ¥ï¼Œå³å­æ ‘çš„å·¦å­æ ‘å’Œå·¦å­æ ‘çš„å³å­æ ‘ä¸ç®¡æ€ä¹ˆæ—‹è½¬ï¼Œé«˜åº¦éƒ½ä¸€æ ·ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 152;
flex-basis: 365px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/avl-tree/image-20220211135807095.png" data-size="559x367">
&lt;img src="https://nnnewb.github.io/blog/blog/p/avl-tree/image-20220211135807095.png"
width="559"
height="367"
srcset="https://nnnewb.github.io/blog/blog/p/avl-tree/image-20220211135807095_huce0ca6d6e6da680d37b57191522379d3_34024_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/avl-tree/image-20220211135807095_huce0ca6d6e6da680d37b57191522379d3_34024_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20220211135807095">
&lt;/a>
&lt;figcaption>image-20220211135807095&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>ä¸ºä»€ä¹ˆè¿™æ ·å¯ä»¥ä¿æŒå¹³è¡¡å‘¢ï¼Ÿé¦–å…ˆAVLæ ‘çš„å­æ ‘ä¹Ÿæ˜¯AVLæ ‘ï¼Œæ‰€ä»¥å­æ ‘çš„å­æ ‘ä¹‹é—´é«˜åº¦å·®ä¹Ÿä¸è¶…è¿‡1ã€‚å·¦æ—‹è½¬ã€å³æ—‹è½¬çš„çš„ä½œç”¨æ˜¯è®©å­æ ‘é«˜åº¦ä¸€ä¾§å‡é«˜ï¼Œä¸€ä¾§é™ä½â€”â€”æ³¨æ„ï¼Œå·¦æ—‹è½¬åªèƒ½é™ä½å³å„¿å­çš„å³å­æ ‘é«˜åº¦ï¼Œå³å„¿å­çš„å·¦å­æ ‘é«˜åº¦ä¸å˜ã€‚å³æ—‹è½¬åªèƒ½é™ä½å·¦å„¿å­çš„å·¦å­æ ‘é«˜åº¦ï¼Œå·¦å„¿å­çš„å³å­æ ‘é«˜åº¦ä¸å˜ã€‚&lt;/p>
&lt;p>ä¸¾ä¾‹æ¥è¯´ï¼Œä¸Šå›¾ä¸­å³å„¿å­çš„å³å­æ ‘ï¼ˆ4-6-7-8ï¼‰è¾ƒé«˜ï¼Œæ—‹è½¬åå˜æˆäº†ï¼ˆ6-7-8ï¼‰ï¼Œè€ŒåŸæœ¬çš„ï¼ˆ4-6-5ï¼‰å˜æˆäº†ï¼ˆ6-4-5ï¼‰ï¼Œé«˜åº¦ä¸å˜ã€‚&lt;/p>
&lt;p>è¿™ä¸ªè§„å¾‹å¾ˆå¥½ç†è§£ï¼Œå› ä¸ºåŸæ¥çš„å³å­æ ‘å˜æˆäº†æ ¹ï¼Œæ•´ä¸ªå³å­æ ‘å‰©ä¸‹çš„èŠ‚ç‚¹é«˜åº¦éƒ½é™ä½äº†ã€‚è€Œå³å­æ ‘çš„å·¦å­æ ‘å˜æˆäº†ç°åœ¨çš„å·¦å­æ ‘çš„å³å­æ ‘ï¼Œå’Œæ ¹çš„è·ç¦»ä¸€æ ·ï¼Œæ‰€ä»¥é«˜åº¦ä¸å˜ã€‚&lt;/p>
&lt;p>&lt;strong>å·¦æ—‹è½¬è®©å³å­æ ‘çš„å³å­æ ‘é«˜åº¦-1ï¼Œå·¦å­æ ‘çš„å·¦å­æ ‘é«˜åº¦+1ã€‚å·¦å­æ ‘çš„å³å­æ ‘é«˜åº¦ç­‰äºå³å­æ ‘çš„å·¦å­æ ‘ï¼Œæ—‹è½¬åæ–°æ ‘çš„å·¦å³å­æ ‘çš„é«˜åº¦ç›¸ç­‰ã€‚&lt;/strong>&lt;/p>
&lt;h2 id="åŒæ—‹è½¬">åŒæ—‹è½¬&lt;/h2>
&lt;p>å¯¹äºå¾€å·¦å„¿å­çš„å·¦å­æ ‘æ’å…¥èŠ‚ç‚¹é€ æˆçš„ä¸å¹³è¡¡ï¼Œå³æ—‹è½¬å¯ä»¥å®ç°é™ä½å·¦å„¿å­çš„å·¦å­æ ‘é«˜åº¦ï¼Œå†æ¬¡å¹³è¡¡ã€‚å¾€å³å„¿å­çš„å³å­æ ‘æ’å…¥èŠ‚ç‚¹é€ æˆçš„ä¸å¹³è¡¡ï¼Œå·¦æ—‹è½¬å¯ä»¥é™ä½å³å„¿å­çš„å³å­æ ‘é«˜åº¦ï¼Œå†æ¬¡å¹³è¡¡ã€‚ä½†å¯¹äºå·¦å„¿å­çš„å³å­æ ‘æˆ–å³å„¿å­çš„å·¦å­æ ‘æ’å…¥èŠ‚ç‚¹é€ æˆçš„ä¸å¹³è¡¡ï¼Œä¸€æ¬¡å·¦ã€å³æ—‹è½¬æ— æ³•å®ç°å†å¹³è¡¡ã€‚&lt;/p>
&lt;p>å†çœ‹ä¸€ä¸ªä¾‹å­ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 134;
flex-basis: 321px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/avl-tree/image-20220211141652944.png" data-size="535x399">
&lt;img src="https://nnnewb.github.io/blog/blog/p/avl-tree/image-20220211141652944.png"
width="535"
height="399"
srcset="https://nnnewb.github.io/blog/blog/p/avl-tree/image-20220211141652944_hue06f3e4447c8c13119165b1bee1e7d22_36072_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/avl-tree/image-20220211141652944_hue06f3e4447c8c13119165b1bee1e7d22_36072_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20220211141652944">
&lt;/a>
&lt;figcaption>image-20220211141652944&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æ—‹è½¬å‰ï¼Œå³å„¿å­çš„å·¦å­æ ‘ï¼ˆ4-7-6-5ï¼‰é«˜åº¦æ˜¯4ï¼Œæ—‹è½¬åï¼ˆ7-4-6-5ï¼‰é«˜åº¦ä¸å˜ï¼Œä¾ç„¶æ˜¯4ï¼Œæ ‘ä»ç„¶ä¸å¹³è¡¡ã€‚è§£å†³åŠæ³•ä¹Ÿå¾ˆç®€å•ï¼Œå…ˆæŠŠå³å­æ ‘ï¼ˆ7ï¼‰å³æ—‹ï¼Œè®©å³å„¿å­çš„å·¦å­æ ‘é«˜åº¦ä½äºå³å­æ ‘ï¼Œå†å¯¹æ•´æ£µæ ‘å·¦æ—‹ï¼Œä¹Ÿå°±æ˜¯AVLæ ‘çš„åŒæ—‹è½¬ã€‚&lt;/p>
&lt;p>ä¸€æ­¥ä¸€æ­¥çœ‹åŒæ—‹è½¬æ˜¯æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚&lt;/p>
&lt;p>ç¬¬ä¸€æ­¥ï¼Œå³å„¿å­çš„å·¦å­æ ‘æ¯”å³å„¿å­å³å­æ ‘é«˜ï¼Œæ‰€ä»¥å°†å³å„¿å­å³æ—‹ï¼Œä½¿å¾—å³å„¿å­çš„å³å­æ ‘é«˜äºå³å„¿å­çš„å·¦å­æ ‘ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 141;
flex-basis: 339px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/avl-tree/image-20220211142847329.png" data-size="490x346">
&lt;img src="https://nnnewb.github.io/blog/blog/p/avl-tree/image-20220211142847329.png"
width="490"
height="346"
srcset="https://nnnewb.github.io/blog/blog/p/avl-tree/image-20220211142847329_hudfe01573f636ba8f14106612b6b86fbd_23701_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/avl-tree/image-20220211142847329_hudfe01573f636ba8f14106612b6b86fbd_23701_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20220211142847329">
&lt;/a>
&lt;figcaption>image-20220211142847329&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æˆ‘ä»¬çŸ¥é“çš„å·¦æ—‹è½¬æ—¶å³å„¿å­çš„å·¦å­æ ‘é«˜åº¦ä¸å˜ï¼Œå³å„¿å­çš„å³å­æ ‘é«˜åº¦-1ã€‚è¿™ä¸€æ­¥å‰ï¼Œç›´æ¥å¯¹æ•´æ£µæ ‘å·¦æ—‹æ—¶ï¼Œæœ€é«˜çš„é‚£é¢—å­æ ‘ï¼ˆå³å„¿å­çš„å·¦å­æ ‘ï¼‰é«˜åº¦æ²¡æœ‰å˜åŒ–ï¼Œæ ‘ä¾ç„¶ä¸å¹³è¡¡ï¼Œåªæ˜¯å˜æˆäº†å³å­æ ‘æ›´çŸ®ï¼Œå·¦å­æ ‘æ›´é«˜è€Œå·²ã€‚&lt;/p>
&lt;p>è€Œè¿™ä¸€æ­¥ä¹‹åï¼Œæœ€é«˜çš„å­æ ‘å˜æˆäº†å³å­æ ‘çš„å³å­æ ‘ã€‚ç°åœ¨å¯¹æ•´æ£µæ ‘å·¦æ—‹ï¼Œå³å­æ ‘çš„å³å­æ ‘é«˜åº¦ä¸‹é™äº†ï¼Œå’ŒåŸæœ¬å³å­æ ‘çš„å·¦å­æ ‘é«˜åº¦ä¸€è‡´ï¼Œè¾¾æˆå¹³è¡¡ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 162;
flex-basis: 390px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/avl-tree/image-20220211151253277.png" data-size="573x352">
&lt;img src="https://nnnewb.github.io/blog/blog/p/avl-tree/image-20220211151253277.png"
width="573"
height="352"
srcset="https://nnnewb.github.io/blog/blog/p/avl-tree/image-20220211151253277_hu3754058aad682cd96a93972186837210_33976_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/avl-tree/image-20220211151253277_hu3754058aad682cd96a93972186837210_33976_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20220211151253277">
&lt;/a>
&lt;figcaption>image-20220211151253277&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>è¿™ä¸ªåŸåˆ™ç®€å•åœ°è¯´ï¼Œå°±æ˜¯å·¦å­æ ‘ä¸‹æœ€é«˜çš„å­æ ‘åº”è¯¥æ˜¯å·¦å­æ ‘ï¼Œå³å­æ ‘ä¸‹æœ€é«˜çš„å­æ ‘åº”è¯¥æ˜¯å³å­æ ‘ã€‚å¦‚æœæ–°å¢èŠ‚ç‚¹åä¸æ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼Œå°±è¦å…ˆå¯¹å·¦å­æ ‘å·¦æ—‹ï¼Œæˆ–è€…å¯¹å³å­æ ‘å³æ—‹ï¼Œæ¥æ»¡è¶³è¿™ä¸ªæ¡ä»¶ã€‚&lt;/p>
&lt;h2 id="ä»£ç å®ç°">ä»£ç å®ç°&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="kn">from&lt;/span> &lt;span class="nn">typing&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">Optional&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">AVLTreeNode&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;æ ‘èŠ‚ç‚¹
&lt;/span>&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="fm">__init__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">parent&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s1">&amp;#39;AVLTreeNode&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">value&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">parent&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">Optional&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;AVLTreeNode&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">None&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">right&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">Optional&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;AVLTreeNode&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">None&lt;/span>
&lt;span class="nd">@property&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">height&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;å­æ ‘é«˜åº¦
&lt;/span>&lt;span class="s2">
&lt;/span>&lt;span class="s2"> Returns:
&lt;/span>&lt;span class="s2"> int: å­æ ‘é«˜åº¦
&lt;/span>&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">max&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_left_height&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_right_height&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;span class="nd">@property&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">_left_height&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">height&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="nd">@property&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">_right_height&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">right&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">height&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">right&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="nd">@property&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">balance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="nb">bool&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;æ˜¯å¦å¹³è¡¡
&lt;/span>&lt;span class="s2">
&lt;/span>&lt;span class="s2"> Returns:
&lt;/span>&lt;span class="s2"> bool: æ˜¯å¦å¹³è¡¡
&lt;/span>&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">abs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_left_height&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_right_height&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">right_rotate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;èŠ‚ç‚¹å³æ—‹
&lt;/span>&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">raise&lt;/span> &lt;span class="ne">Exception&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;can not rotate tree with empty left node&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1"># æ—§çš„æ ¹æˆä¸ºå³èŠ‚ç‚¹&lt;/span>
&lt;span class="c1"># æ—§çš„æ ¹çš„å·¦èŠ‚ç‚¹æˆä¸ºæ–°çš„æ ¹&lt;/span>
&lt;span class="c1"># æ–°çš„æ ¹çš„å³èŠ‚ç‚¹å˜æˆæ—§çš„æ ¹çš„å·¦èŠ‚ç‚¹&lt;/span>
&lt;span class="c1"># æ—§çš„æ ¹å˜æˆæ–°çš„æ ¹çš„å³èŠ‚ç‚¹&lt;/span>
&lt;span class="n">old_root&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>
&lt;span class="n">new_root&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">old_root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left&lt;/span>
&lt;span class="n">old_root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">new_root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">right&lt;/span>
&lt;span class="n">new_root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">right&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">old_root&lt;/span>
&lt;span class="c1"># æ–°æ ¹æ›¿æ¢æ—§æ ¹&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="n">old_root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parent&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="n">old_root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parent&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">old_root&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">old_root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parent&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">new_root&lt;/span>
&lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">old_root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parent&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">right&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">new_root&lt;/span>
&lt;span class="n">new_root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">old_root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parent&lt;/span>
&lt;span class="n">old_root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">new_root&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="n">old_root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">old_root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">old_root&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">left_rotate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;èŠ‚ç‚¹å·¦æ—‹
&lt;/span>&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">right&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">raise&lt;/span> &lt;span class="ne">Exception&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;can not rotate tree with empty right node&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1"># æ—§çš„æ ¹æˆä¸ºå·¦èŠ‚ç‚¹&lt;/span>
&lt;span class="c1"># æ—§çš„æ ¹çš„å³èŠ‚ç‚¹æˆä¸ºæ–°çš„æ ¹&lt;/span>
&lt;span class="c1"># æ–°çš„æ ¹çš„å·¦èŠ‚ç‚¹ä½œä¸ºæ—§çš„æ ¹çš„å³å­æ ‘&lt;/span>
&lt;span class="c1"># æ—§çš„æ ¹å˜æˆæ–°çš„æ ¹çš„å·¦å­æ ‘&lt;/span>
&lt;span class="n">old_root&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>
&lt;span class="n">new_root&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">right&lt;/span>
&lt;span class="n">old_root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">right&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">new_root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left&lt;/span>
&lt;span class="n">new_root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">old_root&lt;/span>
&lt;span class="c1"># æ–°æ ¹æ›¿æ¢æ—§æ ¹&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="n">old_root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parent&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="n">old_root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parent&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">old_root&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">old_root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parent&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">new_root&lt;/span>
&lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">old_root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parent&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">right&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">new_root&lt;/span>
&lt;span class="n">new_root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">old_root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parent&lt;/span>
&lt;span class="n">old_root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">new_root&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="n">old_root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">right&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">old_root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">right&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">old_root&lt;/span>
&lt;span class="k">assert&lt;/span> &lt;span class="n">new_root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">right&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">new_root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">value&lt;/span>
&lt;span class="k">assert&lt;/span> &lt;span class="n">new_root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">new_root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">value&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">_rebalance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">balance&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_left_height&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_right_height&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="c1"># å¦‚æœæœ€é«˜çš„å­æ ‘æ˜¯å·¦å­æ ‘çš„å³å­æ ‘ï¼Œå…ˆå¯¹å·¦å­æ ‘å·¦æ—‹&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span> \
&lt;span class="ow">and&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">right&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span> \
&lt;span class="ow">and&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">height&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">right&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">height&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left_rotate&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">right_rotate&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="c1"># å¦‚æœæœ€é«˜çš„å­æ ‘æ˜¯å³å­æ ‘çš„å·¦å­æ ‘ï¼Œå…ˆå¯¹å³å­æ ‘å³æ—‹&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">right&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">right&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span> \
&lt;span class="ow">and&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">right&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span> \
&lt;span class="ow">and&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">right&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">right&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">height&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">right&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">height&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">right&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">right_rotate&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left_rotate&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">insert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;æ’å…¥æ–°èŠ‚ç‚¹
&lt;/span>&lt;span class="s2">
&lt;/span>&lt;span class="s2"> Args:
&lt;/span>&lt;span class="s2"> value (int): è¦æ’å…¥çš„æ•°æ®
&lt;/span>&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">AVLTreeNode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">insert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">elif&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">right&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">right&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">AVLTreeNode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">right&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">insert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_rebalance&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="nb">bool&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;æœç´¢å€¼
&lt;/span>&lt;span class="s2">
&lt;/span>&lt;span class="s2"> Args:
&lt;/span>&lt;span class="s2"> value (int): å¾…æœç´¢çš„å€¼
&lt;/span>&lt;span class="s2">
&lt;/span>&lt;span class="s2"> Returns:
&lt;/span>&lt;span class="s2"> bool: å€¼æ˜¯å¦å­˜åœ¨
&lt;/span>&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">True&lt;/span>
&lt;span class="k">elif&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">value&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">elif&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">value&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">right&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">right&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">False&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">AVLTree&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;AVL tree
&lt;/span>&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="fm">__init__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">Optional&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">AVLTreeNode&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">None&lt;/span>
&lt;span class="nd">@property&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">height&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;AVLæ ‘é«˜åº¦
&lt;/span>&lt;span class="s2">
&lt;/span>&lt;span class="s2"> Returns:
&lt;/span>&lt;span class="s2"> int: æ ‘é«˜åº¦
&lt;/span>&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">root&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">height&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="nd">@property&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">balance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="nb">bool&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;æ ‘æ˜¯å¦å¹³è¡¡
&lt;/span>&lt;span class="s2">
&lt;/span>&lt;span class="s2"> Returns:
&lt;/span>&lt;span class="s2"> bool: æ ‘æ˜¯å¦å¹³è¡¡
&lt;/span>&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">root&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">balance&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">True&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">insert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;insert new value
&lt;/span>&lt;span class="s2">
&lt;/span>&lt;span class="s2"> Args:
&lt;/span>&lt;span class="s2"> value (int): new value
&lt;/span>&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">root&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">root&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">AVLTreeNode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">insert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1"># AVL æ ‘æ—‹è½¬åæ ¹èŠ‚ç‚¹å¯èƒ½ä¸å†æ˜¯ç°åœ¨è¿™ä¸ªèŠ‚ç‚¹ï¼Œéœ€è¦é‡æ–°å¯»æ‰¾æ ¹èŠ‚ç‚¹&lt;/span>
&lt;span class="n">top&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">root&lt;/span>
&lt;span class="k">while&lt;/span> &lt;span class="n">top&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parent&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">top&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">top&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parent&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">root&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">top&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="nb">bool&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;search a value
&lt;/span>&lt;span class="s2">
&lt;/span>&lt;span class="s2"> Args:
&lt;/span>&lt;span class="s2"> value (int): searching value
&lt;/span>&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">root&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">False&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>AVLæ ‘åªè¦ç†è§£å’Œå·¦å³æ—‹è½¬çš„æ–¹æ³•å’Œä½œç”¨ï¼Œå°±ä¸éš¾ç†è§£å·¦å³æ—‹è½¬ä¸åŒæ—‹è½¬çš„æ„ä¹‰äº†ã€‚&lt;/p>
&lt;p>å•æ¬¡æ—‹è½¬çš„ç›®çš„éƒ½æ˜¯å°†ä¸¤ä¾§å­æ ‘ï¼Œä¸€é¢—å­æ ‘é«˜åº¦+1ï¼Œä¸€é¢—å­æ ‘é«˜åº¦-1ï¼Œå°†é«˜åº¦ç›¸å·®2çš„ä¸¤é¢—å­æ ‘é‡æ–°å¹³è¡¡ã€‚&lt;/p>
&lt;p>å•æ¬¡æ—‹è½¬çš„é™åˆ¶æ˜¯åªèƒ½é™ä½å­æ ‘ä¸­ä¸€é¢—å­æ ‘çš„é«˜åº¦ï¼Œå·¦å­æ ‘çš„å·¦å­æ ‘æˆ–å³å­æ ‘çš„å³å­æ ‘ï¼Œæ‰€ä»¥ä¸€æ—¦å‡ºç°å·¦å³å­æ ‘ä¸­æœ€é«˜çš„å­æ ‘ä¸æ˜¯å·¦-å·¦æˆ–å³-å³ï¼Œå•æ¬¡æ—‹è½¬å°±ä¸èƒ½é‡æ–°å¹³è¡¡ã€‚å¯¹è¿™ç§æƒ…å†µï¼Œå…ˆæ—‹è½¬å­æ ‘ï¼Œä»¤å·¦-å·¦æˆ–å³-å³æˆä¸ºæœ€é«˜çš„å­æ ‘åï¼Œå†å¯¹æ ¹èŠ‚ç‚¹æ—‹è½¬ï¼Œå°±èƒ½é‡æ–°å¹³è¡¡äº†ã€‚&lt;/p></description></item><item><title>2022æ–°å¹´ç¬¬ä¸€ç¯‡åšå®¢</title><link>https://nnnewb.github.io/blog/p/first-blog-in-2022/</link><pubDate>Wed, 09 Feb 2022 09:24:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/first-blog-in-2022/</guid><description>&lt;h2 id="ä¸€">ä¸€&lt;/h2>
&lt;p>å…¶å®å¹´å‰è¿˜æœ‰ä¸€ç¯‡å†™äº†è›®é•¿çš„ï¼Œä½†å› ä¸ºç§ç§åŸå› åæ­£å‡æœŸå†…æ˜¯æ²¡ç»§ç»­åŠ¨ç¬”å†™å®Œï¼Œä»Šå¤©æœ¬æ¥æ‰“ç®—ç»§ç»­å†™ï¼Œä½†æ˜¯çœ‹äº†çœ¼å¼€å¤´ï¼Œè¿˜æ˜¯æŠŠå…¨æ–‡ ctrl+a delete äº†ã€‚&lt;/p>
&lt;p>è¿™æ¬¡å°±çŸ­ä¸€ç‚¹ã€‚&lt;/p>
&lt;h2 id="äºŒ">äºŒ&lt;/h2>
&lt;p>å›é¡¾è¿‡å»ï¼Œ2021å¹´å¯¹æˆ‘è€Œè¨€æ˜¯æ€æ ·çš„ä¸€å¹´ï¼Ÿ&lt;/p>
&lt;p>å½“æˆ‘é—®è‡ªå·±è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘æ‰å‘ç°ä¼¼ä¹æ²¡æœ‰ä¸€ä¸ªèƒ½è„±å£è€Œå‡ºçš„ç­”æ¡ˆã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 564;
flex-basis: 1355px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/first-blog-in-2022/image-20220209093132174.png" data-size="870x154">
&lt;img src="https://nnnewb.github.io/blog/blog/p/first-blog-in-2022/image-20220209093132174.png"
width="870"
height="154"
srcset="https://nnnewb.github.io/blog/blog/p/first-blog-in-2022/image-20220209093132174_hu312baa1af15bc0284994619b812524f6_3754_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/first-blog-in-2022/image-20220209093132174_hu312baa1af15bc0284994619b812524f6_3754_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20220209093132174">
&lt;/a>
&lt;figcaption>image-20220209093132174&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æ™®æ™®é€šé€šåœ°æ­£å¸¸å·¥ä½œï¼Œé¡ºä¾¿ä¹Ÿæ‘¸æ‘¸é±¼ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 495;
flex-basis: 1188px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/first-blog-in-2022/image-20220209093249061.png" data-size="728x147">
&lt;img src="https://nnnewb.github.io/blog/blog/p/first-blog-in-2022/image-20220209093249061.png"
width="728"
height="147"
srcset="https://nnnewb.github.io/blog/blog/p/first-blog-in-2022/image-20220209093249061_huc19f43cf1d7a348ef7c6f534f3f07c4a_8775_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/first-blog-in-2022/image-20220209093249061_huc19f43cf1d7a348ef7c6f534f3f07c4a_8775_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20220209093249061">
&lt;/a>
&lt;figcaption>image-20220209093249061&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å¶å°”ä¹Ÿä¸ŠGitHubçœ‹ä¸¤çœ¼ï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆæ–°é²œç©æ„å„¿ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 350;
flex-basis: 840px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/first-blog-in-2022/image-20220209093447327.png" data-size="452x129">
&lt;img src="https://nnnewb.github.io/blog/blog/p/first-blog-in-2022/image-20220209093447327.png"
width="452"
height="129"
srcset="https://nnnewb.github.io/blog/blog/p/first-blog-in-2022/image-20220209093447327_hucfe56099574b6d1070a7ba458db01ed2_7134_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/first-blog-in-2022/image-20220209093447327_hucfe56099574b6d1070a7ba458db01ed2_7134_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20220209093447327">
&lt;/a>
&lt;figcaption>image-20220209093447327&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å­¦äº†ç‚¹æ²¡ç”¨çš„é€†å‘æŠ€æœ¯ï¼Œdemoä¹Ÿå‹‰å¼ºå‡‘å‡º9+1ä¸ªstarã€‚ä¸è¿‡è¶è¿™ä¸ªæœºä¼šå€’æ˜¯äº†è§£äº†ä¸‹x86æ±‡ç¼–è¯­è¨€ï¼Œå§‘ä¸”ç®—æ˜¯ä¸ªæ²¡ä»€ä¹ˆåµç”¨çš„è¿›æ­¥ï¼Œä¸»æµ64ä½çš„æ±‡ç¼–å’Œarmçš„æ±‡ç¼–è¿˜æ˜¯ä¸æ‡‚ï¼Œx86ä¹Ÿåªèƒ½ç®—æ˜¯ç›²äººæ‘¸è±¡ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 297;
flex-basis: 714px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/first-blog-in-2022/image-20220209093903198.png" data-size="366x123">
&lt;img src="https://nnnewb.github.io/blog/blog/p/first-blog-in-2022/image-20220209093903198.png"
width="366"
height="123"
srcset="https://nnnewb.github.io/blog/blog/p/first-blog-in-2022/image-20220209093903198_hu1a597d42e008a51b6b7e3058561fedc4_7207_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/first-blog-in-2022/image-20220209093903198_hu1a597d42e008a51b6b7e3058561fedc4_7207_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20220209093903198">
&lt;/a>
&lt;figcaption>image-20220209093903198&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>åˆä¸€ä¸ªç©å…·ï¼Œè¿™ç±»ç©å…·å¤ªå¤šäº†ã€‚æˆ‘æ°´å¹³ä¸å¤Ÿï¼Œå®Œæˆåº¦ä¹Ÿä½ï¼Œåªèƒ½è¯´æ˜¯å†™è¿™ä¸ªçš„æ—¶å€™å°±æ˜¯æ‰“å‘æ—¶é—´ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 211;
flex-basis: 507px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/first-blog-in-2022/image-20220209094119262.png" data-size="256x121">
&lt;img src="https://nnnewb.github.io/blog/blog/p/first-blog-in-2022/image-20220209094119262.png"
width="256"
height="121"
srcset="https://nnnewb.github.io/blog/blog/p/first-blog-in-2022/image-20220209094119262_huba5eeb6809b4946e971e1798bbd4c32c_4701_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/first-blog-in-2022/image-20220209094119262_huba5eeb6809b4946e971e1798bbd4c32c_4701_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20220209094119262">
&lt;/a>
&lt;figcaption>image-20220209094119262&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æœ¬æ¥ä¸æ˜¯å¾ˆçœ‹å¾—ä¸Š dtm è¿™ä¸ªé¡¹ç›®ã€‚ä¸ä¸ºåˆ«çš„ï¼Œå°±æ˜¯è§‰å¾—ä½œè€… segmentfault ä¸Šåˆ·åšæ–‡å®£ä¼ è‡ªå·±çš„æ¡†æ¶æœ‰ç§ä¿é™©æ¨é”€å‘˜çš„æ„Ÿè§‰ï¼Œè®©äººè§‰å¾—ä¸é è°±ã€‚ä½†è¿˜æ˜¯è€å®å»çœ‹äº†ä»£ç ï¼Œæ¯•ç«Ÿæ¯”èµ· Java å†™å¾— seata ä¹‹ç±»çš„æ¡†æ¶ï¼Œdtm å°è£…æ¯”è¾ƒè–„ï¼Œæºç ç¨å¾®å¥½è¯»ä¸€ç‚¹ã€‚&lt;/p>
&lt;p>å®é™…è¯»èµ·æ¥æ„Ÿè§‰è¿˜æ˜¯æœ‰ç‚¹æ··ä¹±ï¼Œæœ€åç…§ç€ dtm æ–‡æ¡£çš„æ—¶åºå›¾å†™äº†ä¸ªæ¡ˆä¾‹ï¼Œé…ç½®äº†opentelemetryã€‚åˆ†å¸ƒå¼è¿½è¸ªçœŸçš„å¾ˆå¥½ç”¨ï¼Œè®²çœŸï¼Œè¦æ˜¯å•ä½“åº”ç”¨ä¹Ÿèƒ½è·Ÿç€å‡½æ•°è¿½è¸ªå‡ºè¿™æ ·ä¸€ä¸ªå›¾å°±ç»äº†ã€‚æˆ‘è§‰å¾—å¯ä»¥æ‹¿ python å¼€åˆ€è¯•è¯•ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 270;
flex-basis: 650px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/first-blog-in-2022/image-20220209095328828.png" data-size="355x131">
&lt;img src="https://nnnewb.github.io/blog/blog/p/first-blog-in-2022/image-20220209095328828.png"
width="355"
height="131"
srcset="https://nnnewb.github.io/blog/blog/p/first-blog-in-2022/image-20220209095328828_hu09413e63593e9e88b5002d57426f4aa7_9471_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/first-blog-in-2022/image-20220209095328828_hu09413e63593e9e88b5002d57426f4aa7_9471_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20220209095328828">
&lt;/a>
&lt;figcaption>image-20220209095328828&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å°è¯•å…¥é—¨å¯†ç å­¦ï¼Œä½†æ•°å­¦åŸºç¡€ä¸å¥½ï¼Œä¸ºäº†ææ˜ç™½å¸Œå°”å¯†ç ç”¨åˆ°çš„çŸ©é˜µè¿ç®—ç¿»äº†åŠå¤©æœç´¢å¼•æ“æ‰å†™å‡ºæ¥ã€‚ç»“æœè¿˜æ˜¯æ²¡ç»§ç»­å­¦ä¸‹å»ã€‚2022ä¹Ÿè®¸ç»§ç»­çœ‹ï¼Ÿå¥½æ­¹æŠŠä¼ ç»Ÿå¯†ç é‡Œçš„DESã€AESå­¦å®Œå§ï¼Œä¸æ±‚èƒ½æ‰‹å†™ï¼Œå¤§æ¦‚èƒ½çœ‹æ˜ç™½è¿‡ç¨‹å°±å¥½ã€‚è¦æ˜¯èƒ½å†æŠŠåŸç†æ‡‚ä¸ªå¤§æ¦‚å°±æ›´å¥½äº†ã€‚&lt;/p>
&lt;p>è‡³äºåˆ«çš„ï¼Œä¹Ÿè®¸æˆ‘èƒ½æŠ¥èœåä¸€æ ·æä¸€å¤§å †åå­—ï¼Œä½†ç»ˆç©¶éª—ä¸äº†æˆ‘è‡ªå·±ã€‚æ˜¯ï¼Œ2021ä¸€å¹´æ—¶é—´ï¼Œå„ç§æ‚ä¸ƒæ‚å…«çš„æŠ€æœ¯æ¦‚å¿µå’Œæ–°åè¯ç¢°äº†ä¸€å †ï¼Œä½†æ‚è€Œä¸ç²¾ï¼Œå‡ ä¹æ²¡æœ‰ä»€ä¹ˆçœŸæ­£å¸æ”¶ã€èä¼šè´¯é€šçš„å†…å®¹ã€‚&lt;/p>
&lt;h2 id="ä¸‰">ä¸‰&lt;/h2>
&lt;p>å·¥ä½œå’Œç”Ÿæ´»ä¸Šè¿˜æ˜¯è€ä¸€å¥—ã€‚&lt;/p>
&lt;p>äº§å“ç»ç†èµ°äº†ï¼Œäºæ˜¯éƒ¨é—¨é—´çš„çŸ›ç›¾å’Œç£¨åˆåˆæ¥äº†ã€‚æˆ‘ç”šè‡³ä¸æ„¿æ„ç®¡è¿™ä¸ªå«â€œç£¨åˆâ€ï¼Œæ— éæ˜¯ä¸¤è¾¹ä¸€èµ·æ‘†çƒ‚ç½¢äº†ã€‚æ‰€ä»¥è¿˜æ˜¯åˆ°æ­¤ä¸ºæ­¢ï¼Œåªèƒ½æœŸç›¼å¥½èšå¥½æ•£ï¼Œ2022å°è¯•è·³ä¸ªæ„¿æ„å‡ºæ›´é«˜å·¥èµ„çš„åœ°æ–¹ï¼Œä¹Ÿè®¸èƒ½åœ¨ä¸­å¹´å±æœºå‰æ”’å¤Ÿæœ¬é’±ï¼Œä¸‹åŠç”Ÿæ˜¯è‡ªå·±åšç‚¹ç”Ÿæ„ä¹Ÿå¥½ï¼Œå®‰å¿ƒæ‰“å·¥ä¹Ÿå¥½ï¼Œè‡³å°‘èƒ½å®‰é¡¿å¥½ä¸€å®¶äººï¼Œå³ä¾¿ä¸èƒ½å¯Œè¶³ï¼Œä¹Ÿå¾—æ¸©é¥±ã€‚çœŸå¿ƒå¸Œæœ›è¿™ä¸ªæ¸ºå°çš„æ„¿æœ›å¯ä»¥å®ç°ã€‚&lt;/p>
&lt;p>ç”Ÿæ´»ä¸Šï¼Œå¹´åº•æ‰æ”¶åˆ°ä¸€ä¸ªåæ¶ˆæ¯ï¼Œçˆ·çˆ·ç—…äº†ï¼Œå¯èƒ½æ˜¯è‚ºç™Œã€‚å¾ˆéš¾æè¿°å¬åˆ°è¿™ä¸ªæ¶ˆæ¯çš„æ—¶å€™æˆ‘çš„å¿ƒæƒ…ã€‚ä¸Šåˆä¸­çš„æ—¶å€™æˆ‘çš„æ›¾ç¥–çˆ¶å»ä¸–äº†ï¼Œæˆ‘å’Œæ›¾ç¥–çˆ¶äº¤æµæ¥è§¦å¾ˆå°‘ï¼Œä½†è¿˜æ˜¯æœ‰ç§å¿ƒé‡Œç¼ºäº†ä¸€å—çš„æ„Ÿè§‰ã€‚&lt;/p>
&lt;p>æ˜¯ï¼Œäººç»ˆæœ‰ä¸€æ­»ã€‚ä½†å‡ºå¥‡çš„æ˜¯æˆ‘ä¸€ç‚¹ä¹Ÿæ²¡æƒ³ä»€ä¹ˆè½»äºé¸¿æ¯›é‡äºæ³°å±±ã€‚æ­»äº¡å°±åªæ˜¯æ­»äº¡è€Œå·²ï¼Œæ²¡æœ‰æ„ä¹‰ï¼Œä»€ä¹ˆä¹Ÿæ²¡æœ‰ã€‚æ—¶é—´æœ€ç»ˆä¼šæŠšå¹³ä¸€åˆ‡ã€‚&lt;/p>
&lt;p>å¥½äº†ã€‚&lt;/p>
&lt;p>2022ï¼Œè¿˜æ˜¯ç¥æ„¿çˆ·çˆ·ä»–æ‰‹æœ¯é¡ºåˆ©ï¼Œèƒ½æ´»åˆ°120å²ã€‚&lt;/p>
&lt;h2 id="å››">å››&lt;/h2>
&lt;p>è¿˜æ˜¯è¦å±•æœ›ä¸‹æœªæ¥çš„ã€‚&lt;/p>
&lt;p>2022å¹´ï¼Œå¾ˆå¿«å°±è¦26å‘¨å²äº†ï¼Œè¿˜æ˜¯å•èº«ï¼Œä¸€å¹´çš„æ”¶å…¥å¤§æ¦‚èƒ½åœ¨å¹¿å·ä¹°ä¸€ä¸¤å¹³ç±³çš„å«ç”Ÿé—´ï¼Œå­˜æ¬¾ä¸æ¯”ä¸€é—´å«ç”Ÿé—´çš„ä»·å€¼å¤šå¤šå°‘ã€‚æœ‰ä¸€ç‚¹ç„¦è™‘ã€‚&lt;/p>
&lt;p>ç„¦è™‘çš„åŸå› åœ¨äºæˆ‘è§‰å¾—è‡ªå·±é…å¾—ä¸Šæ›´é«˜çš„å·¥èµ„ï¼Œæˆ–è€…è¯´ï¼Œæ›´å¥½çš„ç”Ÿæ´»ï¼Œæœ‰çœ‹å¾—åˆ°å¸Œæœ›çš„æœªæ¥ã€‚ä½†ç†æƒ³å’Œç°å®çš„çŸ›ç›¾å§‹ç»ˆæ— æ³•è§£å†³ã€‚&lt;/p>
&lt;p>ä¸è¯´é‚£ä¹ˆå¤šäº†ã€‚&lt;/p>
&lt;p>ä»Šå¹´æœ‰è·³æ§½çš„æƒ³æ³•ï¼Œä¹Ÿæœ‰è€ƒä¸ªç³»ç»Ÿåˆ†æå¸ˆè¯ä¹¦çš„æƒ³æ³•ï¼Œä½†ä¸¤è€…ææ€•ä¸å¥½å…¼é¡¾ã€‚è¿˜å¥½çš„æ˜¯ç³»ç»Ÿåˆ†æå¸ˆè€ƒè¯•åœ¨5æœˆï¼Œè¿™æ®µæ—¶é—´æ¥ä¸ªç™¾æ—¥å†²åˆºï¼Œè¿æ°”å¥½çš„è¯æœ‰æœºä¼šæ‹¿åˆ°è¯ä¹¦ï¼Œå†åœ¨ä¸‹åŠå¹´é è¯ä¹¦è·³ä¸ªæ›´é«˜è–ªçš„èŒä½ã€‚è¿æ°”ä¸å¥½çš„è¯ï¼Œä»Šå¹´æ²¡è€ƒä¸Šï¼Œä¸‹åŠå¹´è·³æ§½è¿˜æœ‰æ‚¬å¿µï¼Œé‚£å°±æ˜å¹´å†è¯´äº†ã€‚&lt;/p>
&lt;p>å¦å¤–æ›´æ–°ç®€å†çš„æ—¶å€™å‘ç°ï¼Œå¤šå†™ç‚¹åšå®¢è¿˜æ˜¯æŒºå”¬äººçš„ã€‚21å¹´ä¸‹åŠå¹´å‡ ä¸ªæœˆå†™äº†40ç¯‡ï¼Œ2022å¹´ç»§ç»­ä¿æŒçš„è¯èµ·ç ä¸€å¹´ä¸€ç™¾ç¯‡ä¸è¿‡åˆ†å§ï¼ŒåšæŒå¤šå†™å‡ ç¯‡ï¼Œç¬”è€•ä¸è¾ã€‚&lt;/p>
&lt;p>æœ€å¥½å†å‚ä¸ä¸‹çŸ¥åçš„å¼€æºé¡¹ç›®ï¼Œå‘å‡ ä¸ªPRã€‚&lt;/p>
&lt;p>å°è¯´ä¹Ÿæƒ³å†™ï¼ŒçŸ­ç¯‡æ•´ä¸ªåå‡ ä¸‡å­—æ€»å¾—æœ‰ã€‚&lt;/p>
&lt;p>æ¢¦æƒ³å˜›ï¼Œè¿˜æ˜¯è¦æœ‰çš„ã€‚&lt;/p>
&lt;h2 id="æ¥å§2022">æ¥å§ï¼Œ2022ï¼&lt;/h2></description></item><item><title>è®°ä¸€æ¬¡APIå“åº”æ—¶é—´ä¼˜åŒ–</title><link>https://nnnewb.github.io/blog/p/an-api-response-time-optimize/</link><pubDate>Fri, 31 Dec 2021 18:30:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/an-api-response-time-optimize/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>åˆšæ¥æ‰‹ç®¡ç†åå°çš„åç«¯æœåŠ¡ï¼Œå…ˆéšä¾¿æŒ‘ä¸ªä»€ä¹ˆä¸œè¥¿ä¸‹æ‰‹çœ‹çœ‹ã€‚æ­£å¥½æ³¨æ„åˆ°ä¸€ä¸ªç®€å•çš„æ¥å£è¿”å›æ—¶é—´éƒ½è›®é•¿çš„ï¼Œäºæ˜¯æ‹¿åˆšä» opentelemetry çš„ issue/pr é‡ŒæŠ„æ¥çš„ sqlmw åŒ…è£…é©±åŠ¨æ¥åˆ†æä¼˜åŒ–ä¸‹æ€§èƒ½ã€‚&lt;/p>
&lt;h2 id="0x01-æ€§èƒ½åˆ†æ">0x01 æ€§èƒ½åˆ†æ&lt;/h2>
&lt;h3 id="é¢„åˆ¤">é¢„åˆ¤&lt;/h3>
&lt;p>ä¸‹æ‰‹å‰é¢„ä¼°ä¸‹å¯èƒ½å­˜åœ¨ç“¶é¢ˆçš„åœ°æ–¹ã€‚å¯¹äºè¿™æ¬¡ä¸‹æ‰‹çš„æ¥å£ï¼ˆ&lt;code>get_users&lt;/code>ï¼‰ï¼Œæ•´ä¸ªå®ç°ä¹Ÿæ²¡å‡ è¡Œä»£ç ï¼Œåªæœ‰ä¸¤ä¸‰ä¸ªæŸ¥è¯¢ï¼Œæ•°æ®é‡ä¹Ÿä¸å¤§ï¼Œä½†æ˜¯è€—æ—¶æœ‰80ms+ã€‚&lt;/p>
&lt;p>å…¶ä»–æ¥å£æœ‰å¿«æœ‰æ…¢ï¼Œå¹¶æ²¡æœ‰è¡¨ç°å‡ºåŒæ—¶å¢åŠ è€—æ—¶ï¼Œè€Œä¸”å¼€å‘æœåŠ¡å™¨æ¶åœ¨å†…ç½‘ï¼Œæ’é™¤ç½‘ç»œåŸå› ï¼Œå¤§æ¦‚è¿˜æ˜¯æœåŠ¡æœ¬èº«çš„å­˜åœ¨çš„é—®é¢˜ã€‚äºæ˜¯è€ƒè™‘ç“¶é¢ˆåœ¨æ•°æ®åº“æˆ–ä»£ç ä¸­ï¼Œä½†å…·ä½“è‚¯å®šæ˜¯è¦çœ‹ä»£ç å»åˆ†æçš„ã€‚æ—¢ç„¶åˆ¤æ–­æ˜¯ä»£ç é‡Œçš„é—®é¢˜ï¼Œé‚£ä¸‹ä¸€æ­¥å°±æ˜¯æµ‹é‡ä¸‹è€—æ—¶æƒ…å†µäº†ã€‚&lt;/p>
&lt;p>å¯¹äºgoï¼Œ&lt;code>pprof&lt;/code>è™½ç„¶æ˜¯ä¸ªä¸é”™çš„ä¸»æ„ï¼Œä½†å®è¯è¯´éƒ¨ç½²åœ¨ kubernetes é‡Œï¼Œé… &lt;code>pprof&lt;/code> å»æ‹‰ç»“æœæœ‰ç‚¹éº»çƒ¦ï¼Œè€Œä¸”è¿˜æœ‰ç‚¹ç‚¹ç”¨ä¸æƒ¯ã€‚æ­£å¥½è¿™ä¸ªé¡¹ç›®é‡Œæ—©å°±é…ç½®äº† &lt;code>opentracing&lt;/code>+&lt;code>jaeger&lt;/code>åšåˆ†å¸ƒå¼è·Ÿè¸ªï¼Œæ‰€ä»¥å°±ç›´æ¥æŠ„ä¸€ä¸‹ opentelemetry çš„ &lt;a class="link" href="https://github.com/seslattery/otelsql/blob/master/otelsql.go" target="_blank" rel="noopener"
>otelsql&lt;/a> ï¼ŒæŠŠSQLæŸ¥è¯¢çš„è¯¦ç»†è€—æ—¶æƒ…å†µè®°å½•ä¸‹æ¥ï¼Œå°±å¯ä»¥å¼€å§‹åˆ†æäº†ã€‚&lt;/p>
&lt;h3 id="opentracingæ”¶é›†æ•°æ®">opentracingæ”¶é›†æ•°æ®&lt;/h3>
&lt;p>&lt;code>otelsql&lt;/code> åŸç†æ˜¯ç”¨ &lt;a class="link" href="https://github.com/ngrok/sqlmw" target="_blank" rel="noopener"
>sqlmw&lt;/a> åœ¨ sql é©±åŠ¨å±‚çº§ä¸Šè¿›è¡ŒåŒ…è£…&lt;code>sql ==&amp;gt; sqlmw.Driver{mysql.Driver}&lt;/code> ã€‚goçš„&lt;code>sql&lt;/code>è°ƒç”¨&lt;code>sqlmw.Driver&lt;/code>ï¼Œ&lt;code>sqlmw.Driver&lt;/code>è°ƒç”¨&lt;code>mysql.Driver&lt;/code>ï¼Œå¦‚æ­¤è€Œå·²ï¼Œå…·ä½“ä¸è§£é‡Šã€‚&lt;/p>
&lt;p>ä»&lt;code>otelsql&lt;/code>å€Ÿé‰´ä¸‹æ€è·¯å³å¯ï¼Œç°åœ¨ &lt;code>opentracing&lt;/code> å·²ç»å’Œ &lt;code>opencensus&lt;/code> åˆå¹¶æˆäº† &lt;code>opentelemetry&lt;/code>ï¼Œä½†é¡¹ç›®ä¹Ÿæ²¡æ³•è¯´å‡çº§å°±å‡çº§ï¼Œæ¯•ç«Ÿé¡¹ç›®æ¶æ„è®¾è®¡ç¨€çƒ‚ï¼Œå¤ªå¤šåœ°æ–¹å’Œ &lt;code>opentracing&lt;/code>ã€&lt;code>jaeger-client&lt;/code> å¼ºè€¦åˆäº†ã€‚æŠŠ&lt;code>otelsql&lt;/code>é‡Œç”¨&lt;code>sqlmw&lt;/code>çš„éƒ¨åˆ†æŠ„å‡ºæ¥ï¼Œæ”¹æˆ&lt;code>opentracing&lt;/code>çš„æ–¹å¼åˆ›å»º&lt;code>span&lt;/code>å®Œäº‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">in&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">sqlInterceptor&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">ConnExecContext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">conn&lt;/span> &lt;span class="nx">driver&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ExecerContext&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">query&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">args&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">driver&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NamedValue&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">driver&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">span&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ctx&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">opentracing&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">StartSpanFromContext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;ConnExecContext&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">span&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Finish&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">span&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">LogKV&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;sql.query&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">query&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ExecContext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">query&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">args&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦‚æ­¤ä¸€æ¥ï¼Œ å½“goçš„&lt;code>sql&lt;/code>åº“è®¿é—®æ•°æ®åº“çš„æ—¶å€™ï¼Œå°±ä¼šåœ¨&lt;code>jaeger&lt;/code>é‡Œè®°å½•ä¸€ä¸ª&lt;code>span&lt;/code>ï¼Œå¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°è€—æ—¶æƒ…å†µã€‚&lt;/p>
&lt;h3 id="åˆ†æ">åˆ†æ&lt;/h3>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 207;
flex-basis: 497px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/an-api-response-time-optimize/image-20211231103911728.png" data-size="1166x563">
&lt;img src="https://nnnewb.github.io/blog/blog/p/an-api-response-time-optimize/image-20211231103911728.png"
width="1166"
height="563"
srcset="https://nnnewb.github.io/blog/blog/p/an-api-response-time-optimize/image-20211231103911728_hu4ca051d63fb418ff00457f384002403d_37132_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/an-api-response-time-optimize/image-20211231103911728_hu4ca051d63fb418ff00457f384002403d_37132_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211231103911728">
&lt;/a>
&lt;figcaption>image-20211231103911728&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æ”¶é›†åˆ°è€—æ—¶æƒ…å†µåå¼€å§‹è§‚å¯Ÿï¼Œæ³¨æ„åˆ°ä¸¤ä¸ªé—®é¢˜ï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;code>ConnectorConnect&lt;/code> åœ¨æ¯ä¸ªè¯·æ±‚å‰å‡ºç°ï¼Œæ¯æ¬¡è€—æ—¶ 2ms å·¦å³ã€‚ä½† &lt;code>sql&lt;/code> æ˜¯æœ‰è¿æ¥æ± çš„ï¼Œè¿™é‡Œæ¯æ¬¡æ‰§è¡ŒæŸ¥è¯¢éƒ½äº§ç”Ÿä¸€æ¬¡è¿æ¥æ˜¾ç„¶ä¸å¯¹åŠ²ã€‚&lt;/li>
&lt;li>&lt;code>StmtQueryContext&lt;/code> å‡ºç°ä¸€ä¸ªè€—æ—¶æé•¿çš„æŸ¥è¯¢ï¼Œå æ®æ¥è¿‘1/2çš„è¯·æ±‚è€—æ—¶ï¼Œè¿™æ¡æŸ¥è¯¢å°±æ˜¯ä¸»è¦ç“¶é¢ˆã€‚&lt;/li>
&lt;/ol>
&lt;p>æ…¢æŸ¥è¯¢çš„SQLå¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">count&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">user&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">where&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">role&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">and&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">create_timestamp&lt;/span>&lt;span class="o">&amp;gt;?&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">and&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">create_timestamp&lt;/span>&lt;span class="o">&amp;lt;?&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ˜¯ä¸€ä¸ªç®€å•çš„ &lt;code>select count(1)&lt;/code> æŸ¥è¯¢ï¼Œåˆæ­¥è€ƒè™‘æ˜¯ &lt;code>where&lt;/code> é‡Œå°‘äº†ç´¢å¼•ã€‚&lt;/p>
&lt;h2 id="0x02-ä¼˜åŒ–">0x02 ä¼˜åŒ–&lt;/h2>
&lt;h3 id="ç´¢å¼•ä¼˜åŒ–">ç´¢å¼•ä¼˜åŒ–&lt;/h3>
&lt;p>æ—¢ç„¶å°‘ç´¢å¼•ï¼Œé‚£å°±è€ƒè™‘ä¸‹åŠ ç´¢å¼•ã€‚çœ‹äº†ä¸‹æ•°æ®åº“ï¼Œ&lt;code>role&lt;/code>å’Œ&lt;code>create_timestamp&lt;/code>å­—æ®µéƒ½æ²¡æœ‰ç´¢å¼•ï¼Œäºæ˜¯å…ˆåˆ†åˆ«åŠ ä¸Šäº†ç´¢å¼•ï¼Œå† &lt;code>explain&lt;/code> ï¼Œå‘ç°æŸ¥è¯¢ç±»å‹å·²ç»å˜æˆäº† &lt;code>ref&lt;/code> ã€‚å†è¿è¡ŒæŸ¥è¯¢ï¼Œå‘ç°è€—æ—¶ä¾ç„¶æœ‰ 20ms+ã€‚&lt;/p>
&lt;p>å‚è€ƒ &lt;a class="link" href="https://dev.mysql.com/doc/refman/5.7/en/multiple-column-indexes.html" target="_blank" rel="noopener"
>multiple-column index&lt;/a> ä¸­çš„è¯ï¼š&lt;/p>
&lt;blockquote>
&lt;p>MySQL can use multiple-column indexes for queries that test all the columns in the index, or queries that test just the first column, the first two columns, the first three columns, and so on. If you specify the columns in the right order in the index definition, a single composite index can speed up several kinds of queries on the same table.&lt;/p>
&lt;/blockquote>
&lt;p>æ–‡æ¡£ä¸­è¿˜è¯´ï¼š&lt;/p>
&lt;blockquote>
&lt;p>If a multiple-column index exists on &lt;code>col1&lt;/code> and &lt;code>col2&lt;/code>, the appropriate rows can be fetched directly. If separate single-column indexes exist on &lt;code>col1&lt;/code> and &lt;code>col2&lt;/code>, the optimizer attempts to use the Index Merge optimization (see &lt;a class="link" href="https://dev.mysql.com/doc/refman/5.7/en/index-merge-optimization.html" target="_blank" rel="noopener"
>Section 8.2.1.3, â€œIndex Merge Optimizationâ€&lt;/a>), or attempts to find the most restrictive index by deciding which index excludes more rows and using that index to fetch the rows.&lt;/p>
&lt;/blockquote>
&lt;p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœ&lt;code>role&lt;/code>å’Œ&lt;code>create_timestamp&lt;/code>åˆ†åˆ«æœ‰ç´¢å¼•ï¼Œ&lt;code>mysql&lt;/code>ä¼šå°è¯•ç”¨ &lt;em>Index Merge Optimization&lt;/em> ç®—æ³•æ¥ä¼˜åŒ–æŸ¥è¯¢ã€‚ä½†å¦‚æœæœ‰å¤šåˆ—ç´¢å¼•çš„è¯ï¼Œå°±èƒ½ç›´æ¥è·å–ï¼ˆæ–‡æ¡£é‡Œçš„åœºæ™¯èƒ½ç›´æ¥è·å–ï¼Œä½†ä¸Šæ–‡çš„ &lt;code>count(1)&lt;/code> æŸ¥è¯¢åº”è¯¥ä¸è¡Œï¼‰ã€‚&lt;/p>
&lt;p>äºæ˜¯åŠ ä¸Šå¤šåˆ—ç´¢å¼•ï¼Œå†&lt;code>explain&lt;/code>ï¼Œå‘ç°æŸ¥è¯¢ç±»å‹å˜æˆäº†&lt;code>range&lt;/code>ï¼Œå®é™…æ‰§è¡Œå‘ç°æŸ¥è¯¢è€—æ—¶é™ä½è‡³ 5ms å·¦å³ã€‚&lt;/p>
&lt;h3 id="è¿æ¥æ± ä¼˜åŒ–">è¿æ¥æ± ä¼˜åŒ–&lt;/h3>
&lt;p>goçš„&lt;code>sql&lt;/code>åŒ…è‡ªå¸¦è¿æ¥æ± åº”è¯¥æ˜¯æ¯”è¾ƒæ¸…æ¥šçš„ã€‚åŸæœ¬æ€€ç–‘æ˜¯ä¸æ˜¯å¯¹&lt;code>sql.DB&lt;/code>è¿™ä¸ªç»“æ„çš„ç”¨æ³•æœ‰é—®é¢˜ï¼Œä½†ç¿»äº†ä¸‹æºç ï¼Œå‘ç°&lt;code>sql.DB.ExecContext&lt;/code>ä¹‹ç±»çš„æ¥å£éƒ½ä¼šé€šè¿‡è¿æ¥æ± å–è¿æ¥ï¼Œå®Œæˆåè¿”å›è¿æ¥æ± ã€‚æ‰€ä»¥ç†è®ºä¸Šæ¥è¯´éƒ½åº”è¯¥èµ°è¿æ¥æ± çš„è¿æ¥ï¼Œè€Œä¸æ˜¯æ¯æ¬¡æŸ¥è¯¢éƒ½åˆ›å»ºâ€”â€”é™¤éè¿æ¥æ± é‡Œæ²¡æœ‰å¯ç”¨çš„è¿æ¥äº†ã€‚å¦å¤–ä¹Ÿè°·æ­Œäº†ä¸€åœˆï¼Œ&lt;code>sql.DB&lt;/code> ä¼¼ä¹ä¹Ÿæ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„æœ€ä½³å®è·µï¼Œå¹¶æ²¡æœ‰äººæåˆ°è¦æ‰‹åŠ¨&lt;code>DB.Conn&lt;/code>å–è¿æ¥åè‡ªå·±å¤„ç†ã€‚&lt;/p>
&lt;p>äºæ˜¯åˆæ­¥æ€€ç–‘ä¸‹æ˜¯ä¸æ˜¯å“ªé‡Œè®¾ç½®äº†è¿æ¥æ± å±æ€§å‡ºäº†é—®é¢˜ã€‚é€šè¿‡æ’æŸ¥æºç ä¸­è®¾ç½®è¿æ¥æ± å±æ€§çš„åœ°æ–¹ï¼Œå‘ç°ä¸€ä¸ªè‡ªå·±åŸ‹ä¸‹çš„å‘ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">if&lt;/span> &lt;span class="nx">env&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DEBUG&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">mysqldb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetMaxIdleConns&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">cfg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">mysql&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ParseDSN&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">host&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">cfg&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">mysql&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Config&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nf">StartObverseSQLConnPool&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">cfg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DBName&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">mysqlDB&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Duration&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å› ä¸ºæˆ‘å¸è¿™ä¸ªé¡¹ç›®æ²¡æœ‰é…ç½® metrics æ”¶é›†å’Œåˆ†æï¼Œè‡ªç„¶ä¹Ÿæ²¡æ”¶é›†æœåŠ¡çš„è¿æ¥æ± æƒ…å†µã€‚æ‰€ä»¥å½“åˆå…¥èŒåé‡åˆ°ä¸€ä¸ªå¥‡æ€ªçš„è¿æ¥æ± è€—å°½ï¼ŒæœåŠ¡å‡æ­»ï¼Œè°ƒç”¨æ ˆå…¨éƒ¨å¡åœ¨è¿æ¥æ± ä¸Šçš„é—®é¢˜æ—¶ï¼Œä¸ºäº†åˆ¤æ–­æ˜¯ä¸æ˜¯å‡ºç°è¿æ¥æ³„éœ²ï¼Œå†™äº†ä¸ªgoroutineå»ç›‘æµ‹è¿æ¥æ± é‡Œè¿æ¥è·å–å’Œé‡Šæ”¾çš„æƒ…å†µ&amp;hellip;&lt;/p>
&lt;p>ä¸ºäº†è°ƒè¯•æ–¹ä¾¿ï¼Œè¿˜æŠŠ&lt;code>SetMaxIdleConns&lt;/code>è®¾ç½®ä¸ºäº†0ã€‚&lt;/p>
&lt;p>äºæ˜¯åˆæ­¥æ€€ç–‘å°±æ˜¯è¿™ä¸ªåŸå› å¯¼è‡´è¿æ¥æ± ç½¢å·¥ï¼Œå°†æ•´æ®µè°ƒè¯•ä»£ç æ³¨é‡Šæ‰ä¹‹åï¼Œå†æ¬¡è®¿é—®æ¥å£ï¼Œå“åº”æ—¶é—´é™ä½è‡³9.8msã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 190;
flex-basis: 458px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/an-api-response-time-optimize/image-20211231110219407.png" data-size="212x111">
&lt;img src="https://nnnewb.github.io/blog/blog/p/an-api-response-time-optimize/image-20211231110219407.png"
width="212"
height="111"
srcset="https://nnnewb.github.io/blog/blog/p/an-api-response-time-optimize/image-20211231110219407_hu55ac2a3a3dacd3b69ab961805df24cc9_3194_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/an-api-response-time-optimize/image-20211231110219407_hu55ac2a3a3dacd3b69ab961805df24cc9_3194_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211231110219407">
&lt;/a>
&lt;figcaption>image-20211231110219407&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æœ€å¤§å¤´çš„è€—æ—¶ä¾ç„¶æ˜¯&lt;code>count(1)&lt;/code>æŸ¥è¯¢ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 355;
flex-basis: 854px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/an-api-response-time-optimize/image-20211231110316414.png" data-size="1559x438">
&lt;img src="https://nnnewb.github.io/blog/blog/p/an-api-response-time-optimize/image-20211231110316414.png"
width="1559"
height="438"
srcset="https://nnnewb.github.io/blog/blog/p/an-api-response-time-optimize/image-20211231110316414_hu2a272a2603430f6072c0c8e118d561d2_28788_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/an-api-response-time-optimize/image-20211231110316414_hu2a272a2603430f6072c0c8e118d561d2_28788_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211231110316414">
&lt;/a>
&lt;figcaption>image-20211231110316414&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>é»˜è®¤æƒ…å†µä¸‹ IdleConn åªæœ‰ 2ï¼Œè¶…æ—¶ä¹Ÿæ¯”è¾ƒçŸ­ã€‚å®é™…å‚æ•°åº”è¯¥æ ¹æ®ä¸šåŠ¡è®¿é—®æƒ…å†µæ¥å®‰æ’ã€‚æˆ‘è¿™ä¹Ÿæ²¡ä»€ä¹ˆå¥½çš„è®¡ç®—å…¬å¼ã€‚è¿æ¥æ± å‚æ•°æœ‰é—®é¢˜ä¼šå½±å“å•æ¡SQLçš„åŸºæœ¬è€—æ—¶ï¼Œè¯·æ±‚é‡Œä¸‰å››æ¡æŸ¥è¯¢ï¼Œæ¯æ¡åŠ ä¸Šå‡ ä¸ªmsï¼Œæ•´ä¸ªè¯·æ±‚æ—¶é—´å°±æ‹–é•¿äº†åå‡ msã€‚åœ¨å¾®æœåŠ¡ç³»ç»Ÿé‡Œå½±å“è¿˜å¯èƒ½æ”¾å¤§ï¼Œåˆ«çš„æœåŠ¡è¦æ˜¯å¤šæ¬¡è°ƒç”¨ï¼Œç§¯ç´¯çš„æ—¶å»¶å¯èƒ½å°±è¦ä¸Šç™¾msäº†ã€‚&lt;/p>
&lt;h3 id="ç¼“å­˜ä¼˜åŒ–">ç¼“å­˜ä¼˜åŒ–&lt;/h3>
&lt;p>è¿›ä¸€æ­¥çš„ä¼˜åŒ–æ€è·¯å°±æ˜¯åšç¼“å­˜ã€‚æ˜¯ä¸ºäº†æé«˜æœåŠ¡å“åº”é€Ÿåº¦ï¼Œä¹Ÿæ˜¯ä¸ºäº†æé«˜è´Ÿè½½èƒ½åŠ›ã€å‡è½»æŸ¥è¯¢å‹åŠ›ï¼Œä¿æŠ¤ MySQL æœåŠ¡ã€‚è¿‡å»å¹´è½»æ— çŸ¥çŠ¯è¿‡é”™ï¼Œå°±æ˜¯è€ƒè™‘æ€§èƒ½çš„æ—¶å€™åªå…³æ³¨åˆ°äº†è‡ªå·±å†™çš„ä»£ç ï¼Œè®¤ä¸ºä»£ç è·‘å¾—å¿«é‡è¦â€”â€”æ¯”å¦‚æŠŠ C çš„æ‰§è¡Œæ€§èƒ½å¹ä¸Šå¤©ã€‚ä½†äº‹æƒ…ä»æ¥ä¸æ˜¯è¿™ä¹ˆç®€å•â€”â€”è¾©è¯æ³•è¯´å®äº‹æ±‚æ˜¯ï¼Œè¦å…·ä½“é—®é¢˜å…·ä½“åˆ†æã€‚åç«¯ä»æ¥ä¸æ˜¯â€œæˆ‘çš„ä»£ç â€è¿™ä¹ˆç®€å•ï¼Œå¦‚æœä¸èƒ½ä»æ•´ä¸ªç³»ç»Ÿçš„è§’åº¦å‡ºå‘å‘ç°é—®é¢˜ï¼Œé‚£å°±ç®—æ˜¯ CPU æˆç²¾äº†ä¹Ÿæ²¡è¾™ã€‚&lt;/p>
&lt;p>å¯¹äºå®æ—¶æ€§è¦æ±‚ä¸é«˜çš„æ¥å£ï¼Œå°†æ•°æ®ç¼“å­˜ä¸€æ®µæ—¶é—´æ˜¯ç»å¯¹æ²¡é—®é¢˜çš„ã€‚ä¸è¿‡å› ä¸ºåšç¼“å­˜æ˜¯ä¸ªç³»ç»Ÿæ€§çš„äº‹æƒ…â€”â€”è¦è€ƒè™‘ç¼“å­˜æ›´æ–°çš„å˜›ï¼Œä¹Ÿä¸æ˜¯æ¯ä¸ªæ¥å£éƒ½é€‚åˆç¼“å­˜ï¼Œå®æ—¶æ€§æœ‰è¦æ±‚æˆ–è€…æŸ¥è¯¢å¤ªå¤æ‚çš„è¯å®å¯è€ƒè™‘æ¢æˆ ES ä¸€ç±»çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼ŒæŠŠå‹åŠ›åˆ†æ‘Šåˆ°æ›´å¤šæœºå™¨ä¸Šã€‚å½“ç„¶ä¹Ÿæ„å‘³ç€è¦èŠ±æ›´å¤šçš„é’±ï¼Œæ›´éš¾ç»´æŠ¤ã€‚&lt;/p>
&lt;p>æˆ‘å¸é¡¹ç›®å°±æ˜¯ä¸ªå¾ˆæ²™é›•çš„ä¾‹å­ï¼Œå› ä¸ºæœ€åˆå°±æ²¡è®¾è®¡ç¼“å­˜ï¼Œè¿SQLéƒ½åœ¨ç”¨æ‰‹å·¥æ‹¼æ¥ï¼Œç°åœ¨å¹²è„†å˜æˆäº†æ··ç”¨ &lt;code>xorm&lt;/code> å’Œ &lt;code>sql&lt;/code>ã€‚è™½ç„¶ä¹Ÿå¯ä»¥è€ƒè™‘ä¸‹ç”¨ &lt;code>sqlmw&lt;/code> æ’ä¸ªç¼“å­˜ï¼Œä½†æ¯•ç«Ÿæ²¡éªŒè¯è¿‡ï¼Œåšç¬¬ä¸€ä¸ªåƒèƒèŸ¹çš„ä¹Ÿæ„å‘³ç€è¦ç¬¬ä¸€ä¸ªèƒŒé”…ã€‚&lt;/p>
&lt;p>æ€»ä¹‹ï¼Œè¦åšé‚£å¯ç®€å•äº†ï¼Œç›´æ¥è°ƒ &lt;code>redis&lt;/code> å®¢æˆ·ç«¯ï¼ˆå·²ç»åŒ…è£…è¿‡ä¸€ä¸ª &lt;code>cachetools&lt;/code>ï¼‰è®¾ç½®ä¸‹ç¼“å­˜ï¼Œç»™ä¸ªæ—¶é™å°±å®Œäº†ã€‚ç¼“å­˜è¿‡æœŸçš„æ—¶å€™åŠ ä¸ª &lt;code>redlock&lt;/code>ï¼Œè®©å…¶ä»–å®¢æˆ·ç«¯å…ˆè¿”å›æ—§æ•°æ®ï¼Œæ›´æ–°å®Œè§£é”ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯éƒ½è¿”å›æ–°æ•°æ®ã€‚&lt;/p>
&lt;p>æ›´ç³»ç»ŸåŒ–çš„å¤„ç†ï¼Œå°±è¦è€ƒè™‘ä¸‹æ€ä¹ˆåšä¸€ä¸ªæˆ–å¤šä¸ªæ›´é€šç”¨ï¼ˆå¯¹ä¸šåŠ¡åœºæ™¯è€Œè¨€æ›´é€šç”¨ï¼Œè€Œä¸æ˜¯çœŸçš„å¯¹ &lt;em>æ‰€æœ‰&lt;/em> åœºæ™¯éƒ½é€šç”¨ï¼‰çš„ç¼“å­˜å±‚â€”â€”åœ¨SQLé©±åŠ¨å±‚åšç¼“å­˜ï¼ŸORMå±‚ç¼“å­˜ï¼Ÿåœ¨è¯·æ±‚/å“åº”ä¸­åšç¼“å­˜ï¼Ÿä¸šåŠ¡/æ•°æ®è®¿é—®å±‚ï¼ˆå¦‚&lt;code>DAO&lt;/code>ï¼‰åšç¼“å­˜ï¼Ÿç¼“å­˜ç”¨ä»€ä¹ˆé”®ï¼Ÿæ€ä¹ˆè¦†ç›–å°½å¯èƒ½å¤šçš„æŸ¥è¯¢åœºæ™¯ï¼Ÿæ•´ä¸ªé‡æ„çš„å·¥ç¨‹é‡å¦‚ä½•æŠŠæ¡ï¼Ÿå€¼ä¸å€¼å¾—ï¼Ÿ&lt;/p>
&lt;h2 id="ç»“è®º">ç»“è®º&lt;/h2>
&lt;p>æ”¶é›†æ€§èƒ½æ•°æ®çš„ä¸»è¦æ–¹å¼ï¼š&lt;/p>
&lt;ul>
&lt;li>metrics&lt;/li>
&lt;li>pprof&lt;/li>
&lt;li>opentracing/opentelemetry&lt;/li>
&lt;/ul>
&lt;p>ä¼˜åŒ–æ‰‹æ®µï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>explain&lt;/code> åˆ†ææŸ¥è¯¢ã€ä¼˜åŒ–å’Œå»ºç«‹ç´¢å¼•&lt;/li>
&lt;li>ä¼˜åŒ–è¿æ¥æ± å‚æ•°&lt;/li>
&lt;li>åŠ ç¼“å­˜&lt;/li>
&lt;/ul>
&lt;p>è¿˜æœ‰æœ€é‡è¦çš„ï¼Œ&lt;strong>å…·ä½“é—®é¢˜å…·ä½“åˆ†æ&lt;/strong>ã€‚&lt;/p></description></item><item><title>æ’æŸ¥ä¸€ä¸ªkubectlæ— ååº”çš„é—®é¢˜</title><link>https://nnnewb.github.io/blog/p/why-my-kubectl-not-responding/</link><pubDate>Mon, 27 Dec 2021 15:21:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/why-my-kubectl-not-responding/</guid><description>&lt;p>æ‡’å¾—åˆ†æ®µäº†ï¼Œå°±å½“åšæ˜¯è®²ä¸ªæ•…äº‹å§ã€‚&lt;/p>
&lt;p>èƒŒæ™¯å¤§æ¦‚æ˜¯è¿™æ ·ã€‚&lt;/p>
&lt;p>å†…ç½‘å…¬å…±å¼€å‘æœºä¸Šé…ç½®äº† k3s é›†ç¾¤ï¼ŒåŒæ—¶åç«¯å¼€å‘å·¥ä½œä¹Ÿåœ¨è¿™å°å¼€å‘æœºä¸Šè¿›è¡Œï¼ˆé€šè¿‡vscode remote-sshï¼‰ã€‚å› ä¸ºå…¬å¸å¤ªæŠ é—¨ï¼Œå¼€å‘æœºåªæœ‰117Gç¡¬ç›˜å®¹é‡ï¼Œé™¤å»å¿…è¦çš„å¼€å‘å·¥å…·ã€ç³»ç»Ÿç¯å¢ƒä¹‹ç±»çš„ä¸œè¥¿ï¼Œå®é™…å¯ç”¨ä¸€ç›´æ²¡è¶…è¿‡50%ï¼Œæœºå™¨ä¸Šåˆè·‘äº†å¾ˆå¤šä¸œè¥¿ï¼Œåƒæ˜¯ gitlab-runnerã€dockerçš„registryã€MySQLã€elasticsearchã€å¼€å‘é›†ç¾¤æœåŠ¡ç­‰ç­‰ï¼Œå·®ä¸å¤šæ¯ä¸€ä¸¤ä¸ªæ˜ŸæœŸéƒ½ä¼šå‡ºç° disk-pressure çš„ taintï¼Œå¯¼è‡´ pod è¢« evictedã€‚å®è¯è¯´èƒ½è·‘å°±å¾ˆæ»¡è¶³äº†ï¼Œæ¯•ç«Ÿå…¬å¸æŠ é—¨åˆ°å¼€å‘éƒ¨é—¨çš„ä¸Šè¡Œå¸¦å®½éƒ½è´¼å°ï¼Œå¦‚æœæŠŠé•œåƒæ¨é€åˆ°å…¬ç½‘çš„registryå»éƒ¨ç½²çš„è¯ä½“éªŒæ›´å·®ã€‚&lt;/p>
&lt;p>ä»Šå¤©ï¼ˆå‘¨ä¸€ï¼‰æ¥å…¬å¸ä¹‹åè°ƒäº†ä¸‹gitlab-ciï¼Œç»™ä¸€ä¸ªå‰ç«¯é¡¹ç›®åšæŒç»­éƒ¨ç½²ã€‚å› ä¸ºå‰ç«¯å¯¹kubernetesè¿™å¥—ä¸ç†Ÿæ‚‰ï¼Œä¹Ÿæ²¡æœ‰ç›¸å…³çš„æœåŠ¡å™¨æƒé™ï¼Œæ€»ä¹‹å°±æ˜¯å¾ˆéš¾è®©ä»–ä»¬è‡ªå·±æ¥ã€‚ä½†æ˜¯äº§å“éƒ¨é—¨åˆå–œæ¬¢æé‚£ç§â€œæŒ‰é’®ç§»åˆ°å³ä¸Šè§’â€ã€â€œåŠ ä¸ªå›¾ç‰‡â€ä¹‹ç±»çš„éœ€æ±‚ï¼ˆå¯¹ï¼Œæˆ‘å¸è¿˜æ²¡æœ‰éœ€æ±‚ç®¡ç†ç³»ç»Ÿï¼Œå¼€å‘å°±æ˜¯ä¸ªæ’¸ç çš„æ— æƒ…å·¥å…·äººï¼‰ï¼Œå‰ç«¯è€æ˜¯è¿‡æ¥æ‰¾æˆ‘å»éƒ¨ç½²ä¸‹ç¯å¢ƒï¼Œå°±æå¾—æ‘¸é±¼éƒ½æ‘¸ä¸ç—›å¿«ã€‚&lt;/p>
&lt;p>æ‰€ä»¥ï¼Œå½“å½“å½“~å½“~ï¼Œæ•´ä¸€ä¸ªæŒç»­éƒ¨ç½²å‘—ï¼Œåæ­£æ˜¯ä¸ªçº¯å‰ç«¯é¡¹ç›®ï¼Œä¸ç”¨éƒ¨ç½²é…å¥—çš„åç«¯ä»£ç ï¼Œå†™ä¸ªdockerfileå†å†™ä¸ªhelm chartå°±å·®ä¸å¤šäº†ï¼Œciè°ƒäº†è°ƒæ„å»ºé•œåƒå°±å®Œäº‹ï¼Œä¸è¿‡å› ä¸ºciéƒ¨ç½²éœ€è¦è®¿é—®é›†ç¾¤ï¼Œæ‰€ä»¥åˆæ”¹äº†ä¸‹&lt;code>.kube/config&lt;/code>ï¼Œåˆ äº†ä¹‹å‰å°è¯•&lt;code>csr&lt;/code>æ–¹å¼æ·»åŠ ç”¨æˆ·çš„æ—¶å€™åŠ å¤šçš„ user å’Œ context ï¼Œå¤åˆ¶äº†ä¸€ä»½æŒ‚è½½åˆ° runner å®¹å™¨é‡Œã€‚&lt;/p>
&lt;p>ç„¶å&amp;hellip;&amp;hellip;é—®é¢˜å°±æ¥äº†ã€‚&lt;/p>
&lt;p>åŒäº‹å¿½ç„¶å‘Šè¯‰æˆ‘åŠå…¬å®¤çš„æœåŠ¡æŒ‚äº†ï¼Œäºæ˜¯ä¸‹æ„è¯†åœ°æ‰“å‡º&lt;code>kgp&lt;/code>ï¼Œå¡ä½ã€‚&lt;/p>
&lt;p>ç­‰äº†ä¸€ä¼šå„¿ï¼Œè¿˜æ˜¯å¡ä½ã€‚&lt;/p>
&lt;p>åˆç­‰äº†ä¸€ä¼šå„¿ï¼Œåä¸ä½äº†ã€‚è¯•äº†ä¸‹&lt;code>kubectl cluster-info&lt;/code>ï¼Œç»§ç»­å¡ä½ã€‚&lt;/p>
&lt;p>å¼€å§‹æ…Œäº†ï¼Œæƒ³èµ·ä»Šå¤©çš„æœºå™¨æœ‰ç‚¹å¡ï¼Œå…ˆçœ‹çœ‹ &lt;code>free -h&lt;/code> æœ‰æ²¡æœ‰å†…å­˜æ³„æ¼ä¹‹ç±»çš„é—®é¢˜å¯¼è‡´é˜»å¡ï¼Œç»“æœå‘ç°å¹¶æ²¡æœ‰ï¼Œäºæ˜¯ç»§ç»­çœ‹ &lt;code>htop&lt;/code>ï¼Œcpuä½¿ç”¨ç‡ä¹Ÿæ¯”è¾ƒæ­£å¸¸ã€‚å†çœ‹&lt;code>df -h | grep -vE 'shm|overlay'&lt;/code>ï¼Œå‘ç°ç¡¬ç›˜ä½¿ç”¨ç‡96%ï¼ˆä¼°è®¡ç¡¬ç›˜ä¸»æ§æƒ³æ­»çš„å¿ƒéƒ½æœ‰äº†ï¼Œæªç€4%çš„å¯ç”¨ç©ºé—´æƒ³æŠŠPEæ•°å¹³å‡åˆ°å„ä¸ªåŒºå—ææ€•ä¸å®¹æ˜“ï¼‰ã€‚&lt;/p>
&lt;p>æ‰¾åˆ°é—®é¢˜åæ¾äº†å£æ°”ï¼Œåæœ‰å…«ä¹æ˜¯åˆå‡ºç° evicted äº†ã€‚äºŒè¯ä¸è¯´ç›´æ¥ &lt;code>docker system df&lt;/code>ï¼Œçœ‹åˆ°30å¤šGçš„ build cache é¡¿æ—¶æƒŠäº†ï¼Œè‚¯å®šä¸æ˜¯goçš„æ„å»ºç¼“å­˜ï¼ˆæ‰‹åŠ¨æŒ‚è½½ä¼˜åŒ–äº†ï¼‰ï¼Œé‚£å°±æ˜¯ node_modules åˆç«‹å¥‡åŠŸäº†ã€‚node_modules=é»‘æ´æœç„¶ä¸æ˜¯å¹çš„ã€‚&lt;/p>
&lt;p>æ¸…ç†å®Œä½¿ç”¨ç‡æ¢å¤åˆ°63%ï¼Œä½†ä¾ç„¶æœ‰ç§ä¸å®‰æ„Ÿè¦ç»•äºå¿ƒï¼Œäºæ˜¯å†æ¬¡å°è¯•&lt;code>kgp&lt;/code>ï¼Œå¡ä½ã€‚&lt;/p>
&lt;p>ç­‰äº†ä¸€ä¼šå„¿ï¼Œå–å£æ°´ï¼Œç»§ç»­å¡ç€ã€‚&lt;/p>
&lt;p>åˆç­‰äº†ä¸€ä¼šå„¿ï¼Œæ·¦ã€‚&lt;/p>
&lt;p>æƒ³äº†æƒ³ï¼Œ&lt;code>journalctl -r -u k3s&lt;/code>çœ‹çœ‹æ—¥å¿—ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆå‘ç°ï¼Œå€’æ˜¯æ³¨æ„åˆ°å¾ˆå¤š&lt;code>linkerd&lt;/code>ä¹‹ç±»çš„æˆ‘ä»¬éƒ¨é—¨ç»ç†æäº‹çš„æ—¶å€™é—ç•™ä¸‹æ¥çš„ç©æ„å„¿åœ¨æŠ¥é”™ï¼Œservice mesh æˆ‘ä¸ç†Ÿï¼Œä½†å¯»æ€åº”è¯¥ä¸ä¼šå½±å“ kubectl å§ï¼Œk3s æœ¬ä½“çš„ api-server åº”è¯¥ä¸å½’ linkerd ç®¡ã€‚æ›´ä½•å†µ linkerd æœ¬èº«å°±æ²¡é…å¥½ã€‚å†ç¿»äº†ç¿»çœ‹åˆ°ä¸‹é¢çš„å†…å®¹ã€‚&lt;/p>
&lt;pre>&lt;code class="language-log" data-lang="log"> 6 12æœˆ 25 21:16:07 office k3s[794]: I1225 13:16:07.685149 794 container_gc.go:85] attempting to delete unused containers
7 12æœˆ 25 21:16:07 office k3s[794]: I1225 13:16:07.687723 794 image_gc_manager.go:321] attempting to delete unused images
8 12æœˆ 25 21:16:07 office k3s[794]: I1225 13:16:07.782390 794 eviction_manager.go:351] eviction manager: able to reduce ephemeral-storage pressure without evicting pods.
9 12æœˆ 25 21:16:17 office k3s[794]: W1225 13:16:17.939242 794 eviction_manager.go:344] eviction manager: attempting to reclaim ephemeral-storage
10 12æœˆ 25 21:16:17 office k3s[794]: I1225 13:16:17.939267 794 container_gc.go:85] attempting to delete unused containers
11 12æœˆ 25 21:16:17 office k3s[794]: I1225 13:16:17.941771 794 image_gc_manager.go:321] attempting to delete unused images
12 12æœˆ 25 21:16:18 office k3s[794]: I1225 13:16:18.033724 794 eviction_manager.go:351] eviction manager: able to reduce ephemeral-storage pressure without evicting pods.
13 12æœˆ 25 21:16:28 office k3s[794]: W1225 13:16:28.214032 794 eviction_manager.go:344] eviction manager: attempting to reclaim ephemeral-storage
&lt;/code>&lt;/pre>&lt;p>è¿™ä¸ªæ˜¯è€é—®é¢˜äº†ï¼Œä¸€ç›´æ²¡å»ç ”ç©¶æ€ä¹ˆè§£å†³ã€‚&lt;/p>
&lt;pre>&lt;code class="language-log" data-lang="log"> 154 12æœˆ 25 21:21:55 office k3s[794]: I1225 13:21:55.021937 794 image_gc_manager.go:304] [imageGCManager]: Disk usage on image filesystem is at 95% which is over the high threshold (85%). Trying to free 182 155 12æœˆ 25 21:21:55 office k3s[794]: E1225 13:21:55.025140 794 kubelet.go:1292] Image garbage collection failed multiple times in a row: failed to garbage collect required amount of images. Wanted to free
&lt;/code>&lt;/pre>&lt;p>è¿™æ¬¡æœäº†ä¸‹ï¼Œåº”è¯¥æ˜¯ &lt;code>docker system prune&lt;/code> é€ æˆ &lt;code>kubelet&lt;/code> æ‰¾ä¸åˆ°å¯å›æ”¶çš„é•œåƒæ‰æŠ¥é”™ï¼ˆçŒœæµ‹ï¼‰ï¼Œä¸è¿‡ä¾ç„¶ä¸èƒ½è§£é‡Šä¸ºå•¥ &lt;code>kubectl&lt;/code> æ²¡ååº”ã€‚äºæ˜¯ç»§ç»­ç¿»äº†ä¼šå„¿æ—¥å¿—ï¼Œæœç´¢é”™è¯¯ï¼Œä½†å§‹ç»ˆæ²¡æœ‰ä»€ä¹ˆç»“æœã€‚&lt;/p>
&lt;p>ä½†æ˜¯åŒäº‹è¿˜è¦å¹²æ´»ï¼Œæ²¡è¾™äº†ï¼Œå…ˆé‡å¯ä¸‹æœåŠ¡å™¨å§ã€‚ç¾¤é‡Œè¯´äº†ä¸€å£°è¦é‡å¯äº†ï¼Œç­‰äº†ä¸€ä¼šå„¿è·‘&lt;code>sudo reboot&lt;/code>ï¼Œé‡å¯å®Œè¿æ¥ï¼Œç»§ç»­&lt;code>kgp&lt;/code>ï¼Œå¡ä½ã€‚&lt;/p>
&lt;p>å—¯&amp;hellip;&amp;hellip;&lt;/p>
&lt;p>æ—©æœ‰é¢„æ–™ã€‚&lt;/p>
&lt;p>&lt;code>journalctl -r -u k3s --boot&lt;/code> çœ‹çœ‹é‡å¯åçš„æ—¥å¿—ï¼Œå‘ç°è¿˜æ˜¯è€ä¸€å¥—çš„é—®é¢˜ï¼Œ&lt;code>docker&lt;/code> æ‰‹åŠ¨å¤„ç†é•œåƒå’Œå®¹å™¨é€ æˆçš„å’Œ kubernetes çš„ç®¡ç†æœºåˆ¶çš„å†²çªï¼Œå„ç§æ‰¾ä¸åˆ°é•œåƒæˆ–è€…å®¹å™¨çš„è­¦å‘Šï¼Œè¿˜æœ‰ä¸€äº›é”™è¯¯å’Œtraceï¼Œä½†æ²¡æœ‰ä¸€ä¸ªèƒ½è§£é‡Šä¸ºä»€ä¹ˆ&lt;code>kubectl&lt;/code>æ²¡æœ‰ååº”ã€‚ã€‚ã€‚&lt;/p>
&lt;p>ç›´åˆ°åœ¨&lt;code>kubectl&lt;/code>çš„ç»ˆç«¯é‡ŒæŒ‰ä¸‹äº†ctrl+cï¼Œåœ¨é¡ºæ‰‹&lt;code>clear&lt;/code>ä¹‹å‰çœ‹åˆ°äº†ä¸€è¡Œè¯·è¾“å…¥ç”¨æˆ·åï¼ˆengï¼‰&amp;hellip;&lt;/p>
&lt;p>è­¦è§‰ã€‚&lt;/p>
&lt;p>å¿½ç„¶æƒ³èµ·æ¥ï¼Œå› ä¸º &lt;code>kubectl&lt;/code> è¿™ç ´ç©æ„å„¿æ˜¯æ²¡æœ‰é¢œè‰²è¾“å‡ºçš„ï¼Œç”¨ä¹ æƒ¯äº†å„ç§å½©è‰²è¾“å‡ºçš„å‘½ä»¤è¡Œå·¥å…·ï¼Œ&lt;code>kubectl&lt;/code>å°±æ ¼å¤–ä¸é¡ºçœ¼ã€‚æ‰€ä»¥åœ¨å‘ç°&lt;code>kubecolors&lt;/code>åï¼Œæˆ‘å°±ç›´æ¥æŠŠ&lt;code>kubectl&lt;/code>é…ç½®æˆäº†&lt;code>kubecolor&lt;/code>çš„åˆ«åã€‚&lt;/p>
&lt;p>æ‰€ä»¥&amp;hellip;&amp;hellip;éš¾é“æ˜¯&lt;code>kubecolor&lt;/code>çš„é—®é¢˜ï¼Ÿ&lt;/p>
&lt;p>&lt;code>whereis kubectl&lt;/code>æ‰¾åˆ°&lt;code>kubectl&lt;/code>çš„ç»å¯¹è·¯å¾„ä¹‹åï¼Œå°è¯•æ‰‹åŠ¨è¿è¡Œ&lt;code>/usr/local/bin/kubectl cluster-info&lt;/code>ï¼Œå†æ¬¡å‡ºç°äº†é‚£ä¸ªè¾“å…¥ç”¨æˆ·åçš„æç¤ºï¼Œé¡¿æ—¶å¼€å§‹æ€€ç–‘èµ·&lt;code>.kube/config&lt;/code>é…ç½®æœ‰é—®é¢˜ï¼Œæ­£å¥½åœ¨å‡ºç°é—®é¢˜ä¹‹å‰æ”¹è¿‡äº†&lt;code>.kube/config&lt;/code>ï¼Œè¿™é‡Œå‡ºé—®é¢˜çš„å«Œç–‘å°±å¾ˆå‰å°”å¤§ã€‚&lt;/p>
&lt;p>äºæ˜¯æ‰“å¼€&lt;code>.kube/config&lt;/code>ï¼Œæ£€æŸ¥äº†ä¸€ä¸‹é›†ç¾¤çš„ç”¨æˆ·é…ç½®ï¼Œå‘ç°æœç„¶ï¼Œæ˜¯æˆ‘æ‰‹æ¬ æŠŠåŠå…¬å®¤é›†ç¾¤çš„ç”¨æˆ·ç»™åˆ äº†ã€‚è‰ã€‚&lt;/p>
&lt;p>æ€¥å¿™ä»&lt;code>/etc/rancher/k3s/k3s.yaml&lt;/code>å¤åˆ¶ä¸‹ç”¨æˆ·è¯ä¹¦é…ç½®ï¼Œè´´è¿›å»ï¼Œå†è¿è¡Œ&lt;code>kgp&lt;/code>æœç„¶å±äº‹æ²¡æœ‰äº†ã€‚&lt;/p>
&lt;p>æ‰€ä»¥æ€»ç»“å¦‚ä¸‹ã€‚&lt;/p>
&lt;ol>
&lt;li>åˆ«è¢«è¡¨é¢çš„é—®é¢˜è¿·æƒ‘ã€‚&lt;/li>
&lt;li>è‡ªå·±çŠ¯å‚»çš„å‡ ç‡å¤§äºåŸºç¡€è®¾æ–½/å¸¸ç”¨å·¥å…·çŠ¯å‚»çš„å‡ ç‡ã€‚&lt;/li>
&lt;li>é‡åˆ°é—®é¢˜è§£å†³æ­¥éª¤å¾ˆé‡è¦ï¼Œå‡†ç¡®çš„æ–¹å‘å¯ä»¥çœå¾ˆå¤šæ—¶é—´ã€‚
&lt;ol>
&lt;li>å…ˆç¡®å®šæ•…éšœè¡¨ç°å’Œå¤ç°æ¡ä»¶&lt;/li>
&lt;li>ç¡®å®šæ•…éšœç‚¹ï¼ˆå‡ºç°åœ¨ç½‘ç»œã€ç½‘å…³è¿˜æ˜¯åº”ç”¨ã€æ•°æ®åº“ï¼‰ï¼Œå¼„æ¸…æ¥šæ˜¯ä¸æ˜¯æ–°é—®é¢˜&lt;/li>
&lt;li>å†æ’æŸ¥ç›¸å…³é…ç½®æ˜¯å¦æ­£ç¡®ï¼Œå›å¿†æ˜¯å¦æœ‰åšè¿‡ç›¸å…³ä¿®æ”¹å˜æ›´&lt;/li>
&lt;li>å†æ’æŸ¥æ•…éšœç‚¹æ—¥å¿—ï¼Œå¿…è¦çš„æ—¶å€™å‚è€ƒä¸‹ä»£ç ï¼Œæ¯•ç«Ÿæœ‰çš„æ—¶å€™æ—¥å¿—æ²¡å†™æ¸…æ¥šé”™è¯¯çš„ä¸Šä¸‹æ–‡&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ol></description></item><item><title>åœ¨raspbianä¸Šæ‰‹åŠ¨ç¼–è¯‘vim8.2</title><link>https://nnnewb.github.io/blog/p/build-vim8.2-manually-on-raspbian/</link><pubDate>Sat, 25 Dec 2021 10:37:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/build-vim8.2-manually-on-raspbian/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>raspbianä¸Šè‡ªå¸¦çš„vimç‰ˆæœ¬è¿˜æ˜¯ä½äº†ç‚¹ï¼Œåƒæ˜¯&lt;code>coc.nvim&lt;/code>ä¹‹ç±»çš„æ’ä»¶å¼¹è­¦å‘Šå°±æå¾—å¾ˆçƒ¦ã€‚æˆ‘å¯»æ€è‡ªå·±ç¼–è¯‘ä¸€ä¸ªå§ã€‚&lt;/p>
&lt;h2 id="0x01-ä¸‹è½½æºç ">0x01 ä¸‹è½½æºç &lt;/h2>
&lt;p>ä»&lt;a class="link" href="https://www.vim.org/download.php" target="_blank" rel="noopener"
>vimå®˜ç½‘&lt;/a>ä¸‹è½½æºç ï¼ˆæˆ–è€…å¯ä»¥ä»GitHubä¸‹ï¼Œå‡ºäºç½‘ç»œè€ƒè™‘è¿˜æ˜¯ç›´æ¥ä»ftpä¸‹äº†ï¼‰ï¼Œä¸‹å®Œç›´æ¥&lt;code>scp&lt;/code>ä¼ åˆ°æ ‘è“æ´¾ä¸Šï¼Œ&lt;code>tar xf&lt;/code>è§£å‹å¥½å‡†å¤‡å¼€æ•´ã€‚&lt;/p>
&lt;h2 id="0x02-é…ç½®">0x02 é…ç½®&lt;/h2>
&lt;p>æƒ¯ä¾‹å…ˆçœ‹çœ‹æ–‡æ¡£ï¼Œ&lt;code>README.md&lt;/code>é‡ŒæŒ‡å‡ºæºç å®‰è£…å»çœ‹&lt;code>src/INSTALL&lt;/code>ï¼Œæ‰€ä»¥è·Ÿç€å»çœ‹ã€‚&lt;/p>
&lt;p>åœ¨ Unix ä¸€èŠ‚ä¸­æåˆ°ç›´æ¥&lt;code>make&lt;/code>+&lt;code>make install&lt;/code>å°±å®Œäº‹ï¼Œä½†æˆ‘è¦çš„ä¸æ˜¯ç¼–è¯‘ä¸ªé»˜è®¤ç‰ˆæœ¬çš„vimï¼Œæ¯•ç«Ÿè¿˜æœ‰æ’ä»¶ä¼šç”¨åˆ°&lt;code>vim&lt;/code>çš„ &lt;code>Pyhon&lt;/code>/&lt;code>Python3&lt;/code> ç‰¹æ€§ï¼Œæ¯”å¦‚&lt;code>ycm&lt;/code>ã€‚&lt;/p>
&lt;p>ç»§ç»­å¾€ä¸‹ç¿»ä¼šçœ‹åˆ°ç¼–è¯‘ä¾èµ–ã€‚&lt;/p>
&lt;pre>&lt;code>% sudo apt install git
% sudo apt install make
% sudo apt install clang
% sudo apt install libtool-bin
&lt;/code>&lt;/pre>
&lt;p>è·Ÿç€æŠŠä¾èµ–è£…å¥½ï¼Œclangä¼°è®¡æ˜¯å¯é€‰é¡¹ï¼Œgccè‚¯å®šæ˜¯èƒ½ç¼–è¯‘vimçš„ã€‚ä¸è¿‡ä»¥é˜²ä¸‡ä¸€åæ­£å…¨è£…ä¸Šã€‚&lt;/p>
&lt;p>åé¢ç»ˆäºçœ‹åˆ°äº†Python3æ·»åŠ æ”¯æŒçš„æ–¹å¼ã€‚&lt;/p>
&lt;pre>&lt;code>Add Python 3 support:
% sudo apt install libpython3-dev
Uncomment this line in Makefile:
&amp;quot;CONF_OPT_PYTHON3 = --enable-python3interp&amp;quot;
% make reconfig
&lt;/code>&lt;/pre>
&lt;p>è™½ç„¶è¯´æ–‡æ¡£è®©å–æ¶ˆæ³¨é‡Šï¼Œä½†æ˜¯æˆ‘ä¸æƒ³æ”¹ä¸œè¥¿ã€‚æ‰€ä»¥è®°ä¸€ä¸‹&lt;code>--enable-python3interp&lt;/code>ï¼Œç­‰ä¼šå„¿åŠ å…¥&lt;code>configure&lt;/code>çš„å‚æ•°ã€‚&lt;/p>
&lt;p>åé¢åˆæœ‰ä¸ªå…³äºguiçš„ï¼Œå› ä¸ºä¸ä½¿ç”¨guiï¼Œæ‰€ä»¥ä¹Ÿè®°ä¸€ä¸‹ã€‚&lt;/p>
&lt;blockquote>
&lt;p>Unix: COMPILING WITH/WITHOUT GUI&lt;/p>
&lt;p>NOTE: This is incomplete, look in Makefile for more info.&lt;/p>
&lt;p>These configure arguments can be used to select which GUI to use:&lt;/p>
&lt;pre>&lt;code>--enable-gui=gtk or: gtk2, motif, athena or auto
--disable-gtk-check
--disable-motif-check
--disable-athena-check
&lt;/code>&lt;/pre>&lt;p>This configure argument can be used to disable the GUI, even when the necessary
files are found:&lt;/p>
&lt;pre>&lt;code>--disable-gui
&lt;/code>&lt;/pre>&lt;/blockquote>
&lt;p>åˆ°æ—¶å€™&lt;code>--disable-gui&lt;/code>å¯ä»¥çœä¸€ç‚¹ç¼–è¯‘æ—¶é—´ï¼Œè™½ç„¶æœ¬æ¥ä¹Ÿæ²¡å¤šå°‘ç¼–è¯‘æ—¶é—´ã€‚æ ‘è“æ´¾æ€§èƒ½ä¸æ˜¯å¾ˆå¥½ï¼Œtfå¡è¯»å†™å¯¿å‘½ä¹Ÿæœ‰é™ï¼Œçœä¸€ç‚¹æ˜¯ä¸€ç‚¹å’¯ã€‚&lt;/p>
&lt;p>è¿˜æœ‰ä¸ª&lt;code>--with-features=big&lt;/code>ï¼Œå®é™…å‚è€ƒ&lt;a class="link" href="http://www.drchip.org/astronaut/vim/vimfeat.html" target="_blank" rel="noopener"
>vim&amp;rsquo;s versions and features&lt;/a>ï¼Œè¿˜æ˜¯ç”¨&lt;code>huge&lt;/code>ï¼Œå› ä¸ºçœ‹èµ·æ¥åŠŸèƒ½æ¯”è¾ƒå…¨ã€‚&lt;/p>
&lt;p>å†åŠ ä¸Šå‚æ•°&lt;code>--enable-multibyte&lt;/code>å’Œ&lt;code>--enable-cscope&lt;/code>å°±å·®ä¸å¤šäº†ã€‚å†åŠ ä¸Šå¿…è¦çš„ä¸€äº›ä¾èµ–åº“ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">sudo apt install -y libpython-dev libpython3-dev libperl-dev libncurses-dev
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="0x03-ç¼–è¯‘">0x03 ç¼–è¯‘&lt;/h2>
&lt;p>æŒ‰ç…§&lt;code>autoconf&lt;/code>è¿™å¥—ç¼–è¯‘ç³»ç»Ÿçš„å¸¸è§„å¥—è·¯ï¼Œå…ˆè¿è¡Œ&lt;code>./configure&lt;/code>ï¼Œå¸¦ä¸Šä¹‹å‰è€ƒè™‘å¥½çš„å‚æ•°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">./configure &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> --prefix&lt;span class="o">=&lt;/span>/usr/local/ &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> --with-features&lt;span class="o">=&lt;/span>huge &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> --enable-multibyte &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> --disable-gui &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> --enable-pythoninterp &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> --enable-python3interp &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> --enable-perlinterp &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> --enable-cscope
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ€å&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">make
sudo make install
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç­‰ç¼–è¯‘å®Œæˆã€‚&lt;/p>
&lt;h2 id="0x04-è®¾ç½®é»˜è®¤ç¼–è¾‘å™¨">0x04 è®¾ç½®é»˜è®¤ç¼–è¾‘å™¨&lt;/h2>
&lt;p>ç”¨&lt;code>update-alternatives&lt;/code>é…ç½®é»˜è®¤ç¼–è¾‘å™¨ï¼Œæˆ–è€…åœ¨&lt;code>.zshrc&lt;/code>é‡ŒåŠ ä¸Š&lt;code>alias vim=/usr/local/bin/vim&lt;/code>ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">sudo update-alternatives --install /usr/bin/editor editor /usr/local/bin/vim &lt;span class="m">1&lt;/span>
sudo update-alternatives --set editor /usr/local/bin/vim
sudo update-alternatives --install /usr/bin/vi vi /usr/local/bin/vim &lt;span class="m">1&lt;/span>
sudo update-alternatives --set vi /usr/local/bin/vim
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>vimçš„ç¼–è¯‘è¿™ä¹ˆç®€å•åº”è¯¥æŠŠåŠŸåŠ³ç®—åˆ°è‰¯å¥½çš„æ¶æ„ä¸Šï¼ŒåŠŸèƒ½å¼€å…³è¿™ç§ä¸œè¥¿æ˜¯è¦æ¶æ„æ¸…æ™°åœ°ç»™ç»„ä»¶ä¹‹é—´åˆ’å‡ºè¾¹ç•Œçš„ã€‚&lt;/p>
&lt;p>å¾ˆå¤šæ‚é±¼å…¬å¸æ ¹æœ¬ä¸è€ƒè™‘ç³»ç»Ÿç»´æŠ¤ï¼Œæ‰€è°“çš„ &lt;strong>åˆ›é€ ä»·å€¼&lt;/strong> å°±æ˜¯ä»¥æœ€å¿«çš„é€Ÿåº¦ &lt;strong>åº”ä»˜éœ€æ±‚&lt;/strong> ï¼Œæƒ³èµ·å‡ å¹´å‰çš„è‡ªå·±è¿˜çœŸçš„æ˜¯å¤©çœŸï¼Œä»¥ä¸ºè½¯ä»¶ä»ä¸šèµ·ç æ˜¯æœ‰ç‚¹åŸºæœ¬çš„ç´ å…»çš„ï¼Œèµ·ç å·¥ç¨‹èƒ½åŠ›æ˜¯æœ‰çš„ã€‚ç°åœ¨æˆ‘çš„æƒ³æ³•å˜äº†ï¼Œè½¯ä»¶ä»ä¸šä¸æ˜¯æœ‰æ‰‹å°±è¡Œï¼Ÿäº§å“æœ€æƒ³è¦çš„å°±æ˜¯ç›´æ¥æŠŠåˆ«å®¶çš„è½¯ä»¶ &lt;em>copy&amp;amp;paste&lt;/em> æˆè‡ªå·±çš„ï¼Œæˆ‘å¯»æ€åšè½¯ä»¶é”®ç›˜ä¸Šç£¨æŸæœ€å¿«çš„å°±æ˜¯ &lt;code>ctrl&lt;/code> &lt;code>c&lt;/code> &lt;code>v&lt;/code>è¿™ä¸‰ä¸ªé”®äº†ã€‚&lt;/p>
&lt;p>äº§å“å˜›ã€‚ä»€ä¹ˆå·¥ç¨‹æ€§ï¼Ÿä»€ä¹ˆå¯ç»´æŠ¤ï¼Ÿé‚£è·Ÿæˆ‘æœ‰ä»€ä¹ˆå…³ç³»ï¼Œåæ­£æ”¹éœ€æ±‚çš„dead lineæ˜¯ç å†œçš„ï¼Œä¿®bugæ˜¯ç å†œä¿®ï¼Œæˆ‘äº§å“è®¾è®¡è¦ä¸æ—¶ä¿±è¿›ï¼Œè¦ç´§éšå¸‚åœºï¼Œè¦æœåŠ¡å®¢æˆ·ï¼Œä½ å°±æ˜¯ä¸ªå†™ä»£ç çš„ï¼Œè¿™ä¹Ÿä¸åšé‚£ä¹Ÿä¸åšé›‡ä½ æ¥å¹²ä»€ä¹ˆï¼Ÿ&lt;/p>
&lt;p>å¹³å¸¸å¿ƒå¹³å¸¸å¿ƒï¼Œæ‰¯è¿œäº†ã€‚&lt;/p>
&lt;p>æ€»ä¹‹ï¼Œvimï¼Œå¥½è½¯ä»¶ã€‚é¡ºä¾¿è®°å¾—å…³æ³¨ä¸‹ä¹Œå¹²è¾¾å„¿ç«¥ç”Ÿå­˜çŠ¶å†µï¼ˆä¸æ‰¯æ”¿æ²»åœ°è¯´ï¼Œvimè‡ªç§°æ…ˆå–„è½¯ä»¶(charityware)è¿˜æ˜¯æœ‰ç‚¹ä¸œè¥¿çš„ï¼Œå†è¯´ä¸‹å»é²è¿…å…ˆç”Ÿå°±è¦å‡ºæ¥èµ¶è‹è‡äº†ï¼‰ã€‚&lt;/p></description></item><item><title>XA äº‹åŠ¡ä»ç†è®ºåˆ°å®è·µ</title><link>https://nnnewb.github.io/blog/p/xa-transaction-theory-to-practice/</link><pubDate>Thu, 16 Dec 2021 15:00:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/xa-transaction-theory-to-practice/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>æœ‰è¨€é“ï¼Œçº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…ï¼Œç»çŸ¥æ­¤äº‹è¦èº¬è¡Œã€‚åˆ†å¸ƒå¼äº‹åŠ¡çš„å…·ä½“æ–¹æ¡ˆï¼Œçœ‹å‡ ç¯‡æ–‡ç« å°±åŸºæœ¬æœ‰äº†æ¦‚å¿µï¼Œä½†å®é™…åº”ç”¨çš„æœºä¼šå¾ˆå°‘ã€‚è¿™ä¸æœ‰ç‚¹é—²æš‡ï¼Œå°±è¯•è¯•çœ‹æŠŠç†è®ºåŒ–ä½œä»£ç ï¼Œåœ¨å®è·µä¸­æ£€éªŒã€‚&lt;/p>
&lt;h2 id="1-æ¡ˆä¾‹è®¾è®¡">#1 æ¡ˆä¾‹è®¾è®¡&lt;/h2>
&lt;p>é‡‡ç”¨åˆ†å¸ƒå¼äº‹åŠ¡ç»å…¸çš„è½¬è´¦æ¡ˆä¾‹ï¼šç”¨æˆ·ä»é“¶è¡ŒAè½¬è´¦åˆ°é“¶è¡ŒBï¼Œé“¶è¡ŒAæ‰£é™¤ä½™é¢ï¼Œé“¶è¡ŒBå¢åŠ ä½™é¢ã€‚&lt;/p>
&lt;p>XAäº‹åŠ¡å®˜æ–¹è§„èŒƒæ–‡æ¡£ç»™å‡ºçš„ç¤ºæ„å›¾å¦‚ä¸‹ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/%E4%BA%8B%E5%8A%A1%E6%A8%A1%E5%9E%8B-16396188786822.webp" >
&lt;img src="https://nnnewb.github.io/blog/blog/%E4%BA%8B%E5%8A%A1%E6%A8%A1%E5%9E%8B-16396188786822.webp"
loading="lazy"
alt="äº‹åŠ¡æ¨¡å‹">
&lt;/a>
&lt;figcaption>äº‹åŠ¡æ¨¡å‹&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>ç”¨ XA äº‹åŠ¡æè¿°ï¼Œç”¨æˆ·çš„è½¬è´¦æ“ä½œå‘ç”Ÿåœ¨APï¼ŒAPè°ƒç”¨TMæ³¨å†Œå…¨å±€äº‹åŠ¡åï¼Œè°ƒç”¨é“¶è¡ŒAï¼ˆRMï¼‰å®Œæˆæ‰£æ¬¾ï¼ˆPREPAREï¼‰ï¼Œè°ƒç”¨é“¶è¡ŒBï¼ˆRMï¼‰å®Œæˆå¢åŠ ä½™é¢ï¼ˆPREPAREï¼‰ï¼Œç„¶åè°ƒç”¨TMæäº¤å…¨å±€äº‹åŠ¡ï¼ŒTMå›è°ƒé“¶è¡ŒAå’ŒBæäº¤æœ¬åœ°äº‹åŠ¡ã€‚&lt;/p>
&lt;p>å›¾ç¤ºå¦‚ä¸‹ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 129;
flex-basis: 309px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/xa-transaction-theory-to-practice/image-20211216093842362-16396187268731.png" data-size="975x755">
&lt;img src="https://nnnewb.github.io/blog/blog/p/xa-transaction-theory-to-practice/image-20211216093842362-16396187268731.png"
width="975"
height="755"
srcset="https://nnnewb.github.io/blog/blog/p/xa-transaction-theory-to-practice/image-20211216093842362-16396187268731_hud4880bf67613c24d16e213b564201e7c_46081_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/xa-transaction-theory-to-practice/image-20211216093842362-16396187268731_hud4880bf67613c24d16e213b564201e7c_46081_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="xaäº‹åŠ¡æ—¶åºå›¾">
&lt;/a>
&lt;figcaption>xaäº‹åŠ¡æ—¶åºå›¾&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>ä¸Šé¢çš„æ—¶åºå›¾æ˜¯è¯»äº† &lt;a class="link" href="https://github.com/yedf/dtm/" target="_blank" rel="noopener"
>github.com/yedf/dtm&lt;/a> ä»£ç åèƒ¡ä¹±åˆ†æå‡ºæ¥çš„ï¼Œå›¾ç•¥å»äº†é”™è¯¯å¤„ç†çš„éƒ¨åˆ†ã€‚æ ¹æ®è¿™ä¸ªæ—¶åºå›¾å¯ä»¥åšå‡ºä¸€ä¸ªç®€å•çš„æœåŠ¡åˆ’åˆ†è®¾è®¡ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 110;
flex-basis: 265px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/xa-transaction-theory-to-practice/image-20211216095721213.png" data-size="634x574">
&lt;img src="https://nnnewb.github.io/blog/blog/p/xa-transaction-theory-to-practice/image-20211216095721213.png"
width="634"
height="574"
srcset="https://nnnewb.github.io/blog/blog/p/xa-transaction-theory-to-practice/image-20211216095721213_hucf2754a53d93ba8eebe14a4b22b7b5b1_40377_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/xa-transaction-theory-to-practice/image-20211216095721213_hucf2754a53d93ba8eebe14a4b22b7b5b1_40377_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="æ¡ˆä¾‹æœåŠ¡åˆ’åˆ†">
&lt;/a>
&lt;figcaption>æ¡ˆä¾‹æœåŠ¡åˆ’åˆ†&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>ä¸ºäº†æ›´å¥½åœ°è§‚å¯ŸæœåŠ¡çš„äº¤äº’æƒ…å†µï¼Œå¼•å…¥äº† Jaeger ï¼Œå¦‚æœæ˜¯ä¸ºäº†ç®€åŒ–æ•´ä¸ªæ¡ˆä¾‹ä»£ç è€ƒè™‘ä¹Ÿå¯ä»¥ä¸è¦ã€‚ä½†å¤§éƒ¨åˆ†æ—¶å€™ Jaeger åº”è¯¥æ˜¯æ²¡ä»€ä¹ˆå­˜åœ¨æ„Ÿçš„ã€‚&lt;/p>
&lt;p>nginx åå‘ä»£ç†å°† AP çš„æ¥å£è¿˜æœ‰ Bank1/Bank2çš„æ¥å£å¯¼å‡ºç»™ç”¨æˆ·è®¿é—®ï¼Œå®é™…ä¸Šæ¡ˆä¾‹ä¸­æ²¡æœ‰éœ€è¦è®¿é—® Bank1/Bank2 æ¥å£çš„æƒ…å†µï¼Œæ‰€ä»¥ å»æ‰ nginx åå‘ä»£ç†åº”è¯¥ä¹Ÿæ²¡ä»€ä¹ˆå¤§å…³ç³»ã€‚&lt;/p>
&lt;h2 id="2-æŠ€æœ¯æ ˆ">#2 æŠ€æœ¯æ ˆ&lt;/h2>
&lt;p>æ‰€æœ‰æœåŠ¡ä½¿ç”¨docker-composeéƒ¨ç½²ï¼Œkubernetesä¹Ÿæ²¡é—®é¢˜ã€‚&lt;/p>
&lt;p>MySQLä½¿ç”¨5.7ç‰ˆæœ¬ï¼Œjaegerå’Œnginxæœ€æ–°ç¨³å®šç‰ˆã€‚AP/BankæœåŠ¡éƒ½ä½¿ç”¨ Go è¯­è¨€ç¼–å†™ï¼Œ ä½¿ç”¨ Gin ä½œä¸º HTTP æœåŠ¡æ¡†æ¶ï¼ŒOpenTelemetry è·Ÿè¸ªï¼Œsqlx åš ORMã€‚&lt;/p>
&lt;h2 id="3-æ¥å£è®¾è®¡">#3 æ¥å£è®¾è®¡&lt;/h2>
&lt;p>æ¥å£urlè®¾è®¡æœ‰å‚è€ƒ Google APIs è§„èŒƒï¼Œä½†å¹¶ä¸æ˜¯ç¡¬å¥— RESTful ã€‚&lt;/p>
&lt;p>APæœåŠ¡æä¾›æ¥å£&lt;/p>
&lt;ul>
&lt;li>&lt;code>/v1alpha1/transfer&lt;/code> è½¬è´¦æ¥å£&lt;/li>
&lt;/ul>
&lt;p>BankæœåŠ¡æä¾›æ¥å£&lt;/p>
&lt;ul>
&lt;li>&lt;code>/v1alpha1/trans_in&lt;/code> ä½™é¢è½¬å…¥&lt;/li>
&lt;li>&lt;code>/v1alpha1/trans_out&lt;/code> ä½™é¢è½¬å‡º&lt;/li>
&lt;li>&lt;code>/v1alpha1/tm_callback&lt;/code> äº‹åŠ¡å›è°ƒï¼Œå½“APæäº¤äº‹åŠ¡æˆ–è€…å›æ»šæ—¶ï¼ŒTMå›è°ƒè¿™ä¸ªæ¥å£å¹¶å‘ŠçŸ¥éœ€è¦æäº¤è¿˜æ˜¯å›æ»š&lt;/li>
&lt;/ul>
&lt;p>TMæœåŠ¡æä¾›æ¥å£&lt;/p>
&lt;ul>
&lt;li>&lt;code>/v1alpha1/create_global_tx&lt;/code> æ³¨å†Œå…¨å±€äº‹åŠ¡ã€‚&lt;/li>
&lt;li>&lt;code>/v1alpha1/register_local_tx&lt;/code> æ³¨å†Œæœ¬åœ°äº‹åŠ¡ï¼ŒæŒ‡å®šå…³è”å“ªä¸ªå…¨å±€äº‹åŠ¡ã€‚åœ¨APæäº¤æˆ–è€…å›æ»šçš„æ—¶å€™TMå¯ä»¥æŸ¥æ‰¾å‡ºæ‰€æœ‰æœ¬åœ°äº‹åŠ¡å¹¶å›è°ƒã€‚&lt;/li>
&lt;li>&lt;code>/v1alpha1/commit_global_tx&lt;/code> æäº¤å…¨å±€äº‹åŠ¡ã€‚&lt;/li>
&lt;li>&lt;code>/v1alpha1/rollback_global_tx&lt;/code> å›æ»šå…¨å±€äº‹åŠ¡ã€‚&lt;/li>
&lt;/ul>
&lt;p>ä¸€å…±éœ€è¦å®ç°8ä¸ªæ¥å£ï¼Œæ¥å£ä¼šå°½é‡ç®€åŒ–ã€‚&lt;/p>
&lt;h2 id="4-æ¡†æ¶æ„å»º">#4 æ¡†æ¶æ„å»º&lt;/h2>
&lt;p>åˆ›å»ºå¥½å„ä¸ªæœåŠ¡çš„æ ·æ¿ï¼ˆå°±æ˜¯ç®€å•çš„ç”¨GinæŠŠä¸Šé¢çš„æ¥å£å®šä¹‰å¥½ï¼Œå†™å¥½ä¸»ç¨‹åºï¼‰ï¼Œæ¥ç€å†™ Dockerfile å’Œ docker-compose.yml æŠŠä¹‹å‰è®¾è®¡çš„æœåŠ¡åˆ’åˆ†å®ç°å‡ºæ¥ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;3.1&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">services&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">jaeger&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">jaegertracing/all-in-one:1.29&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">environment&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">COLLECTOR_ZIPKIN_HOST_PORT=:9411&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">expose&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="m">5775&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="m">6831&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="m">6832&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="m">5778&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="m">16686&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="m">14268&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="m">14250&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="m">9411&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="m">16686&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="m">16686&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">restart&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">always&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">mysql&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mysql:5.7&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;3306:3306&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">environment&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">MYSQL_ROOT_PASSWORD&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">root&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">restart&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">always&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">./scripts/initdb.d/:/docker-entrypoint-initdb.d/:ro&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">reverseproxy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nginx:mainline&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="m">8080&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="m">80&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">restart&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">always&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">depends_on&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">bank1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">bank2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">app&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">./scripts/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">tm&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">build&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">context&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">.&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">dockerfile&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">docker/tm.Dockerfile&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">expose&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="m">5000&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">restart&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">always&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">depends_on&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">mysql&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">bank1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">build&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">context&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">.&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">dockerfile&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">docker/bank.Dockerfile&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;/bank&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;-bank-id&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;1&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">expose&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="m">5000&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">restart&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">always&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">depends_on&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">tm&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">mysql&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">bank2&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">build&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">context&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">.&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">dockerfile&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">docker/bank.Dockerfile&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;/bank&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;-bank-id&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;2&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">expose&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="m">5000&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">restart&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">always&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">depends_on&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">tm&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">mysql&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">build&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">context&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">.&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">dockerfile&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">docker/app.Dockerfile&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">expose&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="m">5000&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">restart&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">always&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">depends_on&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">tm&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">bank1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">bank2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">mysql&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…¶ä¸­ Bank1/Bank2 ç”¨çš„åŒä¸€å¥—ä»£ç ï¼Œä»¥å‘½ä»¤è¡Œå‚æ•°æ¥åŒºåˆ†è¿æ¥ä¸åŒçš„æ•°æ®åº“ã€‚&lt;/p>
&lt;h2 id="5-tm-å®ç°">#5 TM å®ç°&lt;/h2>
&lt;h3 id="åˆ›å»ºå…¨å±€äº‹åŠ¡">åˆ›å»ºå…¨å±€äº‹åŠ¡&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">createGlobalTx&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">gin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">req&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">tm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CreateGlobalTxReq&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">BindJSON&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">db&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">MustGet&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;db&amp;#34;&lt;/span>&lt;span class="p">).(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">sqlx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DB&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NamedExecContext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Context&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="s">`INSERT INTO global_tx(gid) VALUES(:gid)`&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">tm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GlobalTx&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">GID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GID&lt;/span>&lt;span class="p">})&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JSONP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">200&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{}{&lt;/span>
&lt;span class="s">&amp;#34;code&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s">&amp;#34;message&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;ok&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æš‚æ—¶æ²¡æœ‰è€ƒè™‘æ›´å¤šå…¨å±€äº‹åŠ¡çš„ç”¨æ³•ï¼Œåªæ˜¯å•çº¯çš„ä¿å­˜ã€‚&lt;/p>
&lt;h3 id="æ³¨å†Œæœ¬åœ°äº‹åŠ¡">æ³¨å†Œæœ¬åœ°äº‹åŠ¡&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">registerLocalTx&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">gin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">req&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">tm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RegisterLocalTxReq&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">BindJSON&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">db&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">MustGet&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;db&amp;#34;&lt;/span>&lt;span class="p">).(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">sqlx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DB&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NamedExecContext&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Context&lt;/span>&lt;span class="p">(),&lt;/span>
&lt;span class="s">`INSERT INTO local_tx(gid,branch_id,callback_url) values(:gid, :branch_id, :callback_url)`&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">tm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">LocalTx&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">GID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GID&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">BranchID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">BranchID&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">CallbackUrl&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CallbackUrl&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JSONP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">200&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{}{&lt;/span>
&lt;span class="s">&amp;#34;code&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s">&amp;#34;message&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;ok&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ¬åœ°äº‹åŠ¡éœ€è¦è®°å½•ä¸‹å¯¹åº”çš„å…¨å±€äº‹åŠ¡IDå’Œåˆ†æ”¯IDï¼ˆå°±æ˜¯è¿™ä¸ªæœ¬åœ°äº‹åŠ¡çš„IDï¼Œç”¨äºå›è°ƒçš„æ—¶å€™å‘Šè¯‰RMæäº¤å“ªä¸ªæœ¬åœ°äº‹åŠ¡ï¼Œåœ¨MySQL XAé‡Œå°±æ˜¯XID çš„ bqual éƒ¨åˆ†ï¼‰ï¼Œä»¥åŠå›è°ƒçš„åœ°å€ã€‚&lt;/p>
&lt;h3 id="æäº¤å…¨å±€äº‹åŠ¡">æäº¤å…¨å±€äº‹åŠ¡&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">commitGlobalTx&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">gin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">req&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">tm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CommitGlobalTxReq&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">BindJSON&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">db&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">MustGet&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;db&amp;#34;&lt;/span>&lt;span class="p">).(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">sqlx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DB&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">allLocalTx&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="nx">tm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">LocalTx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SelectContext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Context&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">allLocalTx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;SELECT * FROM local_tx WHERE gid=?&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GID&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// TODO æç«¯æƒ…å†µä¸‹ï¼Œå›è°ƒ RM æ—¶å‡ºç°éƒ¨åˆ†å¤±è´¥è¦å¦‚ä½•å¤„ç†ï¼Ÿ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">cli&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Client&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Transport&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">otelhttp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewTransport&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DefaultTransport&lt;/span>&lt;span class="p">)}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">tx&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">allLocalTx&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">callbackPayload&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">bank&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TMCallbackReq&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Action&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;commit&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">GID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GID&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">BranchID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">tx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">BranchID&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="nx">callbackResp&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">bank&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TMCallbackResp&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WrappedPost&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Context&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">cli&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">tx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CallbackUrl&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">callbackPayload&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">callbackResp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">callbackResp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Code&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JSONP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">500&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">tm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CommitGlobalTxResp&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Code&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Message&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;commit local tx failed, response code %d, %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">callbackResp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Code&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">callbackResp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Message&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JSONP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">200&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{}{&lt;/span>
&lt;span class="s">&amp;#34;code&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s">&amp;#34;message&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;ok&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…¨å±€äº‹åŠ¡çš„æäº¤ï¼Œæœ¬è´¨æ˜¯ç”±TMè´Ÿè´£é€ä¸ªå‘ŠçŸ¥RMæäº¤è‡ªå·±çš„æœ¬åœ°äº‹åŠ¡ï¼Œä¹Ÿæ˜¯æ•´ä¸ª XA è¿‡ç¨‹é‡Œæœ€é‡è¦ä¹Ÿæœ€è„†å¼±çš„ä¸€æ­¥ã€‚ç†è®ºä¸Šæ¥è¯´è¿™æ—¶çš„ XA äº‹åŠ¡æ— è®ºæ˜¯æäº¤è¿˜æ˜¯å›æ»šéƒ½åº”è¯¥æ— æ¡ä»¶æˆåŠŸã€‚&lt;/p>
&lt;p>ä½†TMæœ¬èº«ï¼Œä»¥åŠTMå’ŒRMä¹‹é—´çš„ç½‘ç»œå­˜åœ¨æ•…éšœçš„å¯èƒ½ã€‚å¦‚æœTMå´©æºƒï¼Œæˆ–è€…TMå’ŒRMä¹‹é—´å‡ºç°ç½‘ç»œåˆ†åŒºï¼Œå¯¼è‡´TMæ— æ³•å‘å‡ºæäº¤æˆ–å›æ»šçš„æ¶ˆæ¯æ—¶ï¼Œå°±ä¼šå¯¼è‡´å‚ä¸è€…é™·å…¥é•¿æ—¶é—´çš„é˜»å¡ï¼Œç›´åˆ°TMæ¢å¤è¿è¡Œï¼Œæˆ–ç½‘ç»œæ¢å¤ç•…é€šï¼Œå‚ä¸è€…æ”¶åˆ°TMå‘å‡ºçš„Commitæˆ–Rollbackæ¶ˆæ¯ä¸ºæ­¢ã€‚&lt;/p>
&lt;p>æ›´å¯èƒ½å‡ºç°çš„æƒ…å†µæ˜¯ï¼Œä¸€ä¸ªæˆ–å‡ ä¸ªå‚ä¸è€…å‡ºç°ç½‘ç»œåˆ†åŒºæˆ–å´©æºƒï¼Œæ²¡æœ‰æ”¶åˆ° Commit æ¶ˆæ¯ï¼Œåªèƒ½ç»§ç»­é˜»å¡ç­‰å¾…ï¼ŒTMä¹Ÿéœ€è¦ä¸æ–­é‡è¯•ã€‚å‚ä¸è€…ä¸èƒ½ä¾æ®è¶…æ—¶æ—¶é—´æ­¦æ–­æäº¤æˆ–å›æ»šï¼Œå› ä¸ºTMå¾ˆå¯èƒ½å‘å‡ºäº†æäº¤çš„æŒ‡ä»¤ï¼Œåªæ˜¯å› ä¸ºç½‘ç»œçŠ¶å†µä¸ä½³ç­‰åŸå› æœªèƒ½åŠæ—¶é€è¾¾ã€‚è¿™ä¸€æƒ…å†µä¹Ÿå¯ä»¥é€šè¿‡å‚ä¸è€…ä¹‹é—´äº’ç›¸è¯¢é—®æ¥è§£å†³ï¼Œç­‰å¾…è¶…æ—¶çš„å‚ä¸è€…å¯ä»¥è¯¢é—®å…¶ä»–å‚ä¸è€…ï¼Œå¦‚æœæœ‰å‚ä¸è€…æœªå‡†å¤‡åˆ™å¯ä»¥ç¡®å®šéœ€è¦å›æ»šï¼Œå¦‚æœæœ‰å‚ä¸è€…å·²ç»æäº¤ï¼Œåˆ™ä¹Ÿå¯ä»¥ç¡®å®šéœ€è¦æäº¤ã€‚ä½†å¦‚æœæ‰€æœ‰å‚ä¸è€…éƒ½å¤„äºå°±ç»ªçŠ¶æ€ï¼Œåˆ™æ— æ³•åˆ¤æ–­TMçš„æœ€ç»ˆå†³ç­–ï¼Œåªèƒ½ç»§ç»­å‚»ç­‰ã€‚&lt;/p>
&lt;p>å¦å¤–å…³äºç½‘ç»œåˆ†åŒºï¼ˆå°±æ˜¯CAPä¸­çš„Pï¼‰ï¼Œå‡å¦‚è¯´æ¶ˆæ¯å‘é€è€…ä¼šä¸æ–­é‡è¯•å‘é€ï¼Œç›´åˆ°æ¥æ”¶è€…å‘ŠçŸ¥æˆåŠŸï¼Œæš‚ä¸”è®¤ä¸ºå¤šæ¬¡å‘é€æ¶ˆæ¯äº§ç”Ÿçš„ç»“æœæ˜¯å¹‚ç­‰çš„ï¼Œé‚£ä¹ˆæ¥æ”¶è€…å› ä¸ºç½‘ç»œåŸå› æœªèƒ½æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œå’Œæ¥æ”¶åˆ°äº†æ¶ˆæ¯ï¼Œä½†å› ä¸ºæ¥æ”¶è€…æœ¬èº«çš„æ•…éšœæˆ–èµ„æºä¸è¶³ç­‰åŸå› æœªèƒ½å¤„ç†æ¶ˆæ¯å°±å´©æºƒé‡å¯çš„è¯ï¼Œå®è´¨ä¸Šå’Œç½‘ç»œåˆ†åŒºçš„ç»“æœæ˜¯å·®ä¸å¤šçš„ï¼Œéƒ½å¯ä»¥çœ‹ä½œæ˜¯æ¥æ”¶è€…æœªèƒ½æ”¶åˆ°æ¶ˆæ¯ã€‚ä¸¾ä¾‹æ¥è¯´å°±æ˜¯ä¸€ä¸ªHTTPè¯·æ±‚åœ¨ç¨‹åºä¸­é—´ä»¶é‡Œè§¦å‘äº†å´©æºƒï¼Œæ²¡æœ‰æ‰§è¡Œä»»ä½•ä¸šåŠ¡é€»è¾‘ï¼Œç›´åˆ°å‹åŠ›ç¼“è§£åæ‰æ¢å¤ï¼Œè¿™ç§æƒ…å†µæ”¾åœ¨ä¸Šé¢çš„åœºæ™¯ï¼ˆTMå›è°ƒæäº¤æœ¬åœ°äº‹åŠ¡ï¼‰é‡Œåˆ†æï¼Œå’Œå‡ºç°ç½‘ç»œåˆ†åŒºçš„æƒ…å†µæ˜¯å¾ˆæ¥è¿‘çš„ã€‚ï¼ˆPSï¼šå¼€è„‘æ´ï¼Œåˆ«å½“çœŸå•Šï¼Œåº”è¯¥å’Œ P è¿˜æ˜¯ä¸å¤§ä¸€æ ·çš„ï¼‰&lt;/p>
&lt;p>æ‰€ä»¥æ€»ç»“å°±æ˜¯ï¼ŒTMè¦ä¿è¯æœ€ç»ˆä¸€è‡´ï¼Œæ‰€æœ‰çš„XAäº‹åŠ¡éƒ½è¢«æäº¤æˆ–å›æ»šã€‚ä¸€æ—¦è¿›å…¥æäº¤æˆ–å›æ»šå…¨å±€äº‹åŠ¡çš„çŠ¶æ€ï¼Œåˆ™&lt;strong>éœ€è¦æ— é™æ¬¡å°è¯•å›è°ƒæäº¤æˆ–å›æ»šæœ¬åœ°äº‹åŠ¡ï¼Œç›´è‡³å…¨éƒ¨æˆåŠŸ&lt;/strong>ã€‚ä¸Šé¢çš„æ¡ˆä¾‹ä»£ç æ˜¯æ²¡æœ‰è€ƒè™‘é‡è¯•çš„æƒ…å†µï¼Œå®é™…åº”è¯¥åœ¨å‡½æ•°é‡Œä¸æ–­é‡è¯•ï¼Œç›´åˆ°æˆåŠŸã€‚æˆ–è€…ç›´æ¥æ”¾åˆ°åå°å»è·‘ï¼Œè¿”å›ä¸ªæäº¤è¿›è¡Œä¸­ä¹Ÿæ˜¯ä¸€ç§åŠæ³•ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹åº”è¯¥æ˜¯ä¸ä¼šæœ‰é—®é¢˜çš„ï¼Œç›´æ¥é‡è¯•ä¹Ÿè¿˜èƒ½æ¥å—ã€‚å¯ä»¥ç»™ä¸ªè¶…æ—¶ï¼Œå¦‚æœå‡ºç°éƒ¨åˆ†å¤±è´¥å°±æ”¾åˆ°åå°å»æ…¢æ…¢è·‘ï¼Œå…ˆè¿”å›ä¸ªè¿›è¡Œä¸­ã€‚&lt;/p>
&lt;p>è™½ç„¶ä¿è¯äº†ä¸€è‡´æ€§ï¼ˆCAPé‡Œçš„Cï¼‰ï¼Œä¹Ÿå®¹å¿äº†å«å‚ä¸è€…æäº¤æœ¬åœ°äº‹åŠ¡å¤±è´¥è€Œäº§ç”Ÿçš„åˆ†åŒºï¼ˆPï¼‰ï¼Œä½†è¿™æ ·åšå¿…ç„¶æ˜¯è¦èˆå¼ƒä¸€éƒ¨åˆ†å¯ç”¨æ€§ï¼ˆAï¼‰çš„ã€‚æ‰€ä»¥ XA äº‹åŠ¡æ˜¯ä¸€ç§ä¿è¯ CP çš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆã€‚&lt;/p>
&lt;h3 id="å›æ»šæœ¬åœ°äº‹åŠ¡">å›æ»šæœ¬åœ°äº‹åŠ¡&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">rollbackGlobalTx&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">gin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">req&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">tm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RollbackGlobalTxReq&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">BindJSON&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">db&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">MustGet&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;db&amp;#34;&lt;/span>&lt;span class="p">).(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">sqlx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DB&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">allLocalTx&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="nx">tm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">LocalTx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SelectContext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Context&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">allLocalTx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;SELECT * FROM local_tx WHERE gid=?&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GID&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// TODO æç«¯æƒ…å†µä¸‹ï¼Œå›è°ƒ RM æ—¶å‡ºç°éƒ¨åˆ†å¤±è´¥è¦å¦‚ä½•å¤„ç†ï¼Ÿ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">cli&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Client&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Transport&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">otelhttp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewTransport&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DefaultTransport&lt;/span>&lt;span class="p">)}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">tx&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">allLocalTx&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">callbackPayload&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">bank&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TMCallbackReq&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Action&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;rollback&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">GID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GID&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">BranchID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">tx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">BranchID&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="nx">callbackResp&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">bank&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TMCallbackResp&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WrappedPost&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Context&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">cli&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">tx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CallbackUrl&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">callbackPayload&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">callbackResp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">callbackResp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Code&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JSONP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">500&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">tm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RollbackGlobalTxResp&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Code&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Message&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;rollback local tx failed, response code %d, %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">callbackResp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Code&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">callbackResp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Message&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JSONP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">200&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{}{&lt;/span>
&lt;span class="s">&amp;#34;code&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s">&amp;#34;message&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;ok&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å›æ»šçš„é€»è¾‘å’Œæäº¤æ˜¯ä¸€æ ·çš„ï¼Œä¸å¤šåšè§£é‡Šäº†ã€‚&lt;/p>
&lt;h2 id="6-bank-å®ç°">#6 Bank å®ç°&lt;/h2>
&lt;h3 id="è½¬å…¥">è½¬å…¥&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">transIn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">gin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">req&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">bank&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TransInReq&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">BindJSON&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">db&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">MustGet&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;db&amp;#34;&lt;/span>&lt;span class="p">).(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">sqlx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DB&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">cli&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewTMClient&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;http://tm:5000&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">branchID&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">tm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">MustGenBranchID&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;TransIn&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">resp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">cli&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RegisterLocalTx&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Context&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">tm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RegisterLocalTxReq&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">GID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GID&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">BranchID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">branchID&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">CallbackUrl&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;http://bank%d:5000/v1alpha1/tm_callback&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">flgBankID&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">resp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Code&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JSONP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">500&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">bank&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TransInResp&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Code&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Message&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;register local tx failed&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// ä¸šåŠ¡é€»è¾‘
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// å‡†å¤‡ XA äº‹åŠ¡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">xid&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;&amp;#39;%s&amp;#39;,&amp;#39;%s&amp;#39;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GID&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">branchID&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ExecContext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Context&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;XA BEGIN %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">xid&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ExecContext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Context&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="s">&amp;#34;UPDATE wallet SET balance=balance+? WHERE id=?&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Amount&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ID&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ExecContext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Context&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;XA END %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">xid&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ExecContext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Context&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;XA PREPARE %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">xid&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JSONP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">200&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{}{&lt;/span>
&lt;span class="s">&amp;#34;code&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s">&amp;#34;message&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;ok&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦‚æœæŠŠMySQLè§†ä½œRMçš„è¯ï¼ŒBankæœåŠ¡å°±æ˜¯è¿é€šTMå’ŒAPçš„æ¡¥æ¢ã€‚æ”¾åˆ°è½¬è´¦çš„åœºæ™¯é‡Œï¼Œå‡è®¾APæ˜¯æ”¯ä»˜å®ï¼Œé‚£èƒ½æŒ‡æœ›æ”¯ä»˜å®å»ç›´æ¥è®¿é—®é“¶è¡Œçš„æ•°æ®åº“å—ï¼Ÿæ¯”å¦‚æ”¯ä»˜å®ä»åŸºé‡‘é‡Œææ¬¾ï¼Œè°ƒç”¨åŸºé‡‘çš„ææ¬¾æ¥å£å’Œé“¶è¡Œçš„è½¬è´¦ï¼Œä¹Ÿæ˜¯ä¸ªç±»ä¼¼çš„åœºæ™¯ã€‚å½“ç„¶å…·ä½“ä¸šåŠ¡ä¸èƒ½ç›´æ¥å¥—XAï¼Œå°±æ˜¯ä¸¾ä¸ªä¾‹å­ã€‚&lt;/p>
&lt;p>è½¬å…¥çš„æ¥å£æœ¬èº«å°±æ˜¯ä»£ç†äº†ä¸€ä¸‹ MySQL çš„ &lt;code>update&lt;/code> è¯­å¥ï¼Œå®é™…ä¸šåŠ¡åœºæ™¯é‡Œå¯èƒ½è¿˜ä¼šæœ‰æ›´å¤šä¸šåŠ¡é€»è¾‘ä¸Šçš„åˆ¤æ–­ã€‚&lt;/p>
&lt;h3 id="è½¬å‡º">è½¬å‡º&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">transOut&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">gin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">req&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">bank&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TransOutReq&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">BindJSON&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">db&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">MustGet&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;db&amp;#34;&lt;/span>&lt;span class="p">).(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">sqlx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DB&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">cli&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewTMClient&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;http://tm:5000&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">branchID&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">tm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">MustGenBranchID&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;TransOut&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// æ³¨å†Œæœ¬åœ°äº‹åŠ¡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">resp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">cli&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RegisterLocalTx&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Context&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">tm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RegisterLocalTxReq&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">GID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GID&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">BranchID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">branchID&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">CallbackUrl&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;http://bank%d:5000/v1alpha1/tm_callback&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">flgBankID&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">resp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Code&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JSONP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">500&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">bank&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TransInResp&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Code&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Message&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;register local tx failed&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// ä¸šåŠ¡é€»è¾‘
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// å‡†å¤‡ XA äº‹åŠ¡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">xid&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;&amp;#39;%s&amp;#39;,&amp;#39;%s&amp;#39;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GID&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">branchID&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ExecContext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Context&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;XA BEGIN %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">xid&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ExecContext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Context&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="s">&amp;#34;UPDATE wallet SET balance=balance-? WHERE id=?&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Amount&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ID&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ExecContext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Context&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;XA END %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">xid&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ExecContext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Context&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;XA PREPARE %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">xid&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JSONP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">200&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{}{&lt;/span>
&lt;span class="s">&amp;#34;code&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s">&amp;#34;message&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;ok&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è½¬å‡ºçš„ä»£ç å…¶å®æœ‰ç‚¹é—®é¢˜ï¼Œæ¼æ‰äº†æ£€æŸ¥ä½™é¢ï¼Œå…¶ä»–å’Œè½¬å…¥çš„æ¥å£å°±æ²¡ä»€ä¹ˆåŒºåˆ«äº†ã€‚&lt;/p>
&lt;h2 id="7-ap-å®ç°">#7 AP å®ç°&lt;/h2>
&lt;h3 id="è½¬è´¦">è½¬è´¦&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">transfer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">gin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">req&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">TransferReq&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">BindJSON&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">tmcli&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewTMClient&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;http://tm:5000&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">gid&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">tm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">MustGenGID&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">resp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">tmcli&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">CreateGlobalTx&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Context&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">tm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CreateGlobalTxReq&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">GID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">gid&lt;/span>&lt;span class="p">})&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">resp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Code&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JSONP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">500&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">GeneralResp&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Code&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Message&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;create global transaction failed&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">cli1&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewBankClient&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;http://bank1:5000&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">transInResp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">cli1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">TransIn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Context&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">bank&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TransInReq&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">GID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">gid&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ToID&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Amount&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Amount&lt;/span>&lt;span class="p">})&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// å¤±è´¥çš„è¯å°±ç­‰ç€è¶…æ—¶
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">tmcli&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RollbackGlobalTx&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Context&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">tm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RollbackGlobalTxReq&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">GID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">gid&lt;/span>&lt;span class="p">})&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JSONP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">500&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">GeneralResp&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Code&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Message&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;trans in failed&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">transInResp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Code&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// å¤±è´¥çš„è¯å°±ç­‰ç€è¶…æ—¶
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">tmcli&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RollbackGlobalTx&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Context&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">tm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RollbackGlobalTxReq&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">GID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">gid&lt;/span>&lt;span class="p">})&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JSONP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">500&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">GeneralResp&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Code&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Message&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;trans in failed&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">cli2&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewBankClient&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;http://bank2:5000&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">transOutResp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">cli2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">TransOut&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Context&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">bank&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TransOutReq&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">GID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">gid&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ToID&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Amount&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Amount&lt;/span>&lt;span class="p">})&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// å¤±è´¥çš„è¯å°±ç­‰ç€è¶…æ—¶
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">tmcli&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RollbackGlobalTx&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Context&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">tm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RollbackGlobalTxReq&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">GID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">gid&lt;/span>&lt;span class="p">})&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JSONP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">500&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">GeneralResp&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Code&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Message&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;trans out failed&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">transOutResp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Code&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// å¤±è´¥çš„è¯å°±ç­‰ç€è¶…æ—¶
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">tmcli&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RollbackGlobalTx&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Context&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">tm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RollbackGlobalTxReq&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">GID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">gid&lt;/span>&lt;span class="p">})&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JSONP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">500&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">GeneralResp&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Code&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Message&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;trans out failed&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">commitResp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">tmcli&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">CommitGlobalTx&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Context&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">tm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CommitGlobalTxReq&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">GID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">gid&lt;/span>&lt;span class="p">})&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// å¤±è´¥çš„è¯å°±ç­‰ç€è¶…æ—¶
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">tmcli&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RollbackGlobalTx&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Context&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">tm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RollbackGlobalTxReq&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">GID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">gid&lt;/span>&lt;span class="p">})&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JSONP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">500&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">GeneralResp&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Code&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Message&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;commit failed&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">commitResp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Code&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// å¤±è´¥çš„è¯å°±ç­‰ç€è¶…æ—¶
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">tmcli&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RollbackGlobalTx&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Context&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">tm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RollbackGlobalTxReq&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">GID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">gid&lt;/span>&lt;span class="p">})&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JSONP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">500&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">GeneralResp&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Code&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Message&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;commit failed&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JSONP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">200&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{}{&lt;/span>
&lt;span class="s">&amp;#34;code&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s">&amp;#34;message&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;ok&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>APä»£ç ä¸»è¦å°±æ˜¯è°ƒå„ä¸ªRMï¼Œå‘èµ·è½¬å…¥/è½¬å‡ºæ“ä½œï¼Œä»¥åŠåœ¨å‡ºç°é—®é¢˜çš„æƒ…å†µä¸‹å›æ»šå…¨å±€äº‹åŠ¡ã€‚&lt;/p>
&lt;p>å½“ç„¶ï¼ŒAPå›æ»šå…¨å±€äº‹åŠ¡ä¹Ÿä¼šå‡ºç°ç½‘ç»œåˆ†åŒºçš„æƒ…å†µï¼ŒAPå´©æºƒæˆ–è€…ç½‘ç»œæ•…éšœè€Œæ— æ³•è¿æ¥TMï¼Œä¹Ÿå°±æ— æ³•å‘Šè¯‰TMæ˜¯ä¸æ˜¯æ‰€æœ‰å‚ä¸è€…éƒ½å‡†å¤‡å°±ç»ªï¼ŒTMåªèƒ½è‡ªå·±ç­‰è¶…æ—¶åå»å›è°ƒå‚ä¸è€…ï¼Œè®©å‚ä¸è€…å›æ»šæ‰€æœ‰æœ¬åœ°äº‹åŠ¡ã€‚&lt;/p>
&lt;p>è¿™é‡Œå’Œå‚ä¸è€…å‡ºç°åˆ†åŒºåˆä¸å¤§ä¸€æ ·ï¼ŒAPå‡ºç°åˆ†åŒºæœ€å¤šæ˜¯å¯¼è‡´åŸæœ¬è¯¥æäº¤çš„äº‹åŠ¡è¢«å›æ»šï¼Œå¹¶ä¸ä¼šç ´åä¸€è‡´æ€§ï¼Œä¹Ÿå°±æ»¡è¶³äº†CPã€‚ä½†äº‹åŠ¡è¢«å›æ»šï¼Œç­‰äºæ˜¯å¤±å»äº†å¯ç”¨æ€§ï¼Œä¸æ»¡è¶³CAPä¸­çš„Aã€‚&lt;/p>
&lt;h2 id="8-å…³äºtcc">#8 å…³äºTCC&lt;/h2>
&lt;p>TCC æ˜¯ Try-Confirm-Cancel çš„ç¼©å†™ï¼Œæœ€æ—©æ˜¯ç”± Pat Helland äº 2007 å¹´å‘è¡¨çš„ä¸€ç¯‡åä¸ºã€ŠLife beyond Distributed Transactions:an Apostateâ€™s Opinionã€‹çš„è®ºæ–‡æå‡ºã€‚è¿™é‡Œåªè®²ä¸€ä¸‹ä¸ªäººç†è§£ï¼Œå› ä¸º TCC çš„æ—¶åºå›¾å’Œ XA å¯ä»¥è¯´æ˜¯ä¸€æ¨¡ä¸€æ ·ã€‚&lt;/p>
&lt;p>TCC ä¹Ÿæ˜¯ä¸€ç§ 2 é˜¶æ®µæäº¤çš„åè®®ï¼Œå’Œ XA æ¨¡å‹çš„ä¸»è¦åŒºåˆ«æ˜¯æœ¬åœ°äº‹åŠ¡çš„å‡†å¤‡å’Œæäº¤æ˜¯ä¸šåŠ¡å±‚é¢ä¸Šåšçš„æ¥å£ï¼Œä¸šåŠ¡ä¸Šå¯æ§æ€§æ›´å¥½çš„åŒæ—¶ï¼Œä¹Ÿè¦æ±‚å¯¹æœåŠ¡æ¥å£è¿›è¡Œå¤§åˆ€é˜”æ–§çš„ä¿®æ”¹ï¼Œå¼€å‘é‡ä¼šå¤§å¾ˆå¤šã€‚TCC ä¹Ÿå¯ä»¥ç”¨æ•°æ®åº“çš„ XA å®ç°ã€‚&lt;/p>
&lt;p>TCC çš„ä¸€ä¸ªé‡è¦ä¼˜ç‚¹æ˜¯å¯ä»¥å‡å°‘æ•°æ®åº“èµ„æºé”å®šï¼Œæ¯”å¦‚è¯´ï¼Œé‡‡ç”¨ TCC æ–¹å¼å¼€å‘ä¸€ä¸ªæ·»åŠ è´¦å•çš„æ¥å£ï¼ŒTry é˜¶æ®µå¯ä»¥ç›´æ¥ INSERT ä¸€ä¸ªéšè—çš„è´¦å•ï¼ŒConfirm é˜¶æ®µæŠŠè´¦å•è®¾ç½®ä¸ºå¯è§ï¼ŒCancel é˜¶æ®µåˆ™åˆ é™¤ã€‚å¦‚æœå› ä¸ºæŸäº›åŸå› ï¼Œå¾ˆé•¿æ—¶é—´æ²¡æœ‰è¿›å…¥ Confirm é˜¶æ®µï¼ŒTCC æœåŠ¡ä¹Ÿä¸ä¼šæœ‰ä»€ä¹ˆå½±å“ã€‚è€Œ XA æ–¹å¼ä¸€æ–¹é¢è¦æ•°æ®åº“æ”¯æŒï¼Œä¸€æ–¹é¢æ•°æ®åº“è¦ç»´æŒé”ï¼Œæ¶ˆè€—ä¼šæ›´å¤§ã€‚&lt;/p>
&lt;h2 id="9-åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜">#9 åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜&lt;/h2>
&lt;p>åˆ†å¸ƒå¼äº‹åŠ¡éœ€è¦æœåŠ¡åœ¨æ¥å£åšå¥½ä¸€å®šçš„ä¿æŠ¤æªæ–½ï¼Œéµå¾ªä¸€å®šçš„ç¼–ç¨‹è§„èŒƒï¼Œæ¥é¿å…é”™è¯¯å‘ç”Ÿã€‚&lt;/p>
&lt;h3 id="ç©ºè¡¥å¿">ç©ºè¡¥å¿&lt;/h3>
&lt;p>ç©ºè¡¥å¿é—®é¢˜ï¼ŒæŒ‡çš„æ˜¯æœåŠ¡å› ä¸ºä¸€äº›åŸå› æ²¡æœ‰æ”¶åˆ° PREPARE è¯·æ±‚ï¼Œåœ¨ TM å‘èµ·äº†å›æ»šæ“ä½œæ—¶æ”¶åˆ°äº† ROLLBACK è¯·æ±‚ã€‚æ­¤æ—¶æœåŠ¡å¹¶æ²¡æœ‰éœ€è¦å›æ»šçš„æœ¬åœ°äº‹åŠ¡ï¼Œä¹Ÿå°±æ˜¯ç©ºè¡¥å¿ï¼ˆæˆ–è€…å«ç©ºå›æ»šï¼‰ã€‚&lt;/p>
&lt;p>å¦‚æœæœåŠ¡æ²¡æœ‰å¤„ç†ç©ºè¡¥å¿ï¼Œè¿”å›äº†é”™è¯¯ï¼ŒTMå°±ä¼šè®¤ä¸ºæœåŠ¡æ²¡æœ‰å›æ»šæˆåŠŸè¿›è€Œä¸æ–­é‡è¯•ã€‚&lt;/p>
&lt;h3 id="é˜²æ‚¬æŒ‚">é˜²æ‚¬æŒ‚&lt;/h3>
&lt;p>äº‹åŠ¡æ‚¬æŒ‚é—®é¢˜ï¼ŒæŒ‡çš„æ˜¯å› ä¸ºç½‘ç»œæ‹¥å¡ç­‰åŸå› ï¼ŒPREPARE è¯·æ±‚æ™šäº ROLLBACK è¯·æ±‚åˆ°æ¥çš„æƒ…å†µã€‚æ­¤æ—¶æœåŠ¡å·²ç»åšäº†ç©ºè¡¥å¿ï¼Œå…¨å±€äº‹åŠ¡è¢«å›æ»šï¼Œè¿Ÿåˆ°çš„ PREPARE è¯·æ±‚ä¸å¯¹åº”ä»»ä½•å…¨å±€äº‹åŠ¡ï¼Œä¹Ÿå°±æ˜¯â€œå‚æ‚¬çš„â€ã€‚&lt;/p>
&lt;p>å…³äºå‚æ‚¬è¿™ä¸ªæœ¯è¯­ï¼Œæ˜¯ä» &lt;code>dangling (dangleçš„è¿›è¡Œæ—¶)&lt;/code> ç¿»è¯‘è€Œæ¥ã€‚æ¯”å¦‚å‚æ‚¬æŒ‡é’ˆ &lt;em>dangling pointer&lt;/em> æŒ‡çš„æ˜¯å·²ç»è¢«æŒ‡å‘å·²ç»è¢«é‡Šæ”¾çš„ç©ºé—´çš„æŒ‡é’ˆï¼Œå‚æ‚¬äº‹åŠ¡å¯¹åº”çš„å°±æ˜¯æŒ‡å‘å·²ç»è¢«å›æ»šçš„å…¨å±€äº‹åŠ¡çš„æœ¬åœ°äº‹åŠ¡ã€‚&lt;/p>
&lt;p>å¯¹äºå…¨å±€äº‹åŠ¡å·²ç»è¢«å›æ»šçš„æƒ…å†µï¼ŒæœåŠ¡åº”è¯¥ä¸æ‰§è¡Œ PREPAREï¼Œè¶…æ—¶åˆ° TM éƒ½å›æ»šäº†ï¼Œå¤§æ¦‚ä¹Ÿæ²¡æ³•è¿”å›é”™è¯¯ï¼Œå®¢æˆ·ç«¯è¿æ¥éƒ½å¯èƒ½æ–­å¼€äº†ã€‚&lt;/p>
&lt;h3 id="å¹‚ç­‰">å¹‚ç­‰&lt;/h3>
&lt;p>å› ä¸ºç½‘ç»œå»¶è¿Ÿå’ŒæŠ–åŠ¨çš„å­˜åœ¨ï¼ŒæœåŠ¡å¯èƒ½ä¼šæ”¶åˆ°å¤šæ¬¡ PREPARE/COMMIT/ROLLBACK ã€‚å¯¹è¿™ç§æƒ…å†µä¹Ÿè¦ä¿è¯åŒæ ·çš„æ¡ä»¶ä¸‹ï¼Œä¸€æ¬¡è¯·æ±‚å’Œå¤šæ¬¡è¯·æ±‚äº§ç”Ÿçš„ç»“æœæ˜¯ä¸€è‡´çš„ã€‚&lt;/p>
&lt;p>æ¢è¨€ä¹‹ï¼ŒåŒæ ·çš„å‚æ•°PREPAREå¤šæ¬¡ï¼Œå’Œä¸€æ¬¡ PREPARE ä¸€è‡´ã€‚å¤šä½™çš„ PREPARE å¯ä»¥å•¥ä¹Ÿä¸åšã€‚åŒæ ·çš„ COMMIT/ROLLBACK å¤šæ¬¡ï¼Œä¹Ÿæ˜¯ç­‰äºåª COMMIT/ROLLBACK ä¸€æ¬¡ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>ä¸»è¦ç ”ç©¶äº†2é˜¶æ®µæäº¤çš„ä¸»è¦è¿‡ç¨‹ã€æ¥å£è®¾è®¡ã€TMå®ç°ä»¥åŠ2é˜¶æ®µæäº¤åè®®ä¸­å¯èƒ½é‡åˆ°çš„ä¸€äº›é—®é¢˜ã€‚ä»£ç ä¸»è¦æ˜¯è¾…åŠ©æ€è€ƒï¼Œå¹¶æ²¡æœ‰çœŸæ­£çš„æˆæœã€‚&lt;/p>
&lt;p>2é˜¶æ®µæäº¤è¿‡ç¨‹ï¼š&lt;/p>
&lt;ul>
&lt;li>prepare&lt;/li>
&lt;li>commit/rollback&lt;/li>
&lt;/ul>
&lt;p>2é˜¶æ®µæäº¤çš„åŸºæœ¬æ—¶åºï¼š&lt;/p>
&lt;ul>
&lt;li>æ³¨å†Œå…¨å±€äº‹åŠ¡&lt;/li>
&lt;li>æ³¨å†Œæœ¬åœ°äº‹åŠ¡ï¼ˆprepareï¼‰
&lt;ul>
&lt;li>å¦‚æœå¤±è´¥ï¼Œåˆ™å›æ»šå…¨å±€äº‹åŠ¡&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>æäº¤å…¨å±€äº‹åŠ¡&lt;/li>
&lt;/ul>
&lt;p>å…¨å±€äº‹åŠ¡çš„æäº¤å’Œå›æ»šéƒ½ä¸å…è®¸éƒ¨åˆ†å¤±è´¥çš„æƒ…å†µï¼Œä¸€æ—¦PREPAREæˆåŠŸï¼Œæäº¤æˆ–å›æ»šéƒ½å¿…é¡»æˆåŠŸã€‚å¦‚æœå‡ºç°ä¸´æ—¶å¤±è´¥ï¼ˆç½‘ç»œé—®é¢˜æˆ–è€…å´©æºƒï¼‰ï¼Œåˆ™ä¸æ–­é‡è¯•ç›´åˆ°å…¨éƒ¨æˆåŠŸã€‚&lt;/p>
&lt;p>åˆ†å¸ƒå¼äº‹åŠ¡å¸¸è§é—®é¢˜ï¼š&lt;/p>
&lt;ul>
&lt;li>ç©ºè¡¥å¿é—®é¢˜ã€‚å‡ºç°åœ¨æ²¡æœ‰ PREPARE å°±è°ƒç”¨äº† ROLLBACK çš„æƒ…å†µã€‚éœ€è¦æ”¯æŒã€‚&lt;/li>
&lt;li>å‚æ‚¬é—®é¢˜ã€‚å‡ºç°åœ¨å…ˆè°ƒç”¨äº† ROLLBACK æ‰è°ƒç”¨ PREPARE çš„æƒ…å†µã€‚ä¸è¿›è¡Œ PREPAREã€‚&lt;/li>
&lt;li>å¹‚ç­‰é—®é¢˜ã€‚å‡ºç°åœ¨ä»¥åŒæ ·çš„æ¡ä»¶å¤šæ¬¡è°ƒç”¨ PREPARE/COMMIT/ROLLBACK çš„æƒ…å†µã€‚å¤šæ¬¡è°ƒç”¨åº”å’Œä¸€æ¬¡è°ƒç”¨ç»“æœä¸€è‡´ã€‚&lt;/li>
&lt;/ul>
&lt;p>ä¹‹åå¯èƒ½å†ç ”ç©¶ä¸‹åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜çš„å…·ä½“å®è·µï¼Œæˆ–è€…å®ç°ä¸‹ TCC ä¹‹ç±»å…¶ä»–çš„åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹ã€‚&lt;/p>
&lt;p>æœ€ç»ˆä»£ç åœ¨ &lt;a class="link" href="https://github.com/nnnewb/dt" target="_blank" rel="noopener"
>github.com/nnnewb/dt&lt;/a>&lt;/p></description></item><item><title>åŸºäºæ ˆçš„è™šæ‹Ÿæœº</title><link>https://nnnewb.github.io/blog/p/stack-based-virtual-machine-for-minilang/</link><pubDate>Mon, 13 Dec 2021 16:20:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/stack-based-virtual-machine-for-minilang/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>ä¹‹å‰å†™äº†ä¸ªsè¡¨è¾¾å¼æ±‚å€¼å™¨ï¼Œå¾ˆç®€é™‹ï¼Œç›´æ¥åœ¨æŠ½è±¡è¯­æ³•æ ‘ä¸Šæ‰§è¡Œã€‚åªæ˜¯è¿™æ ·çš„è¯å…¶å®è¿˜æ²¡å•¥æ„æ€ï¼Œæ‰€ä»¥å†è¯•è¯•æ”¹è¿›æˆåœ¨åŸºäºæ ˆçš„è™šæ‹Ÿæœºä¸Šæ‰§è¡Œã€‚&lt;/p>
&lt;h2 id="0x01-è™šæ‹Ÿæœºæ¨¡å‹">0x01 è™šæ‹Ÿæœºæ¨¡å‹&lt;/h2>
&lt;p>é¦–å…ˆå¾—æ‰¿è®¤å¯¹è¿™äº›è¯­è¨€å±‚çº§çš„è™šæ‹Ÿæœºä¸ç†Ÿï¼ŒåŸºæœ¬æ˜¯éšä¾¿è®¾è®¡çš„ã€‚&lt;/p>
&lt;h3 id="å¯¹è±¡æ¨¡å‹">å¯¹è±¡æ¨¡å‹&lt;/h3>
&lt;p>è™šæ‹ŸæœºæŒ‡ä»¤æ“ä½œçš„ç›®æ ‡æ˜¯ &lt;strong>å¯¹è±¡&lt;/strong> ï¼ŒåŒ…æ‹¬å†…å»ºçš„å¯¹è±¡å’Œç”¨æˆ·å®šä¹‰çš„å¯¹è±¡ï¼Œè™šæ‹ŸæœºæŒ‡ä»¤æ“ä½œçš„åŸºæœ¬å•ä½ä¹Ÿæ˜¯å¯¹è±¡ã€‚&lt;/p>
&lt;p>ç›®å‰å…³æ³¨çš„æ˜¯å†…å»ºçš„å¯¹è±¡ï¼Œç®€å•æŠ½è±¡å‡ºäº†å‡ ä¸ªåŸºæœ¬ç±»å‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Object&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">TypeName&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">UInt&lt;/span> &lt;span class="kt">uint64&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">u&lt;/span> &lt;span class="nx">UInt&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">TypeName&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;UInt&amp;#34;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">Float&lt;/span> &lt;span class="kt">float64&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">f&lt;/span> &lt;span class="nx">Float&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">TypeName&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;Float&amp;#34;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">Boolean&lt;/span> &lt;span class="kt">bool&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">b&lt;/span> &lt;span class="nx">Boolean&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">TypeName&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;boolean&amp;#34;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">String&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="nx">String&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">TypeName&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;string&amp;#34;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">Symbol&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="nx">Symbol&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">TypeName&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;symbol&amp;#34;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">Nil&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span> &lt;span class="nx">Nil&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">TypeName&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;nil&amp;#34;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>çœç•¥äº†ä¸€éƒ¨åˆ†ï¼Œé¢†ä¼šç²¾ç¥å³å¯ã€‚ä¸Šé¢å®šä¹‰çš„ &lt;code>Symbol&lt;/code> ç±»å‹å…¶å®å°±æ˜¯ &lt;code>#ident&lt;/code> è¿™ç§è¯­æ³•å…ƒç´ ï¼Œç›®çš„æ˜¯ä¿æŒè¯­ä¹‰ä¸Šçš„ç®€æ´ã€‚&lt;/p>
&lt;p>æ¯”å¦‚è¯´ &lt;code>(let a b)&lt;/code>ï¼Œåœ¨ minilang é‡Œè§£é‡Šæˆä»¥&lt;code>a&lt;/code>å’Œ&lt;code>b&lt;/code>ä½œä¸ºå‚æ•°ï¼Œè°ƒç”¨&lt;code>let&lt;/code>å‡½æ•°ï¼Œ&lt;code>a&lt;/code>å’Œ&lt;code>b&lt;/code>éƒ½ä¼šè¢«æ±‚å€¼ã€‚&lt;code>let&lt;/code>æ˜¯ä¸€ä¸ªå†…ç½®å‡½æ•°ï¼Œåœ¨å½“å‰ç¯å¢ƒé‡Œå®šä¹‰ä¸€ä¸ªæ–°çš„å˜é‡å¹¶è®¾åˆå€¼ã€‚&lt;/p>
&lt;p>å¯å®é™…å†™ä»£ç çš„äººæƒ³è¦çš„å¯èƒ½æ˜¯ &lt;em>å®šä¹‰aï¼Œåˆå§‹åŒ–ä¸ºb&lt;/em>ã€‚è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬ä¸å¸Œæœ›&lt;code>a&lt;/code>è¢«æ±‚å€¼ï¼Œè€Œæ˜¯å­—é¢æ„æ€ï¼šæ ‡è¯†ç¬¦&lt;code>a&lt;/code>ï¼Œä¼ ç»™&lt;code>let&lt;/code>å‡½æ•°ã€‚è¿™ç§æƒ…å†µä¸‹å°±å¯ä»¥ç”¨ &lt;code>(let #a b)&lt;/code> ï¼Œ&lt;code>#a&lt;/code> è¡¨ç¤ºä¸€ä¸ª &lt;code>Symbol&lt;/code> ç±»å‹çš„å­—é¢é‡ã€‚&lt;/p>
&lt;p>æˆ–è®¸æœ‰äººä¼šæ³¨æ„åˆ°æœ¬è´¨ä¸Šæ¥è¯´&lt;code>#a&lt;/code>æ˜¯ä¸ªè¯­æ³•ç³–ï¼Œä¹Ÿå¯ä»¥è¢«å†™æˆ &lt;code>(quote &amp;quot;a&amp;quot;)&lt;/code> è¿™æ ·çš„å½¢å¼ã€‚&lt;code>quota&lt;/code> å®šä¹‰ä¸ºå°†å­—ç¬¦ä¸²æ„é€ æˆ &lt;code>Symbol&lt;/code> å¯¹è±¡çš„å‡½æ•°ã€‚&lt;/p>
&lt;h3 id="æŒ‡ä»¤é›†">æŒ‡ä»¤é›†&lt;/h3>
&lt;p>æœ‰äº†åŸºæœ¬çš„å¯¹è±¡æ¨¡å‹ï¼Œå†å®šä¹‰æœ€åŸºæœ¬çš„æŒ‡ä»¤ã€‚å› ä¸ºè€ƒè™‘å°†ä»£ç ä¹Ÿè§†ä½œæ•°æ®ï¼Œæ‰€ä»¥ç›®å‰çš„æƒ³æ³•è¿˜æ˜¯æŠŠæ§åˆ¶ç»“æ„ä¹Ÿåšæˆå†…ç½®å‡½æ•°ï¼Œå› æ­¤æŒ‡ä»¤é›†é‡Œä¸éœ€è¦å¤ªå¤šè½¬ç§»æŒ‡ä»¤ã€‚&lt;/p>
&lt;p>æš‚å®šçš„æŒ‡ä»¤é›†å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">OpCode&lt;/span> &lt;span class="kt">int32&lt;/span>
&lt;span class="kd">const&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">RESERVED&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">iota&lt;/span>
&lt;span class="c1">// CALL &amp;lt;STR&amp;gt;
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// å‹æ ˆä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œè·³è½¬åˆ°æŒ‡å®šä½ç½®
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">CALL&lt;/span>
&lt;span class="c1">// RET &amp;lt;OBJ&amp;gt;
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// å–æ ˆé¡¶çš„å¯¹è±¡ä½œä¸ºè·³è½¬åœ°å€ï¼Œå‹æ ˆè¿”å›å€¼
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">RET&lt;/span>
&lt;span class="c1">// LOAD &amp;lt;STR&amp;gt;
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// è¯»å–å±€éƒ¨ç¯å¢ƒé‡Œçš„å˜é‡å‹æ ˆ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">LOAD&lt;/span>
&lt;span class="c1">// PUSH &amp;lt;NUM&amp;gt;
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// å‹æ ˆå¯¹è±¡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">PUSH&lt;/span>
&lt;span class="c1">// POP &amp;lt;NUM&amp;gt;
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// å‡ºæ ˆä¸€å®šæ•°é‡çš„å¯¹è±¡ï¼Œå‡ºæ ˆçš„å¯¹è±¡ç›´æ¥ä¸¢å¼ƒ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">POP&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">o&lt;/span> &lt;span class="nx">OpCode&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">String&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="s">&amp;#34;RESERVED&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s">&amp;#34;CALL&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s">&amp;#34;RET&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s">&amp;#34;LOAD&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s">&amp;#34;PUSH&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s">&amp;#34;POP&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}[&lt;/span>&lt;span class="nx">o&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>é™¤äº†æœ€åˆçš„ &lt;code>RESERVED&lt;/code> æ˜¯æ•…æ„å ç”¨äº†é›¶å€¼ï¼Œå‰©ä¸‹çš„å°±æ˜¯æœ‰æ•ˆçš„æŒ‡ä»¤äº†ã€‚&lt;/p>
&lt;p>å†™è¿‡ x86 æ±‡ç¼–çš„è¯ä¼šçœ‹çš„å¾ˆä¸ä¹ æƒ¯ï¼Œå› ä¸ºå®Œå…¨æ²¡è€ƒè™‘å¯»å€ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;code>CALL&lt;/code> æŒ‡ä»¤çš„æ“ä½œæ•°å¯¹è±¡æ˜¯å­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œåœ¨æœ¬åœ°ç¯å¢ƒå¯»æ‰¾å¯¹åº”åç§°çš„å†…å»ºå‡½æ•°ï¼›
&lt;ul>
&lt;li>æˆ–è€…ï¼Œæ“ä½œæ•°æ˜¯ UINT çš„è¯ï¼Œå‹æ ˆä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€åè·³è½¬åˆ°æŒ‡å®šä½ç½®ï¼Œå’Œ x86 æ±‡ç¼–ç±»ä¼¼ï¼›&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;code>RET&lt;/code> æŠŠå½“å‰æ ˆé¡¶çš„å˜é‡(UINT)å½“æˆä¸‹ä¸€ä¸ªæŒ‡ä»¤çš„åœ°å€&lt;/li>
&lt;li>&lt;code>LOAD&lt;/code> åœ¨æœ¬åœ°ç¯å¢ƒå¯»æ‰¾å¯¹åº”åç§°çš„å˜é‡å‹æ ˆ&lt;/li>
&lt;/ul>
&lt;p>å‰©ä½™ç•¥ã€‚å…¶å®å¯ä»¥çœ‹å‡ºç›´æ¥å¯¹æœºå™¨ç¼–ç¨‹ä¸­çš„å¯»å€è¢«æ›¿æ¢æˆäº†æ ¹æ®å˜é‡åï¼ˆå­—ç¬¦ä¸²ï¼‰æŸ¥æ‰¾æœ¬åœ°ç¯å¢ƒï¼Œå¾ˆå¤šé«˜å±‚çº§çš„æ¦‚å¿µï¼ˆå¯¹è±¡ã€å­—ç¬¦ä¸²ï¼‰è¢«ç³…æ‚åœ¨é‡Œé¢ã€‚&lt;/p>
&lt;h2 id="0x02-ç¼–è¯‘">0x02 ç¼–è¯‘&lt;/h2>
&lt;p>æ¥ä¸‹æ¥æ˜¯æŠŠæŠ½è±¡è¯­æ³•æ ‘ç¿»è¯‘æˆæŒ‡ä»¤åºåˆ—ã€‚&lt;/p>
&lt;h3 id="å­—é¢é‡ç¿»è¯‘">å­—é¢é‡ç¿»è¯‘&lt;/h3>
&lt;p>å› ä¸º minilang çš„æŒ‡ä»¤ç›´æ¥æ“ä½œå¯¹è±¡ï¼Œæ‰€ä»¥èƒ½å¾ˆçœäº‹åœ°æŠŠå­—é¢é‡éƒ½æ„é€ æˆç›¸åº”åœ°å¯¹è±¡ã€‚å¯¹äºæ›´å¤æ‚çš„å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥ç¼–è¯‘æˆæ„é€ æŒ‡ä»¤ï¼Œå½“ç„¶ç›®å‰ä¸æ¶‰åŠã€‚&lt;/p>
&lt;p>ä¸¾ä¸ªä¾‹å­ï¼Œåˆ—è¡¨å­—é¢é‡ &lt;code>#(display hello)&lt;/code>ã€‚å¯ä»¥åœ¨ç¼–è¯‘è¿‡ç¨‹é‡Œç›´æ¥æ„é€ å‡º &lt;code>List&lt;/code> å¯¹è±¡ï¼Œç„¶åç”Ÿæˆä¸€ä¸ª &lt;code>PUSH List{}&lt;/code> æŒ‡ä»¤ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯æ›´ç®€å•ï¼Œæ•ˆç‡ä¼šæ›´å¥½ä¸€ç‚¹ï¼Œæ¯•ç«Ÿå°‘å‡ ä¸ªè§£é‡Šæ‰§è¡Œçš„æŒ‡ä»¤ã€‚ç›¸åº”çš„é™åˆ¶æ˜¯ä¸èƒ½å¼•ç”¨ç¯å¢ƒé‡Œçš„å˜é‡ï¼Œå› ä¸ºåœ¨æ„é€ å­—é¢é‡å¯¹è±¡çš„è¿‡ç¨‹é‡Œè¿˜æ²¡æœ‰è¿›å…¥è¿è¡Œæ—¶ç¯å¢ƒã€‚&lt;/p>
&lt;p>æ¯”å¦‚è¯´ &lt;code>#(display name)&lt;/code>ï¼Œå¦‚æœç¼–è¯‘æˆ &lt;code>PUSH List{display, name}&lt;/code>ï¼Œé‚£ä¹ˆ&lt;code>name&lt;/code>åœ¨æ­¤åˆ»å°±ä¸èƒ½è¢«æ±‚å€¼ï¼Œå¿…é¡»å»¶è¿Ÿåˆ°æ‰§è¡Œçš„æ—¶å€™æ‰èƒ½æ±‚å€¼&lt;code>name&lt;/code>ã€‚è¿™é‡Œåˆæ¶‰åŠç¼–è¯‘æœŸçš„è®¡ç®—ï¼Œæ¯”å¦‚æˆ‘å¯ä»¥å®šä¹‰ä¸€ä¸ªç¼–è¯‘é˜¶æ®µæ‰§è¡Œçš„æŒ‡ä»¤æ ¼å¼ &lt;code>[elem...]&lt;/code>ï¼Œç¼–è¯‘çš„æ—¶å€™å¯¹ &lt;code>[elem...]&lt;/code>æ±‚å€¼ï¼Œæ±‚å€¼ç»“æœå†™è¿›ç¼–è¯‘å‡ºçš„æŒ‡ä»¤é‡Œã€‚ä¹Ÿæ˜¯åè¯ã€‚&lt;/p>
&lt;p>ç¼–è¯‘æˆæŒ‡ä»¤çš„å¥½å¤„æ˜¯ä¹‹åè¦åš JIT æˆ–è€…å…¨é‡ç¼–è¯‘æˆæœ¬åœ°ä»£ç çš„è¯ï¼Œä¸éœ€è¦é‡æ–°å¤„ç†è¿™ä¸ªå­—é¢é‡ï¼Œå†™ä¸€å † case æŠŠå­—é¢é‡ç¼–è¯‘æˆå‡ ä¸ªå‡½æ•°è°ƒç”¨ã€‚&lt;/p>
&lt;p>æ‰¯è¿œäº†ï¼Œå…ˆå‰æˆ‘ä»¬æ‹¿ &lt;code>gocc&lt;/code> ç”Ÿæˆå¥½äº†è¯­æ³•æ ‘ï¼Œæ¥ä¸‹æ¥å°±æ˜¯ç®€å•åœ°åšä¸€ä¸‹ç¿»è¯‘ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">case&lt;/span> &lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Boolean&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">UInt&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Float&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Symbol&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Quoted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">String&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">instructions&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">instructions&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nf">push&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">vm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ObjectFromLiteral&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">node&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…¶ä¸­ &lt;code>vm.ObjectFromLiteral(node)&lt;/code> å°±æ˜¯è´Ÿè´£æŠŠä»æŠ½è±¡è¯­æ³•æ ‘èŠ‚ç‚¹æ„é€ å‡ºå¯¹è±¡å®ä¾‹çš„å‡½æ•°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">ObjectFromLiteral&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">node&lt;/span> &lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Node&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">Object&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="nx">node&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">node&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="kd">type&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Float&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nf">Float&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">node&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">UInt&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nf">UInt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">node&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">String&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nf">String&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">node&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Boolean&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nf">Boolean&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">node&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Quoted&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">lst&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">List&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">node&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetValue&lt;/span>&lt;span class="p">().([]&lt;/span>&lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Node&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">lst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">underlying&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">lst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">underlying&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nf">ObjectFromLiteral&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">lst&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Symbol&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nf">Symbol&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">node&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatalf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;unexpected ast node in ToValue %v(%T)&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">node&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">node&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>Quoted&lt;/code> è¡¨ç¤ºåˆ—è¡¨å­—é¢é‡ã€‚è¿™ä¸ªå‡½æ•°æœ¬èº«å¾ˆç®€å•å¾ˆç›´ç™½ï¼Œé™åˆ¶æ˜¯å¯¹äºéå­—é¢é‡çš„èŠ‚ç‚¹ä¸èƒ½æ±‚å€¼ï¼ˆæ¯”å¦‚ Identifierã€å‡½æ•°è°ƒç”¨éƒ½åªèƒ½åœ¨è¿è¡Œæ—¶æ±‚å€¼ï¼‰ã€‚&lt;/p>
&lt;h3 id="å‡½æ•°è°ƒç”¨ç¿»è¯‘">å‡½æ•°è°ƒç”¨ç¿»è¯‘&lt;/h3>
&lt;p>æ¥ç€å°±æ˜¯é‡å¤´æˆï¼Œå‡½æ•°è°ƒç”¨çš„ç¿»è¯‘ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">case&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">List&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">elements&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">node&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetValue&lt;/span>&lt;span class="p">().([]&lt;/span>&lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Node&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">elements&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="nx">vm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Instruction&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// å‚æ•°ä»å³åˆ°å·¦å‹æ ˆ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">elements&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">--&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">inst&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Compile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">elements&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">]);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">instructions&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">instructions&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">inst&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// å‹å…¥å‚æ•°æ•°é‡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">instructions&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">instructions&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nf">push&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">vm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">UInt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">elements&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;span class="c1">// æ’å…¥è°ƒç”¨è¯­å¥
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">callee&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">elements&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">ident&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">callee&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Identifier&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">instructions&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">instructions&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">vm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Instruction&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">OpCode&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">vm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CALL&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Operand&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">vm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">vm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Symbol&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ident&lt;/span>&lt;span class="p">)},&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è°ˆå‡½æ•°è°ƒç”¨çš„ç¼–è¯‘å‰å¿…é¡»å…ˆç¡®å®šå¥½è°ƒç”¨çº¦å®šã€‚è¿™é‡Œé‡‡ç”¨äº†å’Œ cdecl ç±»ä¼¼çš„è°ƒç”¨çº¦å®šï¼Œå‚æ•°ä»å³å¾€å·¦å‹æ ˆï¼ŒåŒæ—¶åœ¨æœ€å·¦æ·»åŠ ä¸€ä¸ªå‚æ•°æ•°é‡çš„å‚æ•°ï¼Œå°±åƒæ˜¯ &lt;code>object f(object argc, object ...argv)&lt;/code> ä¸€æ ·ï¼Œé¢†ä¼šç²¾ç¥ã€‚&lt;/p>
&lt;p>å‡½æ•°çš„è¿”å›å€¼ä¸€å¾‹åŒ…è£…æˆ object è¿”å›ï¼Œä¸å…è®¸å¤šè¿”å›å€¼ï¼ˆä½†å¯ä»¥è€ƒè™‘åŠ ä¸ªè§£æ„è¯­æ³•ä¹‹ç±»çš„ç³–ï¼‰ï¼Œè¿”å›å€¼ä¹Ÿé€šè¿‡æ ˆä¼ é€’ã€‚&lt;/p>
&lt;p>æ•´ä¸ªå‡½æ•°è°ƒç”¨çš„è¿‡ç¨‹å¯ä»¥æè¿°ä¸ºï¼š&lt;/p>
&lt;ol>
&lt;li>è°ƒç”¨æ–¹å‚æ•°å‹æ ˆ&lt;/li>
&lt;li>è°ƒç”¨æ–¹å‚æ•°æ•°é‡å‹æ ˆ&lt;/li>
&lt;li>è°ƒç”¨æ–¹è¿”å›åœ°å€å‹æ ˆ&lt;/li>
&lt;li>è°ƒç”¨æ–¹è·³è½¬åˆ°å‡½æ•°å…¥å£ï¼ˆæˆ–è€…è¿›å…¥å†…ç½®å‡½æ•°ï¼‰&lt;/li>
&lt;li>è¢«è°ƒæ–¹å¼¹å‡ºè¿”å›åœ°å€&lt;/li>
&lt;li>è¢«è°ƒæ–¹å¼¹å‡ºæ‰€æœ‰å‚æ•°&lt;/li>
&lt;li>è¢«è°ƒæ–¹å‹æ ˆè¿”å›å€¼&lt;/li>
&lt;li>è¢«è°ƒæ–¹è·³è½¬è‡³è¿”å›åœ°å€&lt;/li>
&lt;/ol>
&lt;p>ä¸€å¥è¯æ¦‚æ‹¬å°±æ˜¯è¢«è°ƒæ–¹æ¸…æ ˆï¼Œè¿”å›å€¼æ”¾åœ¨æ ˆé¡¶ã€‚å¯¹äºå†…ç½®å‡½æ•°ï¼Œæ­¥éª¤5-8éƒ½è¦åœ¨å†…ç½®å‡½æ•°é‡Œå®Œæˆã€‚ä¹‹ååšç”¨æˆ·å®šä¹‰ &lt;code>procedure&lt;/code> çš„è¯å°±è¦åœ¨ &lt;code>procedure&lt;/code> ç¼–è¯‘ç»“æœé‡ŒåŠ ä¸Šå¹³æ ˆçš„ä»£ç äº†ã€‚ç°åœ¨è¿˜åœ¨çº ç»“ &lt;code>POP&lt;/code> æŒ‡ä»¤ç›´æ¥æŠŠå¼¹å‡ºçš„å¯¹è±¡ç»™ä¸¢å¼ƒäº†ï¼Œè¯¥æ€ä¹ˆæš‚å­˜è¿”å›åœ°å€ã€‚å®åœ¨ä¸è¡Œå°±æ”¹æˆè°ƒç”¨æ–¹æ¸…æ ˆå¾—äº†ã€‚&lt;/p>
&lt;h2 id="0x03-è™šæ‹ŸæœºæŠ½è±¡">0x03 è™šæ‹ŸæœºæŠ½è±¡&lt;/h2>
&lt;p>è™šæ‹Ÿæœºç†è§£ä¸ºä¸€ä¸ªçŠ¶æ€å®¹å™¨ï¼ŒåŒ…æ‹¬æŒ‡ä»¤ç©ºé—´ï¼ˆæŒ‡ä»¤é›†åˆå’ŒæŒ‡ä»¤æŒ‡é’ˆï¼‰ã€æ•°æ®ç©ºé—´ï¼ˆæ ˆã€æœ¬åœ°å˜é‡ï¼‰ï¼Œç»™ä¸€ä¸ªç®€å•çš„æ„é€ å™¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">MiniVM&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Stack&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">Object&lt;/span> &lt;span class="c1">// æ ˆç©ºé—´ï¼ŒåŒ…æ‹¬ä¼ å‚å’Œæœ¬åœ°å˜é‡éƒ½å­˜æ”¾åœ¨è¿™é‡Œ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Top&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="c1">// æ ˆé¡¶åœ°å€
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Locals&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nx">Object&lt;/span> &lt;span class="c1">// æœ¬åœ°å˜é‡ï¼Œä»è¿™é‡ŒæŸ¥æ‰¾å˜é‡å’Œå¯è°ƒç”¨çš„å¯¹è±¡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">IP&lt;/span> &lt;span class="nx">UInt&lt;/span> &lt;span class="c1">// Instruction Pointer æŒ‡ä»¤æŒ‡é’ˆ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Instructions&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">Instruction&lt;/span> &lt;span class="c1">// ç¨‹åºæŒ‡ä»¤é›†åˆ
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewMiniVM&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">instructions&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">Instruction&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">MiniVM&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">MiniVM&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Stack&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">Top&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">IP&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Instructions&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">instructions&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Locals&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶åå®šä¹‰æ¯ä¸ªæŒ‡ä»¤çš„æ‰§è¡Œé€»è¾‘ã€‚è¿™é‡Œå…¶å®æœ‰ç‚¹åƒæ˜¯è®¾è®¡æ¨¡å¼é‡Œçš„å‘½ä»¤æ¨¡å¼ï¼ˆCommnad Patternï¼‰ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">MiniVM&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">instCall&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span> &lt;span class="nx">Instruction&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Operand&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;invalid CALL instruction: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">inst&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">sym&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Operand&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">].(&lt;/span>&lt;span class="nx">Symbol&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">proc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">LookupProc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">string&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">sym&lt;/span>&lt;span class="p">));&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">proc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">isBuiltin&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Push&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nf">UInt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">IP&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">proc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Builtin&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">proc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Location&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Push&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nf">UInt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">IP&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">IP&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">UInt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">proc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Location&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatalf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;invalid Procedure object&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatalf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;invalid CALL instruction operand %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Operand&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">MiniVM&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">instRet&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span> &lt;span class="nx">Instruction&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Operand&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;invalid RET instruction: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">inst&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">returnAddress&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Pop&lt;/span>&lt;span class="p">().(&lt;/span>&lt;span class="nx">UInt&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">IP&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">returnAddress&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Push&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Operand&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">MiniVM&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">instPush&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span> &lt;span class="nx">Instruction&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Operand&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Operand&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;invalid PUSH instruction: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">inst&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Push&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Operand&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">MiniVM&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">instPop&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span> &lt;span class="nx">Instruction&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Operand&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Operand&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;invalid POP instruction: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">inst&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Pop&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">MiniVM&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">instLoad&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span> &lt;span class="nx">Instruction&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Operand&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Operand&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;invalid LOAD instruction: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">inst&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Operand&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">].(&lt;/span>&lt;span class="nx">Symbol&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Locals&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nb">string&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">)];&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Push&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;undefined name %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;unexpected operand for instruction LOAD %v(%T)&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Operand&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Operand&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">MiniVM&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">ExecNextInstruction&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">IP&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Instructions&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">ErrNoMoreInstructions&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">inst&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Instructions&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">IP&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">OpCode&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">CALL&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">instCall&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">RET&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">instRet&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">PUSH&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">instPush&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">POP&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">instPop&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">LOAD&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">instLoad&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;unexpected opcode %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">OpCode&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">IP&lt;/span>&lt;span class="o">++&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="0x04-ç»“æœå±•ç¤º">0x04 ç»“æœå±•ç¤º&lt;/h2>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 275;
flex-basis: 660px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/stack-based-virtual-machine-for-minilang/image-20211213160751960.png" data-size="154x56">
&lt;img src="https://nnnewb.github.io/blog/blog/p/stack-based-virtual-machine-for-minilang/image-20211213160751960.png"
width="154"
height="56"
srcset="https://nnnewb.github.io/blog/blog/p/stack-based-virtual-machine-for-minilang/image-20211213160751960_hub5ba10952ea39a099fde4f51e1c00d4b_2964_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/stack-based-virtual-machine-for-minilang/image-20211213160751960_hub5ba10952ea39a099fde4f51e1c00d4b_2964_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211213160751960">
&lt;/a>
&lt;figcaption>image-20211213160751960&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>PSï¼šè¿™ä¸ª &lt;code>+&lt;/code> ä¹Ÿæ˜¯å‡½æ•°ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>è¿™ä¸ªç®€å•çš„ VM å†™çš„æ—¶å€™è„‘å­é‡Œæƒ³çš„éƒ½æ˜¯ x86 æ±‡ç¼–å’Œ Python çš„ç±»å‹ï¼Œæ‰€ä»¥å†…ç½®ç±»å‹å®šä¹‰å°±å¾ˆç²—æš´ï¼ŒæŒ‡ä»¤ OpCode å®šä¹‰ä¹Ÿæ˜¯æƒ³å½“ç„¶ã€‚å†™æˆè¿™æ ·å½“ç„¶è¿˜æ˜¯ä¸æ»¡æ„çš„ï¼Œéƒ½è´¹äº†è¿™ä¹ˆå¤§åŠ²äº†ï¼Œç®€ç®€å•å•åšä¸ª JIT ä¸è¿‡åˆ†å§ï¼Ÿ&lt;/p>
&lt;p>ä½†è®²è€å®çš„ï¼Œæˆ‘è¿˜çœŸä¸çŸ¥é“ä¸ç”¨ CGO çš„æƒ…å†µä¸‹ï¼Œæˆ‘å°±ç®—æ˜¯æ‹¿ &lt;code>syscall&lt;/code> è¿™ä¸ªåŒ…åˆ†é…å¥½äº†è¯»å†™æ‰§è¡Œçš„ç©ºé—´ä¹ŸæˆåŠŸæ±‡ç¼–å‡ºäº†æœºå™¨ç ï¼Œä¹Ÿä¸çŸ¥é“æ€ä¹ˆå»è°ƒ Go é‡Œå®šä¹‰çš„å‡½æ•°å’Œæ•°æ®ç»“æ„ã€‚è¿™ä¸€ç‚¹çœ‹ï¼Œè¦æ˜¯ä¸€å¼€å§‹æ‹¿ C å†™çš„è¯ï¼Œé—®é¢˜å°±ä¼šå¥½è§£å†³å¾ˆå¤šï¼šå¤Ÿåº•å±‚å˜›ï¼Œä¸ç”¨æ‹…å¿ƒç§»æ¤æ€§å’Œè¿è¡Œæ—¶çš„å°è£…ã€‚&lt;/p>
&lt;p>ä¸è¿‡ä¹Ÿä¸æ˜¯çœŸçš„ä¸€ç‚¹åŠæ³•ä¹Ÿæ²¡æœ‰ï¼Œå¹²è„†æŠŠå†…å»ºç±»å‹å’Œå‡½æ•°å…¨éƒ¨æ‹¿ C æˆ–è€… minilang è‡ªå·±å®ç°å°±å¥½äº†ï¼Œå®šä¹‰å¥½æ•°æ®ç»“æ„ï¼Œminilang ç¼–è¯‘å‡ºæ¥çš„æŒ‡ä»¤å…¨æ˜¯è°ƒç”¨è‡ªå·±æˆ–è€…è°ƒç”¨Cå‡½æ•°ï¼Œå†æƒ³ç¿»è¯‘åˆ°æ±‡ç¼–æŒ‡ä»¤å°±ç®€å•å¾ˆå¤šäº†ã€‚åˆ°äº†è¿™ä¸€æ­¥ï¼Œç›´æ¥æ‹¿ minilang å†™ä¸€ä¸ªç¼–è¯‘è‡ªå·±çš„ç¼–è¯‘å™¨ä¹Ÿä¸æ˜¯ä¸è¡Œã€‚&lt;/p></description></item><item><title>ä¸€ä¸ªsè¡¨è¾¾å¼æ±‚å€¼å™¨</title><link>https://nnnewb.github.io/blog/p/a-s-exp-evaluator/</link><pubDate>Thu, 09 Dec 2021 17:11:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/a-s-exp-evaluator/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>ç¿»æ²¡çœ‹è¿‡çš„è—ä¹¦çš„æ—¶å€™æ‰¾å‡ºä¸€æœ¬ã€ŠSICPã€‹çš„ PDFï¼ˆPSï¼šå·²ç»ä¹°äº†æ­£ç‰ˆä¹¦ï¼‰ï¼Œæƒ³èµ·æ›¾ç»æ‹¿ Rust å†™ç©å…·è§£é‡Šå™¨ï¼Œç»“æœç°åœ¨è¿ Rust æœ¬èº«éƒ½å·²ç»å¿«å¿˜å…‰äº†ã€‚&lt;/p>
&lt;p>æ‰€ä»¥å°±å½“æ€€æ—§ï¼Œå†™ä¸ªå¾ˆç®€å•çš„ç©å…·ï¼Œsè¡¨è¾¾å¼æ±‚å€¼å™¨ã€‚&lt;/p>
&lt;h2 id="æŠ€æœ¯æ ˆ">æŠ€æœ¯æ ˆ&lt;/h2>
&lt;p>è¯­è¨€é€‰æ‹©äº† Goï¼Œç”¨ gocc ç”Ÿæˆ Parser/Lexer ã€‚è™½ç„¶è¯´æ‰‹å†™+è°ƒè¯• Lexer/Parser ä¹Ÿæ˜¯æŒºå¿«ä¹çš„ï¼Œä½†æ¯•ç«Ÿåªæ˜¯æ€€æ—§é‡æ¸©ä¸‹å½“å¹´æ„£å¤´é’çš„è‡ªå·±ï¼Œä¸æƒ³èŠ±å¤ªå¤šæ—¶é—´ã€‚&lt;/p>
&lt;h2 id="è¯æ³•å®šä¹‰">è¯æ³•å®šä¹‰&lt;/h2>
&lt;p>ç®€å•è§£é‡Šä¸‹ gocc å®šä¹‰è¯æ³•å…ƒç´ çš„ DSL æ˜¯æ€ä¹ˆå›äº‹ã€‚gocc çš„è¿™ä¸ª DSL æ˜¯ç±»ä¼¼äº EBNF çš„è¯­æ³•ï¼ˆè‡ªç§°ï¼‰ï¼Œ &lt;code>_letter: 'a'-'z'&lt;/code> å°±æ˜¯ä¸€æ¡äº§ç”Ÿå¼ï¼Œ&lt;code>:&lt;/code>å‰é¢æ˜¯äº§ç”Ÿå¼çš„åç§°ï¼Œåé¢æ˜¯æ¨¡å¼ã€‚&lt;/p>
&lt;p>äº§ç”Ÿå¼åç§°ä¹Ÿæœ‰ç‰¹æ®Šå«ä¹‰ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;code>!&lt;/code> å¼€å¤´çš„äº§ç”Ÿå¼ä¼šè¢« Lexer å¿½ç•¥ã€‚&lt;/li>
&lt;li>&lt;code>_&lt;/code> å¼€å¤´çš„äº§ç”Ÿå¼å«åš &lt;code>regDefId&lt;/code>ï¼Œå¯ä»¥ç†è§£æˆç»™åé¢çš„æ¨¡å¼å®šä¹‰çš„åˆ«åã€‚&lt;/li>
&lt;li>&lt;code>a-z&lt;/code>å°å†™å­—æ¯å¼€å¤´çš„æ˜¯ &lt;code>token&lt;/code>ï¼Œä¹Ÿå°±æ˜¯ä¸€èˆ¬è¯´çš„è¯æ³•å…ƒç´ å®šä¹‰äº†ã€‚&lt;/li>
&lt;/ul>
&lt;p>å€¼å¾—æ³¨æ„çš„æ˜¯ &lt;code>token&lt;/code> ä¸èƒ½è¢«ç”¨ä½œå…¶ä»–è¯æ³•å…ƒç´ äº§ç”Ÿå¼çš„æ¨¡å¼éƒ¨åˆ†ï¼Œä½† &lt;code>regDefId&lt;/code> å¯ä»¥ï¼Œæ‰€ä»¥è¦æ³¨æ„è¦å¤ç”¨çš„è§„åˆ™åº”è¯¥å®šä¹‰æˆä¸‹åˆ’çº¿å¼€å¤´ã€‚&lt;/p>
&lt;p>æ¯”å¦‚è¯´ä¸‹é¢çš„ä¾‹å­ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">// example 1
letter: &amp;#39;a&amp;#39;-&amp;#39;z&amp;#39;;
identifier: letter; // Error!
// example 2
_letter: &amp;#39;a&amp;#39;-&amp;#39;z&amp;#39;;
identifier: _letter; // OK
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸‹é¢æ˜¯æ±‚å€¼å™¨çš„è¯æ³•å…ƒç´ å®šä¹‰ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">!whitespace: &amp;#39; &amp;#39; | &amp;#39;\t&amp;#39; | &amp;#39;\r&amp;#39; | &amp;#39;\n&amp;#39;;
!comment: &amp;#39;;&amp;#39; {.} &amp;#39;\n&amp;#39;;
//
// identifier
//
_letter : &amp;#39;a&amp;#39;-&amp;#39;z&amp;#39; | &amp;#39;A&amp;#39;-&amp;#39;Z&amp;#39;;
_initial: _letter;
_digit : &amp;#39;0&amp;#39;-&amp;#39;9&amp;#39; ;
_special_subsequent : &amp;#39;.&amp;#39; | &amp;#39;+&amp;#39; | &amp;#39;-&amp;#39; | &amp;#39;!&amp;#39; | &amp;#39;?&amp;#39;;
_subsequent: _initial | _digit | _special_subsequent;
_peculiar_identifier: &amp;#39;+&amp;#39; | &amp;#39;-&amp;#39; | &amp;#39;.&amp;#39; &amp;#39;.&amp;#39; &amp;#39;.&amp;#39;;
_identifier : _initial { _subsequent } | _peculiar_identifier;
identifier: _identifier;
quoted_identifier: &amp;#39;#&amp;#39; _identifier;
//
// boolean
//
_boolean_t: &amp;#39;#&amp;#39; &amp;#39;t&amp;#39;;
_boolean_f: &amp;#39;#&amp;#39; &amp;#39;f&amp;#39;;
boolean_t: _boolean_t;
boolean_f: _boolean_f;
//
// string
//
_string_element: &amp;#39;\\&amp;#39; &amp;#39;&amp;#34;&amp;#39; | . | &amp;#39;\\&amp;#39; &amp;#39;\\&amp;#39;;
_string : &amp;#39;&amp;#34;&amp;#39; { _string_element } &amp;#39;&amp;#34;&amp;#39;;
string: _string;
//
// number
//
_sign: &amp;#39;+&amp;#39; | &amp;#39;-&amp;#39;;
_uint10: _digit { _digit };
_ureal10 : [&amp;#39;.&amp;#39;] _uint10 | _uint10 &amp;#39;.&amp;#39; _digit {_digit};
_number : [_sign] _ureal10;
number: _number;
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¯æ³•å…ƒç´ å¾ˆç®€å•ï¼Œè¿ç®—ç¬¦ä¹Ÿå½“æˆ identifier å¤„ç†äº†ï¼Œä¸‡ä¸€è¦æ‰©å±•ä¹Ÿå®¹æ˜“ã€‚&lt;/p>
&lt;h2 id="è¯­æ³•å®šä¹‰">è¯­æ³•å®šä¹‰&lt;/h2>
&lt;p>gocc çš„è¯­æ³•å…ƒç´ å®šä¹‰å’Œè¯æ³•å…ƒç´ å®šä¹‰å·®ä¸å¤šã€‚äº§ç”Ÿå¼åç§°è¦ç”¨å¤§å†™å­—æ¯å¼€å¤´ï¼Œåé¢è·Ÿçš„å…ƒç´ åªèƒ½æ˜¯ &lt;code>token&lt;/code>ã€è¯­æ³•å…ƒç´ è¿˜æœ‰å­—ç¬¦ä¸²å­—é¢é‡ã€‚å¦å¤–å°±æ˜¯åœ¨æ¯ä¸ªè§„åˆ™åé¢å¯ä»¥åŠ ä¸Šä¸€ä¸ª â€œåŠ¨ä½œâ€ï¼Œç”¨è¿‡ flex/bison çš„åº”è¯¥çŸ¥é“æˆ‘è¯´çš„å•¥ã€‚è¿™ä¸ªåŠ¨ä½œæ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œæ±‚å€¼åå¿…é¡»æ˜¯ &lt;code>interface{}, error&lt;/code> è¿™æ ·çš„å…ƒç»„ã€‚è¿™ä¸ªæ±‚å€¼ç»“æœä¼šè¢« Parser è¿”å›ï¼Œæ‰€ä»¥éœ€è¦åœ¨ Action é‡Œå°±æŠŠ AST ç»„è£…å¥½ã€‚&lt;/p>
&lt;p>å¦å¤–å€¼å¾—ä¸€æçš„å°±æ˜¯è¯­æ³•å…ƒç´ çš„å®šä¹‰æ˜¯ä¸æ”¯æŒ &lt;code>[]&lt;/code>ã€&lt;code>{}&lt;/code> è¿™æ ·çš„ç³–çš„ï¼Œæ‰€ä»¥å¯é€‰å°±å¾—è‡ªå·±å†™æˆ &lt;code>Opt: Value | empty&lt;/code> ï¼Œé‡å¤ä¸€æˆ–å¤šæ¬¡å°±å¾—è‡ªå·±å†™æˆ &lt;code>Elements: Element | Elements Element&lt;/code> è¯¸å¦‚æ­¤ç±»ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">//
// Syntax start here
//
&amp;lt;&amp;lt;
import (
&amp;#34;github.com/nnnewb/minilang/pkg/ast&amp;#34;
&amp;#34;github.com/nnnewb/minilang/pkg/bnf/token&amp;#34;
)
&amp;gt;&amp;gt;
//
// value
//
Value
: identifier &amp;lt;&amp;lt; ast.Identifier(string($0.(*token.Token).Lit)), nil &amp;gt;&amp;gt;
| quoted_identifier &amp;lt;&amp;lt; ast.NewQuoted(ast.Identifier(string($0.(*token.Token).Lit[1:]))), nil &amp;gt;&amp;gt;
| boolean_t &amp;lt;&amp;lt; ast.Boolean(true), nil &amp;gt;&amp;gt;
| boolean_f &amp;lt;&amp;lt; ast.Boolean(false), nil &amp;gt;&amp;gt;
| number &amp;lt;&amp;lt; ast.NewNumber(string($0.(*token.Token).Lit)) &amp;gt;&amp;gt;
| string &amp;lt;&amp;lt; ast.String(string($0.(*token.Token).Lit)), nil &amp;gt;&amp;gt;
| List &amp;lt;&amp;lt; $0, nil &amp;gt;&amp;gt;
;
//
// list
//
ListElements
: Value &amp;lt;&amp;lt; ast.NewListWithInitial($0.(ast.Node)), nil &amp;gt;&amp;gt;
| ListElements Value &amp;lt;&amp;lt; $0.(*ast.List).Append($1.(ast.Node)), nil &amp;gt;&amp;gt;
;
List
: &amp;#34;(&amp;#34; ListElements &amp;#34;)&amp;#34; &amp;lt;&amp;lt; $1, nil &amp;gt;&amp;gt;
| &amp;#34;(&amp;#34; &amp;#34;)&amp;#34; &amp;lt;&amp;lt; ast.NewList(), nil &amp;gt;&amp;gt;
| &amp;#34;#(&amp;#34; ListElements &amp;#34;)&amp;#34; &amp;lt;&amp;lt; ast.NewQuoted($1.(ast.Node)), nil &amp;gt;&amp;gt;
| &amp;#34;#(&amp;#34; &amp;#34;)&amp;#34; &amp;lt;&amp;lt; ast.NewQuoted(ast.NewList()), nil &amp;gt;&amp;gt;
;
&lt;/code>&lt;/pre>&lt;/div>&lt;p>sè¡¨è¾¾å¼æœ¬èº«å°±æ˜¯ä¸€ä¸ªæ‹¬å·æ‹¬èµ·æ¥çš„åˆ—è¡¨ï¼Œæ‰€ä»¥è¯­æ³•å…ƒç´ æ›´ç®€å•äº†ï¼Œç›´æ¥æŠŠè¯æ³•å…ƒç´ æ”¾è¿›å»å°±è¡Œã€‚&lt;/p>
&lt;h2 id="è§£æå’Œæ‰§è¡Œ">è§£æå’Œæ‰§è¡Œ&lt;/h2>
&lt;h3 id="æ‰§è¡Œç¯å¢ƒ">æ‰§è¡Œç¯å¢ƒ&lt;/h3>
&lt;p>æ‰§è¡Œç¯å¢ƒå°±æ˜¯ä¿å­˜å˜é‡ï¼ˆè€ƒè™‘ä½œç”¨åŸŸçš„è¯è¿˜è¦åµŒå¥—ï¼‰ã€å‡½æ•°ï¼ˆæˆ–è€…å« procedureï¼‰ã€è§£é‡Šå™¨å†…å»ºçš„å‡½æ•°ä¹‹ç±»çš„ä¸œè¥¿çš„åœ°æ–¹ï¼Œç®€å•å®ç°æˆä¸€ä¸ª map å°±å®Œäº‹äº†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">ExecutionEnv&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">symbols&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nx">Value&lt;/span>
&lt;span class="nx">parent&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ExecutionEnv&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewExecutionEnv&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">parent&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ExecutionEnv&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ExecutionEnv&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">ExecutionEnv&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">symbols&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nx">Value&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">parent&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">parent&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ee&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ExecutionEnv&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">SetValue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">name&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">val&lt;/span> &lt;span class="nx">Value&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">Value&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">old&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">ee&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">symbols&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nx">ee&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">symbols&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">val&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">old&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ee&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ExecutionEnv&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">LookupName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">name&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">Value&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">val&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">ee&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">LookupLocalName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">val&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">val&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">ee&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">parent&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">LookupName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ee&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ExecutionEnv&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">LookupLocalName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">name&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">Value&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">val&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">ee&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">symbols&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">];&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">val&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æ±‚å€¼">æ±‚å€¼&lt;/h3>
&lt;p>è¯­è¨€å®šä¹‰é‡Œï¼ˆä¸æ˜¯ scheme çš„è¯­è¨€å®šä¹‰ï¼Œé‚£ä¸ªå»å‚è€ƒ r4rs/r5rs/r6rs/r7rsï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯æˆ‘ç»™è¿™ä¸ªç©å…·æ±‚å€¼å™¨çš„è¯­è¨€å®šä¹‰ï¼‰ï¼Œ&lt;code>(a b c)&lt;/code> è¿™æ ·çš„åˆ—è¡¨ç­‰äºæ˜¯ &lt;code>a(b, c)&lt;/code> è¿™æ ·çš„å‡½æ•°è°ƒç”¨ï¼Œè€ŒåŸå§‹åˆ—è¡¨å¾—å†™æˆ &lt;code>#(a b c)&lt;/code>ï¼Œå¯ä»¥ç†è§£æˆå‘Šè¯‰æ±‚å€¼å™¨è¦æŠŠç»™å‡ºçš„è¡¨è¾¾å¼å½“æˆæ•°æ®è¿˜æ˜¯ä»£ç ã€‚&lt;/p>
&lt;p>ç±»ä¼¼çš„è¿˜æœ‰&lt;code>ident&lt;/code>ä¼šè¢«æ±‚å€¼ï¼Œåœ¨æ‰§è¡Œç¯å¢ƒé‡Œå¯»æ‰¾å¯¹åº”çš„å˜é‡ï¼›&lt;code>#ident&lt;/code> æ±‚å€¼ç»“æœå°±æ˜¯æ ‡è¯†ç¬¦&lt;code>ident&lt;/code>ã€‚&lt;/p>
&lt;p>æ±‚å€¼è¿‡ç¨‹å°±æ˜¯ç®€å•çš„åšä¸ª type switchï¼Œå­—é¢é‡ä¸ç®¡ï¼ŒåŸå§‹åˆ—è¡¨å’Œæ ‡è¯†ç¬¦è¿”å›å†…å®¹ï¼Œå†ç„¶åå°±æ˜¯åˆ—è¡¨å½“æˆå‡½æ•°æ±‚å€¼ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ee&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ExecutionEnv&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">EvaluateList&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">list&lt;/span> &lt;span class="nx">List&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">Value&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">list&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">first&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">ee&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Evaluate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">list&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">fn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">first&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="nx">BuiltinFunc&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;TypeError: %v(%T) is not callable&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">first&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">first&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">args&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="nx">Value&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">list&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">:]))&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">list&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">:]&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">arg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">ee&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Evaluate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">args&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">args&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">arg&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nf">fn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ee&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">args&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ee&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ExecutionEnv&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Evaluate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">val&lt;/span> &lt;span class="nx">Value&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">Value&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">val&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="kd">type&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">List&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">ee&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">EvaluateList&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">Identifier&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">ee&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">LookupName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">string&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">)),&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Quoted&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetValue&lt;/span>&lt;span class="p">().(&lt;/span>&lt;span class="nx">Value&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å› ä¸ºè¿˜æ²¡å†™ procdure çš„å®šä¹‰ï¼Œæ‰€ä»¥ç›´æ¥æ‹¿ Builtin åšäº†ç±»å‹æ–­è¨€åˆ¤æ–­æ˜¯ä¸æ˜¯å¯ä»¥è°ƒç”¨ã€‚æˆ‘å¯»æ€ä¼ å‚å¤§æ¦‚ä¼šæ˜¯ä¸ªæŒºéº»çƒ¦çš„äº‹æƒ…ã€‚&lt;/p>
&lt;h3 id="repl">REPL&lt;/h3>
&lt;p>æœ€åå°±æ˜¯è§£é‡Šå™¨æœ¬ä½“äº†ï¼Œç”¨ &lt;code>go-prompt&lt;/code> åšäº†ä¸ªç®€å•çš„å¾ªç¯ï¼Œå†åŠ ä¸Šä¸€ç‚¹ç®—æ•°å‡½æ•°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/c-bata/go-prompt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/nnnewb/minilang/internal/builtin&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/nnnewb/minilang/internal/environment&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/nnnewb/minilang/pkg/ast&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/nnnewb/minilang/pkg/bnf/lexer&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/nnnewb/minilang/pkg/bnf/parser&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">input&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">prompt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Input&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">d&lt;/span> &lt;span class="nx">prompt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Document&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">prompt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Suggest&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">prompt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Suggest&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">input&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;.quit&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">break&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">ee&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">environment&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewExecutionEnv&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">nil&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">builtin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RegisterArithmeticBuiltin&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ee&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">ee&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetValue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;display&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">environment&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">BuiltinFunc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ee&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">environment&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ExecutionEnv&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">args&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">environment&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Value&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">environment&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Value&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">args&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nb">println&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}))&lt;/span>
&lt;span class="nx">lexer&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">lexer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewLexer&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="nb">byte&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">input&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="nx">parser&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">parser&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewParser&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">parseResult&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">parser&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Parse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">lexer&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;parse error %v\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">continue&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">val&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">environment&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewValueFromASTNode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">parseResult&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Node&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="nx">evaluated&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">ee&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Evaluate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">val&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;evaluation failed, error %v\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">continue&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;# (%T) %v\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">evaluated&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">evaluated&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ€åæ‰§è¡Œçš„æ•ˆæœå°±æ˜¯è¿™æ ·ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">&amp;gt;(display &amp;#34;Hello world!&amp;#34;)
&amp;#34;Hello world!&amp;#34;
# (&amp;lt;nil&amp;gt;) &amp;lt;nil&amp;gt;
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>sè¡¨è¾¾å¼æ±‚å€¼ä¸æ˜¯ä»€ä¹ˆå¤§ä¸äº†çš„ä¸œè¥¿ï¼Œä½† Lisp/Scheme ä¸­ä½“ç°å‡ºçš„é‚£ç§ â€œä»£ç å³æ•°æ®â€ çš„æ€æƒ³è¿˜æ˜¯å¾ˆæœ‰æ„æ€çš„ï¼Œç”šè‡³æ˜¯å¾ˆæœ‰æƒ³è±¡åŠ›çš„ã€‚&lt;/p>
&lt;p>ä¸ç®¡æ˜¯å‘½ä»¤å¼è¯­è¨€è¿˜æ˜¯å‡½æ•°å¼è¯­è¨€ï¼Œä»£ç å’Œæ•°æ®éƒ½æ˜¯è¢«åˆ†å¼€è®¨è®ºçš„ã€‚â€œä»£ç â€å¤„ç†â€œæ•°æ®â€ï¼Œæ”¾åœ¨ Lisp å®¶æ—é‡Œå°±æ˜¯ â€œä»£ç â€å¤„ç†â€œä»£ç â€ï¼Œæœ‰æ²¡æœ‰è”æƒ³åˆ° AI ï¼Ÿ&lt;/p>
&lt;p>å¥½å§ï¼Œæ¯•ç«Ÿæ˜¯ä¸Šä¸–çºªçš„å¤è‘£äº†ï¼Œç°åœ¨è¯´èµ· AI éƒ½æ˜¯ Python å’Œç¥ç»ç½‘ç»œã€‚ä½†ä¸ç®¡æ€ä¹ˆè¯´å§ï¼ŒLisp/Scheme è¿˜æ˜¯æŒºå¥½ç©çš„å¯¹å§ï¼Ÿæ²¡äº‹å¯ä»¥ä¸Š &lt;a class="link" href="https://racket-lang.org/" target="_blank" rel="noopener"
>Racket&lt;/a> å®˜ç½‘çœ‹çœ‹ï¼Œè¯´ä¸å®šä¼šå–œæ¬¢ä¸Š Lisp çš„å¥‡å¦™ä¹‹å¤„å‘¢ã€‚&lt;/p></description></item><item><title>ç®€å•çš„ECKéƒ¨ç½²</title><link>https://nnnewb.github.io/blog/p/simple-eck-cluster-deployment/</link><pubDate>Tue, 30 Nov 2021 11:13:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/simple-eck-cluster-deployment/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>å› ä¸ºå·¥ä½œéœ€è¦ï¼Œå¾—åœ¨è‡ªå·±æ­å»ºçš„é›†ç¾¤é‡Œéƒ¨ç½²ä¸€ä¸ª Elasticsearch ã€‚åˆå› ä¸ºæ˜¯äº‘ç«¯çš„é›†ç¾¤ï¼Œåœ¨ k8s å¤–ç”¨ docker å•ç‹¬èµ·ä¸€ä¸ª ES æ˜æ˜¾æ›´éš¾ç»´æŠ¤ï¼ˆä½†éƒ¨ç½²æ›´ç®€å•ï¼‰ï¼Œäºæ˜¯é€‰æ‹©ç”¨ ECK ã€‚&lt;/p>
&lt;p>ECK å°±æ˜¯ Elastic Cloud on Kubernetes çš„ç¼©å†™ï¼Œå¯ä»¥ç†è§£æˆéƒ¨ç½²åœ¨ Kubernetes ä¸Šçš„ Elasticsearch ã€‚å½“ç„¶ä¸æ­¢ ES ã€‚&lt;/p>
&lt;p>éƒ¨ç½² ES çš„è¿‡ç¨‹é‡åˆ°å‡ ä¸ªé—®é¢˜è®°å½•ä¸‹æ€ä¹ˆè§£å†³çš„ã€‚&lt;/p>
&lt;ol>
&lt;li>ES ä½¿ç”¨è‡ªç­¾åè¯ä¹¦ï¼Œå¯¼è‡´ HTTP ä¸èƒ½è¿æ¥ã€‚&lt;/li>
&lt;li>ECK éœ€è¦å®‰è£… IK åˆ†è¯æ’ä»¶ã€‚&lt;/li>
&lt;li>ECK é»˜è®¤å¯†ç æ¯æ¬¡éƒ¨ç½²éƒ½é‡æ–°ç”Ÿæˆï¼Œè€Œä¸”é»˜è®¤ç”¨æˆ·æƒé™è¿‡å¤§ã€‚&lt;/li>
&lt;li>ECK é»˜è®¤æ²¡é… PVC ï¼Œæ•°æ®æ²¡æœ‰æŒä¹…åŒ–ã€‚&lt;/li>
&lt;/ol>
&lt;p>æ¥ä¸‹æ¥é€ä¸ªè§£å†³ã€‚&lt;/p>
&lt;h2 id="0x01-è‡ªç­¾åè¯ä¹¦">0x01 è‡ªç­¾åè¯ä¹¦&lt;/h2>
&lt;p>è‡ªç­¾åè¯ä¹¦è§£å†³æ–¹æ³•æœ‰å‡ ä¸ª&lt;/p>
&lt;ol>
&lt;li>æ”¹å®¢æˆ·ç«¯ï¼Œè®©å®¢æˆ·ç«¯ç”¨è‡ªç­¾åè¯ä¹¦è¿æ¥ã€‚å¾ˆéº»çƒ¦ã€‚&lt;/li>
&lt;li>ç”Ÿæˆä¸€ä¸ªå›ºå®šçš„è¯ä¹¦ï¼Œè®©ESå’Œå®¢æˆ·ç«¯éƒ½ç”¨è¿™ä¸ªè¯ä¹¦ï¼Œå®¢æˆ·ç«¯å’ŒESéƒ½è¦æ”¹ã€‚å¾ˆéº»çƒ¦ã€‚&lt;/li>
&lt;li>ç¦ç”¨ ES çš„è‡ªç­¾åè¯ä¹¦ã€‚&lt;/li>
&lt;/ol>
&lt;p>è€ƒè™‘åˆ°æ˜¯ç§æœ‰çš„æµ‹è¯•ç¯å¢ƒï¼Œä¸æè¿™äº›çƒ¦äººçš„ä¸œè¥¿ï¼Œç›´æ¥ç¦ç”¨ã€‚&lt;/p>
&lt;p>ä¿®æ”¹ YAML å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">elasticsearch.k8s.elastic.co/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Elasticsearch&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">elasticsearch&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">http&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">tls&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">selfSignedCertificate&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">disabled&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ³¨æ„ &lt;code>spec.http.tls.selfSignedCertificate.disabled&lt;/code> è¿™ä¸ªå­—æ®µã€‚&lt;/p>
&lt;p>å‚è€ƒæ–‡æ¡£ï¼š&lt;a class="link" href="https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s-tls-certificates.html" target="_blank" rel="noopener"
>Orchestrating Elastic Stack applications - Access Elastic Stack services - TLS certificates&lt;/a>&lt;/p>
&lt;h2 id="0x02-å®‰è£…-ik-åˆ†è¯ç»„ä»¶">0x02 å®‰è£… IK åˆ†è¯ç»„ä»¶&lt;/h2>
&lt;p>å®˜æ–¹æ–‡æ¡£æä¾›çš„å®‰è£…æ’ä»¶æ€è·¯æ˜¯åˆ©ç”¨ initContainer ã€‚å‚è€ƒæ–‡æ¡£ï¼š&lt;a class="link" href="https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s-init-containers-plugin-downloads.html" target="_blank" rel="noopener"
>init containers for plugin downloads&lt;/a> ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">nodeSets&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">default&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">count&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">3&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">podTemplate&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">initContainers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">install-plugins&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">sh&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">c&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="p">|&lt;/span>&lt;span class="sd">
&lt;/span>&lt;span class="sd"> &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">bin/elasticsearch-plugin install --batch repository-gcs&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>initContainer å®¹å™¨é»˜è®¤ä¼šç»§æ‰¿è‡ªä¸‹é¢çš„å†…å®¹ï¼š&lt;/p>
&lt;ul>
&lt;li>æ²¡æœ‰å¦å¤–æŒ‡å®šçš„æƒ…å†µä¸‹ï¼Œç»§æ‰¿ä¸»å®¹å™¨çš„é•œåƒ(æˆ‘çš„ä¾‹å­ä¸­ï¼Œå°±æ˜¯ &lt;code>Elasticsearch:7.9.1&lt;/code>)&lt;/li>
&lt;li>ä¸»å®¹å™¨çš„ volume æŒ‚è½½ï¼Œå¦‚æœ initContainer æœ‰åŒååŒè·¯å¾„çš„ volume åˆ™ä¼˜å…ˆç”¨ initContainer çš„ã€‚&lt;/li>
&lt;li>POD åç§°å’Œ IP ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="0x03-æ·»åŠ è‡ªå®šä¹‰ç”¨æˆ·">0x03 æ·»åŠ è‡ªå®šä¹‰ç”¨æˆ·&lt;/h2>
&lt;p>æœ‰å¥½å‡ ç§æ–¹å¼ï¼š&lt;/p>
&lt;ol>
&lt;li>å®˜æ–¹æ–‡æ¡£ä¸­çš„æ–¹æ³•ï¼š&lt;a class="link" href="https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s-users-and-roles.html" target="_blank" rel="noopener"
>k8s users and roles&lt;/a>ï¼Œæ¯”è¾ƒç¨³å®šï¼Œä½†è¿˜æ˜¯æŒºéº»çƒ¦çš„ã€‚&lt;/li>
&lt;li>ä¿®æ”¹ &lt;code>[es-cluster-name]-es-elastic-user&lt;/code> è¿™ä¸ª &lt;code>secret&lt;/code>ï¼Œå¥½å¤„æ˜¯ç®€å•ï¼Œä½†è¦æ±‚å¿…é¡»å…ˆåˆ›å»º secret å†åˆ›å»º ES ï¼Œå•ä¸ª YAML å» &lt;code>create -f&lt;/code> çš„æƒ…å†µä¸‹ä¸å‹å¥½ã€‚&lt;/li>
&lt;li>åŸºäºç¬¬2èŠ‚ä¸­åˆ©ç”¨ initContainer çš„åšæ³•å’Œå®˜æ–¹æ–‡æ¡£é‡Œæåˆ°çš„ &lt;code>elasticsearch-users&lt;/code> å‘½ä»¤è¡Œå·¥å…·ï¼Œç›´æ¥åœ¨ initContainer é‡Œåˆ›å»ºæŒ‡å®šç”¨æˆ·åå¯†ç çš„ç”¨æˆ·ã€‚ä¸ç¡®å®šè¿™ä¸ªåšæ³•ä¼šä¸ä¼šåœ¨å¤šèŠ‚ç‚¹ ECK é‡Œå‡ºé—®é¢˜ï¼Œæ¯•ç«Ÿè¿™ç­‰äºæ˜¯æ¯ä¸ªèŠ‚ç‚¹éƒ½åˆ›å»ºäº†ä¸€æ¬¡ç”¨æˆ·ã€‚ä¸è¿‡æˆ‘åªéœ€è¦å•èŠ‚ç‚¹ï¼Œæ‰€ä»¥ä¹Ÿè¿˜è¿‡å¾—å»ã€‚&lt;/li>
&lt;/ol>
&lt;p>æœ€ç»ˆå†³å®šç”¨ç¬¬ 3 ç§æ–¹æ³•ï¼Œå› ä¸ºåšä¸€ä¸ªå•èŠ‚ç‚¹é›†ç¾¤ç®€å•ä¸è´¹äº‹ï¼Œå¤šèŠ‚ç‚¹çš„è¯ï¼Œç›®å‰å¼€çš„æœåŠ¡å™¨é…ç½®ä¹Ÿåƒä¸æ¶ˆã€‚ï¼ˆå…¶å®æ˜¯æå®Œæ‰ä»”ç»†è¯»æ–‡æ¡£ï¼Œç¬¬ 1 ç§æ–¹æ³•å…¶å®ä¹Ÿä¸ç®—å¤ªéº»çƒ¦&amp;hellip;ï¼‰&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">nodeSets&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">default&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">count&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">3&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">podTemplate&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">initContainers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">donviewclass-initialize&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">sh&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">c&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="p">|&lt;/span>&lt;span class="sd">
&lt;/span>&lt;span class="sd"> ./bin/elasticsearch-plugin install -batch https://ghproxy.com/https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.9.1/elasticsearch-analysis-ik-7.9.1.zip
&lt;/span>&lt;span class="sd"> ./bin/elasticsearch-users useradd tsdonviewclass -p tsdonviewclass -r superuser&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>./bin/elasticsearch-users useradd tsdonviewclass -p tsdonviewclass -r superuser&lt;/code> ä¸»è¦å°±æ˜¯å¢åŠ è¿™ä¸€å¥ã€‚åŒæ ·æ˜¯å› ä¸ºæ‡’ï¼Œæƒé™ç›´æ¥ç»™äº† superuser ã€‚&lt;/p>
&lt;p>å‚è€ƒæ–‡æ¡£ï¼š&lt;a class="link" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/users-command.html" target="_blank" rel="noopener"
>elasticsearch-users&lt;/a> ã€‚&lt;/p>
&lt;h2 id="0x04-é…ç½®pvc">0x04 é…ç½®PVC&lt;/h2>
&lt;p>ä¾ç„¶æ˜¯å‚è€ƒå®˜æ–¹æ–‡æ¡£æ¥ï¼š&lt;a class="link" href="https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s-volume-claim-templates.html" target="_blank" rel="noopener"
>k8s-volume-claim-templates&lt;/a>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">nodeSets&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">default&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">count&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">config&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">node.store.allow_mmap&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeClaimTemplates&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">elasticsearch-data&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Do not change this name unless you set up a volume mount for the data path.&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">accessModes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">ReadWriteOnce&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">requests&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">5Gi&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storageClassName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">local-path&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ³¨æ„ &lt;code>volumeClaimTemplates&lt;/code> ä¸‹ &lt;code>metadata.name&lt;/code> ä¸è¦å˜ï¼Œé™¤éä½ è‡ªå·±åœ¨ &lt;code>podTemplate&lt;/code> é‡Œè¦†å†™æŒ‚è½½å­—æ®µã€‚&lt;/p>
&lt;p>å…¶ä»–çš„ &lt;code>spec&lt;/code> ä¸‹å†…å®¹å’Œé€šå¸¸çš„ PVC ä¸€æ ·ï¼Œå¯ä»¥å‚è€ƒ &lt;a class="link" href="https://kubernetes.io/zh/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims" target="_blank" rel="noopener"
>Kubernetes - PersistentVolumeClaims&lt;/a> ã€‚&lt;/p>
&lt;p>å€¼å¾—æ³¨æ„çš„æ˜¯ ECK é»˜è®¤åœ¨é›†ç¾¤èŠ‚ç‚¹æ•°é‡ scaled down æ—¶åˆ é™¤ PVC ï¼Œå¯¹åº”çš„ PV å¯èƒ½ä¿ç•™ï¼Œå…·ä½“çœ‹&lt;a class="link" href="https://kubernetes.io/docs/concepts/storage/storage-classes/#reclaim-policy" target="_blank" rel="noopener"
>å­˜å‚¨ç±»çš„å›æ”¶ç­–ç•¥&lt;/a>ã€‚ECK çš„ CRD é‡Œä¹Ÿç»™äº†ç›¸å…³çš„é…ç½®é¡¹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">elasticsearch.k8s.elastic.co/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Elasticsearch&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">es&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">7.15.2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeClaimDeletePolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">DeleteOnScaledownOnly&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">nodeSets&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">default&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">count&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">3&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ³¨æ„ &lt;code>volumeClaimDeletePolicy: DeleteOnScaledownOnly&lt;/code> ã€‚å¯é€‰çš„ç­–ç•¥åŒ…æ‹¬ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>DeleteOnScaledownAndClusterDeletion&lt;/code>&lt;/li>
&lt;li>&lt;code>DeleteOnScaledownOnly&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>é»˜è®¤ç­–ç•¥æ˜¯ &lt;code>DeleteOnScaledownAndClusterDeletion&lt;/code> ï¼Œé›†ç¾¤åˆ é™¤å’Œ scaled down æ—¶åˆ é™¤ PVCã€‚&lt;/p>
&lt;p>å¦‚æœæ˜¯ä¸€æ¬¡æ€§çš„éƒ¨ç½²ï¼Œå¯ä»¥ç›´æ¥ç”¨ &lt;code>emptyDir&lt;/code> ä½œä¸ºå­˜å‚¨ç±»ï¼Œä¸ç”¨ç®¡æ•°æ®ä¸¢ä¸ä¸¢ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>è¿™å‡ æ­¥é…ç½®ä¸‹æ¥ï¼Œä¸€ä¸ªå¼€å‘ç”¨çš„ ES é›†ç¾¤å°±ç®—æ˜¯é…å®Œäº†ï¼Œèµ„æºç»™å¤Ÿå°±èƒ½å¼€å§‹ç©äº†ã€‚&lt;/p>
&lt;p>è®²é“ç†æˆ‘ä¸å¤ªä¼šè¿ç»´ ES å•Šï¼ŒES è¿™ä¸œè¥¿å®åœ¨æœ‰ç‚¹é‡é‡çº§ï¼Œç°é˜¶æ®µçš„èƒ½åŠ›ä¹Ÿå°±åªèƒ½çœ‹æ–‡æ¡£è¿™é‡Œé‚£é‡Œé…ä¸€ä¸‹ï¼Œåœ¨ä¸Šé¢å¼€å‘ä»€ä¹ˆçš„ã€‚çœŸè¦é‡åˆ°å¤§é—®é¢˜è¿˜å¾—æŠ“çã€‚&lt;/p>
&lt;p>å°±å…ˆè¿™æ ·å§ã€‚&lt;/p></description></item><item><title>kubeadmå®‰è£…å®éªŒé›†ç¾¤è®°å½•</title><link>https://nnnewb.github.io/blog/p/kubernetes-manually-install-by-kubeadm/</link><pubDate>Thu, 25 Nov 2021 14:31:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/kubernetes-manually-install-by-kubeadm/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>å¥½å§ï¼Œå¦‚æœä»”ç»†æƒ³æƒ³å°±ä¼šå‘ç°ä¸ç®¡æ˜¯ k3s è¿˜æ˜¯ ucloud ä¸Šçš„ k8s ï¼Œéƒ½æ²¡æœ‰ä¸€ä¸ªæ˜¯è‡ªå·±æ‰‹åŠ¨é…ç½®å¥½çš„ã€‚è™½è¯´å¹¶ä¸æ˜¯è‡³å…³é‡è¦çš„ï¼Œä½†æ‰‹åŠ¨ç”¨ kubeadm è£…ä¸€æ¬¡ kubernetes æ€»ä¸ä¼šæœ‰ä»€ä¹ˆåå¤„ã€‚é¡ºæ‰‹åšä¸ªç¬”è®°ã€‚å‚è€ƒèµ„æ–™åˆ—å‡ºå¦‚ä¸‹ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;a class="link" href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/" target="_blank" rel="noopener"
>https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://mirrors.tuna.tsinghua.edu.cn/help/kubernetes/" target="_blank" rel="noopener"
>https://mirrors.tuna.tsinghua.edu.cn/help/kubernetes/&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://computingforgeeks.com/deploy-kubernetes-cluster-on-ubuntu-with-kubeadm/" target="_blank" rel="noopener"
>https://computingforgeeks.com/deploy-kubernetes-cluster-on-ubuntu-with-kubeadm/&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="ç³»ç»Ÿé…ç½®">ç³»ç»Ÿé…ç½®&lt;/h2>
&lt;p>æ­£å¼å®‰è£…ä¹‹å‰å…ˆç¡®è®¤ä¸€äº›ç³»ç»Ÿçº§é…ç½®ã€‚&lt;/p>
&lt;h3 id="swapoff">swapoff&lt;/h3>
&lt;p>ç®€å•çš„åšæ³•æ˜¯ &lt;code>sudo swapoff -a&lt;/code> å³å¯ã€‚ä¹‹åæ”¹ &lt;code>fstab&lt;/code> æŠŠ &lt;code>swap&lt;/code> åˆ†åŒºå…³æ‰ã€‚&lt;/p>
&lt;h3 id="iptablesæ£€æŸ¥æ¡¥æ¥æµé‡">iptablesæ£€æŸ¥æ¡¥æ¥æµé‡&lt;/h3>
&lt;p>ç”¨ &lt;code>lsmod | grep bf_netfitler&lt;/code> æ£€æŸ¥æœ‰æ²¡æœ‰å¯ç”¨ &lt;code>bf_netfilter&lt;/code> æ¨¡å—ï¼Œå¦‚æœæ²¡æœ‰è¾“å‡ºçš„è¯è¯´æ˜æ²¡åŠ è½½ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">cat &lt;span class="s">&amp;lt;&amp;lt;EOF | sudo tee /etc/modules-load.d/k8s.conf
&lt;/span>&lt;span class="s">br_netfilter
&lt;/span>&lt;span class="s">EOF&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¼šåœ¨ &lt;code>/etc/modules-load.d&lt;/code> ä¸‹æ·»åŠ ä¸€ä¸ªæ¨¡å—è‡ªåŠ¨åŠ è½½çš„é…ç½®ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">cat &lt;span class="s">&amp;lt;&amp;lt;EOF | sudo tee /etc/sysctl.d/k8s.conf
&lt;/span>&lt;span class="s">net.bridge.bridge-nf-call-ip6tables = 1
&lt;/span>&lt;span class="s">net.bridge.bridge-nf-call-iptables = 1
&lt;/span>&lt;span class="s">EOF&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å†åœ¨ &lt;code>/etc/sysctl.d/&lt;/code> ä¸‹æ·»åŠ ä¸€ä¸ªé…ç½®ï¼Œå…è®¸ &lt;code>iptables&lt;/code> æŸ¥çœ‹æ¡¥æ¥æµé‡ã€‚&lt;/p>
&lt;p>ç„¶åç”¨ &lt;code>sysctl&lt;/code> é‡è½½é…ç½®ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">sudo sysctl --system
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="ç«¯å£">ç«¯å£&lt;/h3>
&lt;p>æ§åˆ¶å¹³é¢èŠ‚ç‚¹çš„ç«¯å£æ¸…å•ï¼Œå¦‚æœæœ‰æœ¬æœºé˜²ç«å¢™çš„è¯éœ€è¦å¼€æ”¾ä¸‹é¢çš„ç«¯å£ã€‚&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>åè®®&lt;/th>
&lt;th>æ–¹å‘&lt;/th>
&lt;th>ç«¯å£èŒƒå›´&lt;/th>
&lt;th>ä½œç”¨&lt;/th>
&lt;th>ä½¿ç”¨è€…&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>TCP&lt;/td>
&lt;td>å…¥ç«™&lt;/td>
&lt;td>6443&lt;/td>
&lt;td>Kubernetes API æœåŠ¡å™¨&lt;/td>
&lt;td>æ‰€æœ‰ç»„ä»¶&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>TCP&lt;/td>
&lt;td>å…¥ç«™&lt;/td>
&lt;td>2379-2380&lt;/td>
&lt;td>etcd æœåŠ¡å™¨å®¢æˆ·ç«¯ API&lt;/td>
&lt;td>kube-apiserver, etcd&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>TCP&lt;/td>
&lt;td>å…¥ç«™&lt;/td>
&lt;td>10250&lt;/td>
&lt;td>Kubelet API&lt;/td>
&lt;td>kubelet è‡ªèº«ã€æ§åˆ¶å¹³é¢ç»„ä»¶&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>TCP&lt;/td>
&lt;td>å…¥ç«™&lt;/td>
&lt;td>10251&lt;/td>
&lt;td>kube-scheduler&lt;/td>
&lt;td>kube-scheduler è‡ªèº«&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>TCP&lt;/td>
&lt;td>å…¥ç«™&lt;/td>
&lt;td>10252&lt;/td>
&lt;td>kube-controller-manager&lt;/td>
&lt;td>kube-controller-manager è‡ªèº«&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>å·¥ä½œèŠ‚ç‚¹çš„ç«¯å£æ¸…å•ï¼Œå¦‚æœæœ‰æœ¬æœºé˜²ç«å¢™çš„è¯éœ€è¦å¼€æ”¾ä¸‹é¢çš„ç«¯å£ã€‚&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>åè®®&lt;/th>
&lt;th>æ–¹å‘&lt;/th>
&lt;th>ç«¯å£èŒƒå›´&lt;/th>
&lt;th>ä½œç”¨&lt;/th>
&lt;th>ä½¿ç”¨è€…&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>TCP&lt;/td>
&lt;td>å…¥ç«™&lt;/td>
&lt;td>10250&lt;/td>
&lt;td>Kubelet API&lt;/td>
&lt;td>kubelet è‡ªèº«ã€æ§åˆ¶å¹³é¢ç»„ä»¶&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>TCP&lt;/td>
&lt;td>å…¥ç«™&lt;/td>
&lt;td>30000-32767&lt;/td>
&lt;td>NodePort æœåŠ¡â€ &lt;/td>
&lt;td>æ‰€æœ‰ç»„ä»¶&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="å®¹å™¨è¿è¡Œæ—¶">å®¹å™¨è¿è¡Œæ—¶&lt;/h3>
&lt;p>å‚è€ƒ &lt;a class="link" href="https://mirrors.tuna.tsinghua.edu.cn/help/docker-ce/" target="_blank" rel="noopener"
>æ¸…åå¤§å­¦å¼€æºè½¯ä»¶é•œåƒç«™ Docker Community Edition é•œåƒä½¿ç”¨å¸®åŠ©&lt;/a>ã€‚&lt;/p>
&lt;h3 id="å®‰è£…kubeadm">å®‰è£…kubeadm&lt;/h3>
&lt;p>å…ˆä¿¡ä»»è½¯ä»¶ä»“åº“çš„è¯ä¹¦ï¼Œè¦æ³¨æ„çš„æ˜¯è¯ä¹¦æ‰˜ç®¡åœ¨è°·æ­Œï¼Œæ‰€ä»¥åŸºæœ¬ä¸ç”¨è€ƒè™‘ç›´æ¥æ‰§è¡Œå‘½ä»¤èƒ½æˆåŠŸäº†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg &lt;span class="p">|&lt;/span> sudo apt-key add -
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½œä¸ºä»£æ›¿ï¼Œå¯ä»¥å…ˆæ‰‹åŠ¨é­”æ³•ä¸Šç½‘ä¸‹è½½åˆ°è¯ä¹¦ï¼Œå†å˜é€šä¸€ä¸‹å®Œæˆè¯ä¹¦æ·»åŠ ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">cat apt-key.gpg &lt;span class="p">|&lt;/span> sudo apt-key add -
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¹‹åæ·»åŠ æºï¼Œæºçš„ç‰ˆæœ¬å¹¶ä¸èƒ½ç›´æ¥å¯¹åº”åˆ°å‘è¡Œç‰ˆçš„ç‰ˆæœ¬ï¼Œç›®å‰ ubuntu server åªæ”¯æŒåˆ° 16.04 LTS ï¼Œæˆ–è€… Debian 9 Stretch ã€‚æ›´é«˜ç‰ˆæœ¬ä¹Ÿå¯ä»¥è£…ï¼Œä½†æˆ‘æ¯”è¾ƒæ€€ç–‘å®˜æ–¹çš„åŒ…åˆ°åº•æœ‰æ²¡æœ‰åœ¨æ–°å‘è¡Œç‰ˆé‡Œæµ‹è¯•è¿‡ï¼Œæ”¯æŒåŠ›åº¦è¡Œä¸è¡Œã€‚&lt;/p>
&lt;p>æ€»ä¹‹ï¼Œå¦‚æœå®¿ä¸»æœºä¸æ‹¿æ¥å½“å¼€å‘ç¯å¢ƒä½¿çš„è¯ï¼Œä¸Šä¸ª Ubuntu server 16.04 LTS ä¹Ÿæ²¡äº‹ï¼Œåªè¦è¿˜æ²¡æœ‰å®Œå…¨åœæ­¢æ”¯æŒå°±å¥½ã€‚æ€»ä¹‹è¿™ä¸ªé—®é¢˜ä¸Šæˆ‘ä¿ç•™æ„è§å§ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;deb https://mirrors.tuna.tsinghua.edu.cn/kubernetes/apt kubernetes-xenial main&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> sudo tee /etc/apt/sources.list.d/kubernetes.list
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ·»åŠ è½¯ä»¶æºä¹‹åæ›´æ–°è½¯ä»¶åŒ…æ¸…å•å¹¶å®‰è£… &lt;code>kubelet&lt;/code>ã€&lt;code>kubeadm&lt;/code>ã€&lt;code>kubectl&lt;/code> ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">sudo apt update
sudo apt install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æ£€æŸ¥">æ£€æŸ¥&lt;/h3>
&lt;p>é¦–å…ˆç¡®è®¤æ‰€æœ‰ &lt;code>kubelet&lt;/code>ã€&lt;code>kubeadm&lt;/code>ã€&lt;code>kubectl&lt;/code> å‘½ä»¤éƒ½å·²ç»å¯ç”¨ï¼Œå¦‚æœå‘½ä»¤ä¸å­˜åœ¨åˆ™è¯´æ˜å®‰è£…æœ‰é—®é¢˜ï¼Œæ ¹æ®å…·ä½“æƒ…å†µå¤„ç†ã€‚&lt;/p>
&lt;p>ç„¶åæ£€æŸ¥&lt;code>kubelet&lt;/code>æœåŠ¡çš„çŠ¶æ€ï¼ˆæ³¨æ„ç”¨äº†&lt;code>systemd&lt;/code>ï¼Œä¸ç¡®å®šæœ‰æ²¡æœ‰ç”¨ &lt;code>upstart&lt;/code> æˆ–åˆ«çš„ Unix é£æ ¼çš„æœåŠ¡ç®¡ç†çš„ï¼‰ã€‚&lt;/p>
&lt;p>è¿è¡Œå‘½ä»¤ &lt;code>sudo systemctl status kubelet&lt;/code> å¾—åˆ°ä¸‹é¢çš„è¾“å‡ºã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">â— kubelet.service - kubelet: The Kubernetes Node Agent
Loaded: loaded (/lib/systemd/system/kubelet.service; enabled; vendor preset: enabled)
Drop-In: /etc/systemd/system/kubelet.service.d
â””â”€10-kubeadm.conf
Active: activating (auto-restart) (Result: exit-code) since Fri 2021-11-19 02:32:29 UTC; 9s ago
Docs: https://kubernetes.io/docs/home/
Process: 6767 ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS (code=exited, status=1/FAILURE)
Main PID: 6767 (code=exited, status=1/FAILURE)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ­¤æ—¶çš„ &lt;code>kubelet&lt;/code> æœåŠ¡è¿˜æ˜¯å¤±è´¥çš„çŠ¶æ€ï¼Œå†æ£€æŸ¥ &lt;code>kubelet&lt;/code> çš„æ—¥å¿—ï¼Œé€šè¿‡ &lt;code>sudo journalctl -u kubelet&lt;/code> ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">-- Logs begin at Thu 2021-11-18 07:40:58 UTC, end at Fri 2021-11-19 02:34:19 UTC. --
Nov 19 02:27:41 vm systemd[1]: Started kubelet: The Kubernetes Node Agent.
Nov 19 02:27:42 vm systemd[1]: kubelet.service: Current command vanished from the unit file, execution of the command list won&amp;#39;t be resumed.
Nov 19 02:27:42 vm systemd[1]: Stopping kubelet: The Kubernetes Node Agent...
Nov 19 02:27:42 vm systemd[1]: kubelet.service: Succeeded.
Nov 19 02:27:42 vm systemd[1]: Stopped kubelet: The Kubernetes Node Agent.
Nov 19 02:27:42 vm systemd[1]: Started kubelet: The Kubernetes Node Agent.
Nov 19 02:27:42 vm kubelet[5944]: E1119 02:27:42.559949 5944 server.go:206] &amp;#34;Failed to load kubelet config file&amp;#34; err=&amp;#34;failed to load Kubelet config file /var/lib/kubelet/config.yaml, error failed to read kube&amp;gt;
Nov 19 02:27:42 vm systemd[1]: kubelet.service: Main process exited, code=exited, status=1/FAILURE
Nov 19 02:27:42 vm systemd[1]: kubelet.service: Failed with result &amp;#39;exit-code&amp;#39;.
Nov 19 02:27:52 vm systemd[1]: kubelet.service: Scheduled restart job, restart counter is at 1.
Nov 19 02:27:52 vm systemd[1]: Stopped kubelet: The Kubernetes Node Agent.
Nov 19 02:27:52 vm systemd[1]: Started kubelet: The Kubernetes Node Agent.
Nov 19 02:27:52 vm kubelet[6119]: E1119 02:27:52.804723 6119 server.go:206] &amp;#34;Failed to load kubelet config file&amp;#34; err=&amp;#34;failed to load Kubelet config file /var/lib/kubelet/config.yaml, error failed to read kube&amp;gt;
Nov 19 02:27:52 vm systemd[1]: kubelet.service: Main process exited, code=exited, status=1/FAILURE
Nov 19 02:27:52 vm systemd[1]: kubelet.service: Failed with result &amp;#39;exit-code&amp;#39;.
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¤±è´¥çš„åŸå› æ˜¯ &lt;code>Failed to load kubelet config file&amp;quot; err=&amp;quot;failed to load Kubelet config file /var/lib/kubelet/config.yaml, error failed to read kube&amp;gt;&lt;/code>ã€‚&lt;/p>
&lt;h2 id="åˆ›å»ºé›†ç¾¤">åˆ›å»ºé›†ç¾¤&lt;/h2>
&lt;p>ç›®æ ‡æ˜¯åˆ›å»ºä¸€ä¸ªå•èŠ‚ç‚¹çš„é›†ç¾¤ã€‚&lt;/p>
&lt;h3 id="æ‹‰å–é•œåƒ">æ‹‰å–é•œåƒ&lt;/h3>
&lt;p>ä¼—æ‰€å‘¨çŸ¥çš„åŸå› ï¼Œ&lt;code>kubernetes&lt;/code> çš„é•œåƒæ‰˜ç®¡åœ¨è°·æ­ŒæœåŠ¡å™¨ä¸Šï¼Œéº»ç“œæ˜¯è®¿é—®ä¸åˆ°çš„ï¼Œæ‰€ä»¥å°±è¿æ‹‰å–é•œåƒä¹Ÿå€¼å¾—ç”¨å‡ åä¸ªå­—æ¥è¯´ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">sudo kubeadm config images pull --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="åˆå§‹åŒ–ä¸»èŠ‚ç‚¹">åˆå§‹åŒ–ä¸»èŠ‚ç‚¹&lt;/h3>
&lt;p>æ³¨æ„ä½¿ç”¨ &lt;code>kubeadm config images pull&lt;/code> æ‹‰å–äº†é•œåƒçš„è¯ï¼Œåœ¨ &lt;code>init&lt;/code> é˜¶æ®µé™¤éä½ æŠŠé•œåƒ tag ç»™æ”¹äº†ï¼Œä¸ç„¶ä¹Ÿè¦ä¼ ä¸ª &lt;code>--image-repository&lt;/code> å‚æ•°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">sudo kubeadm init --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å®Œæ•´è¾“å‡ºå¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">[init] Using Kubernetes version: v1.22.4
[preflight] Running pre-flight checks
[preflight] Pulling images required for setting up a Kubernetes cluster
[preflight] This might take a minute or two, depending on the speed of your internet connection
[preflight] You can also perform this action in beforehand using &amp;#39;kubeadm config images pull&amp;#39;
[certs] Using certificateDir folder &amp;#34;/etc/kubernetes/pki&amp;#34;
[certs] Generating &amp;#34;ca&amp;#34; certificate and key
[certs] Generating &amp;#34;apiserver&amp;#34; certificate and key
[certs] apiserver serving cert is signed for DNS names [kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local vm] and IPs [10.96.0.1 10.0.2.15]
[certs] Generating &amp;#34;apiserver-kubelet-client&amp;#34; certificate and key
[certs] Generating &amp;#34;front-proxy-ca&amp;#34; certificate and key
[certs] Generating &amp;#34;front-proxy-client&amp;#34; certificate and key
[certs] Generating &amp;#34;etcd/ca&amp;#34; certificate and key
[certs] Generating &amp;#34;etcd/server&amp;#34; certificate and key
[certs] etcd/server serving cert is signed for DNS names [localhost vm] and IPs [10.0.2.15 127.0.0.1 ::1]
[certs] Generating &amp;#34;etcd/peer&amp;#34; certificate and key
[certs] etcd/peer serving cert is signed for DNS names [localhost vm] and IPs [10.0.2.15 127.0.0.1 ::1]
[certs] Generating &amp;#34;etcd/healthcheck-client&amp;#34; certificate and key
[certs] Generating &amp;#34;apiserver-etcd-client&amp;#34; certificate and key
[certs] Generating &amp;#34;sa&amp;#34; key and public key
[kubeconfig] Using kubeconfig folder &amp;#34;/etc/kubernetes&amp;#34;
[kubeconfig] Writing &amp;#34;admin.conf&amp;#34; kubeconfig file
[kubeconfig] Writing &amp;#34;kubelet.conf&amp;#34; kubeconfig file
[kubeconfig] Writing &amp;#34;controller-manager.conf&amp;#34; kubeconfig file
[kubeconfig] Writing &amp;#34;scheduler.conf&amp;#34; kubeconfig file
[kubelet-start] Writing kubelet environment file with flags to file &amp;#34;/var/lib/kubelet/kubeadm-flags.env&amp;#34;
[kubelet-start] Writing kubelet configuration to file &amp;#34;/var/lib/kubelet/config.yaml&amp;#34;
[kubelet-start] Starting the kubelet
[control-plane] Using manifest folder &amp;#34;/etc/kubernetes/manifests&amp;#34;
[control-plane] Creating static Pod manifest for &amp;#34;kube-apiserver&amp;#34;
[control-plane] Creating static Pod manifest for &amp;#34;kube-controller-manager&amp;#34;
[control-plane] Creating static Pod manifest for &amp;#34;kube-scheduler&amp;#34;
[etcd] Creating static Pod manifest for local etcd in &amp;#34;/etc/kubernetes/manifests&amp;#34;
[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory &amp;#34;/etc/kubernetes/manifests&amp;#34;. This can take up to 4m0s
sudo kubeadm init --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers[apiclient] All control plane components are healthy after 9.003038 seconds
[upload-config] Storing the configuration used in ConfigMap &amp;#34;kubeadm-config&amp;#34; in the &amp;#34;kube-system&amp;#34; Namespace
[kubelet] Creating a ConfigMap &amp;#34;kubelet-config-1.22&amp;#34; in namespace kube-system with the configuration for the kubelets in the cluster
[upload-certs] Skipping phase. Please see --upload-certs
[mark-control-plane] Marking the node vm as control-plane by adding the labels: [node-role.kubernetes.io/master(deprecated) node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]
[mark-control-plane] Marking the node vm as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule]
[bootstrap-token] Using token: jfhacg.2ahc3yqndiwct9vk
[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles
[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to get nodes
[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials
[bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token
[bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster
[bootstrap-token] Creating the &amp;#34;cluster-info&amp;#34; ConfigMap in the &amp;#34;kube-public&amp;#34; namespace
[kubelet-finalize] Updating &amp;#34;/etc/kubernetes/kubelet.conf&amp;#34; to point to a rotatable kubelet client certificate and key
[addons] Applied essential addon: CoreDNS
[addons] Applied essential addon: kube-proxy
Your Kubernetes control-plane has initialized successfully!
To start using your cluster, you need to run the following as a regular user:
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
Alternatively, if you are the root user, you can run:
export KUBECONFIG=/etc/kubernetes/admin.conf
You should now deploy a pod network to the cluster.
Run &amp;#34;kubectl apply -f [podnetwork].yaml&amp;#34; with one of the options listed at:
https://kubernetes.io/docs/concepts/cluster-administration/addons/
Then you can join any number of worker nodes by running the following on each as root:
kubeadm join 10.0.2.15:6443 --token jfhacg.2ahc3yqndiwct9vk \
--discovery-token-ca-cert-hash sha256:377d6ead2bde8373000333d883c9bd9449233686fe277814ccade0b55fc362a1
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å› ä¸ºæ˜¯è™šæ‹Ÿæœºé‡Œçš„é›†ç¾¤ï¼Œä¹Ÿæ²¡æ‰“ç®—ç»™ä»»ä½•äººè®¿é—®ï¼Œå…³é”®ä¿¡æ¯æ‡’å¾—æ‰“ç äº†ã€‚&lt;/p>
&lt;p>å‡ ä¸ªå€¼å¾—å…³æ³¨çš„å†…å®¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># Your Kubernetes control-plane has initialized successfully!&lt;/span>
&lt;span class="c1"># To start using your cluster, you need to run the following as a regular user:&lt;/span>
mkdir -p &lt;span class="nv">$HOME&lt;/span>/.kube
sudo cp -i /etc/kubernetes/admin.conf &lt;span class="nv">$HOME&lt;/span>/.kube/config
sudo chown &lt;span class="k">$(&lt;/span>id -u&lt;span class="k">)&lt;/span>:&lt;span class="k">$(&lt;/span>id -g&lt;span class="k">)&lt;/span> &lt;span class="nv">$HOME&lt;/span>/.kube/config
&lt;span class="c1"># Alternatively, if you are the root user, you can run:&lt;/span>
&lt;span class="nb">export&lt;/span> &lt;span class="nv">KUBECONFIG&lt;/span>&lt;span class="o">=&lt;/span>/etc/kubernetes/admin.conf
&lt;/code>&lt;/pre>&lt;/div>&lt;p>é¦–å…ˆï¼Œé›†ç¾¤æ§åˆ¶å¹³é¢å·²ç»åˆå§‹åŒ–æˆåŠŸäº†ï¼Œè¯´æ˜å‘½ä»¤æ‰§è¡ŒåŸºæœ¬ OKï¼Œæ²¡æœ‰è‡´å‘½é”™è¯¯ã€‚&lt;/p>
&lt;p>åé¢å°±æ˜¯æ•™ä½ æ€ä¹ˆé…ç½® &lt;code>kubectl&lt;/code> æ¥è®¿é—®æ§åˆ¶å¹³é¢ï¼Œé›†ç¾¤çš„ç®¡ç†å‘˜é…ç½®æ”¾åœ¨ &lt;code>/etc/kubernetes/admin.conf&lt;/code> ï¼Œå¯ä»¥ç”¨ &lt;code>KUBECONFIG&lt;/code> ç¯å¢ƒå˜é‡æ¥ä½¿ç”¨ï¼Œæˆ–è€…æŠŠé…ç½®æ–‡ä»¶å¤åˆ¶åˆ°å®¶ç›®å½•ä¸‹çš„è·¯å¾„ &lt;code>~/.kube/config&lt;/code> ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">You should now deploy a pod network to the cluster.
Run &amp;#34;kubectl apply -f [podnetwork].yaml&amp;#34; with one of the options listed at:
https://kubernetes.io/docs/concepts/cluster-administration/addons/
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æç¤ºä½ åº”è¯¥éƒ¨ç½²ä¸€ä¸ª POD ç½‘ç»œåˆ°é›†ç¾¤ï¼Œä¹Ÿå°±æ˜¯ä¸€èˆ¬è¯´çš„ CNI æ’ä»¶ï¼Œä»¥ä¾¿ POD ä¹‹é—´å¯ä»¥äº’ç›¸é€šä¿¡ã€‚å®‰è£…æ’ä»¶ä¹‹å‰ï¼Œé›†ç¾¤çš„ DNS ï¼ˆ&lt;code>CoreDNS&lt;/code>ï¼‰ ä¸ä¼šå¯åŠ¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">Then you can join any number of worker nodes by running the following on each as root:
kubeadm join 10.0.2.15:6443 --token jfhacg.2ahc3yqndiwct9vk \
--discovery-token-ca-cert-hash sha256:377d6ead2bde8373000333d883c9bd9449233686fe277814ccade0b55fc362a1
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸€æ—¦æå®šäº†ç½‘ç»œæ’ä»¶ï¼Œå°±å¯ä»¥ç”¨ &lt;code>kubeadm&lt;/code> ç»§ç»­æ·»åŠ æ–°çš„èŠ‚ç‚¹åˆ°é›†ç¾¤é‡Œäº†ã€‚&lt;/p>
&lt;h3 id="å®‰è£…ç½‘ç»œæ’ä»¶">å®‰è£…ç½‘ç»œæ’ä»¶&lt;/h3>
&lt;p>çœ‹èµ·æ¥å¤§å®¶éƒ½åœ¨ç”¨ &lt;code>calico&lt;/code> åš POD ç½‘ç»œï¼Œæ‰€ä»¥æˆ‘ä¹Ÿç”¨ &lt;code>calico&lt;/code> å¥½äº†ã€‚æ­¥éª¤å‚è€ƒ &lt;code>calico&lt;/code> çš„&lt;a class="link" href="https://docs.projectcalico.org/getting-started/kubernetes/self-managed-onprem/onpremises" target="_blank" rel="noopener"
>å®˜æ–¹æ–‡æ¡£&lt;/a> å’Œ &lt;a class="link" href="https://docs.projectcalico.org/getting-started/kubernetes/quickstart" target="_blank" rel="noopener"
>å®˜æ–¹çš„å¿«é€Ÿå¼€å§‹&lt;/a> æ¥é…ç½®ä¸€ä¸ªå•èŠ‚ç‚¹é›†ç¾¤çš„ POD ã€‚&lt;/p>
&lt;p>æ­£å¼å¼€å§‹å‰ï¼Œå‚è€ƒä¸Šé¢çš„å†…å®¹é…ç½®å¥½ &lt;code>kubectl&lt;/code> ï¼Œä»¥ä¾¿æ— éœ€ root æƒé™è¿è¡Œ &lt;code>kubectl&lt;/code> å‘½ä»¤ã€‚&lt;/p>
&lt;p>å…ˆä¸‹è½½ &lt;code>calico&lt;/code> çš„ k8s èµ„æºã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">curl https://docs.projectcalico.org/manifests/calico-typha.yaml -o calico.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æŒ‰ç…§è¯´æ˜ï¼Œåˆ¤æ–­ä¸‹ POD çš„ CIDRï¼ˆPODçš„ç½‘æ®µï¼‰ï¼Œç”¨ &lt;code>sudo kubectl --kubeconfig /etc/kubernetes/admin.conf get cm kubeadm-config -n kube-system -o yaml&lt;/code> è·å– &lt;code>kubeadm-config&lt;/code> è¿™ä¸ª &lt;code>configmap&lt;/code>ï¼Œæ£€æŸ¥å…¶ä¸­çš„ &lt;code>networking.podSubnet&lt;/code> å€¼ã€‚åœ¨æˆ‘è¿™é‡Œçš„è¾“å‡ºå¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">data&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">ClusterConfiguration&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="sd">
&lt;/span>&lt;span class="sd"> apiServer:
&lt;/span>&lt;span class="sd"> extraArgs:
&lt;/span>&lt;span class="sd"> authorization-mode: Node,RBAC
&lt;/span>&lt;span class="sd"> timeoutForControlPlane: 4m0s
&lt;/span>&lt;span class="sd"> apiVersion: kubeadm.k8s.io/v1beta3
&lt;/span>&lt;span class="sd"> certificatesDir: /etc/kubernetes/pki
&lt;/span>&lt;span class="sd"> clusterName: kubernetes
&lt;/span>&lt;span class="sd"> controllerManager: {}
&lt;/span>&lt;span class="sd"> dns: {}
&lt;/span>&lt;span class="sd"> etcd:
&lt;/span>&lt;span class="sd"> local:
&lt;/span>&lt;span class="sd"> dataDir: /var/lib/etcd
&lt;/span>&lt;span class="sd"> imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers
&lt;/span>&lt;span class="sd"> kind: ClusterConfiguration
&lt;/span>&lt;span class="sd"> kubernetesVersion: v1.22.4
&lt;/span>&lt;span class="sd"> networking:
&lt;/span>&lt;span class="sd"> dnsDomain: cluster.local
&lt;/span>&lt;span class="sd"> serviceSubnet: 10.96.0.0/12
&lt;/span>&lt;span class="sd"> scheduler: {}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ConfigMap&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">creationTimestamp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;2021-11-19T02:54:04Z&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">kubeadm-config&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">kube-system&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resourceVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;210&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">uid&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">2567d366-2257-4114-8709-12b016cd1fe8&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥å‘ç°æ²¡æœ‰ &lt;code>podSubnet&lt;/code>ï¼Œé‚£å°±å½“æ˜¯é»˜è®¤ï¼ŒæŒ‰ç…§ &lt;code>calico&lt;/code> æ–‡æ¡£è¯´æ˜ä¸ç”¨æ”¹ &lt;code>yaml&lt;/code>ï¼Œæ­£å¸¸åº”ç”¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">sudo kubectl --kubeconfig /etc/kubernetes/admin.conf apply -f calico.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¾“å‡ºå¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">configmap/calico-config created
customresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/caliconodestatuses.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/ipreservations.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/kubecontrollersconfigurations.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created
clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created
clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created
clusterrole.rbac.authorization.k8s.io/calico-node created
clusterrolebinding.rbac.authorization.k8s.io/calico-node created
service/calico-typha created
deployment.apps/calico-typha created
Warning: policy/v1beta1 PodDisruptionBudget is deprecated in v1.21+, unavailable in v1.25+; use policy/v1 PodDisruptionBudget
poddisruptionbudget.policy/calico-typha created
daemonset.apps/calico-node created
serviceaccount/calico-node created
deployment.apps/calico-kube-controllers created
serviceaccount/calico-kube-controllers created
poddisruptionbudget.policy/calico-kube-controllers created
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å‡ºç°äº†ä¸€ä¸ªå¼ƒç”¨è­¦å‘Šï¼Œæ— è§†ä¹‹ï¼Œåæ­£æ˜¯ &lt;code>calico&lt;/code> çš„é—®é¢˜ã€‚å†æ£€æŸ¥ä¸‹ç›¸å…³çš„ &lt;code>POD&lt;/code> åˆ›å»ºæ˜¯å¦æˆåŠŸï¼Œç”¨å‘½ä»¤ &lt;code>kubectl get pod -n kube-system&lt;/code>ï¼Œè¾“å‡ºå¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">NAMESPACE NAME READY STATUS RESTARTS AGE
kube-system calico-kube-controllers-5d995d45d6-gwwrw 1/1 Running 0 5m29s
kube-system calico-node-sgb2x 0/1 Running 2 (49s ago) 5m29s
kube-system calico-typha-7df55cc78b-hpfkx 0/1 Pending 0 5m29s
kube-system coredns-7d89d9b6b8-c7sxl 1/1 Running 0 32m
kube-system coredns-7d89d9b6b8-tjsj8 1/1 Running 0 32m
kube-system etcd-vm 1/1 Running 0 32m
kube-system kube-apiserver-vm 1/1 Running 0 32m
kube-system kube-controller-manager-vm 1/1 Running 0 32m
kube-system kube-proxy-d64kh 1/1 Running 0 32m
kube-system kube-scheduler-vm 1/1 Running 0 32m
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°è‡³å°‘é•œåƒæ˜¯æ‹‰åˆ°äº†ã€‚&lt;/p>
&lt;p>&lt;code>calico-typha-7df55cc78b-hpfkx&lt;/code> è¿™ä¸ª POD çš„ &lt;code>describe&lt;/code> æ˜¾ç¤ºä¸èƒ½è¿è¡Œåœ¨ &lt;code>master&lt;/code> èŠ‚ç‚¹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">Events:
Type Reason Age From Message
---- ------ ---- ---- -------
Warning FailedScheduling 56s (x9 over 8m57s) default-scheduler 0/1 nodes are available: 1 node(s) had taint {node-role.kubernetes.io/master: }, that the pod didn&amp;#39;t tolerate.
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è€Œ &lt;code>calico-node-sgb2x&lt;/code> çš„æ—¥å¿—æ˜¾ç¤ºéœ€è¦ &lt;code>calico-typha&lt;/code> æ‰èƒ½è¿è¡Œã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">2021-11-19 03:27:46.413 [ERROR][1674] confd/discovery.go 153: Didn&amp;#39;t find any ready Typha instances.
2021-11-19 03:27:46.413 [FATAL][1674] confd/startsyncerclient.go 48: Typha discovery enabled but discovery failed. error=Kubernetes service missing IP or port
bird: Unable to open configuration file /etc/calico/confd/config/bird6.cfg: No such file or directory
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å› ä¸ºæƒ³è¦çš„æ˜¯ä¸€ä¸ªå•èŠ‚ç‚¹é›†ç¾¤ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æŠŠæœ¬èŠ‚ç‚¹çš„æ±¡ç‚¹ &lt;code>node-role.kubernetes.io/master-&lt;/code> ç»™å»æ‰ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">sudo kubectl --kubeconfig /etc/kubernetes/admin.conf taint nodes --all node-role.kubernetes.io/master-
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¾“å‡º&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">node/vm untainted
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å†è§‚å¯Ÿ &lt;code>kube-system&lt;/code> é‡Œçš„ POD çŠ¶æ€ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">NAME READY STATUS RESTARTS AGE
calico-kube-controllers-5d995d45d6-gwwrw 1/1 Running 0 11m
calico-node-sgb2x 1/1 Running 7 (38s ago) 11m
calico-typha-7df55cc78b-hpfkx 1/1 Running 0 11m
coredns-7d89d9b6b8-c7sxl 1/1 Running 0 38m
coredns-7d89d9b6b8-tjsj8 1/1 Running 0 38m
etcd-vm 1/1 Running 0 38m
kube-apiserver-vm 1/1 Running 0 38m
kube-controller-manager-vm 1/1 Running 0 38m
kube-proxy-d64kh 1/1 Running 0 38m
kube-scheduler-vm 1/1 Running 0 38m
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„PODéƒ½å·²ç»è¿›å…¥&lt;code>Ready&lt;/code>çŠ¶æ€ã€‚&lt;/p>
&lt;p>æœ€åé€šè¿‡ &lt;code>kubectl get nodes -o wide&lt;/code> æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">NAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIME
vm Ready control-plane,master 39m v1.22.4 10.0.2.15 &amp;lt;none&amp;gt; Ubuntu 20.04.3 LTS 5.4.0-90-generic docker://20.10.11
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ°è¿™é‡Œå•èŠ‚ç‚¹é›†ç¾¤å°±æˆåŠŸéƒ¨ç½²äº†ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>ä¹‹åè¿˜å¯ä»¥éƒ¨ç½² dashboard ä¹‹ç±»çš„åº”ç”¨éªŒè¯ï¼Œä¸æƒ³å†™äº†ï¼Œæµªè´¹æ—¶é—´ã€‚&lt;/p>
&lt;p>å†™äº†ä¸€å¤§å †åˆåˆ æ‰äº†ã€‚&lt;/p>
&lt;p>å¦‚æœä¸€å®šè¦æ€»ç»“çš„è¯ï¼Œk8sï¼Œå­¦äº†è¿›å°å‚å§ï¼Œå°å‚ä¸ç”¨ï¼›å­¦äº†è¿›å¤§å‚å§ï¼Œå¤§å‚ä¹Ÿä¸è¦ä½ ã€‚&lt;/p></description></item><item><title>å¯†ç å­¦å…¥é—¨03 - å¤å…¸å¯†ç #3</title><link>https://nnnewb.github.io/blog/p/cryptography-introduction-03/</link><pubDate>Tue, 16 Nov 2021 11:31:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/cryptography-introduction-03/</guid><description>&lt;img src="https://nnnewb.github.io/blog/p/cryptography-introduction-03/cover.jpg" alt="Featured image of post å¯†ç å­¦å…¥é—¨03 - å¤å…¸å¯†ç #3" />&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>å­¦ä¹ ä¸€ä¸‹ Hill å¯†ç ã€‚&lt;/p>
&lt;h2 id="0x01-æ•°å­¦åŸºç¡€">0x01 æ•°å­¦åŸºç¡€&lt;/h2>
&lt;p>å‚è€ƒäº† &lt;a class="link" href="https://www.shuxuele.com/algebra/matrix-introduction.html" target="_blank" rel="noopener"
>æ•°å­¦ä¹&lt;/a> ã€‚æ²¡æœ‰è¯¦ç»†ä»‹ç»çŸ©é˜µçš„æ„ä¹‰ï¼Œä½†åŸºæœ¬è¿ç®—è§„åˆ™ä¹‹ç±»çš„è®²å¾—å¾ˆæ¸…æ¥šå¥½æ‡‚ã€‚&lt;/p>
&lt;h3 id="11-çŸ©é˜µ">1.1 çŸ©é˜µ&lt;/h3>
&lt;p>ä¸€ä¸ªçŸ©é˜µå°±æ˜¯nè¡Œmåˆ—çš„æ•°å­—è¡¨æ ¼ï¼Œå«ä¹‰æš‚ä¸è€ƒè™‘ï¼Œåªå­¦ä¹ ä¸‹çŸ©é˜µçš„è¡¨ç¤ºæ–¹æ³•ã€è¿ç®—è§„åˆ™ï¼Œä¸ç„¶æœ‰ç‚¹éš¾è¯»æ‡‚ Hill å¯†ç çš„è§„åˆ™ã€‚&lt;/p>
&lt;p>ä¸€ä¸ªæœ‰ &lt;em>m&lt;/em> è¡Œï¼Œ&lt;em>n&lt;/em> åˆ—çš„çŸ©é˜µ &lt;em>A&lt;/em> çš„ä¹¦å†™å½¢å¼å¦‚ä¸‹ã€‚
$$
A=\begin{bmatrix}
a_{11} &amp;amp; a_{12} &amp;amp; \dots &amp;amp; a_{1n} \\ a_{21} &amp;amp; a_{22} &amp;amp; \dots &amp;amp; a_{2n} \\ \vdots &amp;amp; \vdots &amp;amp; &amp;amp; \vdots \\ a_{m1} &amp;amp; a_{m2} &amp;amp; \dots &amp;amp; a_{mn}
\end{bmatrix}
$$&lt;/p>
&lt;h3 id="12-çŸ©é˜µåŠ æ³•å‡æ³•">1.2 çŸ©é˜µåŠ æ³•/å‡æ³•&lt;/h3>
&lt;p>çŸ©é˜µåŠ å‡æ³•è§„åˆ™å¦‚ä¸‹ã€‚è®¾æœ‰çŸ©é˜µ &lt;em>A&lt;/em>ã€&lt;em>B&lt;/em> å¦‚ä¸‹ã€‚
$$
A=\begin{bmatrix}
a_{11} &amp;amp; a_{12} &amp;amp; \dots &amp;amp; a_{1n} \\ a_{21} &amp;amp; a_{22} &amp;amp; \dots &amp;amp; a_{2n} \\ \vdots &amp;amp; \vdots &amp;amp; &amp;amp; \vdots \\ a_{m1} &amp;amp; a_{m2} &amp;amp; \dots &amp;amp; a_{mn}
\end{bmatrix},B=\begin{bmatrix}
b_{11} &amp;amp; b_{12} &amp;amp; \dots &amp;amp; b_{1n} \\ b_{21} &amp;amp; b_{22} &amp;amp; \dots &amp;amp; b_{2n} \\ \vdots &amp;amp; \vdots &amp;amp; &amp;amp; \vdots \\ b_{m1} &amp;amp; b_{m2} &amp;amp; \dots &amp;amp; b_{mn}
\end{bmatrix}
$$
åˆ™è®¡ç®— AÂ±B çš„è§„åˆ™å¦‚ä¸‹ã€‚
$$
AÂ±B=\begin{bmatrix}
a_{11}Â±b_{11} &amp;amp; a_{12}Â±b_{12} &amp;amp; \dots &amp;amp; a_{1n}Â±b_{1n} \\ a_{21}Â±b_{21} &amp;amp; a_{22}Â±b_{22} &amp;amp; \dots &amp;amp; a_{2n}Â±b_{2n} \\ \vdots &amp;amp; \vdots &amp;amp; &amp;amp; \vdots \\ a_{m1}Â±b_{m1} &amp;amp; a_{m2}Â±b_{m2} &amp;amp; \dots &amp;amp; a_{mn}Â±b_{mn}
\end{bmatrix}
$$
æ€§è´¨ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;strong>åªæœ‰è¡Œåˆ—æ•°ç›¸åŒçš„çŸ©é˜µï¼ŒåŠ å‡æ³•æ‰æœ‰æ„ä¹‰&lt;/strong>&lt;/li>
&lt;li>&lt;strong>çŸ©é˜µçš„åŠ å‡æ³•ï¼Œå°±æ˜¯çŸ©é˜µä¸­ç›¸åŒä½ç½®å…ƒç´ åŠ å‡&lt;/strong>&lt;/li>
&lt;li>çŸ©é˜µåŠ å‡æ³•æ»¡è¶³ &lt;strong>äº¤æ¢å¾‹&lt;/strong>ï¼ˆ&lt;code>A+B=B+A&lt;/code>ï¼‰ å’Œ &lt;strong>ç»“åˆå¾‹&lt;/strong> ï¼ˆ&lt;code>A+(B+C)=(A+B)+c&lt;/code>ï¼‰&lt;/li>
&lt;/ul>
&lt;h3 id="12-çŸ©é˜µæ•°ä¹˜">1.2 çŸ©é˜µæ•°ä¹˜&lt;/h3>
&lt;p>æ•°Î»ä¹˜çŸ©é˜µ &lt;em>A&lt;/em>ï¼Œå³ä½¿å°†æ•°Î»ä¹˜çŸ©é˜µAä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ï¼Œè®°ä¸º &lt;em>Î»A&lt;/em> æˆ– &lt;em>AÎ»&lt;/em>ã€‚&lt;/p>
&lt;p>ç‰¹åˆ«çš„ï¼Œç§° &lt;em>-A&lt;/em> ä¸º &lt;em>A&lt;/em> çš„è´ŸçŸ©é˜µã€‚&lt;/p>
&lt;p>æ€§è´¨ï¼š&lt;/p>
&lt;ul>
&lt;li>æ»¡è¶³ &lt;strong>ç»“åˆå¾‹&lt;/strong> ï¼ˆ&lt;code>(Î»Î¼)A=Î»(Î¼A); (Î»+Î¼)A=Î»A+Î¼A&lt;/code>ï¼‰ å’Œ &lt;strong>åˆ†é…å¾‹&lt;/strong> ï¼ˆ&lt;code>Î»(A+B)=Î»A+Î»B&lt;/code>ï¼‰&lt;/li>
&lt;/ul>
&lt;h3 id="13-çŸ©é˜µä¹˜æ³•">1.3 çŸ©é˜µä¹˜æ³•&lt;/h3>
&lt;p>å…ˆçœ‹çŸ©é˜µçš„å¦ä¸€ç§è¡¨ç¤ºå½¢å¼ï¼š&lt;em>A=(a&lt;sub>ij&lt;/sub>)&lt;sub>mxs&lt;/sub>&lt;/em> ï¼Œè¿™ç§è¡¨ç¤ºå½¢å¼ä¸­ï¼Œ&lt;em>m&lt;/em> è¡¨ç¤ºè¡Œæ•°ï¼Œ&lt;em>s&lt;/em> è¡¨ç¤ºåˆ—æ•°ï¼Œ&lt;em>a&lt;sub>ij&lt;/sub>&lt;/em> å§‘ä¸”å½“å ä½ï¼Œè¡¨ç¤ºçŸ©é˜µå…ƒç´ ã€‚&lt;/p>
&lt;p>è®¾ &lt;em>A=(a&lt;sub>ij&lt;/sub>)&lt;sub>mxs&lt;/sub>&lt;/em> &lt;em>B=(b&lt;sub>ij&lt;/sub>)&lt;sub>sxn&lt;/sub>&lt;/em> ï¼Œåˆ™ &lt;em>A=AB&lt;/em> æ˜¯è¿™æ ·ä¸€ä¸ªçŸ©é˜µï¼š&lt;/p>
&lt;ol>
&lt;li>è¡Œæ•°å’Œå·¦çŸ©é˜µ &lt;em>A&lt;/em> ç›¸åŒï¼Œåˆ—æ•°å’Œå³çŸ©é˜µ &lt;em>B&lt;/em> ç›¸åŒï¼Œå³ &lt;em>C=(c&lt;sub>ij&lt;/sub>)&lt;sub>mxn&lt;/sub>&lt;/em> ã€‚&lt;/li>
&lt;li>&lt;em>C&lt;/em> çš„ç¬¬ &lt;em>i&lt;/em> è¡Œç¬¬ &lt;em>j&lt;/em> åˆ—çš„å…ƒç´  &lt;em>c&lt;sub>ij&lt;/sub>&lt;/em> ç”± &lt;em>A&lt;/em> çš„ç¬¬ &lt;em>i&lt;/em> è¡Œå…ƒç´ å’Œ &lt;em>B&lt;/em> çš„ç¬¬ &lt;em>j&lt;/em> åˆ—å…ƒç´ å¯¹åº”ç›¸ä¹˜ï¼Œå†å–ä¹˜ç§¯ä¹‹å’Œã€‚&lt;/li>
&lt;/ol>
&lt;p>ä¸¾ä¾‹æ¥è¯´ï¼Œå°†è¿™ä¸¤ä¸ªçŸ©é˜µç›¸ä¹˜ã€‚&lt;/p>
&lt;p>$$
A=\begin{bmatrix}
1 &amp;amp; 2 \\ 1 &amp;amp; -1
\end{bmatrix},B=
\begin{bmatrix}
1 &amp;amp; 2 &amp;amp; -3 \\ -1 &amp;amp; 1 &amp;amp; 2
\end{bmatrix}
$$
ç»“æœæ˜¯ä¸€ä¸ª 2x3 çš„çŸ©é˜µï¼Œæ¯ä¸ªå…ƒç´ è®¡ç®—å¦‚ä¸‹ï¼š
$$
AB=\begin{bmatrix}
(1Ã—1+2Ã—-1) &amp;amp; (1Ã—2+2Ã—1) &amp;amp; (1Ã—-3+2Ã—2) \\ (1Ã—1+-1Ã—-1) &amp;amp; (1Ã—2+-1Ã—1) &amp;amp; (1Ã—-3+-1Ã—2)
\end{bmatrix}=
\begin{bmatrix}
-1 &amp;amp; 4 &amp;amp; 1 \\ 2 &amp;amp; 1 &amp;amp; -5
\end{bmatrix}
$$
å…ˆç”¨ &lt;em>A&lt;/em> çš„ç¬¬1è¡Œï¼Œåˆ†åˆ«ä¹˜ &lt;em>B&lt;/em> çš„ç¬¬1ã€2ã€3åˆ—ï¼Œä½œä¸ºç»“æœçŸ©é˜µ &lt;em>C&lt;/em> çš„ç¬¬1è¡Œã€‚ç„¶åç”¨ &lt;em>A&lt;/em> çš„ç¬¬2è¡Œï¼Œåˆ†åˆ«ä¹˜ &lt;em>B&lt;/em> çš„ç¬¬1ã€2ã€3åˆ—ï¼Œä½œä¸ºç»“æœçŸ©é˜µ &lt;em>C&lt;/em> çš„ç¬¬äºŒè¡Œã€‚&lt;/p>
&lt;p>æ³¨æ„ï¼šç›¸ä¹˜çš„çŸ©é˜µåº”è¯¥æ»¡è¶³æ¡ä»¶ï¼Œå·¦ä¾§çŸ©é˜µåˆ—æ•°ç­‰äºå³ä¾§çŸ©é˜µè¡Œæ•°ï¼Œè®¡ç®—æ‰èƒ½è¿›è¡Œã€‚&lt;/p>
&lt;p>æ€§è´¨ï¼ˆå‡è®¾è¿ç®—éƒ½æ˜¯å¯è¡Œçš„ï¼‰ï¼š&lt;/p>
&lt;ol>
&lt;li>ç¬¦åˆç»“åˆå¾‹ &lt;em>(AB)C=A(BC)&lt;/em>&lt;/li>
&lt;li>ç¬¦åˆåˆ†é…å¾‹ &lt;em>A(BÂ±C)=ABÂ±AC&lt;/em> ï¼ˆå·¦åˆ†é…å¾‹ï¼‰; &lt;em>(BÂ±C)A=BAÂ±CA&lt;/em> ï¼ˆå³åˆ†é…å¾‹ï¼‰&lt;/li>
&lt;li>&lt;em>(Î»A)B=Î»(AB)=A(Î»B)&lt;/em>&lt;/li>
&lt;/ol>
&lt;h3 id="14-çŸ©é˜µè½¬ç½®">1.4 çŸ©é˜µè½¬ç½®&lt;/h3>
&lt;p>å°† &lt;em>A&lt;/em> çŸ©é˜µçš„è¡Œæ¢æˆåŒåºå·çš„åˆ—æ‰€å¾—åˆ°çš„æ–°çŸ©é˜µç§°ä¸º &lt;em>A&lt;/em> çš„è½¬ç½®çŸ©é˜µï¼Œè®°ä½œ &lt;em>A'&lt;/em> æˆ–è€… &lt;em>A&lt;sup>T&lt;/sup>&lt;/em> ã€‚
$$
A=
\begin{bmatrix}
1 &amp;amp; 0 &amp;amp; 3 &amp;amp; -1 \\ 2 &amp;amp; 1 &amp;amp; 0 &amp;amp; 2
\end{bmatrix},A'=A^T=
\begin{bmatrix}
1 &amp;amp; 2 \\ 0 &amp;amp; 1 \\ 3 &amp;amp; 0 \\ -1 &amp;amp; 2
\end{bmatrix}
$$
æ€§è´¨ï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;em>(A')'=A&lt;/em>&lt;/li>
&lt;li>&lt;em>(A+B)'=A'+B'&lt;/em>&lt;/li>
&lt;li>&lt;em>(AB)'=B&amp;rsquo;A'&lt;/em>&lt;/li>
&lt;li>&lt;em>(Î»A)'=Î»A'&lt;/em>ï¼ŒÎ»æ˜¯å¸¸æ•°&lt;/li>
&lt;/ol>
&lt;h3 id="15-å¯¹ç§°çŸ©é˜µ">1.5 å¯¹ç§°çŸ©é˜µ&lt;/h3>
&lt;p>å¦‚æœçŸ©é˜µ &lt;em>A&lt;/em> æ»¡è¶³ &lt;em>A'=A&lt;/em> ï¼Œå³ &lt;em>a&lt;sub>ij&lt;/sub>=a&lt;sub>ji&lt;/sub>&lt;/em> ï¼Œåˆ™ç§° &lt;em>A&lt;/em> ä¸º &lt;strong>å¯¹ç§°çŸ©é˜µ&lt;/strong>ã€‚&lt;/p>
&lt;p>å¯¹ç§°çŸ©é˜µçš„ç‰¹ç‚¹æ˜¯å®ƒçš„å…ƒç´ ä»¥ä¸»å¯¹è§’çº¿ä¸ºå¯¹ç§°è½´å¯¹åº”ç›¸ç­‰ã€‚&lt;/p>
&lt;p>ä¸¾ä¾‹å¦‚ä¸‹ã€‚
$$
A=\begin{bmatrix}
1 &amp;amp; 2 &amp;amp; 3 \\ 2 &amp;amp; 1 &amp;amp; 2 \\ 3 &amp;amp; 2 &amp;amp; 1
\end{bmatrix}
$$&lt;/p>
&lt;p>å°è¯•å°†è¿™ä¸ªçŸ©é˜µè½¬ç½®ï¼Œä»¤ &lt;em>a&lt;sub>ij&lt;/sub>=a&lt;sub>ji&lt;/sub>&lt;/em> ï¼Œå¾—åˆ°ä¸‹é¢çš„çŸ©é˜µï¼Œå‘ç°çš„ç¡®å’ŒåŸçŸ©é˜µç›¸åŒã€‚
$$
A'=\begin{bmatrix}
a_{11} &amp;amp; a_{21} &amp;amp; a_{31} \\ a_{12} &amp;amp; a_{22} &amp;amp; a_{32} \\ a_{13} &amp;amp; a_{23} &amp;amp; a_{33}
\end{bmatrix}=
\begin{bmatrix}
1 &amp;amp; 2 &amp;amp; 3 \\ 2 &amp;amp; 1 &amp;amp; 2 \\ 3 &amp;amp; 2 &amp;amp; 1
\end{bmatrix}
$$&lt;/p>
&lt;p>è€ŒåŸçŸ©é˜µå…³äºä¸»å¯¹è§’çº¿å¯¹ç§°ã€‚&lt;/p>
&lt;h3 id="16-å•ä½çŸ©é˜µ">1.6 å•ä½çŸ©é˜µ&lt;/h3>
&lt;p>å•ä½çŸ©é˜µæ˜¯é™¤äº†ä¸»å¯¹è§’çº¿ä¸Šæ˜¯1ï¼Œå…¶ä»–æ•°å­—éƒ½æ˜¯0çš„çŸ©é˜µã€‚&lt;strong>ä»»ä½•çŸ©é˜µå’Œå•ä½çŸ©é˜µç›¸ä¹˜éƒ½ç­‰äºè‡ªèº«&lt;/strong>ã€‚&lt;/p>
&lt;p>æ¯”å¦‚ä¸‹é¢è¿™ä¸ª 3x3 çŸ©é˜µã€‚
$$
I=\begin{bmatrix}
1 &amp;amp; 0 &amp;amp; 0 \\ 0 &amp;amp; 1 &amp;amp; 0 \\ 0 &amp;amp; 0 &amp;amp; 1
\end{bmatrix}
$$&lt;/p>
&lt;h3 id="17-é€†çŸ©é˜µ">1.7 é€†çŸ©é˜µ&lt;/h3>
&lt;p>å¦‚æœæœ‰çŸ©é˜µ &lt;em>B&lt;/em> ï¼Œä»¤ &lt;em>BA=AB=I&lt;/em>ï¼Œå…¶ä¸­ &lt;em>I&lt;/em> ä¸ºå•ä½çŸ©é˜µï¼Œåˆ™ç§° &lt;em>B&lt;/em> ä¸º &lt;em>A&lt;/em> çš„é€†çŸ©é˜µï¼Œè®°ä¸º &lt;em>A&lt;sup>-1&lt;/sup>&lt;/em> ã€‚å¯¹ä»»æ„çŸ©é˜µ &lt;em>A&lt;/em> ï¼Œé€†çŸ©é˜µå¹¶ä¸ä¸€å®šå­˜åœ¨ã€‚&lt;/p>
&lt;p>é€†çŸ©é˜µçš„ä½œç”¨æ˜¯ä¸€å®šç¨‹åº¦ä¸Šä»£æ›¿äº†çŸ©é˜µé™¤æ³•è¿ç®—ï¼ˆçŸ©é˜µä¸èƒ½åšé™¤æ³•ï¼‰ï¼Œä¾‹å¦‚å·²çŸ¥çŸ©é˜µAã€Bï¼Œæ±‚çŸ©é˜µXï¼Œæœ‰ä¸‹é¢çš„å¼å­ã€‚&lt;/p>
&lt;p>&lt;em>XA=B&lt;/em>&lt;/p>
&lt;p>å¦‚æœæœ‰é™¤æ³•ï¼Œé‚£å¯ä»¥ç›´æ¥ç§»é¡¹ &lt;em>X=B/A&lt;/em> ï¼Œä½†çŸ©é˜µåªèƒ½ç›¸ä¹˜ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨ä¸¤è¾¹éƒ½ä¹˜ä¸Š A çš„é€†çŸ©é˜µ &lt;em>A&lt;sup>-1&lt;/sup>&lt;/em> ã€‚&lt;/p>
&lt;p>&lt;em>XAA&lt;sup>-1&lt;/sup>=BA&lt;sup>-1&lt;/sup>&lt;/em>&lt;/p>
&lt;p>å› ä¸º &lt;em>AA&lt;sup>-1&lt;/sup>&lt;/em> å¾—å•ä½çŸ©é˜µ &lt;em>I&lt;/em> ï¼Œæ‰€ä»¥å·¦ä¾§å°±å˜æˆäº† &lt;em>XI&lt;/em>ã€‚åˆå› ä¸ºä»»ä½•çŸ©é˜µå’Œå•ä½çŸ©é˜µç›¸ä¹˜éƒ½ç­‰äºè‡ªèº«ï¼Œæ‰€ä»¥ &lt;em>XI&lt;/em> å¯ä»¥ç®€åŒ–ä¸º &lt;em>X&lt;/em> ã€‚äºæ˜¯å°±å¾—åˆ°äº†ï¼š&lt;/p>
&lt;p>&lt;em>X=BA&lt;sup>-1&lt;/sup>&lt;/em>&lt;/p>
&lt;p>ä½†æ˜¯è¦&lt;strong>æ³¨æ„æ¬¡åº&lt;/strong>ï¼ &lt;em>AX=B&lt;/em> ä¸èƒ½ç”¨ä¸Šè¿°æ–¹æ³•åšï¼Œå› ä¸º&lt;strong>çŸ©é˜µä¹˜æ³•ä¸ä¸€å®šæ»¡è¶³ç»“åˆå¾‹&lt;/strong> ï¼ˆ&lt;em>AB=BA&lt;/em>ï¼‰ï¼Œå¯¹äº &lt;em>AX=B&lt;/em> çš„æƒ…å†µï¼Œå¯ä»¥å°† &lt;em>A&lt;sup>-1&lt;/sup>&lt;/em> æ”¾åœ¨å¼å­ä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯ &lt;em>A&lt;sup>-1&lt;/sup>AX=A&lt;sup>-1&lt;/sup>B&lt;/em> ã€‚&lt;/p>
&lt;h3 id="18-è¡Œåˆ—å¼æ‹‰æ™®æ‹‰æ–¯å±•å¼€">1.8 è¡Œåˆ—å¼ï¼ˆæ‹‰æ™®æ‹‰æ–¯å±•å¼€ï¼‰&lt;/h3>
&lt;p>çŸ©é˜µ A çš„è¡Œåˆ—å¼è®°ä¸º &lt;em>|A|&lt;/em> ï¼Œå’Œç»å¯¹å€¼ç¬¦å·ä¸€æ ·ã€‚åªæœ‰&lt;strong>æ–¹å½¢çŸ©é˜µ&lt;/strong>æ‰èƒ½è®¡ç®—è¡Œåˆ—å¼ã€‚æ–¹å½¢çŸ©é˜µå°±æ˜¯è¡Œå’Œåˆ—æ•°ç›®ç›¸ç­‰çš„çŸ©é˜µã€‚&lt;/p>
&lt;p>é¦–å…ˆçœ‹ 2x2 çŸ©é˜µã€‚
$$
A=\begin{bmatrix}
a &amp;amp; b \\ c &amp;amp; d
\end{bmatrix},|A|=ad-bc
$$
2x2çŸ©é˜µçš„è¡Œåˆ—å¼å°±æ˜¯ç®€å•çš„äº¤å‰ç›¸ä¹˜å†ç›¸å‡ã€‚ä¸‹å›¾ä¸­è“è‰²æ˜¯æ­£ï¼Œçº¢è‰²æ˜¯è´Ÿã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 148;
flex-basis: 357px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-03/image-20211112142023403.png" data-size="122x82">
&lt;img src="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-03/image-20211112142023403.png"
width="122"
height="82"
srcset="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-03/image-20211112142023403_huc11a23cfb761a28dddf43c5ac68c59d6_2679_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/cryptography-introduction-03/image-20211112142023403_huc11a23cfb761a28dddf43c5ac68c59d6_2679_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211112142023403">
&lt;/a>
&lt;figcaption>image-20211112142023403&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å†çœ‹ 3x3 çŸ©é˜µçš„è¡Œåˆ—å¼å†™æ³•ï¼Œç”¨çŸ©é˜µç¬¬ä¸€è¡Œçš„å…ƒç´ ï¼Œé€ä¸ªå»ä¹˜ä¸åœ¨å’Œè¿™ä¸ªå…ƒç´ åŒä¸€è¡ŒåŒä¸€åˆ—å…ƒç´ çš„è¡Œåˆ—å¼ï¼Œæœ€åæŠŠè¿™äº›å€¼ç”¨åŠ å‡å·è¿èµ·æ¥ã€‚
$$
\begin{vmatrix}
a &amp;amp; b &amp;amp; c \\ d &amp;amp; e &amp;amp; f \\ g &amp;amp; h &amp;amp; i
\end{vmatrix}=
a
\begin{vmatrix}
e &amp;amp; f \\ h &amp;amp; i
\end{vmatrix}
-b
\begin{vmatrix}
d &amp;amp; f \\ g &amp;amp; i
\end{vmatrix}
+c
\begin{vmatrix}
d &amp;amp; e \\ g &amp;amp; h
\end{vmatrix}
=a(ei-fh)-b(di-fg)+c(dh-eg)
$$
æ›´ç›´è§‚çš„å›¾å½¢åŒ–è¡¨ç¤ºï¼š&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 379;
flex-basis: 909px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-03/image-20211112142439733.png" data-size="436x115">
&lt;img src="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-03/image-20211112142439733.png"
width="436"
height="115"
srcset="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-03/image-20211112142439733_hu6459d23d051a17bdb0e4e65aba5ebe8f_9156_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/cryptography-introduction-03/image-20211112142439733_hu6459d23d051a17bdb0e4e65aba5ebe8f_9156_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211112142439733">
&lt;/a>
&lt;figcaption>image-20211112142439733&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æ³¨æ„è¿™ä¸ªè¿‡ç¨‹ä¸­çš„åŠ å‡ç¬¦å·è§„å¾‹ï¼Œ&lt;em>a&lt;sub>11&lt;/sub>Ã—(&amp;hellip;)&lt;/em> æ˜¯æ­£ï¼Œ&lt;em>a&lt;sub>12&lt;/sub>Ã—(&amp;hellip;)&lt;/em> æ˜¯è´Ÿï¼Œ&lt;em>a&lt;sub>13&lt;/sub>Ã—(&amp;hellip;)&lt;/em> åˆæ˜¯æ­£ã€‚&lt;/p>
&lt;p>çŸ¥æ™“è¿™äº›è§„å¾‹åå†çœ‹æ›´å¤§çš„çŸ©é˜µï¼Œä¹Ÿå¯ä»¥ä¾è‘«èŠ¦ç”»ç“¢å†™å‡ºè¡Œåˆ—å¼ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 468;
flex-basis: 1123px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-03/image-20211112143050819.png" data-size="590x126">
&lt;img src="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-03/image-20211112143050819.png"
width="590"
height="126"
srcset="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-03/image-20211112143050819_hu6a758e89ff701756d3ce691fff269895_11232_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/cryptography-introduction-03/image-20211112143050819_hu6a758e89ff701756d3ce691fff269895_11232_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211112143050819">
&lt;/a>
&lt;figcaption>image-20211112143050819&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>ç•™æ„å…¶ä¸­æ­£è´Ÿå·å‡ºç°çš„è§„å¾‹ï¼Œ&lt;em>+a&lt;sub>11&lt;/sub>&lt;/em> &lt;em>-a&lt;sub>12&lt;/sub>&lt;/em> &lt;em>+a&lt;sub>13&lt;/sub>&lt;/em> &lt;em>-a&lt;sub>14&lt;/sub>&lt;/em> ã€‚&lt;/p>
&lt;p>è¿™ç§è®¡ç®—æ–¹æ³•å«åš &lt;strong>æ‹‰æ™®æ‹‰æ–¯å±•å¼€&lt;/strong> ã€‚&lt;/p>
&lt;h3 id="19-æ±‚é€†çŸ©é˜µçš„æ–¹æ³•">1.9 æ±‚é€†çŸ©é˜µçš„æ–¹æ³•&lt;/h3>
&lt;ul>
&lt;li>2x2 çŸ©é˜µçš„é€†çŸ©é˜µ&lt;/li>
&lt;li>åˆç­‰è¡Œè¿ç®—&lt;/li>
&lt;li>ä½™å­å¼ã€ä»£æ•°ä½™å­å¼å’Œä¼´éšæ¥æ±‚é€†çŸ©é˜µ&lt;/li>
&lt;/ul>
&lt;p>2x2 çŸ©é˜µçš„é€†çŸ©é˜µæ˜¯ï¼š
$$
A^{-1}=\begin{bmatrix}
a &amp;amp; b \\ c &amp;amp; d
\end{bmatrix}^{-1}=
\frac{1}{|A|}
\begin{bmatrix}
d &amp;amp; -b \\ -c &amp;amp; a
\end{bmatrix}
$$&lt;/p>
&lt;ol>
&lt;li>è°ƒæ¢ &lt;em>a&lt;sub>11&lt;/sub>&lt;/em> å’Œ &lt;em>a&lt;sub>22&lt;/sub>&lt;/em>&lt;/li>
&lt;li>&lt;em>a&lt;sub>12&lt;/sub>&lt;/em> å’Œ &lt;em>a&lt;sub>21&lt;/sub>&lt;/em> åŠ ä¸Šè´Ÿå·&lt;/li>
&lt;li>é™¤ä»¥åŸçŸ©é˜µçš„è¡Œåˆ—å¼&lt;/li>
&lt;/ol>
&lt;p>3x3 æˆ–æ›´å¤§çš„çŸ©é˜µçš„é€†çŸ©é˜µæ±‚æ³•å¯ä»¥ç”¨ &lt;a class="link" href="https://www.shuxuele.com/algebra/matrix-inverse-row-operations-gauss-jordan.html" target="_blank" rel="noopener"
>åˆç­‰è¡Œè¿ç®—&lt;/a> æˆ– &lt;a class="link" href="https://www.shuxuele.com/algebra/matrix-inverse-minors-cofactors-adjugate.html" target="_blank" rel="noopener"
>ç”¨ä½™å­å¼ã€ä»£æ•°ä½™å­å¼å’Œä¼´éš æ¥æ±‚é€†çŸ©é˜µ&lt;/a> ã€‚&lt;/p>
&lt;h2 id="0x02-hill-å¯†ç ">0x02 Hill å¯†ç &lt;/h2>
&lt;h3 id="21-åŠ å¯†è¿‡ç¨‹">2.1 åŠ å¯†è¿‡ç¨‹&lt;/h3>
&lt;p>é¦–å…ˆç»™å®šä¸€ä¸ªå¯†ç çŸ©é˜µ &lt;em>A&lt;/em>ã€‚
$$
A=\begin{bmatrix}
1 &amp;amp; 2 \\ 3 &amp;amp; 4
\end{bmatrix}
$$&lt;/p>
&lt;p>å†ç»™å‡ºæ˜æ–‡ï¼š&lt;em>The quick brown fox jumps over the lazy dog&lt;/em>&lt;/p>
&lt;p>å°†æ˜æ–‡è½¬æ¢æˆæ•°å­—ï¼ˆASCIIï¼‰ï¼Œä¸¤ä¸ªä¸€ç»„ã€‚æ¯”å¦‚ &lt;code>Th&lt;/code> å°±æ˜¯ &lt;code>84 104&lt;/code> ï¼Œå†™æˆçŸ©é˜µå½¢å¼å°±æ˜¯è¿™æ ·ã€‚&lt;/p>
&lt;p>$$
P=\begin{bmatrix}
84 \\ 104
\end{bmatrix}
$$&lt;/p>
&lt;p>å°†å¯†ç çŸ©é˜µ &lt;em>A&lt;/em> å·¦ä¹˜æ˜æ–‡çŸ©é˜µ &lt;em>P&lt;/em> ï¼Œ&lt;em>C=AP&lt;/em>ï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†å¯†æ–‡ã€‚&lt;/p>
&lt;p>$$
C=AP=\begin{bmatrix}
1 &amp;amp; 2 \\ 3 &amp;amp; 4
\end{bmatrix}
\begin{bmatrix}
84 \\ 104
\end{bmatrix}=
\begin{bmatrix}
292 \\ 668
\end{bmatrix}
$$&lt;/p>
&lt;h3 id="22-è§£å¯†è¿‡ç¨‹">2.2 è§£å¯†è¿‡ç¨‹&lt;/h3>
&lt;p>è§£å¯†è¿‡ç¨‹å°±æ˜¯åˆ©ç”¨å¯†ç çŸ©é˜µçš„é€†çŸ©é˜µ &lt;em>A&lt;sup>-1&lt;/sup>&lt;/em> ï¼Œä»å¯†æ–‡æ±‚æ˜æ–‡çš„è¿‡ç¨‹ï¼Œå…¬å¼ &lt;em>A&lt;sup>-1&lt;/sup>C=A&lt;sup>-1&lt;/sup>AP&lt;/em> ã€‚&lt;/p>
&lt;p>2x2 çŸ©é˜µçš„é€†çŸ©é˜µæ±‚è§£æ–¹æ³•çœ‹å‰é¢ 1.9ï¼Œæ±‚å¾—é€†çŸ©é˜µå¦‚ä¸‹ã€‚&lt;/p>
&lt;p>$$
A^{-1}=\begin{bmatrix}
-2 &amp;amp; 1 \\ 1.5 &amp;amp; -0.5
\end{bmatrix}
$$&lt;/p>
&lt;p>ç„¶åä½¿ç”¨é€†çŸ©é˜µå·¦ä¹˜å¯†æ–‡ï¼š&lt;/p>
&lt;p>$$
P=A^{-1}C=\begin{bmatrix}
-2 &amp;amp; 1 \\ 1.5 &amp;amp; -0.5
\end{bmatrix}
\begin{bmatrix}
292 \\ 668
\end{bmatrix}=
\begin{bmatrix}
84 \\ 104
\end{bmatrix}
$$&lt;/p>
&lt;p>å³å¯å¾—åˆ°æ˜æ–‡ã€‚&lt;/p>
&lt;h3 id="23-å®‰å…¨æ€§">2.3 å®‰å…¨æ€§&lt;/h3>
&lt;p>Hillå¯†ç çš„å®‰å…¨æ€§ä½“ç°åœ¨éšè—äº†å•ä¸ªå­—æ¯çš„é¢‘ç‡ä¿¡æ¯ï¼ŒåŠ å¯†çŸ©é˜µè¶Šå¤§æ•ˆæœè¶Šå¥½ã€‚&lt;/p>
&lt;p>Hillå¯†ç æ— æ³•æŠµæŠ—å·²çŸ¥æ˜æ–‡æ”»å‡»ï¼Œå·²çŸ¥æ˜æ–‡å’Œå¯†æ–‡æ—¶å®Œå…¨å¯ä»¥è®¡ç®—å‡ºåŠ å¯†çŸ©é˜µã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>é‡ç‚¹ï¼š&lt;/p>
&lt;ol>
&lt;li>çŸ©é˜µä¹˜æ³•ã€å•ä½çŸ©é˜µã€è¡Œåˆ—å¼å’Œé€†çŸ©é˜µ&lt;/li>
&lt;/ol>
&lt;p>Hillå¯†ç æ˜¯å°†æ˜æ–‡è½¬ä¸ºçŸ©é˜µåå’ŒåŠ å¯†çŸ©é˜µç›¸ä¹˜ï¼ŒåŠ å¯†çŸ©é˜µå³ä¸ºåŠ å¯†å¯†é’¥ï¼ŒåŠ å¯†çŸ©é˜µè¶Šå¤§æ•ˆæœè¶Šå¥½ã€‚è§£å¯†ä½¿ç”¨åŠ å¯†çŸ©é˜µçš„é€†çŸ©é˜µä½œä¸ºå¯†é’¥ã€‚&lt;/p>
&lt;p>Hill å¯†ç èƒ½éšè—å­—æ¯é¢‘ç‡ä¿¡æ¯ï¼Œå¯¹æŠ—ä»…å¯†æ–‡åˆ†æï¼Œä½†æ— æ³•å¯¹æŠ—å·²çŸ¥æ˜æ–‡åˆ†æã€‚&lt;/p></description></item><item><title>å¯†ç å­¦å…¥é—¨02 - å¤å…¸å¯†ç #2</title><link>https://nnnewb.github.io/blog/p/cryptography-introduction-02/</link><pubDate>Thu, 11 Nov 2021 16:53:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/cryptography-introduction-02/</guid><description>&lt;img src="https://nnnewb.github.io/blog/p/cryptography-introduction-02/cover.jpg" alt="Featured image of post å¯†ç å­¦å…¥é—¨02 - å¤å…¸å¯†ç #2" />&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>ä»å•è¡¨ä»£æ›¿å¯†ç å¼€å§‹ï¼Œç»§ç»­å­¦ä¹ å¤å…¸å¯†ç ã€‚&lt;/p>
&lt;h2 id="0x01-playfair-å¯†ç ">0x01 playfair å¯†ç &lt;/h2>
&lt;p>&lt;em>playfair&lt;/em> è¿™ä¸ªè¯ä¹ä¸€å¬æˆ‘ç”šè‡³æœ‰ç‚¹è¿·æƒ‘ï¼Œå•¥æ„æ€ï¼Œå…¬å¹³ç«èµ›å—ã€‚ä¹‹åæ‰çŸ¥é“åŸæ¥æ˜¯äººåã€‚&lt;/p>
&lt;h3 id="æ¦‚è¿°">æ¦‚è¿°&lt;/h3>
&lt;p>playfair å¯†ç æ˜¯æœ€è‘—åçš„å¤šå­—æ¯ä»£æ›¿å¯†ç ï¼Œå®ƒæŠŠæ˜æ–‡ä¸­çš„å­—æ¯å¯¹è½¬æ¢æˆå¯†æ–‡çš„å­—æ¯å¯¹ï¼Œæ¯æ¬¡åŠ å¯†è¾“å…¥ä¸¤ä¸ªå­—æ¯ï¼Œè¾“å‡ºä¸¤ä¸ªå­—æ¯ã€‚&lt;/p>
&lt;p>playfair ç®—æ³•åŸºäºä¸€ä¸ªç”±å¯†é’¥è¯æ„æˆçš„ 5x5 å­—æ¯çŸ©é˜µï¼Œå°†å¯†é’¥è¯å»é™¤é‡å¤å­—æ¯åï¼Œå’Œå­—æ¯è¡¨å‰©ä½™çš„å­—æ¯æŒ‰å·¦è‡³å³ã€ä¸Šè‡³ä¸‹çš„é¡ºåºå¡«å……è¿›è¡¨é‡Œã€‚&lt;/p>
&lt;p>ä¸¾ä¾‹æ¥è¯´ï¼Œç”¨ &lt;code>pojie&lt;/code> ä½œä¸ºå¯†é’¥è¯ã€‚&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>-&lt;/th>
&lt;th>-&lt;/th>
&lt;th>-&lt;/th>
&lt;th>-&lt;/th>
&lt;th>-&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>p&lt;/td>
&lt;td>o&lt;/td>
&lt;td>j&lt;/td>
&lt;td>i&lt;/td>
&lt;td>e&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>a&lt;/td>
&lt;td>b&lt;/td>
&lt;td>c&lt;/td>
&lt;td>d&lt;/td>
&lt;td>f&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>g/h&lt;/td>
&lt;td>k&lt;/td>
&lt;td>l&lt;/td>
&lt;td>m&lt;/td>
&lt;td>n&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>q&lt;/td>
&lt;td>r&lt;/td>
&lt;td>s&lt;/td>
&lt;td>t&lt;/td>
&lt;td>u&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>v&lt;/td>
&lt;td>w&lt;/td>
&lt;td>x&lt;/td>
&lt;td>y&lt;/td>
&lt;td>z&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>éœ€è¦æ³¨æ„çš„æ˜¯å­—æ¯è¡¨æœ‰26ä¸ªå­—æ¯ï¼Œä½† playfair çš„å­—æ¯çŸ©é˜µåªæœ‰ 25 ä¸ªç©ºæ ¼ã€‚å‡ºç°å­—æ¯è¡¨ä¸æ˜¯ 5 çš„æ•´æ•°å€çš„æƒ…å†µæ—¶å¯ä»¥é€‰æ‹©å°†å¤šå‡ºæ¥çš„å­—æ¯è§†ä½œåŒä¸€ä¸ªï¼Œæˆ–è€…å»æ‰ä¸å¸¸ç”¨çš„å­—æ¯ï¼Œä½¿å…¶æ­£å¥½å¡«æ»¡çŸ©é˜µã€‚æ¯”å¦‚å›¾ä¸­çš„&lt;code>g&lt;/code>/&lt;code>h&lt;/code>ï¼Œå¥½å­©å­ä¸è¦å­¦å“¦ã€‚å¸¸è§çš„æƒ…å†µæ˜¯&lt;code>i&lt;/code>/&lt;code>j&lt;/code>æˆ–è€…å»æ‰&lt;code>z&lt;/code>æˆ–&lt;code>q&lt;/code>ã€‚&lt;/p>
&lt;h3 id="åŠ å¯†è¿‡ç¨‹">åŠ å¯†è¿‡ç¨‹&lt;/h3>
&lt;p>åŠ å¯†è¿‡ç¨‹å¦‚ä¸‹ã€‚&lt;/p>
&lt;p>ç¬¬ä¸€æ­¥ï¼šå°†æ˜æ–‡åˆ†æˆä¸¤ä¸ªå­—æ¯ä¸€ç»„ï¼Œä¸¤ä¸ªå­—æ¯é‡å¤çš„è¯å°±åœ¨ä¸­é—´å¡«&lt;code>x&lt;/code>é‡æ–°åˆ†ç»„ï¼›å¦‚æœæœ€åå‰©ä¸‹ä¸€ä¸ªå­—æ¯çš„è¯ï¼Œä¹Ÿæ·»åŠ &lt;code>x&lt;/code>åˆ†æˆä¸€ç»„ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œå¯¹å•è¯&lt;code>balloon&lt;/code>ï¼Œç›´æ¥åˆ†ç»„çš„è¯å°±æ˜¯&lt;code>ba&lt;/code>ã€&lt;code>ll&lt;/code>ã€&lt;code>on&lt;/code>ï¼Œå¡«&lt;code>x&lt;/code>é‡æ–°åˆ†ç»„å°±æ˜¯&lt;code>ba&lt;/code>ã€&lt;code>lx&lt;/code>ã€&lt;code>lo&lt;/code>ã€&lt;code>on&lt;/code>ã€‚&lt;/p>
&lt;p>åˆ†ç»„åï¼Œå¯¹æ¯ä¸ªç»„è¿›è¡ŒåŠ å¯†ï¼Œä¾ç„¶æ˜¯ &lt;code>balloon&lt;/code> ä¸ºä¾‹ã€‚é¦–å…ˆç¬¬ä¸€ç»„ &lt;code>ba&lt;/code>ã€‚&lt;/p>
&lt;p>ç¬¬äºŒæ­¥ï¼šæ‰¾å‡ºä¸¤ä¸ªå­—æ¯åœ¨ä¸Šé¢è¡¨æ ¼é‡Œçš„è¡Œåˆ—åæ ‡ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;code>b&lt;/code> æ˜¯ç¬¬ 2 è¡Œç¬¬ 2 åˆ—ã€‚&lt;/li>
&lt;li>&lt;code>a&lt;/code> æ˜¯ç¬¬ 1 è¡Œç¬¬ 2 åˆ—ã€‚&lt;/li>
&lt;/ul>
&lt;p>ç¬¬ä¸‰æ­¥ï¼šæŒ‰è§„åˆ™é€‰æ‹©ä»£æ›¿çš„å­—æ¯&lt;/p>
&lt;ul>
&lt;li>å¦‚æœä¸¤ä¸ªå­—æ¯ä¸åŒè¡Œä¹Ÿä¸åŒåˆ—ï¼Œåˆ™é€‰æ‹©æœ¬å­—æ¯æ‰€åœ¨è¡Œã€åˆ†ç»„ä¸­å¦ä¸€ä¸ªå­—æ¯æ‰€åœ¨åˆ—çš„å­—æ¯ä»£æ›¿ã€‚&lt;/li>
&lt;li>å¦‚æœä¸¤ä¸ªå­—æ¯åœ¨åŒä¸€è¡Œï¼Œåˆ™é€‰æ‹©æ˜æ–‡å³è¾¹çš„å­—æ¯ä»£æ›¿ã€‚æ˜æ–‡åœ¨æœ€å³è¾¹åˆ™ç”±æœ€å·¦è¾¹çš„å­—æ¯ä»£æ›¿ã€‚&lt;/li>
&lt;li>å¦‚æœä¸¤ä¸ªå­—æ¯åœ¨åŒä¸€åˆ—ï¼Œåˆ™é€‰æ‹©æ˜æ–‡ä¸‹è¾¹çš„å­—æ¯ä»£æ›¿ã€‚æ˜æ–‡åœ¨æœ€åº•ä¸‹åˆ™ç”±æœ€ä¸Šè¾¹çš„å­—æ¯ä»£æ›¿ã€‚&lt;/li>
&lt;/ul>
&lt;p>æ¯”å¦‚ &lt;code>balloon&lt;/code> åŠ å¯†åï¼Œå°±æ˜¯ &lt;code>bcsjkjek&lt;/code> ã€‚&lt;/p>
&lt;h3 id="ç‰¹ç‚¹">ç‰¹ç‚¹&lt;/h3>
&lt;p>playfair æœ‰ 26x26 ä¸ªå­—æ¯å¯¹ï¼Œå› æ­¤è¯†åˆ«å‡ºå•ä¸ªå­—æ¯å¯¹ç›¸å¯¹ç®€å•çš„å•è¡¨ä»£æ›¿ç®—æ³•è¦å›°éš¾å¾—å¤šã€‚å­—æ¯å¯¹çš„ç›¸å¯¹é¢‘ç‡æ¯”å­—æ¯çš„ç›¸å¯¹é¢‘ç‡å˜åŒ–å¹…åº¦å°ï¼Œåˆ©ç”¨é¢‘ç‡åˆ†æå­—æ¯å¯¹æ›´å›°éš¾ã€‚&lt;/p>
&lt;p>playfair ä»ç„¶æ˜¯ç›¸å¯¹å®¹æ˜“æ”»ç ´çš„ï¼Œå› ä¸ºå®ƒçš„å¯†æ–‡ä»ç„¶å®Œå¥½ä¿ç•™äº†æ˜æ–‡è¯­è¨€çš„å¤§éƒ¨åˆ†ç»“æ„ç‰¹å¾ï¼Œå‡ ç™¾ä¸ªå­—æ¯çš„å¯†æ–‡å°±è¶³å¤Ÿåˆ†æå‡ºè§„å¾‹äº†ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 168;
flex-basis: 404px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-02/image-20211111144837847.png" data-size="1325x787">
&lt;img src="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-02/image-20211111144837847.png"
width="1325"
height="787"
srcset="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-02/image-20211111144837847_hu40999a0266ccbfe450f46cc822fe186a_187757_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/cryptography-introduction-02/image-20211111144837847_hu40999a0266ccbfe450f46cc822fe186a_187757_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211111144837847">
&lt;/a>
&lt;figcaption>image-20211111144837847&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å›¾ä¸­æ˜¾ç¤ºäº† playfair å¯†ç å’Œå…¶ä»–ä¸€äº›å¯†ç åŠ å¯†çš„æœ‰æ•ˆæ€§ï¼Œæ ‡æœ‰æ˜æ–‡çš„æ›²çº¿ç”»å‡ºäº†è¶…è¿‡ä»7wä¸ªå­—æ¯çš„æ–‡ç« ä¸­å¾—åˆ°çš„é¢‘ç‡åˆ†å¸ƒã€‚æ›²çº¿ä»£è¡¨è¿™æ ·çš„å«ä¹‰ï¼šå¯¹æ–‡ç« ä¸­å‡ºç°çš„æ¯ä¸ªå­—æ¯è®¡æ•°ï¼Œè®¡æ•°ç»“æœé™¤ä»¥ä½¿ç”¨é¢‘ç‡æœ€é«˜çš„å­—æ¯å‡ºç°æ¬¡æ•°ã€‚å‡è®¾ä½¿ç”¨é¢‘ç‡æœ€é«˜çš„å­—æ¯ &lt;code>e&lt;/code> å‡ºç°çš„é¢‘ç‡ä¸º 1 ï¼Œé‚£ä¹ˆ &lt;code>t&lt;/code> å‡ºç°çš„é¢‘ç‡å°±æ˜¯ &lt;code>0.76&lt;/code> ç­‰ç­‰ã€‚&lt;/p>
&lt;p>å›¾ä¸­çš„æ¨ªè½´è¡¨ç¤ºå­—æ¯ï¼Œçºµè½´è¡¨ç¤ºå­—æ¯å‡ºç°çš„é¢‘ç‡ã€‚ æ›²çº¿ä½“ç°äº†åŠ å¯†åå­—æ¯é¢‘ç‡åˆ†å¸ƒè¢«æ©ç›–çš„ç¨‹åº¦ã€‚å¦‚æœé¢‘ç‡åˆ†å¸ƒçš„ä¿¡æ¯å®Œå…¨è¢«åŠ å¯†è¿‡ç¨‹ç»™éšè—äº†ï¼Œé‚£ä¹ˆå¯†æ–‡çš„é¢‘ç‡æ›²çº¿åº”è¯¥æ˜¯ä¸€æ¡æ°´å¹³çš„çº¿ï¼Œå”¯å¯†æ–‡å¯†ç åˆ†æç”±æ­¤ä¸‹æ‰‹å°†ä¸€æ— æ‰€è·ã€‚&lt;/p>
&lt;p>å›¾ä¸­æ‰€ç¤ºçš„é¢‘ç‡æ›²çº¿è¡¨æ˜ playfair å¯†ç è™½ç„¶æœ‰æ¯”æ˜æ–‡ç¨å¹³å¦çš„é¢‘ç‡åˆ†å¸ƒæ›²çº¿ï¼Œä½†ä»ç„¶é€éœ²äº†å¤§é‡ä¿¡æ¯ç»™å¯†ç åˆ†æè€…ã€‚&lt;/p>
&lt;h3 id="ä»£ç å®ç°">ä»£ç å®ç°&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-cpp" data-lang="cpp">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;algorithm&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;array&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;cctype&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;cstddef&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;cstdlib&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;iostream&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;iterator&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;ostream&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;set&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;string&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;unordered_set&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;utility&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="k">constexpr&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">lowercase&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;abcdefghijklmnopqrstuvwxyz&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// ä¿æŒé¡ºåºçš„æƒ…å†µä¸‹ï¼Œå¯¹è¾“å…¥æ–‡æœ¬å»é‡ï¼Œå¹¶ä¸”ä»æ–‡æœ¬é‡ŒæŠŠå­—ç¬¦jæ›¿æ¢æˆi
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">string&lt;/span> &lt;span class="n">my_unique&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">string&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">text&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">string&lt;/span> &lt;span class="n">ret&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">text&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">replace&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ret&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">begin&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="n">ret&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">end&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="sc">&amp;#39;j&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sc">&amp;#39;i&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">unordered_set&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">char&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">s&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">last&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">stable_partition&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ret&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">begin&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="n">ret&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">end&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="p">](&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">n&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kt">bool&lt;/span> &lt;span class="n">ret&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">!&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// not exists
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">insert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">ret&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">});&lt;/span>
&lt;span class="n">ret&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">erase&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">last&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ret&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">end&lt;/span>&lt;span class="p">());&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">ret&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// ä»å¯†é’¥å­—ç¬¦ä¸²æ„é€ å‡º playfair å¯†é’¥çŸ©é˜µ
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">array&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">playfair_matrix&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">string&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// åˆå§‹åŒ–å¯†é’¥ï¼Œæ„é€ çš„å¯†é’¥ä¸­æ²¡æœ‰ jï¼ŒåŠ å¯†æ—¶ j è§†ä½œ i å¤„ç†
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">string&lt;/span> &lt;span class="n">fullkey&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">my_unique&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">lowercase&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">fullkey&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">length&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">cerr&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34;invalid key length&amp;#34;&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">endl&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// æ„é€ çŸ©é˜µ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">array&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">matrix&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">auto&lt;/span> &lt;span class="nl">c&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">fullkey&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">matrix&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">count&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">push_back&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="o">++&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">matrix&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// ç”¨è¿­ä»£å™¨è¯»å–ä¸€ç»„ä¸¤ä¸ªå­—ç¬¦ï¼ˆä»å½“å‰ä½ç½®å¼€å§‹ï¼Œ*iter å’Œ *(iter+1) ä¸ºä¸€ç»„ï¼‰ã€‚
&lt;/span>&lt;span class="c1">// å¦‚æœåç»­ä¸¤ä¸ªå­—ç¬¦é‡å¤ï¼Œåˆ™å–ä¸€ä¸ªå­—ç¬¦åŠ ä¸Š x è¿”å›ï¼›
&lt;/span>&lt;span class="c1">// å¦‚æœåç»­ä»…å‰©ä¸€ä¸ªå­—ç¬¦ä¹ŸåŠ ä¸Š x è¿”å›ã€‚
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">array&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">char&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">next2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">string&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">const_iterator&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">it&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">string&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">const_iterator&lt;/span> &lt;span class="n">end&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">array&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">char&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">ret&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">it&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">end&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">it&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">it&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">ret&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tolower&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">it&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">));&lt;/span>
&lt;span class="n">ret&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="sc">&amp;#39;x&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">ret&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tolower&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">it&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">));&lt;/span>
&lt;span class="n">ret&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tolower&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">it&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">));&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">ret&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// è·å¾—å­—ç¬¦åœ¨å¯†é’¥çŸ©é˜µä¸­çš„åæ ‡ï¼Œè¿”å› (è¡Œ,åˆ—)
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">pair&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">get_row_col&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">array&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">matrix&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="n">c&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">size_t&lt;/span> &lt;span class="n">r&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">r&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">matrix&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">r&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">const&lt;/span> &lt;span class="k">auto&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">row&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">matrix&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">r&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">col&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">row&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">find&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">col&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">row&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">npos&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">make_pair&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">r&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">col&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">make_pair&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// playfair åŠ å¯†å‡½æ•°
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">string&lt;/span> &lt;span class="n">playfair_cipher&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">string&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">input&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">string&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">string&lt;/span> &lt;span class="n">ciphertext&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">matrix&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">playfair_matrix&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">it&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">input&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">cbegin&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">it&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">input&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">cend&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">char_pair&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">next2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">it&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">input&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">cend&lt;/span>&lt;span class="p">());&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">c1_pos&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">get_row_col&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">matrix&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">char_pair&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="sc">&amp;#39;j&amp;#39;&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="sc">&amp;#39;i&amp;#39;&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="n">char_pair&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">c2_pos&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">get_row_col&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">matrix&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">char_pair&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="sc">&amp;#39;j&amp;#39;&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="sc">&amp;#39;i&amp;#39;&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="n">char_pair&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">c1_pos&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">first&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">c2_pos&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">first&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// åŒä¸€è¡Œï¼Œå–åŒè¡Œä¸‹ä¸€ä¸ªå­—ç¬¦
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">auto&lt;/span> &lt;span class="n">row&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">c1_pos&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">first&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">c1_col&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">c1_pos&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">second&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="mi">5&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="n">c1_pos&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">second&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">c2_col&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">c2_pos&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">second&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="mi">5&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="n">c2_pos&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">second&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ciphertext&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">push_back&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">matrix&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">row&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">c1_col&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="n">ciphertext&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">push_back&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">matrix&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">row&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">c2_col&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="nf">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">c1_pos&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">second&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">c2_pos&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">second&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// åŒä¸€åˆ—ï¼Œå–åŒåˆ—ä¸‹ä¸€ä¸ªå­—ç¬¦
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">auto&lt;/span> &lt;span class="n">col&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">c1_pos&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">second&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">c1_row&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">c1_pos&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">first&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="mi">5&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="n">c1_pos&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">first&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">c2_row&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">c2_pos&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">first&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="mi">5&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="n">c2_pos&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">first&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ciphertext&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">push_back&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">matrix&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">c1_row&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">col&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="n">ciphertext&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">push_back&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">matrix&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">c2_row&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">col&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ä¸åŒè¡Œä¹Ÿä¸åŒåˆ—ï¼Œå–æœ¬è¡Œï¼Œå¦ä¸€å­—ç¬¦æ‰€åœ¨åˆ—çš„å­—ç¬¦
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">auto&lt;/span> &lt;span class="n">row&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">c1_pos&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">first&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">c1_col&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">c2_pos&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">second&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">c2_col&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">c1_pos&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">second&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ciphertext&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">push_back&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">matrix&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">row&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">c1_col&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="n">ciphertext&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">push_back&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">matrix&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">row&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">c2_col&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">ciphertext&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="k">auto&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nl">row&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">playfair_matrix&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;haoye&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">cout&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">row&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">endl&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">cout&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34;ciphertext:&amp;#34;&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">playfair_cipher&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;helloworld&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;haoye&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">endl&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»¥ä¸Šæ˜¯ playfair åŠ å¯†çš„ c++ å®ç°ã€‚æ¯”è¾ƒæ€ªçš„æ˜¯ playfair ç½‘ä¸Šå¯ä»¥æ‰¾åˆ°å¾ˆå¤šå˜ä½“ï¼Œæ¯”å¦‚ &lt;a class="link" href="http://www.practicalcryptography.com/ciphers/classical-era/playfair/#javascript-example-of-the-playfair-cipher" target="_blank" rel="noopener"
>practice cryptography&lt;/a> æè¿°å’Œå®ç°çš„ playfair ç®—æ³•æ˜¯åœ¨åˆ†ç»„é˜¶æ®µï¼ŒæŠŠé‡å¤å‡ºç°çš„ç¬¬äºŒä¸ªå­—ç¬¦æ›¿æ¢æˆ &lt;code>x&lt;/code> ã€‚&lt;/p>
&lt;p>è§£å¯†æ²¡æœ‰åœ¨è¿™é‡Œå®ç°ï¼Œè§£å¯†å‡½æ•°è§„åˆ™å¦‚ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>å¦‚æœä¸€ç»„ä¸¤ä¸ªå­—æ¯åœ¨åŒä¸€è¡Œï¼Œåˆ™ç”¨å‰ä¸€åˆ—å­—æ¯æ›¿æ¢ï¼Œç¬¬ä¸€åˆ—ç”¨æœ€åä¸€åˆ—å­—æ¯æ›¿æ¢ã€‚&lt;/li>
&lt;li>å¦‚æœä¸€ç»„ä¸¤ä¸ªå­—æ¯åœ¨åŒä¸€åˆ—ï¼Œåˆ™ç”¨å‰ä¸€è¡Œå­—æ¯æ›¿æ¢ï¼Œç¬¬ä¸€è¡Œç”¨æœ€åä¸€è¡Œå­—æ¯æ›¿æ¢ã€‚&lt;/li>
&lt;li>å¦‚æœä¸€ç»„ä¸¤ä¸ªå­—ç¬¦ä¸åœ¨åŒä¸€åˆ—åŒä¸€è¡Œï¼Œåˆ™å–åŒä¸€è¡Œï¼Œä¸€ç»„ä¸­å¦ä¸€å­—æ¯æ‰€åœ¨åˆ—çš„å­—æ¯æ›¿æ¢ã€‚&lt;/li>
&lt;/ul>
&lt;p>å°±æ˜¯æŠŠåŠ å¯†è§„åˆ™åè¿‡æ¥æ‰§è¡Œï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯åœ¨åˆ†ç»„é˜¶æ®µä¸ç”¨è€ƒè™‘ç›¸åŒå­—æ¯ï¼Œå‡ºç°ç›¸åŒå­—æ¯è¯´æ˜å¯†æ–‡æœ‰é—®é¢˜ï¼Œå¯ä»¥è·³è¿‡è¿™ä¸€ç»„å­—æ¯ã€‚æœ€åè§£å¯†ç»“æœä¼šå‡ºç°å¤šä½™çš„&lt;code>x&lt;/code>ï¼Œå¦‚æœæ˜æ–‡åŒ…å«&lt;code>j&lt;/code>çš„è¯è§£å¯†ç»“æœä¼šå˜æˆ&lt;code>i&lt;/code>ã€‚&lt;/p>
&lt;h2 id="ç»“è®º">ç»“è®º&lt;/h2>
&lt;p>ç®€è¦æè¿° playfair ç®—æ³•åŠ å¯†è¿‡ç¨‹ï¼š&lt;/p>
&lt;ul>
&lt;li>ä»å¯†é’¥æ„é€  5x5 çŸ©é˜µ&lt;/li>
&lt;li>å¯¹æ˜æ–‡æŒ‰ä¸¤ä¸ªå­—æ¯ä¸€ç»„åˆ†ç»„ï¼Œåˆ†ç»„è¿‡ç¨‹ä¸­å¤„ç†è¿ç»­é‡å¤å­—ç¬¦ï¼ˆé‡å¤å­—æ¯é—´æ’å…¥&lt;code>x&lt;/code>ï¼‰å’Œå­¤ç«‹å­—æ¯ï¼ˆæœ«å°¾å‰©ä½™çš„æœ€åä¸€ä¸ªå­—æ¯ä¹ŸåŠ ä¸Š&lt;code>x&lt;/code>ï¼‰&lt;/li>
&lt;li>æŒ‰è§„åˆ™ï¼Œå¯¹ä¸€ç»„ä¸¤ä¸ªå­—æ¯è¿›è¡Œæ›¿æ¢ï¼Œç›´åˆ°æ‰€æœ‰æ˜æ–‡éƒ½è¢«æ›¿æ¢å®Œæˆ
&lt;ul>
&lt;li>å¦‚æœä¸¤ä¸ªå­—æ¯åœ¨çŸ©é˜µåŒä¸€è¡Œï¼Œå–å­—æ¯åœ¨æœ¬è¡Œçš„ä¸‹ä¸€ä¸ªå­—æ¯æ›¿æ¢ï¼Œè¡Œæœ«å­—æ¯å–è¡Œé¦–ã€‚&lt;/li>
&lt;li>å¦‚æœä¸¤ä¸ªå­—æ¯åœ¨çŸ©é˜µåŒä¸€åˆ—ï¼Œå–å­—æ¯åœ¨æœ¬åˆ—çš„ä¸‹ä¸€ä¸ªå­—æ¯æ›¿æ¢ï¼Œåˆ—æœ«å­—æ¯å–åˆ—é¦–ã€‚&lt;/li>
&lt;li>å¦‚æœä¸åŒè¡Œä¸åŒåˆ—ï¼Œå–å­—æ¯æœ¬è¡Œï¼Œæœ¬ç»„å¦ä¸€å­—æ¯æ‰€åœ¨åˆ—çš„å­—æ¯æ›¿æ¢ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>playfair å¯†ç çš„ç›¸æ¯”ç®€å•å•è¡¨æ›¿æ¢ï¼Œåˆ†æéš¾åº¦å¤§å¾—å¤šã€‚ä½†ä¾ç„¶å®Œæ•´ä¿ç•™äº†è¯­è¨€çš„ç»“æ„ç‰¹å¾ï¼Œå› æ­¤åˆ†æä¾ç„¶æ¯”è¾ƒå®¹æ˜“ã€‚&lt;/p></description></item><item><title>å¯†ç å­¦å…¥é—¨01 - å¤å…¸å¯†ç #1</title><link>https://nnnewb.github.io/blog/p/cryptography-introduction-01/</link><pubDate>Thu, 11 Nov 2021 11:35:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/cryptography-introduction-01/</guid><description>&lt;img src="https://nnnewb.github.io/blog/p/cryptography-introduction-01/cover.jpg" alt="Featured image of post å¯†ç å­¦å…¥é—¨01 - å¤å…¸å¯†ç #1" />&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>æœ¬æ–‡æ˜¯å­¦ä¹ ã€Šå¯†ç ç¼–ç å­¦ä¸ç½‘ç»œå®‰å…¨ã€‹ä¸€ä¹¦çš„ç¬”è®°ï¼Œå…³äºä¼ ç»ŸåŠ å¯†æŠ€æœ¯ä¸€ç« ã€‚&lt;/p>
&lt;h2 id="0x01-å¯¹ç§°å¯†ç æ¨¡å‹">0x01 å¯¹ç§°å¯†ç æ¨¡å‹&lt;/h2>
&lt;p>å¯¹ç§°åŠ å¯†ï¼Œä¹Ÿç§°ä¼ ç»ŸåŠ å¯†æˆ–å•é’¥åŠ å¯†ï¼Œæ˜¯20ä¸–çºª70å¹´ä»£å…¬é’¥å¯†ç äº§ç”Ÿä¹‹å‰å”¯ä¸€çš„åŠ å¯†ç±»å‹ã€‚è¿„ä»Šä¸ºæ­¢ï¼Œå®ƒä»æ˜¯ä½¿ç”¨æœ€å¹¿æ³›çš„åŠ å¯†ç±»å‹ã€‚&lt;/p>
&lt;p>å¯¹ç§°åŠ å¯†æ–¹æ¡ˆæœ‰5ä¸ªåŸºæœ¬æˆåˆ†ï¼š&lt;/p>
&lt;ul>
&lt;li>æ˜æ–‡ï¼šåŸå§‹å¯ä»¥ç†è§£çš„æ¶ˆæ¯æˆ–æ•°æ®ï¼Œæ˜¯ç®—æ³•çš„è¾“å…¥ã€‚&lt;/li>
&lt;li>åŠ å¯†ç®—æ³•ï¼šåŠ å¯†ç®—æ³•å¯¹æ˜æ–‡è¿›è¡Œå„ç§ä»£æ›¿å’Œå˜æ¢ã€‚&lt;/li>
&lt;li>å¯†é’¥ï¼šå¯†é’¥ä¹Ÿæ˜¯åŠ å¯†ç®—æ³•çš„è¾“å…¥ã€‚å¯†é’¥ç‹¬ç«‹äºæ˜æ–‡å’Œç®—æ³•ã€‚ç®—æ³•æ ¹æ®æ‰€ç”¨çš„ç‰¹å®šå¯†é’¥è€Œäº§ç”Ÿä¸åŒçš„è¾“å‡ºã€‚ç®—æ³•æ‰€ç”¨çš„ç¡®åˆ‡ä»£æ›¿å’Œå˜æ¢ä¹Ÿä¾é å¯†é’¥ã€‚&lt;/li>
&lt;li>å¯†æ–‡ï¼šä½œä¸ºç®—æ³•çš„è¾“å‡ºï¼Œçœ‹èµ·æ¥å®Œå…¨éšæœºè€Œæ‚ä¹±çš„æ¶ˆæ¯ï¼Œä¾èµ–äºæ˜æ–‡å’Œå¯†é’¥ã€‚å¯¹äºç»™å®šçš„æ¶ˆæ¯ï¼Œä¸åŒå¯†é’¥äº§ç”Ÿä¸åŒçš„å¯†æ–‡ï¼Œå¯†æ–‡çœ‹ä¸Šå»æ˜¯éšæœºçš„æ•°æ®æµå¹¶ä¸”å…¶æ„ä¹‰æ˜¯ä¸å¯ç†è§£çš„ã€‚&lt;/li>
&lt;li>è§£å¯†ç®—æ³•ï¼šæœ¬è´¨ä¸Šæ˜¯åŠ å¯†ç®—æ³•çš„é€†è¿ç®—ã€‚è¾“å…¥å¯†æ–‡å’Œå¯†é’¥ï¼Œè¾“å‡ºåŸå§‹æ˜æ–‡ã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 306;
flex-basis: 735px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-01/image-20211110140236382.png" data-size="1155x377">
&lt;img src="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-01/image-20211110140236382.png"
width="1155"
height="377"
srcset="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-01/image-20211110140236382_hu8783c317e7f9de22b27c24c57fb0b0d7_134857_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/cryptography-introduction-01/image-20211110140236382_hu8783c317e7f9de22b27c24c57fb0b0d7_134857_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211110140236382">
&lt;/a>
&lt;figcaption>image-20211110140236382&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>ä¼ ç»Ÿå¯†ç çš„å®‰å…¨ä½¿ç”¨è¦æ»¡è¶³ä¸¤ä¸ªè¦æ±‚ï¼š&lt;/p>
&lt;ul>
&lt;li>åŠ å¯†ç®—æ³•å¿…é¡»æ˜¯è¶³å¤Ÿå¼ºçš„ã€‚å³ä½¿æ”»å‡»è€…æ‹¥æœ‰ä¸€å®šæ•°é‡çš„å¯†æ–‡å’Œäº§ç”Ÿè¿™äº›å¯†æ–‡çš„æ˜æ–‡ï¼Œä»–ä¹Ÿä¸èƒ½ç ´è¯‘å¯†æ–‡æˆ–å‘ç°å¯†é’¥ã€‚&lt;/li>
&lt;li>å‘é€è€…å’Œæ¥æ”¶è€…å¿…é¡»åœ¨æŸç§å®‰å…¨çš„å½¢å¼ä¸‹è·å¾—å¯†é’¥å¹¶ä¿è¯å¯†é’¥å®‰å…¨ã€‚å¦‚æœæœ‰äººå‘ç°å¯†é’¥ï¼Œå¹¶çŸ¥é“ç®—æ³•ï¼Œå°±èƒ½è§£è¯»ä½¿ç”¨è¯¥å¯†é’¥åŠ å¯†çš„æ‰€æœ‰é€šä¿¡ã€‚&lt;/li>
&lt;/ul>
&lt;p>æˆ‘ä»¬å‡è®¾åŸºäºå·²çŸ¥å¯†æ–‡å’ŒåŠ å¯†/è§£å¯†ç®—æ³•è€Œç ´è¯‘æ¶ˆæ¯æ˜¯ä¸å®é™…çš„ï¼Œæˆ‘ä»¬ä¸éœ€è¦ç®—æ³•ä¿å¯†ï¼Œä»…éœ€è¦å¯†é’¥ä¿å¯†ã€‚å¦‚æœå¯†é’¥æ˜¯ç”±ä¿¡æ¯çš„å‘é€æ–¹äº§ç”Ÿçš„ï¼Œé‚£ä¹ˆå®ƒè¦é€šè¿‡æŸç§å®‰å…¨ä¿¡é“å‘é€åˆ°æ¥æ”¶æ–¹ï¼›å¦ä¸€ç§æ˜¯ç”±ç¬¬ä¸‰æ–¹ç”Ÿæˆå¯†é’¥åå†å®‰å…¨åœ°åˆ†å‘ç»™å‘é€æ–¹å’Œæ¥æ”¶æ–¹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-cpp" data-lang="cpp">&lt;span class="c1">// æ˜æ–‡Xï¼Œå…± m ä¸ªå…ƒç´ 
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">byte&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">m&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">X&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">X1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">X2&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">X3&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">X4&lt;/span>&lt;span class="p">,...,&lt;/span>&lt;span class="n">Xm&lt;/span>&lt;span class="p">};&lt;/span>
&lt;span class="c1">// å¯†é’¥Kï¼Œå…± j ä¸ªå…ƒç´ 
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">byte&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">K&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">K1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">K2&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">K3&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">K4&lt;/span>&lt;span class="p">,...,&lt;/span>&lt;span class="n">Kj&lt;/span>&lt;span class="p">};&lt;/span>
&lt;span class="c1">// åŠ å¯†ç®—æ³•Eï¼Œä»¥æ˜æ–‡å’Œå¯†é’¥ä¸ºè¾“å…¥ï¼Œè¾“å‡ºå¯†æ–‡ Y
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">byte&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">Y&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">E&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">X&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">K&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// è§£å¯†ç®—æ³•Dï¼Œä»¥å¯†æ–‡å’Œå¯†é’¥ä¸ºè¾“å…¥ï¼Œè¾“å‡ºæ˜æ–‡ X
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">byte&lt;/span>&lt;span class="p">[]&lt;/span> &lt;span class="n">X&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">D&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">K&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="11-å¯†ç ç¼–ç å­¦">1.1 å¯†ç ç¼–ç å­¦&lt;/h3>
&lt;p>å¯†ç ç¼–ç ç³»ç»Ÿæœ‰ä¸‰ä¸ªç‹¬ç«‹ç‰¹å¾ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;strong>è½¬æ¢æ˜æ–‡ä¸ºå¯†æ–‡çš„è¿ç®—ç±»å‹&lt;/strong>ã€‚&lt;strong>æ‰€æœ‰çš„åŠ å¯†ç®—æ³•éƒ½åŸºäºä¸¤ä¸ªåŸç†ï¼šä»£æ›¿å’Œç½®æ¢&lt;/strong>ã€‚ä»£æ›¿æ˜¯å°†æ˜æ–‡ä¸­çš„æ¯ä¸ªå…ƒç´ ï¼ˆå¦‚ä½ã€å­—æ¯ã€ä½ç»„æˆ–å­—æ¯ç»„ï¼‰æ˜ å°„æˆå¦ä¸€ä¸ªå…ƒç´ ï¼›ç½®æ¢æ˜¯å°†æ˜æ–‡ä¸­çš„å…ƒç´ é‡æ–°æ’åˆ—ã€‚ä¸Šè¿°è¿ç®—çš„åŸºæœ¬è¦æ±‚æ˜¯ä¸å…è®¸æœ‰ä¿¡æ¯ä¸¢å¤±ï¼ˆæ‰€æœ‰è¿ç®—éƒ½æ˜¯å¯é€†çš„ï¼‰ã€‚å¤§å¤šå¯†ç ä½“åˆ¶ä¹Ÿç§°ä¸ºä¹˜ç§¯å¯†ç ç³»ç»Ÿï¼Œéƒ½ä½¿ç”¨äº†å¤šå±‚ä»£æ›¿å’Œç½®æ¢ã€‚&lt;/li>
&lt;li>&lt;strong>æ‰€ç”¨çš„å¯†é’¥æ•°&lt;/strong>ã€‚å¦‚æœå‘é€æ–¹å’Œæ¥æ”¶æ–¹ä½¿ç”¨ç›¸åŒçš„å¯†é’¥ï¼Œè¿™ç§å¯†ç å°±ç§°ä¸ºå¯¹ç§°å¯†ç ã€å•å¯†é’¥å¯†ç æˆ–ä¼ ç»Ÿå¯†ç ã€‚å¦‚æœå‘æ”¶åŒæ–¹ä½¿ç”¨ä¸åŒçš„å¯†é’¥ï¼Œè¿™ç§å¯†ç å°±ç§°ä¸ºéå¯¹ç§°å¯†ç ã€åŒé’¥æˆ–å…¬é’¥å¯†ç ã€‚&lt;/li>
&lt;li>&lt;strong>å¤„ç†æ˜æ–‡çš„æ–¹æ³•&lt;/strong>ã€‚åˆ†ç»„å¯†ç æ¯æ¬¡å¤„ç†è¾“å…¥çš„ä¸€ç»„å…ƒç´ ï¼Œç›¸åº”åœ°è¾“å‡ºä¸€ç»„å…ƒç´ ã€‚æµå¯†ç åˆ™æ˜¯è¿ç»­åœ°å¤„ç†è¾“å…¥å…ƒç´ ï¼Œæ¯æ¬¡è¾“å‡ºä¸€ä¸ªå…ƒç´ ã€‚&lt;/li>
&lt;/ul>
&lt;p>æ”»å‡»å¯†ç ç³»ç»Ÿçš„å…¸å‹ç›®æ ‡æ˜¯æ¢å¤ä½¿ç”¨çš„å¯†é’¥ï¼Œè€Œä¸ä»…ä»…æ¢å¤å‡ºå•ä¸ªå¯†æ–‡å¯¹åº”çš„æ˜æ–‡ã€‚æ”»å‡»ä¼ ç»Ÿå¯†ç æœ‰ä¸¤ç§é€šç”¨çš„æ–¹æ³•ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;strong>å¯†ç åˆ†æå­¦&lt;/strong>ï¼šå¯†ç åˆ†æå­¦æ”»å‡»ä¾èµ–äºç®—æ³•çš„æ€§è´¨ã€æ˜æ–‡çš„ä¸€èˆ¬ç‰¹å¾æˆ–æŸäº›æ˜å¯†æ–‡å¯¹ã€‚è¿™ç§æ”»å‡»å½¢å¼ä¼å›¾åˆ©ç”¨ç®—æ³•çš„ç‰¹å¾æ¥æ¨å¯¼å‡ºç‰¹å®šçš„æ˜æ–‡æˆ–ä½¿ç”¨çš„å¯†é’¥ã€‚&lt;/li>
&lt;li>&lt;strong>ç©·ä¸¾æ”»å‡»&lt;/strong>ï¼šæ”»å‡»è€…å¯¹ä¸€æ¡å¯†æ–‡å°è¯•æ‰€æœ‰å¯èƒ½çš„å¯†é’¥ï¼Œç›´åˆ°æŠŠå®ƒè½¬åŒ–ä¸ºå¯è¯»çš„æœ‰æ„ä¹‰çš„æ˜æ–‡ã€‚å¹³å‡è€Œè¨€ï¼Œè·å¾—æˆåŠŸè‡³å°‘è¦å°è¯•æ‰€æœ‰å¯èƒ½çš„å¯†é’¥çš„ä¸€åŠã€‚&lt;/li>
&lt;/ul>
&lt;p>åŸºäºå¯†ç åˆ†æè€…çŸ¥é“çš„ä¿¡æ¯çš„å¤šå°‘ï¼Œæ¦‚æ‹¬å¯†ç æ”»å‡»çš„å‡ ç§ç±»å‹å¦‚ä¸‹ã€‚&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>æ”»å‡»ç±»å‹&lt;/th>
&lt;th>æ”»å‡»è€…å·²çŸ¥çš„ä¿¡æ¯&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>å”¯å¯†æ–‡æ”»å‡»&lt;/td>
&lt;td>åŠ å¯†ç®—æ³•ï¼›å¯†æ–‡ï¼›&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>å·²çŸ¥æ˜æ–‡æ”»å‡»&lt;/td>
&lt;td>åŠ å¯†ç®—æ³•ï¼›å¯†æ–‡ï¼›ä¸å¾…è§£å¯†å¯†æ–‡åŒä¸€å¯†é’¥åŠ å¯†çš„ä¸€ä¸ªæˆ–å¤šä¸ªæ˜å¯†æ–‡å¯¹ï¼›&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>é€‰æ‹©æ˜æ–‡æ”»å‡»&lt;/td>
&lt;td>åŠ å¯†ç®—æ³•ï¼›å¯†æ–‡ï¼›åˆ†æè€…é€‰æ‹©çš„æ˜æ–‡ï¼Œä»¥åŠå¯¹åº”çš„ï¼ˆä½¿ç”¨å’Œå¾…è§£å¯†å¯†æ–‡åŒä¸€å¯†é’¥ï¼‰åŠ å¯†çš„å¯†æ–‡ï¼›&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>é€‰æ‹©å¯†æ–‡æ”»å‡»&lt;/td>
&lt;td>åŠ å¯†ç®—æ³•ï¼›å¯†æ–‡ï¼›åˆ†æè€…é€‰æ‹©çš„å¯†æ–‡ï¼Œä»¥åŠå¯¹åº”çš„ï¼ˆä½¿ç”¨å’Œå¾…è§£å¯†å¯†æ–‡åŒä¸€å¯†é’¥ï¼‰çš„è§£å¯†æ˜æ–‡ï¼›&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>é€‰æ‹©æ–‡æœ¬æ”»å‡»&lt;/td>
&lt;td>åŠ å¯†ç®—æ³•ï¼›å¯†æ–‡ï¼›åˆ†æè€…é€‰çš„æ˜æ–‡ï¼Œä»¥åŠå¯¹åº”çš„å¯†æ–‡ï¼›åˆ†æè€…é€‰æ‹©çš„å¯†æ–‡ï¼Œä»¥åŠå¯¹åº”çš„æ˜æ–‡ï¼Œä½¿ç”¨å’Œå¾…è§£å¯†å¯†æ–‡åŒä¸€å¯†é’¥ã€‚&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>å”¯å¯†æ–‡æ”»å‡»æœ€å®¹æ˜“é˜²èŒƒï¼Œä½†å¾ˆå¤šæƒ…å†µä¸‹åˆ†æè€…å¯ä»¥å¾—åˆ°æ›´å¤šçš„ä¿¡æ¯ã€‚æ¯”å¦‚ postscript æ ¼å¼åŠ å¯†çš„æ–‡ä»¶æ€»æ˜¯ä»¥ç›¸åŒçš„æ ¼å¼å¼€å¤´ï¼Œç”µå­é‡‘èæ¶ˆæ¯å¾€å¾€æœ‰æ ‡å‡†åŒ–çš„æ–‡ä»¶å¤´æˆ–è€…æ ‡å¿—ï¼Œç±»ä¼¼çš„ä¾‹å­è¿˜æœ‰å¾ˆå¤šï¼Œè¿™äº›éƒ½æ˜¯å·²çŸ¥æ˜æ–‡æ”»å‡»çš„ä¾‹å­ã€‚æœ‰è¿™äº›çŸ¥è¯†çš„åˆ†æè€…å°±å¯ä»¥ä»è½¬æ¢æ˜æ–‡çš„æ–¹æ³•å…¥æ‰‹æ¥æ¨å¯¼å‡ºå¯†é’¥ã€‚&lt;/p>
&lt;p>ä¸å·²çŸ¥æ˜æ–‡æ”»å‡»ç´§å¯†ç›¸å…³çš„æ˜¯å¯èƒ½è¯æ”»å‡»ã€‚å¦‚æœæ”»å‡»è€…å¤„ç†çš„æ˜¯ä¸€äº›ç‰¹å®šçš„ä¿¡æ¯ï¼Œä»–å°±å¯èƒ½çŸ¥é“å…¶ä¸­çš„éƒ¨åˆ†å†…å®¹ã€‚æ¯”å¦‚è¯´ï¼ŒæŸå…¬å¸å¼€å‘çš„ç¨‹åºæºä»£ç å°±å¯èƒ½åŒ…å«è¯¥å…¬å¸çš„ç‰ˆæƒä¿¡æ¯ï¼Œå¹¶æ”¾åœ¨æŸä¸ªæ ‡å‡†ä½ç½®ã€‚&lt;/p>
&lt;p>å¦‚æœåˆ†æè€…èƒ½é€šè¿‡æŸç§æ–¹å¼è®©å‘é€æ–¹åœ¨å‘é€çš„ä¿¡æ¯ä¸­æ’å…¥ä¸€æ®µç”±ä»–é€‰æ‹©çš„ä¿¡æ¯ï¼Œé‚£ä¹ˆé€‰æ‹©æ˜æ–‡æ”»å‡»å°±æœ‰å¯èƒ½å®ç°ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœåˆ†æè€…æœ‰åŠæ³•é€‰æ‹©æ˜æ–‡åŠ å¯†ï¼Œé‚£ä¹ˆä»–å°†ç‰¹æ„é€‰å–é‚£äº›æœ€æœ‰å¯èƒ½ä¼šä»˜å‡ºå¯†é’¥çš„æ•°æ®ã€‚&lt;/p>
&lt;p>åªæœ‰ç›¸å¯¹è¾ƒå¼±çš„ç®—æ³•æ‰æŠµæŒ¡ä¸ä½å”¯å¯†æ–‡æ”»å‡»ï¼Œä¸€èˆ¬åœ°è¯´ï¼ŒåŠ å¯†ç®—æ³•èµ·ç è¦èƒ½ç»å—ä½å·²çŸ¥æ˜æ–‡æ”»å‡»æ‰è¡Œã€‚&lt;/p>
&lt;p>å¦‚æœä¸€ä¸ªå¯†ç ä½“åˆ¶æ»¡è¶³æ¡ä»¶ï¼šæ— è®ºæœ‰å¤šå°‘å¯ä½¿ç”¨çš„å¯†æ–‡ï¼Œéƒ½ä¸è¶³ä»¥å”¯ä¸€åœ°ç¡®å®šå¯†æ–‡æ‰€å¯¹åº”çš„æ˜æ–‡ï¼Œåˆ™ç§°è¯¥åŠ å¯†ä½“åˆ¶æ˜¯æ— æ¡ä»¶å®‰å…¨çš„ã€‚ä¹Ÿå°±æ˜¯æ”»å‡»è€…æ— è®ºèŠ±å¤šå°‘æ—¶é—´ï¼Œéƒ½æ— æ³•å°†å¯†æ–‡è§£å¯†ï¼Œå› ä¸ºä»–æ‰€éœ€çš„ä¿¡æ¯ä¸åœ¨å¯†æ–‡ä¸­ã€‚é™¤äº†ä¸€æ¬¡ä¸€å¯†ä¹‹å¤–æ‰€æœ‰çš„åŠ å¯†ç®—æ³•éƒ½ä¸æ˜¯æ— æ¡ä»¶å®‰å…¨çš„ã€‚&lt;/p>
&lt;p>åŠ å¯†ç®—æ³•ä½¿ç”¨è€…åº”è¯¥å°½é‡æŒ‘é€‰æ»¡è¶³ä¸‹é¢æ ‡å‡†çš„ç®—æ³•ï¼š&lt;/p>
&lt;ul>
&lt;li>ç ´è¯‘å¯†ç çš„ä»£ä»·è¶…è¿‡å¯†æ–‡ä¿¡æ¯çš„ä»·å€¼ã€‚&lt;/li>
&lt;li>ç ´è¯‘å¯†ç çš„æ—¶é—´è¶…å‡ºå¯†æ–‡ä¿¡æ¯çš„æœ‰æ•ˆç”Ÿå‘½æœŸã€‚&lt;/li>
&lt;/ul>
&lt;p>å¦‚æœæ»¡è¶³ä¸Šè¿°æ ‡å‡†ä¸­ä»»æ„ä¸€æ¡åˆ™å®ƒåœ¨è®¡ç®—ä¸Šæ˜¯å®‰å…¨çš„ï¼Œä½†ä¼°è®¡æ”»å‡»è€…ç ´è¯‘å¯†æ–‡æ‰€éœ€çš„å·¥ä½œé‡æ˜¯éå¸¸å›°éš¾çš„ã€‚&lt;/p>
&lt;p>ä»ç©·ä¸¾æ³•å…¥æ‰‹ï¼Œè€ƒè™‘æ‰€éœ€çš„æ—¶é—´ã€‚ç©·ä¸¾è¦è·å¾—æˆåŠŸå¹³å‡æ¥è¯´å¿…é¡»å°è¯•æ‰€æœ‰å¯èƒ½å¯†é’¥çš„ä¸€åŠï¼Œä¸‹å›¾ç»™å‡ºäº†ä¸åŒå¯†é’¥ç©ºé—´ç©·ä¸¾å°è¯•æ‰€éœ€çš„æ—¶é—´ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 401;
flex-basis: 964px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-01/image-20211110150214623.png" data-size="1431x356">
&lt;img src="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-01/image-20211110150214623.png"
width="1431"
height="356"
srcset="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-01/image-20211110150214623_hua784c719a6627b81510d7a296f0c9cd9_192031_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/cryptography-introduction-01/image-20211110150214623_hua784c719a6627b81510d7a296f0c9cd9_192031_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211110150214623">
&lt;/a>
&lt;figcaption>image-20211110150214623&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;h2 id="0x02-ä»£æ›¿æŠ€æœ¯">0x02 ä»£æ›¿æŠ€æœ¯&lt;/h2>
&lt;h3 id="21-caesar-å‡¯æ’’å¯†ç ">2.1 Caesar å‡¯æ’’å¯†ç &lt;/h3>
&lt;p>å·²çŸ¥æœ€æ—©çš„ä»£æ›¿å¯†ç æ˜¯ç”± julius caesar å‘æ˜çš„ caesar å¯†ç ã€‚caesar å¯†ç éå¸¸ç®€å•ï¼Œå°±æ˜¯å¯¹å­—æ¯è¡¨ä¸­çš„æ¯ä¸ªå­—æ¯ï¼Œç”¨å®ƒä¹‹åçš„ç¬¬ä¸‰ä¸ªå­—æ¯æ¥ä»£æ›¿ï¼Œå­—æ¯è¡¨æ˜¯é¦–å°¾ç›¸è¿å¾ªç¯çš„ã€‚&lt;/p>
&lt;p>å‡¯æ’’å¯†ç å¯ä»¥è¿™æ ·è¡¨è¾¾ï¼š&lt;code>C = E(k, p) = (p + k) mod 26&lt;/code>ã€‚&lt;/p>
&lt;p>å‡¯æ’’å¯†ç çš„è§£å¯†ç®—æ³•å¯ä»¥è¿™æ ·è¡¨è¾¾ï¼š&lt;code>p = D(k, C) = (C - k) mod 26&lt;/code>ã€‚&lt;/p>
&lt;p>å…¶ä¸­ k çš„å–å€¼èŒƒå›´æ˜¯ 1-25ï¼Œå–å€¼ä¸º 0 çš„æƒ…å†µä¸‹å°±æ˜¯æ˜æ–‡ï¼›å–å€¼26å’Œå–å€¼0ç›¸åŒï¼›å–å€¼è¶…è¿‡ 26 åˆ™ç›¸å½“äºæ˜¯å–äº† &lt;code>k mod 26&lt;/code> ï¼Œå› ä¸ºå­—æ¯è¡¨æ˜¯å¾ªç¯çš„ï¼›å–è´Ÿæ•°ç›¸å½“äºå– &lt;code>26 + k&lt;/code>ï¼Œå› ä¸ºå­—æ¯è¡¨æ˜¯å¾ªç¯çš„ã€‚&lt;/p>
&lt;p>ä¸€ä¸ªç®€å•çš„å®ç°å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-cpp" data-lang="cpp">&lt;span class="k">enum&lt;/span> &lt;span class="k">class&lt;/span> &lt;span class="nc">CryptMode&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">encrypt&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="n">decrypt&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">};&lt;/span>
&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">string&lt;/span> &lt;span class="n">caesar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">k&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">string&lt;/span> &lt;span class="n">plaintext&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">CryptMode&lt;/span> &lt;span class="n">mode&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">string&lt;/span> &lt;span class="n">output&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">auto&lt;/span> &lt;span class="nl">c&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">plaintext&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">mode&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">CryptMode&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">decrypt&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">output&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">push_back&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">c&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="sc">&amp;#39;A&amp;#39;&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">k&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="mi">26&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="sc">&amp;#39;a&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">output&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">push_back&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">c&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="sc">&amp;#39;a&amp;#39;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">k&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="mi">26&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="sc">&amp;#39;A&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">output&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯¹äºè¾“å…¥ &lt;code>hello&lt;/code> ï¼Œ&lt;code>k=3&lt;/code>ï¼Œè¾“å‡ºä¸º &lt;code>KHOOR&lt;/code> ã€‚&lt;/p>
&lt;p>å¦‚æœå·²çŸ¥æŸç»™å®šçš„å¯†æ–‡æ˜¯ caesar å¯†ç ï¼Œç©·ä¸¾æ”»å‡»æ˜¯å¾ˆå®¹æ˜“å®ç°çš„ï¼šåªè¦ç®€å•åœ°æµ‹è¯•25ç§å¯èƒ½çš„å¯†é’¥ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-cpp" data-lang="cpp">&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">string&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">brute_force_caesar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">string&lt;/span> &lt;span class="n">ciphertext&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">string&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">k&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">k&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">25&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">k&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">push_back&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">caesar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">k&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ciphertext&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">CryptMode&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">decrypt&lt;/span>&lt;span class="p">));&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å°†å‰é¢çš„å¯†æ–‡è¾“å…¥ï¼Œå¾—åˆ°è¾“å‡ºå¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">brute force caesar: jgnnq
brute force caesar: ifmmp
brute force caesar: hello
brute force caesar: gdkkn
... ä¸‹ç•¥
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°æ˜æ–‡å·²ç»å‡ºç°ã€‚&lt;/p>
&lt;p>å‡¯æ’’å¯†ç çš„ä¸‰ä¸ªé‡è¦ç‰¹å¾ä½¿æˆ‘ä»¬å¯ä»¥ç©·ä¸¾æ”»å‡»ï¼š&lt;/p>
&lt;ol>
&lt;li>å·²çŸ¥åŠ è§£å¯†çš„ç®—æ³•&lt;/li>
&lt;li>éœ€æµ‹è¯•çš„å¯†é’¥åªæœ‰25ä¸ª&lt;/li>
&lt;li>æ˜æ–‡æ‰€ç”¨çš„è¯­è¨€æ˜¯å·²çŸ¥çš„ï¼Œè€Œä¸”æ„ä¹‰æ˜“äºè¯†åˆ«&lt;/li>
&lt;/ol>
&lt;p>å¤§å¤šæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å‡è®¾å¯†ç ç®—æ³•æ˜¯å·²çŸ¥çš„ã€‚ä¸€èˆ¬å¯†é’¥ç©ºé—´å¾ˆå¤§çš„ç®—æ³•å¯ä»¥ä½¿ç©·ä¸¾æ”»å‡»ä¸å¤ªå¯èƒ½ï¼Œä¾‹å¦‚3DESç®—æ³•çš„å¯†é’¥é•¿åº¦æ˜¯ 168 ä½ï¼Œå¯†é’¥ç©ºé—´æ˜¯ 2^168ï¼Œæœ‰å¤§äº 3.7*10^50 ç§å¯èƒ½çš„å¯†é’¥ã€‚&lt;/p>
&lt;p>å¦‚æœæ˜æ–‡æ‰€ç”¨çš„è¯­è¨€ä¸ä¸ºæˆ‘ä»¬æ‰€çŸ¥ï¼Œé‚£ä¹ˆæ˜æ–‡è¾“å‡ºå°±ä¸å¯è¯†åˆ«ã€‚è¾“å…¥ä¹Ÿå¯èƒ½æŒ‰ç…§æŸç§æ–¹å¼ç»è¿‡ç¼©å†™æˆ–å‹ç¼©ï¼Œä¹Ÿå°±æ›´ä¸å¯èƒ½è¯†åˆ«äº†ã€‚ä¾‹å¦‚ä¸€ä¸ªç»è¿‡zipå‹ç¼©çš„æ–‡æœ¬æ–‡ä»¶ï¼Œç”¨ä¸€ç§ç®€å•çš„ä»£æ›¿å¯†ç æ¥åŠ å¯†ï¼Œé‚£ä¹ˆå³ä½¿ç”¨ç©·ä¸¾æ³•æ¥è¿›è¡Œå¯†ç åˆ†æï¼Œæ¢å¤å‡ºæ¥çš„æ˜æ–‡ä¹Ÿæ˜¯ä¸å¯è¯†åˆ«çš„ã€‚ï¼ˆæ³¨ï¼šå®é™…ä¸Šå¯ä»¥é€šè¿‡æ–‡ä»¶å¤´ã€magic number ä¹‹ç±»çš„å·²çŸ¥ç‰¹å¾æ¥çŒœæµ‹å‡ºå†…å®¹æ˜¯è¢«å‹ç¼©è¿‡çš„ï¼‰ã€‚&lt;/p>
&lt;h3 id="22-å•è¡¨ä»£æ›¿å¯†ç ">2.2 å•è¡¨ä»£æ›¿å¯†ç &lt;/h3>
&lt;p>å‡¯æ’’å¯†ç æ˜¯ä¸€ç§ä»£æ›¿å¯†ç ï¼Œæ¯ä¸ªæ˜æ–‡å…ƒç´ å”¯ä¸€å¯¹åº”ä»£æ›¿è¡¨ä¸­çš„ä¸€ä¸ªå¯†æ–‡å…ƒç´ ã€‚å› ä¸ºä»£æ›¿è¡¨æ˜¯å­—æ¯è¡¨çš„å¾ªç¯ç§»åŠ¨ï¼Œæ•…å¯†ç èŒƒå›´åªæœ‰ 1-25ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 620;
flex-basis: 1489px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-01/image-20211110155545123.png" data-size="571x92">
&lt;img src="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-01/image-20211110155545123.png"
width="571"
height="92"
srcset="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-01/image-20211110155545123_hu3e213ee09efbd6d51e121868c96de46b_37508_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/cryptography-introduction-01/image-20211110155545123_hu3e213ee09efbd6d51e121868c96de46b_37508_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211110155545123">
&lt;/a>
&lt;figcaption>image-20211110155545123&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å®šä¹‰æœ¯è¯­&lt;strong>ç½®æ¢&lt;/strong>ï¼šè®¾æœ‰é™å…ƒç´ çš„é›†åˆ &lt;em>S&lt;/em> çš„ç½®æ¢æ˜¯ &lt;em>S&lt;/em> çš„æ‰€æœ‰å…ƒç´ çš„æœ‰åºæ’åˆ—ï¼Œè€Œä¸”æ¯ä¸ªå…ƒç´ åªå‡ºç°ä¸€æ¬¡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæœ‰ &lt;code>S = {a,b,c}&lt;/code> ï¼Œåˆ™ &lt;em>S&lt;/em> æœ‰ 6 ä¸ªç½®æ¢ï¼š&lt;code>abc,acb,bac,bca,cab,cba&lt;/code> ã€‚ä¸€èˆ¬å…·æœ‰ n ä¸ªå…ƒç´ çš„é›†åˆæœ‰ &lt;code>n!&lt;/code> ä¸ªç½®æ¢ã€‚&lt;/p>
&lt;p>å¦‚æœä»£æ›¿è¡¨æ˜¯26ä¸ªå­—æ¯çš„ä»»æ„ç½®æ¢ï¼Œé‚£ä¹ˆå°±æœ‰ &lt;code>26!&lt;/code> ç§å¯èƒ½çš„å¯†é’¥ï¼Œå¤§äº &lt;code>4*10^26&lt;/code> ç§å¯èƒ½ï¼Œè¿™æ¯” DES çš„å¯†é’¥ç©ºé—´è¿˜è¦å¤§ 10 ä¸ªæ•°é‡çº§ï¼Œçœ‹èµ·æ¥èƒ½æŠµæŒ¡ç©·ä¸¾æ”»å‡»äº†ã€‚&lt;/p>
&lt;p>è¿™ç§æ–¹æ³•è¢«ç§°ä¸ºå•è¡¨ä»£æ›¿å¯†ç ï¼Œæ¯æ¡æ¶ˆæ¯ç”¨ä¸€ä¸ªå­—æ¯è¡¨ï¼ˆç»™å‡ºä»æ˜æ–‡å­—æ¯åˆ°å¯†æ–‡å­—æ¯çš„æ˜ å°„ï¼‰åŠ å¯†ã€‚&lt;/p>
&lt;h3 id="23-è¯é¢‘æ”»å‡»">2.3 è¯é¢‘æ”»å‡»&lt;/h3>
&lt;p>å¯¹äºå•è¡¨ä»£æ›¿å¯†ç ï¼Œå¦‚æœæ”»å‡»è€…çŸ¥é“æ˜æ–‡çš„å±æ€§ï¼Œæ¯”å¦‚çŸ¥é“æ˜æ–‡æ˜¯æœªç»å‹ç¼©çš„è‹±æ–‡æ–‡æœ¬ï¼Œå°±å¯ä»¥é€šè¿‡è¯­è¨€çš„ä¸€äº›ç»Ÿè®¡å­¦è§„å¾‹è¿›è¡Œæ”»å‡»ã€‚&lt;/p>
&lt;p>ä¾‹å¦‚ä¸‹å›¾ä¸­çš„å¯†æ–‡ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 596;
flex-basis: 1431px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-01/image-20211110160433970.png" data-size="841x141">
&lt;img src="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-01/image-20211110160433970.png"
width="841"
height="141"
srcset="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-01/image-20211110160433970_hu0bae56299b47face312e3af416d81f8d_75914_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/cryptography-introduction-01/image-20211110160433970_hu0bae56299b47face312e3af416d81f8d_75914_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211110160433970">
&lt;/a>
&lt;figcaption>image-20211110160433970&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å·²çŸ¥æ˜æ–‡æ˜¯è‹±æ–‡æ–‡æœ¬ï¼Œé¦–å…ˆæŠŠå­—æ¯ä½¿ç”¨çš„ç›¸å¯¹é¢‘ç‡ç»Ÿè®¡å‡ºæ¥ï¼Œä¸è‹±æ–‡å­—æ¯çš„ä½¿ç”¨é¢‘ç‡åˆ†å¸ƒè¿›è¡Œæ¯”è¾ƒã€‚&lt;/p>
&lt;p>å¯†æ–‡å­—æ¯ä½¿ç”¨é¢‘ç‡ï¼š&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 567;
flex-basis: 1362px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-01/image-20211110160604203.png" data-size="1345x237">
&lt;img src="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-01/image-20211110160604203.png"
width="1345"
height="237"
srcset="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-01/image-20211110160604203_hud2bc73f9e0917779ec0f259ca64b743c_85725_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/cryptography-introduction-01/image-20211110160604203_hud2bc73f9e0917779ec0f259ca64b743c_85725_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211110160604203">
&lt;/a>
&lt;figcaption>image-20211110160604203&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>è‹±æ–‡å­—æ¯ä½¿ç”¨é¢‘ç‡ï¼š&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 134;
flex-basis: 323px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-01/image-20211110160620669.png" data-size="884x656">
&lt;img src="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-01/image-20211110160620669.png"
width="884"
height="656"
srcset="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-01/image-20211110160620669_hu4f20a761c6fb706ee66e5ab52766ee21_322944_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/cryptography-introduction-01/image-20211110160620669_hu4f20a761c6fb706ee66e5ab52766ee21_322944_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211110160620669">
&lt;/a>
&lt;figcaption>image-20211110160620669&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æ­¤æ—¶æˆ‘ä»¬å¯ä»¥å°è¯•åœ¨å¯†æ–‡ä¸Šåšä¸€äº›ä»£æ›¿ï¼Œå¡«å…¥æ˜æ–‡ï¼Œçœ‹çœ‹æ˜¯å¦å½¢æˆä¸€ä¸ªå¯è¯»æ¶ˆæ¯ã€‚æ›´ç³»ç»Ÿä¸€ç‚¹çš„æ–¹æ³•æ˜¯å¯»æ‰¾å…¶ä»–è§„å¾‹ï¼Œä¾‹å¦‚æ˜æ–‡ä¸­æœ‰æŸäº›è¯å¯èƒ½æ˜¯å·²çŸ¥çš„ï¼Œæˆ–è€…å¯»æ‰¾å¯†æ–‡å­—æ¯ä¸­çš„é‡å¤åºåˆ—ï¼Œæ¨å¯¼å®ƒä»¬çš„ç­‰ä»·æ˜æ–‡ã€‚ç»Ÿè®¡åŒå­—æ¯ç»„åˆçš„é¢‘ç‡ä¼šæ˜¯ä¸ªå¾ˆæœ‰æ•ˆçš„å·¥å…·ã€‚&lt;/p>
&lt;p>å°è¯•åˆ†æçš„ç»“æœæ˜¯ï¼š&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 343;
flex-basis: 824px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-01/image-20211110160738100.png" data-size="831x242">
&lt;img src="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-01/image-20211110160738100.png"
width="831"
height="242"
srcset="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-01/image-20211110160738100_hub66bc3a0a336c5d68333c334cbbee3ec_99281_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/cryptography-introduction-01/image-20211110160738100_hub66bc3a0a336c5d68333c334cbbee3ec_99281_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211110160738100">
&lt;/a>
&lt;figcaption>image-20211110160738100&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>ç»§ç»­è¿›è¡Œåˆ†æå’Œæµ‹è¯•å¯ä»¥å¾ˆå¿«å¾—å‡ºå®Œæ•´çš„æ˜æ–‡ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 864;
flex-basis: 2075px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-01/image-20211110161027735.png" data-size="960x111">
&lt;img src="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-01/image-20211110161027735.png"
width="960"
height="111"
srcset="https://nnnewb.github.io/blog/blog/p/cryptography-introduction-01/image-20211110161027735_hu97cc0623de9f6e01bc3a236c731df603_66342_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/cryptography-introduction-01/image-20211110161027735_hu97cc0623de9f6e01bc3a236c731df603_66342_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211110161027735">
&lt;/a>
&lt;figcaption>image-20211110161027735&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å®è·µï¼š&lt;/p>
&lt;p>å®ç°ä¸€ä¸ªç®€å•çš„æ›¿ä»£å¯†ç ï¼Œç”¨éšæœºç”Ÿæˆçš„å¯†ç è¡¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-cpp" data-lang="cpp">&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">string&lt;/span> &lt;span class="n">substitution_cipher&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">string&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">plaintext&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">map&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">char&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">char&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">chart&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">string&lt;/span> &lt;span class="n">output&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="nl">c&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">plaintext&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">output&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">push_back&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">chart&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tolower&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="p">)));&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">out_of_range&lt;/span> &lt;span class="n">err&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;invalid input&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">output&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// æ›¿ä»£å¯†ç è¡¨
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">map&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">char&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">char&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">chart&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="p">{&lt;/span>&lt;span class="sc">&amp;#39;a&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sc">&amp;#39;o&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="sc">&amp;#39;b&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sc">&amp;#39;a&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="sc">&amp;#39;c&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sc">&amp;#39;f&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="sc">&amp;#39;d&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sc">&amp;#39;u&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="sc">&amp;#39;e&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sc">&amp;#39;g&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="sc">&amp;#39;f&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sc">&amp;#39;y&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="sc">&amp;#39;g&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sc">&amp;#39;n&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="sc">&amp;#39;h&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sc">&amp;#39;k&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span>
&lt;span class="p">{&lt;/span>&lt;span class="sc">&amp;#39;i&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sc">&amp;#39;e&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="sc">&amp;#39;j&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sc">&amp;#39;z&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="sc">&amp;#39;k&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sc">&amp;#39;t&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="sc">&amp;#39;l&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sc">&amp;#39;b&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="sc">&amp;#39;m&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sc">&amp;#39;d&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="sc">&amp;#39;n&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sc">&amp;#39;p&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="sc">&amp;#39;o&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sc">&amp;#39;l&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="sc">&amp;#39;p&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sc">&amp;#39;m&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span>
&lt;span class="p">{&lt;/span>&lt;span class="sc">&amp;#39;q&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sc">&amp;#39;j&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="sc">&amp;#39;r&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sc">&amp;#39;q&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="sc">&amp;#39;s&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sc">&amp;#39;c&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="sc">&amp;#39;t&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sc">&amp;#39;i&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="sc">&amp;#39;u&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sc">&amp;#39;w&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="sc">&amp;#39;v&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sc">&amp;#39;x&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="sc">&amp;#39;w&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sc">&amp;#39;s&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="sc">&amp;#39;x&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sc">&amp;#39;v&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span>
&lt;span class="p">{&lt;/span>&lt;span class="sc">&amp;#39;y&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sc">&amp;#39;r&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="sc">&amp;#39;z&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sc">&amp;#39;h&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="sc">&amp;#39; &amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sc">&amp;#39; &amp;#39;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="sc">&amp;#39;,&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sc">&amp;#39;,&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="sc">&amp;#39;.&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sc">&amp;#39;.&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="sc">&amp;#39;\&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sc">&amp;#39;\&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span>
&lt;span class="p">};&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">ciphertext&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">substitution_cipher&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;It can solve simple substitution ciphers often found in newspapers, including puzzles like cryptoquips&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">chart&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">cout&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">ciphertext&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">endl&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åŠ å¯†ç»“æœï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">ei fop clbxg cedmbg cwacieiwielp femkgqc lyigp ylwpu ep pgscmomgqc, epfbwuepn mwhhbgc betg fqrmiljwemc
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥åœ¨ &lt;a class="link" href="https://www.quipqiup.com/" target="_blank" rel="noopener"
>quipquip&lt;/a> å°è¯•è§£å¯†ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>Qï¼šå¯¹ç§°å¯†ç çš„æœ¬è´¨æˆåˆ†&lt;/p>
&lt;p>æ˜æ–‡ã€å¯†æ–‡ã€å¯†é’¥ã€åŠ å¯†ç®—æ³•ã€è§£å¯†ç®—æ³•ã€‚&lt;/p>
&lt;p>Qï¼šå¯†ç ç®—æ³•ä¸­çš„ä¸¤ä¸ªåŸºæœ¬å‡½æ•°&lt;/p>
&lt;p>æ›¿ä»£å’Œç½®æ¢ã€‚&lt;/p>
&lt;p>Qï¼šç”¨å¯†ç é€šä¿¡çš„ä¸¤ä¸ªäººéœ€è¦å¤šå°‘å¯†é’¥&lt;/p>
&lt;p>1ä¸ªï¼ˆå¯¹ç§°åŠ å¯†ï¼‰æˆ– 2 ä¸ªï¼ˆå…¬é’¥åŠ å¯†ï¼‰ã€‚&lt;/p>
&lt;p>å…³äºè¿™ç‚¹å¯¹ä¹¦æœ¬æœ‰ç‚¹å›°æƒ‘ï¼Œå®é™…ç»éªŒå‘Šè¯‰æˆ‘éœ€è¦è‡³å°‘4ä¸ªå¯†é’¥ï¼ˆå‘é€æ–¹å…¬é’¥ã€å‘é€æ–¹ç§é’¥ã€æ¥æ”¶æ–¹å…¬é’¥ã€æ¥æ”¶æ–¹ç§é’¥ï¼‰ï¼Œä¹¦æœ¬é‡Œå¯èƒ½æŠŠä¸€å¯¹å…¬ç§é’¥ç®—ä¸€ä¸ªå¯†é’¥ã€‚&lt;/p>
&lt;p>Qï¼šåˆ†ç»„å¯†ç å’Œæµå¯†ç çš„åŒºåˆ«&lt;/p>
&lt;p>åˆ†ç»„å¯†ç ä¸€æ¬¡å¤„ç†ä¸€ç»„å…ƒç´ ï¼Œä¸€æ¬¡è¾“å‡ºä¸€ç»„å…ƒç´ ã€‚æµå¯†ç è¿ç»­å¤„ç†è¾“å…¥å…ƒç´ ï¼Œæ¯æ¬¡è¾“å‡ºä¸€ä¸ªå…ƒç´ ã€‚&lt;/p>
&lt;p>Qï¼šæ”»å‡»å¯†ç çš„ä¸¤ç§ä¸€èˆ¬æ–¹æ³•æ˜¯ä»€ä¹ˆ&lt;/p>
&lt;p>å¯†ç åˆ†æå’Œç©·ä¸¾ã€‚å¯†ç åˆ†æå­¦æ”»å‡»ä¾èµ–äºç®—æ³•çš„æ€§è´¨ã€æ˜æ–‡çš„ä¸€èˆ¬ç‰¹å¾æˆ–æŸäº›æ˜å¯†æ–‡å¯¹ã€‚è¿™ç§æ”»å‡»å½¢å¼ä¼å›¾åˆ©ç”¨ç®—æ³•çš„ç‰¹å¾æ¥æ¨å¯¼å‡ºç‰¹å®šçš„æ˜æ–‡æˆ–ä½¿ç”¨çš„å¯†é’¥ã€‚ç©·ä¸¾æ³•åˆ™æ˜¯æšä¸¾æ‰€æœ‰å¯èƒ½çš„å¯†é’¥ï¼Œç›´åˆ°è·å¾—æœ‰æ„ä¹‰çš„æ˜æ–‡ã€‚&lt;/p>
&lt;p>Qï¼šåˆ—å‡ºå’Œå®šä¹‰åŸºäºæ”»å‡»è€…æ‰€çŸ¥ä¿¡æ¯çš„å¯†ç åˆ†ææ”»å‡»ç±»å‹&lt;/p>
&lt;ul>
&lt;li>å”¯å¯†æ–‡æ”»å‡»ã€‚å·²çŸ¥ç®—æ³•å’Œå¯†æ–‡ã€‚&lt;/li>
&lt;li>å·²çŸ¥æ˜æ–‡æ”»å‡»ã€‚å·²çŸ¥ç®—æ³•ã€å¯†æ–‡ã€æ˜æ–‡ã€‚&lt;/li>
&lt;li>é€‰æ‹©å¯†æ–‡æ”»å‡»ã€‚å·²çŸ¥ç®—æ³•ã€å¯†æ–‡ã€æ”»å‡»è€…é€‰æ‹©çš„æ˜æ–‡å’Œå¯¹åº”çš„å¯†æ–‡ã€‚ï¼ˆæ”»å‡»è€…å¯ä»¥æ§åˆ¶å¾…åŠ å¯†å†…å®¹ï¼‰&lt;/li>
&lt;li>é€‰æ‹©æ˜æ–‡æ”»å‡»ã€‚å·²çŸ¥ç®—æ³•ã€å¯†æ–‡ã€æ”»å‡»è€…é€‰æ‹©çš„å¯†æ–‡å’Œå¯¹åº”çš„æ˜æ–‡ã€‚ï¼ˆæ”»å‡»è€…å¯ä»¥æ§åˆ¶å¾…è§£å¯†å†…å®¹ï¼‰&lt;/li>
&lt;li>é€‰æ‹©æ–‡æœ¬æ”»å‡»ã€‚å·²çŸ¥ç®—æ³•ã€å¯†æ–‡ã€æ”»å‡»è€…é€‰æ‹©çš„å¯†æ–‡å’Œå¯¹åº”çš„æ˜æ–‡ã€æ”»å‡»è€…é€‰æ‹©çš„æ˜æ–‡å’Œå¯¹åº”çš„å¯†æ–‡ã€‚ï¼ˆæ”»å‡»è€…å¯ä»¥è‡ªç”±åŠ å¯†/è§£å¯†ï¼Œä½†ä¸çŸ¥é“å¯†é’¥ï¼‰&lt;/li>
&lt;/ul>
&lt;p>Qï¼šæ— æ¡ä»¶å®‰å…¨å¯†ç å’Œè®¡ç®—ä¸Šå®‰å…¨çš„å¯†ç åŒºåˆ«æ˜¯ä»€ä¹ˆ&lt;/p>
&lt;p>æ— æ¡ä»¶å®‰å…¨å¯†ç æ— æ³•ä»å¯†æ–‡åˆ†æå‡ºå¯†é’¥ï¼Œä¸å¯ç ´è¯‘ã€‚&lt;/p>
&lt;p>è®¡ç®—ä¸Šå®‰å…¨çš„å¯†ç æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ä¹‹ä¸€ï¼š&lt;/p>
&lt;ol>
&lt;li>ç ´è¯‘å¯†æ–‡çš„ä»£ä»·å¤§äºå¯†æ–‡ä¿¡æ¯çš„ä»·å€¼ã€‚&lt;/li>
&lt;li>ç ´è¯‘å¯†ç çš„æ—¶é—´è¶…è¿‡å¯†æ–‡ä¿¡æ¯çš„æœ‰æ•ˆæœŸã€‚&lt;/li>
&lt;/ol>
&lt;p>Qï¼šç®€è¦å®šä¹‰ Caesar å¯†ç &lt;/p>
&lt;p>&lt;code>C = E(k, p) = (p + k) mod 26&lt;/code>&lt;/p>
&lt;p>&lt;code>p = D(k, C) = (C - k) mod 26&lt;/code>&lt;/p>
&lt;p>Qï¼šç®€è¦å®šä¹‰å•è¡¨ä»£æ›¿å¯†ç &lt;/p>
&lt;p>å…è®¸å­—æ¯ä»»æ„æ›¿ä»£ï¼Œæ˜æ–‡å­—æ¯è¡¨å’Œå¯†æ–‡å­—æ¯è¡¨æ˜¯&lt;a class="link" href="https://baike.baidu.com/item/%E5%8F%8C%E5%B0%84/942799" target="_blank" rel="noopener"
>åŒå°„&lt;/a>çš„ã€‚&lt;/p></description></item><item><title>è¿ç»´çè®° 2021å¹´11æœˆ11æ—¥</title><link>https://nnnewb.github.io/blog/p/blind-op-2021-11-11/</link><pubDate>Thu, 11 Nov 2021 10:19:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/blind-op-2021-11-11/</guid><description>&lt;img src="https://nnnewb.github.io/blog/p/blind-op-2021-11-11/cover.png" alt="Featured image of post è¿ç»´çè®° 2021å¹´11æœˆ11æ—¥" />&lt;h2 id="è®°è™šæ‹Ÿæœºç½‘ç»œæœªè¿æ¥">è®°è™šæ‹Ÿæœºç½‘ç»œæœªè¿æ¥&lt;/h2>
&lt;h3 id="èµ·å› ">èµ·å› &lt;/h3>
&lt;p>å› ä¸ºUbuntu serverå®‰è£…æ—¶æ›´æ–°çš„è¯éœ€è¦ä»ç½‘ç»œä¸‹è½½ï¼Œæ…¢çš„ä¸€æ‰¹ï¼Œæ‰€ä»¥å®‰è£…çš„æ—¶å€™è™šæ‹Ÿæœºçš„ç½‘ç»œæ–­å¼€äº†ï¼Œå®‰è£…å¥½å¯åŠ¨ä¹‹åæ‰é‡æ–°é“¾æ¥ã€‚&lt;/p>
&lt;p>ä½†æ˜¯&amp;hellip;&lt;/p>
&lt;p>è¿æ¥åè¿›å…¥ç³»ç»Ÿå´å‘ç°å¹¶æ²¡æœ‰ç½‘ç»œï¼ˆVirtualBoxï¼‰ï¼Œæ£€æŸ¥ &lt;code>networkctl&lt;/code> å‘ç° &lt;code>enp0s3&lt;/code> æ˜¯ &lt;code>off&lt;/code> çŠ¶æ€ã€‚&lt;/p>
&lt;h3 id="åŸå› ">åŸå› &lt;/h3>
&lt;p>åˆ«é—®ï¼Œä¸çŸ¥é“ã€‚&lt;/p>
&lt;h3 id="å¤„ç†">å¤„ç†&lt;/h3>
&lt;p>é¡ºè—¤æ‘¸ç“œä¸æ±‚ç”šè§£äº†ã€‚&lt;/p>
&lt;p>çœ‹åˆ° &lt;code>enp0s3&lt;/code> æ˜¯ &lt;code>off&lt;/code> é‚£å°±å…ˆæŸ¥æŸ¥æ€ä¹ˆè§£å†³ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">sudo ip link &lt;span class="nb">set&lt;/span> enp0s3 up
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å†æ£€æŸ¥è¿æ¥çŠ¶æ€ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">networkctl status
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å‘ç°è¿æ¥è¿›å…¥ &lt;code>downgrade&lt;/code> çŠ¶æ€ï¼Œæœç´¢å¾—çŸ¥æ˜¯æœªåˆ†é… IP åœ°å€ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">sudo dhclient enp0s3
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æŠ¥äº†ä¸€ä¸ªå¥‡æ€ªçš„CMPä»€ä¹ˆçš„é”™è¯¯ï¼Œä¸ç®¡äº†ã€‚å†æ£€æŸ¥ä¸‹ç½‘ç»œã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">networkctl
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å‘ç° &lt;code>enp0s3&lt;/code> è¿›å…¥ &lt;code>routable&lt;/code> çŠ¶æ€ï¼Œå¤§åŠŸå‘Šæˆã€‚&lt;/p>
&lt;h3 id="æ€»ç»“">æ€»ç»“&lt;/h3>
&lt;p>æˆ‘æ€»ç»“ä¸ªè›‹ã€‚&lt;/p></description></item><item><title>ä¸€äº›å±è¯ 2021å¹´11æœˆ4æ—¥</title><link>https://nnnewb.github.io/blog/p/2021-11-4-diary/</link><pubDate>Thu, 04 Nov 2021 16:06:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/2021-11-4-diary/</guid><description>&lt;h2 id="æ¯”çƒ‚">æ¯”çƒ‚&lt;/h2>
&lt;p>ä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™èµ·ï¼Œå¯¹ç°åœ¨çš„å·¥ä½œå¤±å»äº†æ¿€æƒ…ï¼Œè¿å¸¦ç€å¯¹ç”Ÿæ´»ä¹Ÿå¤±å»äº†æœŸå¾…ã€‚&lt;/p>
&lt;p>ä¸Šç­ä¸‹ç­ï¼Œä¾‹è¡Œå…¬äº‹ï¼Œåƒæ˜¯ä¸ªæœºå™¨äººã€‚è™½ç„¶ä¸€ç›´éƒ½æ˜¯è¿™æ ·ï¼Œä»æ¥æ²¡æœ‰å¥½è¿‡ã€‚&lt;/p>
&lt;p>ä¼¼ä¹ä¹Ÿä¸æ˜¯â€”â€”è‡³å°‘åœ¨peroperoå·¥ä½œçš„é‚£æ®µæ—¶é—´ï¼Œè¿˜æ˜¯æœ‰äº›å…´å¥‹çš„ã€‚åªæ˜¯ç¡®å®å„æ–¹é¢å¤šå°‘æœ‰äº›åˆä¸æ¥ï¼Œä½†ä¸ªäººåŸå› è¿˜æ˜¯å±…å¤šæ•°ã€‚æ¯•ç«Ÿå¤šå°‘å·²ç»æ‘¸çˆ¬æ»šæ‰“äº†å‡ å¹´ä¸‹æ¥ï¼Œä¸€å®šè¦è¯´å“ªä¸ªè€ä¸œå®¶å¾ˆå¥½æˆ–è€…å¾ˆå·®ï¼Œææ€•éƒ½ä¸åˆé€‚ã€‚&lt;/p>
&lt;p>æœ‰ä¼˜ç‚¹ä¹Ÿæœ‰ç¼ºç‚¹æ˜¯å¸¸æ€ï¼Œå†³å®šèƒ½ä¸èƒ½æŒç»­å¹²ä¸‹å»ï¼Œæœ€åè¿˜æ˜¯çœ‹èƒ½ä¸èƒ½å¿å—ç¼ºç‚¹ã€‚&lt;/p>
&lt;p>æ‰€ä»¥è¯´åˆ°åº•è¿˜æ˜¯æ¯”çƒ‚ï¼Œåˆ°åº•ä¸‡äº‹ä¸‡ç‰©è¿˜æ˜¯æ¯”çƒ‚ã€‚&lt;/p>
&lt;h2 id="åšäºº">åšäºº&lt;/h2>
&lt;p>ä¸€ä¸ªå¸¸å¸¸å‡ºç°åœ¨è„‘æµ·é‡Œçš„é—®é¢˜æ˜¯ï¼Œæˆ‘åº”è¯¥åšä»€ä¹ˆæ ·çš„äººï¼Ÿ&lt;/p>
&lt;p>ç„¶åå¿½ç„¶å°±æœ‰äº†ç­”æ¡ˆï¼Œé‚£å°±æ˜¯æˆ‘ä¸èƒ½å†³å®šè‡ªå·±æˆä¸ºä»€ä¹ˆæ ·çš„äººã€‚ç¯å¢ƒå¡‘é€ äººï¼Œç»å†å¡‘é€ äººï¼Œå”¯ç‹¬äººä¸èƒ½å¡‘é€ è‡ªå·±ï¼Œæ‰€ä»¥è¯´åšä»€ä¹ˆæ ·çš„äººå…¶å®æ˜¯ä¼ªå‘½é¢˜ã€‚&lt;/p>
&lt;p>è¿™ä¹ˆæƒ³æœ‰äº›æ‚²è§‚ï¼Œæ˜¯æœºæ¢°å†³å®šè®ºã€‚äººä¸€å‡ºç”Ÿå°±å·²ç»å†³å®šäº†å‘½è¿ï¼Œæ‰€æ€æ‰€æƒ³ï¼Œæ‚²æ¬¢ç¦»åˆï¼Œæ—©å·²ç»å†³å®šï¼Œç”Ÿå‘½å°±æ˜¯æ¦‚ç‡ä¹‹æµ·çš„å°æ°´èŠ±ï¼Œç”Ÿæˆ–æ­»éƒ½æ²¡æœ‰æ„ä¹‰ã€‚&lt;/p>
&lt;p>ä½†æ— è®ºå¦‚ä½•å§ï¼Œè‡³å°‘ï¼Œè¿˜å¾—æœ‰ä¸€ç‚¹å¿µæƒ³ï¼Ÿå‡è£…ä¸€åˆ‡éƒ½åœ¨æŒæ§ä¹‹ä¸­ï¼Œåƒæ˜¯æŠ“ä½æµªæ½®ä¸­çš„æµ®æœ¨ã€‚æ‰€ä»¥è¿˜æ˜¯å¾—æœ‰ä¸ªä»€ä¹ˆå¿µæƒ³ï¼Œè¦åšä¸€ä¸ªä»€ä¹ˆæ ·çš„äººã€‚&lt;/p>
&lt;p>æˆ‘æ€ä¹ˆæƒ³å‘¢ã€‚&lt;/p>
&lt;p>åšæ­£ç¡®çš„äº‹ï¼Œä¹Ÿè®¸ä¸æ­£ç¡®ï¼Œä¹Ÿè®¸ç°åœ¨ä»¥ä¸ºæ˜¯æ­£ç¡®ï¼Œå°†æ¥åˆè§‰å¾—ä¸æ­£ç¡®ã€‚è€Œå³ä¾¿æ˜¯è¿™æ ·ä¹Ÿåšä¸åˆ°ã€‚&lt;/p>
&lt;h2 id="æ—¶é—´">æ—¶é—´&lt;/h2>
&lt;p>ç°åœ¨æ˜¯2021å¹´11æœˆ4æ—¥ï¼Œ2021å¹´ä¹Ÿå¿«è¦è¿‡å»äº†ï¼Œå¤©æ°”è½¬å‡‰ã€‚&lt;/p>
&lt;p>ç°åœ¨æ€»ç»“ä¸€å¹´çš„å·¥ä½œæˆ–è€…ç”Ÿæ´»è¿˜æœ‰äº›å¤ªæ—©ï¼Œä½†å¦‚ä»Šå›å¤´çœ‹ï¼Œè¿™ä¸€å¹´ä¹Ÿå°±è¿™æ ·å§ã€‚&lt;/p>
&lt;p>äº‹ä¸šå‘å±•ï¼Œæ²¡æœ‰å˜åŒ–ã€‚&lt;/p>
&lt;p>äººç”Ÿå¤§äº‹ï¼Œæ²¡æœ‰è¿›å±•ã€‚&lt;/p>
&lt;p>å¥åº·ç”Ÿæ´»ï¼Ÿè¢«ç—›é£æŠ˜ç£¨ï¼Œå¤´å‘è‚‰çœ¼å¯è§åœ°å˜å¾—ç¨€ç–ï¼Œè¿˜å¥½å‘é™…çº¿æ²¡æœ‰å¤ªæ˜æ˜¾çš„ç§»åŠ¨ã€‚ç²¾åŠ›è™½ç„¶æœ‰äº›æ¶ˆé€€ï¼Œä½†å¹¶æ²¡æœ‰ä»€ä¹ˆå¦¨å®³ã€‚&lt;/p>
&lt;p>æƒ³è¦çœ‹çœ‹è¿˜æœ‰æ²¡æœ‰ä»€ä¹ˆæå‡çš„æœºä¼šï¼Œå‘ç°å›½å®¶åˆåœ¨æ•™æ”¹ï¼Œæˆäººå­¦å†æ•™è‚²æ˜å¹´å¤§æ¦‚åˆæœ‰ä»€ä¹ˆåŠ¨ä½œã€‚éšä¾¿ç¿»äº†ç¿»æ‹›ç”Ÿç®€ç« ï¼Œå°±çœ‹åˆ°å¯¹25å²ä»¥ä¸Šè€ƒç”Ÿå±…ç„¶æœ‰ä¼˜å¾…ã€‚&lt;/p>
&lt;p>å†ä¸€å¯¹è‡ªå·±çš„ï¼Œå“¦è±ï¼Œä¸ç”¨ç­‰æ˜å¹´ï¼Œä»Šå¹´12æœˆå°±æˆäº†è¢«ä¼˜å¾…çš„å¯¹è±¡äº†ã€‚&lt;/p>
&lt;p>å·²ç»å¿«è®°ä¸èµ·ä¸Šå­¦æ—¶çš„å…‰æ™¯äº†ï¼Œå¥½åƒæ‰€æœ‰ä¸œè¥¿éƒ½åœ¨é£å¿«åœ°è¿œç¦»ã€‚&lt;/p>
&lt;h2 id="å˜åŒ–">å˜åŒ–&lt;/h2>
&lt;p>æ—¶é—´ç»™äººå¸¦æ¥æœ€æ˜æ˜¾çš„å˜åŒ–å°±æ˜¯å†…æ•›ã€‚&lt;/p>
&lt;p>ä¸å†è½»æ˜“å–œæ‚¦ï¼Œä¹Ÿä¸å†è½»æ˜“åŠ¨æ€’ã€‚&lt;/p>
&lt;p>ä¸å…¶è¯´æ˜¯æ²‰ç¨³ï¼Œä¸å¦‚è¯´æ˜¯æ›´ç„¦è™‘äº†ï¼Œä¸ºèº«è¾¹çš„ä¸€åˆ‡äº‹æƒ…ç„¦è™‘ï¼Œä¸ºè‡ªå·±çš„èƒ½åŠ›æ€»æ˜¯æ‰è¥Ÿè§è‚˜ç„¦è™‘ã€‚è€Œååˆå®¹æ˜“æ”¾å¼ƒï¼Œå› ä¸ºæ€»å¿ä¸ä½å»å¯¹æ¯”å·²çŸ¥çš„æˆæœ¬å’ŒæœªçŸ¥çš„æ”¶ç›Šï¼Œåˆæˆ–è€…å› ä¸ºå„ç§å†…å¤–æ¡ä»¶å˜åŒ–è€Œä¸äº†äº†ä¹‹ã€‚&lt;/p>
&lt;p>æ˜çŸ¥é“æŠ±æ€¨æ²¡æœ‰æ„ä¹‰ï¼Œè¿˜æ˜¯å¿ä¸ä½æŠ±æ€¨ï¼Œæ¯å¤©éƒ½æœ‰å‘æ³„ä¸å®Œçš„æƒ…ç»ªã€‚&lt;/p>
&lt;h2 id="ç»ˆ">ç»ˆ&lt;/h2>
&lt;p>å†™äº†é‚£ä¹ˆå¤šå±è¯ï¼Œè¿˜æ˜¯è¦åˆ°è¿™é‡Œç»“æŸã€‚&lt;/p>
&lt;p>ç”Ÿæ´»è¿˜è¦ç»§ç»­ã€‚&lt;/p></description></item><item><title>åŠ å£³åŸç†08ï¼šæ··æ·†æŠ€æœ¯å…¥é—¨</title><link>https://nnnewb.github.io/blog/p/learning-packer-08/</link><pubDate>Wed, 03 Nov 2021 16:54:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/learning-packer-08/</guid><description>&lt;img src="https://nnnewb.github.io/blog/p/learning-packer-08/cover.jpg" alt="Featured image of post åŠ å£³åŸç†08ï¼šæ··æ·†æŠ€æœ¯å…¥é—¨" />&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>æœ¬ç¯‡å°è¯•å­¦ä¹ é€šè¿‡åŠ¨æ‰‹å†™ä¸€ä¸ª LLVM Pass æ¥å­¦ä¹ ç¼–è¯‘é˜¶æ®µè¿›è¡Œä»£ç æ··æ·†çš„æŠ€æœ¯ã€‚&lt;/p>
&lt;h2 id="0x01-ç¯å¢ƒè®¾ç½®">0x01 ç¯å¢ƒè®¾ç½®&lt;/h2>
&lt;p>LLVM æ˜¯ä¸ªç›¸å½“å¤§çš„é¡¹ç›®ï¼Œåšå¥½ç¯å¢ƒè®¾ç½®æ˜¯é¦–å…ˆè¦åšçš„äº‹æƒ…ã€‚è¿™é‡Œé€‰æ‹© msys2 ä½œä¸ºé¦–è¦å¼€å‘ç¯å¢ƒï¼Œä¸ç„¶å…‰æ˜¯ MSVC æŠŠ LLVM æºç ç¼–è¯‘ä¸€éå°±å¤Ÿå‘›äº†ã€‚&lt;/p>
&lt;p>å®‰è£…å¥½MSYS2ä¹‹åå®‰è£… clang å·¥å…·é“¾ï¼ˆ2021å¹´11æœˆ3æ—¥ï¼Œclang32å·¥å…·é“¾é»˜è®¤ä¸åœ¨msys2çš„æºé‡Œï¼Œéœ€è¦æ‰‹åŠ¨æ”¹ &lt;code>pacman.conf&lt;/code> åŠ å…¥ &lt;code>clang32&lt;/code> æºï¼Œè¿™é‡Œä»¥ x86_64 çš„ LLVM å·¥å…·é“¾è¿›è¡Œå®è·µï¼‰ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">pacman -Sy mingw-w64-clang-x86_64-toolchain
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å®Œæˆåæ·»åŠ ç¯å¢ƒå˜é‡ï¼ŒæŠŠ msys2 å®‰è£…ç›®å½•ä¸‹çš„ &lt;code>clang64/bin&lt;/code> åŠ å…¥ç¯å¢ƒå˜é‡ï¼Œæ–¹ä¾¿ VSCode + CMake æ‰¾åˆ°å·¥å…·é“¾ã€‚å¦å¤–æ³¨æ„è£…ä¸€ä¸ª Ninjaï¼ŒåŒæ ·åŠ å…¥ Pathã€‚&lt;/p>
&lt;p>VSCode é‡Œè£…ä¸Šå¾®è½¯çš„ C/C++ å’Œ clangdï¼Œç¦ç”¨å¾®è½¯ C/C++ çš„ Intellisenseï¼Œå®åœ¨å¤ªæ…¢ã€‚&lt;/p>
&lt;p>æ‰‹åŠ¨ç¼–è¯‘æ•´ä¸ªLLVMæºç æ ‘å®åœ¨æ˜¯å¤ªè´¹æ—¶é—´äº†ï¼Œæˆ‘é€‰æ‹©ç”¨MSYS2çš„å·¥å…·é“¾ã€‚å‚è€ƒè¿™ç¯‡æ–‡æ¡£å»é…ç½®ä¸€ä¸ª LLVM æºç æ ‘å¤–çš„ Pass å·¥ç¨‹ï¼š&lt;a class="link" href="https://llvm.org/docs/CMake.html#cmake-out-of-source-pass" target="_blank" rel="noopener"
>CMake out of source pass - LLVM&lt;/a> ã€‚å†™ä¸€ä¸ªç®€å•çš„ CMakeLists.txt ï¼Œè·Ÿç€ &lt;a class="link" href="https://llvm.org/docs/WritingAnLLVMPass.html" target="_blank" rel="noopener"
>Writing an LLVM Pass - LLVM&lt;/a> è¿™ç¯‡æ–‡æ¡£å¿«é€Ÿå®ç°ä¸€ä¸ªéå†å‡½æ•°çš„ Pass ã€‚&lt;/p>
&lt;p>ä¸‹é¢æ˜¯ &lt;code>CMakeLists.txt&lt;/code> çš„å†…å®¹&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-cmake" data-lang="cmake">&lt;span class="nb">cmake_minimum_required&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">VERSION&lt;/span> &lt;span class="s">3.13.4&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="nb">project&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">Hello&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="nb">find_package&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">LLVM&lt;/span> &lt;span class="s">REQUIRED&lt;/span> &lt;span class="s">CONFIG&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="nb">message&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">STATUS&lt;/span> &lt;span class="s2">&amp;#34;Found LLVM ${LLVM_PACKAGE_VERSION}&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="nb">message&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">STATUS&lt;/span> &lt;span class="s2">&amp;#34;Using LLVMConfig.cmake in: ${LLVM_DIR}&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="nb">include_directories&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">${&lt;/span>&lt;span class="nv">LLVM_INCLUDE_DIRS&lt;/span>&lt;span class="o">}&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="nb">separate_arguments&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">LLVM_DEFINITIONS_LIST&lt;/span> &lt;span class="s">NATIVE_COMMAND&lt;/span> &lt;span class="o">${&lt;/span>&lt;span class="nv">LLVM_DEFINITIONS&lt;/span>&lt;span class="o">}&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="nb">add_definitions&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">${&lt;/span>&lt;span class="nv">LLVM_DEFINITIONS_LIST&lt;/span>&lt;span class="o">}&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="nb">list&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">APPEND&lt;/span> &lt;span class="s">CMAKE_MODULE_PATH&lt;/span> &lt;span class="s2">&amp;#34;${LLVM_CMAKE_DIR}&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="nb">include&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">AddLLVM&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="nb">add_llvm_library&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">Hello&lt;/span> &lt;span class="s">MODULE&lt;/span> &lt;span class="s">hello.cpp&lt;/span> &lt;span class="s">PLUGIN_TOOL&lt;/span> &lt;span class="s">opt&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶åæ˜¯å®ç° pass çš„æºç ï¼Œæºç çš„è¯¦ç»†è§£é‡Šç›´æ¥è¯» LLVM ç»™çš„æ–‡æ¡£ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;#34;llvm/IR/Function.h&amp;#34;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;#34;llvm/IR/LegacyPassManager.h&amp;#34;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;#34;llvm/Pass.h&amp;#34;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;#34;llvm/Support/raw_ostream.h&amp;#34;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;#34;llvm/Transforms/IPO/PassManagerBuilder.h&amp;#34;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="k">using&lt;/span> &lt;span class="k">namespace&lt;/span> &lt;span class="n">llvm&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">namespace&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">struct&lt;/span> &lt;span class="nc">Hello&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="k">public&lt;/span> &lt;span class="n">FunctionPass&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">static&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="n">ID&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">Hello&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="n">FunctionPass&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ID&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;span class="kt">bool&lt;/span> &lt;span class="nf">runOnFunction&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Function&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">F&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">override&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">errs&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34;Hello:&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">errs&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="n">write_escaped&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">F&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getName&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">false&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">};&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="c1">// namespace
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="kt">char&lt;/span> &lt;span class="n">Hello&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">ID&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">static&lt;/span> &lt;span class="n">RegisterPass&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Hello&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">X&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hello&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;hello world pass&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">false&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">false&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">static&lt;/span> &lt;span class="n">RegisterStandardPasses&lt;/span> &lt;span class="nf">Y&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">PassManagerBuilder&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">EP_EarlyAsPossible&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">[](&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="n">PassManagerBuilder&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">builder&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">legacy&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">PassManagerBase&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">pm&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">pm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">Hello&lt;/span>&lt;span class="p">());&lt;/span>
&lt;span class="p">});&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å†å‡†å¤‡ä¸€ä¸ªç®€å•çš„æ ·æœ¬ï¼Œç”¨æ¥å®éªŒ Pass çš„æ•ˆæœã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdio.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hello world&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¥ç€æ˜¯å®éªŒæ­¥éª¤ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">clang -O3 -emit-llvm sample.c -c -o sample.bc
opt -enable-new-pm&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> -load build/hello.dll -hello sample.bc -o sample.exe
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">Hello:main
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸é¡ºåˆ©çš„è¯åªèƒ½è‡ªå·±è°·æ­Œã€‚&lt;/p>
&lt;h2 id="0x02-ollvm-bcf-æ··æ·†åˆçª¥">0x02 OLLVM bcf æ··æ·†åˆçª¥&lt;/h2>
&lt;p>è¿™éƒ¨åˆ†å…ˆçœ‹çœ‹çŸ¥åçš„ OLLVM é¡¹ç›®æ˜¯æ€ä¹ˆåšçš„ï¼Œå…ˆçœ‹ &lt;em>bcf&lt;/em> æ··æ·†ï¼Œæºç åœ¨ &lt;code>llvm/lib/Transforms/Obfuscation/BogusControlFlow.cpp&lt;/code>ï¼Œ å…¥å£åœ¨ &lt;code>runOnFunction&lt;/code> å‡½æ•°ã€‚&lt;/p>
&lt;h3 id="21-runonfunction">2.1 runOnFunction&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-cpp" data-lang="cpp"> &lt;span class="cm">/* runOnFunction
&lt;/span>&lt;span class="cm"> *
&lt;/span>&lt;span class="cm"> * Overwrite FunctionPass method to apply the transformation
&lt;/span>&lt;span class="cm"> * to the function. See header for more details.
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="k">virtual&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="nf">runOnFunction&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Function&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">F&lt;/span>&lt;span class="p">){&lt;/span>
&lt;span class="c1">// Check if the percentage is correct
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">ObfTimes&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">errs&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">&amp;lt;&amp;lt;&lt;/span>&lt;span class="s">&amp;#34;BogusControlFlow application number -bcf_loop=x must be x &amp;gt; 0&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">false&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Check if the number of applications is correct
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span> &lt;span class="o">!&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">ObfProbRate&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">ObfProbRate&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">errs&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">&amp;lt;&amp;lt;&lt;/span>&lt;span class="s">&amp;#34;BogusControlFlow application basic blocks percentage -bcf_prob=x must be 0 &amp;lt; x &amp;lt;= 100&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">false&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// If fla annotations
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">toObfuscate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">flag&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">F&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s">&amp;#34;bcf&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">isInvoke&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">F&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">bogus&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">F&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">doF&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">F&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getParent&lt;/span>&lt;span class="p">());&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">true&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">false&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="c1">// end of runOnFunction()
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å‰ä¸¤ä¸ª &lt;code>if&lt;/code> éƒ½æ˜¯åœ¨åˆ¤æ–­å‚æ•°ï¼Œå…ˆå¿½ç•¥ã€‚&lt;code>if(toObfuscate(flag,&amp;amp;F,&amp;quot;bcf&amp;quot;))&lt;/code> åˆ¤æ–­æ˜¯å¦æ˜¯å¦éœ€è¦æ··æ·†ï¼Œ&lt;code>if (isInvoke(&amp;amp;F))&lt;/code> åˆ¤æ–­èƒ½å¦æ··æ·†ã€‚&lt;/p>
&lt;p>çœŸæ­£çš„æ··æ·†é€»è¾‘åœ¨ &lt;code>bogus(F)&lt;/code> é‡Œã€‚&lt;/p>
&lt;h3 id="22-bogus">2.2 bogus&lt;/h3>
&lt;p>è£å‰ªæ‰äº†è°ƒè¯•è¾“å‡ºåçš„ &lt;code>bogus&lt;/code> å‡½æ•°å†…å®¹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="kt">void&lt;/span> &lt;span class="nf">bogus&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Function&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">F&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// For statistics and debug
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">NumFunction&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">NumBasicBlocks&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kt">bool&lt;/span> &lt;span class="n">firstTime&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">true&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// First time we do the loop in this function
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="n">NumTimesOnFunctions&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ObfTimes&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">NumObfTimes&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ObfTimes&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// Real begining of the pass
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// Loop for the number of time we run the pass on the function
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Put all the function&amp;#39;s block in a list
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">list&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">BasicBlock&lt;/span> &lt;span class="o">*&amp;gt;&lt;/span> &lt;span class="n">basicBlocks&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">Function&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">iterator&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">F&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">begin&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">F&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">end&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">basicBlocks&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">push_back&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;*&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">basicBlocks&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">empty&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">NumBasicBlocks&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// Basic Blocks&amp;#39; selection
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">llvm&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">cryptoutils&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">get_range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">100&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="n">ObfProbRate&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">++&lt;/span>&lt;span class="n">NumModifiedBasicBlocks&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">NumAddedBasicBlocks&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">FinalNumBasicBlocks&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// Add bogus flow to the given Basic Block (see description)
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">BasicBlock&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">basicBlock&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">basicBlocks&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">front&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="n">addBogusFlow&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">basicBlock&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">F&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// remove the block from the list
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">basicBlocks&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">pop_front&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">firstTime&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// first time we iterate on this function
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">InitNumBasicBlocks&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="o">++&lt;/span>&lt;span class="n">FinalNumBasicBlocks&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="c1">// end of while(!basicBlocks.empty())
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="n">firstTime&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">false&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">--&lt;/span>&lt;span class="n">NumObfTimes&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å°è¯•åˆ†æä¸Šé¢çš„å‡½æ•°é€»è¾‘ï¼š&lt;/p>
&lt;ol>
&lt;li>å¾ªç¯æ··æ·†ä¸€å®šæ¬¡æ•°ï¼ˆ&lt;code>NumObfTimes&lt;/code>ï¼‰
&lt;ol>
&lt;li>éå†åŸå‡½æ•°åŸºæœ¬å—ï¼ˆ&lt;code>basicBlocks&lt;/code>ï¼‰
&lt;ol>
&lt;li>é€‰æ‹©åŸºæœ¬å—ï¼ˆ&lt;code>cryptoutils-&amp;gt;get_range(100) &amp;lt;= ObfProbRate&lt;/code>ï¼‰
&lt;ol>
&lt;li>å„ç§è®¡æ•°è‡ªå¢&lt;/li>
&lt;li>æ·»åŠ ä¼ªé€ æ§åˆ¶æµï¼ˆ&lt;code>addBogusFlow(basicBlock, F)&lt;/code>ï¼‰&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ol>
&lt;p>æ··æ·†æ¬¡æ•°å’ŒåŸºæœ¬å—éå†æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œé€‰æ‹©åŸºæœ¬å—è¿™é‡Œï¼Œ&lt;code>get_range(100)&lt;/code> å®é™…ä¸Šæ˜¯ä¸€ä¸ªå®‰å…¨çš„éšæœºæ•°ç”Ÿæˆå™¨ï¼Œ&lt;code>ObfProbRate&lt;/code> æ˜¯åŸºæœ¬å—è¢«æ··æ·†çš„æœºç‡ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªå‡½æ•°å†…çš„åŸºæœ¬å—æ˜¯éšæœºè¢«æ··æ·†çš„ï¼ŒåŠ ä¸Šæ··æ·†æ¬¡æ•°çš„è®¾è®¡ï¼Œä¼šå‡ºç°æœ‰çš„åŸºæœ¬å—è¢«æ··æ·†å¤šæ¬¡æœ‰çš„æ²¡æœ‰è¢«æ··æ·†çš„æƒ…å†µã€‚&lt;/p>
&lt;h3 id="22-addbogusflow">2.2 addBogusFlow&lt;/h3>
&lt;p>æ¥ç€ç»§ç»­çœ‹æ·»åŠ ä¼ªé€ æ§åˆ¶æµçš„é€»è¾‘ï¼ŒåŒæ ·è£å‰ªæ‰äº†è°ƒè¯•è¾“å‡ºã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="cm">/* addBogusFlow
&lt;/span>&lt;span class="cm"> *
&lt;/span>&lt;span class="cm"> * Add bogus flow to a given basic block, according to the header&amp;#39;s description
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="k">virtual&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">addBogusFlow&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">BasicBlock&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">basicBlock&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Function&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">F&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Split the block: first part with only the phi nodes and debug info and terminator
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// created by splitBasicBlock. (-&amp;gt; No instruction)
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// Second part with every instructions from the original block
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// We do this way, so we don&amp;#39;t have to adjust all the phi nodes, metadatas and so on
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// for the first block. We have to let the phi nodes in the first part, because they
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// actually are updated in the second part according to them.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">BasicBlock&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">iterator&lt;/span> &lt;span class="n">i1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">basicBlock&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">begin&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">basicBlock&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getFirstNonPHIOrDbgOrLifetime&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="n">i1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">BasicBlock&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">iterator&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">basicBlock&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getFirstNonPHIOrDbgOrLifetime&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="n">Twine&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">var&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">var&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Twine&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;originalBB&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">BasicBlock&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">originalBB&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">basicBlock&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">splitBasicBlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">var&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// Creating the altered basic block on which the first basicBlock will jump
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">Twine&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">var3&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Twine&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;alteredBB&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">BasicBlock&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">alteredBB&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">createAlteredBasicBlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">originalBB&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">var3&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">F&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// Now that all the blocks are created,
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// we modify the terminators to adjust the control flow.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">alteredBB&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getTerminator&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">eraseFromParent&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="n">basicBlock&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getTerminator&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">eraseFromParent&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="c1">// Preparing a condition..
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// For now, the condition is an always true comparaison between 2 float
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// This will be complicated after the pass (in doFinalization())
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">Value&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">LHS&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ConstantFP&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Type&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">getFloatTy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">F&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getContext&lt;/span>&lt;span class="p">()),&lt;/span> &lt;span class="mf">1.0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">Value&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">RHS&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ConstantFP&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Type&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">getFloatTy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">F&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getContext&lt;/span>&lt;span class="p">()),&lt;/span> &lt;span class="mf">1.0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// The always true condition. End of the first block
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">Twine&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">var4&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Twine&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;condition&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">FCmpInst&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">condition&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">FCmpInst&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">basicBlock&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">FCmpInst&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">FCMP_TRUE&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">LHS&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">RHS&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">var4&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// Jump to the original basic block if the condition is true or
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// to the altered block if false.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">BranchInst&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">Create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">originalBB&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">alteredBB&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">Value&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">condition&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">basicBlock&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// The altered block loop back on the original one.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">BranchInst&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">Create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">originalBB&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">alteredBB&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// The end of the originalBB is modified to give the impression that sometimes
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// it continues in the loop, and sometimes it return the desired value
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// (of course it&amp;#39;s always true, so it always use the original terminator..
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// but this will be obfuscated too;) )
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// iterate on instruction just before the terminator of the originalBB
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">BasicBlock&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">iterator&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">originalBB&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">end&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="c1">// Split at this point (we only want the terminator in the second part)
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">Twine&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">var5&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Twine&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;originalBBpart2&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">BasicBlock&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">originalBBpart2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">originalBB&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">splitBasicBlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">--&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">var5&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// the first part go either on the return statement or on the begining
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// of the altered block.. So we erase the terminator created when splitting.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">originalBB&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getTerminator&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">eraseFromParent&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="c1">// We add at the end a new always true condition
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">Twine&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">var6&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Twine&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;condition2&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">FCmpInst&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">condition2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">FCmpInst&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">originalBB&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">CmpInst&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">FCMP_TRUE&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">LHS&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">RHS&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">var6&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">BranchInst&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">Create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">originalBBpart2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">alteredBB&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">Value&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">condition2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">originalBB&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="c1">// end of addBogusFlow()
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å°è¯•åˆ†æä¸Šé¢çš„å‡½æ•°é€»è¾‘ï¼š&lt;/p>
&lt;ol>
&lt;li>åˆ†å‰²åŸºæœ¬å—ï¼ŒæŠŠ &lt;code>phinode&lt;/code> å’Œè°ƒè¯•ä¿¡æ¯ä¹‹ç±»çš„åˆ†å‰²åˆ°åŸå§‹å—ï¼Œæ–°åˆ›å»ºå‡ºæ¥çš„å—ä¸åŒ…å« &lt;code>phinode&lt;/code> ä¹‹ç±»çš„ä¸œè¥¿ã€‚ï¼ˆ&lt;code>entry&lt;/code>ï¼‰&lt;/li>
&lt;li>åˆ›å»ºä¼ªé€ åˆ†æ”¯ã€‚ï¼ˆ&lt;code>altered&lt;/code>ï¼‰&lt;/li>
&lt;li>åˆ›å»ºæ’çœŸæ¡ä»¶ï¼Œè¿™é‡Œæ˜¯åˆ©ç”¨æµ®ç‚¹æ¯”è¾ƒ &lt;code>FCMP_TRUE&lt;/code>ã€‚ï¼ˆ&lt;code>condition&lt;/code>ï¼‰&lt;/li>
&lt;li>åˆ›å»ºåˆ†æ”¯æŒ‡ä»¤ï¼ŒçœŸè·³è½¬åŸå§‹å—ï¼Œå‡è·³è½¬ä¼ªé€ å—ï¼Œä¼ªé€ å—çš„æœ«å°¾åˆè·³å›åŸå§‹å—ã€‚&lt;/li>
&lt;li>åœ¨åŸå§‹å—çš„ç»“æŸéƒ¨åˆ†å†æ¬¡åˆ†å‰²åŸºæœ¬å—ï¼Œåˆ†å‰²åçš„å—åŒ…å«åŸå§‹å—çš„ terminator ï¼ˆ&lt;code>terminator&lt;/code>ï¼‰&lt;/li>
&lt;li>åˆ›å»ºä¸€ä¸ªæ’çœŸæ¡ä»¶ï¼Œè·³è½¬åˆ°åŸå§‹å—çš„ terminatorï¼Œå‡åˆ™è·³è½¬åˆ°ä¼ªé€ å— ï¼ˆ&lt;code>condition2&lt;/code>ï¼‰&lt;/li>
&lt;/ol>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 67;
flex-basis: 161px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/learning-packer-08/image-20211102160422737.png" data-size="435x648">
&lt;img src="https://nnnewb.github.io/blog/blog/p/learning-packer-08/image-20211102160422737.png"
width="435"
height="648"
srcset="https://nnnewb.github.io/blog/blog/p/learning-packer-08/image-20211102160422737_hu1adf2e2db9eba618ac02ebe93739a09a_98722_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/learning-packer-08/image-20211102160422737_hu1adf2e2db9eba618ac02ebe93739a09a_98722_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211102160422737">
&lt;/a>
&lt;figcaption>image-20211102160422737&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æ··æ·†åçš„æ§åˆ¶æµé•¿è¿™æ ·ï¼Œä¸¤ä¸ª condition éƒ½æ˜¯æ’çœŸæ¡ä»¶ï¼ŒåŸå§‹å—è¢«åˆ†æˆäº†ä¸‰ä¸ªéƒ¨åˆ†ï¼Œ&lt;code>entry&lt;/code>ã€&lt;code>origin&lt;/code>ã€&lt;code>terminator&lt;/code> ã€‚å›¾ä¸­çº¢è‰²çš„éƒ¨åˆ†æ˜¯ä¼ªé€ å—ï¼ŒåŒ…å«åƒåœ¾æŒ‡ä»¤ï¼Œç»¿è‰²çš„æ¡ä»¶å—éƒ½æ˜¯æ’çœŸæ¡ä»¶ï¼Œåªæœ‰ç»¿è‰²ç®­å¤´çš„æ§åˆ¶æµèƒ½èµ°é€šã€‚è“è‰²èŠ‚ç‚¹æ˜¯ä»åŸå§‹åŸºæœ¬å—ä¸Šåˆ†å‰²å‡ºæ¥çš„éƒ¨åˆ†ã€‚&lt;/p>
&lt;h3 id="23-createalteredbasicblock">2.3 createAlteredBasicBlock&lt;/h3>
&lt;p>å†çœ‹ä¼ªé€ å—æ˜¯å¦‚ä½•ç”Ÿæˆçš„ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++"> &lt;span class="cm">/* createAlteredBasicBlock
&lt;/span>&lt;span class="cm"> *
&lt;/span>&lt;span class="cm"> * This function return a basic block similar to a given one.
&lt;/span>&lt;span class="cm"> * It&amp;#39;s inserted just after the given basic block.
&lt;/span>&lt;span class="cm"> * The instructions are similar but junk instructions are added between
&lt;/span>&lt;span class="cm"> * the cloned one. The cloned instructions&amp;#39; phi nodes, metadatas, uses and
&lt;/span>&lt;span class="cm"> * debug locations are adjusted to fit in the cloned basic block and
&lt;/span>&lt;span class="cm"> * behave nicely.
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="k">virtual&lt;/span> &lt;span class="n">BasicBlock&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nf">createAlteredBasicBlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">BasicBlock&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">basicBlock&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="n">Twine&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">Name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;gen&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Function&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">F&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Useful to remap the informations concerning instructions.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">ValueToValueMapTy&lt;/span> &lt;span class="n">VMap&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">BasicBlock&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">alteredBB&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">llvm&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">CloneBasicBlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">basicBlock&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">VMap&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">F&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// Remap operands.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">BasicBlock&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">iterator&lt;/span> &lt;span class="n">ji&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">basicBlock&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">begin&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">BasicBlock&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">iterator&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">alteredBB&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">begin&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="n">e&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">alteredBB&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">end&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Loop over the operands of the instruction
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">User&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">op_iterator&lt;/span> &lt;span class="n">opi&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">op_begin&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="n">ope&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">op_end&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="n">opi&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">ope&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">opi&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// get the value for the operand
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">Value&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">MapValue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">opi&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">VMap&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">RF_None&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">*&lt;/span>&lt;span class="n">opi&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">v&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Remap phi nodes&amp;#39; incoming blocks.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">PHINode&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">pn&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">dyn_cast&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">PHINode&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">unsigned&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">e&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">pn&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getNumIncomingValues&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">Value&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">MapValue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pn&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getIncomingBlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">VMap&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">RF_None&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">pn&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">setIncomingBlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">cast&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">BasicBlock&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">v&lt;/span>&lt;span class="p">));&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Remap attached metadata.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">SmallVector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">pair&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">unsigned&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MDNode&lt;/span> &lt;span class="o">*&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">MDs&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">i&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getAllMetadata&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">MDs&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// important for compiling with DWARF, using option -g.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">setDebugLoc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ji&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getDebugLoc&lt;/span>&lt;span class="p">());&lt;/span>
&lt;span class="n">ji&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="c1">// The instructions&amp;#39; informations are now all correct
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// add random instruction in the middle of the bloc. This part can be improve
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">BasicBlock&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">iterator&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">alteredBB&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">begin&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="n">e&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">alteredBB&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">end&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// in the case we find binary operator, we modify slightly this part by randomly
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// insert some instructions
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">isBinaryOp&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// binary instructions
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">unsigned&lt;/span> &lt;span class="n">opcode&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getOpcode&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="n">BinaryOperator&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">op&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">op1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">UnaryOperator&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">op2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">Twine&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">var&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Twine&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;_&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// treat differently float or int
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// Binary int
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">opcode&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">Instruction&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">Add&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">opcode&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">Instruction&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">Sub&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">opcode&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">Instruction&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">Mul&lt;/span> &lt;span class="o">||&lt;/span>
&lt;span class="n">opcode&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">Instruction&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">UDiv&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">opcode&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">Instruction&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">SDiv&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">opcode&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">Instruction&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">URem&lt;/span> &lt;span class="o">||&lt;/span>
&lt;span class="n">opcode&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">Instruction&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">SRem&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">opcode&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">Instruction&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">Shl&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">opcode&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">Instruction&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">LShr&lt;/span> &lt;span class="o">||&lt;/span>
&lt;span class="n">opcode&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">Instruction&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">AShr&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">opcode&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">Instruction&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">And&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">opcode&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">Instruction&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">Or&lt;/span> &lt;span class="o">||&lt;/span>
&lt;span class="n">opcode&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">Instruction&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">Xor&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">random&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">llvm&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">cryptoutils&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">get_range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="n">random&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">random&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">llvm&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">cryptoutils&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">get_range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// to improve
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="c1">// do nothing
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">op&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">BinaryOperator&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">CreateNeg&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getOperand&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">var&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;*&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">op1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">BinaryOperator&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">Create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Instruction&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">Add&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">op&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getOperand&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="s">&amp;#34;gen&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;*&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">op1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">BinaryOperator&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">Create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Instruction&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">Sub&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getOperand&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getOperand&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">var&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;*&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">op&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">BinaryOperator&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">Create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Instruction&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">Mul&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">op1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getOperand&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="s">&amp;#34;gen&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;*&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">op&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">BinaryOperator&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">Create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Instruction&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">Shl&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getOperand&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getOperand&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">var&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;*&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Binary float
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">opcode&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">Instruction&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">FAdd&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">opcode&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">Instruction&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">FSub&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">opcode&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">Instruction&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">FMul&lt;/span> &lt;span class="o">||&lt;/span>
&lt;span class="n">opcode&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">Instruction&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">FDiv&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">opcode&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">Instruction&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">FRem&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">random&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">llvm&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">cryptoutils&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">get_range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="n">random&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">random&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">llvm&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">cryptoutils&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">get_range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// can be improved
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="c1">// do nothing
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">op2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">UnaryOperator&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">CreateFNeg&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getOperand&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">var&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;*&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">op1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">BinaryOperator&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">Create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Instruction&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">FAdd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">op2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getOperand&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="s">&amp;#34;gen&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;*&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">op&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">BinaryOperator&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">Create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Instruction&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">FSub&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getOperand&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getOperand&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">var&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;*&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">op1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">BinaryOperator&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">Create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Instruction&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">FMul&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">op&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getOperand&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="s">&amp;#34;gen&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;*&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">opcode&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">Instruction&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">ICmp&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// Condition (with int)
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">ICmpInst&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">currentI&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">ICmpInst&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">llvm&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">cryptoutils&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">get_range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// must be improved
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="c1">// do nothing
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">currentI&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">swapOperands&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="c1">// randomly change the predicate
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">switch&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">llvm&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">cryptoutils&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">get_range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">currentI&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">setPredicate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ICmpInst&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">ICMP_EQ&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// equal
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">currentI&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">setPredicate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ICmpInst&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">ICMP_NE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// not equal
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">currentI&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">setPredicate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ICmpInst&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">ICMP_UGT&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// unsigned greater than
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">currentI&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">setPredicate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ICmpInst&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">ICMP_UGE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// unsigned greater or equal
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">currentI&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">setPredicate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ICmpInst&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">ICMP_ULT&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// unsigned less than
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">currentI&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">setPredicate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ICmpInst&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">ICMP_ULE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// unsigned less or equal
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="mi">6&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">currentI&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">setPredicate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ICmpInst&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">ICMP_SGT&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// signed greater than
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="mi">7&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">currentI&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">setPredicate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ICmpInst&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">ICMP_SGE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// signed greater or equal
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">currentI&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">setPredicate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ICmpInst&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">ICMP_SLT&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// signed less than
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="mi">9&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">currentI&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">setPredicate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ICmpInst&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">ICMP_SLE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// signed less or equal
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">opcode&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">Instruction&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">FCmp&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// Conditions (with float)
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">FCmpInst&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">currentI&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">FCmpInst&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">llvm&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">cryptoutils&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">get_range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// must be improved
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="c1">// do nothing
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">currentI&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">swapOperands&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="c1">// randomly change the predicate
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">switch&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">llvm&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">cryptoutils&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">get_range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">currentI&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">setPredicate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">FCmpInst&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">FCMP_OEQ&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// ordered and equal
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">currentI&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">setPredicate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">FCmpInst&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">FCMP_ONE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// ordered and operands are unequal
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">currentI&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">setPredicate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">FCmpInst&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">FCMP_UGT&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// unordered or greater than
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">currentI&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">setPredicate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">FCmpInst&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">FCMP_UGE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// unordered, or greater than, or equal
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">currentI&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">setPredicate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">FCmpInst&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">FCMP_ULT&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// unordered or less than
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">currentI&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">setPredicate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">FCmpInst&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">FCMP_ULE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// unordered, or less than, or equal
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="mi">6&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">currentI&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">setPredicate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">FCmpInst&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">FCMP_OGT&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// ordered and greater than
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="mi">7&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">currentI&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">setPredicate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">FCmpInst&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">FCMP_OGE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// ordered and greater than or equal
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">currentI&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">setPredicate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">FCmpInst&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">FCMP_OLT&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// ordered and less than
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="mi">9&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">currentI&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">setPredicate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">FCmpInst&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">FCMP_OLE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// ordered or less than, or equal
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">alteredBB&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="c1">// end of createAlteredBasicBlock()
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸»è¦æ˜¯åˆ†ä¸¤éƒ¨åˆ†ï¼š&lt;/p>
&lt;ol>
&lt;li>å¤åˆ¶åŸå§‹å—ï¼Œå¹¶ä¿®å¤ä¼ªé€ å—çš„è°ƒè¯•ä¿¡æ¯ä¸å…ƒæ•°æ®&lt;/li>
&lt;li>åœ¨ä¼ªé€ å—ä¸­å¯»æ‰¾äºŒå…ƒè¿ç®—ã€æµ®ç‚¹è¿ç®—ã€æ¯”è¾ƒæŒ‡ä»¤ï¼Œåœ¨å…¶ä¸­æ’å…¥åƒåœ¾æŒ‡ä»¤ã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="0x03-åˆ›å»ºè‡ªå·±çš„æ··æ·†">0x03 åˆ›å»ºè‡ªå·±çš„æ··æ·†&lt;/h2>
&lt;p>å¯¹ OLLVM çš„ bcf æ··æ·†æœ‰äº†åˆæ­¥çš„æ˜ åƒä¹‹åï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥ä¾æ ·ç”»è‘«èŠ¦æŠ„ä¸€ä¸ªè‡ªå·±çš„æ··æ·†å‡ºæ¥å•¦ã€‚&lt;/p>
&lt;h3 id="31-æ–¹æ¡ˆ">3.1 æ–¹æ¡ˆ&lt;/h3>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 131;
flex-basis: 315px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/learning-packer-08/image-20211103105527721.png" data-size="953x726">
&lt;img src="https://nnnewb.github.io/blog/blog/p/learning-packer-08/image-20211103105527721.png"
width="953"
height="726"
srcset="https://nnnewb.github.io/blog/blog/p/learning-packer-08/image-20211103105527721_huf9cff02c3a79573b2f021a9808299ab4_137978_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/learning-packer-08/image-20211103105527721_huf9cff02c3a79573b2f021a9808299ab4_137978_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211103105527721">
&lt;/a>
&lt;figcaption>image-20211103105527721&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>ä½œä¸ºæ¦‚å¿µéªŒè¯ï¼Œæˆ‘ä»¬çš„ pass å°†åŸå§‹ä»£ç åˆ†å‰²æˆä¸‰ä¸ªåŸºæœ¬å—ï¼Œç§°ä¸º &lt;code>entry&lt;/code>ã€&lt;code>original&lt;/code>å’Œ&lt;code>terminator&lt;/code>ã€‚&lt;code>entry&lt;/code> é€šè¿‡ä¸€ä¸ªæ’çœŸåˆ¤æ–­è·³è½¬è‡³ &lt;code>original&lt;/code>ï¼Œ&lt;code>original&lt;/code> é€šè¿‡æ’çœŸåˆ¤æ–­è·³è½¬è‡³ &lt;code>terminator&lt;/code>ã€‚ä¼ªé€ å— &lt;code>altered&lt;/code> åˆ™æ˜¯ false åˆ†æ”¯ï¼Œå†…å®¹ä»…å¤åˆ¶ &lt;code>original&lt;/code> å—ï¼Œå¹¶åœ¨æœ«å°¾è·³è½¬è‡³ &lt;code>original&lt;/code> å—ã€‚&lt;/p>
&lt;p>ä¼ªé€ å—åº”è¯¥æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œã€‚&lt;/p>
&lt;h3 id="32-llvmç¼–ç¨‹çš„é‡è¦æ¦‚å¿µ">3.2 LLVMç¼–ç¨‹çš„é‡è¦æ¦‚å¿µ&lt;/h3>
&lt;p>å‚è€ƒæ–‡ç« ï¼š&lt;a class="link" href="https://mukulrathi.com/create-your-own-programming-language/llvm-ir-cpp-api-tutorial/" target="_blank" rel="noopener"
>LLVM IR C++ API Tutorial&lt;/a>&lt;/p>
&lt;h4 id="å…³é”®ç±»å‹">å…³é”®ç±»å‹ï¼š&lt;/h4>
&lt;p>æ¸…å•å¦‚ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>Value&lt;/code>&lt;/li>
&lt;li>&lt;code>Module&lt;/code>&lt;/li>
&lt;li>&lt;code>Type&lt;/code>&lt;/li>
&lt;li>&lt;code>Function&lt;/code>&lt;/li>
&lt;li>&lt;code>BasicBlock&lt;/code>&lt;/li>
&lt;li>&lt;code>BranchInst&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>åˆ—å‡ºçš„è¿™äº›æ˜¯ LLVM C++ æ¥å£å®šä¹‰çš„ç±»ï¼Œå¯ä»¥é€šè¿‡ &lt;code>Module&lt;/code> è·å– &lt;code>Function&lt;/code>ï¼Œå¯ä»¥ä» &lt;code>Function&lt;/code> è·å– &lt;code>BasicBlock&lt;/code>ï¼Œä¹Ÿå¯ä»¥ä» &lt;code>BasicBlock&lt;/code> åè¿‡æ¥è·å– &lt;code>Function&lt;/code>ï¼Œè¿™äº›å®¹å™¨é—´ç»„ç»‡æˆå±‚çº§å…³ç³»ã€‚&lt;/p>
&lt;p>&lt;code>Module&lt;/code>-&amp;gt;&lt;code>Function&lt;/code>-&amp;gt;&lt;code>BasicBlock&lt;/code>-&amp;gt;&lt;code>Instruction&lt;/code>&lt;/p>
&lt;p>&lt;code>Value&lt;/code> æ˜¯å…¬å…±åŸºç±»ï¼Œ&lt;code>Function&lt;/code>ã€&lt;code>BasicBlock&lt;/code>ï¼ŒåŒ…æ‹¬å„ç§æŒ‡ä»¤ç±»éƒ½æ˜¯ä»&lt;code>Value&lt;/code>ç»§æ‰¿ã€‚&lt;/p>
&lt;h4 id="phinode">PHINodeï¼š&lt;/h4>
&lt;p>å‚è€ƒæ–‡ç« ï¼š&lt;a class="link" href="http://mayuyu.io/2018/06/04/PhiNode-in-LLVM/" target="_blank" rel="noopener"
>PhiNode in LLVM&lt;/a>&lt;/p>
&lt;p>LLVMçš„æŒ‡ä»¤ç±»å‹ä¸­åŒ…å«ä¸€ç§ç‰¹æ®ŠèŠ‚ç‚¹å« PhiNodeï¼ŒPhiNode çš„å­˜åœ¨æ˜¯ä¸ºäº†è§£å†³ LLVM IR ä¸­å›  SSA ï¼ˆé™æ€å•æ¬¡èµ‹å€¼ï¼‰å¼•èµ·çš„æ¡ä»¶åˆå§‹åŒ–é—®é¢˜ã€‚ç¤ºä¾‹å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="kt">int&lt;/span> &lt;span class="nf">foooooo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">bar&lt;/span>&lt;span class="p">){&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">bar&lt;/span>&lt;span class="o">%&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">){&lt;/span>
&lt;span class="n">i&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//BasicBlock 1
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="k">else&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="n">i&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//BasicBlock 2
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬éœ€è¦æŒ‰ &lt;code>bar&lt;/code> çš„å–å€¼æ¥åˆå§‹åŒ– &lt;code>i&lt;/code>ï¼Œä½† SSA è¦æ±‚ &lt;code>i&lt;/code> åªèƒ½è¢«èµ‹å€¼ä¸€æ¬¡ã€‚PhiNode å…è®¸æ ¹æ®åŸºæœ¬å—é€‰æ‹©èµ‹å€¼ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="kt">int&lt;/span> &lt;span class="nf">foooooo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">bar&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">bar&lt;/span>&lt;span class="o">%&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">){&lt;/span>
&lt;span class="c1">//BasicBlock1
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="k">else&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="c1">//BasicBlock2
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">Phi&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="n">BasicBlock1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">],[&lt;/span>&lt;span class="n">BasicBlock2&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸Šé¢çš„ä¾‹å­ä¹Ÿå¯ä»¥æ”¹æˆåœ¨æ ˆæˆ–å †ä¸Šå¼€è¾Ÿç©ºé—´ï¼Œä»¥ç±»ä¼¼æŒ‡é’ˆçš„æ–¹å¼é¿å¼€ SSA çº¦æŸã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="kt">int&lt;/span> &lt;span class="nf">foooooo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">bar&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kt">int&lt;/span>&lt;span class="o">*&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">malloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">));&lt;/span>
&lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">bar&lt;/span>&lt;span class="o">%&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">){&lt;/span>
&lt;span class="n">Store&lt;/span> &lt;span class="n">Value&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">to&lt;/span> &lt;span class="n">the&lt;/span> &lt;span class="n">memory&lt;/span> &lt;span class="n">location&lt;/span> &lt;span class="n">pointed&lt;/span> &lt;span class="n">to&lt;/span> &lt;span class="n">by&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">else&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="n">Store&lt;/span> &lt;span class="n">Value&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="n">to&lt;/span> &lt;span class="n">the&lt;/span> &lt;span class="n">memory&lt;/span> &lt;span class="n">location&lt;/span> &lt;span class="n">pointed&lt;/span> &lt;span class="n">to&lt;/span> &lt;span class="n">by&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">j&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">load&lt;/span> &lt;span class="n">from&lt;/span> &lt;span class="n">the&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="n">pointed&lt;/span> &lt;span class="n">by&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">j&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="terminator">Terminator:&lt;/h4>
&lt;p>å‚è€ƒæ–‡ç« ï¼š&lt;a class="link" href="https://www.quora.com/How-do-Terminators-work-in-the-LLVM-IR" target="_blank" rel="noopener"
>How do Terminator work in LLVM IR&lt;/a>&lt;/p>
&lt;p>LLVMä¸­ï¼Œä¸€ä¸ªåŸºæœ¬å— &lt;em>BasicBlock&lt;/em> æ€»æ˜¯ä»¥ç»ˆç»“æŒ‡ä»¤ &lt;em>TerminatorInst&lt;/em> ç»“æŸçš„ã€‚ç»ˆç»“æŒ‡ä»¤ä¸èƒ½å‡ºç°åœ¨åŸºæœ¬å—æœ«å°¾ä»¥å¤–çš„ä»»ä½•åœ°æ–¹ã€‚ç²—ç•¥åœ°è¯´ï¼Œç»ˆç»“æŒ‡ä»¤æ ‡è¯†æ§åˆ¶æµåœ¨åŸºæœ¬å—ç»“æŸåå»å¾€ä½•æ–¹ã€‚&lt;/p>
&lt;p>æ¯ä¸ªç»ˆç»“æŒ‡ä»¤éƒ½åŒ…å«ä¸€å®šçš„åç»§åŸºæœ¬å—ã€‚&lt;/p>
&lt;p>å‡ ä¸ªå¸¸è§çš„ç»ˆç»“æŒ‡ä»¤ç±»å‹ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>ReturnInst&lt;/code> å°±åƒæ˜¯æ™®é€šç¼–ç¨‹ä¸­çš„çš„&lt;code>return&lt;/code>è¯­å¥ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>BranchInst&lt;/code> æ˜¯è·³è½¬æŒ‡ä»¤ï¼ŒåŒ…æ‹¬ä¸¤ç±»ï¼š&lt;/p>
&lt;ul>
&lt;li>æ¡ä»¶è·³è½¬ï¼Œæ»¡è¶³æ¡ä»¶æ—¶è·³è½¬åˆ†æ”¯1ï¼Œå¦åˆ™è·³è½¬åˆ†æ”¯2ã€‚&lt;/li>
&lt;li>éæ¡ä»¶è·³è½¬ï¼Œæ€»æ˜¯è·³è½¬åˆ°æŸä¸ªåˆ†æ”¯ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;code>SwitchInst&lt;/code> ç±»ä¼¼äºæ™®é€šç¼–ç¨‹é‡Œçš„ &lt;code>switch&lt;/code> è¯­å¥ï¼Œå¯ä»¥åŒ…å«æ›´å¤šçš„åç»§å—ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>è¿˜æœ‰äº›ä¸é‚£ä¹ˆå¸¸è§çš„ç»ˆç»“æŒ‡ä»¤ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>invoke&lt;/code> å’Œ &lt;code>catchswitch&lt;/code>&lt;/li>
&lt;li>&lt;code>unreachable&lt;/code>&lt;/li>
&lt;/ul>
&lt;h3 id="33-å·¥å…·é“¾">3.3 å·¥å…·é“¾&lt;/h3>
&lt;p>å‚è€ƒæ–‡ç« ï¼š&lt;a class="link" href="https://llvm.org/docs/CommandGuide/index.html" target="_blank" rel="noopener"
>LLVM Command Guide&lt;/a>&lt;/p>
&lt;p>å®é™…åŠ¨æ‰‹å‰å…ˆäº†è§£ä¸‹ LLVMå·¥å…·é“¾ï¼Œåˆ—å‡ºä¸€äº›ä¼šæ¶‰åŠåˆ°çš„å‘½ä»¤è¡Œå·¥å…·ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;code>llc&lt;/code> å°†è¾“å…¥çš„ LLVM IR(&lt;code>.ll&lt;/code>) ç¼–è¯‘æˆæŒ‡å®šæ¶æ„çš„æ±‡ç¼–ï¼ˆæˆ–äºŒè¿›åˆ¶å¯¹è±¡æ–‡ä»¶ï¼‰&lt;/li>
&lt;li>&lt;code>lli&lt;/code> å°†è¾“å…¥çš„ BitCode(&lt;code>.bc&lt;/code>) è§£é‡Šæ‰§è¡Œã€‚&lt;/li>
&lt;li>&lt;code>llvm-as&lt;/code> æ±‡ç¼–å™¨&lt;/li>
&lt;li>&lt;code>llvm-dis&lt;/code> åæ±‡ç¼–å™¨ï¼Œå¯ä»¥åæ±‡ç¼– BitCode&lt;/li>
&lt;li>&lt;code>opt&lt;/code> BITCODE/IR ä¼˜åŒ–å™¨&lt;/li>
&lt;/ul>
&lt;p>æœ€å¥½å†å®‰è£…ä¸€ä¸ª graphvizï¼Œå› ä¸ºå¾ˆå¤šç¼–ç¨‹è¯­è¨€çš„å‘½ä»¤è¡Œå·¥å…·å¦‚æœæä¾›å›¾å½¢è¾“å‡ºçš„è¯ï¼Œå¤§å¤šæ˜¯ä»¥ dot å½¢å¼æä¾›ï¼ˆæ¯”å¦‚ go çš„ pprof å’Œ LLVM opt çš„ dot-cfgï¼‰ã€‚&lt;/p>
&lt;h3 id="33-runonfunction">3.3 runOnFunction&lt;/h3>
&lt;p>å‚è€ƒ OLLVM çš„ä»£ç ï¼ŒæŠ„å‡ºè¿‡æ»¤å‡½æ•°ã€‚åŸç†ä¸æ˜æš‚ä¸”ä¸æ·±ç©¶ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="kt">bool&lt;/span> &lt;span class="nf">isObfuscateable&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="n">Function&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">fn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">fn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">isDeclaration&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">false&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">fn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">hasAvailableExternallyLinkage&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">false&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">isInvoke&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fn&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">false&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">true&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">bool&lt;/span> &lt;span class="nf">isInvoke&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="n">Function&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">fn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="n">BasicBlock&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nl">bb&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">fn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">isa&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">InvokeInst&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">bb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getTerminator&lt;/span>&lt;span class="p">()))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">false&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">true&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶ååœ¨å…¥å£ç‚¹ç®€å•è¿‡æ»¤æ‰ä¸èƒ½æ··æ·†çš„å‡½æ•°ï¼Œæ¥ç€éå†åŸºæœ¬å—ï¼Œå¯¹æ¯ä¸ªåŸºæœ¬å—éƒ½è¿›è¡Œä¸€æ¬¡æ··æ·†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="kt">bool&lt;/span> &lt;span class="nf">runOnFunction&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Function&lt;/span>&lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">F&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">isObfuscateable&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">F&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">errs&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">&amp;lt;&amp;lt;&lt;/span>&lt;span class="s">&amp;#34;function &amp;#34;&lt;/span>&lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">F&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getName&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span>&lt;span class="s">&amp;#34; is not obfuscateable&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">false&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">list&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">BasicBlock&lt;/span> &lt;span class="o">*&amp;gt;&lt;/span> &lt;span class="n">blocks&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">BasicBlock&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nl">block&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">F&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">blocks&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">push_back&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">block&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">BasicBlock&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nl">block&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">blocks&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// åŸå§‹å—åˆ†å‰²ä¸ºä¸‰ä¸ªåŸºæœ¬å—ï¼šentryã€originalã€terminator
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// é€šè¿‡ä¸¤ä¸ªæ’çœŸæ¡ä»¶è¿æ¥
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">auto&lt;/span> &lt;span class="n">entryBB&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">block&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">originalBB&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">entryBB&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">splitBasicBlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">entryBB&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getFirstNonPHIOrDbgOrLifetime&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="n">Twine&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;original&amp;#34;&lt;/span>&lt;span class="p">));&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">terminatorBB&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">originalBB&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">splitBasicBlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">--&lt;/span>&lt;span class="n">originalBB&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">end&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="n">Twine&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;terminator&amp;#34;&lt;/span>&lt;span class="p">));&lt;/span>
&lt;span class="c1">// æ„é€ ä¼ªé€ å—
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// è¿™ä¸€æ­¥å·²ç»æ„é€ å¥½äº† altered è·³è½¬ original
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">auto&lt;/span> &lt;span class="n">alteredBB&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">createAlteredBB&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">originalBB&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">F&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// æ¸…ç† terminatorï¼Œé‡æ–°æ„é€ è·³è½¬å…³ç³»
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">entryBB&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getTerminator&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">eraseFromParent&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="n">originalBB&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getTerminator&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">eraseFromParent&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="c1">// æ„é€ æ’çœŸæ¡ä»¶ï¼Œä» entry è·³è½¬åˆ° original
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">auto&lt;/span> &lt;span class="n">lhs&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ConstantInt&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Type&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">getInt32Ty&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">F&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getContext&lt;/span>&lt;span class="p">()),&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">rhs&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ConstantInt&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Type&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">getInt32Ty&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">F&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getContext&lt;/span>&lt;span class="p">()),&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">condition&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ICmpInst&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">entryBB&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ICmpInst&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">ICMP_EQ&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">lhs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">rhs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Twine&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;condition&amp;#34;&lt;/span>&lt;span class="p">));&lt;/span>
&lt;span class="n">BranchInst&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">Create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">originalBB&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">alteredBB&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">Value&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">condition&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">entryBB&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// æ„é€ æ’çœŸæ¡ä»¶ï¼Œä» original è·³è½¬åˆ° terminator
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">auto&lt;/span> &lt;span class="n">lhs2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ConstantInt&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Type&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">getInt32Ty&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">F&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getContext&lt;/span>&lt;span class="p">()),&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">rhs2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ConstantInt&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Type&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">getInt32Ty&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">F&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getContext&lt;/span>&lt;span class="p">()),&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">condition2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ICmpInst&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">originalBB&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ICmpInst&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">ICMP_EQ&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">lhs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">rhs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Twine&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;condition2&amp;#34;&lt;/span>&lt;span class="p">));&lt;/span>
&lt;span class="n">BranchInst&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">Create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">terminatorBB&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">alteredBB&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">Value&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">condition&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">originalBB&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">false&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ··æ·†è¿‡ç¨‹éå¸¸ç®€å•ï¼ŒåŸå§‹åŸºæœ¬å—åˆ†å‰²æˆä¸‰ä¸ªéƒ¨åˆ†ï¼Œæ¸…é™¤&lt;code>entry&lt;/code>å’Œ&lt;code>original&lt;/code>çš„&lt;code>terminator&lt;/code>å¹¶åŠ å…¥æ’çœŸæ¡ä»¶è·³è½¬ï¼Œfalse åˆ†æ”¯éƒ½æŒ‡å®šä¸º &lt;code>altered&lt;/code> å³å¯ã€‚&lt;/p>
&lt;h3 id="34-createalteredbb">3.4 createAlteredBB&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="n">BasicBlock&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nf">createAlteredBB&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">BasicBlock&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">original&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Function&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">F&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// æ„é€ ä¼ªé€ å—
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">ValueToValueMapTy&lt;/span> &lt;span class="n">VMap&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">altered&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">CloneBasicBlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">original&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">VMap&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Twine&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;altered&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">F&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// ä¿®å¤ä¼ªé€ å—çš„æŒ‡ä»¤
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">auto&lt;/span> &lt;span class="n">originalInstIt&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">original&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">begin&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">auto&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nl">inst&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">altered&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// NOTE:
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// å‚è€ƒé“¾æ¥ï¼š https://bbs.pediy.com/thread-266201.htm
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// ... ä½†æ˜¯CloneBasicBlockå‡½æ•°è¿›è¡Œçš„å…‹éš†å¹¶ä¸æ˜¯å®Œå…¨çš„å…‹éš†ï¼Œç¬¬ä¸€ä»–ä¸ä¼šå¯¹æŒ‡ä»¤çš„æ“ä½œæ•°è¿›è¡Œæ›¿æ¢ï¼Œæ¯”å¦‚ï¼š
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// ```
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// orig:
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// %a = ...
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// %b = fadd %a, ...
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// clone:
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// %a.clone = ...
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// %b.clone = fadd %a, ... ; Note that this references the old %a and
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// not %a.clone!
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// ```
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// åœ¨cloneå‡ºæ¥çš„åŸºæœ¬å—ä¸­ï¼ŒfaddæŒ‡ä»¤çš„æ“ä½œæ•°ä¸æ˜¯%a.cloneï¼Œè€Œæ˜¯%aã€‚
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// æ‰€ä»¥ä¹‹åè¦é€šè¿‡VMapå¯¹æ‰€æœ‰æ“ä½œæ•°è¿›è¡Œæ˜ å°„ï¼Œä½¿å…¶æ¢å¤æ­£å¸¸ï¼š
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">auto&lt;/span> &lt;span class="n">opi&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">op_begin&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="n">opi&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">op_end&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="n">opi&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">Value&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">MapValue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">opi&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">VMap&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">RF_None&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">*&lt;/span>&lt;span class="n">opi&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">v&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// ç¬¬äºŒï¼Œå®ƒä¸ä¼šå¯¹PHI Nodeè¿›è¡Œä»»ä½•å¤„ç†ï¼ŒPHI Nodeçš„å‰é©±å—ä»ç„¶æ˜¯åŸå§‹åŸºæœ¬å—çš„å‰é©±å—ï¼Œ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// ä½†æ˜¯æ–°å…‹éš†å‡ºæ¥çš„åŸºæœ¬å—å¹¶æ²¡æœ‰ä»»ä½•å‰é©±å—ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å¯¹PHI Nodeçš„å‰é©±å—è¿›è¡Œremapï¼š
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">auto&lt;/span> &lt;span class="n">pn&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">dyn_cast&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">PHINode&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">inst&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">unsigned&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">e&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">pn&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getNumIncomingValues&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">Value&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">MapValue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pn&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getIncomingBlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">VMap&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">RF_None&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">pn&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">setIncomingBlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">cast&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">BasicBlock&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">v&lt;/span>&lt;span class="p">));&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// å…ƒæ•°æ®
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">SmallVector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">pair&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">unsigned&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MDNode&lt;/span> &lt;span class="o">*&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">MDs&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getAllMetadata&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">MDs&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// ä¿®å¤è°ƒè¯•
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">setDebugLoc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">originalInstIt&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getDebugLoc&lt;/span>&lt;span class="p">());&lt;/span>
&lt;span class="o">++&lt;/span>&lt;span class="n">originalInstIt&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// æ¸…ç†åŸæ¥çš„ terminatorï¼Œæ— æ¡ä»¶ä» altered è·³è½¬åˆ° original
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">altered&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getTerminator&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">eraseFromParent&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="n">BranchInst&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">Create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">original&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">altered&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">altered&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å»é™¤ä¿®å¤æŒ‡ä»¤æ“ä½œæ•°å’Œ PhiNode çš„éƒ¨åˆ†ï¼Œå…¶å®å°±æ˜¯å¤åˆ¶äº†åŸå§‹å—çš„æŒ‡ä»¤ï¼Œç„¶åå°†ç»ˆç»“æŒ‡ä»¤æ”¹æˆè·³è½¬åˆ°åŸå§‹å—è€Œå·²ã€‚&lt;/p>
&lt;h3 id="35-ç¼–è¯‘å’Œæµ‹è¯•">3.5 ç¼–è¯‘å’Œæµ‹è¯•&lt;/h3>
&lt;p>ä½¿ç”¨ CMake ç¼–è¯‘ï¼Œåœ¨ç¯å¢ƒè®¾ç½®ä¸€èŠ‚ä¸­å·²ç»è¯´æ˜äº†æ€ä¹ˆé…ç½®ï¼Œç¼–è¯‘å¾—åˆ°äº† &lt;code>Hello.dll&lt;/code> åç”¨ä¸‹é¢çš„æ¡ˆä¾‹ç¨‹åºæµ‹è¯•ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdio.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hello world&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç¨‹åºä¿å­˜åœ¨ &lt;code>sample/sample.c&lt;/code>ï¼Œæµ‹è¯•å‘½ä»¤å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># clang ç¼–è¯‘å¾—åˆ° bitcode&lt;/span>
clang -emit-llvm .&lt;span class="se">\s&lt;/span>ample&lt;span class="se">\s&lt;/span>ample.c -c -o .&lt;span class="se">\s&lt;/span>ample&lt;span class="se">\s&lt;/span>ample.bc
&lt;span class="c1"># opt å¯ç”¨ hello pass åˆ›å»ºæ··æ·†åçš„æ–° bitcode&lt;/span>
opt -enable-new-pm&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> -load .&lt;span class="se">\b&lt;/span>uild&lt;span class="se">\H&lt;/span>ello.dll -hello .&lt;span class="se">\s&lt;/span>ample&lt;span class="se">\s&lt;/span>ample.bc -o .&lt;span class="se">\s&lt;/span>ample&lt;span class="se">\s&lt;/span>ample-optimized.bc
&lt;span class="c1"># llvm-dis åæ±‡ç¼–æ··æ·†åçš„ bitcodeï¼Œå¾—åˆ° sample-optimized.ll ï¼Œå¯ä»¥æ‹¿æ¥çœ‹æ··æ·†ç»“æœ&lt;/span>
llvm-dis .&lt;span class="se">\s&lt;/span>ample&lt;span class="se">\s&lt;/span>ample-optimized.bc
&lt;span class="c1"># llc å°†æ··æ·†åçš„ bitcode ç¼–è¯‘å‡ºæ±‡ç¼–æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ç¼–è¯‘å‡º obj æ–‡ä»¶ï¼Œç”¨ -filetype=obj å°±è¡Œ&lt;/span>
&lt;span class="c1"># æ³¨æ„ -O0ï¼Œä¸ç„¶é»˜è®¤ä¼˜åŒ–å°±ä¼šç›´æ¥æŠŠæˆ‘ä»¬ä¼ªé€ çš„åˆ†æ”¯ç»™å¹²æ‰&lt;/span>
llc .&lt;span class="se">\s&lt;/span>ample&lt;span class="se">\s&lt;/span>ample-optimized.bc -O0 -o .&lt;span class="se">\s&lt;/span>ample.s
&lt;span class="c1"># ç”¨ clang å®Œæˆæœ€åçš„æ±‡ç¼–å’Œé“¾æ¥&lt;/span>
clang sample.s -o sample.exe
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¹Ÿå¯ä»¥ç”¨ opt æ¥è·å¾—æ··æ·†åçš„ä»£ç æ§åˆ¶æµè§†å›¾ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">opt -enable-new-pm&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> -dot-cfg -cfg-func-name&lt;span class="o">=&lt;/span>main .&lt;span class="se">\s&lt;/span>ample&lt;span class="se">\s&lt;/span>ample-optimized.bc
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 136;
flex-basis: 326px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/learning-packer-08/main.png" data-size="755x555">
&lt;img src="https://nnnewb.github.io/blog/blog/p/learning-packer-08/main.png"
width="755"
height="555"
srcset="https://nnnewb.github.io/blog/blog/p/learning-packer-08/main_hu9fb641053a057b276abc5a630d791922_51045_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/learning-packer-08/main_hu9fb641053a057b276abc5a630d791922_51045_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="main">
&lt;/a>
&lt;figcaption>main&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>åœ¨IDAæ‰“å¼€åçœ‹åˆ°çš„ç»“æœå¦‚ä¸‹ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 55;
flex-basis: 132px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/learning-packer-08/image-20211103141258015.png" data-size="370x668">
&lt;img src="https://nnnewb.github.io/blog/blog/p/learning-packer-08/image-20211103141258015.png"
width="370"
height="668"
srcset="https://nnnewb.github.io/blog/blog/p/learning-packer-08/image-20211103141258015_hu6b9a1833094321916938f7c8374d48d6_60703_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/learning-packer-08/image-20211103141258015_hu6b9a1833094321916938f7c8374d48d6_60703_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211103141258015">
&lt;/a>
&lt;figcaption>image-20211103141258015&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å†æ¥ä¸ªæ›´å¤æ‚çš„ä¾‹å­ï¼š&lt;a class="link" href="https://github.com/nnnewb/crackmes/blob/main/cm02/main.c" target="_blank" rel="noopener"
>main.c&lt;/a>&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 49;
flex-basis: 118px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/learning-packer-08/image-20211103142352174.png" data-size="314x638">
&lt;img src="https://nnnewb.github.io/blog/blog/p/learning-packer-08/image-20211103142352174.png"
width="314"
height="638"
srcset="https://nnnewb.github.io/blog/blog/p/learning-packer-08/image-20211103142352174_hu6e7d17f0f44390d3241deebec431bcff_8522_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/learning-packer-08/image-20211103142352174_hu6e7d17f0f44390d3241deebec431bcff_8522_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211103142352174">
&lt;/a>
&lt;figcaption>image-20211103142352174&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;h3 id="36-æ‰©å±•ä¸é€æ˜è°“è¯">3.6 æ‰©å±•ï¼šä¸é€æ˜è°“è¯&lt;/h3>
&lt;p>å‚è€ƒæ–‡ç« ï¼š&lt;a class="link" href="https://reverseengineering.stackexchange.com/questions/1669/what-is-an-opaque-predicate" target="_blank" rel="noopener"
>what is an opaque predicate&lt;/a>&lt;/p>
&lt;p>PSï¼šæœ¬äººæ²¡æœ‰ç›¸å…³å­¦æœ¯èƒŒæ™¯ï¼Œå†…å®¹ä¸œæ‹¼è¥¿å‡‘ï¼Œå¦‚æœå­˜åœ¨ç†è§£é”™è¯¯æˆ–è€…é™ˆè¿°ä¸å‡†ç¡®è¯·æŒ‡å‡ºã€‚&lt;/p>
&lt;p>æ¦‚æ‹¬åœ°è¯´ï¼Œä¸é€æ˜è°“è¯å°±æ˜¯â€œæŸç§å¦‚æœç¨‹åºåˆ†æä¸å¤Ÿå……åˆ†ï¼Œå°±å¯èƒ½é”™è¿‡çš„ä¸œè¥¿â€ã€‚å­¦æœ¯ä¸Šè¯´ä¸é€æ˜è°“è¯æ˜¯å§‹ç»ˆåœ¨ä¸€ä¸ªæ–¹å‘ä¸Šæ‰§è¡Œçš„åˆ†æ”¯ï¼Œå¯¹ç¨‹åºåˆ›å»ºè€…å·²çŸ¥ï¼Œå¯¹åˆ†æå™¨æœªçŸ¥ã€‚&lt;/p>
&lt;p>ä¾‹å¦‚æˆ‘ä»¬çŸ¥é“ç¨‹åºè¿è¡Œæ—¶ï¼Œ&lt;code>LoadLibraryA&lt;/code> åŠ è½½ä¸€ä¸ªä¸å­˜åœ¨çš„åº“ä¼šè¿”å› &lt;code>null&lt;/code>ï¼Œä½†åˆ†æå™¨å¹¶ä¸æ¸…æ¥šæˆ‘ä»¬è¿è¡Œçš„ç¯å¢ƒé‡Œæ˜¯å¦çœŸçš„å­˜åœ¨/ä¸å­˜åœ¨è¿™ä¸ªåº“ï¼Œå¯¹äºåˆ†æå™¨æ¥è¯´ç”¨&lt;code>LoadLibraryA&lt;/code>æ„é€ å‡ºæ¥çš„æ¡ä»¶è·³è½¬å°±æ˜¯ä¸€ä¸ªä¸é€æ˜è°“è¯ã€‚&lt;/p>
&lt;p>é‚£é€æ˜å‘¢ï¼Ÿä¸çŸ¥é“æœ‰æ²¡æœ‰è¿™æ ·çš„è¯´æ³•ï¼Œä¸é€æ˜æ˜¯åˆ†æå™¨å¯èƒ½é”™è¿‡çš„ä¸œè¥¿çš„è¯ï¼Œé€æ˜å°±æ˜¯åˆ†æå™¨ä¸ä¼šé”™è¿‡çš„ä¸œè¥¿ï¼Œæ¯”å¦‚ &lt;code>xor eax,eax&lt;/code> å†ç´§è·Ÿç€ &lt;code>test eax,eax&lt;/code>ï¼Œé‚£ä¹ˆ&lt;code>jnz&lt;/code>çš„èµ°å‘å¯¹åˆ†æå™¨æ¥è¯´å°±æ˜¯å·²çŸ¥çš„â€”â€”é™¤éåˆ†æå™¨æ ¹æœ¬æ²¡è¿™åŠŸèƒ½ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>é¦–å…ˆæ˜¯å®Œæ•´æ¡ˆä¾‹ä»£ç ï¼š&lt;a class="link" href="https://github.com/nnnewb/learning-packer/tree/main/packer8" target="_blank" rel="noopener"
>packer8 - GitHub&lt;/a>&lt;/p>
&lt;p>æ€»ç»“çŸ¥è¯†ç‚¹ï¼š&lt;/p>
&lt;ul>
&lt;li>å…³é”®ç±»å‹ï¼š&lt;code>Module&lt;/code>ã€&lt;code>Function&lt;/code>ã€&lt;code>BasicBlock&lt;/code>ã€&lt;code>Instruction&lt;/code> &amp;hellip;&lt;/li>
&lt;li>PhiNode&lt;/li>
&lt;li>ç»ˆç»“æŒ‡ä»¤ï¼Œ&lt;code>BranchInst&lt;/code>ã€&lt;code>ReturnInst&lt;/code>&lt;/li>
&lt;li>LLVM å·¥å…·é“¾ï¼š&lt;code>opt&lt;/code>ã€&lt;code>llc&lt;/code>ã€&lt;code>lli&lt;/code>ã€&lt;code>llvm-dis&lt;/code>&lt;/li>
&lt;li>å…³äº new pass manager çš„å‘ï¼š&lt;code>-fno-experimental-new-pass-manager&lt;/code>ã€&lt;code>-enable-new-pm=0&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>ç”¨ opt å•ç‹¬ææ··æ·†å¾ˆéº»çƒ¦ï¼Œä¹Ÿä¸èƒ½é›†æˆåˆ°å·²æœ‰çš„ cmake/make é¡¹ç›®é‡Œã€‚ç”¨ clang åŠ è½½æ··æ·†å™¨çš„åªéœ€è¦è¿™æ ·ï¼š&lt;code>-Xclang -load -Xclang bcf.dll -fno-experimental-new-pass-manager&lt;/code> å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ &lt;code>bcf.dll&lt;/code> å‚ä¸æ··æ·†å•¦ã€‚&lt;/p>
&lt;p>LLVM 13.x ç‰ˆæœ¬çš„æ–° pass manager å¸¦æ¥äº†å¾ˆå¤šé—®é¢˜ï¼Œä¸»è¦æ˜¯ LLVM çš„æ–‡æ¡£æ²¡å†™æ€ä¹ˆæŠŠ Pass æ³¨å†Œåˆ°æ–°çš„ PM é‡Œï¼Œç»“æœ opt èƒ½è·‘ clang åˆæ²¡è¿è¡Œ pass ï¼Œå°±æœæ¥æœå»èŠ±äº†å¾ˆå¤šæ—¶é—´&amp;hellip;ä¸è¿‡å®é™…åŠ¨æ‰‹å†™è¿‡ä¹‹åä¼šå‘ç° LLVM æ˜¯ä¸ªå¤§å®åº“ï¼Œç‰¹åˆ«é€‚åˆå‘æŒ¥æƒ³è±¡ã€‚Pass æ¥æ‰©å±•ç¼–è¯‘å™¨åŠŸèƒ½è¿˜æ˜¯æŒºæ–¹ä¾¿æ‰©å±•çš„ï¼Œä¹Ÿèƒ½ä¸€çª¥LLVMå†…éƒ¨çš„å¥‡å¦™ä¸–ç•Œã€‚&lt;/p>
&lt;p>åŸæœ¬è¿˜æ‰“ç®—çœ‹çœ‹æ§åˆ¶æµæ‰å¹³åŒ–ï¼Œæ¯•ç«ŸOLLVMéƒ½å·²ç»å¼€å§‹çœ‹äº†ï¼Œæ§åˆ¶æµæ‰å¹³åŒ–ä¸çœ‹ä¸€ä¸‹æ„Ÿè§‰æœ‰ç‚¹è¯´ä¸è¿‡å»ã€‚ä½†æ˜¯å®é™…ä¸Šæ‰‹å‘ç°æ²¡è€å¿ƒå†è¯»ä¸€éè¿™ä»£ç äº†=ã€‚=ä¹Ÿè®¸ä¸‹æ¬¡ã€‚OLLVMä»£ç è§£è¯»å¥½åƒæœ‰ä¸å°‘å¸–å­äº†å§ï¼Œä¸çŒ®ä¸‘äº†ã€‚æ§åˆ¶æµæ‰å¹³åŒ–çš„ä»£ç é‡ä¹Ÿä¸æ˜¯å¾ˆå¤šï¼Œæ…¢æ…¢è¯»è¿˜æ˜¯èƒ½æ‹æ¸…æ¥šé€»è¾‘çš„ã€‚&lt;/p>
&lt;p>å¦å¤–è¿˜å¯ä»¥å‘æŒ¥æƒ³è±¡ï¼šèƒ½ä¸èƒ½ç”¨ LLVM Pass å¾€ä»£ç é‡Œæ’å…¥èŠ±æŒ‡ä»¤ï¼Ÿ&lt;/p>
&lt;p>å‚è€ƒèµ„æ–™ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;a class="link" href="https://llvm.org/docs/CMake.html#cmake-out-of-source-pass" target="_blank" rel="noopener"
>CMake out of source pass - LLVM&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://llvm.org/docs/WritingAnLLVMPass.html" target="_blank" rel="noopener"
>Writing an LLVM Pass - LLVM&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://mukulrathi.com/create-your-own-programming-language/llvm-ir-cpp-api-tutorial/" target="_blank" rel="noopener"
>LLVM IR C++ API Tutorial&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="http://mayuyu.io/2018/06/04/PhiNode-in-LLVM/" target="_blank" rel="noopener"
>PhiNode in LLVM&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://www.quora.com/How-do-Terminators-work-in-the-LLVM-IR" target="_blank" rel="noopener"
>How do Terminator work in LLVM IR&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://llvm.org/docs/CommandGuide/index.html" target="_blank" rel="noopener"
>LLVM Command Guide&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://bbs.pediy.com/thread-266201.htm" target="_blank" rel="noopener"
>OLLVM è™šå‡æ§åˆ¶æµæºç å­¦ä¹ ç¬”è®° - çœ‹é›ªè®ºå›&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://github1s.com/0x3f97/ollvm-12.x/blob/HEAD/README.md" target="_blank" rel="noopener"
>0x3f97/ollvm-12.x&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>åŠ å£³åŸç†07 - èŠ±æŒ‡ä»¤å…¥é—¨</title><link>https://nnnewb.github.io/blog/p/learning-packer-07/</link><pubDate>Sun, 31 Oct 2021 17:14:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/learning-packer-07/</guid><description>&lt;img src="https://nnnewb.github.io/blog/p/learning-packer-07/cover.jpg" alt="Featured image of post åŠ å£³åŸç†07 - èŠ±æŒ‡ä»¤å…¥é—¨" />&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>ä¸ªäººæµ…è§ï¼Œä¸€èˆ¬åˆ†æä¸€ä¸ªç¨‹åºå¯ä»¥æœ‰åŠ¨æ€å’Œé™æ€ä¸¤æ¡è·¯ï¼ŒåŠ¨æ€ä¸€èˆ¬æŒ‡çš„å°±æ˜¯è°ƒè¯•æˆ–è€…åˆ«çš„è¿è¡Œæ—¶è·Ÿè¸ªç¨‹åºè¡Œä¸ºçš„æ–¹å¼äº†ï¼Œé™¤äº†è°ƒè¯•å™¨å¤–å°±æ˜¯æŠ“å–äº‹ä»¶ã€æ—¥å¿—ã€APIè°ƒç”¨è®°å½•ã€çœ‹å†…å­˜æ•°æ®ç­‰ï¼Œæ¯”å¦‚æœ‰ Fridaï¼Œè¿˜æœ‰å†…å­˜æœç´¢å¦‚CEã€‚é™æ€åˆ™æ˜¯ç”¨å„ç§å·¥å…·åœ¨ä¸å®é™…è¿è¡Œç¨‹åºçš„å‰æä¸‹ï¼Œä»ç¨‹åºæ–‡ä»¶é‡Œæå–æœ‰ç”¨çš„ä¿¡æ¯ã€‚&lt;/p>
&lt;p>å¯¹äºè¿è¡Œæ—¶çš„å¯¹æŠ—æ‰‹æ®µå¾ˆå¤šï¼Œæ¯•ç«Ÿç¨‹åºéƒ½è·‘èµ·æ¥äº†ï¼Œä½ æ¥æˆ‘å¾€æ‰“æ“‚å°å˜›ã€‚è€Œä¸”åœ¨Windowsè¿™ä¸ªé—­æºå¹³å°ä¸Šï¼Œè¿˜å¯ä»¥é ä¸å¤§å¯èƒ½è¢«åŠ¨æ‰‹è„šçš„å†…æ ¸æ¥ä¿æŠ¤è‡ªå·±ï¼ŒLinuxä¸Šå°±å¯èƒ½å†…æ ¸éƒ½æ˜¯è¢«é­”æ”¹è¿‡çš„ã€‚&lt;/p>
&lt;p>ä½†æ˜¯å¯¹é™æ€åˆ†æå°±æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«å¥½çš„åŠæ³•ï¼Œåˆè¦äººé€ çš„è®¡ç®—æœºèƒ½æ­£ç¡®è¿è¡Œï¼Œåˆè¦äººä¸èƒ½ç†è§£ï¼Œå°±æœ‰ç‚¹çŸ›ç›¾ã€‚&lt;/p>
&lt;p>å¹¿ä¸ºäººçŸ¥çš„å¯¹æŠ—é™æ€åˆ†æçš„æ‰‹æ®µæœ‰è¿™äº›ï¼š&lt;/p>
&lt;ol>
&lt;li>æ··æ·†ï¼ŒæŠŠç¨‹åºé€»è¾‘è½¬æ¢æˆæ›´æ™¦æ¶©ä½†ç­‰ä»·çš„å½¢å¼ã€‚&lt;/li>
&lt;li>åŠ èŠ±ï¼Œå¯¹æŠ—åæ±‡ç¼–å¼•æ“ï¼Œåˆ©ç”¨åæ±‡ç¼–å·¥å…·çš„ç®—æ³•ç¼ºé™·ã€æ¼æ´æ¥è¿«ä½¿åˆ†æè€…å¿…é¡»èŠ±è´¹å¤§é‡æ—¶é—´å¤„ç†é”™è¯¯çš„åæ±‡ç¼–ç»“æœï¼Œè®©è¯¸å¦‚æ§åˆ¶æµè§†å›¾ä¹‹ç±»çš„å·¥å…·å¤±æ•ˆã€‚&lt;/li>
&lt;/ol>
&lt;p>æ··æ·†å’ŒåŠ èŠ±çš„ä¸»è¦åŒºåˆ« &lt;strong>åœ¨æˆ‘è¿™&lt;/strong> å®šä¹‰ä¸º &lt;strong>æ··æ·†æ˜¯å˜æ¢åŸç¨‹åºé€»è¾‘ï¼ŒèŠ±æŒ‡ä»¤ä¸æ”¹å˜åŸç¨‹åºé€»è¾‘&lt;/strong> ã€‚&lt;/p>
&lt;p>è¿™äº›å¯¹æŠ—æ‰‹æ®µä¸»è¦çš„ç›®çš„éƒ½æ˜¯ &lt;strong>æ¶ˆç£¨è€å¿ƒ&lt;/strong> å’Œ &lt;strong>æ‹–å»¶æ—¶é—´&lt;/strong> ï¼ŒæŠ¬é«˜äººè‚‰åˆ†æçš„æˆæœ¬ã€‚ä½†æ··æ·†åŠ èŠ±è¿™ç§æ‰‹æ®µæ˜¯æ— æ³•åšåˆ°åªè®©æœºå™¨è¯»æ‡‚ä»£ç è€Œäººè¯»ä¸æ‡‚è¿™ç§æ•ˆæœçš„ã€‚è¿™ä¸ªç»“è®ºå¿˜äº†æ˜¯å“ªç¯‡è®ºæ–‡é‡Œæåˆ°çš„äº†ã€‚&lt;/p>
&lt;p>æœ¬ç¯‡åªè®²å¦‚ä½•å¯¹æŠ—åæ±‡ç¼–ï¼Œä¹Ÿå°±æ˜¯èŠ±æŒ‡ä»¤æŠ€æœ¯ã€‚&lt;/p>
&lt;h2 id="0x01-èŠ±æŒ‡ä»¤åŸç†">0x01 èŠ±æŒ‡ä»¤åŸç†&lt;/h2>
&lt;h3 id="11-æœºå™¨ç æŒ‡ä»¤æ ¼å¼">1.1 æœºå™¨ç æŒ‡ä»¤æ ¼å¼&lt;/h3>
&lt;p>ç å†œæ—¥å¸¸å·¥ä½œæ¥è§¦çš„æ˜¯é«˜çº§è¯­è¨€ï¼ˆè¿™ä¸ªæ¦‚å¿µå¯èƒ½æœ‰äº‰è®®ï¼Œåæ­£ç›¸å¯¹æ±‡ç¼–ã€æœºå™¨ç è¿™ä¸ªå±‚çº§æ¥è¯´éƒ½æ˜¯é«˜çº§è¯­è¨€å°±å¯¹äº†ï¼‰ï¼Œæ±‡ç¼–å’Œæœºå™¨ç è¿™ç§æ»¡æ˜¯å†å²å°˜åŸƒçš„é¢†åŸŸæ˜¯ç»æ— æœºä¼šæ¥è§¦çš„ã€‚ä½†è¦ç†è§£èŠ±æŒ‡ä»¤ï¼Œé¦–å…ˆè¦ç†è§£æ±‡ç¼–ä»£ç çš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼Œæ‰ä¼šæ˜ç™½ä¸ºä»€ä¹ˆåæ±‡ç¼–å·¥å…·çš„åŠ›é‡æ˜¯æœ‰æé™çš„ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 178;
flex-basis: 429px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/learning-packer-07/zHClf.png" data-size="658x368">
&lt;img src="https://nnnewb.github.io/blog/blog/p/learning-packer-07/zHClf.png"
width="658"
height="368"
srcset="https://nnnewb.github.io/blog/blog/p/learning-packer-07/zHClf_hu3ca7a186b6a8e60fb2df5f6ffb33e0d4_25027_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/learning-packer-07/zHClf_hu3ca7a186b6a8e60fb2df5f6ffb33e0d4_25027_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="zHClf">
&lt;/a>
&lt;figcaption>zHClf&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>è¿™æ˜¯ Intel çš„ &lt;a class="link" href="https://www.intel.com/content/dam/www/public/us/en/documents/manuals/64-ia-32-architectures-software-developer-instruction-set-reference-manual-325383.pdf" target="_blank" rel="noopener"
>64-ia-32-architectures-software-developer-instruction-set-reference-manual&lt;/a> é‡Œçš„ä¸€å¼ å›¾ï¼Œè¯´æ˜äº†æ±‡ç¼–æŒ‡ä»¤å¦‚ä½•ä»¥äºŒè¿›åˆ¶å½¢å¼ä¿å­˜ã€‚å¯ä»¥ç®€å•çœ‹æˆ3éƒ¨åˆ†ï¼Œ1å­—èŠ‚çš„å¯é€‰å‰ç¼€ï¼Œ1-3å­—èŠ‚çš„opcodeéƒ¨åˆ†ï¼Œå‰©ä½™æè¿°æ“ä½œæ•°çš„éƒ¨åˆ†ã€‚&lt;/p>
&lt;p>å‡ ä¸ªè¦ç´ ï¼š&lt;/p>
&lt;ol>
&lt;li>æŒ‡ä»¤é•¿åº¦ä¸å›ºå®šï¼Œæœ€çŸ­ 1 å­—èŠ‚ï¼Œæœ€é•¿å¯èƒ½æœ‰ 14 ï¼ˆå›¾ä¸­å…¨éƒ¨ç›¸åŠ ï¼Œå®é™…ä¼šä¸ä¼šæœ‰æˆ‘å°±ä¸çŸ¥é“äº†ï¼‰ã€‚&lt;/li>
&lt;li>ä¸€æ¡&lt;strong>æ±‡ç¼–ä»£ç é‡Œçš„æŒ‡ä»¤&lt;/strong>å¯èƒ½å¯¹åº”å¾ˆå¤šä¸åŒçš„ opcode ï¼Œç®€å•åˆ° &lt;code>add&lt;/code> è¿™æ ·çš„æŒ‡ä»¤ä¹Ÿä¼šæœ‰å¾ˆå¤šç§ä¸åŒå½¢å¼ã€‚&lt;/li>
&lt;/ol>
&lt;p>ç†Ÿæ‚‰æœºå™¨ç æ ¼å¼åœ¨è‡ªå·±æ„é€ èŠ±æŒ‡ä»¤çš„æ—¶å€™å¤§æ¦‚ä¼šæœ‰ç”¨ï¼Œä½†å®è¯è¯´ Intel è¿™æ‰‹å†Œçœ‹å¾—æˆ‘å¤´ç—›ã€‚æ‰€ä»¥è¿˜æ˜¯ç›´æ¥å¿«è¿›åˆ°èŠ±æŒ‡ä»¤åŸç†ã€‚&lt;/p>
&lt;h3 id="12-èŠ±æŒ‡ä»¤åŸç†">1.2 èŠ±æŒ‡ä»¤åŸç†&lt;/h3>
&lt;p>èŠ±æŒ‡ä»¤çš„è‹±æ–‡æ˜¯ &lt;em>junk code&lt;/em> ï¼Œä¹Ÿå°±æ˜¯åƒåœ¾ä»£ç ã€‚å®é™…ä¸ŠèŠ±æŒ‡ä»¤çš„ç¡®æ˜¯ä¸€äº›ä¸å½±å“ç¨‹åºé€»è¾‘çš„ &lt;em>åƒåœ¾&lt;/em> æœºå™¨ç ï¼Œå®ƒå­˜åœ¨çš„å”¯ä¸€æ„ä¹‰å°±æ˜¯å¹²æ‰°åæ±‡ç¼–å¼•æ“å’Œäººè‚‰åˆ†æã€‚&lt;/p>
&lt;p>èŠ±æŒ‡ä»¤æœ‰ä¸¤ç§ç±»å‹ï¼š&lt;/p>
&lt;ul>
&lt;li>ä¸å¯æ‰§è¡Œçš„èŠ±æŒ‡ä»¤&lt;/li>
&lt;li>å¯æ‰§è¡Œçš„èŠ±æŒ‡ä»¤&lt;/li>
&lt;/ul>
&lt;p>å¬èµ·æ¥åƒæ˜¯åºŸè¯ä½†å®é™…ä¸Šæ„é€ è¿™ä¸¤ç§èŠ±æŒ‡ä»¤çš„éš¾åº¦æ˜¯å®Œå…¨ä¸ä¸€æ ·çš„ã€‚&lt;/p>
&lt;p>å¯¹äºä¸å¯æ‰§è¡Œçš„èŠ±æŒ‡ä»¤ï¼Œæœ¬è´¨ä¸Šæˆ‘ä»¬åšçš„äº‹æƒ…æ˜¯åœ¨è·³è½¬æŒ‡ä»¤ä¹‹åæ’å…¥ä¸€ä¸ªå¤šå­—èŠ‚æŒ‡ä»¤çš„å­—èŠ‚ï¼Œæ¬ºéª—åæ±‡ç¼–å™¨å°†è¿™ä¸ªå­—èŠ‚ä¹‹åçš„å‡ ä¸ªå­—èŠ‚å½“æˆä¸€ä¸ªå¤šå­—èŠ‚æŒ‡ä»¤è§£é‡Šï¼Œè¿›è€Œé€ æˆåç»­æŒ‡ä»¤åæ±‡ç¼–å‡ºé”™ã€‚&lt;/p>
&lt;p>è€Œå¯æ‰§è¡Œçš„èŠ±æŒ‡ä»¤ï¼Œæœ¬è´¨æ˜¯å°†æŒ‡ä»¤çš„ç»„æˆéƒ¨åˆ†é‡æ–°è§£é‡Šæ‰§è¡Œã€‚åƒæ˜¯ä¸€ä¸ª2å­—èŠ‚çš„è·³è½¬æŒ‡ä»¤ï¼Œç¬¬äºŒä¸ªå­—èŠ‚æ˜¯æ“ä½œæ•°ï¼Œä½†æ“ä½œæ•°å¯ä»¥æ˜¯ &lt;code>0xff&lt;/code>ï¼Œä¹Ÿå°±æ˜¯å¸¦ç¬¦å·çš„ &lt;code>-1&lt;/code>ï¼Œä½¿ EIP è½åœ¨ &lt;code>0xff&lt;/code> è¿™ä¸ªå­—èŠ‚ä¸Šï¼Œå°†&lt;code>0xff&lt;/code>ä½œä¸ºæŒ‡ä»¤ç»§ç»­æ‰§è¡Œã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­&lt;code>0xff&lt;/code>æ—¢å¯ä»¥è¢«å½“æˆæ•°å­—&lt;code>0xff&lt;/code>è§£é‡Šï¼Œä¹Ÿè¢«å½“æˆäº†æŒ‡ä»¤æ¥è§£é‡Šã€‚&lt;/p>
&lt;h3 id="13-åæ±‡ç¼–ç®—æ³•">1.3 åæ±‡ç¼–ç®—æ³•&lt;/h3>
&lt;p>ç›®å‰å¸¸è§åæ±‡ç¼–ç®—æ³•å°±ä¸¤ç±»ï¼Œä¸€ç±»æ˜¯çº¿æ€§åæ±‡ç¼–ï¼Œå¯¹è¾“å…¥çš„æ•°æ®é€å­—èŠ‚ç¿»è¯‘æˆæ±‡ç¼–ä»£ç ã€‚è¿™ç§åæ±‡ç¼–ç®—æ³•å¤šæ•°æ—¶å€™å·¥ä½œåœ°å¾ˆå¥½ï¼Œä½†å±äºè€å®äººï¼Œè®¤ä¸ºæŒ‡ä»¤æ€»æ˜¯ä¸€ä¸ªæ¥ä¸€ä¸ªå‡ºç°ï¼Œä¸€ä¸ªç®€å•åœ°åœ¨&lt;code>jmp&lt;/code>åæ’å…¥&lt;code>0xe8&lt;/code>å°±èƒ½éª—åˆ°ã€‚&lt;/p>
&lt;p>å¦ä¸€ç±»æ˜¯åŸºäºä»£ç æµåˆ†æçš„ç®—æ³•ï¼Œè¿™ç±»ç®—æ³•çš„ç‰¹ç‚¹æ˜¯ä¸ä¼šæ— è„‘åœ°ç»§ç»­åæ±‡ç¼–è·³è½¬æŒ‡ä»¤ä¹‹åçš„ä»£ç ï¼Œè€Œæ˜¯å»ä¼˜å…ˆåæ±‡ç¼– &lt;strong>å¯è¾¾&lt;/strong> çš„ä»£ç ã€‚åƒæ˜¯æˆ‘ä»¬åœ¨ C é‡Œé¢å†™ &lt;code>if (1) {} else { /* junk code */ }&lt;/code>ï¼Œå¯¹äºè¶³å¤Ÿèªæ˜çš„ç¼–è¯‘å™¨ï¼Œ&lt;code>else&lt;/code> åˆ†æ”¯å°±æ˜¯æ˜ç¡®æ— è¯¯çš„åƒåœ¾ã€‚å¯¹äºè¿™ç§åæ±‡ç¼–ç®—æ³•ï¼Œå¯ä»¥é€šè¿‡å¯æ‰§è¡Œçš„èŠ±æŒ‡ä»¤æ¥æ¬ºéª—ï¼Œæˆ–æ„é€ åæ±‡ç¼–å™¨æ— æ³•åˆ¤æ–­çœŸå‡çš„æ’çœŸ/æ’å‡åˆ†æ”¯ï¼Œå†æ’å…¥ä¸å¯æ‰§è¡Œçš„èŠ±æŒ‡ä»¤æ¥è¾¾åˆ°æ¬ºéª—æ•ˆæœã€‚&lt;/p>
&lt;h2 id="0x02-èŠ±æŒ‡ä»¤æ¡ˆä¾‹">0x02 èŠ±æŒ‡ä»¤æ¡ˆä¾‹&lt;/h2>
&lt;h3 id="21-e8-å’Œçº¿æ€§åæ±‡ç¼–ç®—æ³•">2.1 &lt;code>E8&lt;/code> å’Œçº¿æ€§åæ±‡ç¼–ç®—æ³•&lt;/h3>
&lt;p>&lt;code>E8&lt;/code> æ˜¯ &lt;code>call&lt;/code> æŒ‡ä»¤çš„ opcodeã€‚opcode &lt;em>operation code&lt;/em> ä¹Ÿå«æŒ‡ä»¤æœºå™¨ç  &lt;em>Instruction Machine Code&lt;/em>ï¼Œå°±æ˜¯æ±‡ç¼–æŒ‡ä»¤ç¿»è¯‘åçš„äºŒè¿›åˆ¶å½¢å¼ã€‚è´´ä¸€ä¸ª &lt;a class="link" href="https://en.wikipedia.org/wiki/X86_instruction_listings" target="_blank" rel="noopener"
>wiki ç™¾ç§‘çš„ x86 æŒ‡ä»¤åˆ—è¡¨&lt;/a> ä»¥ä¾›å‚è€ƒã€‚è¿˜æœ‰ &lt;a class="link" href="https://c9x.me/x86/html/file_module_x86_id_26.html" target="_blank" rel="noopener"
>x86 instruction set reference&lt;/a> ã€‚è¿˜æœ‰ &lt;a class="link" href="https://stackoverflow.com/questions/44882315/how-does-the-cpu-distinguish-call-rel16-e8-cw-and-call-rel32-e8-cd" target="_blank" rel="noopener"
>How does the CPU distinguish &amp;lsquo;CALL rel16&amp;rsquo; (E8 cw) and &amp;lsquo;CALL rel32&amp;rsquo; (E8 cd)?&lt;/a>&lt;/p>
&lt;p>æˆ‘ä»¬çš„ç¨‹åºè¿è¡Œåœ¨ç”¨æˆ·æ¨¡å¼ï¼ˆ32ä½ï¼‰æ¨¡å¼ä¸‹ï¼Œ&lt;code>E8&lt;/code> æŒ‡ä»¤åç´§è·Ÿç€çš„æ˜¯4å­—èŠ‚çš„ç›¸å¯¹åç§»ï¼Œä¸€æ¡å®Œæ•´çš„ &lt;code>E8&lt;/code> æŒ‡ä»¤ä¼šä½¿ç”¨ 5 ä¸ªå­—èŠ‚çš„ç©ºé—´ã€‚&lt;/p>
&lt;p>ä¸‹é¢æ˜¯ä¸€ä¸ª &lt;code>E8&lt;/code> èŠ±æŒ‡ä»¤çš„æ¡ˆä¾‹ï¼Œéœ€è¦ MinGW ç¼–è¯‘ï¼Œå¯¹ x32dbg æœ‰æ•ˆã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#define ANTI_LINEAR_DISASSEMBLE_ALGORITHM_1 asm(&amp;#34;jmp next\n.byte 0xe8;\nnext:\n&amp;#34;)
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">start&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">ANTI_LINEAR_DISASSEMBLE_ALGORITHM_1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç¼–è¯‘å‘½ä»¤&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">gcc demo.c &lt;span class="s1">&amp;#39;-Wl,--entry=_start&amp;#39;&lt;/span> -nodefaultlibs -nostartfiles -o demo
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è°ƒè¯•å™¨å†…çš„æ•ˆæœ&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 234;
flex-basis: 562px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/learning-packer-07/image-20211028152219524.png" data-size="1175x501">
&lt;img src="https://nnnewb.github.io/blog/blog/p/learning-packer-07/image-20211028152219524.png"
width="1175"
height="501"
srcset="https://nnnewb.github.io/blog/blog/p/learning-packer-07/image-20211028152219524_hu2408fa036d3a5e5647fcc1f6e2c0b730_66690_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/learning-packer-07/image-20211028152219524_hu2408fa036d3a5e5647fcc1f6e2c0b730_66690_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211028152219524">
&lt;/a>
&lt;figcaption>image-20211028152219524&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å¯ä»¥çœ‹åˆ°åœ¨ &lt;code>jmp&lt;/code> æŒ‡ä»¤åï¼Œåæ±‡ç¼–å‡ºäº†ä¸€æ¡ &lt;code>call&lt;/code> æŒ‡ä»¤ã€‚ä½†å®é™…ä¸Šæˆ‘ä»¬å†™çš„ä»£ç é‡Œæ˜¯æ²¡æœ‰ä»»ä½•å‡½æ•°è°ƒç”¨çš„ã€‚è€Œåœ¨è¿™ä¸ª &lt;code>E8&lt;/code> åé¢çš„ &lt;code>B8 00 00 00 00 5D C3&lt;/code> æ‰æ˜¯çœŸæ­£ä¼šæ‰§è¡Œçš„ä»£ç ï¼š&lt;/p>
&lt;pre>&lt;code>mov eax, 0 ; B8 00 00 00 00
pop ebp ; 5D
retn ; C3
&lt;/code>&lt;/pre>&lt;p>å‚è€ƒ&lt;a class="link" href="http://www.mathemainzel.info/files/x86asmref.html#pop" target="_blank" rel="noopener"
>intel 80x86 assembly language opcodes&lt;/a>ã€‚&lt;/p>
&lt;p>å¦‚æœä»”ç»†çœ‹ &lt;code>jmp&lt;/code> åçš„åç§» &lt;code>01&lt;/code> çš„è¯ä¹Ÿèƒ½çŒœåˆ°ä¸‹ä¸€ä¸ª &lt;code>E8&lt;/code> æ˜¯ä¸ä¼šè¢«æ‰§è¡Œçš„ã€‚&lt;/p>
&lt;p>åƒæ˜¯è¿™ç§ç®€å•çš„èŠ±æŒ‡ä»¤åœ¨ IDA é‡Œæ²¡ç”¨ï¼ŒIDA çš„åæ±‡ç¼–ç®—æ³•ä¼šæ ¹æ®æ§åˆ¶æµåˆ†ææ¥åˆ¤æ–­å“ªäº›å†…å®¹ä¸ä¼šè¢«æ‰§è¡Œï¼Œè¿›è€Œäº§ç”Ÿä¸‹é¢çš„ç»“æœã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 166;
flex-basis: 399px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/learning-packer-07/image-20211028153421508.png" data-size="796x478">
&lt;img src="https://nnnewb.github.io/blog/blog/p/learning-packer-07/image-20211028153421508.png"
width="796"
height="478"
srcset="https://nnnewb.github.io/blog/blog/p/learning-packer-07/image-20211028153421508_hu997bdc75332333c1639f8a4c89fbdacd_51145_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/learning-packer-07/image-20211028153421508_hu997bdc75332333c1639f8a4c89fbdacd_51145_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211028153421508">
&lt;/a>
&lt;figcaption>image-20211028153421508&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;h3 id="22--ida-å’Œä»£ç æµåæ±‡ç¼–ç®—æ³•">2.2 IDA å’Œä»£ç æµåæ±‡ç¼–ç®—æ³•&lt;/h3>
&lt;p>å…³äºIDAçš„åæ±‡ç¼–ç®—æ³•æè¿°æ˜¯æ¥è‡ªã€Šæ¶æ„ä»£ç åˆ†æå®æˆ˜ã€‹ã€‚&lt;/p>
&lt;blockquote>
&lt;p>å‰é¢è®¨è®ºçš„ç®€å•å¯¹æŠ—åæ±‡ç¼–æŠ€æœ¯æ˜¯å·§å¦™åœ°åœ¨æ¡ä»¶è·³è½¬æŒ‡ä»¤ä¹‹åæ”¾ä¸€ä¸ªå­—èŠ‚ï¼Œè¿™ç§æŠ€æœ¯çš„æ€è·¯æ˜¯ï¼Œä»è¿™ä¸ªå­—èŠ‚å¼€å§‹åæ±‡ç¼–ï¼Œé˜»æ­¢å…¶åçœŸæ­£çš„æŒ‡ä»¤è¢«åæ±‡ç¼–ï¼Œå› ä¸ºæ’å…¥çš„å­—èŠ‚æ˜¯ä¸€ä¸ªå¤šå­—èŠ‚æŒ‡ä»¤çš„æœºå™¨ç ã€‚æˆ‘ä»¬ç§°è¿™æ ·çš„å­—èŠ‚æ˜¯æµæ°“å­—èŠ‚ï¼Œå› ä¸ºå®ƒä¸å±äºç¨‹åºçš„ä¸€éƒ¨åˆ†ï¼Œåªæ˜¯ç”¨åœ¨ä»£ç æ®µè¿·æƒ‘åæ±‡ç¼–å™¨ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>IDAçš„åæ±‡ç¼–ç®—æ³•æ˜¯é’ˆå¯¹ä»£ç æµçš„åæ±‡ç¼–ï¼ŒåŸºæœ¬æ€è·¯æ˜¯è®°å½•åæ±‡ç¼–è¿‡ç¨‹ä¸­çš„è·³è½¬åœ°å€ä½œä¸ºä¸‹ä¸€æ¬¡åæ±‡ç¼–çš„èµ·ç‚¹ï¼Œå½“æ§åˆ¶æµè½¬ç§»ï¼ˆ&lt;code>jmp&lt;/code>ä¹‹ç±»çš„è·³è½¬æŒ‡ä»¤ï¼‰æ—¶ï¼Œå¹¶ä¸æ˜¯ä»è·³è½¬æŒ‡ä»¤ä¹‹åç»§ç»­åæ±‡ç¼–ï¼Œè€Œæ˜¯ä»ä¹‹å‰è®°å½•çš„è·³è½¬åœ°å€é‡Œé€‰ä¸€ä¸ªï¼Œå¼€å§‹æ–°çš„åæ±‡ç¼–å·¥ä½œã€‚å¦‚ä¸Šé¢çš„ &lt;code>jmp&lt;/code> + &lt;code>e8&lt;/code> å°±æ— æ³•å¯¹æŠ—è¿™ç§åæ±‡ç¼–ç®—æ³•ã€‚&lt;/p>
&lt;p>ç›®å‰å®è·µä¸­ä¹Ÿå‘ç°ï¼ŒIDA å·²ç»å¯ä»¥è¯†åˆ«å‡ºä¸€äº›ä¾‹å¦‚ &lt;code>jz&lt;/code>+&lt;code>jnz&lt;/code> åˆ¶é€ çš„æ— æ¡ä»¶è·³è½¬ï¼Œé€šè¿‡æ§åˆ¶æµæŒ‡ä»¤åˆ¶é€ æ’çœŸæˆ–æ’å‡æ¡ä»¶æ¥è·³è½¬å¤§æ¦‚ä¼šå¾€æ›´åŠ å¤æ‚ã€é«˜å¼€é”€çš„æ–¹å‘èµ°ï¼šæ¯”å¦‚åˆ©ç”¨ç³»ç»ŸAPIã€ç¯å¢ƒä¸­çš„å·²çŸ¥å¸¸é‡ä½œä¸ºæ¡ä»¶å»æ¬ºéª—IDAï¼Œè®© IDA æ— æ³•è½»æ˜“è®¤å®šæŸæ¡åˆ†æ”¯æ˜¯æ— æ•ˆåˆ†æ”¯ï¼Œè¿›è€Œå¹²æ‰°åæ±‡ç¼–ç»“æœã€‚&lt;/p>
&lt;p>é‚£ä¹ˆé™¤äº†æ’å…¥å¤šå­—èŠ‚æŒ‡ä»¤è¿˜æœ‰ä»€ä¹ˆåŠæ³•å¯¹æŠ—ä»£ç æµåˆ†æç®—æ³•å‘¢ï¼Ÿ&lt;/p>
&lt;blockquote>
&lt;p>&amp;hellip;ä½†æ˜¯ï¼Œå¦‚æœæµæ°“å­—èŠ‚ä¸èƒ½è¢«å¿½ç•¥æ€ä¹ˆåŠï¼Ÿå¦‚æœå®ƒæ˜¯åˆæ³•æŒ‡ä»¤çš„ä¸€éƒ¨åˆ†ï¼Œä¸”åœ¨è¿è¡Œæ—¶èƒ½å¤Ÿè¢«æ­£ç¡®æ‰§è¡Œæ€ä¹ˆåŠï¼Ÿè¿™é‡Œï¼Œæˆ‘ä»¬ç¢°åˆ°ä¸€ä¸ªæ£˜æ‰‹çš„é—®é¢˜ï¼Œæ‰€æœ‰ç»™å®šå­—èŠ‚éƒ½æ˜¯å¤šå­—èŠ‚æŒ‡ä»¤çš„ä¸€éƒ¨åˆ†ï¼Œè€Œä¸”å®ƒä»¬éƒ½èƒ½å¤Ÿè¢«æ‰§è¡Œã€‚ç›®å‰ä¸šå†…æ²¡æœ‰ä¸€ä¸ªåæ±‡ç¼–å™¨èƒ½å¤Ÿå°†å•ä¸ªå­—èŠ‚è¡¨ç¤ºä¸ºä¸¤æ¡æŒ‡ä»¤çš„ç»„æˆéƒ¨åˆ†ï¼Œç„¶è€Œå¤„ç†å™¨æ²¡æœ‰è¿™ç§é™åˆ¶ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>ä¸‹é¢æ˜¯ä¸€ä¸ªæ¡ˆä¾‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="p">.&lt;/span>&lt;span class="n">byte&lt;/span> &lt;span class="mh">0xeb&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mh">0xff&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mh">0xc0&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mh">0x48&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>0xeb&lt;/code> &lt;code>jmp&lt;/code> æŒ‡ä»¤çš„ opcodeï¼Œæ˜¯ä¸€ä¸ª 2 å­—èŠ‚æŒ‡ä»¤ã€‚&lt;code>0xff&lt;/code> è¢«è§£é‡Šä¸º &lt;code>-1&lt;/code>ã€‚&lt;/p>
&lt;p>&lt;code>0xff&lt;/code> æ˜¯ &lt;code>INC&lt;/code> çš„æœºå™¨ç ï¼Œ&lt;code>0xc0&lt;/code>æ˜¯æ“ä½œæ•°ï¼Œè¡¨ç¤º &lt;code>eax&lt;/code>ï¼Œä¹Ÿå°±æ˜¯ &lt;code>inc eax&lt;/code>ã€‚å¯ä»¥åœ¨è¿™ä¸ª&lt;a class="link" href="https://defuse.ca/online-x86-assembler.htm" target="_blank" rel="noopener"
>åœ¨çº¿åæ±‡ç¼–&lt;/a>ç½‘ç«™ä¸ŠéªŒè¯ã€‚&lt;/p>
&lt;p>&lt;code>0x48&lt;/code> åˆ™æ˜¯ &lt;code>dec eax&lt;/code> çš„æ±‡ç¼–æŒ‡ä»¤ï¼Œå› æ­¤è¿™4ä¸ªå­—èŠ‚æ‰§è¡Œåæœ€ç»ˆä¸ä¼šå½±å“ &lt;code>eax&lt;/code> çš„å€¼ã€‚&lt;/p>
&lt;p>åœ¨è¿™é‡Œï¼Œ&lt;code>0xff&lt;/code> åŒæ—¶è¢«è§£é‡Šä¸º &lt;code>jmp&lt;/code> çš„æ“ä½œæ•°å’Œ &lt;code>inc&lt;/code> æŒ‡ä»¤ï¼Œå¹¶ä¸”èƒ½æ­£å¸¸æ‰§è¡Œï¼Œä½†åæ±‡ç¼–å™¨åˆ™ä¼šè¢«è¿·æƒ‘ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 514;
flex-basis: 1233px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/learning-packer-07/image-20211030211603863.png" data-size="910x177">
&lt;img src="https://nnnewb.github.io/blog/blog/p/learning-packer-07/image-20211030211603863.png"
width="910"
height="177"
srcset="https://nnnewb.github.io/blog/blog/p/learning-packer-07/image-20211030211603863_huc23cc312a3844059e36c75b9cf995c65_26582_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/learning-packer-07/image-20211030211603863_huc23cc312a3844059e36c75b9cf995c65_26582_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211030211603863">
&lt;/a>
&lt;figcaption>image-20211030211603863&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>ä¸Šå›¾æ˜¯IDAä¸­åæ±‡ç¼–çš„ç»“æœã€‚&lt;/p>
&lt;h3 id="23-æ„é€ èƒ½æ¬ºéª—idaçš„èŠ±æŒ‡ä»¤">2.3 æ„é€ èƒ½æ¬ºéª—IDAçš„èŠ±æŒ‡ä»¤&lt;/h3>
&lt;p>æ„é€ èƒ½æ¬ºéª—IDAçš„èŠ±æŒ‡ä»¤ç®€å•çš„åŠæ³•å°±æ˜¯æ„é€ æ— æ³•è¢«é™æ€åˆ†æçš„æ’çœŸ/æ’å‡æ¡ä»¶ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œ&lt;code>LoadLibraryA&lt;/code> åŠ è½½å¤±è´¥ä¼šè¿”å› &lt;code>NULL&lt;/code>ï¼Œå°±å¯ä»¥è¢«ç”¨æ¥æ„é€ èŠ±æŒ‡ä»¤ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c"> &lt;span class="n">LoadLibraryA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;not-exists.dll&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">asm&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;test %eax,%eax;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">jz next;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">.byte 0xe8;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">next:&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 357;
flex-basis: 858px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/learning-packer-07/image-20211030213109569.png" data-size="955x267">
&lt;img src="https://nnnewb.github.io/blog/blog/p/learning-packer-07/image-20211030213109569.png"
width="955"
height="267"
srcset="https://nnnewb.github.io/blog/blog/p/learning-packer-07/image-20211030213109569_huae46ff5cf7f405ad977cb15ab7a51e13_39907_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/learning-packer-07/image-20211030213109569_huae46ff5cf7f405ad977cb15ab7a51e13_39907_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211030213109569">
&lt;/a>
&lt;figcaption>image-20211030213109569&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å¯ä»¥çœ‹åˆ°ï¼ŒIDAä¸èƒ½é™æ€åˆ†æå‡º&lt;code>LoadLibraryA&lt;/code> çš„è¿”å›å€¼æ˜¯ &lt;code>NULL&lt;/code>ï¼Œé¡ºç€ &lt;code>jz&lt;/code> çš„ False åˆ†æ”¯åæ±‡ç¼–æ—¶é‡åˆ°äº† &lt;code>0xe8&lt;/code>ï¼Œäºæ˜¯åç»­çš„åæ±‡ç¼–ç»“æœå°±å®Œå…¨ä¹±äº†å¥—ã€‚&lt;/p>
&lt;h3 id="24-ç ´åæ ˆå¸§åˆ†æ">2.4 ç ´åæ ˆå¸§åˆ†æ&lt;/h3>
&lt;p>è¿˜æœ‰ä¸€ç§èŠ±æŒ‡ä»¤æ˜¯é€šè¿‡å¯¹ &lt;code>call&lt;/code> å’Œ &lt;code>ret&lt;/code> åˆ©ç”¨æ¥å®ç°ç ´åæ ˆå¸§åˆ†æã€‚å¤§å®¶éƒ½çŸ¥é“ &lt;code>call&lt;/code> å’Œ &lt;code>ret&lt;/code> å°±æ˜¯ &lt;code>push&lt;/code>+&lt;code>jmp&lt;/code>å’Œ&lt;code>pop&lt;/code>+&lt;code>jmp&lt;/code>ï¼Œå¦‚æœæˆ‘ä»¬æ‰‹åŠ¨åœ¨å‡½æ•°é‡Œå†æ„é€ ä¸€ä¸ªå‡å‡½æ•°ï¼Œè·³è½¬ä¹‹åä¿®æ”¹æ ˆä¸Šçš„è¿”å›åœ°å€ï¼Œè¿”å›åˆ°æˆ‘ä»¬å¸Œæœ›ç»§ç»­æ‰§è¡Œçš„ä½ç½®ï¼Œè™½ç„¶æœ¬è´¨ä¸Šæ˜¯ä¸ª GOTO çš„æ“ä½œï¼Œä½† IDA å°±ä¼šæ‡µåœˆäº†ã€‚&lt;/p>
&lt;p>ä¸€ä¸ªç®€å•çš„ä¾‹å­å¦‚ä¸‹ï¼Œ&lt;code>call&lt;/code>è·³è½¬åˆ°ä¸‹ä¸€è¡Œï¼Œä¿®æ”¹è¿”å›åœ°å€åˆ° &lt;code>continue&lt;/code> ååˆ&lt;code>ret&lt;/code>ï¼Œç»“æœå°±æ˜¯åœ¨ &lt;code>continue&lt;/code> è¿™ä¸ªæ ‡ç­¾å¤„ç»§ç»­æ‰§è¡Œã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c"> &lt;span class="k">asm&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;call next;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;next:&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;movl $continue,(%esp);&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;ret;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;continue:&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>
&lt;span class="p">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>äº§ç”Ÿçš„ä»£ç åœ¨IDAé‡Œåˆ†æä¼šå‡ºç°è¿™æ ·çš„ &lt;code>sp-analysis failed&lt;/code>ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 162;
flex-basis: 390px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/learning-packer-07/image-20211030215415946.png" data-size="529x325">
&lt;img src="https://nnnewb.github.io/blog/blog/p/learning-packer-07/image-20211030215415946.png"
width="529"
height="325"
srcset="https://nnnewb.github.io/blog/blog/p/learning-packer-07/image-20211030215415946_hu1b68fd95622716000a3ab92e85a1f3fd_15293_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/learning-packer-07/image-20211030215415946_hu1b68fd95622716000a3ab92e85a1f3fd_15293_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211030215415946">
&lt;/a>
&lt;figcaption>image-20211030215415946&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>è¿™ä¸ªæ€è·¯å¯ä»¥åå¤åµŒå¥—ï¼Œå¢åŠ è·³è½¬çš„æ¬¡æ•°å’Œæ·±åº¦ï¼Œç”šè‡³æŠŠæ­£å¸¸é€»è¾‘éšè—åœ¨è¿™ç§åå¤è·³è½¬ä¸­ï¼Œä½†ä»é«˜çº§è¯­è¨€å±‚é¢æ‰‹å·¥åŠ è¿™ç§èŠ±å¾ˆå›°éš¾ã€‚&lt;/p>
&lt;p>å†ç»™ä¸€ä¸ªå¤æ‚ä¸€äº›çš„ä¾‹å­ï¼ŒåŒæ ·æ˜¯åˆ©ç”¨äº† &lt;code>call&lt;/code> å’Œ &lt;code>ret&lt;/code> æ¥å®ç°èŠ±å¼è·³è½¬ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 219;
flex-basis: 526px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/learning-packer-07/165417l97li97iwq8lf5qz.png" data-size="836x381">
&lt;img src="https://nnnewb.github.io/blog/blog/p/learning-packer-07/165417l97li97iwq8lf5qz.png"
width="836"
height="381"
srcset="https://nnnewb.github.io/blog/blog/p/learning-packer-07/165417l97li97iwq8lf5qz_hua1e400469607dff71cf186bb43cf99f2_16220_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/learning-packer-07/165417l97li97iwq8lf5qz_hua1e400469607dff71cf186bb43cf99f2_16220_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="img">
&lt;/a>
&lt;figcaption>img&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æ¥è‡ª52è®ºå›çš„ï¼š&lt;a class="link" href="https://www.52pojie.cn/forum.php?mod=viewthread&amp;amp;tid=1068444&amp;amp;highlight=%BB%A8%D6%B8%C1%EE" target="_blank" rel="noopener"
>ä¸€äº›ç®€å•çš„èŠ±æŒ‡ä»¤çš„è§£æ(å«IntelæŒ‡ä»¤é›†) - ã€ç—…æ¯’åˆ†æåŒºã€ - å¾çˆ±ç ´è§£ - LCG - LSG |å®‰å“ç ´è§£|ç—…æ¯’åˆ†æ|www.52pojie.cn&lt;/a>ã€‚&lt;/p>
&lt;p>é¡ºä¾¿ä¸€æï¼Œé“¾æ¥é‡Œé‚£ä¸ª &lt;code>pop ss&lt;/code> ä¹Ÿå¾ˆæœ‰æ„æ€ï¼ŒGrandCrab çš„æ¡ˆä¾‹ä¹Ÿæ˜¯ç»“åˆäº†å¤šç§æ§åˆ¶æµæŒ‡ä»¤æ¥å®Œæˆè·³è½¬ï¼Œé˜»ç¢IDAåˆ†æã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>é¦–å…ˆï¼Œä¸åªæ˜¯E8ï¼Œä¸è¦å±€é™åœ¨è¿™é‡Œã€‚æ‰€æœ‰çš„å¤šå­—èŠ‚æŒ‡ä»¤éƒ½å¯ä»¥ç”¨æ¥æ„é€ èŠ±æŒ‡ä»¤ã€‚èŠ±æŒ‡ä»¤ä¹Ÿä¸åªæ˜¯åˆ©ç”¨å¤šå­—èŠ‚æŒ‡ä»¤å¹²æ‰°åæ±‡ç¼–ï¼Œä¹Ÿèƒ½ç²¾å¿ƒä¼ªé€ æ§åˆ¶æµå¯¹æŠ—åˆ†æå·¥å…·çš„å…¶ä»–é«˜çº§åˆ†æåŠŸèƒ½ï¼Œè¿«ä½¿åˆ†æè€…ä¸èƒ½æ— è„‘F5è¯»ä¼ªä»£ç ï¼Œæ¶ˆç£¨åˆ†æè€…çš„æ—¶é—´ã€ç²¾åŠ›ã€è€å¿ƒã€‚&lt;/p>
&lt;p>èŠ±æŒ‡ä»¤æœ‰å¾ˆå¤šæ¨¡å¼ï¼Œä½†ä¸€ä¸ªæ˜¾è‘—ç‰¹å¾æ˜¯ &lt;strong>è·³è½¬&lt;/strong>ï¼Œå¿…é¡»é€šè¿‡è·³è½¬æŒ‡ä»¤æ¥å®ç°è¶Šè¿‡ä¸å¯æ‰§è¡Œçš„èŠ±æŒ‡ä»¤ï¼Œæˆ–é€šè¿‡è·³è½¬æ¥å®ç°é‡æ–°è§£é‡Šå·²ç»è¢«è§£é‡Šè¿‡çš„æŒ‡ä»¤çš„ä¸€éƒ¨åˆ†ï¼Œä»¥åŠé€šè¿‡è¿ç»­è·³è½¬æ¥éšè—çœŸå®è·³è½¬åœ°å€ã€‚æ‰€ä»¥çœ‹åˆ°è«åå…¶å¦™åœ°å¼€å§‹è·³èµ·æ¥å°±è¦è­¦æƒ•äº†ï¼Œè¿™ä¼šå„¿å¾ˆå¯èƒ½æ­£åœ¨åˆ†ææ— æ•ˆçš„åƒåœ¾ä»£ç ã€‚&lt;/p>
&lt;p>ç¼–å†™èŠ±æŒ‡ä»¤çš„æ—¶å€™åº”è¯¥æ³¨æ„åˆ°ï¼ŒèŠ±æŒ‡ä»¤å¯¹æŠ—çš„ç›®æ ‡ä¸æ˜¯åˆ†æå·¥å…·ï¼Œè€Œæ˜¯åˆ†æè€…ã€‚ç®€å•åœ°å†™ä¸€ä¸ª&lt;code>jz&lt;/code>å’Œ&lt;code>E8&lt;/code>ä¹Ÿè®¸å®ç°äº†è®©åˆ†æå·¥å…·å‡ºé”™çš„ç›®çš„ï¼Œä½†åˆ†æè€…ä¸€çœ¼å°±èƒ½çœ‹å‡ºè¿™æ˜¯æ— æ•ˆä»£ç ï¼ŒåŸºæœ¬æ— æ³•èµ·åˆ°å¯¹æŠ—ä½œç”¨ã€‚&lt;/p>
&lt;p>å‚è€ƒèµ„æ–™ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;a class="link" href="https://book.douban.com/subject/25868289/" target="_blank" rel="noopener"
>æ¶æ„ä»£ç åˆ†æå®æˆ˜ (è±†ç“£) (douban.com)&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://www.cnblogs.com/onetrainee/p/12175257.html" target="_blank" rel="noopener"
>ä¸€ä¸ªåˆ©ç”¨call+retä¿®æ”¹è¿”å›åœ°å€çš„èŠ±æŒ‡ä»¤åˆ†æ - OneTrainee - åšå®¢å›­ (cnblogs.com)&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://www.52pojie.cn/forum.php?mod=viewthread&amp;amp;tid=1068444&amp;amp;highlight=%BB%A8%D6%B8%C1%EE" target="_blank" rel="noopener"
>ä¸€äº›ç®€å•çš„èŠ±æŒ‡ä»¤çš„è§£æ(å«IntelæŒ‡ä»¤é›†) - ã€ç—…æ¯’åˆ†æåŒºã€ - å¾çˆ±ç ´è§£ - LCG - LSG |å®‰å“ç ´è§£|ç—…æ¯’åˆ†æ|www.52pojie.cn&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://www.intel.com/content/www/us/en/develop/download/intel-64-and-ia-32-architectures-sdm-combined-volumes-1-2a-2b-2c-2d-3a-3b-3c-3d-and-4.html" target="_blank" rel="noopener"
>Combined Volume Set of IntelÂ® 64 and IA-32 Architectures Software Developerâ€™s Manuals&lt;/a>&lt;/li>
&lt;li>[&lt;a class="link" href="https://bbs.pediy.com/thread-113402.htm" target="_blank" rel="noopener"
>åŸåˆ›]æ±‡ç¼–æŒ‡ä»¤ä¹‹OpCodeå¿«é€Ÿå…¥é—¨-è½¯ä»¶é€†å‘-çœ‹é›ªè®ºå›-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|bbs.pediy.com&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://www.felixcloutier.com/x86/" target="_blank" rel="noopener"
>x86 and amd64 instruction reference (felixcloutier.com)&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="http://www.mathemainzel.info/files/x86asmref.html" target="_blank" rel="noopener"
>Intel 80x86 Assembly Language OpCodes (mathemainzel.info)&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://defuse.ca/online-x86-assembler.htm" target="_blank" rel="noopener"
>online x86 disassembler&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://www.docin.com/p-748789332.html" target="_blank" rel="noopener"
>èŠ±æŒ‡ä»¤æ¨¡ç³Šå˜æ¢ç­–ç•¥ç ”ç©¶ä¸å®ç° - è±†ä¸ç½‘ (docin.com)&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>ç‰¹åˆ«æ¨èæœ€åè¿™ç¯‡è®ºæ–‡ï¼Œæˆ‘æ²¡æ‰¾åˆ°åœ¨å“ªå„¿èƒ½ä¸‹ï¼Œå°±æ”¾åŸé“¾æ¥äº†ã€‚ç›´æ¥ç™¾åº¦å­¦æœ¯æœèŠ±æŒ‡ä»¤ä¹Ÿèƒ½æ‰¾åˆ°å¾ˆå¤šæœ‰æ„æ€çš„æ–‡ç« ï¼ˆå°½ç®¡å½¢å¼åŒ–æè¿°çš„éƒ¨åˆ†åŸºæœ¬éƒ½æ²¡çœ‹æ‡‚ï¼‰ã€‚&lt;/p>
&lt;p>è‡ªåŠ¨åŒ–çš„åŠ èŠ±æ–¹å¼åŸºæœ¬è¦æ±‚åœ¨æ±‡ç¼–å±‚é¢å»é‡æ’ä»£ç æˆ–è€…æ’å…¥ä»£ç ï¼Œç›´æ¥åœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸ŠåŠ èŠ±æˆ‘å¯»æ€äº†ä¸€ä¸‹æ˜¯è›®éš¾çš„ï¼Œä¸»è¦æ˜¯æ­£å¸¸ç¨‹åºä»£ç æ®µé‡Œéšä¾¿æ’ä¸œè¥¿çš„è¯ï¼Œé‡å®šä½å’Œé‡æ–°ç®—å„ç§æ–‡ä»¶å­—æ®µå¾ˆéº»çƒ¦ã€‚æ‰€ä»¥å§&amp;hellip;å¤§æ¦‚åœ¨ç¼–è¯‘å™¨å±‚é¢ï¼ˆLLVMï¼Ÿæˆ–è€…å¯¹ç”Ÿæˆçš„æ±‡ç¼–æ–‡ä»¶ä¸‹æ‰‹ï¼‰æ‰ä¼šæ¯”è¾ƒå¥½æ–½å±•å¼€ã€‚&lt;/p></description></item><item><title>åŠ å£³åŸç†06ï¼šåè°ƒè¯•æŠ€æœ¯å…¥é—¨</title><link>https://nnnewb.github.io/blog/p/learning-packer-06/</link><pubDate>Wed, 27 Oct 2021 19:50:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/learning-packer-06/</guid><description>&lt;img src="https://nnnewb.github.io/blog/p/learning-packer-06/cover.jpg" alt="Featured image of post åŠ å£³åŸç†06ï¼šåè°ƒè¯•æŠ€æœ¯å…¥é—¨" />&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>åè°ƒè¯•æŠ€æœ¯ï¼Œå¾€å¤§äº†è¯´æ˜¯ç”¨å°½ä¸€åˆ‡æ‰‹æ®µé˜²æ­¢è¿è¡Œæ—¶å¯¹ç¨‹åºçš„éæ³•ç¯¡æ”¹å’Œçª¥è§†ï¼Œå¾€å°äº†è¯´å°±æ˜¯é˜²è°ƒè¯•å™¨ã€‚åæ­£åè°ƒè¯•è¿™ä»¶äº‹å’Œå„ç§æŠ€æœ¯éƒ½èƒ½æ­ç‚¹è¾¹ï¼Œä»€ä¹ˆHOOKå•¦DLLæ³¨å…¥å•¦ã€‚çœŸè¦ç»™æ¶‰åŠåˆ°çš„å„æ–¹é¢éƒ½è¯´å¾—å¤´å¤´æ˜¯é“ï¼Œé‚£æˆ‘è¿™ä¸ªèœé¸¡å°±ä¸å«èœé¸¡äº†ã€‚&lt;/p>
&lt;p>åæ­£æ¶‰åŠçš„å„ç§æŠ€æœ¯ç»†èŠ‚å§ï¼Œå°†æ¥éƒ½ä¼šæ…¢æ…¢å­¦åˆ°çš„ã€‚ä¹Ÿä¸æ€¥äºä¸€æ—¶ã€‚æœ¬ç¯‡å…³æ³¨çš„é‡ç‚¹è¿˜æ˜¯åœ¨å¯¼ï¼Œå¼•å…¥ï¼Œäº†è§£ä¸ªå¤§æ¦‚ã€‚çœ‹çœ‹æœ‰ä»€ä¹ˆåè°ƒè¯•æ€è·¯ï¼Œå¯¹ä»˜è¿™äº›åè°ƒè¯•æŠ€æœ¯åˆæœ‰ä»€ä¹ˆ bypass çš„æ‰‹æ®µã€‚&lt;/p>
&lt;p>è¯´è¿™ä¹ˆå¤šï¼Œå…¶å®è¿˜æ˜¯æ‰¾äº†ç¯‡å†™å¾—ä¸é”™çš„å¤–æ–‡æ–‡ç« ï¼ŒæŠ„äº†ç„¶åè°ƒè¯•äº†ä¸‹æ¡ˆä¾‹ã€‚&lt;/p>
&lt;h2 id="0x01-åè°ƒè¯•æ€è·¯">0x01 åè°ƒè¯•æ€è·¯&lt;/h2>
&lt;p>é¦–å…ˆæ¦‚è¿°ä¸€ä¸‹æœ¬ç¯‡ä¸»è¦çš„åè°ƒè¯•æ€è·¯ã€‚&lt;/p>
&lt;h3 id="11-ç³»ç»Ÿapiæˆ–æ•°æ®ç»“æ„">1.1 ç³»ç»ŸAPIæˆ–æ•°æ®ç»“æ„&lt;/h3>
&lt;p>æ“ä½œç³»ç»Ÿæä¾›äº†ä¸€äº›è°ƒè¯•æ ‡å¿—ä½ï¼Œè°ƒè¯•å™¨å¯åŠ¨çš„è¿›ç¨‹ä¼šæœ‰æ ‡è¯†ã€‚è°ƒè¯•å™¨ä¹Ÿå¯èƒ½ä¼šä¸ºäº†æä¾›æ›´å¥½çš„è°ƒè¯•ä½“éªŒï¼Œä¿®æ”¹ä¸€äº›å‚æ•°ï¼Œè®©æˆ‘ä»¬æœ‰è¿¹å¯å¾ªã€‚&lt;/p>
&lt;ol>
&lt;li>&lt;code>PEB-&amp;gt;BeingDebugged&lt;/code>å’Œ&lt;code>IsDebuggerPresent&lt;/code>&lt;/li>
&lt;li>&lt;code>PEB-&amp;gt;NtGlobalFlag&lt;/code>&lt;/li>
&lt;li>&lt;code>PEB-&amp;gt;HEAP-&amp;gt;Flags&lt;/code>å’Œ&lt;code>PEB-&amp;gt;HEAP-&amp;gt;ForceFlags&lt;/code>&lt;/li>
&lt;li>&lt;code>CheckRemoteDebuggerPresent&lt;/code>&lt;/li>
&lt;li>&lt;code>NtQueryInformationProcess&lt;/code>
&lt;ol>
&lt;li>&lt;code>ProcessDebugPort&lt;/code>&lt;/li>
&lt;li>&lt;code>ProcessDebugObjectHandle&lt;/code>&lt;/li>
&lt;li>&lt;code>ProcessDebugFlags&lt;/code>&lt;/li>
&lt;li>&lt;code>ProcessBasicInformation&lt;/code>&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>&lt;code>NtSetInformationThread&lt;/code>å’Œ&lt;code>NtCreateThreadEx&lt;/code>
&lt;ol>
&lt;li>åˆ©ç”¨ &lt;code>HideFromDebugger&lt;/code> æ ‡å¿—ä½æ¥å¯¹è°ƒè¯•å™¨éšè—è‡ªèº«ã€‚&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ol>
&lt;h3 id="12-sehveh">1.2 SEHã€VEH&lt;/h3>
&lt;p>æ€»çš„æ¥è¯´ï¼Œåˆ©ç”¨ SEH å’Œ VEH æœºåˆ¶ï¼Œå°è¯•æŠ›å‡ºä¸€äº›ä¼šè¢«è°ƒè¯•å™¨å¤„ç†çš„ä¸­æ–­æˆ–å¼‚å¸¸ï¼ŒåŒæ—¶è‡ªå·±æŒ‚ä¸€ä¸ªå¤„ç†å‡½æ•°ï¼Œå¦‚æœå¼‚å¸¸è¢«è°ƒè¯•å™¨æ•è·äº†ï¼Œé‚£è‡ªå·±æŒ‚çš„å¼‚å¸¸å¤„ç†å‡½æ•°å°±ä¸ä¼šè¢«è°ƒç”¨ï¼Œå€Ÿæ­¤åˆ¤æ–­æ˜¯å¦æœ‰è°ƒè¯•å™¨æ­£åœ¨è°ƒè¯•ç¨‹åºã€‚&lt;/p>
&lt;ol>
&lt;li>&lt;code>TF&lt;/code>æ ‡å¿—ä½å’Œ&lt;code>INT 1&lt;/code>ä¸­æ–­&lt;/li>
&lt;li>&lt;code>INT 3&lt;/code> ä¸­æ–­å’Œ SEH å¤„ç†å‡½æ•°ï¼Œ&lt;code>__try __except&lt;/code> æˆ– MinGW çš„ &lt;code>__try1 __except1&lt;/code>ï¼Œé¡ºä¾¿ä¸€ææˆ‘çš„SEHå®éªŒæ²¡æˆåŠŸã€‚ä½†æ˜¯ VEH åŸºæœ¬æ²¡é—®é¢˜ã€‚&lt;/li>
&lt;li>&lt;code>DBG_PRINTEXCEPTION_WIDE_C&lt;/code>å’Œ&lt;code>DBG_PRINTEXCEPTION_W&lt;/code>ï¼ŒWindows 10 &lt;code>OutputDebugString&lt;/code> åˆ©ç”¨äº†è¿™ä¸ª Exception æ¥æŠ›å‡ºè°ƒè¯•å­—ç¬¦ä¸²ã€‚&lt;/li>
&lt;li>&lt;code>EXCEPTION_INVALID_HANDLE&lt;/code>&lt;/li>
&lt;/ol>
&lt;h3 id="13-è°ƒè¯•å¯„å­˜å™¨">1.3 è°ƒè¯•å¯„å­˜å™¨&lt;/h3>
&lt;p>&lt;code>GetThreadContext&lt;/code> è·å–å½“å‰ä¸Šä¸‹æ–‡ï¼Œåˆ¤æ–­ &lt;code>Dr0&lt;/code>-&lt;code>Dr3&lt;/code>å¯„å­˜å™¨çš„å€¼ã€‚&lt;/p>
&lt;h3 id="14-å®Œæ•´æ€§æ ¡éªŒ">1.4 å®Œæ•´æ€§æ ¡éªŒ&lt;/h3>
&lt;p>åŸç†æ˜¯è°ƒè¯•å™¨é€šè¿‡ä¸´æ—¶ä¿®æ”¹æ–­ç‚¹å¤„æŒ‡ä»¤ä¸ºä¸­æ–­æ¥å–å¾—ç¨‹åºæ§åˆ¶æƒï¼Œå¯ä»¥ç”¨CRCæ ¡éªŒï¼Œæˆ–è€…æ›´ç®€å•ç‚¹ï¼Œç›´æ¥é€å­—èŠ‚æ±‚å’Œï¼Œåˆ¤æ–­ä»£ç æ˜¯å¦è¢«ç¯¡æ”¹ã€‚&lt;/p>
&lt;h2 id="0x02-ç³»ç»Ÿapiæ–¹å¼">0x02 ç³»ç»ŸAPIæ–¹å¼&lt;/h2>
&lt;h3 id="21-isdebuggerpresent">2.1 IsDebuggerPresent&lt;/h3>
&lt;p>é¦–å…ˆå‡ºåœºçš„å°±æ˜¯ &lt;code>IsDebuggerPresent&lt;/code> è¿™ä¸ª API äº†ï¼Œæ–‡æ¡£&lt;a class="link" href="https://docs.microsoft.com/en-us/windows/win32/api/debugapi/nf-debugapi-isdebuggerpresent" target="_blank" rel="noopener"
>å¯ä»¥åœ¨è¿™é‡Œ&lt;/a>æ‰¾åˆ°ã€‚ç®€è¦æ¦‚è¿°ä¸€ä¸‹è¿™ä¸ªæ¥å£ï¼Œå¾®è½¯çš„æè¿°æ˜¯æ­¤å‡½æ•°å…è®¸åº”ç”¨ç¨‹åºç¡®å®šè‡ªå·±æ˜¯å¦æ­£åœ¨è¢«è°ƒè¯•ï¼Œå¹¶ä¾æ­¤æ”¹å˜è¡Œä¸ºã€‚ä¾‹å¦‚é€šè¿‡&lt;code>OutputDebugString&lt;/code>å‡½æ•°æä¾›æ›´å¤šè°ƒè¯•ä¿¡æ¯ã€‚&lt;/p>
&lt;p>å¾®è½¯çš„æœ¬æ„åº”è¯¥æ˜¯ä¸€ä¸ªè°ƒè¯•å¼€å…³å¼çš„ä¸œè¥¿ï¼Œæ­£ç»å†™è¿‡å·¥ä½œä»£ç åº”è¯¥çŸ¥é“ä»£ç é‡ŒåŠ ä¸ªè°ƒè¯•å¼€å…³æ–¹ä¾¿åœ¨å‡ºé—®é¢˜çš„æ—¶å€™æ‹¿è¯¦ç»†æ—¥å¿—æ˜¯å¾ˆæœ‰ç”¨å¾ˆæ–¹ä¾¿çš„ï¼ŒåŒæ—¶ä¹Ÿèƒ½åœ¨ä¸éœ€è¦è°ƒè¯•çš„æ—¶å€™ä¹Ÿä¸ä¼šè®©ç¨‹åºä¸ä¼šæŸå¤±å¤ªå¤šæ€§èƒ½ã€‚æ¯”èµ·ç¼–è¯‘æœŸçš„è°ƒè¯•å¼€å…³&lt;code>_DEBUG&lt;/code>å®ä¹‹ç±»çš„ä¼šæ›´çµæ´»ä¸€äº›ã€‚&lt;/p>
&lt;p>æ‰¯è¿œäº†ã€‚æ€»ä¹‹ï¼Œè¿™ä¸ªå‡½æ•°æ²¡å‚æ•°ï¼Œè¿”å›&lt;code>BOOL&lt;/code>ï¼Œæ¡ˆä¾‹å¾ˆå¥½å†™ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;debugapi.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">anti_debug_by_isDebuggerPresent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IsDebuggerPresent&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">TRUE&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">MessageBoxA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;debugger detected&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;IsDebuggerPresent&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MB_OK&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å°±æ˜¯è¿™æ ·ã€‚&lt;/p>
&lt;p>&lt;code>IsDebuggerPresent&lt;/code> è¿™ä¸ª API çš„å®ç°æ–¹å¼æ˜¯ä» PEB &lt;em>Process Environment Block&lt;/em> è¯»å– &lt;code>BeingDebugged&lt;/code> å­—æ®µã€‚éšä¾¿ä»€ä¹ˆè°ƒè¯•å™¨è·³è½¬è¿‡å»å°±èƒ½çœ‹åˆ°è¿™æ ·çš„å®ç°ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nf">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="no">ptr&lt;/span> &lt;span class="no">fs&lt;/span>&lt;span class="p">:[&lt;/span>&lt;span class="mi">0x30&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nf">movzx&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">byte&lt;/span> &lt;span class="no">ptr&lt;/span> &lt;span class="no">ds&lt;/span>&lt;span class="p">:[&lt;/span>&lt;span class="no">eax&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">0x2&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nf">ret&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>fs:[0]&lt;/code>æ˜¯ TEB &lt;em>Thread Environment Block&lt;/em> ç»“æ„çš„åœ°å€ï¼Œå…¶ä¸­&lt;code>fs:[0x30]&lt;/code> è¿™ä¸ªåç§»æ˜¯ PEB æŒ‡é’ˆï¼Œç¬¬ä¸€è¡Œçš„æ„æ€æ˜¯å°† PEB æŒ‡é’ˆèµ‹å€¼ç»™ eax å¯„å­˜å™¨ã€‚&lt;/p>
&lt;p>ç¬¬äºŒè¡Œå°±æ˜¯ä» PEB ç»“æ„çš„ 0x2 åç§»å¤„ï¼Œä¹Ÿå°±æ˜¯ &lt;code>BeingDebugged&lt;/code> å­—æ®µï¼Œå– 1 å­—èŠ‚ï¼Œèµ‹å€¼åˆ° eax ã€‚&lt;/p>
&lt;p>ç¬¬ä¸‰è¡Œå°±æ˜¯è¿”å›äº†ï¼Œæ²¡æœ‰å‚æ•°å’Œå±€éƒ¨å˜é‡æ‰€ä»¥ä¹Ÿæ²¡å¹³æ ˆï¼Œæ— è®º &lt;code>__cdecl&lt;/code> è¿˜æ˜¯ &lt;code>__stdcall&lt;/code> éƒ½æ˜¯åœ¨ &lt;code>eax&lt;/code> å¯„å­˜å™¨ä¿å­˜è¿”å›å€¼ã€‚&lt;/p>
&lt;p>ä»&lt;a class="link" href="https://en.wikipedia.org/wiki/Win32_Thread_Information_Block" target="_blank" rel="noopener"
>wiki&lt;/a> å’Œ &lt;a class="link" href="http://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented%20Functions%2FNT%20Objects%2FThread%2FTEB.html" target="_blank" rel="noopener"
>NTAPI UNDOCUMENTED FUNCTIONS&lt;/a> æŸ¥è¯¢åˆ°çš„æ–‡æ¡£éƒ½èƒ½çœ‹åˆ° PEB ç»“æ„çš„å†…å­˜å¸ƒå±€ã€‚&lt;/p>
&lt;p>æƒ³è¦ bypass è¿™ç§æ£€æŸ¥å°±éå¸¸å®¹æ˜“ï¼Œä¿®æ”¹ PEB ç»“æ„ä¸­çš„ &lt;code>BeingDebugged&lt;/code> å­—æ®µå€¼ä¸º 0 å°±å®Œäº‹äº†ã€‚&lt;/p>
&lt;h3 id="22-ntglobalflag">2.2 NtGlobalFlag&lt;/h3>
&lt;p>&lt;code>NtGlobalFlag&lt;/code> ä¹Ÿæ˜¯ä¸€ä¸ª PEB çš„å­—æ®µï¼Œä½†æ˜¯åœ¨å¾®è½¯å®˜æ–¹çš„ PEB ç»“æ„æ–‡æ¡£å’Œå®šä¹‰é‡Œæ²¡æœ‰ç»™å‡ºè¿™ä¸ªå­—æ®µï¼ˆåœ¨ Reserved é‡Œï¼‰ã€‚æŸ¥é˜…ä¸Šé¢æåˆ°çš„æ–‡æ¡£æˆ–è€…ç”¨ WinDbg çš„ &lt;code>dt&lt;/code> å‘½ä»¤éƒ½å¯ä»¥æŸ¥åˆ°ã€‚&lt;/p>
&lt;p>å½“è¿™ä¸ªå­—æ®µåŒ…å«ç‰¹å®šæ ‡å¿—ä½ï¼ˆ&lt;code>0x20 | 0x40&lt;/code>ï¼Œåˆ†åˆ«æ˜¯ &lt;strong>FLG_HEAP_ENABLE_TAIL_CHECK&lt;/strong> å’Œ &lt;strong>FLG_HEAP_ENABLE_FREE_CHECK&lt;/strong>ï¼‰çš„æ—¶å€™æç¤ºæœ‰è°ƒè¯•å™¨å­˜åœ¨ï¼ˆ&lt;a class="link" href="https://www.geoffchappell.com/studies/windows/win32/ntdll/api/rtl/regutil/getntglobalflags.htm" target="_blank" rel="noopener"
>Geoff Chappell, Software Analystï¼ŒRtlGetNtGlobalFlags()&lt;/a>ï¼Œæ²¡å¾®è½¯çš„æ–‡æ¡£ï¼‰ã€‚&lt;/p>
&lt;p>è¿™é‡Œç»™å‡º WinDbg æŸ¥åˆ°çš„å­—æ®µåç§»ã€‚å¾®è½¯å•†åº—é‡Œçš„ WinDbg Preview ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚å…³äº &lt;code>dt&lt;/code> å‘½ä»¤å¯ä»¥ç”¨ &lt;code>.hh dt&lt;/code> æ¥æŸ¥é˜…å‘½ä»¤çš„æ–‡æ¡£ï¼Œ&lt;code>?&lt;/code> æ¥æŸ¥é˜…å¯ç”¨å‘½ä»¤ï¼Œæˆ–è€…ç›´æ¥ç‚¹ä¸Šé¢çš„å¸®åŠ©ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">0:000&amp;gt; dt _peb NtGlobalFlag @$peb
ntdll!_PEB
+0x068 NtGlobalFlag : 0x70
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°åç§»æ˜¯ &lt;code>0x68&lt;/code>ï¼ŒWinDbg ä¸­æ ‡å¿—ä½çš„å€¼æ˜¯ &lt;code>x70&lt;/code>ï¼Œç¬¦åˆä¸Šé¢æ‰€è¯´çš„ &lt;code>0x20|0x40&lt;/code>ã€‚æ¥ä¸‹æ¥å°è¯•å®ç°ä¸€ä¸‹ã€‚é¦–å…ˆå› ä¸ºæˆ‘ç”¨çš„ MinGW æ‰€ä»¥éœ€è¦å†™ä¸¤å¥æ±‡ç¼–å»å–PEBæŒ‡é’ˆã€‚ï¼ˆç”¨çš„ nasmï¼Œgcc çš„å†…è”æ±‡ç¼–è¯­æ³•å¤ªæ€ªäº†ï¼‰&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nf">section&lt;/span> &lt;span class="no">.text&lt;/span>
&lt;span class="nf">global&lt;/span> &lt;span class="no">_GetPEB&lt;/span>
&lt;span class="nl">_GetPEB:&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,[&lt;/span>&lt;span class="no">fs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">30&lt;/span>&lt;span class="no">h&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nf">retn&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å†å…·ä½“å®ç°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="kt">void&lt;/span> &lt;span class="nf">anti_debug_by_RtlGetNtGlobalFlags&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ä¸¤ç§æ–¹å¼ï¼Œç›´æ¥è¯»å†…å­˜æˆ–è€…ç”¨undocumentedæ¥å£
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">PPEB&lt;/span> &lt;span class="n">peb&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">GetPEB&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">PULONG&lt;/span>&lt;span class="p">)((&lt;/span>&lt;span class="n">PBYTE&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">peb&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mh">0x68&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mh">0x20&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="mh">0x40&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">MessageBoxA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;debugger detected&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;PEB-&amp;gt;NtGlobalFlag&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MB_OK&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// æˆ–è€…...
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">HMODULE&lt;/span> &lt;span class="n">ntdll&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">LoadLibraryA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;ntdll.dll&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">FARPROC&lt;/span> &lt;span class="n">proc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">GetProcAddress&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ntdll&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;RtlGetNtGlobalFlags&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">typedef&lt;/span> &lt;span class="n">ULONG&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">RtlGetNtGlobalFlags_t&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(((&lt;/span>&lt;span class="n">RtlGetNtGlobalFlags_t&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">proc&lt;/span>&lt;span class="p">)()&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mh">0x20&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="mh">0x40&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">MessageBoxA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;debugger detected&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;RtlGetNtGlobalFlags&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MB_OK&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å·®åˆ«ä¸å¤§ï¼Œå¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©å…¶ä¸€ã€‚ç¼–è¯‘åä¸ä½¿ç”¨è°ƒè¯•å™¨æ‰“å¼€åˆ™ä¸ä¼šè§¦å‘åè°ƒè¯•ä»£ç ã€‚&lt;/p>
&lt;p>bypass è¿™ä¸ªæ£€æŸ¥ä¹Ÿå¾ˆå®¹æ˜“ï¼Œå› ä¸ºæ ‡å¿—ä½éƒ½åœ¨è¢«è°ƒè¯•è¿›ç¨‹çš„åœ°å€ç©ºé—´é‡Œï¼Œç›´æ¥æ”¹æ‰å°±è¡Œäº†ã€‚&lt;/p>
&lt;h3 id="23-heap-flags">2.3 HEAP-&amp;gt;Flags&lt;/h3>
&lt;p>PEB ç»“æ„ä¸­è¿˜æœ‰ä¸ªæŒ‡å‘å½“å‰å †ä¿¡æ¯ç»“æ„çš„æŒ‡é’ˆï¼Œ&lt;code>ProcessHeap&lt;/code>ã€‚å¯ä»¥ç”¨ WinDbg çš„ &lt;code>dt&lt;/code> å‘½ä»¤æŸ¥çœ‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">0:000&amp;gt; dt _peb processheap @$peb
ntdll!_PEB
+0x018 ProcessHeap : 0x012d0000 Void
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è€Œè¿™ä¸ª heap ç»“æ„çš„ä¹ŸåŒæ ·å¯ä»¥ç”¨ &lt;code>dt&lt;/code> å‘½ä»¤æŸ¥çœ‹ã€‚æˆ‘ä»¬å…³æ³¨çš„æ˜¯ heap ç»“æ„ä¸­çš„ &lt;code>Flags&lt;/code> å’Œ &lt;code>ForceFlags&lt;/code> å­—æ®µã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">0:000&amp;gt; dt _heap flags 0x012d0000
ntdll!_HEAP
+0x040 Flags : 0x40000062
0:000&amp;gt; dt _heap forceflags 0x012d0000
ntdll!_HEAP
+0x044 ForceFlags : 0x40000060
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å½“ Flags æ²¡æœ‰ &lt;code>HEAP_GROWABLE&lt;/code> æ ‡å¿—ä½ï¼Œæˆ– &lt;code>ForceFlags&lt;/code> ä¸ä¸ºé›¶çš„æ—¶å€™ï¼Œåˆ™å¯èƒ½å­˜åœ¨è°ƒè¯•å™¨ã€‚åŒæ ·çš„ï¼Œ æ²¡æœ‰å®˜æ–¹çš„æ–‡æ¡£ï¼Œåªèƒ½è¯´é€†å‘å‡ºè¿™äº›ä¸œè¥¿çš„å¤§ä½¬çœŸæ˜¯å¤ªå¼ºå•¦ã€‚å…³äº Flags è°·æ­Œäº†ä¸€ä¸‹ï¼Œå‘ç°åœ¨ &lt;a class="link" href="https://ctf-wiki.org/reverse/windows/anti-debug/heap-flags/#flags" target="_blank" rel="noopener"
>CTF Wiki&lt;/a> æœ‰æ¯”è¾ƒè¯¦ç»†çš„è¯´æ˜ã€‚æˆ‘æ¬ä¸€éƒ¨åˆ†è¿‡æ¥ã€‚&lt;/p>
&lt;blockquote>
&lt;p>åœ¨æ‰€æœ‰ç‰ˆæœ¬çš„ Windows ä¸­, &lt;code>Flags&lt;/code>å­—æ®µçš„å€¼æ­£å¸¸æƒ…å†µéƒ½è®¾ä¸º&lt;code>HEAP_GROWABLE(2)&lt;/code>, è€Œ&lt;code>ForceFlags&lt;/code>å­—æ®µæ­£å¸¸æƒ…å†µéƒ½è®¾ä¸º&lt;code>0&lt;/code>. ç„¶è€Œå¯¹äºä¸€ä¸ª 32 ä½è¿›ç¨‹ (64 ä½ç¨‹åºä¸ä¼šæœ‰æ­¤å›°æ‰°), è¿™ä¸¤ä¸ªé»˜è®¤å€¼, éƒ½å–å†³äºå®ƒçš„å®¿ä¸»è¿›ç¨‹(host process) çš„ &lt;a class="link" href="https://msdn.microsoft.com/en-us/library/ms933120.aspx" target="_blank" rel="noopener"
>&lt;code>subsystem&lt;/code>&lt;/a>ç‰ˆæœ¬ (è¿™é‡Œä¸æ˜¯æŒ‡æ‰€è¯´çš„æ¯”å¦‚ win10 çš„ linux å­ç³»ç»Ÿ). åªæœ‰å½“&lt;code>subsystem&lt;/code>åœ¨&lt;code>3.51&lt;/code>åŠæ›´é«˜çš„ç‰ˆæœ¬, å­—æ®µçš„é»˜è®¤å€¼æ‰å¦‚å‰æ‰€è¿°. å¦‚æœæ˜¯åœ¨&lt;code>3.10-3.50&lt;/code>ç‰ˆæœ¬ä¹‹é—´, åˆ™ä¸¤ä¸ªå­—æ®µçš„&lt;code>HEAP_CREATE_ALIGN_16 (0x10000)&lt;/code>éƒ½ä¼šè¢«è®¾ç½®. å¦‚æœç‰ˆæœ¬ä½äº&lt;code>3.10&lt;/code>, é‚£ä¹ˆè¿™ä¸ªç¨‹åºæ–‡ä»¶å°±æ ¹æœ¬ä¸ä¼šè¢«è¿è¡Œ.&lt;/p>
&lt;p>å¦‚æœæŸæ“ä½œå°†&lt;code>Flags&lt;/code>å’Œ&lt;code>ForgeFlags&lt;/code>å­—æ®µçš„å€¼åˆ†åˆ«è®¾ä¸º&lt;code>2&lt;/code>å’Œ&lt;code>0&lt;/code>, ä½†æ˜¯å´æœªå¯¹&lt;code>subsystem&lt;/code>ç‰ˆæœ¬è¿›è¡Œæ£€æŸ¥, é‚£ä¹ˆå°±å¯ä»¥è¡¨æ˜è¯¥åŠ¨ä½œæ˜¯ä¸ºäº†éšè—è°ƒè¯•å™¨è€Œè¿›è¡Œçš„.&lt;/p>
&lt;/blockquote>
&lt;p>æ¥ä¸‹æ¥ç»™å‡ºæ¡ˆä¾‹ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="kt">void&lt;/span> &lt;span class="nf">anti_debug_by_PEB_HeapFlags&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">PPEB&lt;/span> &lt;span class="n">peb&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">GetPEB&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">heap&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">PDWORD&lt;/span>&lt;span class="p">)((&lt;/span>&lt;span class="n">PBYTE&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">peb&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mh">0x18&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">PDWORD&lt;/span> &lt;span class="n">heapFlags&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">PDWORD&lt;/span>&lt;span class="p">)((&lt;/span>&lt;span class="n">PBYTE&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">heap&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mh">0x40&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">PDWORD&lt;/span> &lt;span class="n">forceFlags&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">PDWORD&lt;/span>&lt;span class="p">)((&lt;/span>&lt;span class="n">PBYTE&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">heap&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mh">0x44&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">heapFlags&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="o">~&lt;/span>&lt;span class="n">HEAP_GROWABLE&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">forceFlags&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">MessageBoxA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;debugger detected&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;PEB-&amp;gt;_HEAP-&amp;gt;HeapFlags,ForceFlags&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MB_OK&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»£ç æœ¬èº«å¾ˆç®€å•ï¼Œä¸å¤šè§£é‡Šã€‚åœ¨è°ƒè¯•å™¨å¯åŠ¨æ—¶ä¼šè§¦å‘åè°ƒè¯•ä»£ç ï¼Œæ­£å¸¸è¿è¡Œåˆ™ä¸ä¼šã€‚è¿™ä¸ªæ£€æŸ¥æ¯”è¾ƒç²—é™‹ï¼Œå¯ä»¥æ ¹æ®ä¸Šé¢ CTF Wiki æ‘˜å½•å†…å®¹çš„è¯´æ³•ï¼Œæ ¹æ® PE å¤´ä¸­çš„ subsystem æ¥äºŒæ¬¡åˆ¤æ–­ï¼Œæ¥å‘ç°å°è¯• bypass åè°ƒè¯•ä»£ç çš„è¡Œä¸ºã€‚&lt;/p>
&lt;p>è‡³äºå¦‚ä½• bypass è¿™ä¸ªåè°ƒè¯•æ–¹æ¡ˆï¼ŒæŒ‰ä¸Šé¢ç»™å‡ºçš„åŸç†æ¥åå‘åº”ç”¨å°±å¥½äº†ã€‚&lt;/p>
&lt;h3 id="24-checkremotedebuggerpresent">2.4 CheckRemoteDebuggerPresent&lt;/h3>
&lt;p>&lt;code>CheckRemoteDebuggerPresent&lt;/code> çš„&lt;a class="link" href="https://docs.microsoft.com/en-us/windows/win32/api/debugapi/nf-debugapi-checkremotedebuggerpresent" target="_blank" rel="noopener"
>å¾®è½¯æ–‡æ¡£&lt;/a>ä¸­è¿™ä¹ˆæè¿°ï¼šç¡®å®šæŒ‡å®šè¿›ç¨‹æ˜¯å¦æ­£åœ¨è¢«è°ƒè¯•ã€‚æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯è¿›ç¨‹çš„ HANDLEï¼Œä¸€ä¸ªæ˜¯ PBOOLã€‚&lt;/p>
&lt;p>åº”ç”¨æ–¹å¼å¯ä»¥æœ‰å¾ˆå¤šï¼Œå¯ä»¥åœ¨è¿›ç¨‹å†…è‡ªå·±æ£€æŸ¥è‡ªå·±æœ‰æ²¡æœ‰è¢«è°ƒè¯•ï¼›æˆ–è€…å¼€æ–°è¿›ç¨‹å»ç›‘è§†åŸè¿›ç¨‹æ˜¯å¦æ­£åœ¨è¢«è°ƒè¯•ï¼›ç”šè‡³æ³¨å…¥æ­£å¸¸è¿›ç¨‹ï¼Œéšè—å¥½è‡ªå·±ï¼Œå†å»ç›‘è§†åŸè¿›ç¨‹æ˜¯å¦è¢«è°ƒè¯•ï¼›ç”šè‡³å¹²è„†æ½œä¼ä¸‹æ¥å¼€ä¸ªåé—¨ï¼Œäº²è‡ªäººè‚‰ç›‘è§†å±å¹•ä¸Šæœ‰æ²¡æœ‰è°ƒè¯•å™¨&amp;hellip;&amp;hellip;è¶Šè¯´è¶Šç¦»è°±äº†ã€‚&lt;/p>
&lt;p>æ€»ä¹‹å…ˆç»™äº†æ¡ˆä¾‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="kt">void&lt;/span> &lt;span class="nf">anti_debug_by_CheckRemoteDebuggerPresent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">BOOL&lt;/span> &lt;span class="n">isRemoteDebuggerPresent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">FALSE&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">CheckRemoteDebuggerPresent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">GetCurrentProcess&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">isRemoteDebuggerPresent&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">isRemoteDebuggerPresent&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">TRUE&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">MessageBoxA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;debugger detected&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;CheckRemoteDebuggerPresent&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MB_OK&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»£ç å¾ˆç®€å•ä¸å¤šè§£é‡Šï¼Œä¸è¿‡ä»è¿™é‡Œå¯ä»¥å¼•å‡ºæ–°çš„å†…å®¹ï¼š&lt;code>CheckRemoteDebuggerPresent&lt;/code> çš„å®ç°æ–¹å¼æ˜¯è°ƒç”¨ &lt;code>NtQueryInformationProcess&lt;/code> ï¼Œä¸€ä¸ªæ²¡æœ‰æ–‡æ¡£çš„å†…æ ¸æ¥å£ã€‚&lt;/p>
&lt;h3 id="25-ntqueryinformationprocess">2.5 NtQueryInformationProcess&lt;/h3>
&lt;p>&lt;code>NtQueryInformationProcess&lt;/code> åŒæ ·æ²¡æ–‡æ¡£ï¼Œè¿™é‡Œç»™å‡ºæ¯”è¾ƒæ¸…æ™°çš„ &lt;a class="link" href="https://ctf-wiki.org/reverse/windows/anti-debug/ntqueryinformationprocess/" target="_blank" rel="noopener"
>CTF Wiki&lt;/a> çš„è¯´æ˜é“¾æ¥ã€‚&lt;code>NtQueryInformationProcess&lt;/code> æ˜¯ä¸€ä¸ªæŸ¥è¯¢ä¿¡æ¯çš„æ¥å£ï¼Œè¾“å…¥å‚æ•°åŒ…æ‹¬æŸ¥è¯¢çš„ä¿¡æ¯ç±»å‹ã€è¿›ç¨‹HANDLEã€ç»“æœæŒ‡é’ˆç­‰ã€‚ç”¨æ³•åŒæ ·æ˜¯ç®€å•çš„ã€‚&lt;/p>
&lt;p>å€¼å¾—å…³æ³¨çš„æŸ¥è¯¢ä¿¡æ¯ç±»å‹åŒ…æ‹¬ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>ProcessDebugPort&lt;/code>&lt;/li>
&lt;li>&lt;code>ProcessBasicInformation&lt;/code>&lt;/li>
&lt;li>&lt;code>ProcessDebugObjectHandle&lt;/code>&lt;/li>
&lt;li>&lt;code>ProcessDebugFlags&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>å¯¹äº &lt;code>ProcessDebugPort&lt;/code>ï¼ŒæŸ¥è¯¢ç»“æœæ˜¯ä¸€ä¸ª DWORDï¼Œå½“å­˜åœ¨è°ƒè¯•å™¨æ—¶æŸ¥è¯¢ç»“æœä¼šæ˜¯ &lt;code>0xffffffff&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="kt">void&lt;/span> &lt;span class="nf">anti_debug_by_NtQueryInformationProcess&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">HMODULE&lt;/span> &lt;span class="n">ntdll&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">LoadLibrary&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">TEXT&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;ntdll.dll&amp;#34;&lt;/span>&lt;span class="p">));&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">ntdll&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">abort&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">FARPROC&lt;/span> &lt;span class="n">ntQueryInfoProc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">GetProcAddress&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ntdll&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;NtQueryInformationProcess&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">ntQueryInfoProc&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">abort&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">DWORD&lt;/span> &lt;span class="n">isDebuggerPresent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">FALSE&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">NTSTATUS&lt;/span> &lt;span class="n">status&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ntQueryInfoProc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">GetCurrentProcess&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="n">ProcessDebugPort&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">isDebuggerPresent&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">DWORD&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">status&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">isDebuggerPresent&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">MessageBoxA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;debugger detected&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;NtQueryInformationProcess&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MB_OK&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯¹äº &lt;code>ProcessBasicInformation&lt;/code>ï¼ŒæŸ¥è¯¢ç»“æœæ˜¯ &lt;code>PROCESS_BASIC_INFORMATION&lt;/code> ç»“æ„ï¼Œå¯ä»¥æ ¹æ®è¿™ä¸ªç»“æ„æ¥è¿›ä¸€æ­¥åˆ¤æ–­çˆ¶è¿›ç¨‹æ˜¯å¦æ˜¯å·²çŸ¥çš„è°ƒè¯•å™¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#ifdef UNICODE
&lt;/span>&lt;span class="cp"># define MY_STRCMP wcscmp
&lt;/span>&lt;span class="cp">#else
&lt;/span>&lt;span class="cp"># define MY_STRCMP strcmp
&lt;/span>&lt;span class="cp">#endif
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">anti_debug_by_NtQueryInformationProcess_BasicInformation&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">HMODULE&lt;/span> &lt;span class="n">ntdll&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">LoadLibrary&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">TEXT&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;ntdll.dll&amp;#34;&lt;/span>&lt;span class="p">));&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">ntdll&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">abort&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">FARPROC&lt;/span> &lt;span class="n">ntQueryInfoProc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">GetProcAddress&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ntdll&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;NtQueryInformationProcess&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">ntQueryInfoProc&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">abort&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">PROCESS_BASIC_INFORMATION&lt;/span> &lt;span class="n">info&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">NTSTATUS&lt;/span> &lt;span class="n">status&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ntQueryInfoProc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">GetCurrentProcess&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="n">ProcessBasicInformation&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">info&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">info&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">status&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">HANDLE&lt;/span> &lt;span class="n">hProcSnap&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">CreateToolhelp32Snapshot&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">TH32CS_SNAPPROCESS&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">hProcSnap&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">abort&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">PROCESSENTRY32&lt;/span> &lt;span class="n">pe32&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">pe32&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">dwSize&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">PROCESSENTRY32&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">Process32First&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hProcSnap&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">pe32&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">abort&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">do&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">pe32&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">th32ProcessID&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">info&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">InheritedFromUniqueProcessId&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">MY_STRCMP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">TEXT&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;devenv.exe&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">pe32&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">szExeFile&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">MY_STRCMP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">TEXT&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;x32dbg.exe&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">pe32&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">szExeFile&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">||&lt;/span>
&lt;span class="n">MY_STRCMP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">TEXT&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;x64dbg.exe&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">pe32&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">szExeFile&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">MY_STRCMP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">TEXT&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;ollydbg.exe&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">pe32&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">szExeFile&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">MessageBoxA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;debugger detected&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;BasicInformation&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MB_OK&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">CloseHandle&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hProcSnap&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">Process32Next&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hProcSnap&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">pe32&lt;/span>&lt;span class="p">));&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>ProcessObjectDebugHandle&lt;/code> å’Œ &lt;code>ProcessDebugFlags&lt;/code> å°±ä¸ä¸€ä¸€ç»™æ¡ˆä¾‹äº†ã€‚æ£€æŸ¥æ–¹å¼ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯åˆ¤æ–­éé›¶åˆ™å­˜åœ¨è°ƒè¯•å™¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="n">ntQueryInfoProc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">GetCurrentProcess&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="n">ProcessObjectDebugHandle&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">handle&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">HANDLE&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">ntQueryInfoProc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">GetCurrentProcess&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="n">ProcessDebugFlags&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">flags&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ULONG&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å› ä¸º &lt;code>NtQueryInformationProcess&lt;/code> æ˜¯ä»å†…æ ¸æŸ¥è¯¢æ¶ˆæ¯ï¼Œæ‰€ä»¥ bypass ä¼šæ¯”è¾ƒéš¾â€”â€”å°±æ˜¯è¯´éœ€è¦ HOOK ã€‚ä½†æˆ‘è¿˜ä¸ä¼š HOOK ï¼Œæ‰€ä»¥ç•¥è¿‡ã€‚&lt;/p>
&lt;h3 id="26-ntsetinformationthread">2.6 NtSetInformationThread&lt;/h3>
&lt;p>åˆæ˜¯ä¸€ä¸ªæ²¡æœ‰æ–‡æ¡£çš„APIã€‚&lt;code>NtSetInformationThread&lt;/code> ç­‰åŒäº &lt;code>ZwSetInformationThread&lt;/code>ï¼Œé€šè¿‡è®¾ç½® &lt;code>ThreadHideFromDebugger&lt;/code> æ ‡å¿—ä½å¯ä»¥ç¦æ­¢çº¿ç¨‹äº§ç”Ÿè°ƒè¯•äº‹ä»¶ã€‚å¦‚æœæ­£å¤„äºè°ƒè¯•çŠ¶æ€æ‰§è¡Œäº†è¿™ä¸ª API åˆ™ä¼šå¯¼è‡´ç¨‹åºç«‹å³é€€å‡ºã€‚&lt;/p>
&lt;p>æ¡ˆä¾‹å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="k">typedef&lt;/span> &lt;span class="nf">NTSTATUS&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">NTAPI&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">pfnNtSetInformationThread&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">_In_&lt;/span> &lt;span class="n">HANDLE&lt;/span> &lt;span class="n">ThreadHandle&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">_In_&lt;/span> &lt;span class="n">ULONG&lt;/span> &lt;span class="n">ThreadInformationClass&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="n">_In_&lt;/span> &lt;span class="n">PVOID&lt;/span> &lt;span class="n">ThreadInformation&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">_In_&lt;/span> &lt;span class="n">ULONG&lt;/span> &lt;span class="n">ThreadInformationLength&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">anti_debug_by_HideFromDebugger&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">HMODULE&lt;/span> &lt;span class="n">ntdll&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">LoadLibrary&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">TEXT&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;ntdll.dll&amp;#34;&lt;/span>&lt;span class="p">));&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">ntdll&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">abort&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">pfnNtSetInformationThread&lt;/span> &lt;span class="n">ntSetInfoThread&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">pfnNtSetInformationThread&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">GetProcAddress&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ntdll&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;NtSetInformationThread&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">ntSetInfoThread&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">abort&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">ntSetInfoThread&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">GetCurrentThread&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="n">ThreadHideFromDebugger&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// ... NtCreateThreadEx THREAD_CREATE_FLAGS_HIDE_FROM_DEBUGGER
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åŒæ ·å› ä¸ºè¿™ä¸€æ–¹å¼æ˜¯èµ°å†…æ ¸æ¥å£ï¼Œå¯ä»¥é€šè¿‡ HOOK æŠ€æœ¯æŠŠç›¸åº”çš„æ ‡å¿—ä½æ‹¦æˆªæ‰å°±è¡Œã€‚&lt;/p>
&lt;h3 id="27-setgetlasterror">2.7 Set/GetLastError&lt;/h3>
&lt;p>å¯¹&lt;code>SetLastError&lt;/code>å’Œ&lt;code>GetLastError&lt;/code>çš„åˆ©ç”¨æ–¹å¼æ˜¯ç»“åˆ &lt;code>OutputDebugString&lt;/code> å¤±è´¥æ—¶ä¼šä¿®æ”¹ &lt;code>GetLastError()&lt;/code> çš„é”™è¯¯ç çš„è¡Œä¸ºï¼Œåˆ¤æ–­æ˜¯å¦æœ‰è°ƒè¯•å™¨å­˜åœ¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">// TODO: somehow not work on windows 10, need more test.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="nf">anti_debug_by_SetLastError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">SetLastError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mh">0x1234&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">OutputDebugString&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">TEXT&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Hello Debugger!&amp;#34;&lt;/span>&lt;span class="p">));&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">GetLastError&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mh">0x1234&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">MessageBoxA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;debugger detected&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;Set/Get LastError&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MB_OK&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¯”è¾ƒå¥‡æ€ªçš„æ˜¯åœ¨æˆ‘è¿™æ— è®ºåœ¨ä¸åœ¨è°ƒè¯•ç¯å¢ƒè·‘éƒ½ä¼šè§¦å‘åè°ƒè¯•ï¼Œç¯å¢ƒ Windows 10 + MinGW ã€‚&lt;/p>
&lt;h2 id="0x03-å¼‚å¸¸å¤„ç†æ–¹å¼">0x03 å¼‚å¸¸å¤„ç†æ–¹å¼&lt;/h2>
&lt;p>å¼‚å¸¸å¤„ç†æ–¹å¼çš„åè°ƒè¯•ï¼Œæ˜¯é€šè¿‡è§¦å‘ä¼šè¢«è°ƒè¯•å™¨å¤„ç†çš„ä¸­æ–­æˆ–è€…å¼‚å¸¸ï¼Œå¦‚æœè°ƒè¯•å™¨æ‹¦æˆªå¹¶å¤„ç†äº†ä¸­æ–­æˆ–å¼‚å¸¸ï¼Œå°±ä¼šå¯¼è‡´ç¨‹åºé‡Œæ³¨å†Œçš„å¼‚å¸¸å¤„ç†å‡½æ•°æœªè¢«æ‰§è¡Œï¼Œè¿›è€Œå‘ç°æ­£åœ¨è¢«è°ƒè¯•ã€‚&lt;/p>
&lt;p>è¿™ä¸ªæ€è·¯ä¹Ÿå¯ä»¥ç”¨æ¥æ„é€ ç‰¹æ®Šçš„æ§åˆ¶æµï¼Œæ¯”å¦‚æŠŠå…³é”®é€»è¾‘æ”¾åœ¨ä¸­æ–­å¤„ç†å‡½æ•°é‡Œï¼Œç„¶åæŠ›å‡º INT 1 ä¸­æ–­ï¼ˆå•æ­¥æ‰§è¡Œï¼‰ï¼Œå¦‚æœè¢«è°ƒè¯•å™¨å‘½ä¸­ï¼Œåˆ™æˆ‘ä»¬æ„é€ çš„æ§åˆ¶æµå°±ä¼šè¢«ç ´åï¼Œç¨‹åºå°±ä¼šè·‘é£ã€‚&lt;/p>
&lt;h3 id="31-int-1">3.1 INT 1&lt;/h3>
&lt;p>INT 1 ä¸­æ–­çš„å«ä¹‰æ˜¯ SINGLE STEPï¼Œåœ¨è°ƒè¯•å™¨ä¸Šçš„è¡¨ç°å°±æ˜¯ä¼šè®©è°ƒè¯•å™¨æ–­åœ¨ä¸­æ–­çš„ä½ç½®ï¼ˆåæ­£åœ¨x32dbgä¸Šçš„è¡¨ç°æ˜¯è¿™æ ·ï¼‰ã€‚INT 1ä¸­æ–­åï¼Œå¦‚æœæ²¡æœ‰è°ƒè¯•å™¨ï¼Œé‚£ä¹ˆæ§åˆ¶æƒä¼šè½¬äº¤ç»™è°ƒè¯•å™¨ï¼ŒSEH ä¸ä¼šæ‰§è¡Œï¼Œåä¹‹åˆ™ SEH æ‰§è¡Œï¼Œç”¨æˆ·ç¨‹åºä¿ç•™æ§åˆ¶æƒã€‚&lt;/p>
&lt;p>å®é™…ä¸Šå‘ç° x32dbg å³ä½¿æ–­åˆ°äº†ä¹Ÿä¼šæŠŠæ§åˆ¶æƒè½¬ç»™ SEHï¼Œæ‰€ä»¥å¯¹å…³äº SEH åè°ƒè¯•æ˜¯å¦å¯è¡Œã€å¦‚ä½•å®ç°æŒç–‘é—®ã€‚ä½†æ˜¯ç»è¿‡ä¸€ç•ªæœç´¢å’Œç ”ç©¶å‘ç° VEH æœºåˆ¶å¯ä»¥å®ç°ä¸Šè¿°é€»è¾‘ã€‚æ¡ˆä¾‹ä»£ç å¦‚ä¸‹ã€‚&lt;/p>
&lt;p>ç”¨æ¥æŠ›å‡º INT 1 ä¸­æ–­çš„æ±‡ç¼–ä»£ç &lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nf">section&lt;/span> &lt;span class="no">.text&lt;/span>
&lt;span class="nf">global&lt;/span> &lt;span class="no">_RaiseInt1&lt;/span>
&lt;span class="nl">_RaiseInt1:&lt;/span>
&lt;span class="nf">pushfd&lt;/span>
&lt;span class="nf">or&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">esp&lt;/span>&lt;span class="p">],&lt;/span>&lt;span class="no">dword&lt;/span> &lt;span class="mi">0x100&lt;/span>
&lt;span class="nf">popfd&lt;/span>
&lt;span class="nf">retn&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ£€æµ‹è°ƒè¯•å™¨çš„å‡½æ•°å¦‚ä¸‹&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="n">BOOL&lt;/span> &lt;span class="k">volatile&lt;/span> &lt;span class="n">VEH_INT1_isDebuggerPresent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">FALSE&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">LONG&lt;/span> &lt;span class="n">CALLBACK&lt;/span> &lt;span class="nf">VEH_INT1_UnhandledExceptionFilter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">_In_&lt;/span> &lt;span class="n">EXCEPTION_POINTERS&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">lpEP&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">lpEP&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">ExceptionRecord&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">ExceptionCode&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nl">EXCEPTION_SINGLE_STEP&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="c1">// handle single step exception if not handled by debugger
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">VEH_INT1_isDebuggerPresent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">FALSE&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">EXCEPTION_CONTINUE_EXECUTION&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">EXCEPTION_CONTINUE_SEARCH&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">anti_debug_by_VEH_INT1&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">VEH_INT1_isDebuggerPresent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">TRUE&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// https://docs.microsoft.com/en-us/windows/win32/api/errhandlingapi/nf-errhandlingapi-setunhandledexceptionfilter
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">SetUnhandledExceptionFilter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">VEH_INT1_UnhandledExceptionFilter&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// https://docs.microsoft.com/zh-cn/windows/win32/api/errhandlingapi/nf-errhandlingapi-addvectoredexceptionhandler?redirectedfrom=MSDN
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// https://docs.microsoft.com/en-us/windows/win32/api/winnt/nc-winnt-pvectored_exception_handler
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">RaiseInt1&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">VEH_INT1_isDebuggerPresent&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">TRUE&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">MessageBoxA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;debugger detected&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;VEH INT1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MB_OK&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ©ç”¨ &lt;code>SetUnhandledExceptionFilter&lt;/code> å®ç°ï¼Œæ–‡æ¡£é“¾æ¥åœ¨æ³¨é‡Šé‡Œç»™å‡ºäº†ã€‚ä¹Ÿå¯ä»¥å†ç½—å—¦ä¸€ç‚¹ï¼Œç»“åˆ &lt;code>AddVectoredExceptionHandler&lt;/code> å®ç°ã€‚ä½†é€»è¾‘è¿˜æ˜¯é‚£æ ·ã€‚&lt;/p>
&lt;p>INT 1ä¸­æ–­æ–¹å¼æ£€æµ‹è°ƒè¯•å™¨åï¼Œå¯ä»¥æ¢å¤åˆ°æ­£å¸¸æ§åˆ¶æµæ‰§è¡Œã€‚ä½†æ˜¯ INT 3 ä¼šæœ‰æ‰€åŒºåˆ«ï¼ŒINT 3 ä¸­æ–­æ—¶ EIP ä¼šåœç•™åœ¨ä¸­æ–­æŒ‡ä»¤å¤„ï¼Œä¸­æ–­å¤„ç†ä¸­éœ€è¦ä¿®æ”¹ EIP çš„å€¼æ¢å¤æ§åˆ¶æµã€‚&lt;/p>
&lt;p>å…³äº SEH ä¸­æ–­åè°ƒè¯•æˆ‘ç•™ä¸ªé“¾æ¥ï¼š&lt;a class="link" href="https://bbs.pediy.com/thread-267324.htm" target="_blank" rel="noopener"
>çœ‹é›ªè®ºå›ï¼šåŸºäºSEHçš„é™æ€åè°ƒè¯•å®ä¾‹åˆ†æ&lt;/a>ï¼Œæœ‰ç©ºå†åˆ†æçœ‹çœ‹ã€‚&lt;/p>
&lt;h3 id="32-int-3">3.2 INT 3&lt;/h3>
&lt;p>INT 3 ä¸­æ–­å°±æ˜¯ &lt;code>0xcc&lt;/code> ä¸€å­—èŠ‚ä¸­æ–­æŒ‡ä»¤ï¼Œé¡ºä¾¿ä¸€æå•Šï¼Œå› ä¸ºVCä¼šç”¨ 0xcc å¡«å……æœªåˆå§‹åŒ–çš„æ ˆï¼Œç”¨Cå†™è¿‡ä»£ç å¤šå°‘éƒ½è§è¿‡çš„ &lt;em>çƒ«çƒ«çƒ«&lt;/em> é”™è¯¯å°±æ˜¯æ¥è‡ªäºæ­¤ã€‚&lt;/p>
&lt;p>å‚è€ƒ &lt;a class="link" href="https://ctf-wiki.org/reverse/windows/anti-debug/int-3/" target="_blank" rel="noopener"
>CTF Wiki - Interrupt 3&lt;/a>ã€‚&lt;/p>
&lt;blockquote>
&lt;p>å½“&lt;code>EXCEPTION_BREAKPOINT(0x80000003)&lt;/code>å¼‚å¸¸è§¦å‘æ—¶, Windows ä¼šè®¤å®šè¿™æ˜¯ç”±å•å­—èŠ‚çš„ &amp;ldquo;&lt;code>CC&lt;/code>&amp;rdquo; æ“ä½œç  (ä¹Ÿå³&lt;code>Int 3&lt;/code>æŒ‡ä»¤) é€ æˆçš„. Windows é€’å‡å¼‚å¸¸åœ°å€ä»¥æŒ‡å‘æ‰€è®¤å®šçš„ &amp;ldquo;&lt;code>CC&lt;/code>&amp;rdquo; æ“ä½œç , éšåä¼ é€’è¯¥å¼‚å¸¸ç»™å¼‚å¸¸å¤„ç†å¥æŸ„. ä½†æ˜¯ EIP å¯„å­˜å™¨çš„å€¼å¹¶ä¸ä¼šå‘ç”Ÿå˜åŒ–.&lt;/p>
&lt;p>å› æ­¤, å¦‚æœä½¿ç”¨äº† &lt;code>CD 03&lt;/code>ï¼ˆè¿™æ˜¯ &lt;code>Int 03&lt;/code> çš„æœºå™¨ç è¡¨ç¤ºï¼‰ï¼Œé‚£ä¹ˆå½“å¼‚å¸¸å¤„ç†å¥æŸ„æ¥å—æ§åˆ¶æ—¶, å¼‚å¸¸åœ°å€æ˜¯æŒ‡å‘ &lt;code>03&lt;/code> çš„ä½ç½®.&lt;/p>
&lt;/blockquote>
&lt;p>è¿™é‡Œæœ‰ä¸€ä¸ªè°ƒè¯•ä¸­å‘ç°çš„æ€ªå¼‚é—®é¢˜ï¼šè°ƒè¯•å™¨å†…è¿è¡Œæ—¶ä¼šå¹³æ ˆé”™è¯¯ï¼Œesp ä¼šè¶Šè¿‡åŸæœ¬çš„è¿”å›åœ°å€ï¼Œå¯¼è‡´æ‰§è¡Œåˆ° ret æ—¶è¿”å›åœ°å€æ˜¯0ï¼Œäº§ç”Ÿå¼‚å¸¸ã€‚ç›®å‰ä¸ç¡®å®šæ˜¯ä¸æ˜¯å› ä¸ºä¸Šé¢è¯´çš„EIPæ²¡æœ‰+1å¯¼è‡´çš„é—®é¢˜ã€‚&lt;/p>
&lt;p>æ¡ˆä¾‹ä»£ç å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nf">section&lt;/span> &lt;span class="no">.text&lt;/span>
&lt;span class="nf">global&lt;/span> &lt;span class="no">_RaiseInt3&lt;/span>
&lt;span class="nl">_RaiseInt3:&lt;/span>
&lt;span class="nf">int&lt;/span> &lt;span class="mi">3&lt;/span>
&lt;span class="nf">retn&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="n">BOOL&lt;/span> &lt;span class="k">volatile&lt;/span> &lt;span class="n">VEH_INT3_isDebuggerPresent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">FALSE&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">LONG&lt;/span> &lt;span class="n">CALLBACK&lt;/span> &lt;span class="nf">VEH_INT3_UnhandledExceptionFilter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">_In_&lt;/span> &lt;span class="n">EXCEPTION_POINTERS&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">lpEP&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">lpEP&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">ExceptionRecord&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">ExceptionCode&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nl">EXCEPTION_BREAKPOINT&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="c1">// handle single step exception if not handled by debugger
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">VEH_INT3_isDebuggerPresent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">FALSE&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">lpEP&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">ContextRecord&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">Eip&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">EXCEPTION_CONTINUE_EXECUTION&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">EXCEPTION_CONTINUE_SEARCH&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">anti_debug_by_VEH_INT3&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">VEH_INT3_isDebuggerPresent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">TRUE&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">SetUnhandledExceptionFilter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">VEH_INT3_UnhandledExceptionFilter&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">RaiseInt3&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">VEH_INT3_isDebuggerPresent&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">TRUE&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">MessageBoxA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;debugger detected&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;SEH INT3&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MB_OK&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°å’Œ INT1 çš„æ¡ˆä¾‹åˆ«æ— äºŒè‡´ã€‚è¿™é‡Œå†é™„å¸¦ä¸Šæ±‡ç¼–ç»“æœï¼Œå¤§ä½¬ä¹Ÿå¯ä»¥çœ‹çœ‹ä¸Šé¢è¯´çš„å¹³æ ˆé—®é¢˜æ˜¯æ€ä¹ˆå›äº‹ã€‚ç¼–è¯‘å¥½çš„æ¡ˆä¾‹ä¼šé™„åœ¨æœ€æœ«ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nf">sub&lt;/span> &lt;span class="no">esp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0x1C&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="no">ptr&lt;/span> &lt;span class="no">ds&lt;/span>&lt;span class="p">:[&lt;/span>&lt;span class="mi">0x5B4000&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="mi">0x1&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="no">ptr&lt;/span> &lt;span class="no">ss&lt;/span>&lt;span class="p">:[&lt;/span>&lt;span class="no">esp&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="err">&amp;lt;&lt;/span>&lt;span class="no">packed.sub_5B1390&lt;/span>&lt;span class="err">&amp;gt;&lt;/span>
&lt;span class="nf">call&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="no">ptr&lt;/span> &lt;span class="no">ds&lt;/span>&lt;span class="p">:[&lt;/span>&lt;span class="err">&amp;lt;&amp;amp;&lt;/span>&lt;span class="no">_SetUnhandledExceptionFilterStub@4&lt;/span>&lt;span class="err">&amp;gt;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nf">sub&lt;/span> &lt;span class="no">esp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0x4&lt;/span>
&lt;span class="nf">call&lt;/span> &lt;span class="no">packed.5B1AA1&lt;/span> &lt;span class="c">; int3, retn
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="no">ptr&lt;/span> &lt;span class="no">ds&lt;/span>&lt;span class="p">:[&lt;/span>&lt;span class="mi">0x5B4000&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nf">cmp&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0x1&lt;/span>
&lt;span class="nf">je&lt;/span> &lt;span class="no">packed.5B1650&lt;/span>
&lt;span class="nf">add&lt;/span> &lt;span class="no">esp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0x1C&lt;/span>
&lt;span class="nf">ret&lt;/span>
&lt;span class="no">mov&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="no">ptr&lt;/span> &lt;span class="no">ss&lt;/span>&lt;span class="p">:[&lt;/span>&lt;span class="no">esp&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">0xC&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="mi">0x0&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="no">ptr&lt;/span> &lt;span class="no">ss&lt;/span>&lt;span class="p">:[&lt;/span>&lt;span class="no">esp&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">0x8&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">packed.5B20A1&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="no">ptr&lt;/span> &lt;span class="no">ss&lt;/span>&lt;span class="p">:[&lt;/span>&lt;span class="no">esp&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">0x4&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">packed.5B202A&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="no">ptr&lt;/span> &lt;span class="no">ss&lt;/span>&lt;span class="p">:[&lt;/span>&lt;span class="no">esp&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="mi">0x0&lt;/span>
&lt;span class="nf">call&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="no">ptr&lt;/span> &lt;span class="no">ds&lt;/span>&lt;span class="p">:[&lt;/span>&lt;span class="err">&amp;lt;&amp;amp;&lt;/span>&lt;span class="no">MessageBoxA&lt;/span>&lt;span class="err">&amp;gt;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nf">sub&lt;/span> &lt;span class="no">esp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0x10&lt;/span>
&lt;span class="nf">add&lt;/span> &lt;span class="no">esp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0x1C&lt;/span>
&lt;span class="nf">ret&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="33-debugoutputstring">3.3 DebugOutputString&lt;/h3>
&lt;p>åˆ©ç”¨æ–¹å¼å’Œå‰é¢ä¸€æ ·ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">// TODO: NOT WORK
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="n">BOOL&lt;/span> &lt;span class="n">VEH_OutputDebugStringException_isDebugPresent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">FALSE&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">LONG&lt;/span> &lt;span class="n">CALLBACK&lt;/span> &lt;span class="nf">VEH_OutputDebugStringException_UnhandledExceptionFilter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">_In_&lt;/span> &lt;span class="n">EXCEPTION_POINTERS&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">lpEP&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">lpEP&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">ExceptionRecord&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">ExceptionCode&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nl">EXCEPTION_BREAKPOINT&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="c1">// handle single step exception if not handled by debugger
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">VEH_INT3_isDebuggerPresent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">FALSE&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">EXCEPTION_CONTINUE_EXECUTION&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">EXCEPTION_CONTINUE_SEARCH&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">anti_debug_by_VEH_OutputDebugException&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">ULONG_PTR&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">};&lt;/span>
&lt;span class="n">args&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">ULONG_PTR&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">wcslen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">L&lt;/span>&lt;span class="s">&amp;#34;debug&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">args&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">ULONG_PTR&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="sa">L&lt;/span>&lt;span class="s">&amp;#34;debug&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">AddVectoredExceptionHandler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">VEH_OutputDebugStringException_UnhandledExceptionFilter&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">VEH_OutputDebugStringException_isDebugPresent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">TRUE&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">RaiseException&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">DBG_PRINTEXCEPTION_WIDE_C&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">RemoveVectoredExceptionHandler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">VEH_OutputDebugStringException_UnhandledExceptionFilter&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">VEH_OutputDebugStringException_isDebugPresent&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">TRUE&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">MessageBoxA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;debugger detected&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;OutputDebugString&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MB_OK&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å®æµ‹å‘ç° x32dbg å¹¶ä¸ä¼šå¤„ç† &lt;code>DBG_PRINTEXCEPTION_WIDE_C&lt;/code> ï¼Œæ‰€ä»¥è¿™ä¸ªåè°ƒè¯•å¯¹ x32dbg æ²¡ç”¨ã€‚&lt;/p>
&lt;h3 id="34-invalid_handle">3.4 INVALID_HANDLE&lt;/h3>
&lt;p>æ ¹æ®å¾®è½¯çš„æ–‡æ¡£ &lt;a class="link" href="https://docs.microsoft.com/en-us/windows/win32/api/handleapi/nf-handleapi-closehandle" target="_blank" rel="noopener"
>CloseHandle function (handleapi.h)&lt;/a> è¯´æ˜ï¼š&lt;/p>
&lt;blockquote>
&lt;p>If the application is running under a debugger, the function will throw an exception if it receives either a handle value that is not valid or a pseudo-handle value. This can happen if you close a handle twice, or if you call &lt;strong>CloseHandle&lt;/strong> on a handle returned by the &lt;a class="link" href="https://docs.microsoft.com/en-us/windows/desktop/api/fileapi/nf-fileapi-findfirstfilea" target="_blank" rel="noopener"
>FindFirstFile&lt;/a> function instead of calling the &lt;a class="link" href="https://docs.microsoft.com/en-us/windows/desktop/api/fileapi/nf-fileapi-findclose" target="_blank" rel="noopener"
>FindClose&lt;/a> function.&lt;/p>
&lt;/blockquote>
&lt;p>å¯ä»¥å¾—çŸ¥ï¼Œåœ¨è°ƒè¯•å™¨å¯åŠ¨æ—¶ï¼Œ&lt;code>CloseHandle&lt;/code> å…³é—­æ— æ•ˆçš„ &lt;code>HANDLE&lt;/code> æ—¶ä¼šå‡ºç° &lt;code>EXCEPTION_INVALID_HANDLE&lt;/code> å¼‚å¸¸ã€‚æ‰€ä»¥åªè¦æ•…æ„å…³é—­ä¸€ä¸ªæ— æ•ˆçš„ &lt;code>HANDLE&lt;/code>ï¼ŒæŠ“ä½è¿™ä¸ªå¼‚å¸¸ï¼Œå°±èƒ½ç¡®å®šè°ƒè¯•å™¨å­˜åœ¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="n">LONG&lt;/span> &lt;span class="n">CALLBACK&lt;/span> &lt;span class="nf">VEH_INVALID_HANDLE_UnhandledExceptionFilter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">_In_&lt;/span> &lt;span class="n">EXCEPTION_POINTERS&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">lpEP&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">lpEP&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">ExceptionRecord&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">ExceptionCode&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nl">EXCEPTION_INVALID_HANDLE&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="c1">// if debug present
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">MessageBoxA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;debugger detected&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;INVALID HANDLE&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MB_OK&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">EXCEPTION_CONTINUE_EXECUTION&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">EXCEPTION_CONTINUE_SEARCH&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">anti_debug_by_VEH_INVALID_HANDLE&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">AddVectoredExceptionHandler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">VEH_INVALID_HANDLE_UnhandledExceptionFilter&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">CloseHandle&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">HANDLE&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="mh">0xBAAD&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">RemoveVectoredExceptionHandler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">VEH_INVALID_HANDLE_UnhandledExceptionFilter&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å’Œä¹‹å‰çš„æ£€æŸ¥ä¸åŒï¼ŒINVALID_HANDLE æ˜¯ &lt;strong>å‡ºç°è¿™ä¸ªå¼‚å¸¸æ‰å­˜åœ¨è°ƒè¯•å™¨&lt;/strong>ï¼Œä¹‹å‰çš„å¼‚å¸¸å¤„ç†æ–¹å¼éƒ½æ˜¯æ²¡å‡ºç°å¼‚å¸¸æ‰å­˜åœ¨è°ƒè¯•å™¨ã€‚&lt;/p>
&lt;h2 id="0x04-ç¡¬ä»¶æ–­ç‚¹">0x04 ç¡¬ä»¶æ–­ç‚¹&lt;/h2>
&lt;p>&lt;a class="link" href="https://en.wikipedia.org/wiki/X86_debug_register" target="_blank" rel="noopener"
>x86 ä½“ç³»ä¸Šå­˜åœ¨ä¸€å¥—è°ƒè¯•å¯„å­˜å™¨&lt;/a>ï¼Œå°±æ˜¯ &lt;code>dr0&lt;/code>-&lt;code>dr7&lt;/code>è¿™8ä¸ªå¯„å­˜å™¨ã€‚å…¶ä¸­&lt;code>dr0&lt;/code>-&lt;code>dr3&lt;/code>ä¿å­˜çš„ç¡¬ä»¶æ–­ç‚¹çš„çº¿æ€§åœ°å€ï¼Œæ–­ç‚¹æ¡ä»¶ä¿å­˜åœ¨&lt;code>dr7&lt;/code>å¯„å­˜å™¨ã€‚&lt;code>dr6&lt;/code>å¯„å­˜å™¨ä¿å­˜çš„æ˜¯è°ƒè¯•çŠ¶æ€ï¼ŒæŒ‡ç¤ºè§¦å‘äº†å“ªä¸ªæ–­ç‚¹æ¡ä»¶ã€‚&lt;/p>
&lt;p>æ‰€ä»¥å‘ç°ç¡¬ä»¶æ–­ç‚¹çš„å­˜åœ¨ï¼Œå°±å¯ä»¥ç™¾åˆ†ç™¾ç¡®å®šæ­£åœ¨è¢«è°ƒè¯•ã€‚&lt;/p>
&lt;h3 id="41-ç¡¬ä»¶æ–­ç‚¹">4.1 ç¡¬ä»¶æ–­ç‚¹&lt;/h3>
&lt;p>ç›´æ¥ç»™æ¡ˆä¾‹ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">// detect hardware breakpoint
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="nf">anti_debug_by_DebugRegister&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">CONTEXT&lt;/span> &lt;span class="n">ctx&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">ContextFlags&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">CONTEXT_DEBUG_REGISTERS&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">GetThreadContext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">GetCurrentThread&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">ctx&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Dr0&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Dr1&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Dr2&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Dr3&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">MessageBoxA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;debugger detected&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;Dr0-Dr3&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MB_OK&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>é€šè¿‡&lt;code>GetThreadContext&lt;/code>è¿™ä¸ªæ¥å£è·å¾—å½“å‰å¯„å­˜å™¨çŠ¶æ€ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡å†…è”æ±‡ç¼–æ¥å®ç°ã€‚å½“å‘ç°å››ä¸ªæ–­ç‚¹å¯„å­˜å™¨éé›¶å°±å¯ä»¥ç¡®å®šæ­£åœ¨è¢«è°ƒè¯•äº†ã€‚&lt;/p>
&lt;h2 id="0x05-å®Œæ•´æ€§æ ¡éªŒ">0x05 å®Œæ•´æ€§æ ¡éªŒ&lt;/h2>
&lt;p>å®Œæ•´æ€§æ ¡éªŒåè°ƒè¯•çš„åŸç†æ˜¯æ£€æµ‹ &lt;code>0xCC&lt;/code> è½¯ä»¶æ–­ç‚¹ï¼Œå½“æˆ‘ä»¬ä¸€èˆ¬è¯´çš„åœ¨ç¨‹åºé‡Œ&lt;em>ä¸‹æ–­ç‚¹&lt;/em>çš„æ—¶å€™ä¸‹çš„æ˜¯è½¯ä»¶æ–­ç‚¹ï¼Œå®ç°çš„åŸç†æ˜¯è°ƒè¯•å™¨åœ¨è¿™ä¸ªå†…å­˜ä½ç½®ä¸Šä¸´æ—¶æ”¾ä¸€ä¸ª&lt;code>0xcc&lt;/code>å ä½ï¼Œå½“EIPèµ°åˆ°è¿™é‡Œæ—¶ä¼šè§¦å‘ä¸€ä¸ªINT 3ä¸­æ–­ï¼Œè°ƒè¯•å™¨è¶æœºå–å¾—æ§åˆ¶æƒã€‚åŒæ—¶å› ä¸º INT 3 æ–­ç‚¹ä¸ä¼šæŠŠ EIP + 1ï¼Œæ‰€ä»¥è°ƒè¯•å™¨åªéœ€è¦æŠŠæ”¹æˆ &lt;code>0xcc&lt;/code> çš„åœ°æ–¹æ”¹å›å»ï¼Œå°±å¯ä»¥è®©ç¨‹åºç»§ç»­è·‘è€Œæ— éœ€å»ç¢°å¯„å­˜å™¨ã€‚&lt;/p>
&lt;h3 id="51-softwarebreakpoint">5.1 SoftwareBreakpoint&lt;/h3>
&lt;p>ä¸‹é¢çš„æ¡ˆä¾‹ç»™äº†ä¸€ä¸ªç®€å•çš„è½¯ä»¶æ–­ç‚¹æ£€æµ‹ï¼Œåªèƒ½æ£€æµ‹åˆ°ä¸‹åœ¨å‡½æ•°å¼€å¤´çš„è½¯ä»¶æ–­ç‚¹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">// detect 0xcc interrupt code
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="nf">anti_debug_by_SoftwareBreakPoint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">PBYTE&lt;/span> &lt;span class="n">addr&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">addr&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mh">0xcc&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">MessageBoxA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;debugger detected&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;SoftwareBreakpoint&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MB_OK&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// åœ¨ä¸»å‡½æ•°é‡Œï¼š
&lt;/span>&lt;span class="c1">// anti_debug_by_SoftwareBreakPoint((PBYTE)&amp;amp;load_PE)
&lt;/span>&lt;span class="c1">// å°±èƒ½æ£€æµ‹åˆ°åœ¨ load_PE å‡½æ•°å¼€å¤´å¤„ä¸‹çš„æ–­ç‚¹
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦‚æœèƒ½ä»¥ä¸€å®šçš„æ–¹å¼ç¡®å®šä¸€ä¸ªå‡½æ•°çš„ä»£ç æ®µå¤§å°ï¼Œä¹Ÿå¯ä»¥åšåˆ°å¯¹æ•´ä¸ªå‡½æ•°çš„å®Œæ•´æ€§æ£€æµ‹ï¼ˆé€šè¿‡è®¡ç®— CRC æˆ–è€…å…¶ä»–å“ˆå¸Œç®—æ³•ï¼Œç”šè‡³å°±ç›´æ¥ç´¯åŠ éƒ½è¡Œï¼‰ã€‚&lt;/p>
&lt;p>ç¡®å®šå‡½æ•°ä»£ç æ®µå¤§å°çš„æ–¹å¼æˆ‘åªæƒ³åˆ°ä¸€ä¸ªåˆ©ç”¨æ ˆä¸Šçš„è¿”å›åœ°å€=ï¼Œ=åœ¨å‡½æ•°å¼€å¤´å’Œç»“å°¾éƒ¨åˆ†è°ƒç”¨ä¸€æ¬¡è·å–æ ˆä¸Šè¿”å›åœ°å€çš„å‡½æ•°å°±èƒ½æ‹¿åˆ°ä¸€ä¸ªèŒƒå›´äº†ï¼Œä½†æ„Ÿè§‰å¹¶ä¸å¯é ï¼Œä¸»è¦æ˜¯ç¼–è¯‘å™¨ä¼˜åŒ–å¯èƒ½é‡æ’ä»£ç ï¼Œè€Œä¸”ä¸èµ°åˆ°ç»“å°¾éƒ¨åˆ†ä¹Ÿæ²¡æ³•å¼€å§‹è®¡ç®—å“ˆå¸Œ=ï¼Œ=è¿™éƒ½ç»™äººè°ƒè¯•å®Œäº†ã€‚&lt;/p>
&lt;h2 id="ç»“è®º">ç»“è®º&lt;/h2>
&lt;p>æ‰€æœ‰æ¡ˆä¾‹ä»£ç éƒ½åœ¨è¿™é‡Œï¼š[github.com/nnnewb/learning-packer](&lt;a class="link" href="https://github.com/nnnewb/learning-packer/tree/main/packer6" target="_blank" rel="noopener"
>learning-packer/packer6 at main Â· nnnewb/learning-packer (github.com)&lt;/a>)&lt;/p>
&lt;p>æ€»ç»“å°±æ˜¯åè°ƒè¯•ä¸»è¦é  &lt;em>åˆ¤æ–­è°ƒè¯•å™¨ç‰¹å¾&lt;/em> æ¥å‘ç°æ­£åœ¨è¢«è°ƒè¯•ã€‚è€Œè¿™ä¸ªåˆ¤æ–­æ–¹æ³•å°±å¾ˆå¤šï¼Œä»ç¡¬ä»¶åˆ°æ“ä½œç³»ç»Ÿå±‚é¢ï¼Œå†åˆ°è½¯ä»¶å±‚é¢ï¼Œéƒ½æœ‰æ´å¯ä»¥é’»ã€‚&lt;/p>
&lt;p>æ€»ç»“è¿™ç¯‡é‡Œå®è·µçš„åè°ƒè¯•ï¼ˆæˆ–è€…è¯´æ£€æµ‹è°ƒè¯•å™¨ï¼‰æ–¹å¼æœ‰è¿™äº›ï¼š&lt;/p>
&lt;ul>
&lt;li>PEBå’Œç›¸å…³ç»“æ„çš„å„ç§æ ‡å¿—ä½&lt;/li>
&lt;li>å†…æ ¸æ¥å£ï¼Œ&lt;code>NtQueryInformationProcess&lt;/code>ã€&lt;code>NtSetInformationThread&lt;/code>ç­‰ç­‰&lt;/li>
&lt;li>å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œ&lt;code>SEH&lt;/code>ï¼Œ&lt;code>VEH&lt;/code>ï¼Œè§¦å‘ä¼šè¢«è°ƒè¯•å™¨å¤„ç†çš„å¼‚å¸¸ï¼ˆæˆ–è€…åªåœ¨æœ‰è°ƒè¯•å™¨æ—¶æ‰ä¼šè§¦å‘çš„å¼‚å¸¸ï¼‰æ¥å‘ç°è°ƒè¯•å™¨&lt;/li>
&lt;li>è°ƒè¯•å¯„å­˜å™¨å’Œç¡¬ä»¶æ–­ç‚¹&lt;/li>
&lt;li>ä»£ç å®Œæ•´æ€§æ ¡éªŒå‘ç°è½¯ä»¶æ–­ç‚¹&lt;/li>
&lt;/ul>
&lt;p>ä»¥ä¸Šå°±æ˜¯æœ¬ç¯‡å®éªŒè¿‡çš„æ‰€æœ‰åè°ƒè¯•æ€è·¯äº†ã€‚åŸæœ¬åº”è¯¥æœ‰ä¸ªé€šè¿‡ TLS å›è°ƒéšè—è‡ªèº«çš„æ¡ˆä¾‹ï¼Œä½†æ˜¯ MinGW åŠ ä¸äº† TLS å›è°ƒï¼ˆå¯èƒ½è¿˜æ˜¯æˆ‘èœï¼‰ï¼Œè°·æ­Œæœåˆ°çš„åšæ³•éƒ½æ˜¯è¦å¯¹ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶æ‰“è¡¥ä¸ï¼Œå¤ªéº»çƒ¦å°±æ²¡æã€‚&lt;/p>
&lt;p>å¦å¤–è¿˜æœ‰ä¸ªåˆ©ç”¨æ‰§è¡Œæ—¶é—´åšåè°ƒè¯•ï¼Œå› ä¸ºä¸çŸ¥é“ç°åœ¨éƒ½æ˜¯æ€ä¹ˆåˆ©ç”¨ï¼Œç„¶åæ˜¯è¿™ä¸ªåè°ƒè¯•åŸç†æ„Ÿè§‰ä¹Ÿæ˜¯å¾ˆç®€å•=ï¼Œ=å°±æ˜¯åˆ©ç”¨æ–¹æ³•å¯èƒ½åƒå¥‡ç™¾æ€ªï¼Œå•å•å†™ä¸¤æ¬¡ time è°ƒç”¨æ„Ÿè§‰æ²¡å•¥æ„ä¹‰å°±æ²¡å†™ï¼ˆå·æ‡’äº†ï¼‰ã€‚&lt;/p>
&lt;p>æ€»ä¹‹å°±æ˜¯éšè—å¥½åè°ƒè¯•çš„ä»£ç ï¼Œç„¶åå‘ç°è°ƒè¯•å™¨å°±æ‚„æ‚„æ–½å±•è¿·æƒ‘æ‰‹æ®µæˆ–è€…å¹²è„†å¤§æç ´åã€‚&lt;/p>
&lt;h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™&lt;/h2>
&lt;ul>
&lt;li>&lt;a class="link" href="https://www.apriorit.com/dev-blog/367-anti-reverse-engineering-protection-techniques-to-use-before-releasing-software" target="_blank" rel="noopener"
>Anti Debugging Protection Techniques With Examples&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://www.geoffchappell.com/" target="_blank" rel="noopener"
>Geoff Chappell, Software Analyst&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://ctf-wiki.org/" target="_blank" rel="noopener"
>CTF Wiki&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://book.douban.com/subject/25868289/" target="_blank" rel="noopener"
>ã€Šæ¶æ„ä»£ç åˆ†æå®æˆ˜ã€‹&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>å†…å®¹ä¸»è¦æ¥è‡ªç¬¬ä¸€ä¸ªé“¾æ¥ï¼Œæ ¹æ®æˆ‘çš„ç¯å¢ƒåšäº†ä¸€äº›ä¿®æ”¹ï¼ˆæ¯”å¦‚æœ‰äº›SEHçš„æˆ‘å®æµ‹ x32dbg ä¸è¡Œå°±æ¢æˆäº†VEHï¼‰ï¼Œç»“åˆå‚è€ƒäº† CTF wiki å’Œ ã€Šæ¶æ„ä»£ç åˆ†æå®æˆ˜ã€‹è¿™ä¹¦ã€‚API å…¨æ˜¯å¾®è½¯çš„æ–‡æ¡£å’Œæ²¡æœ‰æ–‡æ¡£åŒ–çš„æ¥å£æˆ‘ä¸ä¸€ä¸ªä¸€ä¸ªæ‘†é“¾æ¥äº†ã€‚&lt;/p></description></item><item><title>åŠ å£³åŸç†05ï¼šåˆ©ç”¨å›¾ç‰‡éšè—</title><link>https://nnnewb.github.io/blog/p/learning-packer-05/</link><pubDate>Thu, 21 Oct 2021 21:17:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/learning-packer-05/</guid><description>&lt;img src="https://nnnewb.github.io/blog/p/learning-packer-05/cover.jpg" alt="Featured image of post åŠ å£³åŸç†05ï¼šåˆ©ç”¨å›¾ç‰‡éšè—" />&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>å®Œæˆäº†ç®€å•çš„å‹ç¼©å£³ä¹‹åæ”¾æ¾ä¸‹ï¼Œåœ¨52è®ºå›ç—…æ¯’åˆ†æåŒºçœ‹åˆ°è¿‡å‡ æ¬¡æŠŠä»£ç éšè—åˆ°å›¾ç‰‡é‡Œçš„åšæ³•ï¼Œä¹Ÿçœ‹åˆ°è¿‡æŠŠç¨‹åºè½¬æˆå›¾ç‰‡åè®­ç»ƒç¥ç»ç½‘ç»œæ¥åˆ¤æ–­æœ‰æ²¡æœ‰æ¶æ„çš„ï¼Œäºæ˜¯å°±æƒ³ï¼Œæ·¦ï¼Œè¿™ä¸æ˜¯æŒºå¥½ç©çš„å˜›ã€‚&lt;/p>
&lt;h2 id="0x01-æ€è·¯">0x01 æ€è·¯&lt;/h2>
&lt;p>ç”¨å›¾ç‰‡ä¿å­˜ç¨‹åºæœ€ç®€å•çš„åšæ³•å°±æ˜¯ç›´æ¥æŠŠç¨‹åºæ¯ä¸ªå­—èŠ‚éƒ½è½¬æˆåƒç´ ï¼Œç„¶åè¾“å‡ºæˆç°åº¦å›¾ã€‚æ¯”è¾ƒè¿›é˜¶çš„åšæ³•å°±åƒæ˜¯äºŒç»´ç äº†ï¼Œå¤§è‰²å—ï¼Œå®¹é”™æ ¡éªŒï¼Œå›¾ç‰‡è¢«å‹åˆ°åŒ…æµ†ä¹Ÿèƒ½æ‰«å‡ºæ¥ã€‚ä½†é‚£ä¸ªæœ‰ç‚¹ç‚¹éš¾ï¼ˆæˆ‘èœï¼‰æœ€ç»ˆæˆæœä¹Ÿå¤§åˆ°ä¸ç°å®ï¼Œè€Œä¸”å®è¯è¯´æ‰“åŒ…åˆ°ç¨‹åºé‡Œå°±ä¸ç”¨è€ƒè™‘è¢«äºŒæ¬¡å‹ç¼©çš„æƒ…å†µäº†ã€‚æ‰€ä»¥ç®€å•çš„8bitç°åº¦å›¾å°±åˆ‘ã€‚&lt;/p>
&lt;p>è¯´åˆ°ä½å›¾è‚¯å®šæœ‰äººæƒ³åˆ°äº† BMP ï¼Œæˆ‘è®°å¾—ä¸Šå­¦é‚£ä¼šå„¿è¿˜è·Ÿç€ç½‘ä¸Šå“ªå„¿æ‰¾çš„æ•™ç¨‹ï¼Œå­¦ç€ç”¨ ffmpeg æŠŠ &lt;em>Bad Apple&lt;/em> è½¬æˆä½å›¾åºåˆ—ï¼Œå†è½¬æˆå­—ç¬¦å›¾åˆå¹¶æˆ HTMLï¼Œç”¨ js æ’­æ”¾ã€‚è¯´èµ·æ¥éƒ½æ˜¯æ³ªã€‚&lt;/p>
&lt;p>ç°åœ¨å·²ç»æˆäº†æ­£ç»çš„ç å†œï¼Œå†æŠ˜è…¾ BMP å°±æ²¡æ„æ€äº†ï¼ŒPNG å°±æŒºå¥½çš„ã€‚&lt;/p>
&lt;p>å›¾ç‰‡å¯ä»¥æ”¾åˆ° Section é‡Œâ€”â€”ä½†å¹¶æ²¡æœ‰æ„ä¹‰ï¼Œæ‰€ä»¥æˆ‘é€‰æ‹©æ”¾åˆ°èµ„æºé‡Œã€‚å†™ä¸€ä¸ª &lt;code>.rc&lt;/code> æ–‡ä»¶ç”¨ &lt;code>windres&lt;/code> ç¼–è¯‘å‡ºç›®æ ‡æ–‡ä»¶ï¼Œå†æ‹¿ &lt;code>gcc&lt;/code> é“¾æ¥å°±è¡Œäº†ã€‚å¦‚æ­¤ä¸€æ¥å¹¶æ²¡æœ‰ lief å‡ºåœºçš„æœºä¼šï¼Œç¼–è¯‘å¥½çš„åŠ è½½å™¨å°±æ˜¯åŠ å®Œå£³çš„ç¨‹åºã€‚&lt;/p>
&lt;p>åŠ è½½å™¨åˆ™é‡‡ç”¨å¼€å¯ ASLR çš„æ¨¡å¼ï¼Œè¿™æ ·ç¨‹åºçš„èŠ‚è¡¨ä¼šæ¯”è¾ƒå¹²å‡€ï¼Œæ²¡æœ‰æ˜æ˜¾ç‰¹å¾ï¼ˆè™½ç„¶ä¹Ÿæ²¡ä»€ä¹ˆåµç”¨ï¼‰ã€‚&lt;/p>
&lt;h2 id="0x02-åŠ è½½å™¨">0x02 åŠ è½½å™¨&lt;/h2>
&lt;h3 id="21-èµ„æºä»‹ç»">2.1 èµ„æºä»‹ç»&lt;/h3>
&lt;p>å‚è€ƒå¾®è½¯çš„æ–‡æ¡£ &lt;a class="link" href="https://docs.microsoft.com/en-us/windows/win32/menurc/using-resources" target="_blank" rel="noopener"
>Using Resources&lt;/a>ã€&lt;a class="link" href="https://docs.microsoft.com/en-us/windows/win32/menurc/resources" target="_blank" rel="noopener"
>Menu and Other Resources&lt;/a>ã€‚&lt;/p>
&lt;blockquote>
&lt;p>A &lt;em>resource&lt;/em> is binary data that you can add to the executable file of a Windows-based application. A resource can be either standard or defined. The data in a &lt;em>standard resource&lt;/em> describes an icon, cursor, menu, dialog box, bitmap, enhanced metafile, font, accelerator table, message-table entry, string-table entry, or version information. An &lt;em>application-defined resource&lt;/em>, also called a &lt;em>custom resource&lt;/em>, contains any data required by a specific application.&lt;/p>
&lt;/blockquote>
&lt;p>èµ„æºå°±æ˜¯ä¸€å †æ‰“åŒ…è¿›å¯æ‰§è¡Œæ–‡ä»¶é‡Œçš„äºŒè¿›åˆ¶æ•°æ®ï¼Œæœ‰æ ‡å‡†èµ„æºç±»å‹å’Œè‡ªå®šä¹‰çš„èµ„æºç±»å‹ï¼Œæ ‡å‡†çš„å›å¤´çœ‹å°±å…¨æ˜¯å¾®è½¯çš„å†å²åŒ…è¢±äº†ï¼Œè‡ªå®šä¹‰çš„å°±æ˜¯éšä¾¿ä»€ä¹ˆä¸œè¥¿ã€‚&lt;/p>
&lt;p>èµ„æºæœ¬èº«æ˜¯æœ‰ç»“æ„çš„ï¼Œå¤§ä½“ä¸Šåˆ†ä¸‰å±‚ï¼š&lt;/p>
&lt;ol>
&lt;li>ç±»å‹ï¼›æ¯”å¦‚å›¾æ ‡ã€å¯¹è¯æ¡†ã€ä½å›¾ã€Manifestç­‰ç­‰ã€‚&lt;/li>
&lt;li>IDï¼›èµ„æºçš„æ ‡è¯†ç¬¦ï¼Œå¯ä»¥æ˜¯æ•°å­—æˆ–å­—ç¬¦ä¸²ã€‚&lt;/li>
&lt;li>è¯­è¨€ï¼›è‹±è¯­æ³•è¯­ç­‰ç­‰..&lt;/li>
&lt;/ol>
&lt;p>ç»è¿‡è¿™æ ·ä¸‰å±‚ç´¢å¼•å°±èƒ½æ‰¾åˆ°å¯¹åº”èµ„æºçš„åŸå§‹æ•°æ®äº†ã€‚&lt;/p>
&lt;p>å¦‚å›¾ï¼š&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 194;
flex-basis: 467px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/learning-packer-05/07_resource_tree.png" data-size="1080x555">
&lt;img src="https://nnnewb.github.io/blog/blog/p/learning-packer-05/07_resource_tree.png"
width="1080"
height="555"
srcset="https://nnnewb.github.io/blog/blog/p/learning-packer-05/07_resource_tree_hu7434ebea0cccdf660ca2884c9de14b61_327250_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/learning-packer-05/07_resource_tree_hu7434ebea0cccdf660ca2884c9de14b61_327250_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="07_resource_tree.png">
&lt;/a>
&lt;figcaption>07_resource_tree.png&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;h3 id="22-æŸ¥æ‰¾å¹¶åŠ è½½èµ„æº">2.2 æŸ¥æ‰¾å¹¶åŠ è½½èµ„æº&lt;/h3>
&lt;p>æ­¥éª¤å¾ˆç®€å•ï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;code>FindResource&lt;/code> æ‰¾åˆ°ä½ è¦çš„èµ„æº&lt;/li>
&lt;li>&lt;code>SizeofResource&lt;/code> ç¡®å®šä½ è¦çš„èµ„æºå¤§å°&lt;/li>
&lt;li>&lt;code>LoadResource&lt;/code> åŠ è½½èµ„æºï¼Œå¾—åˆ° HANDLE&lt;/li>
&lt;li>&lt;code>LockResource&lt;/code> é”å®šèµ„æºï¼Œå¾—åˆ°èµ„æºé¦–å­—èŠ‚æŒ‡é’ˆ&lt;/li>
&lt;/ol>
&lt;p>å®ç°æ¯”è¾ƒå•°å—¦ï¼Œä¸»è¦æ˜¯é”™è¯¯æ£€æŸ¥å¾ˆå•°å—¦ã€‚æˆ‘è¿™è¿”å›å€¼éƒ½æ˜¯éšä¾¿ return çš„ï¼Œæ›´å¥½çš„åšæ³•åº”è¯¥æ˜¯ &lt;code>GetLastError&lt;/code> å»æ‹¿é”™è¯¯ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="kt">int&lt;/span> &lt;span class="nf">get_resource&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">buffer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">size_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">length&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">HRSRC&lt;/span> &lt;span class="n">res_found&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">FindResourceA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;BEAUTIFUL.PNG&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">RT_RCDATA&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">res_found&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">MessageBoxA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;find resource failed&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;FindResourceA&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MB_OK&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">DWORD&lt;/span> &lt;span class="n">sizeof_res&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">SizeofResource&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">res_found&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">sizeof_res&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">MessageBoxA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;sizeof resource failed&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;SizeofResource&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MB_OK&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">HGLOBAL&lt;/span> &lt;span class="n">res_loaded&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">LoadResource&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">res_found&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">res_loaded&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">MessageBoxA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;load resource failed&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;LoadResource&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MB_OK&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">LPVOID&lt;/span> &lt;span class="n">res_acquired&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">LockResource&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">res_loaded&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">res_acquired&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">MessageBoxA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;lock resource failed&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;LockResource&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MB_OK&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="o">*&lt;/span>&lt;span class="n">buffer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">malloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sizeof_res&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="o">*&lt;/span>&lt;span class="n">length&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sizeof_res&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">memcpy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">buffer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">res_acquired&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sizeof_res&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">UnlockResource&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">res_loaded&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">FreeResource&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">res_loaded&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¾—åˆ°æ•°æ®åå¤åˆ¶åˆ°æ–°åˆ†é…çš„å†…å­˜é‡Œè¿”å›å‡ºå»å°±å®Œäº‹äº†ã€‚&lt;/p>
&lt;h3 id="23-è§£æå›¾ç‰‡">2.3 è§£æå›¾ç‰‡&lt;/h3>
&lt;p>å¾—åˆ°äº†èµ„æºå›¾ç‰‡çš„å†…å®¹ä¹‹åï¼Œä¸‹ä¸€æ­¥å°±æ˜¯æŠŠå›¾ç‰‡è§£ç æˆåƒç´ ï¼Œè¿˜åŸåˆ°ç¨‹åºæœ¬èº«äº†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;#34;png.h&amp;#34;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stddef.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdint.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdio.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdlib.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;string.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="k">typedef&lt;/span> &lt;span class="kt">uint8_t&lt;/span> &lt;span class="n">u8&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">u8p&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">typedef&lt;/span> &lt;span class="kt">uint32_t&lt;/span> &lt;span class="n">u32&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">u32p&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// decode PNG in memory
&lt;/span>&lt;span class="c1">// https://stackoverflow.com/questions/53237065/using-libpng-1-2-to-write-rgb-image-buffer-to-png-buffer-in-memory-causing-segme
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">u8p&lt;/span> &lt;span class="nf">read_program_from_png&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">u8p&lt;/span> &lt;span class="n">data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">size_t&lt;/span> &lt;span class="n">length&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">png_image&lt;/span> &lt;span class="n">image&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">memset&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">image&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">image&lt;/span>&lt;span class="p">));&lt;/span>
&lt;span class="n">image&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">version&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">PNG_IMAGE_VERSION&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">png_image_begin_read_from_memory&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">image&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">length&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">png_bytep&lt;/span> &lt;span class="n">buffer&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">image&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">format&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">PNG_FORMAT_GRAY&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">size_t&lt;/span> &lt;span class="n">input_data_length&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">PNG_IMAGE_SIZE&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">image&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">buffer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">png_bytep&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">malloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">input_data_length&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">memset&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">buffer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">input_data_length&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">png_image_finish_read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">image&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">buffer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">u32&lt;/span> &lt;span class="n">actual_len&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">u32&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">buffer&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">program&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">malloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">actual_len&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">memcpy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">program&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">buffer&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">actual_len&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">free&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">buffer&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">u8p&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">program&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>é¢å‘ stackoverflow ç¼–ç¨‹ï¼Œç…§ç€æŠ„ä¸€ä¸ª libpng çš„è§£ç å®ç°ã€‚ä¸åŒçš„æ˜¯æŠŠè§£ç åçš„å¤´4ä¸ªå­—èŠ‚ä½œä¸ºå°ç«¯åºæ— ç¬¦å·æ•´å‹ï¼Œè®¤ä¸ºæ˜¯ç¨‹åºçš„å®é™…å¤§å°ã€‚å› ä¸ºç¨‹åºçš„å¤§å°å¯èƒ½å¹¶ä¸æ­£å¥½æ˜¯å›¾ç‰‡çš„åƒç´ æ•°é‡ï¼ˆwidth*heightï¼‰ã€‚&lt;/p>
&lt;p>æœ€åæ˜¯æŠŠè§£ç åçš„å†…å®¹å¤åˆ¶åˆ°æ–°åˆ†é…çš„å†…å­˜é‡Œè¿”å›ã€‚ç°åœ¨è¿”å›çš„æŒ‡é’ˆåº”è¯¥å°±æŒ‡å‘æˆ‘ä»¬çš„ PE æ–‡ä»¶å†…å®¹äº†ã€‚&lt;/p>
&lt;h3 id="24-å…¥å£ç‚¹">2.4 å…¥å£ç‚¹&lt;/h3>
&lt;p>åœ¨å…¥å£ç‚¹ï¼Œè°ƒç”¨åŠ è½½èµ„æºå‡½æ•°è·å¾—èµ„æºæ•°æ®çš„æŒ‡é’ˆï¼Œä¼ ç»™è§£ç çš„å‡½æ•°ï¼Œå¾—åˆ°è§£ç åçš„PEæ–‡ä»¶æŒ‡é’ˆï¼Œç„¶ååŠ è½½å¹¶è·³è½¬åˆ°è¢«åŠ è½½ç¨‹åºçš„å…¥å£ç‚¹ï¼Œå°±è¿™ä¹ˆç®€å•ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="kt">int&lt;/span> &lt;span class="nf">_start&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">buffer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">size_t&lt;/span> &lt;span class="n">length&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">get_resource&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;BEAUTIFUL.PNG&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">buffer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">length&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">u8p&lt;/span> &lt;span class="n">program&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">read_program_from_png&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">u8p&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">buffer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">length&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">free&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">buffer&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">program&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">entrypoint&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="n">load_PE&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">program&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">entrypoint&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="n">free&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">program&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">MessageBoxA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;.packed section not found&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;loader error&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MB_OK&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="0x03-åŠ å£³æœº">0x03 åŠ å£³æœº&lt;/h2>
&lt;h3 id="31-ç¨‹åºè½¬å›¾ç‰‡">3.1 ç¨‹åºè½¬å›¾ç‰‡&lt;/h3>
&lt;p>ä½¿ç”¨ &lt;code>pypng&lt;/code> è¿™ä¸ªåŒ…å®ç°æŠŠäºŒè¿›åˆ¶ç¨‹åºè½¬å›¾ç‰‡ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">IMG_PATH&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;packer5-packed.png&amp;#39;&lt;/span>
&lt;span class="n">ROW_LEN&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">256&lt;/span>
&lt;span class="k">with&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;example.exe&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;rb&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">f&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">arr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;span class="n">content&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">read&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="n">content&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">struct&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">pack&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;&amp;lt;I&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">content&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="n">content&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">content&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">ROW_LEN&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">t&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">content&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">ROW_LEN&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">ROW_LEN&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="n">ROW_LEN&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="n">arr&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">t&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">png&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">from_array&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">arr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;L&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">save&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">IMG_PATH&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>éå¸¸ç®€å•çš„ä¸€æ®µè„šæœ¬ã€‚æŠŠå†…å®¹é•¿åº¦å’Œå†…å®¹æ‹¼æ¥åï¼Œä»¥ &lt;code>ROW_LEN&lt;/code> æ¯è¡Œï¼Œæ‹†æˆä¸€ä¸ªäºŒç»´æ•°ç»„ï¼Œç„¶åç”¨ pypng ç¼–ç å¹¶ä¿å­˜ã€‚&lt;/p>
&lt;h3 id="32-ç¼–è¯‘èµ„æº">3.2 ç¼–è¯‘èµ„æº&lt;/h3>
&lt;p>éšä¾¿æ–°å»ºä¸€ä¸ª &lt;code>rsrc.rc&lt;/code> ã€‚&lt;/p>
&lt;p>åˆ«é—® &lt;code>.rc&lt;/code> æ€ä¹ˆå†™ï¼Œä¸çŸ¥é“ï¼Œé—®å°±æ˜¯é¢å‘è°·æ­Œç¼–ç¨‹æŠ„çš„ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">beautiful.png RCDATA &amp;#34;packer5-packed.png&amp;#34;
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶ååœ¨è„šæœ¬é‡Œè°ƒç”¨ &lt;code>windres&lt;/code> ç¼–è¯‘ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">def&lt;/span> &lt;span class="nf">windres&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sources&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">output&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">executable&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;windres&amp;#39;&lt;/span>
&lt;span class="n">args&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nb">isinstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sources&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">str&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">bytes&lt;/span>&lt;span class="p">)):&lt;/span>
&lt;span class="n">args&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">sources&lt;/span>
&lt;span class="k">elif&lt;/span> &lt;span class="nb">isinstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sources&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">list&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">tuple&lt;/span>&lt;span class="p">)):&lt;/span>
&lt;span class="n">args&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="s1">&amp;#39; &amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sources&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">cmd&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="sa">f&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">executable&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1"> &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1"> -o &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">output&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>
&lt;span class="n">proc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cmd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">shell&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">stderr&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">STDOUT&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="n">proc&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">returncode&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">raise&lt;/span> &lt;span class="n">CompilationError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">proc&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">returncode&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">proc&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">stdout&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">windres&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">src_dir&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;rsrc.rc&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">src_dir&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;rsrc.o&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å°±å¾—åˆ°äº† &lt;code>rsrc.o&lt;/code> ã€‚&lt;/p>
&lt;h3 id="33-ç¼–è¯‘åŠ è½½å™¨">3.3 ç¼–è¯‘åŠ è½½å™¨&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="c1"># compile shifted loader program&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">compile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sources&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">flags&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">args&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>
&lt;span class="n">compiler&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;gcc&amp;#39;&lt;/span>
&lt;span class="n">args&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nb">isinstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sources&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">str&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">bytes&lt;/span>&lt;span class="p">)):&lt;/span>
&lt;span class="n">args&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">sources&lt;/span>
&lt;span class="k">elif&lt;/span> &lt;span class="nb">isinstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sources&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">list&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">tuple&lt;/span>&lt;span class="p">)):&lt;/span>
&lt;span class="n">args&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="s1">&amp;#39; &amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sources&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">args&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="s1">&amp;#39; &amp;#39;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nb">isinstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">flags&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">str&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">bytes&lt;/span>&lt;span class="p">)):&lt;/span>
&lt;span class="n">args&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">flags&lt;/span>
&lt;span class="k">elif&lt;/span> &lt;span class="nb">isinstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">flags&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">list&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">tuple&lt;/span>&lt;span class="p">)):&lt;/span>
&lt;span class="n">args&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="s1">&amp;#39; &amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">flags&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">cmd&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="sa">f&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">compiler&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1"> &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>
&lt;span class="n">proc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cmd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">shell&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">stderr&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">STDOUT&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="n">proc&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">returncode&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">raise&lt;/span> &lt;span class="n">CompilationError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">proc&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">returncode&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">proc&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">stdout&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">cflags&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>
&lt;span class="s1">&amp;#39;-m32&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;-O2&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;-Wall&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;-I.&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;-Wl,--entry=__start&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;-nodefaultlibs&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;-nostartfiles&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;-lkernel32&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;-luser32&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;-lmsvcrt&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;-lpng&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;-o&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;packed.exe&amp;#39;&lt;/span>
&lt;span class="p">]&lt;/span>
&lt;span class="nb">compile&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">src_dir&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">src&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">src&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;loader.c&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;png_decode.c&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;rsrc.o&amp;#39;&lt;/span>&lt;span class="p">]],&lt;/span> &lt;span class="n">cflags&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;[+] compile loader with resource success.&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸»è¦æ˜¯åŠ ä¸Š &lt;code>-lpng&lt;/code> é“¾æ¥å‚æ•°ï¼Œé“¾æ¥ &lt;code>libpng&lt;/code> ã€‚è¾“å…¥æ–‡ä»¶é‡ŒåŠ ä¸Š &lt;code>png_decode.c&lt;/code> è¿™ä¸ªé‡Œé¢å®ç°äº† &lt;code>read_program_from_png&lt;/code>ï¼Œè¿˜æœ‰ç¼–è¯‘å¥½çš„èµ„æº &lt;code>rsrc.o&lt;/code>ã€‚&lt;/p>
&lt;h2 id="0x04-æˆæœå±•ç¤º">0x04 æˆæœå±•ç¤º&lt;/h2>
&lt;h3 id="41-å®Œæ•´ä»£ç ">4.1 å®Œæ•´ä»£ç &lt;/h3>
&lt;p>&lt;a class="link" href="https://github.com/nnnewb/learning-packer/tree/main/packer5" target="_blank" rel="noopener"
>github.com - packer05&lt;/a>&lt;/p>
&lt;h3 id="42-æˆæœ">4.2 æˆæœ&lt;/h3>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 149;
flex-basis: 359px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/learning-packer-05/png-packer.gif" data-size="934x624">
&lt;img src="https://nnnewb.github.io/blog/blog/p/learning-packer-05/png-packer.gif"
width="934"
height="624"
srcset="https://nnnewb.github.io/blog/blog/p/learning-packer-05/png-packer_hu49467b8d76a283ecefa4b0c8c018eaea_352500_480x0_resize_box.gif 480w, https://nnnewb.github.io/blog/blog/p/learning-packer-05/png-packer_hu49467b8d76a283ecefa4b0c8c018eaea_352500_1024x0_resize_box.gif 1024w"
loading="lazy"
alt="png-packer">
&lt;/a>
&lt;figcaption>png-packer&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 428;
flex-basis: 1028px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/learning-packer-05/image-20211021172402101.png" data-size="1123x262">
&lt;img src="https://nnnewb.github.io/blog/blog/p/learning-packer-05/image-20211021172402101.png"
width="1123"
height="262"
srcset="https://nnnewb.github.io/blog/blog/p/learning-packer-05/image-20211021172402101_hu5e82684139999b9b3beada7e64c4352c_121826_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/learning-packer-05/image-20211021172402101_hu5e82684139999b9b3beada7e64c4352c_121826_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211021172402101">
&lt;/a>
&lt;figcaption>image-20211021172402101&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 168;
flex-basis: 404px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/learning-packer-05/image-20211021172445654.png" data-size="745x442">
&lt;img src="https://nnnewb.github.io/blog/blog/p/learning-packer-05/image-20211021172445654.png"
width="745"
height="442"
srcset="https://nnnewb.github.io/blog/blog/p/learning-packer-05/image-20211021172445654_huadd050e73542001f453da1b3213f5950_43748_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/learning-packer-05/image-20211021172445654_huadd050e73542001f453da1b3213f5950_43748_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211021172445654">
&lt;/a>
&lt;figcaption>image-20211021172445654&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 176;
flex-basis: 422px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/learning-packer-05/image-20211021172504888.png" data-size="969x550">
&lt;img src="https://nnnewb.github.io/blog/blog/p/learning-packer-05/image-20211021172504888.png"
width="969"
height="550"
srcset="https://nnnewb.github.io/blog/blog/p/learning-packer-05/image-20211021172504888_hubda3186aaf1f68e7da983b4009bb0f3d_50213_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/learning-packer-05/image-20211021172504888_hubda3186aaf1f68e7da983b4009bb0f3d_50213_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211021172504888">
&lt;/a>
&lt;figcaption>image-20211021172504888&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>è¿™æ¬¡å®éªŒä¸»è¦æ˜¯éªŒè¯äº†ä»èµ„æºåŠ è½½ç¨‹åºï¼Œæœ¬è´¨å’Œä¹‹å‰çš„å…¶ä»–åŠ å£³æ–¹å¼æ²¡æœ‰åŒºåˆ«ã€‚æŠŠåº”ç”¨ç¨‹åºè½¬æ¢æˆå›¾ç‰‡åçœ‹åˆ°çš„æ•ˆæœç¡®å®æ¯”è¾ƒæœ‰è¶£ï¼Œæˆ‘æƒ³å¦‚æœç”¨ä¸€å¼ æ™®é€šçš„å›¾ç‰‡æˆ–è€…å…¶ä»–æ–‡ä»¶ç±»å‹ï¼Œè—èµ·æ¥å¯èƒ½æ›´éšè”½ã€‚&lt;/p>
&lt;p>ä½†åˆ°è¿™é‡Œè¿˜æ˜¯æœ‰æ˜æ˜¾çš„é—®é¢˜ï¼šå£³å’Œè¢«åŠ è½½çš„ç¨‹åºè¿˜æ˜¯æ³¾æ¸­åˆ†æ˜ã€‚&lt;/p></description></item><item><title>åŠ å£³åŸç†04 - zlibå‹ç¼©å£³æ¡ˆä¾‹</title><link>https://nnnewb.github.io/blog/p/learning-packer-04-zlib-compression-packer-demo/</link><pubDate>Wed, 20 Oct 2021 16:07:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/learning-packer-04-zlib-compression-packer-demo/</guid><description>&lt;img src="https://nnnewb.github.io/blog/p/learning-packer-04-zlib-compression-packer-demo/cover.jpg" alt="Featured image of post åŠ å£³åŸç†04 - zlibå‹ç¼©å£³æ¡ˆä¾‹" />&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>æœ¬æ–‡åœ¨å‰ä¸€ç¯‡åŸºç¡€ä¸Šï¼Œå†™ä¸€ä¸ªä½¿ç”¨ zlib çš„å‹ç¼©å£³æ¡ˆä¾‹ã€‚&lt;/p>
&lt;h2 id="0x01-zlib-è§£å‹">0x01 zlib è§£å‹&lt;/h2>
&lt;h3 id="11-æ¦‚è¿°">1.1 æ¦‚è¿°&lt;/h3>
&lt;p>å…³äº zlib çš„ç”¨æ³•æ‰¾äº†è¿™äº›å‚è€ƒèµ„æ–™ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;a class="link" href="https://zlib.net/zpipe.c" target="_blank" rel="noopener"
>zlib.net/zpipe.c&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://zlib.net/zlib_how.html" target="_blank" rel="noopener"
>zlib Usage Example&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://gist.github.com/arq5x/5315739" target="_blank" rel="noopener"
>Compress and Decompress a string with zlib&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>å°è¯•äº† zlibã€lzoã€Windows Compression APIï¼Œå¯¹å‹ç¼©å’Œè§£å‹ API çš„åŸºæœ¬æ¨¡å¼çš„åŸºæœ¬è®¤è¯†å¤§æ¦‚æ˜¯è¿™æ ·ï¼š&lt;/p>
&lt;ul>
&lt;li>é¦–å…ˆï¼Œä½ å¾—æœ‰è¢«å‹ç¼©æ•°æ®çš„å¤§å°ï¼ˆè¦ä¹ˆåˆ†å—å‹ç¼©ï¼Œè¦ä¹ˆæœ‰æ•´ä¸ªå‹ç¼©åçš„å¤§å°ï¼‰&lt;/li>
&lt;li>ç„¶åå¾—æœ‰è§£å‹åçš„é¢„æœŸå¤§å°ï¼Œè¿™ä¸ªèƒ½é€šè¿‡ &lt;em>å°è¯•è§£å‹&lt;/em> çš„æ“ä½œæ¥å®ç°ã€‚æ¯”å¦‚ Windows Compression API å’Œ lzo éƒ½å¯ä»¥åœ¨è§£å‹ buffer ä¼  NULLï¼Œå°è¯•å–å¾—è§£å‹åçš„å¤§å°ï¼Œå†åˆ†é…å¥½å†…å­˜è§£å‹ã€‚&lt;/li>
&lt;li>zlib è¿™æ ·çš„æµå¼å‹ç¼©ã€è§£å‹å¤„ç†æ–‡ä»¶æ¯”è¾ƒå‹å¥½ï¼Œä½†å…¨ç¨‹åœ¨å†…å­˜é‡Œè¿›è¡Œçš„è¯ï¼Œæµå¼è§£å‹å°±ä¼šå¯¼è‡´å¤§é‡å†…å­˜åˆ†é… =ã€‚= é™¤éä¸€å¼€å§‹å°±åˆ†é…è¶³å¤Ÿçš„ç©ºé—´ï¼Œä¸ç„¶ä¸€ä¸ªä¸€ä¸ªå†…å­˜å—ç”³è¯·å’Œåˆå¹¶ä¼šå¾ˆè›‹ç–¼ã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="12-å†…å­˜å¸ƒå±€">1.2 å†…å­˜å¸ƒå±€&lt;/h3>
&lt;p>å‹ç¼©åçš„ &lt;code>.packed&lt;/code> èŠ‚åœ¨å¤´éƒ¨ç•™å‡º 8 ä¸ªå­—èŠ‚ï¼Œåˆ†åˆ«ä¿å­˜å‹ç¼©åå¤§å°å’Œå‹ç¼©å‰å¤§å°ï¼Œä»¥ä¾¿ä¸€æ¬¡åˆ†é…å¥½å†…å­˜å®Œæˆè§£å‹ã€‚&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>åç§»&lt;/th>
&lt;th>å¤§å°&lt;/th>
&lt;th>å†…å®¹&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>0&lt;/td>
&lt;td>DWORD&lt;/td>
&lt;td>å°ç«¯åºï¼Œå‹ç¼©åå¤§å°&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>4&lt;/td>
&lt;td>DWORD&lt;/td>
&lt;td>å°ç«¯åºï¼Œå‹ç¼©å‰å¤§å°&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>8&lt;/td>
&lt;td>å¯å˜&lt;/td>
&lt;td>å‹ç¼©åçš„æ•°æ®&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="13-è§£å‹ä»£ç ">1.3 è§£å‹ä»£ç &lt;/h3>
&lt;p>è§£å‹è¿‡ç¨‹åœ¨åŠ è½½ PE ä¹‹å‰ï¼Œæ‰¾åˆ° &lt;code>.packed&lt;/code> èŠ‚åï¼Œå¼€å§‹è¯»å–å¤´éƒ¨å¤§å°ï¼Œå¹¶è°ƒç”¨è§£å‹ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">packed&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">DWORD&lt;/span> &lt;span class="n">compressed_size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">DWORD&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">packed&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// compressed size little-endian
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">DWORD&lt;/span> &lt;span class="n">decompressed_size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">DWORD&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">packed&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">));&lt;/span> &lt;span class="c1">// decompressed size little-endian
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">compressed&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">packed&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// compressed buffer
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">decompressed&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">malloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">decompressed_size&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// decompressed buffer
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">decompressed&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">MessageBoxA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;memory allocate failed&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;malloc&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MB_OK&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">decompress&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">compressed&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">compressed_size&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">decompressed&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">decompressed_size&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">entrypoint&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="n">load_PE&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">decompressed&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">entrypoint&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åº”è¯¥æ²¡æœ‰å¤ªå¤šç–‘é—®ã€‚æ¥ä¸‹æ¥çš„æ˜¯è§£å‹ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="kt">void&lt;/span> &lt;span class="nf">decompress&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">compressed&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">size_t&lt;/span> &lt;span class="n">length&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">decompressed&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">size_t&lt;/span> &lt;span class="n">decompressed_length&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">z_stream&lt;/span> &lt;span class="n">inflate_stream&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">inflate_stream&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">zalloc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Z_NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">inflate_stream&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">zfree&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Z_NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">inflate_stream&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">opaque&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Z_NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">inflate_stream&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">avail_in&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">uInt&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">length&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">inflate_stream&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">next_in&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">Bytef&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">compressed&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">inflate_stream&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">avail_out&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">uInt&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">decompressed_length&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">inflate_stream&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">next_out&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">Bytef&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">decompressed&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">inflateInit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">inflate_stream&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">err&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">inflate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">inflate_stream&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Z_NO_FLUSH&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">Z_STREAM_END&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">inflateEnd&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">inflate_stream&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">MessageBoxA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;zlib decompression failed&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;zlib&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MB_OK&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">inflateEnd&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">inflate_stream&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å®šä¹‰ inflate æµï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>avail_in&lt;/code> æ˜¯å¯ç”¨çš„è¾“å…¥ buffer å¤§å°&lt;/li>
&lt;li>&lt;code>avail_out&lt;/code> æ˜¯å¯ç”¨çš„è¾“å‡º buffer å¤§å°&lt;/li>
&lt;li>&lt;code>next_in&lt;/code> æ˜¯è¾“å…¥ buffer çš„æŒ‡é’ˆ&lt;/li>
&lt;li>&lt;code>next_out&lt;/code> æ˜¯è¾“å‡º buffer çš„æŒ‡é’ˆ&lt;/li>
&lt;li>&lt;code>zalloc&lt;/code>ã€&lt;code>zfree&lt;/code>ã€&lt;code>opaque&lt;/code> åˆå§‹åŒ–æˆ NULL&lt;/li>
&lt;/ul>
&lt;p>ä½¿ç”¨ &lt;code>inflateInit()&lt;/code> åˆå§‹åŒ–æµï¼Œç„¶åè°ƒç”¨ &lt;code>inflate()&lt;/code> è§£å‹ã€‚&lt;code>inflate()&lt;/code> ä¼šè¿”å›é”™è¯¯ç ï¼Œå¦‚æœé•¿åº¦æ­£å¥½ï¼Œä¼šè¿”å› &lt;code>Z_STREAM_END&lt;/code>ã€‚å¦‚æœè¾“å‡º buffer é•¿åº¦ä¸è¶³ï¼Œä½†è§£å‹æˆåŠŸï¼Œä¼šè¿”å› &lt;code>Z_OK&lt;/code>ã€‚å…¶ä»–æƒ…å†µä¼šè¿”å›é”™è¯¯ç ã€‚å› ä¸ºè¿™é‡Œå¾ˆæ¸…æ¥šç»™å®šçš„å‹ç¼©å‰é•¿åº¦ï¼Œè§£å‹å¿…å®šè¿”å› &lt;code>Z_STREAM_END&lt;/code>ï¼Œå…¶ä»–æƒ…å†µéƒ½æœ‰é—®é¢˜ï¼Œæ‰€ä»¥åªåšäº†ä¸€ä¸ªåˆ¤æ–­ã€‚&lt;/p>
&lt;p>å¯¹äºå…¶ä»–æƒ…å†µï¼Œé”™è¯¯ç å¯ä»¥ç”¨ &lt;code>zError&lt;/code> è·å–é”™è¯¯æè¿°ã€‚&lt;/p>
&lt;p>è§£å‹ç»“æŸåè¦ä½¿ç”¨ &lt;code>inflateEnd()&lt;/code> å…³é—­æµã€‚&lt;/p>
&lt;h2 id="0x02-zlibå‹ç¼©">0x02 zlibå‹ç¼©&lt;/h2>
&lt;p>å› ä¸ºä½¿ç”¨ python å†™åŠ å£³æœºï¼Œå°±ä¸ç”¨è¿™ä¹ˆéº»çƒ¦äº†ã€‚&lt;/p>
&lt;p>åœ¨å¤„ç† &lt;code>.packed&lt;/code> èŠ‚çš„æ—¶å€™ï¼Œä½¿ç”¨ &lt;code>struct&lt;/code> å’Œ &lt;code>zlib&lt;/code> ä¸¤ä¸ª python è‡ªå¸¦çš„åº“å°±èƒ½å®Œæˆå‹ç¼©å’Œå¡«å……å¤´ã€‚&lt;/p>
&lt;p>åœ¨è„šæœ¬å¤´éƒ¨æ·»åŠ ä¸¤å¥ &lt;code>import&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="kn">import&lt;/span> &lt;span class="nn">struct&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">zlib&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶åä¿®æ”¹åŠ å£³ä»£ç ä¸­ï¼Œæ·»åŠ  &lt;code>.packed&lt;/code> èŠ‚çš„ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="c1"># add packed section&lt;/span>
&lt;span class="k">with&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;example.exe&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;rb&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">f&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">file_content&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">read&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="n">origin_length&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file_content&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">compressed&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">zlib&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">compress&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file_content&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">9&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">compressed_length&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">compressed&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">section_content&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">struct&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">pack&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;&amp;lt;II&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">compressed_length&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">origin_length&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">section_content&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">compressed&lt;/span>
&lt;span class="n">packed_section&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">lief&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Section&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;.packed&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">packed_section&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">content&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">list&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">section_content&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">packed_section&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">characteristics&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">lief&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">SECTION_CHARACTERISTICS&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">MEM_READ&lt;/span> &lt;span class="o">|&lt;/span>
&lt;span class="n">lief&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">SECTION_CHARACTERISTICS&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">CNT_INITIALIZED_DATA&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">output&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">add_section&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">packed_section&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°ä½¿ç”¨ &lt;code>zlib.compress&lt;/code> å°±å®Œæˆäº†å‹ç¼©ï¼Œä¸ç”¨åŸå§‹ zlib æµé‚£ä¹ˆéº»çƒ¦ã€‚&lt;/p>
&lt;p>&lt;code>struct.pack&lt;/code> æŒ‡å®šäº†å°ç«¯åºï¼Œä¸¤ä¸ª4å­—èŠ‚intï¼Œåˆ†åˆ«å¡«å†™å‹ç¼©åå¤§å°å’ŒåŸå§‹å¤§å°ï¼Œè¿æ¥å‹ç¼©åçš„æ•°æ®ï¼Œå¡«å……è¿›&lt;code>.packed&lt;/code> èŠ‚ã€‚&lt;/p>
&lt;p>å°±è¿™æ ·ï¼Œå‹ç¼©åŠŸèƒ½æˆåŠŸå®Œæˆã€‚&lt;/p>
&lt;h2 id="0x03-æˆæœå±•ç¤º">0x03 æˆæœå±•ç¤º&lt;/h2>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 175;
flex-basis: 420px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/learning-packer-04-zlib-compression-packer-demo/compression-packer.gif" data-size="961x548">
&lt;img src="https://nnnewb.github.io/blog/blog/p/learning-packer-04-zlib-compression-packer-demo/compression-packer.gif"
width="961"
height="548"
srcset="https://nnnewb.github.io/blog/blog/p/learning-packer-04-zlib-compression-packer-demo/compression-packer_hu48b8d61b8280e2749c0709493a3ebc66_545730_480x0_resize_box.gif 480w, https://nnnewb.github.io/blog/blog/p/learning-packer-04-zlib-compression-packer-demo/compression-packer_hu48b8d61b8280e2749c0709493a3ebc66_545730_1024x0_resize_box.gif 1024w"
loading="lazy"
alt="compression-packer">
&lt;/a>
&lt;figcaption>compression-packer&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 493;
flex-basis: 1184px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/learning-packer-04-zlib-compression-packer-demo/image-20211020154513713.png" data-size="612x124">
&lt;img src="https://nnnewb.github.io/blog/blog/p/learning-packer-04-zlib-compression-packer-demo/image-20211020154513713.png"
width="612"
height="124"
srcset="https://nnnewb.github.io/blog/blog/p/learning-packer-04-zlib-compression-packer-demo/image-20211020154513713_hu9ea9ff8b4b10d51b1ae7242496aa71bc_14861_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/learning-packer-04-zlib-compression-packer-demo/image-20211020154513713_hu9ea9ff8b4b10d51b1ae7242496aa71bc_14861_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211020154513713">
&lt;/a>
&lt;figcaption>image-20211020154513713&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 181;
flex-basis: 435px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/learning-packer-04-zlib-compression-packer-demo/image-20211020154539546.png" data-size="512x282">
&lt;img src="https://nnnewb.github.io/blog/blog/p/learning-packer-04-zlib-compression-packer-demo/image-20211020154539546.png"
width="512"
height="282"
srcset="https://nnnewb.github.io/blog/blog/p/learning-packer-04-zlib-compression-packer-demo/image-20211020154539546_hu04f79f6a0431df840a4406ea20a286f1_11213_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/learning-packer-04-zlib-compression-packer-demo/image-20211020154539546_hu04f79f6a0431df840a4406ea20a286f1_11213_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211020154539546">
&lt;/a>
&lt;figcaption>image-20211020154539546&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>å·æ‡’äº†ï¼Œç”¨äº†ä¸€äº› msvcrt çš„å‡½æ•°ï¼Œæ¯”å¦‚ mallocï¼Œè¦åŠ ä¸ª &lt;code>-lmsvcrt&lt;/code> é“¾æ¥é€‰é¡¹ã€‚æœ€ç»ˆæˆå“å‹ç¼©ç‡è¿˜å¯ä»¥ï¼Œä»107KB å‹ç¼©åˆ°äº† 49KBï¼Œzlib ä¸è´ŸæœŸæœ›ã€‚&lt;/p>
&lt;p>å†™å¥½å£³ç¨‹åºä¹‹åï¼Œä¸ç®¡æ˜¯åŠ å¯†è¿˜æ˜¯å‹ç¼©éƒ½æ˜¯å¾ˆå®¹æ˜“çš„äº‹æƒ…ï¼ˆæŒ‡å•çº¯åšä¸ªç®€å•å®ç°ï¼‰ï¼Œä½†é—®é¢˜ä¾ç„¶å­˜åœ¨ï¼š&lt;/p>
&lt;ul>
&lt;li>64ä½ç¨‹åºâ€”â€”æˆ‘è§‰å¾—å¯ä»¥ä»¥åå†è¯´å§ï¼Ÿæˆ‘è¿64ä½æ±‡ç¼–éƒ½è¿˜ä¸ä¼šï¼ˆæ³ªï¼‰ã€‚&lt;/li>
&lt;li>è„±å£³è·Ÿç©ä¸€æ ·â€”â€”ç°åœ¨çœ‹ .packed å·²ç»æ²¡æœ‰ MZ è¿™ä¸ªæ‘†æ˜äº†æ˜¯åŸå§‹ç¨‹åºçš„æ ‡å¿—äº†ï¼Œä½†å¹¶æ²¡æœ‰åµç”¨ã€‚å£³ç¨‹åºä¹Ÿæ²¡æ··æ·†å’Œåè°ƒè¯•ï¼ŒèŠ‚è¡¨ä¹Ÿæ˜¯æ¸…æ™°å¯è§ï¼Œæ ¹æœ¬ä¸ç”¨åˆ†æã€‚&lt;/li>
&lt;/ul>
&lt;p>ä¸‹ä¸€ç¯‡è¿˜æ²¡æƒ³å¥½åšä»€ä¹ˆï¼Œå¾—å…ˆç»§ç»­å­¦ä¹ å……å®ä¸‹è‡ªå·±ï¼Œæ‰¾ä¸ªæ–¹å‘ã€‚&lt;/p></description></item><item><title>åŠ å£³åŸç†03 - æ”¯æŒæ²¡æœ‰é‡å®šä½çš„ç¨‹åº</title><link>https://nnnewb.github.io/blog/p/learning-packer-03-support-no-relocations/</link><pubDate>Wed, 20 Oct 2021 10:25:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/learning-packer-03-support-no-relocations/</guid><description>&lt;img src="https://nnnewb.github.io/blog/p/learning-packer-03-support-no-relocations/cover.jpg" alt="Featured image of post åŠ å£³åŸç†03 - æ”¯æŒæ²¡æœ‰é‡å®šä½çš„ç¨‹åº" />&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>è·ç¦»ä¸Šä¸€ç¯‡åŠ å£³åŸç†å·²ç»è¿‡å»æŒºä¹…äº†ï¼Œè¿™æ®µæ—¶é—´ç¨å¾®æŠ˜è…¾äº†ä¸€ä¸‹ nasmï¼Œå°è¯•æ‰‹å·¥åˆ¶ä½œäº† PE32 æ–‡ä»¶ï¼Œç§¯ç´¯äº†ä¸€äº›åŸºæœ¬çš„çŸ¥è¯†å§ã€‚&lt;/p>
&lt;p>æ‰€ä»¥ç°åœ¨ç»§ç»­å­¦ä¹ åŠ å£³â€”â€”å¦‚ä½•å¯¹ä¸æ”¯æŒ ASLR çš„ PE32 ç¨‹åºè¿›è¡ŒåŠ å£³ï¼Ÿ&lt;/p>
&lt;h2 id="0x01-å…³äºaslr">0x01 å…³äºASLR&lt;/h2>
&lt;p>ASLRæ˜¯ä¸€é¡¹å†…å­˜ä¿æŠ¤æŠ€æœ¯ï¼Œç”¨äºé˜²èŒƒå†…å­˜æŸåæ¼æ´ï¼Œæ¯”å¦‚ç¼“å†²åŒºæº¢å‡ºã€‚éœ€è¦æ³¨æ„çš„æ˜¯ ASLR å¹¶ä¸æ˜¯ &lt;em>è§£å†³&lt;/em> äº†ç›¸å…³å¨èƒï¼Œè€Œæ˜¯è®©åˆ©ç”¨ç›¸å…³çš„æ¼æ´å˜å¾—æ›´åŠ å›°éš¾å’Œå…·æœ‰æŒ‘æˆ˜æ€§ã€‚&lt;/p>
&lt;p>ASLR çš„å…¨åæ˜¯ &lt;em>Address Space Layout Randomization&lt;/em> ï¼Œåœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–æŠ€æœ¯ã€‚ä¸€ä¸ªå…¸å‹çš„ PE32 ç¨‹åºåœ¨æ²¡æœ‰ ASLR æ”¯æŒçš„æƒ…å†µä¸‹ï¼Œ åœ°å€ç©ºé—´å¸ƒå±€æ˜¯ç¡®å®šçš„ï¼šç¨‹åºé•œåƒæ€»ä¼šåŠ è½½åˆ°å›ºå®šçš„åœ°å€ã€‚è¿™ä¸ªåœ°å€ä¼šåœ¨æ–‡ä»¶å¤´é‡ŒæŒ‡å®šã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‰¹ç‚¹æ¥æ„é€ æ¶æ„æ•°æ®ï¼Œè®©å­˜åœ¨å†…å­˜æŸåæ¼æ´çš„ç¨‹åºæŒ‰æ”»å‡»è€…æ„å›¾è·³è¿‡æˆ–æ‰§è¡Œç‰¹å®šé€»è¾‘ï¼Œé€ æˆå®‰å…¨å¨èƒã€‚&lt;/p>
&lt;p>å¯¹åº” ASLR çš„åœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–ï¼Œç¨‹åºéœ€è¦å†æ¬¡ç¼–è¯‘æ¥æ”¯æŒé‡å®šä½ &lt;em>Relocation&lt;/em> ï¼Œåˆ«æ— ä»–æ³•ï¼ˆå¤§æ¦‚ï¼‰ã€‚&lt;/p>
&lt;h2 id="0x02-æ€è·¯">0x02 æ€è·¯&lt;/h2>
&lt;p>å¯¹äºåŠ å£³ä¸€ä¸ªæ²¡æœ‰é‡å®šä½ï¼Œä¸æ”¯æŒ ASLR çš„ PE32 ç¨‹åºï¼Œå‡è®¾è¿™ä¸ªç¨‹åºçš„åŸºå€æ˜¯ &lt;code>0x04000000&lt;/code>ï¼ŒåŸå…ˆçš„ &lt;code>VirtualAlloc&lt;/code> æ–¹å¼åˆ†é…å†…å­˜æ˜¯è¡Œä¸é€šçš„ã€‚åŠ å£³åç¨‹åºè‹¥å¼€å¯ ASLRï¼Œåˆ™ &lt;code>0x04000000&lt;/code> å¯èƒ½å·²ç»å­˜åœ¨å…¶ä»–æ¨¡å—ï¼Œå¹¶ä¸èƒ½ä¿è¯è¿™ä¸ªåŸºå€å¯ç”¨ã€‚&lt;strong>æ‰€ä»¥åŠ å£³åçš„ç¨‹åºå¿…é¡»ä¹Ÿä½¿ç”¨ &lt;code>0x04000000&lt;/code> è¿™ä¸ªåŸºå€ï¼Œè€Œä¸”æ ‡è®°ä¸ºä¸æ”¯æŒ ASLR&lt;/strong>ï¼Œé¿å…åŸºå€å·²ç»è¢«å…¶ä»–æ¨¡å—ä½¿ç”¨é€ æˆåŠ è½½å™¨æ— æ³•å·¥ä½œã€‚&lt;/p>
&lt;p>å°†åŠ å£³åç¨‹åºçš„åŸºå€è®¾ç½®ä¸ºå›ºå®šçš„ &lt;code>0x04000000&lt;/code> åˆä¼šäº§ç”Ÿæ–°çš„é—®é¢˜ï¼šåŠ è½½å™¨çš„ä»£ç æ®µä¸èƒ½æ”¾åœ¨ &lt;code>0x04000000&lt;/code> ï¼Œå¦åˆ™åŠ è½½å™¨è¿è¡Œæ—¶å°±ä¼šå‡ºç°è¢«è¢«åŠ è½½çš„ä»£ç è¦†ç›–çš„æƒ…å†µï¼Œå¯¼è‡´ç¨‹åºè·‘é£ã€‚æ‰€ä»¥&lt;strong>ç¼–è¯‘åçš„åŠ è½½å™¨æ‰€æœ‰ Section éƒ½å¿…é¡»æœ‰ä¸€å®šçš„åç§»ï¼Œè¿™ä¸ªåç§»å€¼å°±æ˜¯è¢«åŠ è½½ç¨‹åºçš„ Section å¤§å°ä¹‹å’Œï¼ˆå¯¹é½åï¼‰&lt;/strong>ã€‚è€Œå› æ­¤å¤šå‡ºæ¥çš„ç©ºé—´å•ç‹¬åˆ†æˆä¸€ä¸ª Section ï¼Œæ­£å¥½ç”¨æ¥æ”¾è¦åŠ è½½çš„ç¨‹åºã€‚&lt;/p>
&lt;p>å¦å¤–ï¼Œè¿˜å¿…é¡»ç¡®è®¤æ–‡ä»¶å¤´å¤§å°æ˜¯å¦ä¸€è‡´ï¼Œå› ä¸º&lt;strong>æˆ‘ä»¬éœ€è¦å°†è¢«åŠ è½½ç¨‹åºçš„æ–‡ä»¶å¤´è¦†ç›–åŠ è½½å™¨çš„æ–‡ä»¶å¤´&lt;/strong>ã€‚è€Œ&lt;strong>æœ€å¼€å§‹é¢„ç•™çš„ç©ºé—´å¿…é¡»åˆ†é…ä¸ºä¸€ä¸ª Section&lt;/strong>ï¼Œè®© Windows çš„åŠ è½½å™¨èƒ½é¡ºåˆ©åŠ è½½ç¨‹åºè€Œä¸æŠ¥â€œä¸æ˜¯æœ‰æ•ˆçš„Win32ç¨‹åºâ€é”™è¯¯ã€‚&lt;/p>
&lt;p>å†…å­˜å¸ƒå±€ç¤ºæ„å›¾å¦‚ä¸‹ï¼š&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 796;
flex-basis: 1911px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/learning-packer-03-support-no-relocations/%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80.png" data-size="1155x145">
&lt;img src="https://nnnewb.github.io/blog/blog/p/learning-packer-03-support-no-relocations/%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80.png"
width="1155"
height="145"
srcset="https://nnnewb.github.io/blog/blog/p/learning-packer-03-support-no-relocations/%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80_hu26017091af2f4be7bf70029e5d75a3ba_13811_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/learning-packer-03-support-no-relocations/%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80_hu26017091af2f4be7bf70029e5d75a3ba_13811_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="å†…å­˜å¸ƒå±€">
&lt;/a>
&lt;figcaption>å†…å­˜å¸ƒå±€&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æ‰€ä»¥åŠ è½½å™¨çš„åŠ è½½æ­¥éª¤å¦‚ä¸‹ï¼š&lt;/p>
&lt;ol>
&lt;li>å¯»æ‰¾è¢«åŠ è½½çš„ Section ã€‚&lt;/li>
&lt;li>å¤åˆ¶æ–‡ä»¶å¤´è¦†ç›–è‡ªå·±çš„æ–‡ä»¶å¤´ã€‚&lt;/li>
&lt;li>ä»¥è‡ªå·±çš„åŸºå€ä¸ºè¢«åŠ è½½ç¨‹åºçš„åŸºå€ï¼Œå®ŒæˆåŠ è½½ã€‚&lt;/li>
&lt;/ol>
&lt;p>åŠ å£³æœºçš„åŠ å£³æ­¥éª¤å¦‚ä¸‹ï¼š&lt;/p>
&lt;ol>
&lt;li>è§£æè¢«åŠ å£³ç¨‹åºï¼Œè·å– Section å¤§å°ã€æ–‡ä»¶å¤´å¤§å°ã€å¯¹é½å¤§å°ç­‰ä¿¡æ¯ã€‚&lt;/li>
&lt;li>ç”ŸæˆåŠ è½½å™¨ç¨‹åºï¼Œæ ¹æ®ä¸Šä¸€æ­¥å–å¾—çš„æ•°æ®è®¡ç®—å‡ºåŠ è½½å™¨ Section çš„åç§»å’Œå¯¹é½ã€‚&lt;/li>
&lt;li>åˆå¹¶è¢«åŠ å£³ç¨‹åºå’ŒåŠ è½½å™¨ï¼Œç”Ÿæˆè¢«åŠ å£³ç¨‹åºã€‚&lt;/li>
&lt;/ol>
&lt;p>æ¡ˆä¾‹ç¨‹åºå¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;Windows.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">MessageBoxA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;Hello world!&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;MSGBOX&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MB_OK&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="0x03-åŠ è½½å™¨ä¿®æ”¹">0x03 åŠ è½½å™¨ä¿®æ”¹&lt;/h2>
&lt;p>åŠ è½½å™¨éœ€è¦æŠŠ &lt;code>VirtualAlloc&lt;/code> æ”¹æˆ &lt;code>GetModuleHandleA&lt;/code>ï¼Œå¹¶è§£é™¤å½“å‰ç¨‹åºæ–‡ä»¶å¤´çš„å†™ä¿æŠ¤ï¼Œå¹¶åœ¨éšåçš„å¤åˆ¶ Section é˜¶æ®µåŒæ ·ç”¨ &lt;code>VirtualProtect&lt;/code> è§£é™¤å†™ä¿æŠ¤ï¼Œæ·»åŠ æ‰§è¡Œæƒé™ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nf">load_PE&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">PE_data&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">IMAGE_DOS_HEADER&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_DOS_header&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_DOS_HEADER&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">PE_data&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">IMAGE_NT_HEADERS&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_NT_headers&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_NT_HEADERS&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">PE_data&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">p_DOS_header&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">e_lfanew&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// extract information from PE header
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">DWORD&lt;/span> &lt;span class="n">size_of_image&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">SizeOfImage&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">DWORD&lt;/span> &lt;span class="n">entry_point_RVA&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">AddressOfEntryPoint&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">DWORD&lt;/span> &lt;span class="n">size_of_headers&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">SizeOfHeaders&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// base address
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">GetModuleHandleA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// make sure we can write in allocated memory
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">DWORD&lt;/span> &lt;span class="n">oldProtect&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">VirtualProtect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">p_image_base&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">SizeOfHeaders&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PAGE_READWRITE&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">oldProtect&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// copy PE headers in memory
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">mymemcpy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">p_image_base&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PE_data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">size_of_headers&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// Section headers starts right after the IMAGE_NT_HEADERS struct, so we do some pointer arithmetic-fu here.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">IMAGE_SECTION_HEADER&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">sections&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_SECTION_HEADER&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_NT_headers&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">FileHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">NumberOfSections&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// calculate the VA we need to copy the content, from the RVA
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// section[i].VirtualAddress is a RVA, mind it
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">dest&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">VirtualAddress&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// check if there is Raw data to copy
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">SizeOfRawData&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// make sure we can write in allocated sections
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">VirtualProtect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">SizeOfRawData&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PAGE_READWRITE&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">old_protect&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// We copy SizeOfRaw data bytes, from the offset PointerToRawData in the file
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">mymemcpy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PE_data&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">PointerToRawData&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">SizeOfRawData&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">VirtualProtect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">Misc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">VirtualSize&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PAGE_READWRITE&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">old_protect&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">size_t&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">Misc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">VirtualSize&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">dest&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ­¤å¤–è¿˜æœ‰ä¸€ä¸ªå‘ï¼šä¸çŸ¥é“ä¸ºå•¥ï¼Œæˆ‘ç”¨ lief python ç”Ÿæˆçš„ DataDirectories å®é™…åªæœ‰15ä¸ªå…ƒç´ ï¼ˆåŒ…æ‹¬æœ€åä¸€ä¸ª null å…ƒç´ ï¼‰ï¼Œä½† &lt;code>winnt.h&lt;/code> é‡Œå®šä¹‰çš„ DataDirectories æ˜¯å›ºå®šé•¿åº¦ 16 ä¸ªå…ƒç´ ï¼Œæ‰€ä»¥ç›´æ¥ç®— &lt;code>p_NT_header + 1&lt;/code> å¾—åˆ°çš„åç§»å€¼ä¼šæ¯”é¢„æœŸçš„å¤§ 8 ä¸ªå­—èŠ‚ï¼Œå¯¼è‡´æŠ¥æ‰¾ä¸åˆ° &lt;code>.packed&lt;/code> ã€‚&lt;/p>
&lt;p>æ”¹æˆè¿™æ ·ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="kt">int&lt;/span> &lt;span class="nf">_start&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">unpacker_VA&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">GetModuleHandleA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">IMAGE_DOS_HEADER&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_DOS_header&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">PIMAGE_DOS_HEADER&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">unpacker_VA&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">IMAGE_NT_HEADERS&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_NT_headers&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">PIMAGE_NT_HEADERS&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">unpacker_VA&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">p_DOS_header&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">e_lfanew&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">IMAGE_SECTION_HEADER&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">sections&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">PIMAGE_SECTION_HEADER&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_NT_headers&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// æ³¨æ„çœ‹è¿™é‡Œå†è®¡ç®—äº†ä¸€æ¬¡åç§»
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">sections&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">PIMAGE_SECTION_HEADER&lt;/span>&lt;span class="p">)((&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">sections&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_NUMBEROF_DIRECTORY_ENTRIES&lt;/span> &lt;span class="o">-&lt;/span>
&lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">NumberOfRvaAndSizes&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>
&lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_DATA_DIRECTORY&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="0x04-åŠ å£³å™¨">0x04 åŠ å£³å™¨&lt;/h2>
&lt;p>åŠ å£³å™¨è¿™æ¬¡ç”¨ python å†™ï¼ŒMinGW ä¸‹åˆè¦é‡æ–°ç¼–è¯‘ LIEF å¤ªæŠ˜ç£¨äººäº†ã€‚&lt;/p>
&lt;h3 id="41-å·¥å…·å‡½æ•°">4.1 å·¥å…·å‡½æ•°&lt;/h3>
&lt;p>å…ˆæ˜¯å¯¼å…¥å’Œå®šä¹‰å¿…è¦çš„å·¥å…·ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="kn">import&lt;/span> &lt;span class="nn">lief&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">align&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">al&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34; return &amp;lt;x&amp;gt; aligned to &amp;lt;al&amp;gt; &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">al&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">al&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">al&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="42-è§£æ">4.2 è§£æ&lt;/h3>
&lt;p>å…ˆåˆ†ææ¡ˆä¾‹ç¨‹åºï¼Œè·å¾—å¿…è¦çš„æ•°æ®ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">binary&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">lief&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;example.exe&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1"># calculate shift offset and reserved section size&lt;/span>
&lt;span class="n">image_base&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">binary&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">optional_header&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">imagebase&lt;/span>
&lt;span class="n">lowest_rva&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">min&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">virtual_address&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">s&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">binary&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sections&lt;/span>&lt;span class="p">])&lt;/span>
&lt;span class="n">highest_rva&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">max&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">virtual_address&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">s&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">size&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">s&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">binary&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sections&lt;/span>&lt;span class="p">])&lt;/span>
&lt;span class="n">sect_alignment&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">binary&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">optional_header&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">section_alignment&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;[+] analyze origin demo program binary success.&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å–å¾—åŸºå€ã€æ‰€æœ‰ section ä¸­æœ€ä½çš„èµ·å§‹ rva å’Œæœ€é«˜çš„ç»“æŸ rvaï¼Œå¾—åˆ°æ•´ä¸ª PE é•œåƒçš„ Sections è¦†ç›–çš„å†…å­˜èŒƒå›´ã€‚&lt;/p>
&lt;h3 id="43-æ„é€ åŠ è½½å™¨">4.3 æ„é€ åŠ è½½å™¨&lt;/h3>
&lt;p>ä½¿ç”¨ MinGW æ¥å®ŒæˆåŠ è½½å™¨æ„é€ â€”â€”å½“ç„¶æœ‰å…¶ä»–æ›´å¥½çš„åšæ³•ï¼ŒåŠ å£³è¿˜è¦è£…ä¸€ä¸ª MinGW æœªå…å¤ªéº»çƒ¦ï¼Œä½†æˆ‘ä¹Ÿä¸çŸ¥é“è¯¥æ€ä¹ˆåšå°±æ˜¯äº†ï¼ˆæˆ‘çŒœçš„è¯ï¼Œå¤§æ¦‚æ‹¿ nasm åº”è¯¥å°±åˆ‘ã€‚ï¼‰&lt;/p>
&lt;p>ç¼–è¯‘å‘½ä»¤åœ¨ Python è„šæœ¬é‡Œç”Ÿæˆå¹¶æ‰§è¡Œã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="c1"># compile shifted loader program&lt;/span>
&lt;span class="n">compile_args&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>
&lt;span class="s1">&amp;#39;loader.c&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;-m32&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;-O2&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;-Wall&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;-Wl,--entry=__start&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;-nodefaultlibs&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;-nostartfiles&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;-lkernel32&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;-luser32&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="sa">f&lt;/span>&lt;span class="s1">&amp;#39;-Wl,--image-base=&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="nb">hex&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">image_base&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="sa">f&lt;/span>&lt;span class="s1">&amp;#39;-Wl,--section-start=.text=&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="nb">hex&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">align&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">image_base&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="n">highest_rva&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">sect_alignment&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;-o&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;shifted-loader.exe&amp;#39;&lt;/span>
&lt;span class="p">]&lt;/span>
&lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">check_output&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39; &amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="s1">&amp;#39;gcc&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">compile_args&lt;/span>&lt;span class="p">]),&lt;/span> &lt;span class="n">shell&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">stderr&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">STDOUT&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;[+] compile shifted loader program success.&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">except&lt;/span> &lt;span class="n">CalledProcessError&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s1">&amp;#39;[!] loader compilation failed, &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">stdout&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">decode&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">raise&lt;/span>
&lt;span class="n">shifted_loader&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">lief&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;shifted-loader.exe&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">sect_alignment&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">shifted_loader&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">optional_header&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">section_alignment&lt;/span>
&lt;span class="n">file_alignment&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">shifted_loader&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">optional_header&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">file_alignment&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>-luser32&lt;/code> æ˜¯å› ä¸ºæˆ‘æ·»åŠ äº†ä¸€ä¸ª &lt;code>MessageBoxA&lt;/code> çš„è°ƒç”¨ã€‚&lt;/p>
&lt;p>&lt;code>-Wl,--image-base=...&lt;/code> è®¾ç½®äº†åŠ è½½å™¨çš„åŸºå€ï¼Œç¡®ä¿åŠ è½½å™¨å’Œè¢«åŠ å£³çš„ç¨‹åºè½åœ¨åŒä¸€ä¸ªåŸºå€ä¸Šã€‚&lt;/p>
&lt;p>&lt;code>-Wl,--section-start=...&lt;/code> å› ä¸ºçŸ¥é“ç¬¬ä¸€ä¸ª section ä¸€å®šæ˜¯ &lt;code>.text&lt;/code> æ‰€ä»¥åªè®¾ç½®äº†ç¬¬ä¸€ä¸ª section çš„åœ°å€ï¼Œä¹‹åçš„ section ä¼šè‡ªåŠ¨å¾€åæŒªã€‚&lt;/p>
&lt;p>å…¶ä»–å‚æ•°ä¸å¤šè§£é‡Šäº†ã€‚&lt;/p>
&lt;p>ç¼–è¯‘å®Œæˆåï¼Œå†è§£æå‡ºåŠ è½½å™¨çš„å¯¹é½ä¿¡æ¯ï¼Œå‡†å¤‡ç”¨äºæ„é€ å®Œæ•´çš„è¢«åŠ å£³ç¨‹åºã€‚&lt;/p>
&lt;h3 id="44-æ„é€ åŠ å£³ç¨‹åº">4.4 æ„é€ åŠ å£³ç¨‹åº&lt;/h3>
&lt;p>åŠ è½½å™¨å’Œè¢«åŠ è½½çš„ç¨‹åºéƒ½å·²ç»å°±ç»ªï¼Œæ¥ä¸‹æ¥å°±æ˜¯æŠŠåŠ è½½å™¨å’Œç¨‹åºåˆå¹¶æˆåŠ å£³åçš„ç¨‹åºäº†ã€‚è¿™ä¸€æ­¥è¿˜æ˜¯å…ˆåœ¨åˆ›å»º lief çš„PE32 å¯¹è±¡ï¼Œç„¶åå¡«å……åŸºå€ã€Section å¯¹é½ã€æ–‡ä»¶å¯¹é½ï¼Œå¹¶ä¸”æŠŠ DLL Characteristics é‡ç½®åˆ° 0ï¼Œç›®çš„æ˜¯å£°æ˜ä¸æ”¯æŒ ASLRã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="c1"># create new binary from scratch&lt;/span>
&lt;span class="n">output&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">lief&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Binary&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;packed&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">lief&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE_TYPE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE32&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1"># copy essential fields from shifted_loader&lt;/span>
&lt;span class="n">output&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">optional_header&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">imagebase&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">shifted_loader&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">optional_header&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">imagebase&lt;/span>
&lt;span class="n">output&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">optional_header&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">section_alignment&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">shifted_loader&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">optional_header&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">section_alignment&lt;/span>
&lt;span class="n">output&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">optional_header&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">file_alignment&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">shifted_loader&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">optional_header&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">file_alignment&lt;/span>
&lt;span class="c1"># disable ASLR&lt;/span>
&lt;span class="n">output&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">optional_header&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">dll_characteristics&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…ˆå‡†å¤‡è¿™äº›æ–‡ä»¶å¤´å­—æ®µï¼Œæ¥ä¸‹æ¥å¼€å§‹å¡«å…… Section ï¼Œæœ€å…ˆå¡«å……çš„å°±æ˜¯å‡†å¤‡ç”¨ä½œè¢«åŠ è½½ç¨‹åºå†…å­˜ç©ºé—´çš„ &lt;code>.alloc&lt;/code> èŠ‚ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="c1"># add .alloc section&lt;/span>
&lt;span class="n">allocate_size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">align&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">highest_rva&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">lowest_rva&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sect_alignment&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">allocate_section&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">lief&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Section&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;.alloc&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">allocate_section&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">virtual_address&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">lowest_rva&lt;/span>
&lt;span class="n">allocate_section&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">virtual_size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">allocate_size&lt;/span>
&lt;span class="n">allocate_section&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">characteristics&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">lief&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">SECTION_CHARACTERISTICS&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">MEM_READ&lt;/span>
&lt;span class="o">|&lt;/span> &lt;span class="n">lief&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">SECTION_CHARACTERISTICS&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">MEM_WRITE&lt;/span>
&lt;span class="o">|&lt;/span> &lt;span class="n">lief&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">SECTION_CHARACTERISTICS&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">CNT_UNINITIALIZED_DATA&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">output&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">add_section&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">allocate_section&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å°† &lt;code>.alloc&lt;/code> èŠ‚èµ·å§‹ç‚¹æ”¾ç½®åœ¨ä½ä½ï¼Œé•¿åº¦ä¸ºè¢«åŠ è½½ç¨‹åºçš„èŠ‚å¤§å°ä¹‹å’Œå¯¹é½ã€‚&lt;/p>
&lt;p>ä¹‹åå¼€å§‹å¤åˆ¶åŠ è½½å™¨çš„èŠ‚ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="c1"># copy sections&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="n">s&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">shifted_loader&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sections&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="c1"># let lief recalculate section offset and sizeof raw data&lt;/span>
&lt;span class="n">s&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">offset&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="n">s&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sizeof_raw_data&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="n">output&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">add_section&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>éœ€è¦æ³¨æ„&lt;/strong> æŠŠ &lt;code>offset&lt;/code> å’Œ &lt;code>sizeof_raw_data&lt;/code> ç½®é›¶ï¼Œè®© &lt;code>lief&lt;/code> å»è®¡ç®—åç§»å’Œå¤§å°ï¼Œåé¢æ·»åŠ çš„ä¸€åº”èŠ‚éƒ½æŒ‰è¿™æ ·æ“ä½œã€‚æ–°åˆ›å»ºçš„ Section è¿˜å¥½ï¼Œå¯¹äºä»åŠ è½½å™¨é‡Œå¤åˆ¶çš„ Sectionï¼Œä¿ç•™ &lt;code>offset&lt;/code> å’Œ &lt;code>sizeof_raw_data&lt;/code> ä¼šå¯¼è‡´æœ€ç»ˆæˆå“çš„ Section æ•°æ®ä¸æ­£ç¡®ï¼Œé€ æˆ &lt;code>ntdll&lt;/code> é‡ŒåŠ è½½PEæ–‡ä»¶æ—¶ï¼Œè¯»å–PEæ•°æ®ç»“æ„æ—¶å‡ºé”™ã€‚å¯ä»¥è‡ªè¡Œç”¨ x32dbg éªŒè¯ã€‚&lt;/p>
&lt;p>æœ€åæŠŠè¢«åŠ è½½çš„æ–‡ä»¶æ‰“åŒ…è¿›å»ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="c1"># add packed section&lt;/span>
&lt;span class="k">with&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;example.exe&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;rb&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">f&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">packed_section&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">lief&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Section&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;.packed&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">packed_section&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">content&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">list&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">read&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="n">packed_section&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">characteristics&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">lief&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">SECTION_CHARACTERISTICS&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">MEM_READ&lt;/span> &lt;span class="o">|&lt;/span>
&lt;span class="n">lief&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">SECTION_CHARACTERISTICS&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">CNT_INITIALIZED_DATA&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">output&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">add_section&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">packed_section&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åŒæ ·ï¼Œè®© lief å»è®¡ç®—åç§»å’Œå¤§å°ã€‚å¤åˆ¶å¥½èŠ‚ï¼Œç»§ç»­å¤åˆ¶ Data Directoriesï¼Œè¿™åˆæœ‰ä¸€ä¸ªå‘ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="c1"># copy data directories&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">15&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">src&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">shifted_loader&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">data_directories&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="n">output&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">data_directories&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">rva&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">src&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">rva&lt;/span>
&lt;span class="n">output&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">data_directories&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">src&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">size&lt;/span>
&lt;span class="c1"># correct number of data directories&lt;/span>
&lt;span class="c1"># warning: size of data directories may disagree with IMAGE_NT_HEADERS.DataDirectory in winnt.h&lt;/span>
&lt;span class="n">output&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">optional_header&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">numberof_rva_and_size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">output&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">data_directories&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>éœ€è¦æ³¨æ„åˆ°ï¼Œ&lt;strong>lief çš„æ•°æ®ç»“æ„é‡Œï¼Œå…è®¸çš„ data_directories åªæœ‰ 15 ä¸ª&lt;/strong>ï¼&lt;strong>ä½† &lt;code>winnt.h&lt;/code> é‡Œå®šä¹‰çš„ DATA_DIRECTORIES æ•°ç»„ï¼Œæ˜¯å›ºå®š16ä¸ªå…ƒç´ &lt;/strong>ï¼&lt;/p>
&lt;p>å¦‚æœç›´æ¥ &lt;code>range(16)&lt;/code> å»éå†ï¼Œä¼šå‡ºç° &lt;code>IndexError&lt;/code> ï¼Œå¦‚æœå¿½è§†è¿™ä¸ªé•¿åº¦é—®é¢˜ï¼Œç›´æ¥åœ¨åŠ è½½å™¨é‡Œé‡‡ç”¨ Windows SDK çš„å¤´æ–‡ä»¶å®šä¹‰çš„ç»“æ„ï¼Œä¼šå¯¼è‡´å–èŠ‚è¡¨æŒ‡é’ˆçš„æ—¶å€™æ¯”é¢„æœŸçš„å¤šåç§» 8 ä¸ªå­—èŠ‚ï¼Œé€ æˆé—®é¢˜ã€‚è°ƒè¯•èµ·æ¥ç®€ç›´å¤ªæŠ˜ç£¨äººäº†ã€‚&lt;/p>
&lt;p>ä¹‹åå†å¤åˆ¶å…¥å£ç‚¹å’Œé•œåƒå¤§å°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="c1"># copy original address of entrypoint&lt;/span>
&lt;span class="n">output&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">optional_header&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">addressof_entrypoint&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">shifted_loader&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">optional_header&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">addressof_entrypoint&lt;/span>
&lt;span class="c1"># let lief recalculate size of image&lt;/span>
&lt;span class="n">output&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">optional_header&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sizeof_image&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ³¨æ„ï¼Œå…¥å£ç‚¹å’Œé•œåƒå¤§å°çš„å­—æ®µå¿…é¡»åœ¨å¤åˆ¶å®Œ Section ä¹‹åå†å¤åˆ¶ï¼Œä¸ç„¶ lief ä¼šçŠ¯å‚»ï¼ŒåŸå› ä¸æ˜ï¼Œæœ‰å…´è¶£å¯ä»¥è‡ªå·±æ”¹ä¸€æ”¹é¡ºåºçœ‹çœ‹ç»“æœã€‚&lt;/p>
&lt;p>åˆ°è¿™é‡Œï¼ŒåŸºæœ¬å‡†å¤‡å°±ç»ªï¼Œå°±å¯ä»¥æŠŠæ„é€ å¥½çš„å¯æ‰§è¡Œæ–‡ä»¶å†™å…¥ç¡¬ç›˜äº†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="c1"># build output binary&lt;/span>
&lt;span class="n">builder&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">lief&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Builder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">output&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">builder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">build&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="n">builder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;packed.exe&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="45-å®Œæ•´ä»£ç ">4.5 å®Œæ•´ä»£ç &lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="c1"># %%&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">lief&lt;/span>
&lt;span class="kn">from&lt;/span> &lt;span class="nn">subprocess&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">STDOUT&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">CalledProcessError&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">check_output&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">align&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">al&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34; return &amp;lt;x&amp;gt; aligned to &amp;lt;al&amp;gt; &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">al&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">al&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">al&lt;/span>
&lt;span class="c1"># %%&lt;/span>
&lt;span class="c1"># compile origin demo program&lt;/span>
&lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">check_output&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;gcc example.c -m32 -O2 -o example.exe&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">shell&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">stderr&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">STDOUT&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">except&lt;/span> &lt;span class="n">CalledProcessError&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s1">&amp;#39;[!] demo program compilation failed, &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">stdout&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">decode&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">raise&lt;/span>
&lt;span class="n">binary&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">lief&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;example.exe&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;[+] compile origin demo program success.&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1"># %%&lt;/span>
&lt;span class="c1"># calculate shift offset and reserved section size&lt;/span>
&lt;span class="n">image_base&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">binary&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">optional_header&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">imagebase&lt;/span>
&lt;span class="n">lowest_rva&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">min&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">virtual_address&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">s&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">binary&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sections&lt;/span>&lt;span class="p">])&lt;/span>
&lt;span class="n">highest_rva&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">max&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">virtual_address&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">s&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">size&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">s&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">binary&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sections&lt;/span>&lt;span class="p">])&lt;/span>
&lt;span class="n">sect_alignment&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">binary&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">optional_header&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">section_alignment&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;[+] analyze origin demo program binary success.&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1"># %%&lt;/span>
&lt;span class="c1"># compile shifted loader program&lt;/span>
&lt;span class="n">compile_args&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>
&lt;span class="s1">&amp;#39;loader.c&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;-m32&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;-O2&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;-Wall&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;-Wl,--entry=__start&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;-nodefaultlibs&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;-nostartfiles&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;-lkernel32&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;-luser32&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="sa">f&lt;/span>&lt;span class="s1">&amp;#39;-Wl,--image-base=&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="nb">hex&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">image_base&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="sa">f&lt;/span>&lt;span class="s1">&amp;#39;-Wl,--section-start=.text=&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="nb">hex&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">align&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">image_base&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="n">highest_rva&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">sect_alignment&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;-o&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;shifted-loader.exe&amp;#39;&lt;/span>
&lt;span class="p">]&lt;/span>
&lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">check_output&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39; &amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="s1">&amp;#39;gcc&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">compile_args&lt;/span>&lt;span class="p">]),&lt;/span> &lt;span class="n">shell&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">stderr&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">STDOUT&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;[+] compile shifted loader program success.&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">except&lt;/span> &lt;span class="n">CalledProcessError&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s1">&amp;#39;[!] loader compilation failed, &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">stdout&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">decode&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">raise&lt;/span>
&lt;span class="n">shifted_loader&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">lief&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;shifted-loader.exe&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">sect_alignment&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">shifted_loader&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">optional_header&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">section_alignment&lt;/span>
&lt;span class="n">file_alignment&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">shifted_loader&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">optional_header&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">file_alignment&lt;/span>
&lt;span class="c1"># %%&lt;/span>
&lt;span class="c1"># create new binary from scratch&lt;/span>
&lt;span class="n">output&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">lief&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Binary&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;packed&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">lief&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE_TYPE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE32&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1"># copy essential fields from shifted_loader&lt;/span>
&lt;span class="n">output&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">optional_header&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">imagebase&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">shifted_loader&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">optional_header&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">imagebase&lt;/span>
&lt;span class="n">output&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">optional_header&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">section_alignment&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">shifted_loader&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">optional_header&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">section_alignment&lt;/span>
&lt;span class="n">output&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">optional_header&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">file_alignment&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">shifted_loader&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">optional_header&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">file_alignment&lt;/span>
&lt;span class="c1"># disable ASLR&lt;/span>
&lt;span class="n">output&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">optional_header&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">dll_characteristics&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="c1"># add .alloc section&lt;/span>
&lt;span class="n">allocate_size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">align&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">highest_rva&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">lowest_rva&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sect_alignment&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">allocate_section&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">lief&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Section&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;.alloc&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">allocate_section&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">virtual_address&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">lowest_rva&lt;/span>
&lt;span class="n">allocate_section&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">virtual_size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">allocate_size&lt;/span>
&lt;span class="n">allocate_section&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">characteristics&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">lief&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">SECTION_CHARACTERISTICS&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">MEM_READ&lt;/span>
&lt;span class="o">|&lt;/span> &lt;span class="n">lief&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">SECTION_CHARACTERISTICS&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">MEM_WRITE&lt;/span>
&lt;span class="o">|&lt;/span> &lt;span class="n">lief&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">SECTION_CHARACTERISTICS&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">CNT_UNINITIALIZED_DATA&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">output&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">add_section&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">allocate_section&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1"># copy sections&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="n">s&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">shifted_loader&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sections&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="c1"># let lief recalculate section offset and sizeof raw data&lt;/span>
&lt;span class="n">s&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">offset&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="n">s&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sizeof_raw_data&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="n">output&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">add_section&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1"># add packed section&lt;/span>
&lt;span class="k">with&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;example.exe&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;rb&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">f&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">packed_section&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">lief&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Section&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;.packed&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">packed_section&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">content&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">list&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">read&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="n">packed_section&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">characteristics&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">lief&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">SECTION_CHARACTERISTICS&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">MEM_READ&lt;/span> &lt;span class="o">|&lt;/span>
&lt;span class="n">lief&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">SECTION_CHARACTERISTICS&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">CNT_INITIALIZED_DATA&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">output&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">add_section&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">packed_section&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1"># copy data directories&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">15&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">src&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">shifted_loader&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">data_directories&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="n">output&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">data_directories&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">rva&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">src&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">rva&lt;/span>
&lt;span class="n">output&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">data_directories&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">src&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">size&lt;/span>
&lt;span class="c1"># correct number of data directories&lt;/span>
&lt;span class="c1"># warning: size of data directories may disagree with IMAGE_NT_HEADERS.DataDirectory in winnt.h&lt;/span>
&lt;span class="n">output&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">optional_header&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">numberof_rva_and_size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">output&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">data_directories&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1"># copy original address of entrypoint&lt;/span>
&lt;span class="n">output&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">optional_header&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">addressof_entrypoint&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">shifted_loader&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">optional_header&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">addressof_entrypoint&lt;/span>
&lt;span class="c1"># let lief recalculate size of image&lt;/span>
&lt;span class="n">output&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">optional_header&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sizeof_image&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="c1"># build output binary&lt;/span>
&lt;span class="n">builder&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">lief&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Builder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">output&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">builder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">build&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="n">builder&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;packed.exe&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;[+] create packed binary success.&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åªæ”¾ä¸€ä¸‹åŠ è½½å™¨ä»£ç ï¼Œä¸€å…±ä¸‰ä¸ªä»£ç æ–‡ä»¶æ‰˜ç®¡åœ¨ Gist ä¸Šï¼Œéœ€è¦å®‰è£… MinGW å’Œ LIEFï¼Œé…ç½®æ–¹å¼ä¸èµ˜è¿°ã€‚è¿˜ä¸ä¼š C å’Œ Python çš„è¯å»ºè®®å­¦ä¸€ä¸‹å…ˆå‘¢ã€‚&lt;/p>
&lt;p>&lt;a class="link" href="https://gist.github.com/nnnewb/28ca24ed4ee53f446120d64570c7ad01" target="_blank" rel="noopener"
>å®Œæ•´ä»£ç çš„ GIST&lt;/a>&lt;/p>
&lt;h2 id="0x05-æˆæœ">0x05 æˆæœ&lt;/h2>
&lt;p>åŠ å£³æœºè¿è¡Œæ•ˆæœã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/%E5%8A%A0%E5%A3%B3%E6%9C%BA.gif" >
&lt;img src="https://nnnewb.github.io/blog/blog/%E5%8A%A0%E5%A3%B3%E6%9C%BA.gif"
loading="lazy"
alt="åŠ å£³æœº">
&lt;/a>
&lt;figcaption>åŠ å£³æœº&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>&lt;code>packed.exe&lt;/code> çš„èŠ‚è¡¨ä¿¡æ¯å¦‚ä¸‹ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 171;
flex-basis: 411px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/learning-packer-03-support-no-relocations/image-20211020095008599.png" data-size="507x296">
&lt;img src="https://nnnewb.github.io/blog/blog/p/learning-packer-03-support-no-relocations/image-20211020095008599.png"
width="507"
height="296"
srcset="https://nnnewb.github.io/blog/blog/p/learning-packer-03-support-no-relocations/image-20211020095008599_hu133cb724811b185855f9a631cc001e91_10916_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/learning-packer-03-support-no-relocations/image-20211020095008599_hu133cb724811b185855f9a631cc001e91_10916_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211020095008599">
&lt;/a>
&lt;figcaption>image-20211020095008599&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;h2 id="ç»“è®º">ç»“è®º&lt;/h2>
&lt;p>æ•´ä¸ªè¿‡ç¨‹é‡Œè¸©äº†ä¸å°‘å‘ï¼Œå‡ ä¹éƒ½è¦é  x32dbg è°ƒè¯•å’Œ CFF Explorer æŒ¨ä¸ªæ–‡ä»¶å¤´å­—æ®µæ£€æŸ¥ã€‚æœ‰ä¸ªæ¯”è¾ƒå®ç”¨çš„åšæ³•æ˜¯æ‹¿ LIEF è§£æå¥½åŠ å£³åçš„æ–‡ä»¶ï¼ŒæŠŠè¾“å‡ºç»“æœå’ŒåŸå§‹åŠ è½½å™¨å¯¹æ¯”ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="kn">import&lt;/span> &lt;span class="nn">lief&lt;/span>
&lt;span class="n">packed&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">lief&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;packed.exe&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">loader&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">lief&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;shifted-loader.exe&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">with&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;packed-analysis.txt&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;w+&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">encoding&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;utf-8&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">out&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;-----&amp;#39;&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">out&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;packed.exe&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">out&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;-----&amp;#39;&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">out&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">packed&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">header&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">out&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">packed&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">optional_header&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">out&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="n">entry&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">packed&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">data_directories&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">out&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="n">s&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">packed&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sections&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">out&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">with&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;loader-analysis.txt&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;w+&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">encoding&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;utf-8&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">out&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;-----&amp;#39;&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">out&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;shifted-loader.exe&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">out&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;-----&amp;#39;&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">out&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">loader&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">header&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">out&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">loader&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">optional_header&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">out&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="n">entry&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">loader&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">data_directories&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">out&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="n">s&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">loader&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sections&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">out&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ†æå¥½ä¹‹åå°±å¯ä»¥æ‹¿ vscode å»æ¯”è¾ƒäº†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">code -n -d packed-analysis.txt loader-analysis.txt
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¯”èµ·ç›´æ¥æ‹¿ CFF Explorer ç¡¬çœ‹å­—æ®µå“ªå„¿ä¸å¯¹ï¼Œå’Œç¼–è¯‘å™¨äº§ç”Ÿçš„æ­£å¸¸æ–‡ä»¶æ¯”è¾ƒèƒ½æ’é™¤æ‰ä¸€äº›æ— å…³çš„å­—æ®µã€‚ä½†ä¹Ÿä¸æ˜¯ä¸‡èƒ½ï¼Œæ¯”å¦‚è¯´ä¹‹å‰æ²¡æœ‰å†™ &lt;code>section.offset=0&lt;/code>ï¼Œç»“æœç”Ÿæˆçš„ PE32 æ–‡ä»¶å¯¼å…¥è¡¨å†…å®¹åäº†ï¼Œä¸€ç›´æ²¡æ„è¯†åˆ°ã€‚ç›´åˆ° x32dbg è°ƒè¯•ä¸­å‘ç° ntdll é‡ŒåŠ è½½å¯¼å…¥è¡¨æ—¶ç¢°åˆ°äº†ä¸€ä¸ªæ— æ•ˆåœ°å€ï¼ˆæˆ‘æ€ä¹ˆçŸ¥é“æ˜¯åŠ è½½å¯¼å…¥è¡¨æ—¶å‘¢ï¼Œèƒ†å¤§å¿ƒç»†åŠ ä¸Š99%çš„è¿æ°”&amp;hellip;ï¼‰ï¼Œç„¶åçœ‹ CFF Explorer æ‰å‘ç°å¯¼å…¥è¡¨å®Œå…¨æŒ‚äº†ï¼Œå†å›å¤´çœ‹èŠ‚è¡¨æ‰å‘ç° &lt;code>.idata&lt;/code> çš„åç§»å’Œå¤§å°éƒ½æ˜¯åçš„&amp;hellip;&lt;/p>
&lt;p>è¿˜æœ‰ data directories çš„å‘ï¼Œä¹Ÿæ˜¯é  x32dbgï¼Œè·³è½¬åˆ°å†…å­˜ï¼Œæ‰å‘ç° &lt;code>(IMAGE_SECTION_HEADER*)(PIMAGE_NT_HEADERS+1)&lt;/code> ç®—å‡ºæ¥çš„åç§»å€¼å¤šäº†8å­—èŠ‚ï¼Œå†¥æ€è‹¦æƒ³è¿™8å­—èŠ‚æ€ä¹ˆå›äº‹ï¼Œèƒ¡ä¹±åˆ†æï¼Œç„¶åçªç„¶æ„è¯†åˆ° data directory æ­£å¥½ 8 å­—èŠ‚ï¼ŒåŠ å£³æœºé‡Œåˆæœ‰ä¸ªå¾ˆè¿·æƒ‘çš„ &lt;code>range(0,15)&lt;/code>ï¼Œåå¤ç¡®è®¤äº†å‡ æ¬¡æ‰å‘ç°çœŸçš„æ˜¯ LIEF å°±ç»™äº† 15 ä¸ª Data directory â€”â€” ä½† Windows SDK é‡Œ &lt;code>winnt.h&lt;/code> å®šä¹‰çš„æ˜¯ &lt;strong>å›ºå®š 16 ä¸ªå…ƒç´ &lt;/strong> ï¼Œä¹‹åå»ç¿» PE Format æ–‡æ¡£æ‰å‘ç°å¾®è½¯æ—©å°±æŒ–å¥½äº†è¿™ä¸ªå‘ç­‰ä½ ç¿»æ–‡æ¡£ï¼š&lt;/p>
&lt;blockquote>
&lt;p>Note that the number of directories is not fixed. Before looking for a specific directory, check the NumberOfRvaAndSizes field in the optional header.&lt;/p>
&lt;/blockquote>
&lt;p>åŸå…ˆçš„æ–‡ç« é¢„è®¡æ˜¯è¦åšä¸€ä¸ªå‹ç¼©å£³ï¼Œç®€å•è¯•éªŒäº†ä¸€ä¸‹æ²¡å•¥éš¾åº¦ï¼Œä»£ç éƒ½ä¸ç”¨å‡ è¡Œï¼ˆVS+CMake+VCPKG åŒæ—¶ç”¨ LIEF å’Œ ZLIB/LZO ä»€ä¹ˆçš„æœ‰ç‚¹è´¹åŠ²ï¼Œæ‰€ä»¥ç”¨ Windows Compression APIï¼‰ï¼Œå°±è¿™æ ·æ°´ä¸€ç¯‡æ–‡ç« æœ‰ç‚¹ä¸å¥½æ„æ€ã€‚æ‰€ä»¥å°±å…ˆå»çœ‹æ€ä¹ˆå¯¹ä»˜ä¸èƒ½é‡å®šä½çš„PE32äº†ï¼Œç»“æœæ LIEF çš„å„ç§ç¯å¢ƒç¼–è¯‘ã€æŠ˜è…¾VC++çš„Pragmaã€ç¿» Linker Script æ‰‹å†Œçœ‹èƒ½ä¸èƒ½æ”¹èŠ‚è¡¨åç§»ã€å­¦NASMã€ä»å›½åº†å‘åˆ°ç°åœ¨ã€‚&lt;/p>
&lt;p>æœ¬ç¯‡çš„å‚è€ƒæ–‡ç« æ˜¯ï¼šhttps://bidouillesecurity.com/tutorial-writing-a-pe-packer-part-4/&lt;/p>
&lt;p>æ–‡ä¸­æœ‰äº›åœ°æ–¹æ¯”è¾ƒæ€ªï¼Œæ¯”å¦‚è¯´å…ˆç¼–è¯‘äº†æ­£å¸¸ loader å†ç¼–è¯‘ shifted_loader å°±è®©äººä¸æ˜¯å¾ˆç†è§£ï¼Œç…§æŠ„æŠ„å‡ºä¸€å †bugã€‚æ‰€ä»¥æœ¬æ–‡çš„è„šæœ¬å’Œå‚è€ƒçš„è„šæœ¬å·²ç»æœ‰ç‚¹å¯¹ä¸ä¸Šäº†ã€‚&lt;/p>
&lt;p>å—åˆ¶äºä¸çŸ¥é“æ€ä¹ˆç¼–è¯‘å‡ºæ²¡æœ‰é‡å®šä½çš„ç¨‹åºï¼Œæˆ‘æ‹¿ä¸€ä¸ªæœ‰é‡å®šä½çš„åšäº†å®éªŒï¼ˆç†è®ºä¸Šæ¥è¯´ï¼Œåº”è¯¥æ˜¯ä¸€æ ·çš„å§ï¼Ÿï¼‰ï¼Œæ‰€ä»¥åˆ°å¤´ä¹Ÿä¸ç¡®å®šæ˜¯ä¸æ˜¯çœŸçš„èƒ½æŠŠæ²¡æœ‰é‡å®šä½çš„ç¨‹åºè·‘èµ·æ¥ã€‚&lt;/p>
&lt;p>å°±è¿™æ ·å§ï¼Œè¿™ä¸ªç»“è®ºæœ‰ç‚¹é•¿ã€‚åˆ°è¿™å°±å·®ä¸å¤šäº†ã€‚&lt;/p></description></item><item><title>å…³äºåœ¨å†…å­˜é‡Œæ‰¾kernel32è¿™ä»¶äº‹</title><link>https://nnnewb.github.io/blog/p/find-kernel32-in-memory/</link><pubDate>Thu, 14 Oct 2021 16:31:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/find-kernel32-in-memory/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>æ€»å¾—æœ‰ä¸ªå‰è¨€ã€‚&lt;/p>
&lt;p>ç”¨ nasm æ‰‹å·¥æ‰“é€ äº†ä¸€ä¸ª PE æ–‡ä»¶åï¼Œè¿™ä¸ª PE æ–‡ä»¶è¿˜æ²¡ä»€ä¹ˆåµç”¨ã€‚å¦‚æœè¦åŠ¨ IATï¼Œåˆå«Œéº»çƒ¦ã€‚ç½‘ä¸Šå†²æµªæ‰¾åˆ°&lt;a class="link" href="https://www.ired.team/offensive-security/code-injection-process-injection/finding-kernel32-base-and-function-addresses-in-shellcode#finding-kernel32-base-address" target="_blank" rel="noopener"
>ä¸€ç¯‡å…³äº shellcode çš„æ–‡ç« &lt;/a>ï¼Œè®²å¦‚ä½•åœ¨å†…å­˜é‡Œæ‰¾åˆ° kernel32.dll å¹¶è°ƒç”¨ WinExec å‡½æ•°ï¼Œäºæ˜¯å°±æƒ³å®è·µä¸€ä¸‹çœ‹çœ‹ï¼Œå®é™…æŠ„ä»£ç ç¢°åˆ°ä¸å°‘å‘ã€‚å¯¹æ±‡ç¼–åˆç†Ÿæ‚‰äº†ä¸€ç‚¹ã€‚&lt;/p>
&lt;h2 id="0x01-å¯»æ‰¾-kernel32">0x01 å¯»æ‰¾ kernel32&lt;/h2>
&lt;p>å¾®è½¯æœ‰ä¸€ç¯‡å¾ˆ&lt;a class="link" href="https://docs.microsoft.com/en-us/windows/win32/debug/thread-environment-block--debugging-notes-" target="_blank" rel="noopener"
>ç®€çŸ­çš„æ–‡ç« &lt;/a>ã€‚&lt;/p>
&lt;blockquote>
&lt;p>The Thread Environment Block (&lt;a class="link" href="https://docs.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-teb" target="_blank" rel="noopener"
>&lt;strong>TEB structure&lt;/strong>&lt;/a>) holds context information for a thread.&lt;/p>
&lt;p>In the following versions of Windows, the offset of the 32-bit TEB address within the 64-bit TEB is 0. This can be used to directly access the 32-bit TEB of a WOW64 thread. This might change in later versions of Windows&lt;/p>
&lt;/blockquote>
&lt;p>å¦å¤–åœ¨&lt;a class="link" href="https://en.wikipedia.org/wiki/Win32_Thread_Information_Block" target="_blank" rel="noopener"
>ç»´åŸºç™¾ç§‘é¡µé¢&lt;/a>ä¹Ÿæœ‰ä¸€ç‚¹æ¦‚è¿°ï¼Œ&lt;em>TIB&lt;/em> å°±æ˜¯ &lt;em>TEB&lt;/em> ã€‚&lt;em>TIB&lt;/em> å…¨ç§°æ˜¯ &lt;em>Thread Information Block&lt;/em> ï¼Œ&lt;em>TEB&lt;/em> æ˜¯ &lt;em>Thread Environment Block&lt;/em> ã€‚&lt;/p>
&lt;p>å…³äº &lt;em>TIB&lt;/em> å’Œ &lt;em>TEB&lt;/em> çš„å¾®è½¯å®˜æ–¹æ–‡æ¡£å’Œæ–‡ç« é“¾æ¥å¾ˆå¤šéƒ½å¤±æ•ˆäº†ï¼Œèƒ½æ‰¾åˆ°çš„ç›¸å…³ä¿¡æ¯ä¸å¤šã€‚ä½†æ˜¯å¾®è½¯è‡³å°‘è¿˜&lt;a class="link" href="https://docs.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-teb" target="_blank" rel="noopener"
>ç»™å‡ºäº† TEB çš„ç»“æ„å®šä¹‰&lt;/a>å§ï¼ˆåœ¨Windows SDK é‡Œï¼‰ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="k">typedef&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="nc">_TEB&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">Reserved1&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">12&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="n">PPEB&lt;/span> &lt;span class="n">ProcessEnvironmentBlock&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">Reserved2&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">399&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="n">BYTE&lt;/span> &lt;span class="n">Reserved3&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1952&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">TlsSlots&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">64&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="n">BYTE&lt;/span> &lt;span class="n">Reserved4&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">8&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">Reserved5&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">26&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">ReservedForOle&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">Reserved6&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">TlsExpansionSlots&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="n">TEB&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">PTEB&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¤§é‡çš„åˆºçœ¼çš„ &lt;code>Reserved&lt;/code> ã€‚ä¸è¿‡è¿˜å¥½ï¼ŒèŠ±äº†ç‚¹æ—¶é—´è¿˜æ˜¯è°·æ­Œå‡ºäº†æ‰€è°“çš„&lt;code>Undocumented&lt;/code>çš„ç›¸å…³ä¿¡æ¯ã€‚&lt;a class="link" href="http://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented%20Functions%2FNT%20Objects%2FThread%2FTEB.html" target="_blank" rel="noopener"
>NTAPI Undocumented Function&lt;/a>ã€‚ä¹Ÿå¯ä»¥åƒæˆ‘çœ‹çš„é‚£ç¯‡æ–‡ç« ä¸€æ ·ï¼Œç”¨ &lt;code>WinDbg Preview&lt;/code> å»å®é™…çœ‹çœ‹å†…å­˜é‡Œçš„ç»“æ„ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="k">typedef&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="nc">_TEB&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">NT_TIB&lt;/span> &lt;span class="n">Tib&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">EnvironmentPointer&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">CLIENT_ID&lt;/span> &lt;span class="n">Cid&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">ActiveRpcInfo&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">ThreadLocalStoragePointer&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PPEB&lt;/span> &lt;span class="n">Peb&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">LastErrorValue&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">CountOfOwnedCriticalSections&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">CsrClientThread&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">Win32ThreadInfo&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">Win32ClientInfo&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mh">0x1F&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">WOW32Reserved&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">CurrentLocale&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">FpSoftwareStatusRegister&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">SystemReserved1&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mh">0x36&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">Spare1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">ExceptionCode&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">SpareBytes1&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mh">0x28&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">SystemReserved2&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mh">0xA&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">GdiRgn&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">GdiPen&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">GdiBrush&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">CLIENT_ID&lt;/span> &lt;span class="n">RealClientId&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">GdiCachedProcessHandle&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">GdiClientPID&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">GdiClientTID&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">GdiThreadLocaleInfo&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">UserReserved&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">GlDispatchTable&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mh">0x118&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">GlReserved1&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mh">0x1A&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">GlReserved2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">GlSectionInfo&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">GlSection&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">GlTable&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">GlCurrentRC&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">GlContext&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">NTSTATUS&lt;/span> &lt;span class="n">LastStatusValue&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">UNICODE_STRING&lt;/span> &lt;span class="n">StaticUnicodeString&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">WCHAR&lt;/span> &lt;span class="n">StaticUnicodeBuffer&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mh">0x105&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">DeallocationStack&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">TlsSlots&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mh">0x40&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="n">LIST_ENTRY&lt;/span> &lt;span class="n">TlsLinks&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">Vdm&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">ReservedForNtRpc&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">DbgSsReserved&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mh">0x2&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">HardErrorDisabled&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">Instrumentation&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mh">0x10&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">WinSockData&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">GdiBatchCount&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">Spare2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">Spare3&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">Spare4&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">ReservedForOle&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">WaitingOnLoaderLock&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">StackCommit&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">StackCommitMax&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">StackReserved&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="n">TEB&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">PTEB&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸è¿‡ä¾ç„¶æ²¡ä»€ä¹ˆåµç”¨ï¼Œå› ä¸ºåœ¨ä¹çš„åªæœ‰ PPEB è¿™ä¸ªå­—æ®µã€‚å¥½å§ï¼Œç‚¹åˆ°ä¸ºæ­¢ã€‚&lt;/p>
&lt;p>åœ¨é‚£ç¯‡æ–‡ç« çš„åŸæ–‡é‡Œï¼Œç»™å‡ºçš„æ‰¾åˆ° kernel32.dll çš„æŸ¥æ‰¾è·¯å¾„æ˜¯è¿™æ ·çš„ï¼š&lt;code>TEB-&amp;gt;PEB-&amp;gt;Ldr-&amp;gt;InMemoryOrderLoadList-&amp;gt;currentProgram-&amp;gt;ntdll-&amp;gt;kernel32.BaseDll&lt;/code>&lt;/p>
&lt;h3 id="11--process-environment-block">1.1 Process Environment Block&lt;/h3>
&lt;p>ä» TEB å‡ºå‘ï¼Œæ‰¾åˆ° PEB &lt;code>(12*sizeof PVOID)==48==0x30&lt;/code> ã€‚PEB çš„ç»“æ„å¦‚ä¸‹ï¼Œæ–‡æ¡£å‚è€ƒ&lt;a class="link" href="http://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented%20Functions%2FNT%20Objects%2FProcess%2FPEB.html" target="_blank" rel="noopener"
>è¿™ä¸ª&lt;/a>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="k">typedef&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="nc">_PEB&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">BOOLEAN&lt;/span> &lt;span class="n">InheritedAddressSpace&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">BOOLEAN&lt;/span> &lt;span class="n">ReadImageFileExecOptions&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">BOOLEAN&lt;/span> &lt;span class="n">BeingDebugged&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">BOOLEAN&lt;/span> &lt;span class="n">Spare&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">HANDLE&lt;/span> &lt;span class="n">Mutant&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">ImageBaseAddress&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PPEB_LDR_DATA&lt;/span> &lt;span class="n">LoaderData&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PRTL_USER_PROCESS_PARAMETERS&lt;/span> &lt;span class="n">ProcessParameters&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">SubSystemData&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">ProcessHeap&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">FastPebLock&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PPEBLOCKROUTINE&lt;/span> &lt;span class="n">FastPebLockRoutine&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PPEBLOCKROUTINE&lt;/span> &lt;span class="n">FastPebUnlockRoutine&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">EnvironmentUpdateCount&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PPVOID&lt;/span> &lt;span class="n">KernelCallbackTable&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">EventLogSection&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">EventLog&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PPEB_FREE_BLOCK&lt;/span> &lt;span class="n">FreeList&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">TlsExpansionCounter&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">TlsBitmap&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">TlsBitmapBits&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mh">0x2&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">ReadOnlySharedMemoryBase&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">ReadOnlySharedMemoryHeap&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PPVOID&lt;/span> &lt;span class="n">ReadOnlyStaticServerData&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">AnsiCodePageData&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">OemCodePageData&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">UnicodeCaseTableData&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">NumberOfProcessors&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">NtGlobalFlag&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">BYTE&lt;/span> &lt;span class="n">Spare2&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mh">0x4&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="n">LARGE_INTEGER&lt;/span> &lt;span class="n">CriticalSectionTimeout&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">HeapSegmentReserve&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">HeapSegmentCommit&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">HeapDeCommitTotalFreeThreshold&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">HeapDeCommitFreeBlockThreshold&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">NumberOfHeaps&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">MaximumNumberOfHeaps&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PPVOID&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">ProcessHeaps&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">GdiSharedHandleTable&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">ProcessStarterHelper&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">GdiDCAttributeList&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">LoaderLock&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">OSMajorVersion&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">OSMinorVersion&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">OSBuildNumber&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">OSPlatformId&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">ImageSubSystem&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">ImageSubSystemMajorVersion&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">ImageSubSystemMinorVersion&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">GdiHandleBuffer&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mh">0x22&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">PostProcessInitRoutine&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">TlsExpansionBitmap&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">BYTE&lt;/span> &lt;span class="n">TlsExpansionBitmapBits&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mh">0x80&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">SessionId&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="n">PEB&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">PPEB&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¥ç€ä» PEB æ‰¾åˆ° &lt;code>Ldr&lt;/code>ï¼Œä½ç½®æ˜¯ &lt;code>(sizeof(BOOLEAN)*4+sizeof(HANDLE)+sizeof(PVOID))==12==0xc&lt;/code>ã€‚&lt;/p>
&lt;h3 id="12-peb_ldr_data">1.2 PEB_LDR_DATA&lt;/h3>
&lt;p>æ¥ç€ä» &lt;code>PEB_LDR_DATA&lt;/code> ç»“æ„é‡Œæ‰¾ &lt;code>InMemoryOrderModuleList&lt;/code> è¿™ä¸ªå­—æ®µï¼Œ&lt;code>PEB_LDR_DATA&lt;/code> ç»“æ„å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="k">typedef&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="nc">_PEB_LDR_DATA&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">ULONG&lt;/span> &lt;span class="n">Length&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">BOOLEAN&lt;/span> &lt;span class="n">Initialized&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">PVOID&lt;/span> &lt;span class="n">SsHandle&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">LIST_ENTRY&lt;/span> &lt;span class="n">InLoadOrderModuleList&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">LIST_ENTRY&lt;/span> &lt;span class="n">InMemoryOrderModuleList&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">LIST_ENTRY&lt;/span> &lt;span class="n">InInitializationOrderModuleList&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="n">PEB_LDR_DATA&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">PPEB_LDR_DATA&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰¾åˆ°&lt;code>InMemoryOrderModuleList&lt;/code>å­—æ®µï¼Œä½ç½®æ˜¯&lt;code>(sizeof(ULONG)+sizeof(BOOLEAN)+sizeof(PVOID)+sizeof(LIST_ENTRY))==20==0x14&lt;/code>&lt;/p>
&lt;p>æ³¨æ„ &lt;code>sizeof(BOOLEAN)&lt;/code> æ˜¯ &lt;code>BYTE&lt;/code> ç±»å‹ï¼Œä½†è¿™ä¸ªç»“æ„ä½“æ˜¯è¢«å¯¹é½åˆ°äº†4å­—èŠ‚çš„ï¼Œæ‰€ä»¥ BOOLEAN å­—æ®µåé¢å®é™…æœ‰3ä¸ªå­—èŠ‚çš„ paddingã€‚åˆèµ·æ¥å°±æ˜¯ä¸‰ä¸ª DWORD ã€‚&lt;/p>
&lt;h3 id="13-ldr_data_table_entry">1.3 LDR_DATA_TABLE_ENTRY&lt;/h3>
&lt;p>ä¹‹åå°±æ˜¯ LIST_ENTRY è¿™ä¸ªç»“æ„äº†ï¼Œç”¨ WinDbg æŸ¥äº†ä¸‹ç»“æ„ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">0:000&amp;gt; dt _LIST_ENTRY
ntdll!_LIST_ENTRY
+0x000 Flink : Ptr32 _LIST_ENTRY
+0x004 Blink : Ptr32 _LIST_ENTRY
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ ¹æ®ä¸Šé¢ &lt;em>Undocumented&lt;/em> æ–‡æ¡£å’ŒåŸæ–‡ç« çš„å™è¿°æ¥çœ‹ï¼Œè¿™åº”è¯¥å°±æ˜¯ä¸ªæŒ‡å‘ &lt;code>_LDR_DATA_TABLE_ENTRY&lt;/code> ç»“æ„ï¼ˆåŒå‘é“¾è¡¨ï¼‰çš„æŒ‡é’ˆã€‚&lt;code>_LIST_ENTRY&lt;/code>ç»“æ„æœ¬èº«æ˜¯åŒ…å«ä¸¤ä¸ªæŒ‡é’ˆï¼Œä¸€ä¸ª&lt;code>Forward&lt;/code>æ­£å‘æŒ‡é’ˆï¼Œä¸€ä¸ª&lt;code>Backward&lt;/code>ã€‚æ‰€ä»¥æˆ‘ä»¬å–&lt;code>Flink&lt;/code>å­—æ®µå°±å¯ä»¥ï¼Œè·³è¿‡&lt;code>InLoadOrderModuleList&lt;/code>è¿™ä¸ªå­—æ®µåï¼Œä¸€å…±åç§» &lt;code>0x14&lt;/code> å°±æ˜¯æˆ‘ä»¬è¦çš„ &lt;code>Flink&lt;/code> æŒ‡é’ˆäº†ï¼ŒæŒ‡å‘çš„åº”è¯¥æ˜¯ &lt;code>_LDR_DATA_TABLE_ENTRY&lt;/code> è¿™ä¸ªç»“æ„ä½“ä¸­çš„ &lt;code>InMemoryOrderLinks&lt;/code> å­—æ®µã€‚ä¸‹é¢ç»™å‡º&lt;code>_LDR_DATA_TABLE_ENTRY&lt;/code>çš„ç»“æ„ï¼ˆWinDbgï¼‰ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">0:000&amp;gt; dt _ldr_data_table_entry
ntdll!_LDR_DATA_TABLE_ENTRY
+0x000 InLoadOrderLinks : _LIST_ENTRY
+0x008 InMemoryOrderLinks : _LIST_ENTRY
+0x010 InInitializationOrderLinks : _LIST_ENTRY
+0x018 DllBase : Ptr32 Void
+0x01c EntryPoint : Ptr32 Void
+0x020 SizeOfImage : Uint4B
+0x024 FullDllName : _UNICODE_STRING
+0x02c BaseDllName : _UNICODE_STRING
+0x034 FlagGroup : [4] UChar
+0x034 Flags : Uint4B
+0x034 PackagedBinary : Pos 0, 1 Bit
+0x034 MarkedForRemoval : Pos 1, 1 Bit
+0x034 ImageDll : Pos 2, 1 Bit
+0x034 LoadNotificationsSent : Pos 3, 1 Bit
+0x034 TelemetryEntryProcessed : Pos 4, 1 Bit
+0x034 ProcessStaticImport : Pos 5, 1 Bit
+0x034 InLegacyLists : Pos 6, 1 Bit
+0x034 InIndexes : Pos 7, 1 Bit
+0x034 ShimDll : Pos 8, 1 Bit
+0x034 InExceptionTable : Pos 9, 1 Bit
+0x034 ReservedFlags1 : Pos 10, 2 Bits
+0x034 LoadInProgress : Pos 12, 1 Bit
+0x034 LoadConfigProcessed : Pos 13, 1 Bit
+0x034 EntryProcessed : Pos 14, 1 Bit
+0x034 ProtectDelayLoad : Pos 15, 1 Bit
+0x034 ReservedFlags3 : Pos 16, 2 Bits
+0x034 DontCallForThreads : Pos 18, 1 Bit
+0x034 ProcessAttachCalled : Pos 19, 1 Bit
+0x034 ProcessAttachFailed : Pos 20, 1 Bit
+0x034 CorDeferredValidate : Pos 21, 1 Bit
+0x034 CorImage : Pos 22, 1 Bit
+0x034 DontRelocate : Pos 23, 1 Bit
+0x034 CorILOnly : Pos 24, 1 Bit
+0x034 ChpeImage : Pos 25, 1 Bit
+0x034 ReservedFlags5 : Pos 26, 2 Bits
+0x034 Redirected : Pos 28, 1 Bit
+0x034 ReservedFlags6 : Pos 29, 2 Bits
+0x034 CompatDatabaseProcessed : Pos 31, 1 Bit
+0x038 ObsoleteLoadCount : Uint2B
+0x03a TlsIndex : Uint2B
+0x03c HashLinks : _LIST_ENTRY
+0x044 TimeDateStamp : Uint4B
+0x048 EntryPointActivationContext : Ptr32 _ACTIVATION_CONTEXT
+0x04c Lock : Ptr32 Void
+0x050 DdagNode : Ptr32 _LDR_DDAG_NODE
+0x054 NodeModuleLink : _LIST_ENTRY
+0x05c LoadContext : Ptr32 _LDRP_LOAD_CONTEXT
+0x060 ParentDllBase : Ptr32 Void
+0x064 SwitchBackContext : Ptr32 Void
+0x068 BaseAddressIndexNode : _RTL_BALANCED_NODE
+0x074 MappingInfoIndexNode : _RTL_BALANCED_NODE
+0x080 OriginalBase : Uint4B
+0x088 LoadTime : _LARGE_INTEGER
+0x090 BaseNameHashValue : Uint4B
+0x094 LoadReason : _LDR_DLL_LOAD_REASON
+0x098 ImplicitPathOptions : Uint4B
+0x09c ReferenceCount : Uint4B
+0x0a0 DependentLoadFlags : Uint4B
+0x0a4 SigningLevel : UChar
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¦æ³¨æ„åˆ° &lt;code>_LDR_DATA_TABLE_ENTRY&lt;/code> ç»“æ„ä¸­çš„ &lt;code>InMemoryOrderLinks&lt;/code> å¹¶ä¸æ˜¯åœ¨ç»“æ„å¼€å¤´ï¼Œæ‰€ä»¥å–å¾—çš„åœ°å€å¿…é¡»å…ˆå‡å»è¿™ä¸ªåç§»å€¼ï¼ˆ8å­—èŠ‚ï¼‰å†è½¬æ¢ç±»å‹æ‰æ˜¯æ­£ç¡®çš„ç»“æ„ã€‚&lt;/p>
&lt;h3 id="14-æ¨¡å—åŸºå€">1.4 æ¨¡å—åŸºå€&lt;/h3>
&lt;p>æ¥ç€ä» WinDbg å¯ä»¥å®é™…å‘ç°ï¼Œè¿™ä¸ªé“¾è¡¨é‡Œï¼Œæˆ‘ä»¬çš„ç¨‹åºä¹‹åå°±æ˜¯&lt;code>ntdll.dll&lt;/code>ï¼Œå†ä¹‹åå°±æ˜¯&lt;code>kernel32.dll&lt;/code>ï¼Œä¸å†æ¼”ç¤ºã€‚åæ­£å°±å½“&lt;code>kernel32.dll&lt;/code>å›ºå®šåœ¨è¿™ä¸ªé“¾è¡¨çš„ç¬¬ä¸‰ä¸ªå…ƒç´ å°±æ˜¯äº†ã€‚çœŸè¦é«˜é²æ£’æ€§çš„è¯å°±å¾—éå†è¿™ä¸ªé“¾è¡¨ï¼ŒæŒ‰åå­—æ‰¾å‡º &lt;code>kernel32.dll&lt;/code> å¯¹åº”çš„ç»“æ„ï¼Œå†å–åœ°å€â€”â€”éº»çƒ¦æ­»äº†ã€‚&lt;/p>
&lt;p>å–å¾— &lt;code>kernel32.dll&lt;/code> å¯¹åº”çš„ &lt;code>_LDR_DATA_TABLE_ENTRY&lt;/code> ç»“æ„åï¼Œå°±å¯ä»¥æå–å…¶ä¸­çš„ &lt;code>DllBase&lt;/code> å­—æ®µäº†ï¼Œè¿™ä¸ªå­—æ®µå°±æ˜¯ &lt;code>kernel32.dll&lt;/code> çš„åŸºå€ã€‚&lt;/p>
&lt;h3 id="15-teb-çš„ä½ç½®">1.5 TEB çš„ä½ç½®&lt;/h3>
&lt;p>è°·æ­Œä¸€ä¸‹ä¸éš¾æ‰¾åˆ°ï¼ŒWin32ç¨‹åºè¿›ç¨‹åœ°å€ç©ºé—´é‡Œï¼ŒTEBçš„åœ°å€å°±åœ¨ &lt;code>[fs:0]&lt;/code> è¿™ä¸ªåœ°å€ä¸Šã€‚&lt;/p>
&lt;h3 id="16-è·å–-kernel-32-åŸºå€">1.6 è·å– kernel 32 åŸºå€&lt;/h3>
&lt;p>é‚£å°±å¼€å§‹å†™æ±‡ç¼–ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nf">section&lt;/span> &lt;span class="no">.text&lt;/span>
&lt;span class="nf">global&lt;/span> &lt;span class="no">_main&lt;/span>
&lt;span class="nl">_main:&lt;/span>
&lt;span class="nf">push&lt;/span> &lt;span class="no">ebp&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">ebp&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="no">esp&lt;/span>
&lt;span class="c">; è·å– kernel32.dll åŸºå€
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="nf">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">fs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">30&lt;/span>&lt;span class="no">h&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; eax = TEB-&amp;gt;PEB
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="no">ch&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; eax = PEB-&amp;gt;Ldr
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">14&lt;/span>&lt;span class="no">h&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; eax = PEB_LDR_DATA-&amp;gt;InMemoryOrderModuleList.Flink (å½“å‰ç¨‹åº)
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; eax = &amp;amp;_LDR_DATA_TABLE_ENTRY.InMemoryOrderModuleList.Flink (ç°åœ¨æ˜¯ ntdll.dll)
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; eax = &amp;amp;_LDR_DATA_TABLE_ENTRY.InMemoryOrderModuleList.Flink (ç°åœ¨æ˜¯ kernel32.dll)
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax-8h&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">18&lt;/span>&lt;span class="no">h&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; eax = &amp;amp;_LDR_DATA_TABLE_ENTRY.DllBase (kernel32.dll åŸºå€)
&lt;/span>&lt;span class="c">&lt;/span>
&lt;span class="nf">xor&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="no">eax&lt;/span>
&lt;span class="nf">pop&lt;/span> &lt;span class="no">ebp&lt;/span>
&lt;span class="nf">retn&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç”¨ MinGW ç¼–è¯‘ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">nasm main.asm -f win32 -o main.o
gcc main.o -nostartfiles -nodefaultlibs -o main.exe
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç¬¬ä¸€æ­¥ &lt;code>[fs:30h]&lt;/code> è¿™ä¸ªåœ°å€å°±æ˜¯ TEB ä¸­çš„ PEB æŒ‡é’ˆï¼Œå°†æŒ‡é’ˆä¿å­˜çš„åœ°å€ç§»å…¥ &lt;code>eax&lt;/code> å¯„å­˜å™¨ã€‚ç°åœ¨ &lt;code>eax&lt;/code> å¯„å­˜å™¨æŒ‡å‘çš„å°±æ˜¯ PEB ç»“æ„äº†ã€‚&lt;/p>
&lt;p>ç¬¬äºŒæ­¥å– &lt;code>PEB-&amp;gt;Ldr&lt;/code> æŒ‡é’ˆã€‚&lt;/p>
&lt;p>ç¬¬ä¸‰æ­¥å– &lt;code>PEB_LDR_DATA-&amp;gt;InMemoryOrderModuleList.Flink&lt;/code> æŒ‡é’ˆï¼Œè¿™ä¸ªæŒ‡é’ˆæŒ‡å‘çš„æ˜¯å½“å‰ç¨‹åºçš„ &lt;code>_LDR_DATA_TABLE_ENTRY.InMemoryOrderModuleList.Flink&lt;/code> ã€‚æ­¤æ—¶æˆ‘ä»¬å·²ç»å¼€å§‹éå†é“¾è¡¨ã€‚&lt;/p>
&lt;p>ç¬¬å››æ­¥æ˜¯å–é“¾è¡¨çš„ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œæˆ‘ä»¬è®¤ä¸ºæ˜¯ &lt;code>ntdll.dll&lt;/code> ï¼Œå†å–ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œå¾—åˆ° &lt;code>kernel32.dll&lt;/code>ã€‚&lt;/p>
&lt;p>æ­¤æ—¶çš„ &lt;code>eax&lt;/code> æŒ‡å‘çš„è¿˜æ˜¯ &lt;code>_LDR_DATA_TABLE_ENTRY.InMemoryOrderModuleList.Flink&lt;/code> è¯·æ³¨æ„ï¼Œè®¡ç®—åç§»çš„æ—¶å€™è¦å…ˆç§»å›ç»“æ„çš„é¦–éƒ¨ï¼ˆ&lt;code>-0x08&lt;/code>ï¼‰å†è®¡ç®—ã€‚&lt;/p>
&lt;p>ç¬¬äº”æ­¥å°±æ˜¯ä» &lt;code>kernel32.dll&lt;/code> çš„ &lt;code>_LDR_DATA_TABLE_ENTRY&lt;/code> ç»“æ„é‡Œï¼Œå– &lt;code>DllBase&lt;/code> å­—æ®µçš„å€¼äº†ã€‚&lt;code>eax - 8h + 18h&lt;/code> å¾—åˆ° &lt;code>DllBase&lt;/code> å­—æ®µçš„åç§»åœ°å€ï¼Œæ‰§è¡Œåå¾—åˆ°çš„å°±æ˜¯ &lt;code>kernel32.dll&lt;/code> çš„åŸºå€æŒ‡é’ˆäº†ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å¯ä»¥ç”¨ WinDbg Preview éªŒè¯ä¸‹ã€‚&lt;/p>
&lt;p>&amp;hellip;.&lt;/p>
&lt;p>ä¸çŸ¥é“ä¸ºå•¥ WinDbg Preview ä¸èƒ½æ­£ç¡®è°ƒè¯•ï¼Œè¿˜æ˜¯ç”¨å› x32dbg ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/%e5%85%b3%e4%ba%8e%e5%9c%a8%e5%86%85%e5%ad%98%e9%87%8c%e6%89%bekernel32%e8%bf%99%e4%bb%b6%e4%ba%8b/image-20211014143628806.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/%e5%85%b3%e4%ba%8e%e5%9c%a8%e5%86%85%e5%ad%98%e9%87%8c%e6%89%bekernel32%e8%bf%99%e4%bb%b6%e4%ba%8b/image-20211014143628806.png"
loading="lazy"
alt="image-20211014143628806">
&lt;/a>
&lt;figcaption>image-20211014143628806&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æ³¨æ„æ­¤æ—¶ EAX çš„å€¼æ˜¯ &lt;code>75B30000&lt;/code> ï¼Œå†…å®¹è¢«è°ƒè¯•å™¨è¯†åˆ«ä¸º &lt;code>MZ?&lt;/code> ï¼Œæ˜¾ç„¶æ˜¯ä¸ª DOS æ–‡ä»¶å¤´ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/%e5%85%b3%e4%ba%8e%e5%9c%a8%e5%86%85%e5%ad%98%e9%87%8c%e6%89%bekernel32%e8%bf%99%e4%bb%b6%e4%ba%8b/image-20211014143759203.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/%e5%85%b3%e4%ba%8e%e5%9c%a8%e5%86%85%e5%ad%98%e9%87%8c%e6%89%bekernel32%e8%bf%99%e4%bb%b6%e4%ba%8b/image-20211014143759203.png"
loading="lazy"
alt="image-20211014143759203">
&lt;/a>
&lt;figcaption>image-20211014143759203&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>åœ¨è°ƒè¯•å™¨çš„å†…å­˜å¸ƒå±€çª—å£å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªåœ°å€æ­£å¥½å°±æ˜¯ &lt;code>kernel32.dll&lt;/code> çš„é•œåƒåŸºå€ã€‚&lt;/p>
&lt;p>åˆ°æ­¤ï¼Œæˆ‘ä»¬å·²ç»æ‰¾åˆ°äº† &lt;code>kernel32.dll&lt;/code> çš„é•œåƒåŸºå€ï¼Œæ‰¾åˆ°äº†é•œåƒåŸºå€åï¼Œæ ¹æ®ä¹‹å‰å­¦ä¹ çš„å¯¹ PE æ–‡ä»¶æ ¼å¼çš„äº†è§£ï¼Œå°±æœ‰æœºä¼šè‡ªå·±è§£æå¯¼å‡ºè¡¨ï¼Œè°ƒç”¨ &lt;code>kernel32.dll&lt;/code> å†…çš„å‡½æ•°å•¦ã€‚&lt;/p>
&lt;h2 id="0x02-å¯»æ‰¾-winexec-å‡½æ•°">0x02 å¯»æ‰¾ WinExec å‡½æ•°&lt;/h2>
&lt;p>ä½œä¸ºå®è·µçš„ç›®æ ‡ï¼Œè¿™æ¬¡å¸Œæœ›åœ¨ &lt;code>kernel32.dll&lt;/code> é‡Œæ‰¾å‡º &lt;code>WinExec&lt;/code> å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°çš„æ–‡æ¡£åœ¨&lt;a class="link" href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-winexec" target="_blank" rel="noopener"
>è¿™é‡Œ&lt;/a>ã€‚å‡½æ•°ç­¾åå¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="n">UINT&lt;/span> &lt;span class="nf">WinExec&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="p">[&lt;/span>&lt;span class="n">in&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">LPCSTR&lt;/span> &lt;span class="n">lpCmdLine&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">[&lt;/span>&lt;span class="n">in&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">UINT&lt;/span> &lt;span class="n">uCmdShow&lt;/span>
&lt;span class="p">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ–‡æ¡£è¯´æˆ‘ä»¬åº”è¯¥ç”¨ &lt;code>CreateProcess&lt;/code> ä½†æ˜¯é‚£ä¸ªå‡½æ•°å‚æ•°å¤šçš„ä¸€æ‰¹ï¼Œç‹—éƒ½ä¸çœ‹ã€‚å¾®è½¯å°±æ²¡ç‚¹13æ•°ä¹ˆã€‚&lt;/p>
&lt;h3 id="21-å¯»æ‰¾å¯¼å‡ºè¡¨">2.1 å¯»æ‰¾å¯¼å‡ºè¡¨&lt;/h3>
&lt;p>æœ‰äº† &lt;code>kernel32.dll&lt;/code> çš„åŸºå€ï¼Œä¸‹ä¸€æ­¥å°±æ˜¯å¯»æ‰¾å¯¼å‡ºè¡¨çš„ä½ç½®äº†ã€‚&lt;/p>
&lt;p>ä¾æ®æˆ‘ä»¬å¯¹ PE æ–‡ä»¶æ ¼å¼çš„äº†è§£ï¼Œé¦–å…ˆå¾—åœ¨ Data Directories é‡Œæ‰¾åˆ° &lt;em>Export Directory&lt;/em> ã€‚&lt;/p>
&lt;p>åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæš‚å­˜ä¸€ä¸‹ &lt;code>kernel32.dll&lt;/code> åŸºå€ä»¥å¤‡åç”¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm"> &lt;span class="nf">mov&lt;/span> &lt;span class="no">ebx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">eax&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶åå¼€å§‹å¯»æ‰¾ dos æ–‡ä»¶å¤´é‡Œçš„ &lt;code>lfanew&lt;/code> ã€‚ç›¸å¯¹æ–‡ä»¶å¤´çš„åç§»æ˜¯ &lt;code>3ch&lt;/code> ï¼Œå†…å®¹æ˜¯ç›¸å¯¹æ–‡ä»¶å¤´çš„åç§»å€¼ï¼Œæˆ‘ä»¬è¿™æ ·è®¡ç®—ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm"> &lt;span class="nf">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebx&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="no">ch&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nf">add&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">ebx&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç°åœ¨ eax æŒ‡å‘çš„å°±æ˜¯ pe æ–‡ä»¶å¤´äº†ã€‚&lt;/p>
&lt;p>ç„¶åæˆ‘ä»¬æ‰¾åˆ° &lt;code>ExportDirectory.VirtualAddress&lt;/code> çš„åç§»ï¼Œå®ƒåœ¨ç›¸å¯¹ PE æ–‡ä»¶å¤´ &lt;code>78h&lt;/code> åç§»çš„åœ°æ–¹ã€‚å¦‚æœè¿˜è®°å¾— 16 ä¸ªå…ƒç´ çš„ Data Directories ç»“æ„çš„è¯ï¼Œæé†’ä¸‹ ExportDirectory å°±æ˜¯æ‰€æœ‰ Data Directories é‡Œæ’ç¬¬ä¸€ä¸ªçš„ç»“æ„ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm"> &lt;span class="nf">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">78&lt;/span>&lt;span class="no">h&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; eax = ExportDirectory.VirtualAddress
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¾—åˆ°çš„æ˜¯ RVA ï¼ŒåŠ ä¸ŠåŸºå€ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm"> &lt;span class="nf">add&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">ebx&lt;/span> &lt;span class="c">; eax = &amp;amp;ExportDirectoryTable
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¥ä¸‹æ¥è¦å¼€å§‹è§£æ ExportDirectoryTable ç»“æ„äº†ï¼Œå‚è€ƒ&lt;a class="link" href="https://docs.microsoft.com/en-us/windows/win32/debug/pe-format#export-directory-table" target="_blank" rel="noopener"
>å¾®è½¯çš„æ–‡æ¡£&lt;/a>ã€‚&lt;/p>
&lt;p>å› ä¸ºéœ€è¦æš‚å­˜å¾ˆå¤šå˜é‡ï¼Œæˆ‘ä»¬å…ˆç»™è¿™äº›å˜é‡åœ¨æ ˆä¸Šåˆ†é…ç©ºé—´ã€‚&lt;/p>
&lt;h3 id="22-åˆ†é…æ ˆå˜é‡">2.2 åˆ†é…æ ˆå˜é‡&lt;/h3>
&lt;p>å…ˆå›åˆ°å¼€å¤´ï¼Œå®šä¹‰å¥½æ ˆå¦‚ä½•åˆ†é…ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="err">%&lt;/span>&lt;span class="nf">define&lt;/span> &lt;span class="no">kernel32_base&lt;/span> &lt;span class="mi">0x04&lt;/span>
&lt;span class="err">%&lt;/span>&lt;span class="nf">define&lt;/span> &lt;span class="no">numberof_export_entries&lt;/span> &lt;span class="mi">0x08&lt;/span>
&lt;span class="err">%&lt;/span>&lt;span class="nf">define&lt;/span> &lt;span class="no">address_of_ordinal_table&lt;/span> &lt;span class="mi">0x0c&lt;/span>
&lt;span class="err">%&lt;/span>&lt;span class="nf">define&lt;/span> &lt;span class="no">address_of_func_address_table&lt;/span> &lt;span class="mi">0x10&lt;/span>
&lt;span class="err">%&lt;/span>&lt;span class="nf">define&lt;/span> &lt;span class="no">address_of_export_directory_table&lt;/span> &lt;span class="mi">0x14&lt;/span>
&lt;span class="err">%&lt;/span>&lt;span class="nf">define&lt;/span> &lt;span class="no">address_of_name_table&lt;/span> &lt;span class="mi">0x18&lt;/span>
&lt;span class="err">%&lt;/span>&lt;span class="nf">define&lt;/span> &lt;span class="no">ordinal_base&lt;/span> &lt;span class="mi">0x1c&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶ååœ¨å…¥å£ç‚¹å¤„ï¼Œæ·»åŠ  &lt;code>sub esp, 0x1c&lt;/code>ï¼Œåˆ†é…æ ˆç©ºé—´ã€‚ä¹‹åå°±å¯ä»¥ä½¿ç”¨ &lt;code>[ebp-å˜é‡]&lt;/code> çš„å½¢å¼æ¥ä½¿ç”¨è¿™äº›å˜é‡äº†ã€‚ä¿®æ”¹åçš„ä»£ç å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="err">%&lt;/span>&lt;span class="nf">define&lt;/span> &lt;span class="no">kernel32_base&lt;/span> &lt;span class="mi">0x04&lt;/span>
&lt;span class="err">%&lt;/span>&lt;span class="nf">define&lt;/span> &lt;span class="no">numberof_export_entries&lt;/span> &lt;span class="mi">0x08&lt;/span>
&lt;span class="err">%&lt;/span>&lt;span class="nf">define&lt;/span> &lt;span class="no">address_of_ordinal_table&lt;/span> &lt;span class="mi">0x0c&lt;/span>
&lt;span class="err">%&lt;/span>&lt;span class="nf">define&lt;/span> &lt;span class="no">address_of_func_address_table&lt;/span> &lt;span class="mi">0x10&lt;/span>
&lt;span class="err">%&lt;/span>&lt;span class="nf">define&lt;/span> &lt;span class="no">address_of_export_directory_table&lt;/span> &lt;span class="mi">0x14&lt;/span>
&lt;span class="err">%&lt;/span>&lt;span class="nf">define&lt;/span> &lt;span class="no">address_of_name_table&lt;/span> &lt;span class="mi">0x18&lt;/span>
&lt;span class="err">%&lt;/span>&lt;span class="nf">define&lt;/span> &lt;span class="no">ordinal_base&lt;/span> &lt;span class="mi">0x1c&lt;/span>
&lt;span class="nf">section&lt;/span> &lt;span class="no">.text&lt;/span>
&lt;span class="nf">global&lt;/span> &lt;span class="no">_main&lt;/span>
&lt;span class="nl">_main:&lt;/span>
&lt;span class="nf">push&lt;/span> &lt;span class="no">ebp&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">ebp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">esp&lt;/span>
&lt;span class="nf">sub&lt;/span> &lt;span class="no">esp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="no">ch&lt;/span>
&lt;span class="c">; è·å– kernel32.dll åŸºå€
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="nf">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">fs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">30&lt;/span>&lt;span class="no">h&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; eax = TEB-&amp;gt;PEB
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="no">ch&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; eax = PEB-&amp;gt;Ldr
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">14&lt;/span>&lt;span class="no">h&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; eax = PEB_LDR_DATA-&amp;gt;InMemoryOrderModuleList.Flink (å½“å‰ç¨‹åº)
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; eax = &amp;amp;_LDR_DATA_TABLE_ENTRY.InMemoryOrderModuleList.Flink (ç°åœ¨æ˜¯ ntdll.dll)
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; eax = &amp;amp;_LDR_DATA_TABLE_ENTRY.InMemoryOrderModuleList.Flink (ç°åœ¨æ˜¯ kernel32.dll)
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax-8h&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">18&lt;/span>&lt;span class="no">h&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; eax = &amp;amp;_LDR_DATA_TABLE_ENTRY.DllBase (kernel32.dll åŸºå€)
&lt;/span>&lt;span class="c">&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">ebx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; ebx -&amp;gt; kernel32.dll åŸºå€
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp-kernel32_base&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; kernel32_base -&amp;gt; kernel32.dll åŸºå€
&lt;/span>&lt;span class="c">&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebx&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="no">ch&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nf">add&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">ebx&lt;/span> &lt;span class="c">; eax -&amp;gt; kernel32.dll çš„ pe æ–‡ä»¶å¤´
&lt;/span>&lt;span class="c">&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">78&lt;/span>&lt;span class="no">h&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; eax -&amp;gt; ExportDirectory.VirtualAddress
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">add&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">ebx&lt;/span> &lt;span class="c">; eax -&amp;gt; Export Directory Table
&lt;/span>&lt;span class="c">&lt;/span>
&lt;span class="nf">xor&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">eax&lt;/span>
&lt;span class="nf">add&lt;/span> &lt;span class="no">esp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="no">ch&lt;/span>
&lt;span class="nf">pop&lt;/span> &lt;span class="no">ebp&lt;/span>
&lt;span class="nf">retn&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¥ç€ä» &lt;code>xor eax,eax&lt;/code> ä¹‹å‰ç»§ç»­ã€‚&lt;/p>
&lt;h3 id="23-åˆ†æ-export-directory-table">2.3 åˆ†æ Export Directory Table&lt;/h3>
&lt;p>å…ˆç»™å‡ºå®šä¹‰ã€‚&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:left">Offset&lt;/th>
&lt;th style="text-align:left">Size&lt;/th>
&lt;th style="text-align:left">Field&lt;/th>
&lt;th style="text-align:left">Description&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:left">0&lt;/td>
&lt;td style="text-align:left">4&lt;/td>
&lt;td style="text-align:left">Export Flags&lt;/td>
&lt;td style="text-align:left">Reserved, must be 0.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">4&lt;/td>
&lt;td style="text-align:left">4&lt;/td>
&lt;td style="text-align:left">Time/Date Stamp&lt;/td>
&lt;td style="text-align:left">The time and date that the export data was created.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">8&lt;/td>
&lt;td style="text-align:left">2&lt;/td>
&lt;td style="text-align:left">Major Version&lt;/td>
&lt;td style="text-align:left">The major version number. The major and minor version numbers can be set by the user.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">10&lt;/td>
&lt;td style="text-align:left">2&lt;/td>
&lt;td style="text-align:left">Minor Version&lt;/td>
&lt;td style="text-align:left">The minor version number.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">12&lt;/td>
&lt;td style="text-align:left">4&lt;/td>
&lt;td style="text-align:left">Name RVA&lt;/td>
&lt;td style="text-align:left">The address of the ASCII string that contains the name of the DLL. This address is relative to the image base.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">16&lt;/td>
&lt;td style="text-align:left">4&lt;/td>
&lt;td style="text-align:left">Ordinal Base&lt;/td>
&lt;td style="text-align:left">The starting ordinal number for exports in this image. This field specifies the starting ordinal number for the export address table. It is usually set to 1.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">20&lt;/td>
&lt;td style="text-align:left">4&lt;/td>
&lt;td style="text-align:left">Address Table Entries&lt;/td>
&lt;td style="text-align:left">The number of entries in the export address table.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">24&lt;/td>
&lt;td style="text-align:left">4&lt;/td>
&lt;td style="text-align:left">Number of Name Pointers&lt;/td>
&lt;td style="text-align:left">The number of entries in the name pointer table. This is also the number of entries in the ordinal table.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">28&lt;/td>
&lt;td style="text-align:left">4&lt;/td>
&lt;td style="text-align:left">Export Address Table RVA&lt;/td>
&lt;td style="text-align:left">The address of the export address table, relative to the image base.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">32&lt;/td>
&lt;td style="text-align:left">4&lt;/td>
&lt;td style="text-align:left">Name Pointer RVA&lt;/td>
&lt;td style="text-align:left">The address of the export name pointer table, relative to the image base. The table size is given by the Number of Name Pointers field.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">36&lt;/td>
&lt;td style="text-align:left">4&lt;/td>
&lt;td style="text-align:left">Ordinal Table RVA&lt;/td>
&lt;td style="text-align:left">The address of the ordinal table, relative to the image base.&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>æ³¨æ„ offset æ˜¯ 10 è¿›åˆ¶ï¼Œä¹‹åç¼–å†™çš„ä»£ç é‡Œä¼šç”¨ 16 è¿›åˆ¶ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬æŠŠè¿™ä¸ªç»“æ„é‡Œï¼Œæˆ‘ä»¬å…³æ³¨çš„å­—æ®µä¿å­˜åˆ°æ ˆä¸Šã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm"> &lt;span class="nf">mov&lt;/span> &lt;span class="no">ecx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; æš‚å­˜å¯¼å‡ºè¡¨ç»“æ„åŸºå€ç”¨æ¥è¿ç®—
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp-address_of_export_directory_table&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; ä¿å­˜å¯¼å‡ºè¡¨ç»“æ„åŸºå€åˆ°æ ˆå˜é‡
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="no">ch&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nf">add&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">ebx&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp-address_of_func_address_table&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; ä¿å­˜å¯¼å‡ºå‡½æ•°è¡¨åœ°å€åˆ°æ ˆå˜é‡
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">ecx&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">24&lt;/span>&lt;span class="no">h&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nf">add&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">ebx&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp-address_of_ordinal_table&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; ä¿å­˜ordinalè¡¨åœ°å€åˆ°æ ˆå˜é‡
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">ecx&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">18&lt;/span>&lt;span class="no">h&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp-numberof_export_entries&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; ä¿å­˜å¯¼å‡ºè¡¨(name)æ•°é‡åˆ°æ ˆå˜é‡
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">ecx&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="no">h&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; eax=ç¬¬ä¸€ä¸ªå‡½æ•°åç§°çš„ RVA
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp-address_of_name_table&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; ä¿å­˜å¯¼å‡ºå‡½æ•°çš„åç§°è¡¨åˆ°æ ˆå˜é‡
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">ecx&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="no">h&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp-ordinal_base&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; ä¿å­˜ ordinal base ç”¨äºè®¡ç®—å¯¼å‡ºå‡½æ•°çš„åœ°å€
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åº”è¯¥ä¸éš¾ç†è§£ã€‚&lt;/p>
&lt;p>æ¥ä¸‹æ¥è¦ä»è¿™ä¸ªç»“æ„é‡Œæ‰¾å‡º &lt;code>WinExec&lt;/code> å‡½æ•°çš„åœ°å€ã€‚&lt;/p>
&lt;h3 id="24-å¯¼å‡ºè¡¨å’Œå‡½æ•°åœ°å€">2.4 å¯¼å‡ºè¡¨å’Œå‡½æ•°åœ°å€&lt;/h3>
&lt;p>ä¸€äº›å‰ç½®çŸ¥è¯†ã€‚&lt;/p>
&lt;p>å¯¼å‡ºå‡½æ•°çš„åœ°å€è¡¨æ˜¯ç”¨ Ordinal åšç´¢å¼•çš„ï¼Œæ‰€ä»¥å¿…é¡»å…ˆå–å¾— Ordinal æ‰èƒ½æ­£ç¡®å–å¾—åœ°å€ã€‚&lt;/p>
&lt;blockquote>
&lt;p>The export address table contains the address of exported entry points and exported data and absolutes. An ordinal number is used as an index into the export address table.&lt;/p>
&lt;/blockquote>
&lt;p>æ³¨æ„ä» Ordinal Base å–å‡ºçš„å€¼æ˜¯ &lt;strong>unbiased indexes&lt;/strong>ï¼Œä» Ordinal Table é‡Œå–å‡ºçš„ Ordinal å€¼å¹¶ä¸éœ€è¦å‡å» Ordinal Base ã€‚ä½†æ˜¯ DUMPBIN ä¹‹ç±»çš„å·¥å…·ä¼¼ä¹ä¼šç»™å‡ºåŠ ä¸Šäº† Ordinal Base çš„ Ordinal å€¼ï¼Œä¹Ÿå°±æ˜¯å¾®è½¯æ–‡æ¡£ä¸­è¯´çš„ Biased Ordinal ã€‚&lt;/p>
&lt;p>è¿™ä»½æ–‡æ¡£æ›¾ç»æ˜¯é”™è¯¯çš„ï¼Œ&lt;a class="link" href="https://stackoverflow.com/questions/39996742/how-can-kernel32-dll-export-an-ordinal-of-0-when-its-ordinalbase-field-is-s" target="_blank" rel="noopener"
>è§çˆ†æ ˆçš„è¿™ä¸ªé—®é¢˜&lt;/a>ã€‚è¦æ˜¯çœ‹äº†ä»€ä¹ˆä¸çŸ¥é“ä»å“ªå„¿å¤åˆ¶ç²˜è´´æ¥çš„åšå®¢å¯èƒ½ä¼šæœ‰è¯¯è§£ï¼Œä½†ç°åœ¨çš„æ–‡æ¡£é‡Œæ˜¯æ˜ç¡®è¯´äº†æ˜¯ &lt;strong>unbiased indexes&lt;/strong> ã€‚å–å¾— Ordinal ä¹‹åç›´æ¥å½“ä¸‹æ ‡å»è®¿é—®å°±è¡Œäº†ã€‚&lt;/p>
&lt;blockquote>
&lt;p>The export ordinal table is an array of &lt;strong>16-bit unbiased indexes&lt;/strong> into the export address table. Ordinals are biased by the Ordinal Base field of the export directory table. In other words, the ordinal base must be subtracted from the ordinals to obtain true indexes into the export address table.&lt;/p>
&lt;/blockquote>
&lt;p>æ–‡æ¡£ä¹Ÿæ˜ç¡®æŒ‡å‡ºï¼Œä½ å¯ä»¥æŠŠåç§°è¡¨å’Œordinalè¡¨å½“æˆä¸€ä¸ªè¡¨ï¼Œä¸‹æ ‡æ˜¯å…±é€šçš„ã€‚ä¹Ÿå°±æ˜¯åç§°è¡¨çš„ç¬¬1ä¸ªå…ƒç´ å¯¹åº”ordinalè¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œä»¥æ­¤ç±»æ¨ã€‚&lt;/p>
&lt;blockquote>
&lt;p>The export name pointer table and the export ordinal table form two parallel arrays that are separated to allow natural field alignment. These two tables, in effect, operate as one table, in which the Export Name Pointer column points to a public (exported) name and the Export Ordinal column gives the corresponding ordinal for that public name. A member of the export name pointer table and a member of the export ordinal table are associated by having the same position (index) in their respective arrays.&lt;/p>
&lt;/blockquote>
&lt;p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å¼€å§‹å¤„ç†è¿™å‡ ä¸ªè¡¨äº†ã€‚&lt;/p>
&lt;h3 id="25-éå†åç§°è¡¨">2.5 éå†åç§°è¡¨&lt;/h3>
&lt;p>å­—ç¬¦ä¸²å¸¸é‡è¦è®°å¾—å…ˆå®šä¹‰å¥½ï¼Œä¹‹åç”¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nf">section&lt;/span> &lt;span class="no">.data&lt;/span>
&lt;span class="nl">str_winexec:&lt;/span>
&lt;span class="nf">db&lt;/span> &lt;span class="err">&amp;#39;&lt;/span>&lt;span class="no">WinExec&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="nl">str_calcexe:&lt;/span>
&lt;span class="nf">db&lt;/span> &lt;span class="err">&amp;#39;&lt;/span>&lt;span class="no">calc.exe&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>é¦–å…ˆä»åç§°è¡¨é‡Œæ‰¾å‡º &lt;code>WinExec&lt;/code> è¿™ä¸ªå­—ç¬¦ä¸²ã€‚ä¹‹åä¼šæ‹¿ &lt;code>eax&lt;/code> ä¿å­˜ä¸‹æ ‡ï¼Œ&lt;code>ecx&lt;/code> ç”¨äº &lt;code>repe cmpsb&lt;/code> æŒ‡ä»¤ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªå­—æ®µæˆ‘ä»¬å…ˆæ¸…ç©ºã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm"> &lt;span class="nf">xor&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">eax&lt;/span>
&lt;span class="nf">xor&lt;/span> &lt;span class="no">ecx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">ecx&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¥ç€å†™ä¸€ä¸ªå¾ªç¯ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nl">.findWinExecLocation:&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">esi&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">str_winexec&lt;/span> &lt;span class="c">; å‡†å¤‡æ¯”è¾ƒï¼Œesi=å¸¸é‡å­—ç¬¦ä¸²
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">edi&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp-address_of_name_table&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; å‡†å¤‡æ¯”è¾ƒï¼Œedi=åç§°è¡¨é¦–å…ƒç´ ï¼Œæ³¨æ„åç§°è¡¨æ˜¯ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ éƒ½æ˜¯ DWORD RVA
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">cld&lt;/span> &lt;span class="c">; æ¸…é™¤ df æ ‡å¿—ä½
&lt;/span>&lt;span class="c">&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">ecx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; æš‚å­˜ä¸‹ eaxï¼Œæ¥ä¸‹æ¥ eax è¦ç®—ä¸‹æ ‡
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">shl&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="no">h&lt;/span> &lt;span class="c">; å·¦ç§» 2 ä½ï¼Œç­‰äº eax *= 4
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">add&lt;/span> &lt;span class="no">edi&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; å•°å—¦è¿™ä¹ˆå¤šå°±æ˜¯ä¸ºäº† edi = edi + eax * 4
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">ecx&lt;/span> &lt;span class="c">; æ¢å¤ eax çš„å€¼
&lt;/span>&lt;span class="c">&lt;/span>
&lt;span class="no">mov&lt;/span> &lt;span class="no">edi&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebx&lt;/span> &lt;span class="err">+&lt;/span> &lt;span class="no">edi&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; edi = *(åŸºå€+åç§°è¡¨RVA[ä¸‹æ ‡])ï¼Œæ³¨æ„æ­¤æ—¶æ‹¿åˆ°çš„è¿˜æ˜¯ä¸€ä¸ª RVA ï¼ŒæŒ‡å‘å¯¼å‡ºå‡½æ•°åå­—ç¬¦ä¸²
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">add&lt;/span> &lt;span class="no">edi&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">ebx&lt;/span> &lt;span class="c">; å°† RVA åŠ ä¸ŠåŸºå€ï¼Œå¾—åˆ°å®Œæ•´çš„åœ°å€
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">cx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">8&lt;/span> &lt;span class="c">; repe cmpsb ä½¿ç”¨ cx å¯„å­˜å™¨æ¥è®¡æ•°ï¼ŒWinExec é•¿åº¦æ˜¯ 7ï¼ŒåŠ ä¸Š NUL å°±æ˜¯ 8 ä¸ªå­—ç¬¦
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">repe&lt;/span> &lt;span class="no">cmpsb&lt;/span> &lt;span class="c">; å­—ç¬¦ä¸²æ¯”è¾ƒ
&lt;/span>&lt;span class="c">&lt;/span>
&lt;span class="no">jz&lt;/span> &lt;span class="no">.found&lt;/span> &lt;span class="c">; å¦‚æœ repe cmpsb å¾—åˆ°çš„ç»“æœæ˜¯ç›¸åŒï¼Œé‚£ä¹ˆå½“å‰ä¸‹æ ‡ eax å°±æ˜¯ WinExec äº†ï¼Œè·³è½¬å‡ºå¾ªç¯
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">inc&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; å¦åˆ™ä¸‹æ ‡è‡ªå¢
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">cmp&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp-numberof_export_entries&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; å¦‚æœå½“å‰ä¸‹æ ‡è¿˜ä¸ç­‰äºå¯¼å‡ºæ€»æ•°
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">jne&lt;/span> &lt;span class="no">.findWinExecLocation&lt;/span> &lt;span class="c">; ç»§ç»­å¾ªç¯
&lt;/span>&lt;span class="c">&lt;/span>
&lt;span class="no">.found&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ€å¤æ‚çš„éƒ¨åˆ†å°±æ˜¯ç®—åç§»ï¼Œåœ¨ C ä¸­ä¸€ä¸ªä¸‹æ ‡è¿ç®—åˆæˆ–è€…æŒ‡é’ˆè§£å¼•ç”¨çš„äº‹æƒ…åœ¨æ±‡ç¼–é‡Œå°±å¾ˆè›‹ç–¼ã€‚&lt;/p>
&lt;h3 id="26-å–-ordinal-å’Œå‡½æ•°åœ°å€">2.6 å– Ordinal å’Œå‡½æ•°åœ°å€&lt;/h3>
&lt;p>å¾—åˆ°æ­£ç¡®ä¸‹æ ‡åå°±å¯ä»¥å– Ordinal äº†ã€‚å…ˆæŠŠ ordinal è¡¨çš„åœ°å€å’Œ å‡½æ•°åœ°å€è¡¨çš„åœ°å€æ”¾è¿›å¯„å­˜å™¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm"> &lt;span class="nf">mov&lt;/span> &lt;span class="no">ecx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp-address_of_ordinal_table&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">edx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp-address_of_func_address_table&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶åç”¨ eax åšä¸‹æ ‡ï¼Œå– ordinal å€¼ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm"> &lt;span class="nf">mov&lt;/span> &lt;span class="no">ax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ecx&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="no">eax&lt;/span>&lt;span class="p">*&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; ax(ordinal) = ((WORD*)ordinal_table)[eax]
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å†æ‹¿ Ordinal å€¼åšä¸‹æ ‡ï¼Œå–å‡½æ•°åœ°å€ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm"> &lt;span class="nf">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,[&lt;/span>&lt;span class="no">edx&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="no">eax&lt;/span>&lt;span class="p">*&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; eax = ((DWORD*)address_table)[eax]
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ€åæŠŠå‡½æ•°åœ°å€ï¼ˆRVAï¼‰åŠ ä¸ŠåŸºå€ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm"> &lt;span class="nf">add&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">ebx&lt;/span> &lt;span class="c">; eax=WinExec å‡½æ•°çš„åœ°å€
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¾—åˆ° &lt;code>WinExec&lt;/code> å‡½æ•°åœ¨å†…å­˜ä¸­çš„åœ°å€ã€‚&lt;/p>
&lt;h3 id="27-è°ƒç”¨-winexec-å‡½æ•°">2.7 è°ƒç”¨ WinExec å‡½æ•°&lt;/h3>
&lt;p>Windows API éƒ½æ˜¯ &lt;em>stdcall&lt;/em> è°ƒç”¨çº¦å®šï¼Œæˆ‘ä»¬ä¸ç”¨ç®¡æ¸…æ ˆï¼Œç›´æ¥å‹å‚æ•°å°±å¥½ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm"> &lt;span class="nf">push&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="c">; SW_SHOWDEFAULT
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">push&lt;/span> &lt;span class="no">str_calcexe&lt;/span> &lt;span class="c">; å­—ç¬¦ä¸² calc.exe
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">call&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; __stdcall WinExec
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ°è¿™é‡Œï¼Œåº”è¯¥å°±æˆåŠŸè°ƒç”¨äº† &lt;code>WinExec&lt;/code> å‡½æ•°äº†ã€‚&lt;/p>
&lt;h3 id="28-æ¸…ç†å’Œé€€å‡º">2.8 æ¸…ç†å’Œé€€å‡º&lt;/h3>
&lt;p>å†™å®Œäº†ä¸»è¦åŠŸèƒ½ï¼Œæ¥ä¸‹æ¥å°±è¦ç»™è‡ªå·±æ“¦å±è‚¡äº†ï¼Œå¹³æ ˆã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm"> &lt;span class="nf">add&lt;/span> &lt;span class="no">esp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="no">ch&lt;/span>
&lt;span class="nf">pop&lt;/span> &lt;span class="no">ebp&lt;/span>
&lt;span class="nf">xor&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">eax&lt;/span>
&lt;span class="nf">retn&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ”¶å·¥ï¼&lt;/p>
&lt;h3 id="29-å®Œæ•´ä»£ç ">2.9 å®Œæ•´ä»£ç &lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="err">%&lt;/span>&lt;span class="nf">define&lt;/span> &lt;span class="no">kernel32_base&lt;/span> &lt;span class="mi">0x04&lt;/span>
&lt;span class="err">%&lt;/span>&lt;span class="nf">define&lt;/span> &lt;span class="no">numberof_export_entries&lt;/span> &lt;span class="mi">0x08&lt;/span>
&lt;span class="err">%&lt;/span>&lt;span class="nf">define&lt;/span> &lt;span class="no">address_of_ordinal_table&lt;/span> &lt;span class="mi">0x0c&lt;/span>
&lt;span class="err">%&lt;/span>&lt;span class="nf">define&lt;/span> &lt;span class="no">address_of_func_address_table&lt;/span> &lt;span class="mi">0x10&lt;/span>
&lt;span class="err">%&lt;/span>&lt;span class="nf">define&lt;/span> &lt;span class="no">address_of_export_directory_table&lt;/span> &lt;span class="mi">0x14&lt;/span>
&lt;span class="err">%&lt;/span>&lt;span class="nf">define&lt;/span> &lt;span class="no">address_of_name_table&lt;/span> &lt;span class="mi">0x18&lt;/span>
&lt;span class="err">%&lt;/span>&lt;span class="nf">define&lt;/span> &lt;span class="no">ordinal_base&lt;/span> &lt;span class="mi">0x1c&lt;/span>
&lt;span class="nf">section&lt;/span> &lt;span class="no">.text&lt;/span>
&lt;span class="nf">global&lt;/span> &lt;span class="no">_main&lt;/span>
&lt;span class="nl">_main:&lt;/span>
&lt;span class="nf">push&lt;/span> &lt;span class="no">ebp&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">ebp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">esp&lt;/span>
&lt;span class="nf">sub&lt;/span> &lt;span class="no">esp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="no">ch&lt;/span>
&lt;span class="c">; è·å– kernel32.dll åŸºå€
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="nf">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">fs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">30&lt;/span>&lt;span class="no">h&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; eax = TEB-&amp;gt;PEB
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="no">ch&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; eax = PEB-&amp;gt;Ldr
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">14&lt;/span>&lt;span class="no">h&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; eax = PEB_LDR_DATA-&amp;gt;InMemoryOrderModuleList.Flink (å½“å‰ç¨‹åº)
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; eax = &amp;amp;_LDR_DATA_TABLE_ENTRY.InMemoryOrderModuleList.Flink (ç°åœ¨æ˜¯ ntdll.dll)
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; eax = &amp;amp;_LDR_DATA_TABLE_ENTRY.InMemoryOrderModuleList.Flink (ç°åœ¨æ˜¯ kernel32.dll)
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax-8h&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">18&lt;/span>&lt;span class="no">h&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; eax = &amp;amp;_LDR_DATA_TABLE_ENTRY.DllBase (kernel32.dll åŸºå€)
&lt;/span>&lt;span class="c">&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">ebx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; ebx -&amp;gt; kernel32.dll åŸºå€
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp-kernel32_base&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; kernel32_base -&amp;gt; kernel32.dll åŸºå€
&lt;/span>&lt;span class="c">&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebx&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="no">ch&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nf">add&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">ebx&lt;/span> &lt;span class="c">; eax -&amp;gt; kernel32.dll çš„ pe æ–‡ä»¶å¤´
&lt;/span>&lt;span class="c">&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">78&lt;/span>&lt;span class="no">h&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; eax -&amp;gt; ExportDirectory.VirtualAddress
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">add&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">ebx&lt;/span> &lt;span class="c">; eax -&amp;gt; Export Directory Table
&lt;/span>&lt;span class="c">&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">ecx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; æš‚å­˜å¯¼å‡ºè¡¨ç»“æ„åŸºå€ç”¨æ¥è¿ç®—
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp-address_of_export_directory_table&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; ä¿å­˜å¯¼å‡ºè¡¨ç»“æ„åŸºå€åˆ°æ ˆå˜é‡
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="no">ch&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nf">add&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">ebx&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp-address_of_func_address_table&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; ä¿å­˜å¯¼å‡ºå‡½æ•°è¡¨åœ°å€åˆ°æ ˆå˜é‡
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">ecx&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">24&lt;/span>&lt;span class="no">h&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nf">add&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">ebx&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp-address_of_ordinal_table&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; ä¿å­˜ordinalè¡¨åœ°å€åˆ°æ ˆå˜é‡
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">ecx&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">18&lt;/span>&lt;span class="no">h&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp-numberof_export_entries&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; ä¿å­˜å¯¼å‡ºè¡¨(name)æ•°é‡åˆ°æ ˆå˜é‡
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">ecx&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="no">h&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; eax=ç¬¬ä¸€ä¸ªå‡½æ•°åç§°çš„ RVA
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp-address_of_name_table&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; ä¿å­˜å¯¼å‡ºå‡½æ•°çš„åç§°è¡¨åˆ°æ ˆå˜é‡
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">ecx&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="no">h&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp-ordinal_base&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; ä¿å­˜ ordinal base ç”¨äºè®¡ç®—å¯¼å‡ºå‡½æ•°çš„åœ°å€
&lt;/span>&lt;span class="c">&lt;/span>
&lt;span class="nf">xor&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="no">eax&lt;/span>
&lt;span class="nf">xor&lt;/span> &lt;span class="no">ecx&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="no">ecx&lt;/span>
&lt;span class="nl">.findWinExecLocation:&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">esi&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">str_winexec&lt;/span> &lt;span class="c">; å‡†å¤‡æ¯”è¾ƒï¼Œesi=å¸¸é‡å­—ç¬¦ä¸²
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">edi&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp-address_of_name_table&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; å‡†å¤‡æ¯”è¾ƒï¼Œedi=åç§°è¡¨é¦–å…ƒç´ 
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">cld&lt;/span> &lt;span class="c">; æ¸…é™¤ df æ ‡å¿—ä½
&lt;/span>&lt;span class="c">&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">ecx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; æš‚å­˜ä¸‹ eaxï¼Œæ¥ä¸‹æ¥ eax è¦ç®—ä¸‹æ ‡
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">shl&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="no">h&lt;/span> &lt;span class="c">; å·¦ç§» 2 ä½ï¼Œç­‰äº eax *= 4
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">add&lt;/span> &lt;span class="no">edi&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; å•°å—¦è¿™ä¹ˆå¤šå°±æ˜¯ä¸ºäº† edi = edi + eax * 4
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">ecx&lt;/span> &lt;span class="c">; æ¢å¤ eax çš„å€¼
&lt;/span>&lt;span class="c">&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">edi&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebx&lt;/span> &lt;span class="err">+&lt;/span> &lt;span class="no">edi&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; edi = *(åŸºå€+åç§°è¡¨RVA[ä¸‹æ ‡])ï¼Œæ³¨æ„æ­¤æ—¶æ‹¿åˆ°çš„è¿˜æ˜¯ä¸€ä¸ª RVA ï¼ŒæŒ‡å‘å¯¼å‡ºå‡½æ•°åå­—ç¬¦ä¸²
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">add&lt;/span> &lt;span class="no">edi&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">ebx&lt;/span> &lt;span class="c">; å°† RVA åŠ ä¸ŠåŸºå€ï¼Œå¾—åˆ°å®Œæ•´çš„åœ°å€
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">cx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">8&lt;/span> &lt;span class="c">; repe cmpsb ä½¿ç”¨ cx å¯„å­˜å™¨æ¥è®¡æ•°ï¼ŒWinExec é•¿åº¦æ˜¯ 7ï¼ŒåŠ ä¸Š NUL å°±æ˜¯ 8 ä¸ªå­—ç¬¦
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">repe&lt;/span> &lt;span class="no">cmpsb&lt;/span> &lt;span class="c">; å­—ç¬¦ä¸²æ¯”è¾ƒ
&lt;/span>&lt;span class="c">&lt;/span>
&lt;span class="nf">jz&lt;/span> &lt;span class="no">.found&lt;/span> &lt;span class="c">; å¦‚æœ repe cmpsb å¾—åˆ°çš„ç»“æœæ˜¯ç›¸åŒï¼Œé‚£ä¹ˆå½“å‰ä¸‹æ ‡ eax å°±æ˜¯ WinExec äº†ï¼Œè·³è½¬å‡ºå¾ªç¯
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">inc&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; å¦åˆ™ä¸‹æ ‡è‡ªå¢
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">cmp&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp-numberof_export_entries&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; å¦‚æœå½“å‰ä¸‹æ ‡è¿˜ä¸ç­‰äºå¯¼å‡ºæ€»æ•°
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">jne&lt;/span> &lt;span class="no">.findWinExecLocation&lt;/span> &lt;span class="c">; ç»§ç»­å¾ªç¯
&lt;/span>&lt;span class="c">&lt;/span>
&lt;span class="nl">.found:&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">ecx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp-address_of_ordinal_table&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">edx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp-address_of_func_address_table&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">ax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ecx&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="no">eax&lt;/span>&lt;span class="p">*&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; ax(ordinal) = ((WORD*)ordinal_table)[eax]
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,[&lt;/span>&lt;span class="no">edx&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="no">eax&lt;/span>&lt;span class="p">*&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; eax = ((DWORD*)address_table)[eax]
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">add&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">ebx&lt;/span> &lt;span class="c">; eax=WinExec å‡½æ•°çš„åœ°å€
&lt;/span>&lt;span class="c">&lt;/span>
&lt;span class="nf">push&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="c">; SW_SHOWDEFAULT
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">push&lt;/span> &lt;span class="no">str_calcexe&lt;/span> &lt;span class="c">; å­—ç¬¦ä¸² calc.exe
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">call&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; __stdcall WinExec
&lt;/span>&lt;span class="c">&lt;/span>
&lt;span class="nf">add&lt;/span> &lt;span class="no">esp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="no">ch&lt;/span>
&lt;span class="nf">pop&lt;/span> &lt;span class="no">ebp&lt;/span>
&lt;span class="nf">xor&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">eax&lt;/span>
&lt;span class="nf">retn&lt;/span>
&lt;span class="nf">section&lt;/span> &lt;span class="no">.data&lt;/span>
&lt;span class="nl">str_winexec:&lt;/span>
&lt;span class="nf">db&lt;/span> &lt;span class="err">&amp;#39;&lt;/span>&lt;span class="no">WinExec&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="nl">str_calcexe:&lt;/span>
&lt;span class="nf">db&lt;/span> &lt;span class="err">&amp;#39;&lt;/span>&lt;span class="no">calc.exe&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="0x03-éªŒè¯">0x03 éªŒè¯&lt;/h2>
&lt;p>éªŒè¯æ–¹æ³•å¾ˆç®€å•ï¼Œæˆ‘ä»¬ç¼–è¯‘ä¹‹ï¼Œè¿è¡Œï¼Œç„¶åå°±å¥½å•¦ï¼&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/%e5%85%b3%e4%ba%8e%e5%9c%a8%e5%86%85%e5%ad%98%e9%87%8c%e6%89%bekernel32%e8%bf%99%e4%bb%b6%e4%ba%8b/image-20211014161140486.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/%e5%85%b3%e4%ba%8e%e5%9c%a8%e5%86%85%e5%ad%98%e9%87%8c%e6%89%bekernel32%e8%bf%99%e4%bb%b6%e4%ba%8b/image-20211014161140486.png"
loading="lazy"
alt="image-20211014161140486">
&lt;/a>
&lt;figcaption>image-20211014161140486&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>&lt;code>WinExec&lt;/code> çš„è¿”å›å€¼åœ¨ eax é‡Œï¼Œå¾®è½¯çš„æ–‡æ¡£è¯´è¿”å›å€¼å¤§äº 31 å°±æ˜¯ OJBKï¼Œ0x21 æ˜¯10è¿›åˆ¶çš„33ï¼Œæ‰€ä»¥å®Œå…¨ OJBK ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>è¿™æ˜¯å†™ shellcode çš„æŠ€æœ¯å§ï¼Œä¸œä¸€æ¦”å¤´è¥¿ä¸€æ£’å­å°±æ˜¯æˆ‘äº†ã€‚è¯è¯´ shellcode çš„å…·ä½“å®šä¹‰æ˜¯å•¥æ¥ç€ï¼Ÿæˆ‘åªå‰©èœäº†.jpg&lt;/p>
&lt;p>æœ€ç»ˆä½“ä¼šå°±æ˜¯å†™è¿‡æ±‡ç¼–æ‰çŸ¥é“ C çœŸçš„æ˜¯å¾ˆé«˜çº§çš„è¯­è¨€äº†ï¼ˆ&lt;/p>
&lt;p>çœŸè¦ç®—åœ°å€ç®—åç§»ä¸€ç®—ä¸€æ•´å¤©ï¼Œ365å¤©å¯¹ç€16è¿›åˆ¶æ•°åšåŠ å‡ä¹˜é™¤é‚£çœŸå°±æ˜¯æŠ˜ç£¨ã€‚&lt;/p>
&lt;p>Windows æœªå…¬å¼€çš„æ•°æ®ç»“æ„ä¹Ÿä¸çŸ¥é“ç½‘ä¸Šçš„å¤§ä½¬éƒ½æ˜¯æ€ä¹ˆç ”ç©¶å‡ºæ¥çš„ï¼Œæ¯•ç«Ÿç†è®ºä¸Šæ¥è¯´æè¿™ä¸ªæ²¡æœ‰ä»»ä½•ä»·å€¼ï¼Œåœ¨é€†å‘ç ”ç©¶å‡ºç»“æœä¹‹å‰è°ä¹Ÿä¸çŸ¥é“è¿™äº›ä¸œè¥¿èƒ½å¸¦æ¥ä»€ä¹ˆä»·å€¼ï¼Œç”šè‡³ä½ æå®Œäº†ä¹Ÿä¸çŸ¥é“æœ‰ä»€ä¹ˆä»·å€¼ï¼Œç›´åˆ°æœ‰ä¸€å¤©è¢«æ­£å¥½æœ‰éœ€è¦çš„äººå‘ç°ï¼ˆå¤§é»‘é˜”ï¼šç°æˆçš„æ´ï¼Œå¥½è€¶ï¼‰ã€‚&lt;/p>
&lt;p>å—¯ï¼Œè¿™ä¸ªæƒ³æ³•å°±è®©äººæ¯”è¾ƒå…´å¥‹ï¼Œé¡¿æ—¶æ„Ÿè§‰è‡ªå·±é—²å‡ºå±æ‘¸é±¼ä¹Ÿæ˜¯åœ¨ä¸ºç¤¾ä¼šåˆ›é€ ä»·å€¼äº†å‘¢~&lt;/p>
&lt;p>å¦å¤–å…³äºå¦‚ä½•ç”¨ C å†™ shellcodeï¼Œå…¶å®æˆ‘æƒ³äº†ä¸‹ï¼Œä¹Ÿè®¸å¯ä»¥è®©ç¼–è¯‘å™¨æŠŠæ±‡ç¼–åå‡ºæ¥ï¼Œç„¶åä»é‡Œé¢æ‹¿å’±éœ€è¦çš„ä»£ç ï¼Ÿä¸è¿‡è¿™ä¹Ÿä¸çŸ¥é“æ€ä¹ˆç¼–è¯‘å™¨åå‡ºèƒ½è®© nasm æ¥å—çš„æ±‡ç¼–ã€‚æˆ–è€…æœ‰å•¥æ¯”è¾ƒä¸šç•Œé€šè¡Œçš„è¯­æ³•æ ‡å‡†ï¼ŸåªçŸ¥é“æœ‰ AT&amp;amp;T å’Œ Intel ä¸¤ç§é£æ ¼ï¼Œä½†éè¦è¯´çš„è¯ nasm å’Œ masm éƒ½æœ‰äº›ä¸å…¼å®¹ï¼Œå°½ç®¡éƒ½æ˜¯ Intel é£æ ¼ï¼ˆå¤§æ¦‚ï¼‰ã€‚æˆ–è€…å°±æ˜¯è®©ç¼–è¯‘å™¨åä¸ª obj æ–‡ä»¶å‡ºæ¥ï¼Œç„¶åè§£æè¿™ä¸ª obj ï¼Œæå–é‡Œé¢çš„äºŒè¿›åˆ¶ä»£ç å°±å¥½ã€‚&lt;/p>
&lt;p>å¥½äº†çbbå®Œæ¯•ã€‚æ”¶å·¥å•¦ã€‚&lt;/p></description></item><item><title>nasmæ±‡ç¼–æ‰‹å†™ä¸ªPEå¯æ‰§è¡Œæ–‡ä»¶</title><link>https://nnnewb.github.io/blog/p/hand-write-pe-file-with-nasm-assembly/</link><pubDate>Wed, 13 Oct 2021 11:05:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/hand-write-pe-file-with-nasm-assembly/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>ä¸»è¦æ˜¯è™½ç„¶æœ‰ä¸ªæ±‡ç¼–å™¨ nasm ä½†æ˜¯ä¸çŸ¥é“æ€ä¹ˆç”¨ï¼Œå•¥æ±‡ç¼–éƒ½æ˜¯è°ƒè¯•å™¨é‡Œçº¸ä¸Šè°ˆå…µã€‚æœ€è¿‘ç¢°åˆ°ä¸ªé—®é¢˜ï¼ŒMinGW å¯ä»¥ç”¨å‚æ•° &lt;code>-Wl,section-start=&lt;/code> æ¥ä¿®æ”¹ section åœ°å€ï¼Œä½† &lt;em>msvc&lt;/em> æ²¡æœ‰å¯¹åº”ç‰©ï¼Œå°±è›‹ç–¼ã€‚æ‰‹åŠ¨æ”¹ PE æ¥æ·»åŠ  section å¥½åƒå¯è¡Œï¼Œä½†ä¸çŸ¥é“è¯¥æ€ä¹ˆåšï¼Œlief ä¹Ÿä¸ç†Ÿæ‚‰ã€‚&lt;/p>
&lt;p>æ­£å¥½çè°·æ­Œçš„æ—¶å€™å‘ç° nasm å¯ä»¥ç›´æ¥ç¼–è¯‘å‡º PE æ–‡ä»¶ï¼Œè¿™å°±å¬èµ·æ¥å¾ˆæœ‰æ„æ€äº†ã€‚æ±‡ç¼–å˜›ï¼Œå¬ç€å°±å¾ˆåº•å±‚ï¼Œå¾ˆè‡ªç”±ï¼Œæ”¹ä¸ª Section åœ°å€ä¸æ˜¯æ‰‹åˆ°æ“’æ¥ã€‚äºæ˜¯å°±å­¦å­¦çœ‹ã€‚&lt;/p>
&lt;p>å‚è€ƒæ–‡ç« é™„äºæ–‡æœ«ã€‚&lt;/p>
&lt;h2 id="0x01-nasm-åŸºæœ¬ç”¨æ³•">0x01 nasm åŸºæœ¬ç”¨æ³•&lt;/h2>
&lt;h3 id="11-label">1.1 label&lt;/h3>
&lt;p>æ±‡ç¼–å½“ç„¶æœ‰ç»å…¸çš„ &lt;em>label&lt;/em> å’Œ &lt;em>instruction&lt;/em> äº†ï¼Œ&lt;em>instruction&lt;/em> çš„å‚æ•°å°±å« &lt;em>operand&lt;/em> ã€‚&lt;/p>
&lt;p>nasm çš„ label è¯­æ³•å¾ˆç®€å•ï¼Œä»»ä½•ä¸æ˜¯å®å’Œ &lt;em>instruction&lt;/em> æˆ–è€…ä¼ªæŒ‡ä»¤çš„ä¸œè¥¿ï¼Œå‡ºç°åœ¨è¡Œé¦–ï¼Œéƒ½ä¼šè¢«è®¤ä½œ labelã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nl">lbl1:&lt;/span> &lt;span class="c">; è¿™æ˜¯label
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="nf">sub&lt;/span> &lt;span class="no">esp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="no">h&lt;/span>
&lt;span class="nf">jmp&lt;/span> &lt;span class="no">lbl&lt;/span>
&lt;span class="nf">lbl2&lt;/span> &lt;span class="c">; è¿™ä¹Ÿæ˜¯ label
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">sub&lt;/span> &lt;span class="no">esp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="no">h&lt;/span>
&lt;span class="nf">lbl3&lt;/span> &lt;span class="no">db&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="c">; è¿™è¿˜æ˜¯ label
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">.label4&lt;/span> &lt;span class="c">; è¿™æ˜¯æœ¬åœ° labelï¼Œå¯ä»¥ç”¨ .label4 æˆ–è€…å…¨ç§° lbl3.label4 è®¿é—®
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">.@label5&lt;/span> &lt;span class="c">; è¿™æ˜¯ç‰¹æ®Š label ï¼Œåªèƒ½åœ¨å®é‡Œä½¿ç”¨ï¼Œé¿å…å¹²æ‰°æœ¬åœ°label
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>label å¯ä»¥è¢«è§†ä½œä¸€ä¸ªæ•°å­—å‚ä¸è¿ç®—ï¼Œæ¯”å¦‚è¯´ &lt;code>lbl3-lbl2&lt;/code> è¿™æ ·ç®—å‡ºåç§»ã€‚æˆ–è€…è¿˜å¯ä»¥å‚æ•°ä¼ªæŒ‡ä»¤è®¡ç®—ã€‚æ€»ä¹‹ç”¨å¤„å¾ˆå¤šã€‚&lt;/p>
&lt;h3 id="12-ä¼ªæŒ‡ä»¤">1.2 ä¼ªæŒ‡ä»¤&lt;/h3>
&lt;p>ä¼ªæŒ‡ä»¤æ˜¯ä¸€äº›å¹¶ä¸æ˜¯çœŸæ­£çš„ x86 æœºå™¨æŒ‡ä»¤ï¼Œä½†è¿˜æ˜¯è¢«ç”¨åœ¨äº† instruction åŸŸä¸­çš„æŒ‡ ä»¤ï¼Œå› ä¸ºä½¿ç”¨å®ƒä»¬å¯ä»¥å¸¦æ¥å¾ˆå¤§çš„æ–¹ä¾¿ã€‚å½“å‰çš„ä¼ªæŒ‡ä»¤æœ‰&lt;code>DB&lt;/code>,&lt;code>DW&lt;/code>,&lt;code>DD&lt;/code>,&lt;code>DQ&lt;/code>å’Œ &lt;code>DT&lt;/code>ï¼Œå®ƒä»¬å¯¹åº”çš„æœªåˆå§‹åŒ–æŒ‡ä»¤æ˜¯ &lt;code>RESB&lt;/code>, &lt;code>RESW&lt;/code>,&lt;code> RESD&lt;/code>,&lt;code> RESQ&lt;/code> å’Œ &lt;code>REST&lt;/code>ï¼Œ&lt;code>INCBIN&lt;/code> å‘½ä»¤ï¼Œ&lt;code>EQU&lt;/code> å‘½ä»¤å’Œ &lt;code>TIEMS&lt;/code> å‰ç¼€ã€‚&lt;/p>
&lt;p>ä¸å¤åˆ¶ç²˜è´´äº†ï¼Œçœ‹æ–‡æ¡£å¥½å§ã€‚&lt;/p>
&lt;h3 id="12-æœ‰æ•ˆåœ°å€">1.2 æœ‰æ•ˆåœ°å€&lt;/h3>
&lt;p>æœ‰æ•ˆåœ°å€æ˜¯æŒ‡ä»¤çš„æ“ä½œæ•°ï¼Œæ˜¯å¯¹å†…å­˜çš„å¼•ç”¨ã€‚nasmä¸­æœ‰æ•ˆåœ°å€çš„è¯­æ³•éå¸¸ç®€å•ï¼šç”±ä¸€ä¸ªå¯è®¡ç®—è¡¨è¾¾å¼ç»„æˆï¼Œæ”¾åœ¨ä¸­æ‹¬å·å†…ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nl">wordvar:&lt;/span>
&lt;span class="nf">dw&lt;/span> &lt;span class="mi">123&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">ax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">wordvar&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; [wordvar] å°±æ˜¯å– dw 123 çš„é¦–åœ°å€
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">ax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">wordvar&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; wordvar+1 label å‚ä¸ç®—æœ¯è¿ç®—ï¼Œå– dw 123 åœ°å€ + 1å­—èŠ‚
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">ax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">es&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="no">wordvar&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="no">bx&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; åŠ ä¸Šæ®µé€‰æ‹©å­ï¼Œå¯„å­˜å™¨å‚ä¸è¿ç®—
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸ä¸Šä¾‹ä¸ä¸€è‡´çš„è¡¨è¾¾å¼éƒ½ä¸æ˜¯ nasm çš„æœ‰æ•ˆåœ°å€ï¼Œæ¯”å¦‚ &lt;code>es:wordvar[bx]&lt;/code> ã€‚&lt;/p>
&lt;p>è¿˜å¯ä»¥ç”¨ &lt;code>BYTE&lt;/code> &lt;code>WORD&lt;/code> &lt;code>DWORD&lt;/code> &lt;code>NOSPLIT&lt;/code> ç­‰å…³é”®å­—å¼ºè¿« nasm äº§ç”Ÿç‰¹å®šå½¢å¼çš„æœ‰æ•ˆåœ°å€ã€‚æ¯”å¦‚ &lt;code>[dword eax+3]&lt;/code> ã€‚&lt;/p>
&lt;p>è¯¦ç»†è¿˜æ˜¯çœ‹æ–‡æ¡£ã€‚&lt;/p>
&lt;h3 id="13-å¸¸æ•°">1.3 å¸¸æ•°&lt;/h3>
&lt;p>æ”¯æŒçš„å¸¸æ•°ç±»å‹åŒ…æ‹¬ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>æ•°å€¼&lt;/p>
&lt;ul>
&lt;li>&lt;code>100&lt;/code> 10è¿›åˆ¶&lt;/li>
&lt;li>&lt;code>100h&lt;/code> 16è¿›åˆ¶ï¼Œ&lt;code>h&lt;/code>ç»“å°¾&lt;/li>
&lt;li>&lt;code>0x100&lt;/code> 16è¿›åˆ¶ï¼Œ&lt;code>0x&lt;/code>å¼€å¤´&lt;/li>
&lt;li>&lt;code>$0100&lt;/code> 16è¿›åˆ¶ï¼Œ&lt;code>$0&lt;/code>å¼€å¤´&lt;/li>
&lt;li>&lt;code>777q&lt;/code> 8è¿›åˆ¶ï¼Œ&lt;code>q&lt;/code>ç»“å°¾&lt;/li>
&lt;li>&lt;code>10010011b&lt;/code> 2è¿›åˆ¶ï¼Œ&lt;code>b&lt;/code>ç»“å°¾&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>å­—ç¬¦&lt;/p>
&lt;ul>
&lt;li>&lt;code>abcd&lt;/code> å­—ç¬¦å‹å¸¸æ•°ï¼Œå°ç«¯åº&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>å­—ç¬¦ä¸²&lt;/p>
&lt;ul>
&lt;li>ä¸€èˆ¬åªæœ‰ä¼ªæŒ‡ä»¤æ¥å—ï¼Œå½¢å¼å¦‚ &lt;code>db 'abcd'&lt;/code> ã€&lt;code>db 'a','b','c','d'&lt;/code> ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>æµ®ç‚¹æ•°&lt;/p>
&lt;ul>
&lt;li>åæ­£ç”¨ä¸åˆ°æˆ‘ä¹Ÿæ‡’å¾—çœ‹ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="14-è¡¨è¾¾å¼">1.4 è¡¨è¾¾å¼&lt;/h3>
&lt;p>å’ŒCçš„å·®ä¸å¤šï¼Œé™¤äº†+-*/%å’Œä½è¿ç®—ï¼Œå¤šäº†ä¸ª &lt;code>//&lt;/code> è¡¨ç¤ºå¸¦ç¬¦å·é™¤æ³•ï¼Œ&lt;code>%%&lt;/code> è¡¨ç¤ºå¸¦ç¬¦å·å–æ¨¡ã€‚&lt;/p>
&lt;h3 id="15-é¢„å¤„ç†å™¨">1.5 é¢„å¤„ç†å™¨&lt;/h3>
&lt;p>é¢„å¤„ç†å™¨æŒ‡ä»¤ä»¥ &lt;code>%&lt;/code> å¼€å¤´ã€‚ä¸¾å‡ ä¸ªä¾‹å­&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="err">%&lt;/span>&lt;span class="nf">define&lt;/span> &lt;span class="no">FOO&lt;/span> &lt;span class="no">BAR&lt;/span>
&lt;span class="err">%&lt;/span>&lt;span class="nf">define&lt;/span> &lt;span class="no">FN&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="no">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="no">x&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="err">%&lt;/span>&lt;span class="nf">include&lt;/span> &lt;span class="err">&amp;#34;&lt;/span>&lt;span class="no">xxx.asm&lt;/span>&lt;span class="err">&amp;#34;&lt;/span>
&lt;span class="err">%&lt;/span>&lt;span class="nf">undef&lt;/span> &lt;span class="no">FOO&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…¶ä»–æ‡’å¾—å†™äº†ï¼Œå…ˆçŸ¥é“è¿™å‡ ä¸ªå’ŒCç±»ä¼¼çš„å®å°±è¡Œï¼Œæ›´å¤šçœ‹æ–‡æ¡£ã€‚&lt;/p>
&lt;h3 id="16-æ±‡ç¼–å™¨æŒ‡ä»¤">1.6 æ±‡ç¼–å™¨æŒ‡ä»¤&lt;/h3>
&lt;p>æå‡ ä¸ªä¼šç”¨åˆ°çš„ã€‚&lt;/p>
&lt;p>&lt;code>BITS&lt;/code>ï¼ŒæŒ‡å®šç›®æ ‡å¤„ç†å™¨æ¨¡å¼ï¼Œæ¯”å¦‚ &lt;code>BITS 32&lt;/code> å°±æ˜¯32ä½æ¨¡å¼ã€‚ç°åœ¨æ‰¾16ä½çš„ç¯å¢ƒæ€•æ˜¯ä¹Ÿéš¾ã€‚&lt;/p>
&lt;p>&lt;code>SECTION&lt;/code>ï¼Œæ”¹å˜æ­£åœ¨ç¼–å†™çš„ä»£ç è¦æ±‡ç¼–è¿›çš„æ®µã€‚è¦æ˜¯æ‰“ç®—æ±‡ç¼–æˆ &lt;code>obj&lt;/code> è®©é“¾æ¥å™¨å»é“¾æ¥å‡ºæ–°æ–‡ä»¶ä¼šæœ‰ç‚¹ç”¨ã€‚ä½†æ˜¯è¾“å‡ºæ ¼å¼æ˜¯ &lt;code>bin&lt;/code> çš„æ—¶å€™å°±æ²¡æœ‰åµç”¨äº†ã€‚&lt;/p>
&lt;p>&lt;code>EXTERN&lt;/code>ï¼Œå¯¼å…¥å¤–éƒ¨ç¬¦å·ï¼Œè¿˜æ˜¯æ±‡ç¼–æˆ &lt;code>obj&lt;/code> è®©é“¾æ¥å™¨ç”¨çš„æ—¶å€™ä¼šæœ‰ç‚¹ç”¨ï¼Œé“¾æ¥å™¨ä¼šæå®šé“¾æ¥ï¼Œè¾“å‡ºæ ¼å¼æ˜¯ &lt;code>bin&lt;/code> çš„æ—¶å€™å°±æ²¡åµç”¨ã€‚&lt;/p>
&lt;p>&lt;code>GLOBAL&lt;/code>ï¼Œå¯¼å‡ºç¬¦å·ï¼Œå’Œ&lt;code>EXTERN&lt;/code>çš„åº”ç”¨åœºæ™¯å·®ä¸å¤šã€‚ç†Ÿæ‚‰Cçš„ç å†œåº”è¯¥èƒ½ç†è§£ã€‚&lt;/p>
&lt;h3 id="17-è¾“å‡ºæ ¼å¼">1.7 è¾“å‡ºæ ¼å¼&lt;/h3>
&lt;p>å‡ ä¸ªå€¼å¾—å…³æ³¨çš„è¾“å‡ºæ ¼å¼ã€‚&lt;/p>
&lt;p>&lt;code>-f win32&lt;/code> å°±æ˜¯è¾“å‡ºæˆ win32 å¯¹è±¡æ–‡ä»¶ &lt;code>.obj&lt;/code>ï¼Œä¹‹åå¯ä»¥ç”¨ &lt;code>gcc&lt;/code> æˆ–è€… &lt;code>link.exe&lt;/code> ä¹‹ç±»çš„ä¸œè¥¿é“¾æ¥ã€‚&lt;/p>
&lt;p>&lt;code>-f bin&lt;/code> è¾“å‡ºæˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä½ å†™äº†å•¥å°±è¾“å‡ºå•¥ï¼Œnasm å°±æ˜¯ä¸ªç¿»è¯‘å®˜ã€‚&lt;code>.COM&lt;/code>å’Œ&lt;code>.SYS&lt;/code>éƒ½æ˜¯çº¯äºŒè¿›åˆ¶æ ¼å¼çš„ï¼Œä½ è¦æ˜¯å†™è¿™äº›å¯èƒ½æœ‰ç”¨ã€‚è¿˜æœ‰æ“ä½œç³»ç»Ÿå¼•å¯¼ç¨‹åºä¹‹ç±»çš„çº¯äºŒè¿›åˆ¶ç¨‹åºï¼Œä¸éœ€è¦åˆ«çš„ä»€ä¹ˆæ–‡ä»¶æ ¼å¼çš„æƒ…å†µã€‚&lt;/p>
&lt;p>&lt;code>-f elf&lt;/code> ä½ è¦æ˜¯å†™ linux ä¸‹çš„ç¨‹åºå°±æœ‰ç”¨ã€‚&lt;/p>
&lt;h3 id="18-æ€»ç»“">1.8 æ€»ç»“&lt;/h3>
&lt;p>åŸºæœ¬å°±æ˜¯è¿™æ ·ï¼Œæ›´å¤šä¸œè¥¿å°±ç°æŸ¥ç°ç”¨å¥½å§ã€‚å–„ç”¨è°·æ­Œã€‚&lt;/p>
&lt;h2 id="0x02-ç®€å•æ±‡ç¼–ç¨‹åº">0x02 ç®€å•æ±‡ç¼–ç¨‹åº&lt;/h2>
&lt;p>å…ˆå†™ä¸€ä¸ªç®€å•çš„æ±‡ç¼–ç¨‹åºï¼Œä¸ç›´æ¥äº§ç”Ÿå¯æ‰§è¡Œæ–‡ä»¶ï¼Œè€Œæ˜¯éœ€è¦é“¾æ¥å™¨è¿›ä¸€æ­¥é“¾æ¥ã€‚ä¾‹å­éœ€è¦å®‰è£… MinGWã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nf">section&lt;/span> &lt;span class="no">.data&lt;/span>
&lt;span class="nf">global&lt;/span> &lt;span class="no">HelloWorld&lt;/span>
&lt;span class="nl">HelloWorld:&lt;/span>
&lt;span class="nf">db&lt;/span> &lt;span class="err">&amp;#39;&lt;/span>&lt;span class="no">hello&lt;/span> &lt;span class="no">world&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">0&lt;/span> &lt;span class="c">; å®šä¹‰ä¸€ä¸ªå­—ç¬¦ä¸²å¸¸é‡ï¼Œç”¨äºè¾“å‡º
&lt;/span>&lt;span class="c">&lt;/span>
&lt;span class="nf">section&lt;/span> &lt;span class="no">.text&lt;/span>
&lt;span class="nf">global&lt;/span> &lt;span class="no">_main&lt;/span> &lt;span class="c">; _main å°±æ˜¯ C çš„ main, ç”¨äºè®©é“¾æ¥å™¨è¯†åˆ«å‡ºå…¥å£ç‚¹ï¼Œç”Ÿæˆå‘½ä»¤è¡Œç¨‹åº
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">extern&lt;/span> &lt;span class="no">_printf&lt;/span> &lt;span class="c">; _printf å°±æ˜¯ C çš„ printf, ç”¨äºè¾“å‡º hello world
&lt;/span>&lt;span class="c">&lt;/span>
&lt;span class="nl">_main:&lt;/span>
&lt;span class="nf">push&lt;/span> &lt;span class="no">ebp&lt;/span> &lt;span class="c">; å…¶å®æˆ‘ä»¬è‡ªå·±å†™å°±ä¸ç”¨å•°å—¦ push ebp/mov ebp,esp äº†, å¿ƒé‡Œæœ‰åº•å°±è¡Œ
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">ebp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">esp&lt;/span>
&lt;span class="nf">push&lt;/span> &lt;span class="no">HelloWorld&lt;/span> &lt;span class="c">; å‹å…¥å­—ç¬¦ä¸²å¸¸é‡çš„åœ°å€åšå‚æ•°
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">call&lt;/span> &lt;span class="no">_printf&lt;/span> &lt;span class="c">; è°ƒç”¨ printf è¾“å‡º
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">add&lt;/span> &lt;span class="no">esp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span> &lt;span class="c">; æ ¹æ® cdecl çº¦å®šï¼Œå®Œæˆå¹³æ ˆ
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">pop&lt;/span> &lt;span class="no">ebp&lt;/span> &lt;span class="c">; è¦è¿”å›ä¸€ä¸ªå€¼çš„è¯å¯ä»¥å†åŠ ä¸€è¡Œ mov eax, 0 ç­‰åŒäº return 0
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">retn&lt;/span> &lt;span class="c">; å®Œäº‹
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç¼–è¯‘å‘½ä»¤ï¼Œè¦å®‰è£… MinGW æ‰æœ‰ gcc å¯ä»¥ç”¨ã€‚æˆ–è€…å…¶ä»–é“¾æ¥å™¨ä¹Ÿå¯ä»¥ï¼ŒGoLink å¥½åƒå°±è¡Œï¼Œä½†æ˜¯æˆ‘æ²¡ç”¨è¿‡ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">nasm main.asm -f win32 -o main.o
gcc main.o -o main.exe
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç”Ÿæˆçš„ä»£ç æ”¾è¿›è°ƒè¯•å™¨çœ‹çœ‹ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/nasm%e6%89%8b%e5%86%99%e4%b8%aaPE%e5%8f%af%e6%89%a7%e8%a1%8c%e6%96%87%e4%bb%b6/image-20211013092916141.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/nasm%e6%89%8b%e5%86%99%e4%b8%aaPE%e5%8f%af%e6%89%a7%e8%a1%8c%e6%96%87%e4%bb%b6/image-20211013092916141.png"
loading="lazy"
alt="image-20211013092916141">
&lt;/a>
&lt;figcaption>image-20211013092916141&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„æ±‡ç¼–ä»£ç å¿ å®åœ°å‡ºç°åœ¨è°ƒè¯•å™¨é‡Œã€‚&lt;/p>
&lt;p>è¿™å°±æ˜¯ nasm çš„ç®€å•ç”¨æ³•äº†ï¼Œæƒ³è¦æ‹¿æ±‡ç¼–å†™ä¸€ç‚¹ç®€å•çš„éªŒè¯ä»£ç æ˜¯æ²¡é—®é¢˜çš„ï¼Œä¹Ÿå¯ä»¥æ‰‹å†™æ±‡ç¼–å‡½æ•°ï¼Œå†é“¾æ¥åˆ° C/C++ ä»£ç é‡Œã€‚å½“ç„¶ï¼Œå†™ C/C++ çš„å¤§ä½¬å¤§æ¦‚ä¹ŸçŸ¥é“ Visual C++ æ”¯æŒå†…åµŒæ±‡ç¼–ï¼Œ&lt;code>__asm {}&lt;/code> å°±è¡Œï¼Œè¿™ä¹Ÿç®—ä¸€ç§é€‰é¡¹ã€‚&lt;/p>
&lt;h2 id="0x03-ç”ŸæˆäºŒè¿›åˆ¶ä»£ç ">0x03 ç”ŸæˆäºŒè¿›åˆ¶ä»£ç &lt;/h2>
&lt;p>ä½¿ç”¨ &lt;code>nasm -f bin&lt;/code> å¯ä»¥ç›´æ¥ä»æ±‡ç¼–ä»£ç ç”ŸæˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰é“¾æ¥è¿™ä¸€æ­¥ã€‚&lt;/p>
&lt;p>å½“ç„¶ï¼Œæ²¡æœ‰é“¾æ¥è¿™ä¸€æ­¥ï¼ˆæˆ–è€…è¯´é“¾æ¥ç›¸å…³ä¿¡æ¯ä¸ç”± nasm ç®¡ç†ï¼‰ï¼Œ&lt;code>global&lt;/code> å’Œ &lt;code>extern&lt;/code> éƒ½æ²¡æœ‰æ„ä¹‰ï¼Œåœ¨ &lt;code>-f bin&lt;/code> æ—¶æ±‡ç¼–å™¨ä¼šç›´æ¥æç¤ºé”™è¯¯ï¼Œä¸èƒ½ä½¿ç”¨ã€‚ä½†ç›¸å¯¹çš„ï¼Œå› ä¸º nasm æ²¡è‡ªåŠ¨ç”Ÿæˆæ›´å¤šä¿¡æ¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯¹æ±‡ç¼–ç»“æœæœ‰äº†æ›´å¼ºçš„æ§åˆ¶åŠ›ï¼Œä¹Ÿè¦è´Ÿæ‹…æ›´å¤šè´£ä»»ã€‚&lt;/p>
&lt;h3 id="31-ç”Ÿæˆ-dos-æ–‡ä»¶å¤´">3.1 ç”Ÿæˆ DOS æ–‡ä»¶å¤´&lt;/h3>
&lt;p>PE æ–‡ä»¶æ ¼å¼ä¸å†èµ˜è¿°ï¼Œå‚è€ƒå¾®è½¯çš„ &lt;a class="link" href="https://docs.microsoft.com/en-us/windows/win32/debug/pe-format" target="_blank" rel="noopener"
>PE Format&lt;/a> æ–‡æ¡£ï¼Œæˆ–è€…ç»´åŸºç™¾ç§‘çš„ PE æ ¼å¼å›¾å³å¯ã€‚&lt;/p>
&lt;p>å…ˆä»ç”Ÿæˆ PE æ–‡ä»¶çš„æ–‡ä»¶å¤´å¼€å§‹ï¼Œå¡«å……å¯æ‰§è¡Œæ–‡ä»¶çš„å¿…è¦ä¿¡æ¯ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nf">BITS&lt;/span> &lt;span class="mi">32&lt;/span>
&lt;span class="c">; ç”±ç¼–è¯‘å™¨ç”Ÿæˆçš„ DOS æ–‡ä»¶å¤´å…¶å®åŒ…å«äº†ä¸€æ®µè¾“å‡º This program cannot be run in DOS mode çš„ä»£ç 
&lt;/span>&lt;span class="c">; æˆ‘ä»¬ä¸éœ€è¦ï¼Œè¿™é‡Œç›´æ¥å¿½ç•¥ã€‚
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="nl">dos_header:&lt;/span>
&lt;span class="na">.magic&lt;/span> &lt;span class="no">dw&lt;/span> &lt;span class="s">&amp;#34;MZ&amp;#34;&lt;/span> &lt;span class="c">; dw ä¼ªæŒ‡ä»¤ä¼šæ”¾ç½®ä¸€ä¸ªåŒå­—èŠ‚ word, ä¹Ÿå°±æ˜¯æ“ä½œæ•° MZ
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">.cblp&lt;/span> &lt;span class="no">dw&lt;/span> &lt;span class="mi">90&lt;/span>&lt;span class="no">h&lt;/span> &lt;span class="c">; 90h å°±æ˜¯ 0x90
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">.cp&lt;/span> &lt;span class="no">dw&lt;/span> &lt;span class="mi">3&lt;/span>
&lt;span class="na">.crlc&lt;/span> &lt;span class="no">dw&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="na">.cparhdr&lt;/span> &lt;span class="no">dw&lt;/span> &lt;span class="mi">4&lt;/span>
&lt;span class="na">.minalloc&lt;/span> &lt;span class="no">dw&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="na">.maxalloc&lt;/span> &lt;span class="no">dw&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;span class="na">.ss&lt;/span> &lt;span class="no">dw&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="na">.sp&lt;/span> &lt;span class="no">dw&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="no">B8h&lt;/span>
&lt;span class="na">.csum&lt;/span> &lt;span class="no">dw&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="na">.ip&lt;/span> &lt;span class="no">dw&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="na">.cs&lt;/span> &lt;span class="no">dw&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="na">.lfarlc&lt;/span> &lt;span class="no">dw&lt;/span> &lt;span class="mi">40&lt;/span>&lt;span class="no">h&lt;/span>
&lt;span class="na">.ovno&lt;/span> &lt;span class="no">dw&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="na">.res&lt;/span> &lt;span class="no">times&lt;/span> &lt;span class="mi">4&lt;/span> &lt;span class="no">dw&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="c">; ä¼ªæŒ‡ä»¤ times é‡å¤ n æ¬¡ï¼Œæ”¾ç½® 4 ä¸ªåŒå­—èŠ‚ word ï¼Œå€¼ä¸º 0
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">.oemid&lt;/span> &lt;span class="no">dw&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="na">.oeminfo&lt;/span> &lt;span class="no">dw&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="na">.res2&lt;/span> &lt;span class="no">times&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="no">dw&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="na">.lfanew&lt;/span> &lt;span class="no">dd&lt;/span> &lt;span class="no">.next&lt;/span> &lt;span class="c">; ç´§éšå…¶åçš„å°±æ˜¯ NT æ–‡ä»¶å¤´äº†ï¼Œæ‰€ä»¥ lfanew ç›´æ¥æŒ‡å‘è‡ªå·±æœ«å°¾å
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">.next&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…³äºé“¾æ¥å™¨è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶å¤´ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç«  &lt;a class="link" href="http://blog.marcinchwedczuk.pl/a-closer-look-at-portable-executable-msdos-stub" target="_blank" rel="noopener"
>a closer look at portable executable MS-DOS stub&lt;/a> ã€‚&lt;/p>
&lt;p>åæ­£å’±æ— è„‘å¤åˆ¶äº†ã€‚&lt;/p>
&lt;h3 id="32--ç”Ÿæˆ-pe-æ–‡ä»¶å¤´">3.2 ç”Ÿæˆ PE æ–‡ä»¶å¤´&lt;/h3>
&lt;p>ç”Ÿæˆ PE æ–‡ä»¶å¤´ä¹‹å‰æˆ‘ä»¬è¦é¢„å…ˆè€ƒè™‘å‡ ä¸ªè¦ç´ ã€‚&lt;/p>
&lt;ul>
&lt;li>
&lt;p>æ–‡ä»¶å¦‚ä½•å¯¹é½ï¼Ÿ&lt;/p>
&lt;p>å¯¹é½åˆ° 0x400ï¼Œå¤§éƒ¨åˆ†å†…å®¹éƒ½å¯ä»¥åœ¨ä¸€ä¸ª 0x400 é‡Œå¡«å†™å®Œï¼Œè®¡ç®—é‡æ¯”è¾ƒå°‘ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Section å¦‚ä½•å¯¹é½ï¼Ÿ&lt;/p>
&lt;p>å¯¹é½åˆ° 0x1000ï¼ŒåŒæ ·æ˜¯ç®€åŒ–è®¡ç®—ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>éœ€è¦å‡ ä¸ª Sectionï¼Ÿ&lt;/p>
&lt;p>ä¸€ä¸ª &lt;code>.text&lt;/code> å°±è¶³å¤Ÿäº†ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>å…¶ä½™æ–‡ä»¶å¤´å†…å®¹ï¼Œå‡ºäºç®€å•è€ƒè™‘ï¼ŒåŒ…æ‹¬é‡å®šä½å’Œ IAT åœ¨å†…çš„å¤§éƒ¨åˆ†ä¸œè¥¿éƒ½ç•™ç©ºï¼Œä»…ä»…å†™ä¸€ä¸ªä»€ä¹ˆæ•ˆæœéƒ½æ²¡æœ‰çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nl">nt_header:&lt;/span>
&lt;span class="nl">pe_signature:&lt;/span>
&lt;span class="na">.sig&lt;/span> &lt;span class="no">dd&lt;/span> &lt;span class="s">&amp;#34;PE&amp;#34;&lt;/span> &lt;span class="c">; é­”æœ¯æ ‡è¯†, dd ä¼ªæŒ‡ä»¤å¡«å……ä¸€ä¸ª DWORD, ç»“æœæ˜¯ PE\0\0
&lt;/span>&lt;span class="c">&lt;/span>
&lt;span class="nl">file_header:&lt;/span>
&lt;span class="na">.machine&lt;/span> &lt;span class="no">dw&lt;/span> &lt;span class="mi">0x014c&lt;/span> &lt;span class="c">; æ”¯æŒ Intel I386
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">.numberofsections&lt;/span> &lt;span class="no">dw&lt;/span> &lt;span class="mi">0x01&lt;/span> &lt;span class="c">; æœ¬æ–‡ä»¶åŒ…å«ä¸€ä¸ª Section
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">.timedatestamp&lt;/span> &lt;span class="no">dd&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="na">.pointertosymboltable&lt;/span> &lt;span class="no">dd&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="na">.numberofsymbols&lt;/span> &lt;span class="no">dd&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="na">.optheadersize&lt;/span> &lt;span class="no">dw&lt;/span> &lt;span class="no">$OPT_HEADER_SIZE&lt;/span> &lt;span class="c">; opt_header_size ä¼šåœ¨ç¨åçš„ optional_header æœ«å°¾è®¡ç®—å¾—åˆ°
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">.characteristics&lt;/span> &lt;span class="no">dw&lt;/span> &lt;span class="mi">0x102&lt;/span> &lt;span class="c">; å£°æ˜æœ¬æ–‡ä»¶æ˜¯ä¸€ä¸ª32ä½Windowså¯æ‰§è¡Œç¨‹åº
&lt;/span>&lt;span class="c">&lt;/span>
&lt;span class="nl">optional_header:&lt;/span>
&lt;span class="na">.magic&lt;/span> &lt;span class="no">dw&lt;/span> &lt;span class="mi">0x10b&lt;/span>
&lt;span class="na">.linker_version&lt;/span> &lt;span class="no">db&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;span class="na">.sizeof_code&lt;/span> &lt;span class="no">dd&lt;/span> &lt;span class="mi">1000&lt;/span>&lt;span class="no">h&lt;/span> &lt;span class="c">; å…±åŒ…å« 0x1000 å­—èŠ‚çš„ä»£ç æ®µ
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">.sizeof_initialized_data&lt;/span> &lt;span class="no">dd&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="na">.sizeof_uninitialized_data&lt;/span> &lt;span class="no">dd&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="na">.addressof_entrypoint&lt;/span> &lt;span class="no">dd&lt;/span> &lt;span class="mi">1000&lt;/span>&lt;span class="no">h&lt;/span> &lt;span class="c">; å…¥å£ç‚¹ RVA
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">.baseof_code&lt;/span> &lt;span class="no">dd&lt;/span> &lt;span class="mi">1000&lt;/span>&lt;span class="no">h&lt;/span> &lt;span class="c">; ä»£ç æ®µ RVA
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">.baseof_data&lt;/span> &lt;span class="no">dd&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="no">h&lt;/span> &lt;span class="c">; æ•°æ®æ®µ RVA, æ²¡æœ‰æ•°æ®æ®µå°±ç•™ç©ºäº†
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">.image_base&lt;/span> &lt;span class="no">dd&lt;/span> &lt;span class="mi">4000000&lt;/span>&lt;span class="no">h&lt;/span> &lt;span class="c">; é•œåƒåŸºå€ 0x04000000, åé¢æ˜¯ 6 ä¸ª 0
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">.section_alignment&lt;/span> &lt;span class="no">dd&lt;/span> &lt;span class="mi">1000&lt;/span>&lt;span class="no">h&lt;/span> &lt;span class="c">; section å¯¹é½åˆ° 1000h
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">.file_alignment&lt;/span> &lt;span class="no">dd&lt;/span> &lt;span class="mi">400&lt;/span>&lt;span class="no">h&lt;/span> &lt;span class="c">; æ–‡ä»¶å¯¹é½åˆ° 400h
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">.os_version&lt;/span> &lt;span class="no">dw&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;span class="na">.img_version&lt;/span> &lt;span class="no">dw&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;span class="na">.subsystem_version&lt;/span> &lt;span class="no">dw&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;span class="na">.win32_ver_value&lt;/span> &lt;span class="no">dd&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="na">.sizeof_img&lt;/span> &lt;span class="no">dd&lt;/span> &lt;span class="mi">2000&lt;/span>&lt;span class="no">h&lt;/span> &lt;span class="c">; è¯·æ±‚çš„é•œåƒæ€»å¤§å°ï¼Œæ–‡ä»¶å¤´åˆ°ä»£ç æ®µèµ·ç‚¹å…± 1000h, ä»£ç æ®µ 1000h, å…±è®¡ 2000h
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">.sizeof_headers&lt;/span> &lt;span class="no">dd&lt;/span> &lt;span class="mi">400&lt;/span>&lt;span class="no">h&lt;/span> &lt;span class="c">; æ–‡ä»¶å¤´å¤§å°å¯¹é½åˆ°äº† 400h, æˆ‘ä»¬çŸ¥é“æ–‡ä»¶å¤´è‚¯å®šä¸è¶³ 400h, æ‰€ä»¥ sizeof_headers ç›´æ¥å¡« 400h å°±è¡Œ
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">.checksum&lt;/span> &lt;span class="no">dd&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="na">.subsystem&lt;/span> &lt;span class="no">dw&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;span class="na">.dll_characteristics&lt;/span> &lt;span class="no">dw&lt;/span> &lt;span class="mi">0x400&lt;/span> &lt;span class="c">; ä¸æ”¯æŒ SEH, ä¸å¼€å¯ ASLR
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">.sizeof_stack_reserved&lt;/span> &lt;span class="no">dd&lt;/span> &lt;span class="mi">0x100000&lt;/span>
&lt;span class="na">.sizeof_stack_commit&lt;/span> &lt;span class="no">dd&lt;/span> &lt;span class="mi">0x1000&lt;/span>
&lt;span class="na">.sizeof_heap_reserved&lt;/span> &lt;span class="no">dd&lt;/span> &lt;span class="mi">0x100000&lt;/span>
&lt;span class="na">.sizeof_heap_commit&lt;/span> &lt;span class="no">dd&lt;/span> &lt;span class="mi">0x1000&lt;/span>
&lt;span class="na">.loeader_flags&lt;/span> &lt;span class="no">dd&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="na">.numberof_rva_and_sizes&lt;/span> &lt;span class="no">dd&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="no">h&lt;/span> &lt;span class="c">; åç»­æœ‰ 16 ä¸ª Data Directories
&lt;/span>&lt;span class="c">&lt;/span>
&lt;span class="nl">data_directories:&lt;/span>
&lt;span class="nf">times&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="no">h&lt;/span> &lt;span class="no">dd&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="c">; æ‰€æœ‰çš„ data directories å¡«å…… 0
&lt;/span>&lt;span class="c">&lt;/span>
&lt;span class="c">; é€šè¿‡ä¼ªæŒ‡ä»¤ equ ï¼Œç»™ $OPT_HEADER_SIZE èµ‹å€¼ä¸º (å½“å‰åœ°å€ - optional_headeræ ‡ç­¾)
&lt;/span>&lt;span class="c">; ä¹Ÿå°±æ˜¯æ•´ä¸ª optional_header çš„å¤§å°
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="nf">$OPT_HEADER_SIZE&lt;/span> &lt;span class="no">equ&lt;/span> &lt;span class="no">$&lt;/span> &lt;span class="p">-&lt;/span> &lt;span class="no">optional_header&lt;/span>
&lt;span class="nl">section_table:&lt;/span>
&lt;span class="nl">.text:&lt;/span>
&lt;span class="nf">db&lt;/span> &lt;span class="err">&amp;#34;&lt;/span>&lt;span class="no">.text&lt;/span>&lt;span class="err">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="c">; section name
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="c">; æ³¨æ„å¯¹é½åˆ°äº† 8 å­—èŠ‚ï¼Œä¸è¶³éƒ¨åˆ† 0 å¡«å……, ä¸èƒ½è¶…å‡º
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">dd&lt;/span> &lt;span class="mi">1000&lt;/span>&lt;span class="no">h&lt;/span> &lt;span class="c">; virtual size
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="c">; Section ä½¿ç”¨çš„å†…å­˜å¤§å°
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">dd&lt;/span> &lt;span class="mi">1000&lt;/span>&lt;span class="no">h&lt;/span> &lt;span class="c">; virtual address
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="c">; Section çš„èµ·å§‹ç‚¹ RVA
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">dd&lt;/span> &lt;span class="mi">400&lt;/span>&lt;span class="no">h&lt;/span> &lt;span class="c">; sizeof raw data
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="c">; æˆ‘ä»¬çŸ¥é“å¯¹é½åˆ°äº† 400h ä¸”ä»£ç è‚¯å®šæ¯”è¿™å°‘, æ‰€ä»¥ raw data å¿…ç„¶æœ‰ 400h å¤§å°
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">dd&lt;/span> &lt;span class="no">code&lt;/span> &lt;span class="c">; pointer to raw data
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="c">; ç”¨ label å‘Šè¯‰æ±‡ç¼–å™¨ raw data çš„åç§»
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">dd&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="c">; pointer to relocations
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">dd&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="c">; pointer to linenum
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">dw&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="c">; number of relocations
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">dw&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="c">; number of linenum
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="no">dd&lt;/span> &lt;span class="mi">0x60000020&lt;/span> &lt;span class="c">; characteristics
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="c">; å«ä¹‰æ˜¯ï¼šä»£ç æ®µ - å¯è¯»
&lt;/span>&lt;span class="c">&lt;/span>
&lt;span class="nf">align&lt;/span> &lt;span class="mi">400&lt;/span>&lt;span class="no">h&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">db&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="c">; align ä¼ªæŒ‡ä»¤ï¼Œä¸è¶³çš„éƒ¨åˆ†å¡«å……0, å¯¹é½åˆ° 400h
&lt;/span>&lt;span class="c">; ç›¸å¯¹æ–‡ä»¶å¤´åˆ°è¿™é‡Œ, è‚¯å®šæ˜¯ä¸è¶³ 400h çš„, align ä¼ªæŒ‡ä»¤ä¼šå¡«å……åˆ°æ»¡ 400h ä¸ºæ­¢ã€‚
&lt;/span>&lt;span class="c">; è¿™æ ·ä¸€æ¥, æ•´ä¸ªæ–‡ä»¶å¤´å¤§å°, æ­£å¥½å°±æ˜¯ 400h
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="32-ç¼–å†™æ±‡ç¼–ä»£ç ">3.2 ç¼–å†™æ±‡ç¼–ä»£ç &lt;/h3>
&lt;p>æ–‡ä»¶å¤´å®šä¹‰å®Œæˆåï¼Œå°±å¯ä»¥å¼€å§‹å†™æ±‡ç¼–ä»£ç äº†ã€‚æ­£å¸¸è¿™æ—¶å€™è¿˜è¦å¤„ç†å¯¼å…¥è¡¨ï¼Œä½†æˆ‘ä»¬è·³è¿‡äº†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nl">code:&lt;/span>
&lt;span class="nl">.start:&lt;/span>
&lt;span class="nf">xor&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">eax&lt;/span>
&lt;span class="nf">retn&lt;/span>
&lt;span class="nf">align&lt;/span> &lt;span class="mi">400&lt;/span>&lt;span class="no">h&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">db&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="c">; åŒæ ·ï¼Œå†æ¬¡å¯¹é½åˆ° 400h ï¼ŒæŠŠä»£ç æ®µçš„å‰©ä½™éƒ¨åˆ†å¡«å……æˆ 0
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ°è¿™é‡Œï¼Œæ•´ä¸ª PE æ–‡ä»¶çš„å†…å®¹å°±å¡«å†™å®Œæ¯•äº†ã€‚&lt;/p>
&lt;p>æ–‡ä»¶å¤´çš„ç»å¤§å¤šæ•°å­—æ®µå¹¶ä¸æ˜¯æˆ‘ä»¬å…³æ³¨çš„å¯¹è±¡ï¼Œè®¡ç®—åç§»å’Œå¯¹é½æ˜¯æœ€è›‹ç–¼çš„ã€‚&lt;/p>
&lt;h3 id="33-å…³äºå¯¹é½çš„å‘">3.3 å…³äºå¯¹é½çš„å‘&lt;/h3>
&lt;blockquote>
&lt;p>There are additional restrictions on image files if the SectionAlignment value in the optional header is less than the page size of the architecture. For such files, the location of section data in the file must match its location in memory when the image is loaded, so that the physical offset for section data is the same as the RVA.&lt;/p>
&lt;/blockquote>
&lt;p>å¾®è½¯æ–‡æ¡£é‡ŒæŒ‡å‡ºï¼Œåœ¨ Section å¯¹é½çš„å¤§å°å°äºä½“ç³»ç»“æ„æŒ‡å®šçš„é¡µå¤§å°ï¼ˆ4Kï¼‰çš„æ—¶å€™ï¼Œä¼šæœ‰ä¸ªé¢å¤–é™åˆ¶ï¼Œè¦æ±‚ Section æ•°æ®åœ¨æ–‡ä»¶ä¸­çš„åç§» &lt;strong>å¿…é¡»&lt;/strong> å¯¹åº”åœ¨å†…å­˜ä¸­çš„ RVA ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœ Section å¯¹é½ä¸º 1 å­—èŠ‚ï¼Œ&lt;code>VirtualAddress&lt;/code> æŒ‡å®šä¸º 1000hï¼Œé‚£ Section æ•°æ®å¿…é¡»å­˜æ”¾åœ¨æ–‡ä»¶çš„ 1000h åç§»å¤„ï¼Œå¦åˆ™ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶ä¼šå‡ºç°â€œä¸æ˜¯æœ‰æ•ˆçš„Win32åº”ç”¨ç¨‹åºâ€é”™è¯¯ã€‚&lt;/p>
&lt;h3 id="34-å…¶ä»–å‘">3.4 å…¶ä»–å‘&lt;/h3>
&lt;p>å»ºè®®ä¸è¦å‚è€ƒå•ç‹¬çš„æŸå‡ ç¯‡æ–‡ç« ï¼Œå¤šæ‰¾äº›ç›¸å…³çš„æ–‡ç« åšå®¢å’Œæ–‡æ¡£ï¼Œäº’ç›¸å¯¹ç…§ç€çœ‹ã€‚PEæ ¼å¼é”™è¯¯ä¸ä¼šæœ‰å…·ä½“çš„æç¤ºï¼Œæˆ‘ä¹Ÿæ²¡æ‰¾åˆ°ä»€ä¹ˆå¥½ç”¨çš„å·¥å…·å»æ£€æŸ¥åˆ°åº•å“ªå„¿æœ‰é”™ï¼Œåªèƒ½å»ºè®®å¤šç”¨ç”¨ CFF Explorer å’Œ liefã€pefile è¿™äº›èƒ½æ£€æŸ¥æ–‡ä»¶æ ¼å¼çš„åº“äº†ï¼Œè¦æ˜¯è¿™äº›éƒ½ä¸è¡Œé‚£å°±çœ‹çœ‹16è¿›åˆ¶ç¼–è¾‘å™¨ä»€ä¹ˆçš„å§ï¼Œæ¯”å¦‚ HexWorkshopã€‚IDA åœ¨è¿™å„¿æ²¡å•¥ç”¨ã€‚&lt;/p>
&lt;p>å¦å¤–æˆ‘è¿˜å‘ç°1å­—èŠ‚å¯¹é½çš„æ—¶å€™ï¼Œx32dbg è°ƒè¯•ä¼šçœ‹ä¸åˆ°æ±‡ç¼–ä»£ç ï¼Œåœ¨å†…å­˜å¸ƒå±€é‡Œè¿›å…¥è‡ªå·±çš„PEæ–‡ä»¶ååªèƒ½çœ‹åˆ°PEå¤´ï¼Œä½†æ²¡æœ‰åæ±‡ç¼–ã€‚ä¸è¿‡è°ƒè¯•å™¨è¿˜æ˜¯å¯ä»¥æ­£å¸¸å•æ­¥è°ƒè¯•å’ŒæŸ¥çœ‹å¯„å­˜å™¨ã€‚&lt;/p>
&lt;h3 id="35-ç¼–è¯‘">3.5 ç¼–è¯‘&lt;/h3>
&lt;p>ä¸Šé¢çš„æ±‡ç¼–ä»£ç ç”¨ nasm å³å¯ç¼–è¯‘ï¼Œä¸éœ€è¦å…¶ä»–ç¼–è¯‘æˆ–é“¾æ¥å·¥å…·äº†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">nasm pe.asm -f bin -o pe.exe
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/nasm%e6%89%8b%e5%86%99%e4%b8%aaPE%e5%8f%af%e6%89%a7%e8%a1%8c%e6%96%87%e4%bb%b6/image-20211013104216658.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/nasm%e6%89%8b%e5%86%99%e4%b8%aaPE%e5%8f%af%e6%89%a7%e8%a1%8c%e6%96%87%e4%bb%b6/image-20211013104216658.png"
loading="lazy"
alt="image-20211013104216658">
&lt;/a>
&lt;figcaption>image-20211013104216658&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>ä¹Ÿå¯ä»¥æ”¾è¿›è°ƒè¯•å™¨çœ‹çœ‹ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/nasm%e6%89%8b%e5%86%99%e4%b8%aaPE%e5%8f%af%e6%89%a7%e8%a1%8c%e6%96%87%e4%bb%b6/image-20211013104451137.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/nasm%e6%89%8b%e5%86%99%e4%b8%aaPE%e5%8f%af%e6%89%a7%e8%a1%8c%e6%96%87%e4%bb%b6/image-20211013104451137.png"
loading="lazy"
alt="image-20211013104451137">
&lt;/a>
&lt;figcaption>image-20211013104451137&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å¯ä»¥çœ‹åˆ°ï¼Œä»£ç æ®µæ­£ç¡®å‡ºç°åœ¨ 4001000h è¿™ä¸ªåœ°å€ä¸Šï¼ˆåŸºå€+1000hï¼‰ï¼Œå†…å®¹ä¹Ÿç¬¦åˆæˆ‘ä»¬å†™çš„æ±‡ç¼–ä»£ç ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/nasm%e6%89%8b%e5%86%99%e4%b8%aaPE%e5%8f%af%e6%89%a7%e8%a1%8c%e6%96%87%e4%bb%b6/image-20211013104646905.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/nasm%e6%89%8b%e5%86%99%e4%b8%aaPE%e5%8f%af%e6%89%a7%e8%a1%8c%e6%96%87%e4%bb%b6/image-20211013104646905.png"
loading="lazy"
alt="image-20211013104646905">
&lt;/a>
&lt;figcaption>image-20211013104646905&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>åœ¨å†…å­˜å¸ƒå±€çª—å£ä¹Ÿèƒ½çœ‹åˆ°ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>è¿™æ˜¯ä¸ªå¯¹ PE æ–‡ä»¶æ ¼å¼æœ‰æ‰€äº†è§£åçš„ä¸€ä¸ªç®€å•åº”ç”¨ï¼ŒåŸå…ˆæ˜¯åªä¼šæ‹¿å…¶ä»–ç¼–ç¨‹è¯­è¨€å»è¯» PE æ–‡ä»¶å¤´çš„å†…å®¹ï¼Œç°åœ¨å­¦ä¼šäº†ç”¨æ±‡ç¼–å™¨å»å†™ä¸€ä¸ªç®€å•çš„ PE æ–‡ä»¶ã€‚ä¹‹æ‰€ä»¥æ˜¯æ±‡ç¼–å™¨å»å†™ï¼Œè€Œä¸æ˜¯æ‹¿ C/C++/Python å»å†™ï¼Œè¿˜æ˜¯å› ä¸ºæˆ‘èœè€Œä¸”æ‡’ã€‚å¥½äº†è·³è¿‡å…³äºæˆ‘èœçš„è¯é¢˜å§ã€‚&lt;/p>
&lt;p>å‚è€ƒæ–‡æ¡£ï¼ˆä¸åˆ†å…ˆåï¼‰ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;a class="link" href="http://blog.marcinchwedczuk.pl/a-closer-look-at-portable-executable-msdos-stub" target="_blank" rel="noopener"
>http://blog.marcinchwedczuk.pl/a-closer-look-at-portable-executable-msdos-stub&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://docs.microsoft.com/en-us/windows/win32/debug/pe-format" target="_blank" rel="noopener"
>https://docs.microsoft.com/en-us/windows/win32/debug/pe-format&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://reverseengineering.stackexchange.com/questions/11758/how-do-you-calculate-address-start-size-of-pe-section-like-rdata-data" target="_blank" rel="noopener"
>https://reverseengineering.stackexchange.com/questions/11758/how-do-you-calculate-address-start-size-of-pe-section-like-rdata-data&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="http://www.phreedom.org/research/tinype/" target="_blank" rel="noopener"
>http://www.phreedom.org/research/tinype/&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://stackoverflow.com/questions/17456372/create-and-use-sections-for-pe-file-in-assembly-nasm" target="_blank" rel="noopener"
>https://stackoverflow.com/questions/17456372/create-and-use-sections-for-pe-file-in-assembly-nasm&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://bitcodersblog.wordpress.com/2017/05/10/win32-in-nasm-part-1/" target="_blank" rel="noopener"
>https://bitcodersblog.wordpress.com/2017/05/10/win32-in-nasm-part-1/&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>å¤§éƒ¨åˆ†ä»£ç å…¶å®æ˜¯æ¥è‡ª tinypeï¼Œè¢«æˆ‘è°ƒæ¥è°ƒå»æ”¹äº†å¾ˆå¤šã€‚è‡ªå·±åŠ¨æ‰‹æŠ˜è…¾ä¸€éè¿œæ¯”èµ°é©¬è§‚èŠ±çœ‹ä¸€éæ”¶è·æ›´å¤šï¼Œæœ‰äº›å®è·µé—®é¢˜ä¸è·Ÿç€æŠ„ä¸€æ¬¡æ”¹ä¸€æ”¹æ˜¯ä¸ä¼šå‘ç°çš„ã€‚æœ‰è¨€é“â€œå®è·µå‡ºçœŸçŸ¥â€ï¼Œè™½ç„¶è¯´ç°åœ¨æœ‰äº›æ²™é›•æŠŠç”Ÿæ´»ç»éªŒå½“æˆçœŸç†å¯¼è‡´ä¸€å¸®äººæ§ä¹¦æœ¬ä¸€å¸®äººæ§ç»éªŒï¼Œæå¾—å•¥äº‹æƒ…éƒ½éé»‘å³ç™½&amp;hellip;æŠŠä¼Ÿäººçš„è¯å½“æˆäº’ç›¸æ”»è®¦çš„æ­¦å™¨ã€‚&lt;/p>
&lt;p>æ·¦ï¼Œå¥½å¥½çš„å­¦ä¹ ï¼Œç»“æœæ€»ç»“çš„æ—¶å€™è¶Šæƒ³è¶Šæ°”ã€‚&lt;/p>
&lt;p>æœç„¶ï¼Œâ€œäººç±»çš„æ‚²æ¬¢å¹¶ä¸ç›¸é€šï¼Œæˆ‘åªè§‰å¾—ä»–ä»¬åµé—¹ã€‚â€&lt;/p></description></item><item><title>k3sæ›´æ–°å®¢æˆ·ç«¯è¯ä¹¦çš„å·æ‡’æ–¹æ³•</title><link>https://nnnewb.github.io/blog/p/k3s-renew-client-ca-file-the-lazy-way/</link><pubDate>Mon, 11 Oct 2021 13:58:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/k3s-renew-client-ca-file-the-lazy-way/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>ä»Šå¤©ä¸Šå†…ç½‘æœåŠ¡å™¨çœ‹äº†çœ¼ï¼Œå‡†å¤‡è°ƒè¯•ä¸‹æ–°ä»£ç ï¼Œç»“æœå‘ç°æŠ¥é”™ &lt;code>You must logged in to the server (unauthorized)&lt;/code> ã€‚ç¿»äº†åŠå¤©çš„ &lt;em>KUBECONFIG&lt;/em> é…ç½®ï¼Œå‘ç°å•¥ä¹Ÿæ²¡é”™ã€‚æ¢æˆ &lt;code>/etc/rancher/k3s/k3s.yaml&lt;/code> ä¹Ÿä¸è¡Œã€‚äºæ˜¯æŸ¥äº†ä¸‹ &lt;code>journalctl -r -u k3s&lt;/code> ï¼Œå‘ç°æ—¥å¿— &lt;code>x509: certificate has expired or not yet valid: current time ...&lt;/code> ï¼Œè¿™å°±æ˜ç¡®äº†æ˜¯è¯ä¹¦è¿‡æœŸäº†ã€‚&lt;/p>
&lt;p>äºæ˜¯åˆæ‰¾äº†ä¸€åœˆå¦‚ä½•ç»™k3sæ›´æ–°è¯ä¹¦ï¼Œæœ &lt;code>how to renew client-ca-file&lt;/code> æŸ¥å‡ºæ¥çš„æ–¹æ³•ä¸æ˜¯ &lt;code>kubeadm&lt;/code> å°±æ˜¯æ”¹æ—¶é—´ã€æ¢è¯ä¹¦ï¼Œæ€»ä¹‹&amp;hellip;éº»çƒ¦ï¼Œè€Œä¸”æœå‡ºæ¥çš„æ–‡ç« å¯æ“ä½œæ€§éƒ½æœ‰ç‚¹å·®ï¼ŒçœŸè¦å®è·µå‡ºçœŸçŸ¥ä¹Ÿä¸èƒ½æ”¾å…¬å¸çš„æœºå™¨ä¸Šï¼Œæå‡ºç‚¹é—®é¢˜è¿˜å¾—åŠè‡ªå·±å¿ƒå¹³æ°”å’Œç£¨ä¸Šä¸€æ•´å¤©å»è§£å†³ã€‚&lt;/p>
&lt;p>äºæ˜¯ç»ˆäºæ‰¾åˆ°ä¸ªçœ‹èµ·æ¥èƒ½è¡Œçš„åŠæ³•ï¼šé‡å¯ã€‚&lt;/p>
&lt;h2 id="æ“ä½œ">æ“ä½œ&lt;/h2>
&lt;p>è¿™ä¸ªåŠæ³•å¯æ“ä½œæ€§å¾ˆå¼ºâ€”â€”åæ­£æƒ…å†µä¸ä¼šå˜å¾—æ›´å·®äº†ã€‚å› ä¸ºåŠå…¬å®¤çš„æœåŠ¡å™¨å¹¶ä¸èƒ½ä¿è¯24å°æ—¶ä¸æ–­ç”µï¼Œæœ‰æ—¶å€™ç™½å¤©ä¸Šç­æœºå™¨æ˜¯å…³æœºçš„ï¼Œé‡å¯k3sæ— è®ºå¦‚ä½•ä¸ä¼šå¯¼è‡´é—®é¢˜å˜å¾—æ›´å·®â€”â€”å°±ç®—æ”¾ç€ä¸ç®¡ï¼Œè¿‡ä¸¤å¤©è¯´ä¸å®šä¹Ÿä¼šæ–­ç”µé‡å¯ä¸‹ã€‚&lt;/p>
&lt;p>ç¡®è®¤æ²¡äººç”¨æœåŠ¡ä¹‹åç›´æ¥ä¸Šæ‰‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">sudo systemctl restart k3s
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç­‰å¾…é‡å¯å®Œæˆï¼Œæµ‹è¯•ä¸‹æ–°çš„ &lt;code>k3s.yaml&lt;/code> èƒ½ä¸èƒ½æ­£å¸¸ç”¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="nb">export&lt;/span> &lt;span class="nv">KUBECONFIG&lt;/span>&lt;span class="o">=&lt;/span>/etc/rancher/k3s/k3s.yaml
kubectl cluster-info
&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>Kubernetes control plane is running at https://192.168.2.175:6443
CoreDNS is running at https://192.168.2.175:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
Metrics-server is running at https://192.168.2.175:6443/api/v1/namespaces/kube-system/services/https:metrics-server:/proxy
To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
&lt;/code>&lt;/pre>&lt;p>å…¶ä»– &lt;code>get nodes&lt;/code> ä¹‹ç±»çš„å‘½ä»¤ä¹Ÿé¡ºåˆ©å®Œæˆï¼Œå‰©ä¸‹å°±æ˜¯æŠŠæ–°çš„å®¢æˆ·ç«¯è¯ä¹¦åˆå¹¶åˆ°ä¸ªäººçš„é…ç½®é‡Œäº†ï¼ˆå¯¹ï¼Œå¹¶ä¸æ˜¯ç›´æ¥ç”¨ &lt;code>/etc/rancher/k3s/k3s.yaml&lt;/code>ï¼Œæˆ‘çŸ¥é“æœ‰äººä¼šè¿™ä¹ˆç”¨ï¼‰ã€‚åŠæ³•ä¹Ÿç®€å•ï¼Œ&lt;code>vim /etc/rancher/k3s/k3s.yaml&lt;/code>ï¼ŒæŠŠé‡Œé¢çš„ &lt;code>users&lt;/code> é”®ä¸‹ï¼Œ&lt;code>default&lt;/code> ç”¨æˆ·çš„ä¿¡æ¯å¤åˆ¶å‡ºæ¥ï¼Œç²˜è´´åˆ°ä¸ªäººçš„ &lt;code>~/.kube/config&lt;/code> ç›¸åº”ä½ç½®å°±å¥½ã€‚ä»¥å‰å¤åˆ¶è¿‡çš„è¯ï¼Œå°±è¦†ç›–æ‰ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>æ²¡å•¥å¥½æ€»ç»“çš„ï¼Œé‡å¯å¤§æ³•è§£å†³ä¸€åˆ‡é—®é¢˜ã€‚ä¸è¿‡æ‰‹åŠ¨è½®æ¢è¯ä¹¦çš„åŠæ³•ä¹Ÿå¾—è®°å½•ä¸€ä¸‹ï¼Œè¿™é‡Œç•™ç›¸å…³çš„æ‘˜è¦é“¾æ¥ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;a class="link" href="https://kubernetes.io/zh/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/" target="_blank" rel="noopener"
>kubernetes.io/ä½¿ç”¨ kubeadm è¿›è¡Œè¯ä¹¦ç®¡ç†&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://www.ibm.com/docs/en/fci/1.1.0?topic=kubernetes-renewing-cluster-certificates" target="_blank" rel="noopener"
>ibm.com/renewing kubernetes cluster certificates&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://forums.rancher.com/t/how-to-renew-cert-manually/20022" target="_blank" rel="noopener"
>forum.rancher.com/how to renew cert manually?&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>æ¯”è¾ƒå¥½å¥‡çš„æœ‰å¤šä¸ªmasterèŠ‚ç‚¹çš„é›†ç¾¤ï¼Œèƒ½é€šè¿‡é€ä¸ªé‡å¯masterèŠ‚ç‚¹æ¥å®ç°è‡ªåŠ¨æ›´æ–°è¯ä¹¦å—ï¼Ÿ&lt;/p></description></item><item><title>ç¼–è¯‘LIEFçš„å„ç§å§¿åŠ¿</title><link>https://nnnewb.github.io/blog/p/how-to-compile-lief-on-windows/</link><pubDate>Fri, 08 Oct 2021 16:25:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/how-to-compile-lief-on-windows/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>æƒ¯ä¾‹å¾—æœ‰ä¸ªå‰è¨€ã€‚&lt;/p>
&lt;p>LIEFæ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶åˆ†æå’Œæ“ä½œåº“ï¼Œå®˜æ–¹æ¨èçš„æ˜¯ Python ç‰ˆæœ¬ï¼Œç¡®å®æ›´å¥½ç”¨ï¼Œå°±æ˜¯ç±»å‹çš„é—®é¢˜æœ‰ç‚¹å¤šï¼Œè€Œä¸”æ²¡é™„é€ &lt;code>.pyi&lt;/code> å¯¼è‡´ä¸å¤§å¥½å†™ã€‚è€ŒC++ç‰ˆæœ¬å°±æ²¡è¿™é—®é¢˜ï¼ŒC++ç‰ˆæœ¬æœ‰è‡ªå·±çš„é—®é¢˜=ï¼Œ=&lt;/p>
&lt;p>ä¸€ä¸ªæ˜¯å®˜æ–¹æä¾›ä¸‹è½½çš„SDKæ˜¯é™æ€é“¾æ¥çš„ï¼Œç”¨åˆ°SDKçš„ç¨‹åºå¿…é¡»æŒ‡å®š &lt;code>/MT&lt;/code> ä¸ç„¶ç¼–è¯‘å™¨å°±ä¼šæŠ±æ€¨è¿è¡Œåº“ä¸åŒ¹é…ã€‚è™½ç„¶çœ‹issueé‡Œå·²ç»æœ‰äººè§£å†³äº†ï¼ˆ&lt;code>-DLIEF_USE_CRT_{DEBUG,RELEASE}=MD/MT&lt;/code>ï¼‰ï¼Œä½†CIè¿˜æ˜¯è€æ ·å­ï¼Œåæ­£ç›´æ¥ä¸‹è½½çš„SDKç”¨èµ·æ¥å°±è›‹ç–¼ï¼Œvcpkg å…¨éƒ½æ˜¯ &lt;code>/MD&lt;/code> é“¾æ¥çš„ï¼Œæ²¡æ³•é…åˆç”¨ã€‚&lt;/p>
&lt;p>æ›´åˆ«æ MinGW äº†ï¼Œå°±æ²¡å®˜æ–¹çš„SDKã€‚&lt;/p>
&lt;p>ä»¥ä¸Šå°±æ˜¯é—®é¢˜ï¼Œè§£å†³é—®é¢˜çš„æœ€ç®€å•åŠæ³•å°±æ˜¯è‡ªå·±ç¼–è¯‘äº†ã€‚&lt;/p>
&lt;h2 id="0x01-visual-c-å·¥å…·é“¾-msbuild">0x01 Visual C++ å·¥å…·é“¾ msbuild&lt;/h2>
&lt;p>ä»£ç ä¸‹è½½ä¸‹æ¥ä¹‹åï¼Œç”¨ CMake å»ç¼–è¯‘ã€‚ä¸‹é¢çš„å‘½ä»¤éƒ½æ˜¯ Powershell ä¸‹çš„ï¼Œæ³¨æ„æŠ˜è¡Œç”¨çš„æ˜¯åå¼•å· backquoteï¼Œå°±æ˜¯æ³¢æµªå·é‚£ä¸ªé”®ï¼Œå’Œ bash ç”¨ åæ–œæ ä¸ä¸€æ ·ã€‚ç›´æ¥å¤åˆ¶åˆ°å‘½ä»¤è¡Œæ˜¯è·‘ä¸èµ·æ¥çš„ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="n">cmake&lt;/span> &lt;span class="p">..&lt;/span>
&lt;span class="n">-G&lt;/span> &lt;span class="s2">&amp;#34;Visual Studio 2019&amp;#34;&lt;/span> &lt;span class="c"># Generatorï¼Œä½ çš„å·¥å…·é“¾ï¼Œå¯ä»¥ç”¨ cmake --help æ¥çœ‹çœ‹æœ‰å“ªäº›å¯ç”¨çš„&lt;/span>
&lt;span class="n">-A&lt;/span> &lt;span class="n">Win32&lt;/span> &lt;span class="c"># é€‰æ‹© Visual C++ å·¥å…·é“¾çš„æƒ…å†µä¸‹å¯ä»¥ç”¨ -A Win32 é€‰æ‹©ç¼–è¯‘32ä½ä»£ç ï¼Œæˆ–è€… Win64&lt;/span>
&lt;span class="n">-DCMAKE_BUILD_TYPE&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="n">Debug&lt;/span> &lt;span class="c"># å¸¸ç”¨çš„ Debug/Release/RelWithDebInfo&lt;/span>
&lt;span class="n">-DLIEF_PYTHON_API&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="n">off&lt;/span> &lt;span class="c"># ä¸ç¼–è¯‘ Python æ¨¡å—ï¼Œè¿™æ ·å°±ä¸ç”¨è£… Python äº†&lt;/span>
&lt;span class="n">-DLIEF_USE_CRT_DEBUG&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="nb">MD &lt;/span>&lt;span class="c"># ä½¿ç”¨ /MD é“¾æ¥ msvcrt.dll è€Œä¸æ˜¯ libcmt&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™å„¿æœ‰ä¸ªå‘ï¼Œç”¨ Visual Studio è¿™ä¸ª Generator çš„æ—¶å€™ï¼Œè™½ç„¶æŒ‡å®šäº† &lt;code>CMAKE_BUILD_TYPE&lt;/code>ï¼Œä½†å®é™…æ²¡ä»€ä¹ˆåµç”¨ï¼Œè¿˜å¾—åœ¨ç¼–è¯‘çš„æ—¶å€™ç»™å‚æ•° &lt;code>--config Debug&lt;/code> æ‰ä¼šçœŸçš„æŒ‰ Debug ç¼–è¯‘ã€‚&lt;/p>
&lt;p>ç„¶åæ˜¯ç¼–è¯‘å‘½ä»¤ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="n">cmake&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-build&lt;/span> &lt;span class="p">.&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-config&lt;/span> &lt;span class="n">Debug&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-target&lt;/span> &lt;span class="n">LIB_LIEF&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>é»˜è®¤ç”¨å¾®è½¯çš„ msbuild ä¼šèŠ±å¾ˆé•¿æ—¶é—´å»ç¼–è¯‘ï¼Œä¸å«Œéº»çƒ¦çš„è¯å¯ä»¥ç”¨ Ninjaã€‚&lt;/p>
&lt;p>ç¼–è¯‘å®Œè¿˜ä¸èƒ½ç”¨ï¼Œè¿˜å¾—å…ˆâ€œå®‰è£…â€åˆ°ä¸€ä¸ªç›®å½•é‡Œã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="n">cmake&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-install&lt;/span> &lt;span class="p">.&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-config&lt;/span> &lt;span class="n">Debug&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-prefix&lt;/span> &lt;span class="nb">LIEF-msvc&lt;/span>&lt;span class="n">-debug&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™æ ·å°±ä¼šæŠŠå¿…è¦çš„æ–‡ä»¶ç»™å¤åˆ¶åˆ° &lt;code>LIEF-msvc-debug&lt;/code> è¿™ä¸ªæ–‡ä»¶å¤¹é‡Œäº†ï¼Œå‚è€ƒ LIEF å®˜æ–¹çš„é›†æˆæ–‡æ¡£ï¼ŒæŠŠ &lt;code>LIEF_DIR&lt;/code> è®¾ç½®æˆè¿™ä¸ªæ–‡ä»¶å¤¹çš„è·¯å¾„å°±å¯ä»¥ç”¨å•¦ã€‚&lt;/p>
&lt;h2 id="0x02-visual-c-å·¥å…·é“¾-ninja">0x02 Visual C++ å·¥å…·é“¾ ninja&lt;/h2>
&lt;p>ä½¿ç”¨ CMake + Ninja çš„æƒ…å†µä¸‹æ²¡æ³•ç”¨ &lt;code>-A&lt;/code> å»æ§åˆ¶ç¼–è¯‘32ä½è¿˜æ˜¯64ä½äº†ï¼Œä½ å¾—å…ˆè£…å¥½ Visual C++ æ„å»ºå·¥å…·ï¼Œç„¶åæ‰“å¼€å¼€å‘è€…å‘½ä»¤æç¤ºç¬¦ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/how-to-compile-lief-on-windows/image-20211008160449880.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/how-to-compile-lief-on-windows/image-20211008160449880.png"
loading="lazy"
alt="image-20211008160449880">
&lt;/a>
&lt;figcaption>image-20211008160449880&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æ¯”å¦‚æƒ³ç¼–è¯‘32ä½çš„å°±é€‰ &lt;code>x86 native tool command prompt&lt;/code> ï¼Œåœ¨è¿™ä¸ªå‘½ä»¤æç¤ºç¬¦é‡Œç”¨ cmake æ„å»ºã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="n">cmake&lt;/span> &lt;span class="p">..&lt;/span> &lt;span class="n">-G&lt;/span> &lt;span class="n">Ninja&lt;/span> &lt;span class="n">-DCMAKE_BUILD_TYPE&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="n">Debug&lt;/span> &lt;span class="n">-DLIEF_PYTHON_API&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="n">off&lt;/span> &lt;span class="n">-DLIEF_USE_CRT_DEBUG&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="nb">MD
&lt;/span>&lt;span class="nb">&lt;/span>&lt;span class="n">cmake&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-build&lt;/span> &lt;span class="p">.&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-target&lt;/span> &lt;span class="n">LIB_LIEF&lt;/span>
&lt;span class="n">cmake&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-install&lt;/span> &lt;span class="p">.&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-prefix&lt;/span> &lt;span class="nb">LIEF-msvc&lt;/span>&lt;span class="n">-debug&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…¶ä»–å’Œç›´æ¥ç”¨ msvc æ²¡å•¥åŒºåˆ«ã€‚&lt;/p>
&lt;h2 id="0x03-mingw-å·¥å…·é“¾-makefile">0x03 MinGW å·¥å…·é“¾ makefile&lt;/h2>
&lt;p>MinGW å·¥å…·é“¾å…¶å®å’Œ msvc å·®ä¸å¤ªå¤§ã€‚å…ˆè£… MinGWï¼Œæ¨è msys2ï¼Œmsys2è£…å¥½åè·‘å‘½ä»¤ &lt;code>pacman -Sy mingw-w64-i686-toolchain&lt;/code> å°±èƒ½è£…ä¸Š32ä½çš„ç¼–è¯‘å·¥å…·é“¾äº†ï¼ŒåŒ…æ‹¬äº† &lt;code>gcc&lt;/code>ã€&lt;code>g++&lt;/code>ã€&lt;code>mingw32-make&lt;/code> è¿™äº›å¿…è¦çš„ç¨‹åºã€‚&lt;/p>
&lt;p>å®Œäº‹åæŠŠ &lt;code>MinGW&lt;/code> å·¥å…·é“¾åŠ åˆ° &lt;code>PATH&lt;/code> é‡Œã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå‡å¦‚ä½ æŠŠ msys2 è£…åˆ° &lt;code>C:\msys64&lt;/code> ä¸‹çš„è¯ï¼Œé‚£è¦åŠ çš„è·¯å¾„å°±æ˜¯ &lt;code>C:\msys64\mingw32\bin&lt;/code>ï¼Œè‡ªå·±çœ‹çœ‹è¦ç”¨çš„ gcc æ”¾åœ¨å“ªå„¿å‘—ã€‚&lt;/p>
&lt;p>å¦å¤– &lt;code>LIEF_USE_CRT_DEBUG&lt;/code> è¿™å˜é‡ä¹Ÿç”¨ä¸åˆ°äº†ï¼Œ&lt;code>MD&lt;/code>è¿˜æ˜¯&lt;code>MT&lt;/code> è¿™æ˜¯ä¸“ä¾› MSVC çš„é€‰æ‹©é¢˜ï¼ŒMinGW ä¸ç®¡è¿™ä¸ªã€‚&lt;/p>
&lt;p>æ¥ç€å°±å¯ä»¥ç”¨ CMake äº†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="n">cmake&lt;/span> &lt;span class="p">..&lt;/span> &lt;span class="n">-G&lt;/span> &lt;span class="s2">&amp;#34;MinGW Makefiles&amp;#34;&lt;/span> &lt;span class="n">-DCMAKE_BUILD_TYPE&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="n">Debug&lt;/span> &lt;span class="n">-DLIEF_PYTHON_API&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="n">off&lt;/span> &lt;span class="s1">&amp;#39;-DCMAKE_C_FLAGS:STRING=&amp;#34;-m32&amp;#34;&amp;#39;&lt;/span> &lt;span class="s1">&amp;#39;-DCMAKE_CXX_FLAGS:STRING=&amp;#34;-m32&amp;#34;&amp;#39;&lt;/span>
&lt;span class="n">cmake&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-build&lt;/span> &lt;span class="p">.&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-target&lt;/span> &lt;span class="n">LIB_LIEF&lt;/span>
&lt;span class="n">cmake&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-install&lt;/span> &lt;span class="p">.&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-prefix&lt;/span> &lt;span class="nb">LIEF-mingw32&lt;/span>&lt;span class="n">-debug&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸ç”¨æ‹…å¿ƒ CMake é€‰é”™å·¥å…·é“¾ï¼Œç”¨ &lt;code>MinGW Makefiles&lt;/code> çš„æƒ…å†µä¸‹ä¼šä¼˜å…ˆè€ƒè™‘ GCC çš„ã€‚ä¸è¿‡è¿˜æœ‰ä¸ªè€é—®é¢˜ï¼šæ€ä¹ˆé€‰32ä½è¿˜æ˜¯64ä½ã€‚ç­”æ¡ˆæ˜¯è®¾ç½®ä¸‹ &lt;code>C_FLAGS&lt;/code> å’Œ &lt;code>CXX_FLAGS&lt;/code> è¿™ä¸¤ä¸ªç‰¹æ®Šå˜é‡ï¼Œè®©ç¼–è¯‘å™¨åŠ ä¸Š &lt;code>-m32&lt;/code> è¿™ä¸ªå‚æ•°ï¼Œç¼–è¯‘å‡ºæ¥çš„å°±æ˜¯32ä½ä»£ç äº†ã€‚&lt;/p>
&lt;h2 id="0x04-mingw-å·¥å…·é“¾-ninja">0x04 MinGW å·¥å…·é“¾ Ninja&lt;/h2>
&lt;p>å’Œ &lt;code>MinGW Makefiles&lt;/code> å·®ä¸å¤ªå¤šï¼Œä½†æ˜¯ &lt;code>Ninja&lt;/code> æ²¡é‚£ä¹ˆèªæ˜ï¼Œä¸çŸ¥é“è¦ç”¨ä»€ä¹ˆç¼–è¯‘å™¨ï¼Œå¾—æ‰‹åŠ¨æŒ‡å®šã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="n">cmake&lt;/span> &lt;span class="p">..&lt;/span> &lt;span class="n">-G&lt;/span> &lt;span class="n">Ninja&lt;/span> &lt;span class="n">-DCMAKE_BUILD_TYPE&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="n">Debug&lt;/span> &lt;span class="n">-DLIEF_PYTHON_API&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="n">off&lt;/span> &lt;span class="n">-DCMAKE_C_COMPILER&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="n">gcc&lt;/span> &lt;span class="n">-DCMAKE_CXX_COMPILER&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="n">g&lt;/span>&lt;span class="p">++&lt;/span> &lt;span class="s1">&amp;#39;-DCMAKE_C_FLAGS:STRING=&amp;#34;-m32&amp;#34;&amp;#39;&lt;/span> &lt;span class="s1">&amp;#39;-DCMAKE_CXX_FLAGS:STRING=&amp;#34;-m32&amp;#34;&amp;#39;&lt;/span>
&lt;span class="n">cmake&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-build&lt;/span> &lt;span class="p">.&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-target&lt;/span> &lt;span class="n">LIB_LIEF&lt;/span>
&lt;span class="n">cmake&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-install&lt;/span> &lt;span class="p">.&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-prefix&lt;/span> &lt;span class="nb">LIEF-mingw32&lt;/span>&lt;span class="n">-debug&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>é…ç½®é˜¶æ®µå¤šå‡ºæ¥ä¸¤ä¸ªå‚æ•°ï¼Œ&lt;code>-DCMAKE_C_COMPILER=gcc -DCMAKE_CXX_COMPILER=g++&lt;/code>ï¼Œç›®çš„å°±æ˜¯å‘Šè¯‰ CMake æ”¾æœºçµç‚¹ï¼Œç”¨ &lt;code>gcc/g++&lt;/code> ç¼–è¯‘å™¨ï¼Œåˆ«çæ•´ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>ä¹Ÿå°±è¿™ä¹ˆå›äº‹å§ã€‚&lt;/p></description></item><item><title>åŠ å£³åŸç†02 - ç®€å•åŠ å£³æœº</title><link>https://nnnewb.github.io/blog/p/learning-packer-02/</link><pubDate>Tue, 28 Sep 2021 16:57:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/learning-packer-02/</guid><description>&lt;img src="https://nnnewb.github.io/blog/p/learning-packer-02/cover.jpg" alt="Featured image of post åŠ å£³åŸç†02 - ç®€å•åŠ å£³æœº" />&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>å¯¹ Windows ç¨‹åºçš„åŠ è½½å’Œè¿è¡Œè¿‡ç¨‹æœ‰äº†åŸºæœ¬äº†è§£åï¼Œæ‰‹åŠ¨åŠ è½½å¹¶è¿è¡Œä¸€ä¸ªPEæ–‡ä»¶å¹¶ä¸æˆé—®é¢˜ã€‚åŠ å£³ä»…ä»…æ˜¯åœ¨è¿™ä¸Šé¢æ›´è¿›ä¸€æ­¥ï¼šæŠŠåŠ è½½ç¨‹åºå’Œè¢«åŠ è½½çš„ç¨‹åºåˆå¹¶æˆä¸€ä¸ªæ–‡ä»¶ã€‚&lt;/p>
&lt;p>è¿™ä¹ˆè¯´å¯èƒ½æœ‰ç‚¹å¤ªç®€å•åŒ–ï¼Œå¤§éƒ¨åˆ†çš„å·¥ä½œå…¶å®å°±åœ¨è¿™å„¿ï¼šå¦‚ä½•å¤„ç†è¢«åŠ è½½çš„ç¨‹åºï¼Ÿå‹ç¼©ï¼ŸåŠ å¯†ï¼Ÿæ··æ·†ï¼ŸåŠ è½½å™¨ï¼ˆæˆ–è€…å«å£³ç¨‹åºï¼‰å¦‚ä½•åè°ƒè¯•ï¼Ÿ&lt;/p>
&lt;p>è¿™é‡Œå…ˆå†™ä¸€ä¸ªç®€å•çš„åŠ å£³æœºï¼Œä»…ä»…æ˜¯æŠŠè¢«åŠ è½½çš„PEæ–‡ä»¶ä½œä¸ºä¸€ä¸ª Sectionï¼Œæ·»åŠ åˆ°å£³ç¨‹åºé‡Œï¼Œè®©å£³ç¨‹åºç›´æ¥ä»è¿™ä¸ª Section åŠ è½½å¹¶è¿è¡Œã€‚å…¶ä»–èŠ±é‡Œèƒ¡å“¨çš„æ“ä½œéƒ½å…ˆä¸æ•´ï¼Œä»…ä½œä¸ºè¯æ˜å·¥ä½œåŸç†çš„æ¡ˆä¾‹ã€‚&lt;/p>
&lt;h2 id="0x01-å£³ç¨‹åº">0x01 å£³ç¨‹åº&lt;/h2>
&lt;h3 id="11-æ€è·¯">1.1 æ€è·¯&lt;/h3>
&lt;p>å’ŒåŠ è½½ä¸€ä¸ªPEæ–‡ä»¶ä¸åŒï¼Œæ—¢ç„¶è¢«åŠ è½½çš„ç¨‹åºå°±åœ¨ Section é‡Œï¼Œé‚£éœ€è¦åšçš„åªæœ‰å®šä½åˆ° Sectionï¼Œç„¶åæŠŠ Section å†…å®¹å½“è¯»å–è¿›å†…å­˜çš„ PE æ–‡ä»¶å†…å®¹å¤„ç†å°±å¥½äº†ã€‚&lt;/p>
&lt;p>å£³ç¨‹åºåº”è¯¥å°½é‡ä¿æŒè½»é‡ï¼Œä¸åœ¨åŸå§‹ç¨‹åºä¸Šæ·»åŠ å¤ªå¤šä¸œè¥¿ï¼ˆåŠ å®Œå£³å¤§å°ç¿»ä¸€å€è¿˜å¤šäº†ä¸€å †DLLä¾èµ–é‚£è°å—å¾—äº†å•Šï¼‰ï¼Œæ‰€ä»¥å¾ˆå¤šæ ‡å‡†Cåº“çš„å‡½æ•°ä¹Ÿä¸èƒ½ç”¨äº†ï¼Œåƒæ˜¯&lt;code>memcpy&lt;/code>ã€&lt;code>strcmp&lt;/code> éƒ½è¦è‡ªå·±ç®€å•å®ç°ä¸€ä¸ªã€‚&lt;/p>
&lt;h3 id="12--å£³å®ç°">1.2 å£³å®ç°&lt;/h3>
&lt;p>ç»å¤§éƒ¨åˆ†å†…å®¹å’Œä¹‹å‰æ–‡ç« ä¸­çš„ &lt;code>load_PE&lt;/code> ä¸€è‡´ï¼Œå…¥å£ç‚¹ä¿®æ”¹ä¸º &lt;code>_start&lt;/code>ï¼Œéœ€è¦æ³¨æ„ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;Windows.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;winnt.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nf">load_PE&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">PE_data&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">fix_iat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_image_base&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">IMAGE_NT_HEADERS&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_NT_headers&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">fix_base_reloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_image_base&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">IMAGE_NT_HEADERS&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_NT_headers&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">mystrcmp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">str1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">str2&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">mymemcpy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">dest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">src&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">size_t&lt;/span> &lt;span class="n">length&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">_start&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">unpacker_VA&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">GetModuleHandleA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">IMAGE_DOS_HEADER&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_DOS_header&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_DOS_HEADER&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">unpacker_VA&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">IMAGE_NT_HEADERS&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_NT_headers&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_NT_HEADERS&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(((&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">unpacker_VA&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">p_DOS_header&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">e_lfanew&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">IMAGE_SECTION_HEADER&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">sections&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_SECTION_HEADER&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_NT_headers&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">packed&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kt">char&lt;/span> &lt;span class="n">packed_section_name&lt;/span>&lt;span class="p">[]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;.packed&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">FileHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">NumberOfSections&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">mystrcmp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">Name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">packed_section_name&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">packed&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">unpacker_VA&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">VirtualAddress&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">packed&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">entrypoint&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="n">load_PE&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">packed&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">entrypoint&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nf">load_PE&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">PE_data&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">IMAGE_DOS_HEADER&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_DOS_header&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_DOS_HEADER&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">PE_data&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">IMAGE_NT_HEADERS&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_NT_headers&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_NT_HEADERS&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">PE_data&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">p_DOS_header&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">e_lfanew&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// extract information from PE header
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">DWORD&lt;/span> &lt;span class="n">size_of_image&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">SizeOfImage&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">DWORD&lt;/span> &lt;span class="n">entry_point_RVA&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">AddressOfEntryPoint&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">DWORD&lt;/span> &lt;span class="n">size_of_headers&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">SizeOfHeaders&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// allocate memory
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">VirtualAlloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">size_of_image&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MEM_RESERVE&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">MEM_COMMIT&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PAGE_READWRITE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// copy PE headers in memory
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">mymemcpy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">p_image_base&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PE_data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">size_of_headers&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// Section headers starts right after the IMAGE_NT_HEADERS struct, so we do some pointer arithmetic-fu here.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">IMAGE_SECTION_HEADER&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">sections&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_SECTION_HEADER&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_NT_headers&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">FileHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">NumberOfSections&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// calculate the VA we need to copy the content, from the RVA
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// section[i].VirtualAddress is a RVA, mind it
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">dest&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">VirtualAddress&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// check if there is Raw data to copy
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">SizeOfRawData&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// We copy SizeOfRaw data bytes, from the offset PointerToRawData in the file
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">mymemcpy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PE_data&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">PointerToRawData&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">SizeOfRawData&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">size_t&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">Misc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">VirtualSize&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">dest&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">fix_iat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">p_image_base&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">fix_base_reloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">p_image_base&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// Set permission for the PE header to read only
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">DWORD&lt;/span> &lt;span class="n">oldProtect&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">VirtualProtect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">p_image_base&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">SizeOfHeaders&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PAGE_READONLY&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">oldProtect&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">FileHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">NumberOfSections&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">dest&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">VirtualAddress&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">DWORD&lt;/span> &lt;span class="n">s_perm&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">Characteristics&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">DWORD&lt;/span> &lt;span class="n">v_perm&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// flags are not the same between virtal protect and the section header
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">s_perm&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">IMAGE_SCN_MEM_EXECUTE&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">v_perm&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">s_perm&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">IMAGE_SCN_MEM_WRITE&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="nl">PAGE_EXECUTE_READWRITE&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">PAGE_EXECUTE_READ&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">v_perm&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">s_perm&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">IMAGE_SCN_MEM_WRITE&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="nl">PAGE_READWRITE&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">PAGE_READONLY&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">VirtualProtect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">Misc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">VirtualSize&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">v_perm&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">oldProtect&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">entry_point_RVA&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">fix_iat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_image_base&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">IMAGE_NT_HEADERS&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_NT_headers&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">IMAGE_DATA_DIRECTORY&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">data_directory&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">DataDirectory&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// load the address of the import descriptors array
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">IMAGE_IMPORT_DESCRIPTOR&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">import_descriptors&lt;/span> &lt;span class="o">=&lt;/span>
&lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_IMPORT_DESCRIPTOR&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">data_directory&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">IMAGE_DIRECTORY_ENTRY_IMPORT&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">VirtualAddress&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// this array is null terminated
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">import_descriptors&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">OriginalFirstThunk&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Get the name of the dll, and import it
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">module_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">import_descriptors&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">Name&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">HMODULE&lt;/span> &lt;span class="n">import_module&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">LoadLibraryA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">module_name&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">import_module&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// panic!
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">ExitProcess&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">255&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// the lookup table points to function names or ordinals =&amp;gt; it is the IDT
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">IMAGE_THUNK_DATA&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">lookup_table&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_THUNK_DATA&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">import_descriptors&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">OriginalFirstThunk&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// the address table is a copy of the lookup table at first
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// but we put the addresses of the loaded function inside =&amp;gt; that&amp;#39;s the IAT
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">IMAGE_THUNK_DATA&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">address_table&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_THUNK_DATA&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">import_descriptors&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">FirstThunk&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// null terminated array, again
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">lookup_table&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">u1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">AddressOfData&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">function_handle&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// Check the lookup table for the adresse of the function name to import
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">DWORD&lt;/span> &lt;span class="n">lookup_addr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">lookup_table&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">u1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">AddressOfData&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">lookup_addr&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">IMAGE_ORDINAL_FLAG&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// if first bit is not 1
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// import by name : get the IMAGE_IMPORT_BY_NAME struct
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">IMAGE_IMPORT_BY_NAME&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">image_import&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_IMPORT_BY_NAME&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">lookup_addr&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// this struct points to the ASCII function name
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">funct_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">image_import&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">Name&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// get that function address from it&amp;#39;s module and name
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">function_handle&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">GetProcAddress&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">import_module&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">funct_name&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// import by ordinal, directly
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">function_handle&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">GetProcAddress&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">import_module&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">LPSTR&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">lookup_addr&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">function_handle&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">ExitProcess&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">255&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// change the IAT, and put the function address inside.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">address_table&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">u1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Function&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">DWORD&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">function_handle&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">fix_base_reloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_image_base&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">IMAGE_NT_HEADERS&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_NT_headers&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">IMAGE_DATA_DIRECTORY&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">data_directory&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">DataDirectory&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// this is how much we shifted the ImageBase
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">DWORD&lt;/span> &lt;span class="n">delta_VA_reloc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">DWORD&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">p_image_base&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">ImageBase&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// if there is a relocation table, and we actually shitfted the ImageBase
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">data_directory&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">IMAGE_DIRECTORY_ENTRY_BASERELOC&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">VirtualAddress&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">delta_VA_reloc&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// calculate the relocation table address
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">IMAGE_BASE_RELOCATION&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_reloc&lt;/span> &lt;span class="o">=&lt;/span>
&lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_BASE_RELOCATION&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">data_directory&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">IMAGE_DIRECTORY_ENTRY_BASERELOC&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">VirtualAddress&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// once again, a null terminated array
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">p_reloc&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">VirtualAddress&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// how any relocation in this block
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// ie the total size, minus the size of the &amp;#34;header&amp;#34;, divided by 2 (those are words, so 2 bytes for each)
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">DWORD&lt;/span> &lt;span class="n">size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">p_reloc&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">SizeOfBlock&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_BASE_RELOCATION&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// the first relocation element in the block, right after the header (using pointer arithmetic again)
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">WORD&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">fixups&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">WORD&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_reloc&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">size_t&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">size&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// type is the first 4 bits of the relocation word
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">type&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fixups&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;&lt;/span> &lt;span class="mi">12&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// offset is the last 12 bits
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">offset&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fixups&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mh">0x0fff&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// this is the address we are going to change
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">DWORD&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">change_addr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">DWORD&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">p_reloc&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">VirtualAddress&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">offset&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// there is only one type used that needs to make a change
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">switch&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">type&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nl">IMAGE_REL_BASED_HIGHLOW&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="o">*&lt;/span>&lt;span class="n">change_addr&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">delta_VA_reloc&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// switch to the next relocation block, based on the size
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">p_reloc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_BASE_RELOCATION&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(((&lt;/span>&lt;span class="n">DWORD&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">p_reloc&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">p_reloc&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">SizeOfBlock&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">mystrcmp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">str1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">str2&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">str1&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">str2&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">str1&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">str1&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">str2&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">str1&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">str2&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">mymemcpy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">dest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">src&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">size_t&lt;/span> &lt;span class="n">length&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">size_t&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">length&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">dest&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">src&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ„å»ºå‚æ•°ï¼ˆCMAKEï¼‰&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-cmake" data-lang="cmake">&lt;span class="nb">add_executable&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">loader_2&lt;/span> &lt;span class="s">WIN32&lt;/span> &lt;span class="s">loader_2.c&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="nb">target_compile_options&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">loader_2&lt;/span> &lt;span class="s">PRIVATE&lt;/span> &lt;span class="s">/GS-&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="nb">target_link_options&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">loader_2&lt;/span> &lt;span class="s">PRIVATE&lt;/span> &lt;span class="s">/NODEFAULTLIB&lt;/span> &lt;span class="s">/ENTRY:_start&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å‚æ•°&lt;code>/GS-&lt;/code>æ˜¯ä¸ºäº†é¿å…åœ¨&lt;code>/NODEFAULTLIB&lt;/code>ä¸‹å‡ºç°ä¸€äº›ç¼“å­˜åŒºå®‰å…¨æ£€æŸ¥ä»£ç é“¾æ¥é”™è¯¯ã€‚å‚è€ƒ&lt;a class="link" href="https://docs.microsoft.com/en-us/cpp/build/reference/gs-buffer-security-check?view=msvc-160" target="_blank" rel="noopener"
>æ–‡æ¡£&lt;/a>ã€‚&lt;/p>
&lt;h2 id="0x02-åŠ å£³æœº">0x02 åŠ å£³æœº&lt;/h2>
&lt;p>ç›¸ä¿¡å·²ç»å‘ç°äº†ï¼Œä¸Šæ–‡å¹¶æ²¡æœ‰æåˆ°æ€ä¹ˆæŠŠç¨‹åºåµŒå…¥å£³ç¨‹åºé‡Œã€‚è¿™æ˜¯å› ä¸ºåŠ å£³å¹¶ä¸æ˜¯åœ¨å£³ç¨‹åºç¼–è¯‘æ—¶ç›´æ¥æŠŠæ–‡ä»¶åµŒè¿›å»=ï¼Œ=è™½ç„¶ç†è®ºä¸Šæ¥è¯´ä¹Ÿå¯ä»¥ï¼Œä½†è¿™é‡Œä¸è®¨è®ºäº†ã€‚ä»…ä»…çœ‹åŠ å£³æœºåŠ å£³çš„åœºæ™¯å§ã€‚&lt;/p>
&lt;h3 id="21-åŠ å£³æœºåŸç†">2.1 åŠ å£³æœºåŸç†&lt;/h3>
&lt;p>åŠ å£³æœºåšçš„äº‹æƒ…åŒ…æ‹¬ï¼š&lt;/p>
&lt;ul>
&lt;li>åœ¨ section table é‡Œæ·»åŠ  section
&lt;ul>
&lt;li>æ ¹æ® section table å’Œ file_alignment å†³å®šå¦‚ä½•åˆ†é…ç©ºé—´&lt;/li>
&lt;li>æ ¹æ® section_alignment è®¡ç®— virtual size&lt;/li>
&lt;li>æ ¹æ®ä¸Šä¸€ä¸ª section å¤§å°å’Œä½ç½®è®¡ç®— virtual address&lt;/li>
&lt;li>å¡«å…… pointer_to_raw_data å’Œ size_of_raw_data&lt;/li>
&lt;li>è®¾ç½®åˆé€‚çš„ characteristics&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>è®¡ç®—ä¿®æ”¹ number_of_sections&lt;/li>
&lt;li>è®¡ç®—ä¿®æ”¹ size_of_image&lt;/li>
&lt;li>è®¡ç®—ä¿®æ”¹ size_of_headers&lt;/li>
&lt;/ul>
&lt;p>åæ­£çœ‹èµ·æ¥å°±å¾ˆéº»çƒ¦ï¼Œä¸è¿‡å¹¸å¥½æ“ä½œ PE æ–‡ä»¶çš„åº“ä¸å°‘ï¼ŒGitHub æœä¸€æœå°±æœ‰ã€‚è¿™é‡Œç”¨ &lt;a class="link" href="https://github.com/lief-project/LIEF" target="_blank" rel="noopener"
>LIEF&lt;/a> è¿™ä¸ªåº“ï¼Œæ“ä½œè›®ç®€å•çš„ã€‚&lt;/p>
&lt;h3 id="22-æºç ">2.2 æºç &lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-cpp" data-lang="cpp">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;Windows.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;LIEF/LIEF.hpp&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;vector&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">uint8_t&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">read_file&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">string&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">h&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">CreateFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">c_str&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="n">GENERIC_READ&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">nullptr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">OPEN_EXISTING&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">FILE_ATTRIBUTE_NORMAL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">nullptr&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">DWORD&lt;/span> &lt;span class="n">readbyte&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">filesize&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">GetFileSize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">h&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">nullptr&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">content&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">uint8_t&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="n">content&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">resize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">filesize&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">ReadFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">h&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">content&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="n">filesize&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">readbyte&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">nullptr&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">abort&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">readbyte&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">filesize&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">abort&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">CloseHandle&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">h&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">content&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">argc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[])&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">argc&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;loader and program path are required&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">loader_path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">program_path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">loader_binary&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">LIEF&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">Parser&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">parse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">loader_path&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// LIEF å¸®æˆ‘ä»¬åšäº†åç§»è®¡ç®—ä¹‹ç±»çš„å·¥ä½œï¼Œè¿™é‡Œå°±åªç”¨ç‚¹é€»è¾‘ï¼Œéå¸¸å¾—é“¶æã€‚
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">auto&lt;/span> &lt;span class="n">program_content&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">read_file&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">program_path&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">packed_section&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">LIEF&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">Section&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;.packed&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// æ–°å»º section
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">packed_section&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">content&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">program_content&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// æŠŠè¢«åŠ è½½ç¨‹åºçš„å†…å®¹å½“æˆ section å†…å®¹
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">loader_binary&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">add_section&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">packed_section&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">LIEF&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">PE_SECTION_TYPES&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">DATA&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// æŠŠ section æ·»åŠ åˆ°å£³ç¨‹åºé‡Œ
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// ç”¨ lief å®ç°æŠŠä¿®æ”¹åçš„å£³ç¨‹åºå†™å…¥ç¡¬ç›˜
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">auto&lt;/span> &lt;span class="n">builder&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">LIEF&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">Builder&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">Builder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">loader_binary&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">());&lt;/span>
&lt;span class="n">builder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">build&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="n">builder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;packed.exe&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç¼–è¯‘æŒ‡ä»¤ï¼ˆCMAKEï¼‰å‚è€ƒ &lt;a class="link" href="https://lief-project.github.io//doc/latest/installation.html#cmake-integration" target="_blank" rel="noopener"
>LIEF æ–‡æ¡£&lt;/a>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-cmake" data-lang="cmake">&lt;span class="c"># Custom path to the LIEF install directory
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="nb">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">LIEF_DIR&lt;/span> &lt;span class="s">CACHE&lt;/span> &lt;span class="s">PATH&lt;/span> &lt;span class="o">${&lt;/span>&lt;span class="nv">CMAKE_INSTALL_PREFIX&lt;/span>&lt;span class="o">}&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># Directory to &amp;#39;FindLIEF.cmake&amp;#39;
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="nb">list&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">APPEND&lt;/span> &lt;span class="s">CMAKE_MODULE_PATH&lt;/span> &lt;span class="o">${&lt;/span>&lt;span class="nv">LIEF_DIR&lt;/span>&lt;span class="o">}&lt;/span>&lt;span class="s">/share/LIEF/cmake&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># include &amp;#39;FindLIEF.cmake&amp;#39;
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="nb">include&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">FindLIEF&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># Find LIEF
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="nb">find_package&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">LIEF&lt;/span> &lt;span class="s">REQUIRED&lt;/span> &lt;span class="s">COMPONENTS&lt;/span> &lt;span class="s">STATIC&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c"># COMPONENTS: &amp;lt;SHARED | STATIC&amp;gt; - Default: STATIC
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="nb">add_executable&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">packer&lt;/span> &lt;span class="s">packer.cpp&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="nb">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">MSVC&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="nb">target_compile_options&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">packer&lt;/span> &lt;span class="s">PRIVATE&lt;/span> &lt;span class="s">/FIiso646.h&lt;/span> &lt;span class="s">/MT&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="nb">set_property&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">TARGET&lt;/span> &lt;span class="s">packer&lt;/span> &lt;span class="s">PROPERTY&lt;/span> &lt;span class="s">LINK_FLAGS&lt;/span> &lt;span class="s">/NODEFAULTLIB:MSVCRT&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="nb">endif&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="nb">target_include_directories&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">packer&lt;/span> &lt;span class="s">PRIVATE&lt;/span> &lt;span class="o">${&lt;/span>&lt;span class="nv">LIEF_INCLUDE_DIRS&lt;/span>&lt;span class="o">}&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="nb">set_property&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">TARGET&lt;/span> &lt;span class="s">packer&lt;/span>
&lt;span class="s">PROPERTY&lt;/span> &lt;span class="s">CXX_STANDARD&lt;/span> &lt;span class="s">11&lt;/span>
&lt;span class="s">PROPERTY&lt;/span> &lt;span class="s">CXX_STANDARD_REQUIRED&lt;/span> &lt;span class="s">ON&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="nb">target_link_libraries&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">packer&lt;/span> &lt;span class="s">PRIVATE&lt;/span> &lt;span class="o">${&lt;/span>&lt;span class="nv">LIEF_LIBRARIES&lt;/span>&lt;span class="o">}&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ‘è¦é¡ºä¾¿ä¸€æï¼ŒLIEFæœ‰pythonåŒ…ï¼Œä½†é‚£ç©æ„å„¿ä¸çŸ¥é“ä¸ºå•¥èµ‹å€¼contentä¸€ç›´æŠ¥ not supportedï¼Œæ²¡è§£å†³ã€‚å°±å¹²è„†æ‹¿ c++ å†™äº†ã€‚è®ºç®€å•å¿«æ·è¿˜æ˜¯è¦çœ‹ python ç‰ˆæœ¬çš„ã€‚&lt;/p>
&lt;h2 id="ç»“è®º">ç»“è®º&lt;/h2>
&lt;p>åŠ å£³ç¨‹åºåè€Œå¹³å¹³æ— å¥‡ï¼Œæ­£å°è¯äº†é‚£å¥å°ä¸‹åŠŸå¤«ã€‚&lt;/p></description></item><item><title>åŠ å£³åŸç†01 - Windows ç¨‹åºçš„åŠ è½½å’Œè¿è¡Œ</title><link>https://nnnewb.github.io/blog/p/learning-packer-01/</link><pubDate>Mon, 27 Sep 2021 14:51:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/learning-packer-01/</guid><description>&lt;img src="https://nnnewb.github.io/blog/p/learning-packer-01/cover.jpg" alt="Featured image of post åŠ å£³åŸç†01 - Windows ç¨‹åºçš„åŠ è½½å’Œè¿è¡Œ" />&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>æœ¬æ–‡ç”±å¤šç¯‡ç›¸å…³æ–‡ç« ç¿»è¯‘æ•´åˆå¾—æ¥ï¼Œå‚è€ƒæ–‡ç« å’Œä¹¦ç›®æ–‡æœ«ç»™å‡ºã€‚&lt;/p>
&lt;h2 id="0x01-peæ–‡ä»¶ç»“æ„">0x01 PEæ–‡ä»¶ç»“æ„&lt;/h2>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 134;
flex-basis: 322px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/learning-packer-01/PE_Format.png" data-size="2048x1526">
&lt;img src="https://nnnewb.github.io/blog/blog/p/learning-packer-01/PE_Format.png"
width="2048"
height="1526"
srcset="https://nnnewb.github.io/blog/blog/p/learning-packer-01/PE_Format_hu1d6972d7cbd2497cb5e2be07eb52e9a7_686257_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/learning-packer-01/PE_Format_hu1d6972d7cbd2497cb5e2be07eb52e9a7_686257_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="PE_Format">
&lt;/a>
&lt;figcaption>PE_Format&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;h3 id="11-ä»-pe-coff-æ ¼å¼è¯´èµ·">1.1 ä» PE-COFF æ ¼å¼è¯´èµ·&lt;/h3>
&lt;blockquote>
&lt;p>&amp;hellip; ç°åœ¨PCå¹³å°æµè¡Œçš„ &lt;strong>å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ï¼ˆExecutableï¼‰&lt;/strong> ä¸»è¦æ˜¯ Windows ä¸‹çš„ PE ï¼ˆPortable Executableï¼‰ å’Œ Linux çš„ ELF ï¼ˆExecutable Linkable Formatï¼‰ï¼Œå®ƒä»¬éƒ½æ˜¯ COFFï¼ˆCommon Object File Formatï¼‰æ ¼å¼çš„å˜ç§ã€‚ç›®æ ‡æ–‡ä»¶å°±æ˜¯æºä»£ç ç¼–è¯‘åä½†æœªè¿›è¡Œé“¾æ¥çš„é‚£äº›ä¸­é—´æ–‡ä»¶ï¼ˆWindows çš„ .obj å’Œ Linux ä¸‹çš„ .oï¼‰ï¼Œå®ƒå’Œå¯æ‰§è¡Œæ–‡ä»¶çš„å†…å®¹å’Œç»“æ„å¾ˆç›¸ä¼¼ï¼Œæ‰€ä»¥ä¸€èˆ¬è·Ÿå¯æ‰§è¡Œæ–‡ä»¶ä¸€èµ·é‡‡ç”¨ä¸€ç§æ ¼å¼å­˜å‚¨ã€‚ä»å¹¿ä¹‰ä¸Šçœ‹ï¼Œç›®æ ‡æ–‡ä»¶ä¸å¯æ‰§è¡Œæ–‡ä»¶çš„æ ¼å¼å…¶å®å‡ ä¹æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¹¿ä¹‰åœ°å°†ç›®æ ‡æ–‡ä»¶ä¸å¯æ‰§è¡Œæ–‡ä»¶çœ‹æˆæ˜¯åŒä¸€ç§ç±»å‹çš„æ–‡ä»¶ï¼Œåœ¨ Windows ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ç»Ÿç§°å®ƒä»¬ä¸º PE-COFF æ–‡ä»¶æ ¼å¼ã€‚åœ¨ Linux ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒä»¬ç»Ÿç§°ä¸º ELF æ–‡ä»¶ã€‚&lt;/p>
&lt;p>&amp;hellip; ä¸å…‰æ˜¯ &lt;strong>å¯æ‰§è¡Œæ–‡ä»¶&lt;/strong> ï¼ˆWindows çš„ .exe å’Œ Linux ä¸‹çš„ ELF å¯æ‰§è¡Œæ–‡ä»¶ï¼‰æŒ‰ç…§å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼å­˜å‚¨ã€‚&lt;strong>åŠ¨æ€é“¾æ¥åº“ï¼ˆDLLï¼ŒDynamic Linking Libraryï¼‰&lt;/strong> ï¼ˆWindows çš„ DLL å’Œ Linux ä¸‹çš„ .so ï¼‰ä»¥åŠ&lt;strong>é™æ€é“¾æ¥åº“ ï¼ˆStatic Linking Libraryï¼‰&lt;/strong> ï¼ˆWindows çš„ .lib å’Œ Linux ä¸‹çš„ .aï¼‰æ–‡ä»¶éƒ½æŒ‰ç…§å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼å­˜å‚¨ã€‚å®ƒä»¬åœ¨ Windows ä¸‹éƒ½æŒ‰ç…§ PE-COFF æ ¼å¼å­˜å‚¨ï¼ŒLinux ä¸‹æŒ‰ç…§ ELF æ ¼å¼å­˜å‚¨ã€‚é™æ€é“¾æ¥åº“ç¨æœ‰ä¸åŒï¼Œå®ƒæ˜¯æŠŠå¾ˆå¤šç›®æ ‡æ–‡ä»¶æ†ç»‘åœ¨ä¸€èµ·å½¢æˆä¸€ä¸ªæ–‡ä»¶ï¼Œå†åŠ ä¸Šä¸€äº›ç´¢å¼•ï¼Œå¯ä»¥ç®€å•ç†è§£ä¸ºä¸€ä¸ªåŒ…å«å¾ˆå¤šç›®æ ‡æ–‡ä»¶çš„æ–‡ä»¶åŒ…ã€‚&lt;/p>
&lt;p>&amp;hellip; COFF çš„ä¸»è¦è´¡çŒ®æ˜¯åœ¨ç›®æ ‡æ–‡ä»¶å¼•å…¥äº†â€œæ®µâ€çš„æœºåˆ¶ï¼Œä¸åŒçš„ç›®æ ‡æ–‡ä»¶å¯ä»¥æ‹¥æœ‰ä¸åŒæ•°é‡åŠä¸åŒç±»å‹çš„â€œæ®µâ€ã€‚å¦å¤–ï¼Œå®ƒè¿˜å®šä¹‰äº†è°ƒè¯•æ•°æ®çš„æ ¼å¼ã€‚&lt;/p>
&lt;p>â€”â€”ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»â€”â€”é“¾æ¥ã€è£…è½½ä¸åº“ã€‹&lt;/p>
&lt;/blockquote>
&lt;p>è¿™é‡Œè®¨è®ºå¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ï¼Œç›®æ ‡æ–‡ä»¶ã€é™æ€åº“ã€åŠ¨æ€åº“éƒ½å…ˆæš‚æ—¶ä¸è€ƒè™‘ã€‚btwï¼Œå¼•æ–‡ä¸­çš„â€œæ®µâ€å…¶å®è¯´çš„æ—¢æ˜¯Sectionä¹Ÿæ˜¯Segmentï¼Œæ ¹æ®ä¸Šä¸‹æ–‡è‡ªå·±ç†è§£ã€‚&lt;/p>
&lt;h3 id="12-pe-æ–‡ä»¶å¤´ä¸€è§ˆ">1.2 PE æ–‡ä»¶å¤´ä¸€è§ˆ&lt;/h3>
&lt;p>PEæ ¼å¼åœ¨ Wiki ä¸Šæœ‰å¼ æŒºæ¼‚äº®çš„å›¾ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 70;
flex-basis: 169px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/learning-packer-01/Portable_Executable_32_bit_Structure_in_SVG_fixed.png" data-size="2980x4213">
&lt;img src="https://nnnewb.github.io/blog/blog/p/learning-packer-01/Portable_Executable_32_bit_Structure_in_SVG_fixed.png"
width="2980"
height="4213"
srcset="https://nnnewb.github.io/blog/blog/p/learning-packer-01/Portable_Executable_32_bit_Structure_in_SVG_fixed_hu17a376e08455c311f7e43d421ffa5e76_295222_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/learning-packer-01/Portable_Executable_32_bit_Structure_in_SVG_fixed_hu17a376e08455c311f7e43d421ffa5e76_295222_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="Portable_Executable_32_bit_Structure_in_SVG_fixed">
&lt;/a>
&lt;figcaption>Portable_Executable_32_bit_Structure_in_SVG_fixed&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå¾®è½¯çš„å…¼å®¹åŒ…è¢±æ˜¯çœŸçš„é‡ï¼ˆä¸æ˜¯ï¼‰ã€‚&lt;/p>
&lt;p>PEæ–‡ä»¶å¤´å·²ç»åŒ…å«äº†æµ·é‡çš„ä¿¡æ¯ï¼Œå¤§éƒ¨åˆ†æˆ‘ä»¬ä¸å…³æ³¨ï¼ˆæˆ–è€…è¯´å¾ˆå°‘å…³æ³¨ï¼Ÿï¼‰ï¼Œä»åšä¸ªç®€å•å£³çš„ç›®çš„å‡ºå‘ï¼Œäº†è§£äº†PE-COFFæ ¼å¼çš„ä¸€ç‚¹é€šè¯†å’Œå†å²åå°±å¯ä»¥ç»§ç»­äº†ã€‚&lt;/p>
&lt;p>è¯»æ‡‚è¿™å›¾éœ€è¦äº†è§£ä¸‹å…³äºPEæ–‡ä»¶ä¸­å‡ ç§â€œåœ°å€â€çš„æ¦‚å¿µï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;em>raw addresses&lt;/em>ï¼Œæˆ–è€…æ–‡ä»¶åç§» &lt;em>file offset&lt;/em>ï¼Œè¿™ç§åœ°å€æŒ‡çš„æ˜¯ &lt;strong>PE æ–‡ä»¶ä¸­çš„åç§»&lt;/strong>ã€‚&lt;/li>
&lt;li>&lt;em>virtual addresses&lt;/em>ï¼Œè™šæ‹Ÿåœ°å€ï¼ŒæŒ‡åœ¨ RAM ä¸­çš„åœ°å€ï¼Œå°±æ˜¯ä¸€èˆ¬å¸¸è¯´çš„è¿›ç¨‹åœ°å€ç©ºé—´é‡Œçš„åœ°å€ã€‚&lt;/li>
&lt;li>&lt;em>relative virtual addresses&lt;/em>ï¼Œç›¸å¯¹é•œåƒåŸºå€ï¼ˆImage Baseï¼‰çš„è™šæ‹Ÿåœ°å€ï¼Œä¸è€ƒè™‘ ASLR çš„æƒ…å†µä¸‹ï¼Œç›¸å¯¹åœ°å€è®¡ç®—å°±æ˜¯åŸºå€+RVAã€‚&lt;/li>
&lt;/ul>
&lt;p>å¯ä»¥ç†è§£æˆï¼ŒVA å°±æ˜¯åŸºå€+RVAï¼ŒRVAå°±æ˜¯VA-åŸºå€ã€‚&lt;/p>
&lt;p>VA/RVA è½¬æ–‡ä»¶åç§»å°±éº»çƒ¦å¾ˆå¤šï¼Œè¦æ ¹æ®èŠ‚è¡¨ &lt;em>Section Table&lt;/em> è®¡ç®—ã€‚&lt;/p>
&lt;p>ä¸Šè¿°é•œåƒåŸºå€ &lt;em>Image Base&lt;/em> å’ŒèŠ‚è¡¨ &lt;em>Section Table&lt;/em> éƒ½å¯ä»¥åœ¨å›¾é‡Œæ‰¾åˆ°ã€‚&lt;/p>
&lt;h3 id="13-dos-æ–‡ä»¶å¤´">1.3 DOS æ–‡ä»¶å¤´&lt;/h3>
&lt;p>æˆ‘ä»¬å¯ä»¥ç”¨åœ¨ Python REPL ä¸­ç”¨ &lt;a class="link" href="https://pypi.org/project/pefile" target="_blank" rel="noopener"
>pefile&lt;/a> æ¥å¿«é€Ÿåˆ†æå’ŒæŸ¥çœ‹PEæ–‡ä»¶ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="kn">import&lt;/span> &lt;span class="nn">pefile&lt;/span>
&lt;span class="n">pe&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">pefile&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PE&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;cm04.exe&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># cm04 æ˜¯C++å†™çš„å¸¦ç•Œé¢ Hello worldï¼Œä½ ä¹Ÿå¯ä»¥ç”¨è®¡ç®—å™¨ï¼ŒC:\Windows\System32\calc.exe&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pe&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">DOS_HEADERS&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç»“æœå¦‚ä¸‹&lt;/p>
&lt;pre>&lt;code>[IMAGE_DOS_HEADER]
0x0 0x0 e_magic: 0x5A4D
0x2 0x2 e_cblp: 0x90
0x4 0x4 e_cp: 0x3
0x6 0x6 e_crlc: 0x0
0x8 0x8 e_cparhdr: 0x4
0xA 0xA e_minalloc: 0x0
0xC 0xC e_maxalloc: 0xFFFF
0xE 0xE e_ss: 0x0
0x10 0x10 e_sp: 0xB8
0x12 0x12 e_csum: 0x0
0x14 0x14 e_ip: 0x0
0x16 0x16 e_cs: 0x0
0x18 0x18 e_lfarlc: 0x40
0x1A 0x1A e_ovno: 0x0
0x1C 0x1C e_res:
0x24 0x24 e_oemid: 0x0
0x26 0x26 e_oeminfo: 0x0
0x28 0x28 e_res2:
0x3C 0x3C e_lfanew: 0x108
&lt;/code>&lt;/pre>&lt;p>ç¬¬ä¸€åˆ—æ˜¯æ–‡ä»¶åç§»ï¼Œç¬¬äºŒåˆ—æ˜¯ç»“æ„å†…çš„ç›¸å¯¹åç§»ï¼Œç¬¬ä¸‰åˆ—æ˜¯å­—æ®µåï¼Œç¬¬å››åˆ—æ˜¯å€¼ã€‚&lt;/p>
&lt;p>DOSæ–‡ä»¶å¤´é‡ŒåŸºæœ¬éƒ½æ˜¯ä¸ºå…¼å®¹ä¿ç•™çš„å­—æ®µï¼Œæ²¡æœ‰æˆ‘ä»¬éœ€è¦çš„ä¿¡æ¯ã€‚éœ€è¦å…³æ³¨çš„ä¸»è¦æ˜¯å¼€å¤´çš„&lt;code>e_magic&lt;/code>ï¼Œå›ºå®šä¸º&lt;code>0x5A4D&lt;/code>ï¼Œä¹Ÿå°±æ˜¯ASCIIç¼–ç çš„&lt;code>MZ&lt;/code>ï¼›è¿˜æœ‰æœ«å°¾çš„&lt;code>e_lfanew&lt;/code>ï¼Œè¿™ä¸ªå­—æ®µä¿å­˜çš„æ˜¯NTæ–‡ä»¶å¤´çš„æ–‡ä»¶åç§»ï¼Œå¯¹ç…§ä¸Šæ–‡çš„å›¾ç‰‡ï¼Œå°±æ˜¯ç»¿è‰² COFF Header å¼€å¤´çš„ Signatureã€‚&lt;/p>
&lt;h3 id="14-ntfilecoff-æ–‡ä»¶å¤´">1.4 NT/File/COFF æ–‡ä»¶å¤´&lt;/h3>
&lt;p>è¿™éƒ¨åˆ†å¼€å§‹ï¼Œæ•°æ®ç»“æ„å®šä¹‰å’Œä¸Šæ–‡ä¸­çš„PEæ–‡ä»¶å¤´å›¾æœ‰ç‚¹å·®å¼‚ï¼ˆä¸»è¦æ˜¯å­—æ®µåˆ’åˆ†å½’ç±»ä¸Šï¼‰ï¼Œç¼–ç¨‹çš„æ—¶å€™æŒ‰å®é™…æ•°æ®ç»“æ„å†™ï¼Œçœ‹ç†è®ºçš„æ—¶å€™éµç…§æ–‡æ¡£è¯´æ³•æ¥çµæ´»ç†è§£å§ã€‚ä¹‹åCç»“æ„å®šä¹‰åœ¨å­—æ®µå½’ç±»ä¸Šä¹Ÿæœ‰ç‚¹å·®åˆ«çš„ã€‚æ€»ä¹‹ï¼Œå‚è€ƒå­—æ®µå¤§å°é¡ºåºï¼Œåˆ«å¤ªåœ¨æ„ç»“æ„æ€ä¹ˆå†™çš„ã€‚&lt;/p>
&lt;p>ç”¨ &lt;code>print(pe.NT_HEADERS)&lt;/code> å¯ä»¥çœ‹åˆ°åªè¾“å‡ºäº†ä¸€ä¸ª Signatureã€‚å‰©ä½™çš„ COFF Header å¯ä»¥ç”¨ &lt;code>pe.FILE_HEADER&lt;/code> æŸ¥çœ‹ï¼ˆåœ¨å¾®è½¯ &lt;a class="link" href="https://docs.microsoft.com/en-us/windows/win32/debug/pe-format#file-headers" target="_blank" rel="noopener"
>PE Format æ–‡æ¡£&lt;/a>ä¸­ï¼ŒSignature ä¸æ˜¯ COFF File Header çš„ç»„æˆéƒ¨åˆ†ï¼Œå’Œ Wiki çš„å›¾ä¸ä¸€è‡´ï¼‰ã€‚&lt;/p>
&lt;pre>&lt;code>In [4]: print(pe.FILE_HEADER)
[IMAGE_FILE_HEADER]
0x10C 0x0 Machine: 0x14C
0x10E 0x2 NumberOfSections: 0x7
0x110 0x4 TimeDateStamp: 0x61501513 [Sun Sep 26 06:37:07 2021 UTC]
0x114 0x8 PointerToSymbolTable: 0x0
0x118 0xC NumberOfSymbols: 0x0
0x11C 0x10 SizeOfOptionalHeader: 0xE0
0x11E 0x12 Characteristics: 0x102
&lt;/code>&lt;/pre>&lt;p>åœ¨è¿™éƒ¨åˆ†æ–‡ä»¶å¤´ä¸­æœ‰å‡ ä¸ªé‡è¦å­—æ®µï¼š&lt;code>NumberOfSections&lt;/code>ï¼ŒPEæ–‡ä»¶ä¸­èŠ‚çš„æ•°é‡ï¼›ä»¥åŠ &lt;code>Characteristics&lt;/code>ï¼Œ16æ¯”ç‰¹æ ‡å¿—ä½å­—æ®µï¼Œæ ‡è¯†PEæ–‡ä»¶çš„ä¸€äº›åŸºæœ¬å±æ€§ã€‚&lt;a class="link" href="https://docs.microsoft.com/en-us/windows/win32/debug/pe-format#characteristics" target="_blank" rel="noopener"
>å¯ç”¨çš„å±æ€§æ¸…å•é“¾æ¥&lt;/a>ã€‚&lt;/p>
&lt;h3 id="15-å¯é€‰æ–‡ä»¶å¤´">1.5 å¯é€‰æ–‡ä»¶å¤´&lt;/h3>
&lt;p>è™½ç„¶å«å¯é€‰æ–‡ä»¶å¤´ï¼ˆOptional Headerï¼‰ï¼Œä½†å¹¶ä¸å¯é€‰ã€‚å¯ä»¥ç…§ä¾‹è¾“å‡ºçœ‹çœ‹ã€‚&lt;/p>
&lt;pre>&lt;code>In [5]: print(pe.OPTIONAL_HEADER)
[IMAGE_OPTIONAL_HEADER]
0x120 0x0 Magic: 0x10B
0x122 0x2 MajorLinkerVersion: 0xE
0x123 0x3 MinorLinkerVersion: 0x1D
0x124 0x4 SizeOfCode: 0x6800
0x128 0x8 SizeOfInitializedData: 0xD000
0x12C 0xC SizeOfUninitializedData: 0x0
0x130 0x10 AddressOfEntryPoint: 0x1005
0x134 0x14 BaseOfCode: 0x1000
0x138 0x18 BaseOfData: 0x8000
0x13C 0x1C ImageBase: 0x400000
0x140 0x20 SectionAlignment: 0x1000
0x144 0x24 FileAlignment: 0x200
0x148 0x28 MajorOperatingSystemVersion: 0x6
0x14A 0x2A MinorOperatingSystemVersion: 0x0
0x14C 0x2C MajorImageVersion: 0x0
0x14E 0x2E MinorImageVersion: 0x0
0x150 0x30 MajorSubsystemVersion: 0x6
0x152 0x32 MinorSubsystemVersion: 0x0
0x154 0x34 Reserved1: 0x0
0x158 0x38 SizeOfImage: 0x19000
0x15C 0x3C SizeOfHeaders: 0x400
0x160 0x40 CheckSum: 0x0
0x164 0x44 Subsystem: 0x2
0x166 0x46 DllCharacteristics: 0x8140
0x168 0x48 SizeOfStackReserve: 0x100000
0x16C 0x4C SizeOfStackCommit: 0x1000
0x170 0x50 SizeOfHeapReserve: 0x100000
0x174 0x54 SizeOfHeapCommit: 0x1000
0x178 0x58 LoaderFlags: 0x0
0x17C 0x5C NumberOfRvaAndSizes: 0x10
&lt;/code>&lt;/pre>&lt;p>å…¶ä¸­å¤§éƒ¨åˆ†å­—æ®µè¦ä¸ç„¶æ˜¯æ²¡ç”¨åˆ°ï¼Œè¦ä¸ç„¶å°±æ˜¯å›ºå®šå€¼ä¸å˜ã€‚å‡ ä¸ªå€¼å¾—å…³æ³¨çš„å­—æ®µå¦‚ä¸‹ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;code>Magic&lt;/code>ï¼ŒåŒºåˆ† PE32/PE64 æ ¼å¼ã€‚å¾®è½¯æ–‡æ¡£ç»™å‡ºçš„æ˜¯ &lt;code>0x10b&lt;/code> å¯¹åº” &lt;code>PE32&lt;/code>ï¼Œ&lt;code>0x20b&lt;/code> å¯¹åº” &lt;code>PE32+&lt;/code>ã€‚&lt;/li>
&lt;li>&lt;code>AddressOfEntryPoint&lt;/code>ï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶åŠ è½½åè¦æ‰§è¡Œçš„ç¬¬ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œç¨‹åºçš„å…¥å£ç‚¹ï¼Œ&lt;strong>æ³¨æ„æ˜¯RVA&lt;/strong>ã€‚&lt;/li>
&lt;li>&lt;code>ImageBase&lt;/code>ï¼Œåå¥½çš„é•œåƒåŸºå€ã€‚RVAå’Œè¿™ä¸ªåŸºå€ç›¸åŠ å¾—åˆ°VAã€‚æ³¨æ„å› ä¸ºASLRçš„å­˜åœ¨ï¼ŒçœŸå®åŸºå€åœ¨è¿è¡Œå‰å¹¶ä¸ç¡®å®šã€‚&lt;/li>
&lt;li>&lt;code>SizeOfImage&lt;/code>ï¼Œé•œåƒçš„ &lt;em>è™šæ‹Ÿå¤§å°&lt;/em> ï¼Œæ˜¯åŠ è½½å¯æ‰§è¡Œæ–‡ä»¶åˆ°å†…å­˜æ—¶éœ€è¦ç”³è¯·çš„å†…å­˜å¤§å°ã€‚&lt;/li>
&lt;li>&lt;code>SizeOfHeaders&lt;/code>ï¼Œæ‰€æœ‰æ–‡ä»¶å¤´ï¼ˆDOSã€NTã€COFFã€Optional &amp;hellip;ï¼‰çš„æ€»å¤§å°ã€‚&lt;/li>
&lt;li>&lt;code>DLLCharacteristics&lt;/code>ï¼Œå„ç§æ ‡å¿—ä½ï¼Œæœ€æœ‰ç”¨çš„æ˜¯&lt;code>IMAGE_DLLCHARACTERISTICS_DYNAMIC_BASE&lt;/code> ï¼ŒæŒ‡å®šé•œåƒåŸºå€æ˜¯å¦å¯ç§»åŠ¨ï¼ˆä¹Ÿå°±æ˜¯èƒ½ä¸èƒ½å¼€å¯ASLR åŸºå€éšæœºåŒ–ï¼‰ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="0x02-åŠ è½½pe">0x02 åŠ è½½PE&lt;/h2>
&lt;p>å¯¹PEæ ¼å¼æœ‰äº†åŸºæœ¬äº†è§£åï¼Œå°±å¯ä»¥å¼€å§‹å°è¯•åŠ è½½ PE æ–‡ä»¶åˆ°å†…å­˜é‡Œäº†ã€‚&lt;/p>
&lt;h3 id="21-åŠ è½½å’Œå†…å­˜åˆå§‹åŒ–">2.1 åŠ è½½å’Œå†…å­˜åˆå§‹åŒ–&lt;/h3>
&lt;p>PEæ–‡ä»¶å¤´æ€»æ˜¯åŠ è½½åˆ°é•œåƒåŸºå€å¤„ã€‚å…ˆå†™ä¸€ä¸ªç®€å•çš„Cç¨‹åºï¼ŒæŠŠ PE æ–‡ä»¶è¯»å–ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdio.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdlib.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;Windows.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;winnt.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">argc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[])&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">argc&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;missing path argument&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">FILE&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">exe_file&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fopen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="s">&amp;#34;rb&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">exe_file&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;error opening file&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Get file size : put pointer at the end
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">fseek&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">exe_file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0L&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">SEEK_END&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// and read its position
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">long&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">file_size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ftell&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">exe_file&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// put the pointer back at the beginning
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">fseek&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">exe_file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0L&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">SEEK_SET&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// allocate memory and read the whole file
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">exe_file_data&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">malloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file_size&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// read whole file
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">size_t&lt;/span> &lt;span class="n">n_read&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fread&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">exe_file_data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">file_size&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">exe_file&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">n_read&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">file_size&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;reading error (%d)&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">n_read&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// load the PE in memory
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[+] Loading PE file&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…ˆå†™è¿™ä¹ˆå¤šï¼Œå†…å®¹åªæœ‰ç®€å•åœ°æ–‡ä»¶IOï¼Œè¯»å–PEæ–‡ä»¶åˆ°å†…å­˜ï¼Œæ¥ä¸‹æ¥å†™ä¸€ä¸ª &lt;code>void* load_PE(char* PE_data)&lt;/code> å‡½æ•°ï¼ŒåŠ è½½PEæ–‡ä»¶å†…å®¹åˆ°å†…å­˜ç©ºé—´ï¼Œè¿”å›åŠ è½½åçš„é•œåƒåŸºå€ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nf">load_PE&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">PE_data&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">IMAGE_DOS_HEADER&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_DOS_header&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_DOS_HEADER&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">PE_data&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">IMAGE_NT_HEADERS&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_NT_headers&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_NT_HEADERS&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">PE_data&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">p_DOS_header&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">e_lfanew&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// extract information from PE header
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">DWORD&lt;/span> &lt;span class="n">size_of_image&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">SizeOfImage&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">DWORD&lt;/span> &lt;span class="n">entry_point_RVA&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">AddressOfEntryPoint&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">DWORD&lt;/span> &lt;span class="n">size_of_headers&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">SizeOfHeaders&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// allocate memory
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">VirtualAlloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">size_of_image&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MEM_RESERVE&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">MEM_COMMIT&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PAGE_READWRITE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// copy PE headers in memory
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">memcpy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">p_image_base&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PE_data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">size_of_headers&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// Section headers starts right after the IMAGE_NT_HEADERS struct, so we do some pointer arithmetic-fu here.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">IMAGE_SECTION_HEADER&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">sections&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_SECTION_HEADER&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_NT_headers&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">FileHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">NumberOfSections&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// calculate the VA we need to copy the content, from the RVA
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// section[i].VirtualAddress is a RVA, mind it
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">dest&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">VirtualAddress&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// check if there is Raw data to copy
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">SizeOfRawData&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// We copy SizeOfRaw data bytes, from the offset PointerToRawData in the file
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">memcpy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PE_data&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">PointerToRawData&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">SizeOfRawData&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">memset&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">Misc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">VirtualSize&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">p_image_base&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å‰å‡ å¥èµ‹å€¼éƒ½æ˜¯åœ¨ç”¨æŒ‡é’ˆè¿ç®—å–PEæ–‡ä»¶å¤´é‡Œçš„å­—æ®µã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c"> &lt;span class="n">IMAGE_DOS_HEADER&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_DOS_header&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_DOS_HEADER&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">PE_data&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">IMAGE_NT_HEADERS&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_NT_headers&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_NT_HEADERS&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">PE_data&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">p_DOS_header&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">e_lfanew&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// extract information from PE header
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">DWORD&lt;/span> &lt;span class="n">size_of_image&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">SizeOfImage&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">DWORD&lt;/span> &lt;span class="n">entry_point_RVA&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">AddressOfEntryPoint&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">DWORD&lt;/span> &lt;span class="n">size_of_headers&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">SizeOfHeaders&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…ˆæå–äº† DOS æ–‡ä»¶å¤´å’Œ NT æ–‡ä»¶å¤´ï¼ˆæ³¨æ„ï¼Œ File Header å’Œ Optional Header éƒ½åµŒåœ¨ NT æ–‡ä»¶å¤´ç»“æ„é‡Œï¼Œè¿™å°±æ˜¯ä¸ºå•¥æˆ‘è¯´ç»“æ„å®šä¹‰ä¼šå’Œä¸Šé¢çš„ wiki å›¾ä¸å¤§ä¸€æ ·ï¼‰ã€‚æ¥ç€ä»æ–‡ä»¶å¤´ç»“æ„é‡Œå–é•œåƒå¤§å°ã€å…¥å£ç‚¹RVAã€æ–‡ä»¶å¤´æ€»å¤§å°ï¼Œç”¨äºåç»­åˆ†é…å†…å­˜å’ŒæŒ‡é’ˆè¿ç®—ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c"> &lt;span class="c1">// allocate memory
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">VirtualAlloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">size_of_image&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MEM_RESERVE&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">MEM_COMMIT&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PAGE_READWRITE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç´§æ¥ç€ç”¨ Win32 API åˆ†é…äº†ä¸€ç‰‡å†…å­˜ç©ºé—´ï¼Œå¤§å°ç”± PE æ–‡ä»¶å¤´çš„é•œåƒå¤§å°æŒ‡å®šã€‚ç”¨è¿™ä¸ªAPIçš„åŸå› æ˜¯ä¹‹åæˆ‘ä»¬éœ€è¦è®¾ç½®è¿™ç‰‡å†…å­˜ä¸ºå¯æ‰§è¡Œã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c"> &lt;span class="c1">// copy PE headers in memory
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">memcpy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">p_image_base&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PE_data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">size_of_headers&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>PEæ–‡ä»¶å¤´æ€»æ˜¯åœ¨é•œåƒåŸºå€å¼€å§‹çš„ä½ç½®ï¼Œç›´æ¥å¤åˆ¶è¿‡å»ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c"> &lt;span class="c1">// Section headers starts right after the IMAGE_NT_HEADERS struct, so we do some pointer arithmetic-fu here.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">IMAGE_SECTION_HEADER&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">sections&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_SECTION_HEADER&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_NT_headers&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å–å·§çš„æ–¹å¼è·å¾—èŠ‚è¡¨æŒ‡é’ˆã€‚è¿™æ˜¯ä¸ªç®€å•çš„cæŒ‡é’ˆè¿ç®—ï¼Œ&lt;code>p_NT_headers+1&lt;/code>å…¶å®å°±æ˜¯&lt;code>(char*)p_NT_headers + sizeof(IMAGE_NT_HEADERS)&lt;/code>ï¼Œä¹Ÿå°±æ˜¯NT_HEADERS ç»“æ„ç´§é‚»çš„ä¸‹ä¸€ä¸ªå­—èŠ‚ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">FileHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">NumberOfSections&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// calculate the VA we need to copy the content, from the RVA
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// section[i].VirtualAddress is a RVA, mind it
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">dest&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">VirtualAddress&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// check if there is Raw data to copy
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">SizeOfRawData&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// We copy SizeOfRaw data bytes, from the offset PointerToRawData in the file
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">memcpy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PE_data&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">PointerToRawData&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">SizeOfRawData&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">memset&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">Misc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">VirtualSize&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¥ç€å°±æ˜¯éå†èŠ‚è¡¨ï¼Œå–èŠ‚çš„åŸºåœ°å€ï¼ŒPEæ–‡ä»¶ä¸­èŠ‚åŒ…å«æ•°æ®çš„è¯ï¼Œå°±å¤åˆ¶èŠ‚æ•°æ®åˆ°å†…å­˜ï¼Œå¦åˆ™æŠŠèŠ‚åˆå§‹åŒ–ä¸º0ã€‚&lt;/p>
&lt;p>æ¥ç€è¡¥å……å¯æ‰§è¡Œæƒé™ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c"> &lt;span class="c1">// Set permission for the PE hader to read only
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">DWORD&lt;/span> &lt;span class="n">oldProtect&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">VirtualProtect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">p_image_base&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">SizeOfHeaders&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PAGE_READONLY&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">oldProtect&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">FileHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">NumberOfSections&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">dest&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">VirtualAddress&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">DWORD&lt;/span> &lt;span class="n">s_perm&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">Characteristics&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">DWORD&lt;/span> &lt;span class="n">v_perm&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// flags are not the same between virtal protect and the section header
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">s_perm&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">IMAGE_SCN_MEM_EXECUTE&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">v_perm&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">s_perm&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">IMAGE_SCN_MEM_WRITE&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="nl">PAGE_EXECUTE_READWRITE&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">PAGE_EXECUTE_READ&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">v_perm&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">s_perm&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">IMAGE_SCN_MEM_WRITE&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="nl">PAGE_READWRITE&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">PAGE_READONLY&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">VirtualProtect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">Misc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">VirtualSize&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">v_perm&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">oldProtect&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…ˆæŠŠæ•´ä¸ªPEå¤´è®¾ç½®ä¸ºåªè¯»ï¼Œç„¶åéå†èŠ‚è¡¨ï¼Œå–èŠ‚åŸºåœ°å€å’Œæ ‡å¿—ä½ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">s_perm&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">IMAGE_SCN_MEM_EXECUTE&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">v_perm&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">s_perm&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">IMAGE_SCN_MEM_WRITE&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="nl">PAGE_EXECUTE_READWRITE&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">PAGE_EXECUTE_READ&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ ¹æ®PEå¤´ä¸­èŠ‚çš„å¯å†™ã€å¯æ‰§è¡Œæ ‡å¿—ä½ï¼Œè®¾ç½®å†…å­˜ç©ºé—´ä¿æŠ¤æ–¹å¼ã€‚&lt;/p>
&lt;p>æœ€åè¿”å›å…¥å£ç‚¹åœ°å€ï¼Œåœ¨ main å‡½æ•°é‡Œè·³è½¬ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c"> &lt;span class="k">return&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">entry_point_RVA&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å®Œæ•´ä»£ç å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdio.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdlib.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;Windows.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;winnt.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">argc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[])&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">argc&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;missing path argument&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">FILE&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">exe_file&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fopen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="s">&amp;#34;rb&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">exe_file&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;error opening file&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Get file size : put pointer at the end
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">fseek&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">exe_file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0L&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">SEEK_END&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// and read its position
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">long&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">file_size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ftell&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">exe_file&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// put the pointer back at the beginning
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">fseek&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">exe_file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0L&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">SEEK_SET&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// allocate memory and read the whole file
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">exe_file_data&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">malloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file_size&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// read whole file
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">size_t&lt;/span> &lt;span class="n">n_read&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fread&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">exe_file_data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">file_size&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">exe_file&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">n_read&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">file_size&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;reading error (%d)&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">n_read&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// load the PE in memory
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[+] Loading PE file&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nf">load_PE&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">PE_data&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">IMAGE_DOS_HEADER&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_DOS_header&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_DOS_HEADER&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">PE_data&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">IMAGE_NT_HEADERS&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_NT_headers&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_NT_HEADERS&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">PE_data&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">p_DOS_header&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">e_lfanew&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// extract information from PE header
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">DWORD&lt;/span> &lt;span class="n">size_of_image&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">SizeOfImage&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">DWORD&lt;/span> &lt;span class="n">entry_point_RVA&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">AddressOfEntryPoint&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">DWORD&lt;/span> &lt;span class="n">size_of_headers&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">SizeOfHeaders&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// allocate memory
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">VirtualAlloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">size_of_image&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MEM_RESERVE&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">MEM_COMMIT&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PAGE_READWRITE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// copy PE headers in memory
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">memcpy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">p_image_base&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PE_data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">size_of_headers&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// Section headers starts right after the IMAGE_NT_HEADERS struct, so we do some pointer arithmetic-fu here.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">IMAGE_SECTION_HEADER&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">sections&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_SECTION_HEADER&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_NT_headers&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">FileHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">NumberOfSections&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// calculate the VA we need to copy the content, from the RVA
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// section[i].VirtualAddress is a RVA, mind it
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">dest&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">VirtualAddress&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// check if there is Raw data to copy
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">SizeOfRawData&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// We copy SizeOfRaw data bytes, from the offset PointerToRawData in the file
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">memcpy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PE_data&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">PointerToRawData&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">SizeOfRawData&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">memset&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">Misc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">VirtualSize&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Set permission for the PE hader to read only
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">DWORD&lt;/span> &lt;span class="n">oldProtect&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">VirtualProtect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">p_image_base&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">SizeOfHeaders&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PAGE_READONLY&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">oldProtect&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">FileHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">NumberOfSections&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">dest&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">VirtualAddress&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">DWORD&lt;/span> &lt;span class="n">s_perm&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">Characteristics&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">DWORD&lt;/span> &lt;span class="n">v_perm&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// flags are not the same between virtal protect and the section header
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">s_perm&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">IMAGE_SCN_MEM_EXECUTE&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">v_perm&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">s_perm&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">IMAGE_SCN_MEM_WRITE&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="nl">PAGE_EXECUTE_READWRITE&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">PAGE_EXECUTE_READ&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">v_perm&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">s_perm&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">IMAGE_SCN_MEM_WRITE&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="nl">PAGE_READWRITE&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">PAGE_READONLY&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">VirtualProtect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">Misc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">VirtualSize&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">v_perm&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">oldProtect&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">entry_point_RVA&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ°æ­¤ï¼Œçœ‹èµ·æ¥è¿™ä¸ªåŠ è½½å…¶ä»–ç¨‹åºè¿è¡Œçš„ç¨‹åºå¯ä»¥è¿è¡Œäº†ï¼Œä½†å…¶å®è¿˜ä¸è¡Œã€‚å…¶ä¸»è¦åŸå› ä¹‹ä¸€å°±æ˜¯ç¼ºä¹å¿…è¦çš„å¯¼å…¥ä¿¡æ¯ã€‚ä¸‹æ–‡è¯¦è¿°ã€‚&lt;/p>
&lt;h2 id="0x03-å¯¼å…¥è¡¨">0x03 å¯¼å…¥è¡¨&lt;/h2>
&lt;h3 id="31-å¯¼å…¥è¡¨ä»‹ç»">3.1 å¯¼å…¥è¡¨ä»‹ç»&lt;/h3>
&lt;p>åœ¨Windowsä¸Šï¼Œæ¯ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆ.exeï¼‰éƒ½éœ€è¦ä¸€äº›å¤–éƒ¨å‡½æ•°æ¥æ”¯æŒå…¶æ­£å¸¸è¿ä½œã€‚è¿™äº›å¤–éƒ¨å‡½æ•°é€šå¸¸åœ¨æˆ‘ä»¬ç†Ÿæ‚‰çš„&lt;code>.dll&lt;/code>æ–‡ä»¶é‡Œã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œ&lt;code>calc.exe&lt;/code>ï¼ˆè®¡ç®—å™¨ç¨‹åºï¼‰éœ€è¦å¤–éƒ¨å‡½æ•°æ¥æ”¯æŒæ‰“å¼€çª—å£ã€æ˜¾ç¤ºæŒ‰é’®ç­‰ã€‚&lt;/p>
&lt;p>ä»¥&lt;code>ShellExecuteW&lt;/code>ä¸ºä¾‹ï¼ˆåœ¨&lt;code>calc.exe&lt;/code>è®¡ç®—å™¨ä¸­è¢«å¯¼å…¥ï¼‰ï¼Œ&lt;code>calc.exe&lt;/code>éœ€è¦è¿™ä¸ªå‡½æ•°æ¥æ”¯æŒå®ƒæ­£å¸¸å·¥ä½œï¼ˆå½“ç„¶ï¼Œ&lt;code>calc.exe&lt;/code>éœ€è¦ä¸æ­¢è¿™ä¸€ä¸ªå¤–éƒ¨å‡½æ•°ï¼‰ï¼Œæ‰€ä»¥&lt;code>calc.exe&lt;/code>éœ€è¦çŸ¥é“&lt;code>ShellExecuteW&lt;/code>è¿™ä¸ªå‡½æ•°çš„ä»£ç ï¼ˆæœºå™¨ç ï¼‰åœ¨å“ªå„¿ã€‚&lt;/p>
&lt;p>ä½†äº‹å®ä¸Šï¼Œ&lt;code>.dll&lt;/code> åªä¼šåœ¨è¿è¡Œæ—¶è¢«åŠ è½½ï¼Œè€Œä¸”åŠ è½½ååœ¨å†…å­˜ä¸­çš„ä½ç½®å¹¶ä¸ç¡®å®šã€‚è¿™æ„å‘³ç€ç¼–è¯‘å™¨ç¼–è¯‘æ—¶æ— ä»å¾—çŸ¥&lt;code>ShellExecuteW&lt;/code>çš„åœ°å€ï¼ˆå¼€å¯ASLRçš„è¯å°±æ›´ä¸å¯èƒ½äº†ï¼‰ï¼Œä¹Ÿå°±æ— æ³•ç»™è°ƒç”¨è¯¥å‡½æ•°çš„&lt;code>call&lt;/code>æŒ‡ä»¤æä¾›æ­£ç¡®çš„ç«‹å³æ•°åœ°å€ã€‚&lt;/p>
&lt;p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆç¼–è¯‘å™¨è¦åˆ›å»ºå¯¼å…¥è¡¨ï¼Œå› ä¸ºå®ƒæœŸæœ›ä¸€æ—¦åŠ¨æ€é“¾æ¥åº“åŠ è½½å®Œæˆï¼Œå®ƒå°±å¯ä»¥æŸ¥æ‰¾åˆ°&lt;code>ShellExecuteW&lt;/code>çš„åœ°å€ï¼Œå¹¶åœ¨éœ€è¦çš„æ—¶å€™è°ƒç”¨ã€‚&lt;/p>
&lt;p>åœ¨è°ƒè¯•å™¨é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™æ ·çš„æ±‡ç¼–æŒ‡ä»¤ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 434;
flex-basis: 1042px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/learning-packer-01/call_IAT.jpg" data-size="543x125">
&lt;img src="https://nnnewb.github.io/blog/blog/p/learning-packer-01/call_IAT.jpg"
width="543"
height="125"
srcset="https://nnnewb.github.io/blog/blog/p/learning-packer-01/call_IAT_hu889b99c9eb0c20be37b0dc63e7aa4f3e_34329_480x0_resize_q75_box.jpg 480w, https://nnnewb.github.io/blog/blog/p/learning-packer-01/call_IAT_hu889b99c9eb0c20be37b0dc63e7aa4f3e_34329_1024x0_resize_q75_box.jpg 1024w"
loading="lazy"
alt="import address table">
&lt;/a>
&lt;figcaption>import address table&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>ç¬¬ä¸€æ¡&lt;code>call&lt;/code>æŒ‡ä»¤æ˜¯å†…éƒ¨è°ƒç”¨ï¼Œè°ƒç”¨å¯¹è±¡æ˜¯åŒä¸€ä¸ªæ¨¡å—å†…çš„å‡½æ•°ã€‚ç¼–è¯‘å™¨çŸ¥é“è¢«è°ƒç”¨å‡½æ•°çš„åœ°å€ï¼Œå¹¶ä½¿ç”¨&lt;code>E8&lt;/code> opcode ã€‚è¿™è¡¨ç¤º &lt;em>relative call&lt;/em> ã€‚å½“è°ƒç”¨å¤–éƒ¨æ¨¡å—æ—¶ï¼Œå®ƒè°ƒç”¨äº†ä»IATè¯»å–çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯å›¾ä¸­&lt;code>ds:[&amp;lt;&amp;amp;ShellExecuteW&amp;gt;]&lt;/code>ã€‚&lt;/p>
&lt;p>x86 çš„ call åˆ† 4 ç±»ã€‚&lt;/p>
&lt;ul>
&lt;li>Near, relative (opcode E8) (&lt;code>call func&lt;/code>)&lt;/li>
&lt;li>Far, absolute (opcode 9A) (&lt;code>call 0x12:0x12345678&lt;/code>)&lt;/li>
&lt;li>Near, absolute, indirect (opcode FF /2) (&lt;code>call [edi]&lt;/code>)&lt;/li>
&lt;li>Far, absolute, indirect (opcode FF /3) (&lt;code>call far [edi]&lt;/code>)&lt;/li>
&lt;/ul>
&lt;p>å…·ä½“é—®æœç´¢å¼•æ“ã€‚&lt;/p>
&lt;p>è¡¥å……ï¼Œå‡½æ•°å¯ä»¥é€šè¿‡åå­—ï¼ˆASCIIç¼–ç çš„Cå­—ç¬¦ä¸²ï¼‰æˆ–DLLå¯¼å‡ºè¡¨ä¸­çš„åºå· &lt;em>ordinal&lt;/em> å¯¼å…¥ã€‚&lt;/p>
&lt;h3 id="32-data-directory-å’Œ-idt">3.2 Data Directory å’Œ IDT&lt;/h3>
&lt;p>è¯´äº†è¿™ä¹ˆå¤šIATï¼Œé‚£ä¹ˆIATåˆ°åº•åœ¨å“ªå„¿ï¼Ÿä»¥ä»€ä¹ˆå½¢å¼ä¿å­˜ï¼Ÿè¿˜æ˜¯ç”¨&lt;code>pefile&lt;/code>ï¼Œå…ˆçœ‹çœ‹ PE æ–‡ä»¶å¤´ä¸­çš„ &lt;code>OPTIONAL_HEADER .DATA_DIRECTORY&lt;/code>ã€‚&lt;/p>
&lt;pre>&lt;code>In [10]: pe.OPTIONAL_HEADER.DATA_DIRECTORY
Out[10]:
[&amp;lt;Structure: [IMAGE_DIRECTORY_ENTRY_EXPORT] 0x180 0x0 VirtualAddress: 0x0 0x184 0x4 Size: 0x0&amp;gt;,
&amp;lt;Structure: [IMAGE_DIRECTORY_ENTRY_IMPORT] 0x188 0x0 VirtualAddress: 0xDAA0 0x18C 0x4 Size: 0xC8&amp;gt;,
&amp;lt;Structure: [IMAGE_DIRECTORY_ENTRY_RESOURCE] 0x190 0x0 VirtualAddress: 0x16000 0x194 0x4 Size: 0x5D0&amp;gt;,
&amp;lt;Structure: [IMAGE_DIRECTORY_ENTRY_EXCEPTION] 0x198 0x0 VirtualAddress: 0x0 0x19C 0x4 Size: 0x0&amp;gt;,
&amp;lt;Structure: [IMAGE_DIRECTORY_ENTRY_SECURITY] 0x1A0 0x0 VirtualAddress: 0x0 0x1A4 0x4 Size: 0x0&amp;gt;,
&amp;lt;Structure: [IMAGE_DIRECTORY_ENTRY_BASERELOC] 0x1A8 0x0 VirtualAddress: 0x17000 0x1AC 0x4 Size: 0xE0C&amp;gt;,
&amp;lt;Structure: [IMAGE_DIRECTORY_ENTRY_DEBUG] 0x1B0 0x0 VirtualAddress: 0x98E0 0x1B4 0x4 Size: 0x38&amp;gt;,
&amp;lt;Structure: [IMAGE_DIRECTORY_ENTRY_COPYRIGHT] 0x1B8 0x0 VirtualAddress: 0x0 0x1BC 0x4 Size: 0x0&amp;gt;,
&amp;lt;Structure: [IMAGE_DIRECTORY_ENTRY_GLOBALPTR] 0x1C0 0x0 VirtualAddress: 0x0 0x1C4 0x4 Size: 0x0&amp;gt;,
&amp;lt;Structure: [IMAGE_DIRECTORY_ENTRY_TLS] 0x1C8 0x0 VirtualAddress: 0x0 0x1CC 0x4 Size: 0x0&amp;gt;,
&amp;lt;Structure: [IMAGE_DIRECTORY_ENTRY_LOAD_CONFIG] 0x1D0 0x0 VirtualAddress: 0x9918 0x1D4 0x4 Size: 0x40&amp;gt;,
&amp;lt;Structure: [IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT] 0x1D8 0x0 VirtualAddress: 0x0 0x1DC 0x4 Size: 0x0&amp;gt;,
&amp;lt;Structure: [IMAGE_DIRECTORY_ENTRY_IAT] 0x1E0 0x0 VirtualAddress: 0xD000 0x1E4 0x4 Size: 0xAA0&amp;gt;,
&amp;lt;Structure: [IMAGE_DIRECTORY_ENTRY_DELAY_IMPORT] 0x1E8 0x0 VirtualAddress: 0x0 0x1EC 0x4 Size: 0x0&amp;gt;,
&amp;lt;Structure: [IMAGE_DIRECTORY_ENTRY_COM_DESCRIPTOR] 0x1F0 0x0 VirtualAddress: 0x0 0x1F4 0x4 Size: 0x0&amp;gt;,
&amp;lt;Structure: [IMAGE_DIRECTORY_ENTRY_RESERVED] 0x1F8 0x0 VirtualAddress: 0x0 0x1FC 0x4 Size: 0x0&amp;gt;]
&lt;/code>&lt;/pre>&lt;p>&lt;code>Data directory&lt;/code> å®é™…å°±æ˜¯15ä¸ªç»“æ„ç»„æˆçš„æ•°ç»„ï¼ˆå¿½ç•¥æœ€åä¸€ä¸ªreservedï¼‰ï¼Œæ¯ä¸ªç»“æ„åŒ…å«å¯¹åº”çš„RVAåœ°å€å’Œå¤§å°ï¼ˆRVAå’Œå¤§å°çš„å…·ä½“å«ä¹‰ä¹‹åè®¨è®ºï¼‰ã€‚è¿™ä¸ªç»“æ„é‡Œæˆ‘ä»¬å…³æ³¨çš„æœ‰&lt;code>IMAGE_DIRECTORY_ENTRY_IMPORT&lt;/code>å’Œ&lt;code>IMAGE_DIRECTORY_ENTRY_IAT&lt;/code>ï¼Œåˆ†åˆ«æŒ‡å‘çš„æ˜¯ &lt;em>Import Directory Table&lt;/em> ï¼Œ&lt;em>IDT&lt;/em> ï¼Œå’Œ &lt;em>Import Address Table&lt;/em> ï¼Œ &lt;em>IAT&lt;/em> ã€‚&lt;/p>
&lt;p>åŸºæœ¬æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥è¿™ä¹ˆè¯´ï¼Œ &lt;em>IDT&lt;/em> æŒ‡ç¤ºéœ€è¦å¯¼å…¥å“ªäº›å‡½æ•°ï¼Œè¿™äº›å‡½æ•°å¯¼å…¥åï¼Œåœ°å€å­˜å…¥ &lt;em>IAT&lt;/em> ã€‚ &lt;em>IDT&lt;/em> æ˜¯æˆ‘ä»¬è¦å¯¼å…¥ä»€ä¹ˆï¼Œ &lt;em>IAT&lt;/em> æ˜¯æˆ‘ä»¬å¯¼å…¥åæŠŠåœ°å€æ”¾åœ¨å“ªå„¿ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 64;
flex-basis: 154px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/learning-packer-01/IDT-IAT.drawio.png" data-size="650x1012">
&lt;img src="https://nnnewb.github.io/blog/blog/p/learning-packer-01/IDT-IAT.drawio.png"
width="650"
height="1012"
srcset="https://nnnewb.github.io/blog/blog/p/learning-packer-01/IDT-IAT.drawio_hu519af53fd6ddb5dd0f68ecccb2a04fc7_77938_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/learning-packer-01/IDT-IAT.drawio_hu519af53fd6ddb5dd0f68ecccb2a04fc7_77938_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="IDT-IAT">
&lt;/a>
&lt;figcaption>IDT-IAT&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>&lt;em>Import Directory&lt;/em> æŒ‡å‘çš„æ˜¯ä¸€ä¸ª &lt;code>NULL&lt;/code> ç»“å°¾çš„&lt;code>IMAGE_IMPORT_DESCRIPTOR&lt;/code>ç»“æ„æ•°ç»„ã€‚ä¹‹ååœ¨ä»£ç é‡Œä¼šç”¨åˆ°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="k">typedef&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">_IMAGE_IMPORT_DESCRIPTOR&lt;/span>
&lt;span class="p">{&lt;/span> &lt;span class="n">_ANONYMOUS_UNION&lt;/span> &lt;span class="k">union&lt;/span>
&lt;span class="p">{&lt;/span> &lt;span class="n">DWORD&lt;/span> &lt;span class="n">Characteristics&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">DWORD&lt;/span> &lt;span class="n">OriginalFirstThunk&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// pointer to dword[]
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="n">DUMMYUNIONNAME&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">DWORD&lt;/span> &lt;span class="n">TimeDateStamp&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">DWORD&lt;/span> &lt;span class="n">ForwarderChain&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">DWORD&lt;/span> &lt;span class="n">Name&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// pointer to dll name
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">DWORD&lt;/span> &lt;span class="n">FirstThunk&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// pointer to dword[]
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="n">IMAGE_IMPORT_DESCRIPTOR&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">PIMAGE_IMPORT_DESCRIPTOR&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>OriginalFirstThunk&lt;/code> å’Œ &lt;code>FirstThunk&lt;/code> éƒ½æ˜¯æŒ‡å‘ä¸€ä¸ª NULL ç»“å°¾çš„ DWORD æ•°ç»„ã€‚&lt;code>OriginalFirstThunk&lt;/code> æ˜¯æŒ‡å‘ &lt;em>IDT&lt;/em> &lt;code>DWORD&lt;/code> æ•°ç»„çš„ RVA æŒ‡é’ˆã€‚&lt;/p>
&lt;p>å…¶ä¸­æ•°ç»„å…ƒç´ ï¼š&lt;/p>
&lt;ul>
&lt;li>å¦‚æœé¦–æ¯”ç‰¹æ˜¯1ï¼Œåˆ™è¿™ä¸ªDWORDæ˜¯ &lt;em>ordinal&lt;/em> ï¼Œå‡½æ•°çš„å¯¼å‡ºè¡¨åºå·ã€‚&lt;/li>
&lt;li>å¦åˆ™æ˜¯æŒ‡å‘ &lt;code>IMAGE_IMPORT_BY_NAME&lt;/code> ç»“æ„çš„ RVA åœ°å€ã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;code>FirstThunk&lt;/code>æŒ‡å‘çš„æ˜¯ &lt;em>IAT&lt;/em> ï¼Œå’Œ &lt;em>IDT&lt;/em> ç»“æ„ç›¸åŒï¼Œå½“æˆ‘ä»¬å¾—åˆ°å¯¼å…¥å‡½æ•°çš„åœ°å€åï¼Œéœ€è¦æŠŠåœ°å€æ”¾è¿› &lt;em>IDT&lt;/em> å¯¹åº”çš„ &lt;em>IAT&lt;/em> ä¸­ã€‚&lt;/p>
&lt;h3 id="33--å¡«å……å¯¼å…¥è¡¨">3.3 å¡«å……å¯¼å…¥è¡¨&lt;/h3>
&lt;p>ä¸‹é¢å®é™…ç¼–å†™ä¸€ä¸‹å¡«å…… &lt;em>IAT&lt;/em> çš„ä»£ç ã€‚è¦æ³¨æ„å¡«å…… IAT çš„ä»£ç å¿…é¡»åœ¨åŠ è½½ PE å¤´å’Œ Sections ä¹‹åï¼Œæ—©äºè®¾ç½®å†…å­˜ä¿æŠ¤æ‰§è¡Œã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c"> &lt;span class="n">IMAGE_DATA_DIRECTORY&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">data_directory&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">DataDirectory&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// load the address of the import descriptors array
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">IMAGE_IMPORT_DESCRIPTOR&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">import_descriptors&lt;/span> &lt;span class="o">=&lt;/span>
&lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_IMPORT_DESCRIPTOR&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">data_directory&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">IMAGE_DIRECTORY_ENTRY_IMPORT&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">VirtualAddress&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»æ–‡ä»¶å¤´æå–åˆ° Import Directory çš„åœ°å€ï¼ˆRVAï¼‰åï¼Œå’Œé•œåƒåŸºå€ç›¸åŠ ç®—å‡ºå®é™…ç»“æ„åœ°å€ã€‚æ¥ä¸‹æ¥å¼€å§‹éå†è¿™ä¸ªç»“æ„ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c"> &lt;span class="c1">// this array is null terminated
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">import_descriptors&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">OriginalFirstThunk&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ³¨æ„æ­¤å¤„æ‰€è¯´çš„ &lt;em>null terminated&lt;/em> æŒ‡çš„æ˜¯æœ€åä¸€ä¸ªæ•°ç»„å…ƒç´ å¡«å……äº†0ï¼Œæ•…ç”¨ &lt;code>OriginalFirstThunk&lt;/code> åˆ¤æ–­ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">// Get the name of the dll, and import it
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">module_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">import_descriptors&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">Name&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">HMODULE&lt;/span> &lt;span class="n">import_module&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">LoadLibraryA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">module_name&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">import_module&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;import module is null&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">abort&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>import_descriptors[i].Name&lt;/code> ä¾ç„¶æ˜¯ä¸€ä¸ª RVAï¼ŒæŒ‡å‘å¸¸é‡å­—ç¬¦ä¸²ã€‚åœ¨è¿™ä¸€æ­¥ä¹‹å‰å¿…é¡»å…ˆå®Œæˆ section åŠ è½½ï¼Œä¸ç„¶å–ä¸åˆ°å­—ç¬¦ä¸²ã€‚è¿™é‡Œç”¨ &lt;code>LoadLibraryA&lt;/code> åŠ è½½äº† DLL åˆ°å†…å­˜ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">// the lookup table points to function names or ordinals =&amp;gt; it is the IDT
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">IMAGE_THUNK_DATA&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">lookup_table&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_THUNK_DATA&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">import_descriptors&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">OriginalFirstThunk&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¥ç€å– &lt;code>OriginalFirstThunk&lt;/code> è½¬ä¸º &lt;code>IMAGE_THUNK_DATA&lt;/code> æŒ‡é’ˆï¼Œè¿™å°±æ˜¯ &lt;em>IDT&lt;/em> äº†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">// the address table is a copy of the lookup table at first
&lt;/span>&lt;span class="c1">// but we put the addresses of the loaded function inside =&amp;gt; that&amp;#39;s the IAT
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">IMAGE_THUNK_DATA&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">address_table&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_THUNK_DATA&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">import_descriptors&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">FirstThunk&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å†å– &lt;code>FirstThunk&lt;/code> è½¬ä¸º &lt;code>IMAGE_THUNK_DATA&lt;/code> æŒ‡é’ˆï¼Œè¿™æ˜¯ &lt;em>IAT&lt;/em>ï¼Œä¹‹ååŠ è½½çš„å‡½æ•°åœ°å€ä¼šå­˜æ”¾åˆ°è¿™é‡Œã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">// null terminated array, again
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">lookup_table&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">u1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">AddressOfData&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶åéå† &lt;em>IDT&lt;/em> ï¼Œå’Œéå† &lt;code>import_descriptors&lt;/code> æ—¶ä¸€æ ·ï¼Œæ³¨æ„ &lt;code>null terminated&lt;/code> æŒ‡çš„æ˜¯æœ€åä¸€ä¸ªå…ƒç´ ç”¨0å¡«å……ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">function_handle&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// Check the lookup table for the adresse of the function name to import
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">DWORD&lt;/span> &lt;span class="n">lookup_addr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">lookup_table&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">u1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">AddressOfData&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">lookup_addr&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">IMAGE_ORDINAL_FLAG&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// if first bit is not 1
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// import by name : get the IMAGE_IMPORT_BY_NAME struct
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">IMAGE_IMPORT_BY_NAME&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">image_import&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_IMPORT_BY_NAME&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">lookup_addr&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// this struct points to the ASCII function name
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">funct_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">image_import&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">Name&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// get that function address from it&amp;#39;s module and name
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">function_handle&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">GetProcAddress&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">import_module&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">funct_name&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// import by ordinal, directly
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">function_handle&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">GetProcAddress&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">import_module&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">LPSTR&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">lookup_addr&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">function_handle&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;function handle is null&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">abort&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// change the IAT, and put the function address inside.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">address_table&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">u1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Function&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">DWORD&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">function_handle&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯¹æ¯ä¸ª &lt;em>IDT&lt;/em> å…ƒç´ ï¼Œæ ¹æ® &lt;em>IDT&lt;/em> ä¸­ä¿å­˜çš„å…ƒç´ ç¡®å®šåŠ è½½æ–¹å¼ï¼ˆå­—ç¬¦ä¸²æˆ–è€… &lt;em>ordinal&lt;/em>ï¼‰ï¼Œè°ƒç”¨ &lt;code>GetProcAddress&lt;/code> åŠ è½½åçš„åœ°å€å­˜å…¥ &lt;em>IAT&lt;/em> ã€‚&lt;/p>
&lt;p>è‡³æ­¤ï¼Œ&lt;em>IAT&lt;/em> å¡«å……å®Œæˆã€‚&lt;/p>
&lt;p>å®Œæ•´ä»£ç å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="kt">void&lt;/span> &lt;span class="nf">fix_iat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_image_base&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">IMAGE_NT_HEADERS&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_NT_headers&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">IMAGE_DATA_DIRECTORY&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">data_directory&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">DataDirectory&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// load the address of the import descriptors array
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">IMAGE_IMPORT_DESCRIPTOR&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">import_descriptors&lt;/span> &lt;span class="o">=&lt;/span>
&lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_IMPORT_DESCRIPTOR&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">data_directory&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">IMAGE_DIRECTORY_ENTRY_IMPORT&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">VirtualAddress&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// this array is null terminated
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">import_descriptors&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">OriginalFirstThunk&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Get the name of the dll, and import it
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">module_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">import_descriptors&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">Name&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">HMODULE&lt;/span> &lt;span class="n">import_module&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">LoadLibraryA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">module_name&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">import_module&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;import module is null&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">abort&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// the lookup table points to function names or ordinals =&amp;gt; it is the IDT
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">IMAGE_THUNK_DATA&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">lookup_table&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_THUNK_DATA&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">import_descriptors&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">OriginalFirstThunk&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// the address table is a copy of the lookup table at first
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// but we put the addresses of the loaded function inside =&amp;gt; that&amp;#39;s the IAT
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">IMAGE_THUNK_DATA&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">address_table&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_THUNK_DATA&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">import_descriptors&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">FirstThunk&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// null terminated array, again
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">lookup_table&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">u1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">AddressOfData&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">function_handle&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// Check the lookup table for the adresse of the function name to import
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">DWORD&lt;/span> &lt;span class="n">lookup_addr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">lookup_table&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">u1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">AddressOfData&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">lookup_addr&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">IMAGE_ORDINAL_FLAG&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// if first bit is not 1
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// import by name : get the IMAGE_IMPORT_BY_NAME struct
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">IMAGE_IMPORT_BY_NAME&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">image_import&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_IMPORT_BY_NAME&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">lookup_addr&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// this struct points to the ASCII function name
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">funct_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">image_import&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">Name&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// get that function address from it&amp;#39;s module and name
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">function_handle&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">GetProcAddress&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">import_module&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">funct_name&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// import by ordinal, directly
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">function_handle&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">GetProcAddress&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">import_module&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">LPSTR&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">lookup_addr&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">function_handle&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;function handle is null&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">abort&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// change the IAT, and put the function address inside.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">address_table&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">u1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Function&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">DWORD&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">function_handle&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="0x04-é‡å®šä½">0x04 é‡å®šä½&lt;/h2>
&lt;h3 id="41-é‡å®šä½ä»‹ç»">4.1 é‡å®šä½ä»‹ç»&lt;/h3>
&lt;p>å›é¡¾ä¸‹å‰æ–‡æˆ‘ä»¬åšçš„äº‹æƒ…ï¼š&lt;/p>
&lt;ol>
&lt;li>æ‰“å¼€ calc.exe ï¼Œè¯»å–å®ƒçš„æ–‡ä»¶å¤´ã€‚&lt;/li>
&lt;li>calc.exe æ–‡ä»¶å¤´ä¸­æœ‰ä¸€ä¸ª &lt;code>ImageBase&lt;/code> ï¼Œä¿å­˜å®ƒå€¾å‘äºä½¿ç”¨çš„å†…å­˜åŸºå€ã€‚&lt;/li>
&lt;li>calc.exe å¯ç”¨äº† ASLR æŠ€æœ¯ï¼Œæ‰€ä»¥ç†è®ºä¸Šæˆ‘ä»¬å¯ä»¥æŠŠå®ƒæ”¾åˆ°å†…å­˜ä¸­ä»»æ„ä½ç½®ã€‚&lt;/li>
&lt;li>æˆ‘ä»¬ç”¨ &lt;code>VirtualAlloc&lt;/code> åˆ†é…äº†å†…å­˜ï¼Œä»¥&lt;code>NULL&lt;/code>ä½œä¸ºé¦–å‚æ•°ï¼Œè®©æ“ä½œç³»ç»Ÿå†³å®šåœ¨å“ªå„¿åˆ†é…ï¼Œç»“æœç”¨ä½œé•œåƒåŸºå€ã€‚&lt;/li>
&lt;li>æˆ‘ä»¬å¯¼å…¥äº†å¿…è¦çš„å‡½æ•°å¹¶æŠŠåœ°å€å­˜æ”¾åœ¨ IAT é‡Œã€‚&lt;/li>
&lt;/ol>
&lt;p>ç„¶åç°åœ¨ï¼ŒæŸæ—¶æŸåˆ»ï¼Œcalc.exe éœ€è¦è°ƒç”¨è¢«å¯¼å…¥çš„å‡½æ•°ï¼Œç”¨æˆ‘ä»¬ä¹‹å‰æè¿‡çš„æ–¹æ³•ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 434;
flex-basis: 1042px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/learning-packer-01/call_IAT.jpg" data-size="543x125">
&lt;img src="https://nnnewb.github.io/blog/blog/p/learning-packer-01/call_IAT.jpg"
width="543"
height="125"
srcset="https://nnnewb.github.io/blog/blog/p/learning-packer-01/call_IAT_hu889b99c9eb0c20be37b0dc63e7aa4f3e_34329_480x0_resize_q75_box.jpg 480w, https://nnnewb.github.io/blog/blog/p/learning-packer-01/call_IAT_hu889b99c9eb0c20be37b0dc63e7aa4f3e_34329_1024x0_resize_q75_box.jpg 1024w"
loading="lazy"
alt="call_IAT">
&lt;/a>
&lt;figcaption>call_IAT&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>ä»”ç»†è§‚å¯Ÿå›¾ä¸­çš„ opcodeï¼š&lt;code>FF15&lt;/code>ï¼Œç´§è·Ÿç€çš„æ˜¯å°ç«¯åºçš„&lt;code>0x004b3038&lt;/code>ï¼Œä¸€ä¸ªç»å¯¹åœ°å€ï¼ˆå‰æ–‡æ‰€è¿°çš„VAï¼‰ï¼ŒæŒ‡å‘ &lt;em>IAT&lt;/em> ä¸­ &lt;code>ShellExecuteW&lt;/code> å‡½æ•°çš„åœ°å€ã€‚è¿™å¯¹äºä¸€ä¸ªé¢„æœŸè‡ªå·±ä¼šè¢«æ˜ å°„åˆ°éšæœºåŸºå€ä¸Šçš„PEæ–‡ä»¶æ¥è¯´ï¼Œæ˜¯ä¸€ä¸ªå·¨å¤§çš„é—®é¢˜ã€‚&lt;/p>
&lt;p>æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬æŠŠ calc.exe æ”¾ç½®åœ¨ &lt;code>0x00500000&lt;/code> è€Œä¸æ˜¯æ–‡ä»¶å¤´ä¸­â€åå¥½â€œçš„é•œåƒåŸºå€ &lt;code>0x00400000&lt;/code>ï¼Œè¿™æ¡ &lt;code>call&lt;/code> æŒ‡ä»¤è¿˜ä¿æŒä¸å˜çš„è¯ï¼Œå®ƒä¼šå°è¯•å»è®¿é—®åœ°å€ &lt;code>0x004b3038&lt;/code> â€”â€”ä½†è¿™ä¸æ˜¯ calc.exe çš„å†…å­˜ç©ºé—´ï¼é‚£å„¿å¯èƒ½æœ‰ä»»ä½•ä¸œè¥¿ï¼Œä¹Ÿå¯èƒ½ä»€ä¹ˆä¹Ÿæ²¡æœ‰ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬è¿™é‡Œçœ‹åˆ°çš„æ˜¯ï¼Œå½“æˆ‘ä»¬ç§»åŠ¨äº† PE æ–‡ä»¶åœ¨å†…å­˜ä¸­çš„åŸºå€ï¼Œæ±‡ç¼–ä»£ç ä¹Ÿéœ€è¦åœ¨è¿è¡Œæ—¶ä¿®è¡¥ï¼Œæ¥å“åº”åŸºå€çš„å˜åŒ–ã€‚è¿™å°±æ˜¯é‡å®šä½æ‰€å…³æ³¨çš„äº‹æƒ…ã€‚&lt;/p>
&lt;h3 id="42-peé‡å®šä½ç»“æ„">4.2 PEé‡å®šä½ç»“æ„&lt;/h3>
&lt;p>é‡å®šä½ç»“æ„æ¯”å¯¼å…¥è¡¨ç®€å•å¾—å¤šã€‚&lt;/p>
&lt;p>åŒæ ·çš„ï¼Œåœ¨ Data Directory é‡Œæœ‰ä¸€ä¸ªé‡å®šä½è¡¨ï¼Œç»“æ„å’Œå¯¼å…¥è¡¨ç±»ä¼¼ï¼Œçœ‹å›¾ã€‚&lt;/p>
&lt;p>&lt;figure
class="gallery-image"
style="
flex-grow: 123;
flex-basis: 296px"
>
&lt;a href="https://nnnewb.github.io/blog/blog/p/learning-packer-01/basereloc.png" data-size="980x793">
&lt;img src="https://nnnewb.github.io/blog/blog/p/learning-packer-01/basereloc.png"
width="980"
height="793"
srcset="https://nnnewb.github.io/blog/blog/p/learning-packer-01/basereloc_hu4e0f540e5f0dc51830fd117d9f67457f_361570_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/learning-packer-01/basereloc_hu4e0f540e5f0dc51830fd117d9f67457f_361570_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20210927134554770">
&lt;/a>
&lt;figcaption>image-20210927134554770&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å®é™…ä¸Šæ¯ä¸ª&lt;code>IMAGE_BASE_RELOCATION&lt;/code>ååº”çš„å°±æ˜¯ä¸€ä¸ª Windows é¡µï¼ˆå› ä¸ºæ¯ä¸ª&lt;code>fixup&lt;/code>çš„åç§»æœ€å¤§å–å€¼åªæœ‰ 12bitsï¼Œ0x1000ï¼Œ4KBï¼‰ã€‚&lt;/p>
&lt;p>å…¶ä¸­æ¯ä¸ª &lt;code>fixup&lt;/code> éƒ½æ˜¯ä¸€ä¸ª &lt;code>WORD&lt;/code> ï¼Œå‰ 4bits è¡¨ç¤ºé‡å®šä½ç±»å‹ï¼Œå 12bits è¡¨ç¤ºç›¸å¯¹ &lt;code>IMAGE_BASE_RELOCATION.VirtualAddress&lt;/code> çš„åç§»å€¼ï¼Œåç§»å¤„éœ€è¦åº”ç”¨é‡å®šä½ï¼ˆå°±æ˜¯åŠ ä¸ŠçœŸå®åŸºåœ°å€å’ŒPEå¤´ä¸­åŸºåœ°å€çš„å·®ï¼‰ã€‚&lt;/p>
&lt;h3 id="43-ä¿®å¤é‡å®šä½">4.3 ä¿®å¤é‡å®šä½&lt;/h3>
&lt;p>ä¿®å¤é‡å®šä½å¿…é¡»åœ¨PEå¤´å’ŒSectionsåŠ è½½åˆ°å†…å­˜ä¹‹åï¼Œè®¾ç½®å†…å­˜ä¿æŠ¤ä¹‹å‰è¿›è¡Œã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="n">IMAGE_DATA_DIRECTORY&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">data_directory&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">DataDirectory&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// this is how much we shifted the ImageBase
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">DWORD&lt;/span> &lt;span class="n">delta_VA_reloc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">DWORD&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">p_image_base&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">ImageBase&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// if there is a relocation table, and we actually shitfted the ImageBase
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">data_directory&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">IMAGE_DIRECTORY_ENTRY_BASERELOC&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">VirtualAddress&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">delta_VA_reloc&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨ä»£ç çš„å¼€å§‹ï¼Œéœ€è¦ç¡®è®¤æ˜¯ä¸æ˜¯æœ‰å¿…è¦åšé‡å®šä½ã€‚å¦‚æœåŸºåœ°å€å’ŒPEæ–‡ä»¶å¤´ä¸­ç»™å‡ºçš„åŸºåœ°å€ç›¸åŒï¼Œé‚£å°±ä¸ç”¨è€ƒè™‘é‡å®šä½äº†ã€‚åˆ¤æ–­æ–¹å¼æ˜¯æ‹¿çœŸå®åŸºåœ°å€å‡å»æ–‡ä»¶å¤´é‡Œç»™å‡ºçš„åŸºåœ°å€ï¼Œé0åˆ™è¯´æ˜åŸºåœ°å€éœ€è¦é‡å®šä½ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">// calculate the relocation table address
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">IMAGE_BASE_RELOCATION&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_reloc&lt;/span> &lt;span class="o">=&lt;/span>
&lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_BASE_RELOCATION&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">data_directory&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">IMAGE_DIRECTORY_ENTRY_BASERELOC&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">VirtualAddress&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»RVAå¾—åˆ°é‡å®šä½è¡¨æŒ‡é’ˆï¼Œç„¶åå°±æ˜¯éå†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">// once again, a null terminated array
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">p_reloc&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">VirtualAddress&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// switch to the next relocation block, based on the size
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">p_reloc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_BASE_RELOCATION&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(((&lt;/span>&lt;span class="n">DWORD&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">p_reloc&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">p_reloc&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">SizeOfBlock&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>SizeOfBlock&lt;/code>å…¶å®æ˜¯åŒ…æ‹¬&lt;code>IMAGE_BASE_RELOCATION&lt;/code>ï¼ˆHeaderï¼‰å’Œå±äºè¿™ä¸ªå—çš„æ‰€æœ‰ &lt;em>fixup&lt;/em> ç»„æˆçš„æ€»å¤§å°ï¼Œè¿™é‡Œå¼ºåˆ¶è½¬æ¢æˆ DWORD åç›¸åŠ å°±å¾—åˆ°äº†ä¸‹ä¸€ä¸ª &lt;code>IMAGE_BASE_RELOCATION&lt;/code> ç»“æ„çš„åœ°å€ã€‚&lt;/p>
&lt;p>åŒæ ·çš„ï¼Œè¿™ä¹Ÿæ˜¯å‰æ–‡æ‰€è¿°çš„ &lt;code>null terminated array&lt;/code> ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="c1">// how any relocation in this block
&lt;/span>&lt;span class="c1">// ie the total size, minus the size of the &amp;#34;header&amp;#34;, divided by 2 (those are words, so 2 bytes for each)
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">DWORD&lt;/span> &lt;span class="n">size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">p_reloc&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">SizeOfBlock&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_BASE_RELOCATION&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// the first relocation element in the block, right after the header (using pointer arithmetic again)
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">WORD&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">fixups&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">WORD&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_reloc&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨å¾ªç¯ä½“å†…ï¼Œå…ˆè®¡ç®—å‡ºäº†å…ƒç´ æ€»æ•°ï¼ˆ(æ€»å¤§å°(å­—èŠ‚) - &lt;code>IMAGE_BASE_RELOCATION&lt;/code> ç»“æ„å¤§å°(å­—èŠ‚)) / 2 ï¼‰ï¼Œç„¶åç”¨æŒ‡é’ˆç®—æœ¯å–å¾—ç¬¬ä¸€ä¸ªå…ƒç´ çš„åœ°å€ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">size&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// type is the first 4 bits of the relocation word
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">type&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fixups&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;&lt;/span> &lt;span class="mi">12&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// offset is the last 12 bits
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">offset&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fixups&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mh">0x0fff&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// this is the address we are going to change
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">DWORD&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">change_addr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">DWORD&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">p_reloc&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">VirtualAddress&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">offset&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// there is only one type used that needs to make a change
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">switch&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">type&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nl">IMAGE_REL_BASED_HIGHLOW&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="o">*&lt;/span>&lt;span class="n">change_addr&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">delta_VA_reloc&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>éå†æ‰€æœ‰å…ƒç´ ã€‚å¦‚ä¸Šæ–‡æ‰€è¿°çš„ï¼ŒæŠŠæ¯ä¸ª &lt;code>fixup&lt;/code> å–é«˜ä½4æ¯”ç‰¹å’Œä½ä½12æ¯”ç‰¹ï¼Œè®¡ç®—å‡ºè¦ä¿®è¡¥çš„åœ°å€ã€‚å†æ ¹æ®ä¿®è¡¥çš„ç±»å‹æ¥åº”ç”¨ã€‚&lt;/p>
&lt;p>å‚è€ƒ&lt;a class="link" href="https://docs.microsoft.com/en-us/windows/win32/debug/pe-format#base-relocation-types" target="_blank" rel="noopener"
>å¾®è½¯æ–‡æ¡£çš„Base Relocation Types&lt;/a>ã€‚å€¼å¾—æ³¨æ„ type å°±ä¸¤ä¸ªï¼š&lt;code>IMAGE_REL_BASED_HIGHLOW&lt;/code> å’Œ &lt;code>IMAGE_REL_BASED_DIR64&lt;/code> ï¼Œåˆ†åˆ«æ˜¯ 32ä½å’Œ64ä½çš„é‡å®šå‘ã€‚å…¶ä»–16ä½é‡å®šå‘ä¸å¤šè¯´äº†ã€‚&lt;/p>
&lt;p>å®Œæ•´ä»£ç å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="kt">void&lt;/span> &lt;span class="nf">fix_base_reloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_image_base&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">IMAGE_NT_HEADERS&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_NT_headers&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">IMAGE_DATA_DIRECTORY&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">data_directory&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">DataDirectory&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// this is how much we shifted the ImageBase
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">DWORD&lt;/span> &lt;span class="n">delta_VA_reloc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">DWORD&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">p_image_base&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">ImageBase&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// if there is a relocation table, and we actually shitfted the ImageBase
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">data_directory&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">IMAGE_DIRECTORY_ENTRY_BASERELOC&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">VirtualAddress&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">delta_VA_reloc&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// calculate the relocation table address
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">IMAGE_BASE_RELOCATION&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_reloc&lt;/span> &lt;span class="o">=&lt;/span>
&lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_BASE_RELOCATION&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">data_directory&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">IMAGE_DIRECTORY_ENTRY_BASERELOC&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">VirtualAddress&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// once again, a null terminated array
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">p_reloc&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">VirtualAddress&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// how any relocation in this block
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// ie the total size, minus the size of the &amp;#34;header&amp;#34;, divided by 2 (those are words, so 2 bytes for each)
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">DWORD&lt;/span> &lt;span class="n">size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">p_reloc&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">SizeOfBlock&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_BASE_RELOCATION&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// the first relocation element in the block, right after the header (using pointer arithmetic again)
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">WORD&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">fixups&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">WORD&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_reloc&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">size&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// type is the first 4 bits of the relocation word
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">type&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fixups&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;&lt;/span> &lt;span class="mi">12&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// offset is the last 12 bits
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">offset&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fixups&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mh">0x0fff&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// this is the address we are going to change
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">DWORD&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">change_addr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">DWORD&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">p_reloc&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">VirtualAddress&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">offset&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// there is only one type used that needs to make a change
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">switch&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">type&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nl">IMAGE_REL_BASED_HIGHLOW&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="o">*&lt;/span>&lt;span class="n">change_addr&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">delta_VA_reloc&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// switch to the next relocation block, based on the size
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">p_reloc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_BASE_RELOCATION&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(((&lt;/span>&lt;span class="n">DWORD&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">p_reloc&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">p_reloc&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">SizeOfBlock&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="0x05-å®Œæ•´-loader-ç¨‹åº">0x05 å®Œæ•´ Loader ç¨‹åº&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdio.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdlib.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;Windows.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;winnt.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nf">load_PE&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">PE_data&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">fix_iat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">IMAGE_NT_HEADERS&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">fix_base_reloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_image_base&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">IMAGE_NT_HEADERS&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_NT_headers&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">argc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[])&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">argc&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;missing path argument&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">FILE&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">exe_file&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fopen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="s">&amp;#34;rb&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">exe_file&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;error opening file&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Get file size : put pointer at the end
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">fseek&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">exe_file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0L&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">SEEK_END&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// and read its position
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">long&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">file_size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ftell&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">exe_file&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// put the pointer back at the beginning
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">fseek&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">exe_file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0L&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">SEEK_SET&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// allocate memory and read the whole file
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">exe_file_data&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">malloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file_size&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// read whole file
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">size_t&lt;/span> &lt;span class="n">n_read&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fread&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">exe_file_data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">file_size&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">exe_file&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">n_read&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">file_size&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;reading error (%d)&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">n_read&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// load the PE in memory
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[+] Loading PE file&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">entry&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">load_PE&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">exe_file_data&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">entry&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// call its entrypoint
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="p">)();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nf">load_PE&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">PE_data&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">IMAGE_DOS_HEADER&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_DOS_header&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_DOS_HEADER&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">PE_data&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">IMAGE_NT_HEADERS&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_NT_headers&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_NT_HEADERS&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">PE_data&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">p_DOS_header&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">e_lfanew&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// extract information from PE header
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">DWORD&lt;/span> &lt;span class="n">size_of_image&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">SizeOfImage&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">DWORD&lt;/span> &lt;span class="n">entry_point_RVA&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">AddressOfEntryPoint&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">DWORD&lt;/span> &lt;span class="n">size_of_headers&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">SizeOfHeaders&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// allocate memory
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">VirtualAlloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">size_of_image&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MEM_RESERVE&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">MEM_COMMIT&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PAGE_READWRITE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// copy PE headers in memory
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">memcpy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">p_image_base&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PE_data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">size_of_headers&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// Section headers starts right after the IMAGE_NT_HEADERS struct, so we do some pointer arithmetic-fu here.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">IMAGE_SECTION_HEADER&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">sections&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_SECTION_HEADER&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_NT_headers&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">FileHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">NumberOfSections&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// calculate the VA we need to copy the content, from the RVA
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// section[i].VirtualAddress is a RVA, mind it
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">dest&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">VirtualAddress&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// check if there is Raw data to copy
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">SizeOfRawData&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// We copy SizeOfRaw data bytes, from the offset PointerToRawData in the file
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">memcpy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PE_data&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">PointerToRawData&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">SizeOfRawData&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">memset&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">Misc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">VirtualSize&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">fix_iat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">p_image_base&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">fix_base_reloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">p_image_base&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// Set permission for the PE header to read only
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">DWORD&lt;/span> &lt;span class="n">oldProtect&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">VirtualProtect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">p_image_base&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">SizeOfHeaders&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PAGE_READONLY&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">oldProtect&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">FileHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">NumberOfSections&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">dest&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">VirtualAddress&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">DWORD&lt;/span> &lt;span class="n">s_perm&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">Characteristics&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">DWORD&lt;/span> &lt;span class="n">v_perm&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// flags are not the same between virtal protect and the section header
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">s_perm&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">IMAGE_SCN_MEM_EXECUTE&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">v_perm&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">s_perm&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">IMAGE_SCN_MEM_WRITE&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="nl">PAGE_EXECUTE_READWRITE&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">PAGE_EXECUTE_READ&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">v_perm&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">s_perm&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">IMAGE_SCN_MEM_WRITE&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="nl">PAGE_READWRITE&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">PAGE_READONLY&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">VirtualProtect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sections&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">Misc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">VirtualSize&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">v_perm&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">oldProtect&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">entry_point_RVA&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">fix_iat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_image_base&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">IMAGE_NT_HEADERS&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_NT_headers&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">IMAGE_DATA_DIRECTORY&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">data_directory&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">DataDirectory&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// load the address of the import descriptors array
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">IMAGE_IMPORT_DESCRIPTOR&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">import_descriptors&lt;/span> &lt;span class="o">=&lt;/span>
&lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_IMPORT_DESCRIPTOR&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">data_directory&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">IMAGE_DIRECTORY_ENTRY_IMPORT&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">VirtualAddress&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// this array is null terminated
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">import_descriptors&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">OriginalFirstThunk&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Get the name of the dll, and import it
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">module_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">import_descriptors&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">Name&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">HMODULE&lt;/span> &lt;span class="n">import_module&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">LoadLibraryA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">module_name&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">import_module&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;import module is null&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">abort&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// the lookup table points to function names or ordinals =&amp;gt; it is the IDT
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">IMAGE_THUNK_DATA&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">lookup_table&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_THUNK_DATA&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">import_descriptors&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">OriginalFirstThunk&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// the address table is a copy of the lookup table at first
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// but we put the addresses of the loaded function inside =&amp;gt; that&amp;#39;s the IAT
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">IMAGE_THUNK_DATA&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">address_table&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_THUNK_DATA&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">import_descriptors&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">FirstThunk&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// null terminated array, again
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">lookup_table&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">u1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">AddressOfData&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">function_handle&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// Check the lookup table for the adresse of the function name to import
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">DWORD&lt;/span> &lt;span class="n">lookup_addr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">lookup_table&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">u1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">AddressOfData&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">lookup_addr&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">IMAGE_ORDINAL_FLAG&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// if first bit is not 1
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// import by name : get the IMAGE_IMPORT_BY_NAME struct
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">IMAGE_IMPORT_BY_NAME&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">image_import&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_IMPORT_BY_NAME&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">lookup_addr&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// this struct points to the ASCII function name
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">funct_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">image_import&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">Name&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// get that function address from it&amp;#39;s module and name
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">function_handle&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">GetProcAddress&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">import_module&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">funct_name&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// import by ordinal, directly
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">function_handle&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">GetProcAddress&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">import_module&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">LPSTR&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">lookup_addr&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">function_handle&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;function handle is null&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">abort&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// change the IAT, and put the function address inside.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">address_table&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">u1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Function&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">DWORD&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">function_handle&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="nf">fix_base_reloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_image_base&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">IMAGE_NT_HEADERS&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_NT_headers&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">IMAGE_DATA_DIRECTORY&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">data_directory&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">DataDirectory&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// this is how much we shifted the ImageBase
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">DWORD&lt;/span> &lt;span class="n">delta_VA_reloc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">DWORD&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">p_image_base&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">p_NT_headers&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">OptionalHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">ImageBase&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// if there is a relocation table, and we actually shitfted the ImageBase
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">data_directory&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">IMAGE_DIRECTORY_ENTRY_BASERELOC&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">VirtualAddress&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">delta_VA_reloc&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// calculate the relocation table address
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">IMAGE_BASE_RELOCATION&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p_reloc&lt;/span> &lt;span class="o">=&lt;/span>
&lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_BASE_RELOCATION&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">data_directory&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">IMAGE_DIRECTORY_ENTRY_BASERELOC&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">VirtualAddress&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// once again, a null terminated array
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">p_reloc&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">VirtualAddress&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// how any relocation in this block
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// ie the total size, minus the size of the &amp;#34;header&amp;#34;, divided by 2 (those are words, so 2 bytes for each)
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">DWORD&lt;/span> &lt;span class="n">size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">p_reloc&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">SizeOfBlock&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_BASE_RELOCATION&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// the first relocation element in the block, right after the header (using pointer arithmetic again)
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">WORD&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">fixups&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">WORD&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_reloc&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">size&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// type is the first 4 bits of the relocation word
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">type&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fixups&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;&lt;/span> &lt;span class="mi">12&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// offset is the last 12 bits
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">offset&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fixups&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mh">0x0fff&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// this is the address we are going to change
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">DWORD&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">change_addr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">DWORD&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">p_image_base&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">p_reloc&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">VirtualAddress&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">offset&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// there is only one type used that needs to make a change
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">switch&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">type&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nl">IMAGE_REL_BASED_HIGHLOW&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="o">*&lt;/span>&lt;span class="n">change_addr&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">delta_VA_reloc&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// switch to the next relocation block, based on the size
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">p_reloc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_BASE_RELOCATION&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(((&lt;/span>&lt;span class="n">DWORD&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">p_reloc&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">p_reloc&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">SizeOfBlock&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="0x06-ç»“è®º">0x06 ç»“è®º&lt;/h2>
&lt;p>æœ¬æ–‡çš„èƒŒæ™¯çŸ¥è¯†åŸºæœ¬æ˜¯å‚è€ƒç›¸å…³ä¹¦ç±ï¼Œç¼–å†™ Loader çš„éƒ¨åˆ†åˆ™æ¥è‡ª &lt;a class="link" href="https://bidouillesecurity.com/" target="_blank" rel="noopener"
>BidouilleSecurity&lt;/a> ã€‚å…³äºåŠ å£³è„±å£³åŸç†ï¼Œä¸ä¹å½¢è±¡ç›´è§‚çš„æè¿°ï¼Œä¹Ÿæœ‰å¾ˆå¤šè„±å£³ç›¸å…³æ–‡ç« ï¼Œä½†é€‚åˆèŒæ–°ä¸Šæ‰‹ã€èƒ½ç…§ç€æ’¸å‡ºä»£ç çš„æ–‡ç« å°±å¾ˆå°‘ï¼Œç”šè‡³å¯ä»¥è¯´æ²¡åœ°æ–¹æ‰¾ã€‚æŠ›å¼€åŠ å£³è„±å£³è¿™äº›ç‰¹å®šé¢†åŸŸè¯é¢˜ä¸è°ˆï¼Œç¨‹åºçš„åŠ è½½åˆ°æ‰§è¡Œæœ¬èº«å¯¹æœ‰å¥½å¥‡å¿ƒçš„ç å†œä¹Ÿæ˜¯å¾ˆå€¼å¾—ä¸€èŠçš„å†…å®¹ã€‚&lt;/p>
&lt;p>ç›®å‰è®¨è®ºçš„èŒƒå›´åŒ…æ‹¬äº†å¦‚ä½•åŠ è½½å¹¶è¿è¡Œä¸€ä¸ªWindowsç¨‹åºï¼ˆ32ä½ï¼‰ï¼Œå¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>è¯»å–æ–‡ä»¶åˆ°å†…å­˜&lt;/li>
&lt;li>æ˜ å°„æ–‡ä»¶å¤´åˆ°åŸºåœ°å€&lt;/li>
&lt;li>æ˜ å°„Sections&lt;/li>
&lt;li>å¡«å……IAT&lt;/li>
&lt;li>é‡å®šä½&lt;/li>
&lt;li>è·³è½¬åˆ°å…¥å£ç‚¹å¼€å§‹æ‰§è¡Œã€‚&lt;/li>
&lt;/ul>
&lt;p>åœ¨å¯¹è¿™äº›çŸ¥è¯†æœ‰äº†è¶³å¤Ÿäº†è§£åï¼Œå·²ç»èƒ½å†™å‡ºåŸºæœ¬çš„å£³ç¨‹åºäº†ã€‚ä¹Ÿè®¸ä¸‹ä¸€ç¯‡æ–‡ç« ä¼šè°ˆã€‚&lt;/p>
&lt;p>å‚è€ƒèµ„æ–™ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;a class="link" href="https://bidouillesecurity.com/tutorial-writing-a-pe-packer-part-1/" target="_blank" rel="noopener"
>writing a PE packer - Part 1 : Load a PE in memory&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a class="link" href="https://bidouillesecurity.com/tutorial-writing-a-pe-packer-part-2/" target="_blank" rel="noopener"
>writing a PE packer - Part 2 : Imports and relocations&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a class="link" href="https://book.douban.com/subject/3652388/" target="_blank" rel="noopener"
>ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»â€”â€”é“¾æ¥ã€è£…è½½ä¸åº“ã€‹&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a class="link" href="https://docs.microsoft.com/en-us/windows/win32/debug/pe-format" target="_blank" rel="noopener"
>å¾®è½¯æ–‡æ¡£ - PE Format&lt;/a>&lt;/p>
&lt;/li>
&lt;/ul></description></item><item><title>è‡ªå¨±è‡ªä¹ crackme-03</title><link>https://nnnewb.github.io/blog/p/crackme-03/</link><pubDate>Fri, 24 Sep 2021 16:58:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/crackme-03/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>æ€»å¾—æœ‰ä¸ªå‰è¨€ã€‚&lt;/p>
&lt;p>ä¸€ç›´ç©å‘½ä»¤è¡Œ crackme çœ‹ç€å°±æ²¡å•¥æ„æ€ï¼Œæ¥ç‚¹å¸¦ç•Œé¢çš„ã€‚ä¾ç„¶æ˜¯å­¦ä¹ ç”¨ï¼Œç›®æ ‡æ˜¯æŠŠæ±‡ç¼–å’Œåº•å±‚å’Œå†…å­˜è¿™å¥—ä¸œè¥¿è¯»ç†Ÿã€‚è¿™æ¬¡æ˜¯ç”¨ wxwidgets åšçš„ç®€å• crackmeï¼Œä¸ºäº†åœ¨ CrackME-02 åŸºç¡€ä¸Šå†å¢åŠ ç‚¹éš¾åº¦ä½†åˆä¸è‡³äºå¤ªéš¾ï¼Œè¿™æ¬¡æ˜¯ OTP ç”Ÿæˆåºåˆ—å·ï¼Œè¦æ±‚è§£å‡ºç”Ÿæˆ OTP çš„ SECRETã€‚&lt;/p>
&lt;h2 id="æºç ">æºç &lt;/h2>
&lt;p>è¶Šæ¥è¶Šé•¿äº†ï¼Œè´´ä¸Šæ¥æ²¡æ³•çœ‹ã€‚ç°åœ¨æ‰˜ç®¡åˆ°GitHubï¼ŒåŒ…æ‹¬å‰é¢çš„ä¸¤ä¸ªcmã€‚&lt;/p>
&lt;p>å‰ä¸¤ä¸ªcmæ‰˜ç®¡çš„ä»£ç ç¼–è¯‘å‚æ•°æœ‰ä¸€ç‚¹ä¿®æ”¹ï¼Œå¯èƒ½é€ æˆç»“æœå’Œæ–‡ç« ä¸ä¸€è‡´ï¼Œä½†å¤§ä½“æ˜¯ä¸€æ ·çš„ï¼Œåˆ«åœ¨æ„ã€‚&lt;/p>
&lt;p>æºç æ‰˜ç®¡åœ°å€ï¼š&lt;a class="link" href="https://github.com/nnnewb/crackmes/" target="_blank" rel="noopener"
>github.com/nnnewb/crackmes&lt;/a>&lt;/p>
&lt;p>æŒ‘æˆ˜ä¸€ä¸‹C++ä»£ç å¼€å¯ä¼˜åŒ–çš„Hardæ¨¡å¼ã€‚&lt;/p>
&lt;h2 id="è§‚å¯Ÿ">è§‚å¯Ÿ&lt;/h2>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-03/01.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-03/01.png"
loading="lazy"
alt="image-20210923104439284">
&lt;/a>
&lt;figcaption>image-20210923104439284&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>ä¸€ä¸ªè¾“å…¥æ¡†ï¼Œç‚¹å‡»try itå°è¯•ã€‚å¤±è´¥æ—¶æç¤ºWrongï¼Œæ²¡æœ‰åˆ«çš„ä¿¡æ¯ã€‚&lt;/p>
&lt;h2 id="é™æ€åˆ†æ">é™æ€åˆ†æ&lt;/h2>
&lt;p>è€è§„çŸ©å…ˆé™æ€åˆ†æä¸€æ³¢ï¼Œç²—ç•¥æ‰«ä¸€çœ¼ï¼Œæ‹ä¸€æ‹é€»è¾‘ã€‚ç”¨ä½ å–œæ¬¢çš„åæ±‡ç¼–å·¥å…·æ‰“å¼€ï¼Œæˆ‘ç”¨Cutterå…ˆè¯•è¯•ã€‚&lt;/p>
&lt;p>å› ä¸ºæ˜¯GUIç¨‹åºï¼Œç›´æ¥è·³&lt;code>main&lt;/code>è‚¯å®šæ˜¯ä¸è¡Œçš„ã€‚Win32 GUIç¨‹åºçš„å…¥å£ç‚¹ï¼ˆç¨‹åºå‘˜è§†è§’ï¼‰åœ¨&lt;code>WinMain&lt;/code>è¿™ä¸ªç‰¹æ®Šå‡½æ•°ï¼Œä¸è¿‡çœŸæ‹¿Win32APIæ‰‹æ’¸ç•Œé¢æˆ‘æ˜¯çœŸæ²¡è§è¿‡äº†ï¼ŒWin32 GUIç¨‹åºè®¾è®¡ä¹Ÿæ˜¯ç©çš„äº‹ä»¶å“åº”ï¼Œæ‰¾åˆ°ä¸»å‡½æ•°çš„æ„ä¹‰ä¸å¤§ã€‚&lt;/p>
&lt;p>æ‰€ä»¥æ‰¾å…³é”®è·³è¿™ä¸€æ­¥åªèƒ½æ˜¯ä»æ•°æ®æ®µæ‰¾å­—ç¬¦ä¸²æŸ¥å¼•ç”¨ï¼Œæˆ–è€…è°ƒè¯•å™¨ä¸‹åˆé€‚çš„è®¿é—®æ–­ç‚¹äº†ã€‚&lt;/p>
&lt;p>è¿™é‡Œç›´æ¥ä»æ•°æ®æ®µæ‰¾åˆ°äº†å­—ç¬¦ä¸²ï¼Œå®šä½åˆ°å¼¹å‡ºé”™è¯¯å¯¹è¯æ¡†çš„é€»è¾‘ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-03/02.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-03/02.png"
loading="lazy"
alt="image-20210923105415082">
&lt;/a>
&lt;figcaption>image-20210923105415082&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>è¿™é‡Œæœ‰ä¸ªå§¿åŠ¿ç‚¹æ˜¯&lt;code>__thiscall&lt;/code>ï¼Œè¿™æ˜¯ä¸ªå¾®è½¯è‡ªå®šä¹‰çš„è°ƒç”¨çº¦å®šï¼Œç‚¹è¿™é‡Œçœ‹&lt;a class="link" href="https://docs.microsoft.com/zh-cn/cpp/cpp/thiscall?view=msvc-160" target="_blank" rel="noopener"
>å¾®è½¯çš„æ–‡æ¡£&lt;/a>ã€‚&lt;/p>
&lt;h3 id="__thiscall">__thiscall&lt;/h3>
&lt;p>&lt;code>__thiscall&lt;/code>çš„ç‰¹ç‚¹æ˜¯è¢«è°ƒç”¨æ–¹æ¸…æ ˆï¼Œ&lt;code>this&lt;/code>æŒ‡é’ˆé€šè¿‡&lt;code>ecx&lt;/code>å¯„å­˜å™¨ä¼ é€’ï¼Œå…¶ä»–å‚æ•°å³è‡³å·¦å‹æ ˆã€‚å¯¹äºå¯å˜é•¿åº¦å‚æ•°ï¼ˆVAARGï¼‰çš„æˆå‘˜å‡½æ•°ä¼šç‰¹æ®Šå¤„ç†ï¼Œé‡‡ç”¨&lt;code>cdecl&lt;/code>è°ƒç”¨çº¦å®šï¼Œ&lt;code>this&lt;/code>æŒ‡é’ˆæœ€åå‹æ ˆã€‚&lt;/p>
&lt;p>è¿™é‡Œç®€å•è¯»ä¸€ä¸‹å®šä½åˆ°çš„å‡ å¥ä»£ç ï¼Œåˆ†æä¸‹æ„å›¾ã€‚&lt;/p>
&lt;pre>&lt;code>
0x004064dc 68 34 e8 40 00 push str.Try_again ; 0x40e834
0x004064e1 8d 4d d0 lea ecx, [ebp - 0x30]
0x004064e4 ff 15 e0 33 41 00 call dword [public: void __thiscall wxString::constructor(char const *)] ; 0x4133e0
0x004064ea 68 44 e8 40 00 push str.Wrong ; 0x40e844
0x004064ef 8d 4d b0 lea ecx, [ebp - 0x50]
0x004064f2 c6 45 fc 07 mov byte [ebp - 4], 7
0x004064f6 ff 15 e0 33 41 00 call dword [public: void __thiscall wxString::constructor(char const *)] ; 0x4133e0
0x004064fc 6a ff push 0xffffffffffffffff
0x004064fe 6a ff push 0xffffffffffffffff
0x00406500 6a 00 push 0
0x00406502 6a 05 push 5 ; 5
0x00406504 8d 45 d0 lea eax, [ebp - 0x30]
0x00406507 c6 45 fc 08 mov byte [ebp - 4], 8
0x0040650b 50 push eax
0x0040650c 8d 45 b0 lea eax, [ebp - 0x50]
0x0040650f 50 push eax
0x00406510 ff 15 d4 3c 41 00 call dword [int __cdecl wxMessageBox(class wxString const &amp;amp;, class wxString const &amp;amp;, long int, class wxWindow *, int, int)] ; 0x413cd4
&lt;/code>&lt;/pre>&lt;p>åç¼–è¯‘å™¨å¯¹è°ƒç”¨çš„ç¬¬ä¸‰æ–¹åº“çš„å‡½æ•°åˆ†ææå¤§é™ä½äº†è‚‰çœ¼åˆ¤è¯»çš„éš¾åº¦ã€‚å¯ä»¥çœ‹åˆ°å‰ä¸‰æ­¥&lt;code>push&lt;/code>ã€&lt;code>lea ecx,...&lt;/code>ã€&lt;code>call&lt;/code> æ˜¯å…¸å‹çš„ &lt;code>__thiscall&lt;/code> è°ƒç”¨ï¼Œè°ƒç”¨å¯¹è±¡æ˜¯&lt;code>wxString&lt;/code>çš„æ„é€ å™¨ï¼Œæ‰€ä»¥å¯ä»¥çŸ¥é“&lt;code>ecx&lt;/code>åœ°å€ä¿å­˜çš„æ˜¯ä¸€ä¸ª&lt;code>wxString&lt;/code>å¯¹è±¡çš„æŒ‡é’ˆã€‚&lt;/p>
&lt;pre>&lt;code>0x004064ea 68 44 e8 40 00 push str.Wrong ; 0x40e844
0x004064ef 8d 4d b0 lea ecx, [ebp - 0x50]
0x004064f2 c6 45 fc 07 mov byte [ebp - 4], 7
0x004064f6 ff 15 e0 33 41 00 call dword [public: void __thiscall wxString::constructor(char const *)] ; 0x4133e0
&lt;/code>&lt;/pre>&lt;p>è¿™æ˜¯å¦ä¸€ä¸ª&lt;code>wxString&lt;/code>çš„æ„é€ ã€‚&lt;/p>
&lt;pre>&lt;code>0x004064fc 6a ff push 0xffffffffffffffff
0x004064fe 6a ff push 0xffffffffffffffff
0x00406500 6a 00 push 0
0x00406502 6a 05 push 5 ; 5
0x00406504 8d 45 d0 lea eax, [ebp - 0x30]
0x00406507 c6 45 fc 08 mov byte [ebp - 4], 8
0x0040650b 50 push eax
0x0040650c 8d 45 b0 lea eax, [ebp - 0x50]
0x0040650f 50 push eax
0x00406510 ff 15 d4 3c 41 00 call dword [int __cdecl wxMessageBox(class wxString const &amp;amp;, class wxString const &amp;amp;, long int, class wxWindow *, int, int)] ; 0x413cd4
&lt;/code>&lt;/pre>&lt;p>è¿ç»­æ¨å…¥å¤šä¸ªå‚æ•°åï¼Œè°ƒç”¨äº†&lt;code>wxMessageBox&lt;/code>å‡½æ•°ã€‚æˆ‘ä»¬çŸ¥é“&lt;code>[ebp-0x30]&lt;/code>æ˜¯&lt;code>Try again&lt;/code>ï¼Œ&lt;code>[ebp-0x50]&lt;/code> æ˜¯ &lt;code>Wrong!&lt;/code>ï¼Œè¿™ä¸ªè°ƒç”¨ç”¨ä¼ªä»£ç è¡¨ç¤ºå°±æ˜¯ &lt;code>wxMessageBox(&amp;quot;Wrong!&amp;quot;, &amp;quot;Try again!&amp;quot;, 5, 0, -1, -1)&lt;/code>ã€‚æ³¨æ„å¿½ç•¥ä¸­é—´çš„&lt;code>mov byte [ebp - 4], 8&lt;/code>ï¼Œ&lt;code>ebp-4&lt;/code>è¿™ä¸ªåç§»æ˜¾ç„¶ä¸å¤§å¯èƒ½æ˜¯å‚æ•°ã€‚&lt;/p>
&lt;h3 id="å…³é”®è·³">å…³é”®è·³&lt;/h3>
&lt;p>å›åˆ°è¿™æ®µä»£ç çš„å¼€å¤´ï¼Œé¡ºç€ç•Œé¢ä¸Šçš„ç»¿è‰²ç®­å¤´æ‰¾åˆ°å…³é”®è·³ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-03/03.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-03/03.png"
loading="lazy"
alt="image-20210923111554787">
&lt;/a>
&lt;figcaption>image-20210923111554787&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>ä¸€ä¸ª&lt;code>je&lt;/code>è·³è½¬ï¼Œ&lt;code>je&lt;/code>æŒ‡ä»¤æ£€æŸ¥&lt;code>ZF&lt;/code>ï¼Œå‘ä¸Šä¸€è¡Œå°±æ˜¯&lt;code>test&lt;/code>ï¼Œ&lt;code>test bl,bl&lt;/code>è‡ªå·±å¯¹è‡ªå·±é€»è¾‘ä¸ï¼Œå…¶å®å°±æ˜¯æ±‚&lt;code>bl&lt;/code>æ˜¯ä¸æ˜¯0ã€‚&lt;/p>
&lt;p>blåˆæ¥è‡ªå‰é¢çš„&lt;code>mov bl,al&lt;/code>ï¼Œ&lt;code>al&lt;/code>å¯„å­˜å™¨æ˜¯&lt;code>eax&lt;/code>å¯„å­˜å™¨çš„ä½8ä½ï¼Œå†è€…å¤§å®¶ä¹ŸçŸ¥é“&lt;code>eax&lt;/code>å¯„å­˜å™¨æ˜¯å‡½æ•°è¿”å›å€¼ä¿å­˜çš„å¯„å­˜å™¨ï¼Œè€Œç¦»è¿™ä¸ª&lt;code>mov&lt;/code>æŒ‡ä»¤æœ€è¿‘çš„&lt;code>call&lt;/code>å°±æ˜¯æˆªå›¾ä¸Šæ–¹çš„&lt;code>IsSameAs&lt;/code>å‡½æ•°äº†ã€‚&lt;/p>
&lt;p>åˆ°äº†è¿™ä¸€æ­¥ï¼Œæ”¹æŒ‡ä»¤è·³è¿‡éªŒè¯å·²ç»æ¥è¿‘æˆåŠŸäº†ï¼Œä½†è¿™è¦æ˜¯åš keygen çš„è¯è¿˜ä¸è¡Œã€‚&lt;/p>
&lt;p>ç»§ç»­å¾€å›ç¿»ï¼Œå¯»æ‰¾å¯†ç ç”Ÿæˆçš„ä»£ç ã€‚&lt;/p>
&lt;h3 id="å¯»æ‰¾å¯†ç ç”Ÿæˆç®—æ³•">å¯»æ‰¾å¯†ç ç”Ÿæˆç®—æ³•&lt;/h3>
&lt;p>å…ˆä¸€è·¯å›åˆ°å…³é”®è·³æ‰€å¤„çš„ä»£ç å—é¡¶éƒ¨ï¼ŒæŒ¨ä¸ªå¾€ä¸‹çœ‹æœ‰å“ªäº›å‡½æ•°è°ƒç”¨ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-03/04.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-03/04.png"
loading="lazy"
alt="image-20210923113330184">
&lt;/a>
&lt;figcaption>image-20210923113330184&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>è¿˜æ˜¯é‚£å¥è¯ï¼Œæ„Ÿè°¢åˆ†æå‡ºäº†åº“å‡½æ•°ï¼Œä¸ç„¶ä¸€å †æœªçŸ¥å‡½æ•°çœ‹å¾—æ»¡å¤´é›¾æ°´ã€‚&lt;/p>
&lt;ol>
&lt;li>
&lt;p>è°ƒç”¨æ˜¯ &lt;code>wxString.AsWChar(void)&lt;/code>ï¼Œé¡¾åæ€ä¹‰æ˜¯å–å®½å­—ç¬¦ï¼Œè¿”å›æŒ‡é’ˆã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>è°ƒç”¨æ˜¯&lt;code>wxString.DoFormatWchar(wchar_t*)&lt;/code>ï¼ŒæŸ¥è¯¢æ–‡æ¡£å¯çŸ¥æ˜¯ä¸ªç±»ä¼¼&lt;code>sprintf&lt;/code>çš„å­—ç¬¦ä¸²æ ¼å¼åŒ–å‡½æ•°ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>è°ƒç”¨æ˜¯ææ„å‡½æ•°ï¼Œæ€€ç–‘ä¸Šé¢çš„ä¸¤ä¸ªè°ƒç”¨å…¶å®æ˜¯å†…è”äº†ä»€ä¹ˆwxwidgetsåº“çš„ä»£ç ã€‚å› ä¸ºç›´è§‰å‘Šè¯‰æˆ‘å¦‚æœè¿˜æ²¡ç¦»å¼€ä½œç”¨åŸŸï¼Œç¼–è¯‘å™¨åº”è¯¥ä¸ä¼šè¿™ä¹ˆç€æ€¥æ’å…¥ææ„å‡½æ•°è°ƒç”¨ï¼Œè¿™å¬èµ·æ¥å°±æ²¡ä»€ä¹ˆå¥½å¤„ï¼Œè¿˜è¿èƒŒç å†œç›´è§‰ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å‡½æ•°å°±æ¯”è¾ƒè¿·æƒ‘äº†ï¼Œä¸€è·¯çœ‹ä¸Šå»çš„è¯ä¼šå‘ç°è¿™ä¸ªåç§»å€¼ç»è¿‡äº†å¤šæ¬¡è®¡ç®—ï¼Œç›®å‰çœ‹ä¸å‡ºç”¨æ„ï¼Œä½†è¿˜æŒºå¯ç–‘çš„ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å‡½æ•°é¡¾åæ€ä¹‰ï¼Œæ¯”è¾ƒå­—ç¬¦ä¸²ç›¸ç­‰ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åˆæ˜¯ææ„å‡½æ•°ã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>é‡ç‚¹çœ‹å­—ç¬¦ä¸²æ¯”è¾ƒå‡½æ•°çš„å‚æ•°ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="err">0&lt;/span>&lt;span class="nf">x0040646c&lt;/span> &lt;span class="mi">6&lt;/span>&lt;span class="no">a&lt;/span> &lt;span class="mi">01&lt;/span> &lt;span class="no">push&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="c">; 1
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="mi">0x0040646e&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="no">d&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="no">d&lt;/span> &lt;span class="mi">90&lt;/span> &lt;span class="no">lea&lt;/span> &lt;span class="no">ecx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp&lt;/span> &lt;span class="p">-&lt;/span> &lt;span class="mi">0x70&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x00406471&lt;/span> &lt;span class="no">c6&lt;/span> &lt;span class="mi">45&lt;/span> &lt;span class="no">fc&lt;/span> &lt;span class="mi">04&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">byte&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp&lt;/span> &lt;span class="p">-&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="mi">4&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x00406475&lt;/span> &lt;span class="mi">51&lt;/span> &lt;span class="no">push&lt;/span> &lt;span class="no">ecx&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x00406476&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="no">b&lt;/span> &lt;span class="no">c8&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">ecx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">eax&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x00406478&lt;/span> &lt;span class="no">ff&lt;/span> &lt;span class="mi">15&lt;/span> &lt;span class="no">d4&lt;/span> &lt;span class="mi">33&lt;/span> &lt;span class="mi">41&lt;/span> &lt;span class="mi">00&lt;/span> &lt;span class="no">call&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">public&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="no">bool&lt;/span> &lt;span class="no">__thiscall&lt;/span> &lt;span class="no">wxString&lt;/span>&lt;span class="p">::&lt;/span>&lt;span class="no">IsSameAs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="no">class&lt;/span> &lt;span class="no">wxString&lt;/span> &lt;span class="no">const&lt;/span> &lt;span class="err">&amp;amp;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">bool&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="no">const&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; 0x4133d4
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æŠŠ&lt;code>eax&lt;/code>å½“æˆäº†&lt;code>this&lt;/code>ï¼Œæš‚ä¸”ä¸çœ‹æ ˆä¸Šçš„&lt;code>ebp-0x70&lt;/code>ï¼Œçœ‹åˆ°&lt;code>eax&lt;/code>ç«‹åˆ»å°±å‘ç°æ˜¯æ¥è‡ªç¬¬å››ä¸ªæ¯”è¾ƒè¿·æƒ‘çš„å‡½æ•°è°ƒç”¨ï¼Œå®é”¤è¿™å‡½æ•°å°±æ˜¯ç”Ÿæˆå¯†ç çš„å‡½æ•°ã€‚&lt;/p>
&lt;h2 id="åŠ¨æ€è°ƒè¯•">åŠ¨æ€è°ƒè¯•&lt;/h2>
&lt;p>æ°´å¹³æœ‰é™ï¼Œé™æ€åˆ†æå¾ˆå¿«é‡åˆ°äº†ç“¶é¢ˆï¼Œæ‰¾ä¸å‡ºè¿™ä¸ªåç§»å€¼ç®—å‡ºæ¥çš„å‡½æ•°åˆ°åº•åœ¨å“ªå„¿ã€‚&lt;/p>
&lt;p>äºæ˜¯å¯åŠ¨è°ƒè¯•å™¨ï¼Œå…ˆè·Ÿåˆ°æˆ‘ä»¬å®šä½åˆ°çš„è¿™ä¸ªç‰¹æ®Šå‡½æ•°ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-03/05.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-03/05.png"
loading="lazy"
alt="image-20210923140108796">
&lt;/a>
&lt;figcaption>image-20210923140108796&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æƒŠå–œåœ°å‘ç°èƒ¡ä¹±åˆ†æå‡ºç°äº†é”™è¯¯ï¼Œ&lt;code>eax+0x40&lt;/code>å…¶å®æ˜¯è·å–è¾“å…¥æ¡†å€¼çš„å‡½æ•°ã€‚ã€‚æ‰€ä»¥å¦ä¸€ä¸ªå‚æ•°ï¼Œ&lt;code>ebp-0x70&lt;/code>æ‰æ˜¯å¯†ç ã€‚&lt;/p>
&lt;p>å¾€å›çœ‹&lt;code>ebp-0x70&lt;/code>åœ¨&lt;code>DoFormatWchar&lt;/code>è¢«å½“å‚æ•°ä¼ é€’äº†è¿›å»ï¼Œè¦æ³¨æ„çš„æ˜¯&lt;code>DoFormatWchar&lt;/code>æ˜¯ä¸€ä¸ªæœ‰å˜é•¿å‚æ•°çš„å‡½æ•°ï¼Œè¿™æ„å‘³ç€ä½ æ²¡æ³•å¾—çŸ¥ä¼ äº†å‡ ä¸ªå‚æ•°ï¼ˆå‰é¢pushçš„å†…å®¹ä¸ä¸€å®šæ˜¯å½“å‚æ•°ä¼ äº†ï¼‰ï¼Œåˆ†ææ›´å›°éš¾ã€‚&lt;/p>
&lt;p>çœ‹ä¸€ä¸‹&lt;code>DoFormatWchar&lt;/code>è¿™æ®µæ±‡ç¼–ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="err">0&lt;/span>&lt;span class="nf">x0040642c&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="no">d&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="no">d&lt;/span> &lt;span class="mi">70&lt;/span> &lt;span class="no">ff&lt;/span> &lt;span class="no">ff&lt;/span> &lt;span class="no">ff&lt;/span> &lt;span class="no">lea&lt;/span> &lt;span class="no">ecx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp&lt;/span> &lt;span class="p">-&lt;/span> &lt;span class="mi">0x90&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x00406432&lt;/span> &lt;span class="no">ff&lt;/span> &lt;span class="mi">15&lt;/span> &lt;span class="no">e8&lt;/span> &lt;span class="mi">33&lt;/span> &lt;span class="mi">41&lt;/span> &lt;span class="mi">00&lt;/span> &lt;span class="no">call&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">private&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="no">wchar_t&lt;/span> &lt;span class="no">const&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="no">__thiscall&lt;/span> &lt;span class="no">wxFormatString&lt;/span>&lt;span class="p">::&lt;/span>&lt;span class="no">AsWChar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="no">void&lt;/span>&lt;span class="p">)]&lt;/span> &lt;span class="c">; 0x4133e8
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="mi">0x00406438&lt;/span> &lt;span class="mi">56&lt;/span> &lt;span class="no">push&lt;/span> &lt;span class="no">esi&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x00406439&lt;/span> &lt;span class="mi">50&lt;/span> &lt;span class="no">push&lt;/span> &lt;span class="no">eax&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x0040643a&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="no">d&lt;/span> &lt;span class="mi">45&lt;/span> &lt;span class="mi">90&lt;/span> &lt;span class="no">lea&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp&lt;/span> &lt;span class="p">-&lt;/span> &lt;span class="mi">0x70&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x0040643d&lt;/span> &lt;span class="mi">50&lt;/span> &lt;span class="no">push&lt;/span> &lt;span class="no">eax&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x0040643e&lt;/span> &lt;span class="no">ff&lt;/span> &lt;span class="mi">15&lt;/span> &lt;span class="no">d0&lt;/span> &lt;span class="mi">33&lt;/span> &lt;span class="mi">41&lt;/span> &lt;span class="mi">00&lt;/span> &lt;span class="no">call&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">private&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="no">static&lt;/span> &lt;span class="no">class&lt;/span> &lt;span class="no">wxString&lt;/span> &lt;span class="no">__cdecl&lt;/span> &lt;span class="no">wxString&lt;/span>&lt;span class="p">::&lt;/span>&lt;span class="no">DoFormatWchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="no">wchar_t&lt;/span> &lt;span class="no">const&lt;/span> &lt;span class="p">*)]&lt;/span> &lt;span class="c">; 0x4133d0
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸€å…±æ¨äº†ä¸‰ä¸ªä¸œè¥¿å…¥æ ˆï¼Œesiã€eaxï¼ˆä¸Šä¸€ä¸ªè°ƒç”¨çš„è¿”å›å€¼ï¼‰ã€è¿˜æœ‰&lt;code>[ebp-0x70]&lt;/code>ã€‚&lt;/p>
&lt;p>ç»§ç»­è°ƒè¯•å™¨è·Ÿä¸€éçœ‹çœ‹ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-03/06.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-03/06.png"
loading="lazy"
alt="image-20210923142010900">
&lt;/a>
&lt;figcaption>image-20210923142010900&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>&lt;code>esi&lt;/code>çš„å€¼æ¯”è¾ƒæ€ªï¼Œå…ˆå¿½ç•¥ã€‚&lt;/p>
&lt;p>&lt;code>eax&lt;/code>æ¯”è¾ƒæ¸…æ¥šï¼Œå®½å­—ç¬¦ä¸²&lt;code>%06d&lt;/code>ï¼ŒæŒ‰å‹æ ˆé¡ºåºï¼Œ&lt;code>esi&lt;/code>çš„å€¼æ˜¯ç´§è·Ÿåœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²åé¢çš„å‚æ•°ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-03/07.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-03/07.png"
loading="lazy"
alt="image-20210923142347785">
&lt;/a>
&lt;figcaption>image-20210923142347785&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æœ€åå‹æ ˆçš„eaxï¼Œä¹Ÿå°±æ˜¯ebp-0x70çš„åœ°å€ï¼Œç”¨ä¼ªä»£ç è¡¨ç¤ºå°±æ˜¯ï¼š&lt;code>DoFormatWchar(&amp;amp;var_70, L&amp;quot;%06d&amp;quot;, 0x000F18D8)&lt;/code>ã€‚PSï¼šæœ‰ç‚¹æ€ªï¼Œå‡½æ•°ç­¾åæœ€å·¦ä¾§æ˜¯formatä¹Ÿå°±æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œæœ€åå‹æ ˆè¿™ä¸ªebp-0x70å°±æœ‰ç‚¹è«åå…¶å¦™ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-03/08.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-03/08.png"
loading="lazy"
alt="image-20210923143534148">
&lt;/a>
&lt;figcaption>image-20210923143534148&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>ä¸è¿‡ç”¨è°ƒè¯•å™¨å•æ­¥æ­¥è¿‡åå°±çŸ¥é“ç”¨é€”äº†ï¼Œå’ŒçŒœæµ‹çš„ä¸€æ ·ï¼Œå­˜æ”¾çš„æ˜¯æ ¼å¼åŒ–çš„ç»“æœï¼Œä¹Ÿå°±æ˜¯æ­£ç¡®çš„å¯†ç ã€‚&lt;/p>
&lt;p>æ—¢ç„¶å¦‚æ­¤ï¼Œå¾€å›æ‰¾esiæ˜¯å“ªå„¿èµ‹å€¼çš„ï¼Œå› ä¸ºinlineäº†ä¸€å¤§å †ä¸œè¥¿ï¼ŒCutterè¿å‡½æ•°éƒ½è®¤ä¸å‡ºæ¥äº†ï¼Œæ§åˆ¶æµè§†å›¾ä¹ŸæŒ‚äº†ã€‚ã€‚ä¸€ç›´å¾€ä¸Šç¿»ï¼Œæ‰¾åˆ°&lt;code>0xcc&lt;/code>æˆ–è€…&lt;code>push ebp; mov ebp, esp&lt;/code>ä¸ºæ­¢ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-03/09.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-03/09.png"
loading="lazy"
alt="image-20210923145922049">
&lt;/a>
&lt;figcaption>image-20210923145922049&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å³é”®é€‰æ‹©åœ¨æ­¤å¤„å®šä¹‰å‡½æ•°ï¼Œéšä¾¿ç»™ä¸ªåå­—ï¼Œç„¶åç­‰Cutteråˆ†æå¥½å‡½æ•°ä½“ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-03/10.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-03/10.png"
loading="lazy"
alt="image-20210923150100196">
&lt;/a>
&lt;figcaption>image-20210923150100196&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>è¿™æ ·ä¸€æ¥è‡³å°‘å›¾å½¢è§†å›¾å°±èƒ½çœ‹äº†ã€‚ç²—ç•¥æ‰«ä¸€çœ¼ï¼Œåœ¨åº•ä¸‹æ‰¾åˆ°&lt;code>IsSameAs&lt;/code>è¿™ä¸ªè°ƒç”¨ï¼Œå†å¾€å›ç¿»å“ªå„¿åŠ¨äº†&lt;code>esi&lt;/code>è¿™ä¸ªå¯„å­˜å™¨ï¼Œå¾ˆå¿«æ‰¾åˆ°è¿™ä¸¤æ®µã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-03/11.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-03/11.png"
loading="lazy"
alt="image-20210923150438821">
&lt;/a>
&lt;figcaption>image-20210923150438821&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æœ‰ç‚¹æ‚ï¼Œå…ˆçœ‹çœ‹ã€‚è¿˜æ˜¯ç²—ç•¥æŒ‰æ„å›¾æŠŠæŒ‡ä»¤åˆ†ä¸‹æ®µã€‚&lt;code>esi&lt;/code>æ¥æºæ¶‰åŠ&lt;code>eax&lt;/code>å’Œ&lt;code>ecx&lt;/code>ï¼Œä¸€è·¯è·Ÿç€èµ‹å€¼è·¯å¾„å¾€å›ç¿»åˆ°ç¬¬ä¸€ä¸ªå—ï¼Œæ‰¾åˆ°&lt;code>ecx&lt;/code>çš„èµ‹å€¼ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="err">0&lt;/span>&lt;span class="nf">x004062f1&lt;/span> &lt;span class="no">e8&lt;/span> &lt;span class="mi">68&lt;/span> &lt;span class="no">b3&lt;/span> &lt;span class="no">ff&lt;/span> &lt;span class="no">ff&lt;/span> &lt;span class="no">call&lt;/span> &lt;span class="no">fcn.0040165e&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x004062f6&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="no">b&lt;/span> &lt;span class="mi">08&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">ecx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸€ä¸ªæœªçŸ¥å‡½æ•°ï¼Œctrl+å·¦é”®ç‚¹å‡»è·Ÿè¿›å»åå‘ç°ç–‘ä¼¼æ˜¯ libcrypto å†…è”çš„å‡½æ•°ï¼Œè°ƒç”¨äº† HMAC-SHA1 ç®—æ³•ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-03/12.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-03/12.png"
loading="lazy"
alt="image-20210924092624224">
&lt;/a>
&lt;figcaption>image-20210924092624224&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å…ˆåšä¸ªæ ‡è®°ï¼ŒçŒœæµ‹å‡è®¾è¿™ä¸ªå‡½æ•°æ­£ç¡®è¿”å›ï¼ˆä¸‹é¢çš„jeè·³è½¬èµ°åˆ°æœ€åä¸€ä¸ªå—ï¼‰ï¼Œé‚£è¿”å›ç»“æœåº”è¯¥æ˜¯HMAC-SHA1çš„ç»“æœã€‚è¿™é‡Œé€šè¿‡è°ƒè¯•å™¨å•æ­¥éªŒè¯ã€‚&lt;/p>
&lt;p>å› ä¸º ASLR çš„ç¼˜æ•…ï¼Œå¯æ‰§è¡Œæ–‡ä»¶ .text æ®µæ˜ å°„çš„åœ°å€ä¸æ˜¯ 0x00401000ï¼Œè°ƒè¯•å™¨æ²¡æ³•ç›´æ¥è½¬åˆ°é™æ€åˆ†æå·¥å…·ä¸­çš„åœ°å€ï¼ŒASLR ç¡®å®æŠ˜ç£¨äºº&amp;hellip;&lt;/p>
&lt;p>anyway&amp;hellip;&lt;/p>
&lt;p>æˆ‘æŠ•ç¿”ï¼Œç‰¹ç«‹ç‹¬è¡Œæ˜¯æ²¡å¥½ç»“æœçš„ï¼Œè·‘å»ä¸‹è½½äº†ä¸€ä¸ª IDA Free ï¼Œæ‰“å¼€x32dbgç¡®è®¤ .text æ®µæ˜ å°„çš„åŸºå€åå†åˆ° IDA çš„èœå• &lt;code>Edit&lt;/code> -&amp;gt; &lt;code>Segments&lt;/code> -&amp;gt; &lt;code>rebase program ...&lt;/code> é‡æ–°è®¾å®šé•œåƒåŸºå€ï¼Œè¿™æ ·åœ¨åæ±‡ç¼–ç•Œé¢çœ‹åˆ°çš„åœ°å€å°±èƒ½å’Œè°ƒè¯•å™¨å¯¹ä¸Šäº†ã€‚ç¼ºé™·æ˜¯æ¯æ¬¡æ‰“å¼€è°ƒè¯•å™¨éƒ½è¦å¯¹ä¸€æ¬¡é•œåƒåŸºå€ï¼Œæ¯”è¾ƒéº»çƒ¦ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-03/image-20210924154631893.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-03/image-20210924154631893.png"
loading="lazy"
alt="image-20210924154631893">
&lt;/a>
&lt;figcaption>image-20210924154631893&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å¯¹å¥½é•œåƒåŸºå€åï¼ŒæŠŠä¹‹å‰æƒ³è°ƒè¯•çš„å‡½æ•°è°ƒç”¨åœ°å€æ‰¾åˆ°ï¼ˆ0x003B62F1ï¼‰ï¼Œä¸‹ä¸ªæ–­ç‚¹ï¼Œçœ‹è°ƒç”¨åçš„&lt;code>eax&lt;/code>å€¼ï¼Œå‘ç°å¹¶ä¸åƒçº¯cç¼–è¯‘å‡ºæ¥çš„ç»“æœï¼Œ&lt;code>eax&lt;/code>å¹¶æ²¡æœ‰ä»€ä¹ˆåµç”¨ã€‚&lt;/p>
&lt;p>ç¨å¾®å¾€ä¸ŠçŸäº†ä¸€çœ¼ï¼Œå¾ˆå®¹æ˜“çœ‹åˆ°ä¸€ä¸ª&lt;code>mov ecx,esi&lt;/code>ï¼Œä½†æ²¡ä»€ä¹ˆåµç”¨ã€‚&lt;/p>
&lt;p>ç¢°å£å‡ æ¬¡åå†³å®šè·Ÿè¿›è¿™ä¸ªå‡½æ•°çœ‹çœ‹ã€‚æ— æœã€‚æ¼ï¼Œä½œå¼Šä¹‹ï¼ˆè¯»è¿‡RFCå¯èƒ½æ³¨æ„åˆ°å‡ ä¸ªç‰¹æ®Šå¸¸é‡ï¼Œæ¯”å¦‚å–å“ˆå¸Œç»“æœä¸‹æ ‡19ï¼Œä¸0xfï¼Œä½œä¸ºåç§»å€¼å‘åå†å–4å­—èŠ‚ï¼Œä½œä¸ºbin codeã€‚è·³è¿‡è¿™ä¸ªå‡½æ•°è°ƒç”¨ï¼Œç›´æ¥çœ‹æ¥ä¸‹æ¥çš„å†…å®¹çš„è¯ï¼Œä¼šå‘ç°å“ˆå¸Œå€¼å…¶å®å°±å­˜åœ¨&lt;code>ecx&lt;/code>ä¿å­˜çš„åœ°å€ä¸Šäº†ã€‚ï¼‰&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-03/image-20210924162043275.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-03/image-20210924162043275.png"
loading="lazy"
alt="image-20210924162043275">
&lt;/a>
&lt;figcaption>image-20210924162043275&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>åªæ˜¯è¿™é‡Œçš„HMAC_SHA1å€¼å› ä¸ºä¸æ˜¯æˆ‘ä»¬ç†Ÿæ‚‰çš„ASCIIè¡¨ç¤ºï¼Œæ‰€ä»¥ä¸€çœ¼æœ‰ç‚¹éš¾çœ‹å‡ºæ¥ã€‚&lt;/p>
&lt;p>é‚£ä¹ˆç›´æ¥è·³è¿‡ä¸Šé¢ä¸æ¸…ä¸æ¥šçš„åœ°æ–¹ï¼Œç›´æ¥çœ‹å–å“ˆå¸Œåçš„åšæ³•ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nl">.text:&lt;/span>&lt;span class="err">003&lt;/span>&lt;span class="nf">B6307&lt;/span> &lt;span class="no">movzx&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">byte&lt;/span> &lt;span class="no">ptr&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ecx&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">13&lt;/span>&lt;span class="no">h&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nl">.text:&lt;/span>&lt;span class="err">003&lt;/span>&lt;span class="nf">B630B&lt;/span> &lt;span class="no">and&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="no">Fh&lt;/span> &lt;span class="c">; å– hash[19] &amp;amp; 0xf ä½œä¸ºåˆå§‹åç§»
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">.text&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">003&lt;/span>&lt;span class="no">B630E&lt;/span> &lt;span class="no">add&lt;/span> &lt;span class="no">ecx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">eax&lt;/span>
&lt;span class="nl">.text:&lt;/span>&lt;span class="err">003&lt;/span>&lt;span class="nf">B6310&lt;/span> &lt;span class="no">movzx&lt;/span> &lt;span class="no">esi&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">byte&lt;/span> &lt;span class="no">ptr&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ecx&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; å–åç§»å¤„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œæ— ç¬¦å·
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">.text&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">003&lt;/span>&lt;span class="no">B6313&lt;/span> &lt;span class="no">movzx&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">byte&lt;/span> &lt;span class="no">ptr&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ecx&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; å–åç§»å¤„ç¬¬äºŒä¸ªå­—èŠ‚ï¼Œæ— ç¬¦å·
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">.text&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">003&lt;/span>&lt;span class="no">B6317&lt;/span> &lt;span class="no">and&lt;/span> &lt;span class="no">esi&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">7&lt;/span>&lt;span class="no">Fh&lt;/span> &lt;span class="c">; åç§»å¤„ç¬¬ä¸€ä¸ªå­—èŠ‚ &amp;amp; 0x7f ï¼Œç¡®ä¿ç¬¦å·ä½å½’é›¶
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">.text&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">003&lt;/span>&lt;span class="no">B631A&lt;/span> &lt;span class="no">shl&lt;/span> &lt;span class="no">esi&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">8&lt;/span> &lt;span class="c">; ç¬¬ä¸€ä¸ªå­—èŠ‚å·¦ç§»8ä½å | ç¬¬äºŒä¸ªå­—èŠ‚ï¼Œå°±æ˜¯æŠŠå››ä¸ªå­—èŠ‚æŒ‰é¡ºåºå¡«è¿›esi
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">.text&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">003&lt;/span>&lt;span class="no">B631D&lt;/span> &lt;span class="no">or&lt;/span> &lt;span class="no">esi&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">eax&lt;/span>
&lt;span class="nl">.text:&lt;/span>&lt;span class="err">003&lt;/span>&lt;span class="nf">B631F&lt;/span> &lt;span class="no">movzx&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">byte&lt;/span> &lt;span class="no">ptr&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ecx&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nl">.text:&lt;/span>&lt;span class="err">003&lt;/span>&lt;span class="nf">B6323&lt;/span> &lt;span class="no">shl&lt;/span> &lt;span class="no">esi&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">8&lt;/span>
&lt;span class="nl">.text:&lt;/span>&lt;span class="err">003&lt;/span>&lt;span class="nf">B6326&lt;/span> &lt;span class="no">or&lt;/span> &lt;span class="no">esi&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">eax&lt;/span>
&lt;span class="nl">.text:&lt;/span>&lt;span class="err">003&lt;/span>&lt;span class="nf">B6328&lt;/span> &lt;span class="no">movzx&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">byte&lt;/span> &lt;span class="no">ptr&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ecx&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nl">.text:&lt;/span>&lt;span class="err">003&lt;/span>&lt;span class="nf">B632C&lt;/span> &lt;span class="no">shl&lt;/span> &lt;span class="no">esi&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">8&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å–å¾—çš„å°±æ˜¯4å­—èŠ‚æ­£æ•´æ•°äº†ï¼ŒæŒ‰RFCçš„ä¾‹å­ï¼Œæ¥ä¸‹æ¥åº”è¯¥å–æ¨¡å¾—åˆ°æœ€å¤§6ä½æ•´æ•°ã€‚çœ‹ä¸‹ä¸€å—æ±‡ç¼–ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nl">.text:&lt;/span>&lt;span class="err">003&lt;/span>&lt;span class="nf">B6331&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">ecx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="no">Block&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nl">.text:&lt;/span>&lt;span class="err">003&lt;/span>&lt;span class="nf">B6334&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">431&lt;/span>&lt;span class="no">BDE83h&lt;/span> &lt;span class="c">; magic ?
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">.text&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">003&lt;/span>&lt;span class="no">B6339&lt;/span> &lt;span class="no">imul&lt;/span> &lt;span class="no">esi&lt;/span>
&lt;span class="nl">.text:&lt;/span>&lt;span class="err">003&lt;/span>&lt;span class="nf">B633B&lt;/span> &lt;span class="no">sar&lt;/span> &lt;span class="no">edx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">12&lt;/span>&lt;span class="no">h&lt;/span>
&lt;span class="nl">.text:&lt;/span>&lt;span class="err">003&lt;/span>&lt;span class="nf">B633E&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">edx&lt;/span>
&lt;span class="nl">.text:&lt;/span>&lt;span class="err">003&lt;/span>&lt;span class="nf">B6340&lt;/span> &lt;span class="no">shr&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="no">Fh&lt;/span>
&lt;span class="nl">.text:&lt;/span>&lt;span class="err">003&lt;/span>&lt;span class="nf">B6343&lt;/span> &lt;span class="no">add&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">edx&lt;/span>
&lt;span class="nl">.text:&lt;/span>&lt;span class="err">003&lt;/span>&lt;span class="nf">B6345&lt;/span> &lt;span class="no">imul&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="no">F4240h&lt;/span>
&lt;span class="nl">.text:&lt;/span>&lt;span class="err">003&lt;/span>&lt;span class="nf">B634B&lt;/span> &lt;span class="no">sub&lt;/span> &lt;span class="no">esi&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">eax&lt;/span>
&lt;span class="nl">.text:&lt;/span>&lt;span class="err">003&lt;/span>&lt;span class="nf">B634D&lt;/span> &lt;span class="no">test&lt;/span> &lt;span class="no">ecx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">ecx&lt;/span>
&lt;span class="nl">.text:&lt;/span>&lt;span class="err">003&lt;/span>&lt;span class="nf">B634F&lt;/span> &lt;span class="no">jz&lt;/span> &lt;span class="no">short&lt;/span> &lt;span class="no">loc_3B638F&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>431BDE83h&lt;/code> è¿™ä¸ªé­”æœ¯å¸¸é‡å“åˆ°æˆ‘äº†ã€‚æœäº†ä¸€ä¸‹æ‰¾åˆ°ç¯‡&lt;a class="link" href="https://bbs.pediy.com/thread-100189.htm" target="_blank" rel="noopener"
>çœ‹é›ªçš„å¸–å­&lt;/a>ï¼Œçœ‹èµ·æ¥æ˜¯ç¼–è¯‘å™¨æŠŠä¸€å¥&lt;code>%1000000&lt;/code>å–æ¨¡ç»™ç¼–è¯‘æˆäº†ä¸Šé¢è¿™ä¸€ä¸²æ»¡æ˜¯é­”æ•°çš„æ±‡ç¼–ã€‚å°è¯•è·Ÿåˆ° &lt;code>sub esi,eax&lt;/code> åï¼Œ&lt;code>esi&lt;/code> å¯„å­˜å™¨çš„ç»“æœçš„ç¡®å˜æˆäº†6ä½ä»¥å†…çš„æ•´æ•°ã€‚&lt;/p>
&lt;p>è¿™ç©æ„å„¿æœ‰ä»€ä¹ˆç‰¹å¾å—ï¼Ÿæ€»ä¸è‡³äºå¤šåšå‡ æ¬¡å–æ¨¡ï¼Œç”Ÿæˆçš„æ±‡ç¼–å°±å®Œå…¨æ²¡æ³•çœ‹äº†å§ã€‚ã€‚ã€‚&lt;/p>
&lt;h2 id="keygen">keygenï¼Ÿ&lt;/h2>
&lt;p>å®åŠ›æœ‰é™ï¼Œå°½ç®¡äº²æ‰‹å†™ä¸‹çš„C++ä»£ç çœŸçš„å¾ˆç®€å•ï¼Œä½†ç¼–è¯‘åçš„ç»“æœæˆäº†æ— æ³•æ‰¿å—ä¹‹é‡&amp;hellip;&lt;/p>
&lt;p>ä¸Šé¢åˆ†æçš„å†…å®¹ï¼Œå…¶å®ä»”ç»†å¯¹ç€RFCæ¨æ•²ï¼ˆé¦–å…ˆï¼Œä½ å¾—çŸ¥é“æ˜¯ç…§ç€RFCå†™çš„ï¼Œä¸ç„¶å°±å¤šè¯»å‡ éæ±‡ç¼–&amp;hellip;ï¼‰ï¼Œæ‰èƒ½å¾ˆå‹‰å¼ºå¾—åˆ°ä¸ªç²—ç³™çš„ç®—æ³•ï¼Œè‡³äºèƒ½ä¸èƒ½å†™å‡º keygenï¼Œæˆ‘æ²¡å•¥ä¿¡å¿ƒã€‚&lt;/p>
&lt;h2 id="ç»“è®º">ç»“è®º&lt;/h2>
&lt;p>å¾ˆéš¾ã€‚&lt;/p>
&lt;p>å¦‚æœè¯´å‰é¢çš„ C ä»£ç æ˜¯å°æ¸¸æˆçš„è¯ï¼Œé‚£ cm03 å°±æ˜¯åœ°çƒonlineã€‚å¼€å¯ä¼˜åŒ–çš„C++æ— é—´åœ°ç‹±ã€‚&lt;/p>
&lt;p>å®Œå…¨æºƒè´¥ã€‚&lt;/p></description></item><item><title>è‡ªå¨±è‡ªä¹ crackme-02</title><link>https://nnnewb.github.io/blog/p/crackme-02/</link><pubDate>Wed, 15 Sep 2021 15:43:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/crackme-02/</guid><description>&lt;h2 id="å¾—æœ‰ä¸ªå‰è¨€">å¾—æœ‰ä¸ªå‰è¨€&lt;/h2>
&lt;p>æ€»ä¹‹ä¸Šä¸€ä¸ª crackme-01 è¿˜è¿‡å¾—å»ï¼Œç¨å¾®åŠ å¼ºä¸€ç‚¹ï¼ŒæŠŠå¯†ç éšè—èµ·æ¥ï¼Œä¸è¦éšä¾¿è¢«çœ‹åˆ°ã€‚&lt;/p>
&lt;h2 id="0x01-æºç ">0x01 æºç &lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdio.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdlib.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;string.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="n">size_t&lt;/span> &lt;span class="nf">getline&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">lineptr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">size_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">FILE&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">stream&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">bufptr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">bufptr&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">size_t&lt;/span> &lt;span class="n">size&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">c&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">lineptr&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">stream&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">n&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">bufptr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">lineptr&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">c&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fgetc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stream&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">c&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">EOF&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">bufptr&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">bufptr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">malloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">bufptr&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">128&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">p&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">bufptr&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">c&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">EOF&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">p&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">bufptr&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">size&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">size&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">128&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">bufptr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">realloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">bufptr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">size&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">bufptr&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="o">*&lt;/span>&lt;span class="n">p&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">c&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">c&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="sc">&amp;#39;\n&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">c&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fgetc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stream&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="o">*&lt;/span>&lt;span class="n">p&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="sc">&amp;#39;\0&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="o">*&lt;/span>&lt;span class="n">lineptr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">bufptr&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="o">*&lt;/span>&lt;span class="n">n&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">size&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">p&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">bufptr&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">size_t&lt;/span> &lt;span class="nf">r_trim&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">str&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">size_t&lt;/span> &lt;span class="n">len&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">size_t&lt;/span> &lt;span class="n">slen&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">strnlen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">str&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">len&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">size_t&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">slen&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">str&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="sc">&amp;#39; &amp;#39;&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">str&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="sc">&amp;#39;\n&amp;#39;&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">str&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="sc">&amp;#39;\r&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">str&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="sc">&amp;#39;\0&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">strnlen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">str&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">len&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nf">calculate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">username&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="n">size_t&lt;/span> &lt;span class="n">username_len&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// åˆå§‹åŒ–å›ºå®š8å­—èŠ‚è®¡ç®—å¯†é’¥çš„ç©ºé—´
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="n">size_t&lt;/span> &lt;span class="n">input_buf_len&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">input_buf&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">malloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">input_buf_len&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">size_t&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">input_buf_len&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">input_buf&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mh">0x52&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// ç”¨ç”¨æˆ·è¾“å…¥æ›¿æ¢åˆå§‹åŒ–çš„æ•°æ®
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">memcpy_s&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">input_buf&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">input_buf_len&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">username&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">username_len&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// å¼‚æˆ–å¤„ç†
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">size_t&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">input_buf_len&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">input_buf&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">^=&lt;/span> &lt;span class="mh">0x25&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// åˆå§‹åŒ– Hex è¾“å‡º
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="n">size_t&lt;/span> &lt;span class="n">output_buf_len&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">17&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">output_buf&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">malloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">output_buf_len&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// è½¬ä¸ºå¯è¯»å­—ç¬¦ä¸²
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">size_t&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">input_buf_len&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">output_buf&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="s">&amp;#34;%02x&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">input_buf&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">output_buf&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">16&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">free&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">input_buf&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">output_buf&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">username&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">size_t&lt;/span> &lt;span class="n">username_len&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">serial&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">size_t&lt;/span> &lt;span class="n">serial_len&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">size_t&lt;/span> &lt;span class="n">linesize&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;username:&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">linesize&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">getline&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">username&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">username_len&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">stdin&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">username_len&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">r_trim&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">username&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">linesize&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">username_len&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">free&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">username&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">puts&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;username less than 8 letter&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">continue&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">username_len&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">free&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">username&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">continue&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;serial:&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">linesize&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">getline&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">serial&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">serial_len&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">stdin&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">serial_len&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">r_trim&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serial&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">linesize&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">serial_len&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">16&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">free&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">username&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">free&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serial&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">puts&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;serial has 16 letters&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">continue&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">correct&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">calculate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">username&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">username_len&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">rc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">strncmp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serial&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">correct&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">16&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">rc&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">free&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">correct&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">puts&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Good job!&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">puts&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;wrong pwd!&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">free&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">username&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">free&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">serial&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">free&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">correct&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç¼–è¯‘æ–¹å¼æ˜¯&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-batch" data-lang="batch">clang main.c -o cm02-easy.exe -Wall -m32 -O0
clang main.c -o cm02-normal.exe -Wall -m32 -O1
clang main.c -o cm02-hard.exe -Wall -m32 -O2
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="0x02-è§‚å¯Ÿ">0x02 è§‚å¯Ÿ&lt;/h2>
&lt;p>å¯åŠ¨åè§‚å¯Ÿè¡Œä¸ºï¼ˆä¸æˆªå›¾äº†ã€‚ï¼‰&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">weakptr in cm02 â¯ .\cm02-easy.exe
username:abc
serial:123456
serial é•¿åº¦ä¸º16
username:abc
serial:123456789012345
wrong pwd!
username:
serial:
serial é•¿åº¦ä¸º16
username:abc
serial:aaaaaaaaaaaaaaa
wrong pwd!
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™æ¬¡çš„ç›®æ ‡æ˜¯ï¼š&lt;/p>
&lt;ol>
&lt;li>å¾—åˆ°æŸä¸ªç”¨æˆ·åå¯¹åº”çš„åºåˆ—å·ï¼ˆ&lt;code>serial&lt;/code>ï¼‰ã€‚&lt;/li>
&lt;li>ç ´è§£ï¼Œæ€»æ˜¯æ­£ç¡®æˆ–å¯¹ä»»ä½•è¾“å…¥éƒ½æç¤ºæ­£ç¡®ã€‚&lt;/li>
&lt;li>æ³¨å†Œæœºã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="0x03-é™æ€åˆ†æ---easy">0x03 é™æ€åˆ†æ - easy&lt;/h2>
&lt;h3 id="31-ä¸»å¾ªç¯">3.1 ä¸»å¾ªç¯&lt;/h3>
&lt;p>åœ¨å…¬å¸æ²¡IDAï¼Œç”¨ &lt;a class="link" href="image/crackme-02/https://cutter.re/" >Cutter&lt;/a> æ‰“å¼€ï¼Œåœ¨ä¸Šæ–¹è¾“å…¥æ¡†è¾“å…¥ &lt;code>main&lt;/code> è·³è½¬åˆ° &lt;code>main&lt;/code> å‡½æ•°ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-1.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-1.png"
loading="lazy"
alt="image-20210914114426600">
&lt;/a>
&lt;figcaption>image-20210914114426600&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>ç„¶åç‚¹å‡» &lt;em>å›¾è¡¨ï¼ˆmainï¼‰&lt;/em> è¿›å…¥ç±»ä¼¼ IDA çš„æ§åˆ¶æµè§†å›¾ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-2.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-2.png"
loading="lazy"
alt="image-20210914114547128">
&lt;/a>
&lt;figcaption>image-20210914114547128&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>ä¹‹åå°±èƒ½çœ‹åˆ°ä¸‹é¢çš„æ§åˆ¶æµäº†ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-3.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-3.png"
loading="lazy"
>
&lt;/a>
&lt;/figure>&lt;/p>
&lt;p>easyéš¾åº¦ä¸‹æ²¡æœ‰å¼€å¯ä»»ä½•ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œæ§åˆ¶æµå’ŒåŸå§‹ä»£ç èƒ½ç›´æ¥å¯¹åº”ä¸Šã€‚ç§ç€å›°éš¾å¾ˆå¤šå¯¹å§ï¼Ÿ&lt;/p>
&lt;p>å…ˆç®€å•æ‰«ä¸€çœ¼ï¼Œä¼šå‘ç°å¾ˆå¤šåˆ†æ”¯ç›´æ¥è·³å›äº†&lt;code>0x0040139d&lt;/code>ï¼Œä¹Ÿå°±æ˜¯ä»ä¸Šå¾€ä¸‹æ•°ç¬¬äºŒä¸ªä»£ç å—ï¼ŒåŸºæœ¬æ¯ä¸ªè·³è½¬éƒ½æ˜¯ä¸‹ä¸€ä¸ªå—æˆ–è·³å›è¿™ä¸ªå—ã€‚æŒ‰ç…§ &lt;a class="link" href="https://nnnewb.github.io/blog/p/crackme-01/" target="_blank" rel="noopener"
>cm01&lt;/a>çš„ç»éªŒï¼Œæˆ‘ä»¬å…ˆæ‰¾åˆ°å…³é”®çš„ä¸€è·³ã€‚å¯ä»¥ç›´æ¥æœç´¢å­—ç¬¦ä¸²å¼•ç”¨ï¼ˆ&lt;code>wrong pwd!&lt;/code>ï¼‰ï¼Œä¹Ÿå¯ä»¥é€ä¸ªä»£ç å—çœ‹ä¸‹å»ã€‚&lt;/p>
&lt;p>å¾ˆå¿«ï¼Œå³ä¸‹è§’çš„å…³é”®è·³å‡ºç°åœ¨çœ¼å‰ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-4.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-4.png"
loading="lazy"
alt="image-20210914152834262">
&lt;/a>
&lt;figcaption>image-20210914152834262&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æ¥ç€å›å¤´çœ‹è·³è½¬æ¡ä»¶ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-5.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-5.png"
loading="lazy"
alt="image-20210914153728179">
&lt;/a>
&lt;figcaption>image-20210914153728179&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>è™½ç„¶æ²¡æœ‰åå­—ï¼Œä½†&lt;code>fcn.00403ef4&lt;/code> æ˜¯è€ç†Ÿäººäº†ã€‚ä¸‰ä¸ªå‚æ•°ï¼Œ&lt;code>ecx&lt;/code>ã€&lt;code>eax&lt;/code>ã€&lt;code>0x10&lt;/code>ï¼Œè¿”å›ç»“æœå’Œ&lt;code>0&lt;/code>åšæ¯”è¾ƒï¼Œ&lt;code>jne&lt;/code>æ¡ä»¶è·³è½¬ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;code>cmp&lt;/code>æŒ‡ä»¤ï¼Œæ“ä½œæ•°ç›¸å‡ï¼ˆ&lt;code>dest&lt;/code>-&lt;code>src&lt;/code>ï¼‰ï¼Œç»“æœå­˜å…¥æ ‡å¿—ä½ &lt;code>SF&lt;/code>å’Œ&lt;code>ZF&lt;/code>ã€‚
&lt;ul>
&lt;li>ç»“æœæ˜¯è´Ÿæ•°ï¼ˆ&lt;code>dest&lt;/code>&amp;lt;&lt;code>src&lt;/code>ï¼‰ï¼Œ&lt;code>SF&lt;/code>ä¹Ÿå°±æ˜¯ç»“æœç¬¦å·ä½è®¾ç½®ä¸º1ã€‚&lt;/li>
&lt;li>ç»“æœæ˜¯æ­£æ•°ï¼ˆ&lt;code>dest&lt;/code>&amp;gt;&lt;code>src&lt;/code>ï¼‰ï¼Œ&lt;code>SF&lt;/code>ä¹Ÿå°±æ˜¯ç»“æœç¬¦å·ä½è®¾ç½®ä¸º0ã€‚&lt;/li>
&lt;li>ç»“æœæ˜¯0ï¼ˆ&lt;code>dest&lt;/code>=&lt;code>src&lt;/code>ï¼‰ï¼Œ&lt;code>ZF&lt;/code>è®¾ç½®ä¸º1ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;code>jne&lt;/code>æˆ–&lt;code>jnz&lt;/code>æŒ‡ä»¤ï¼Œéé›¶è·³è½¬ã€‚&lt;code>ZF&lt;/code>æ ‡å¿—ä½ä¸º&lt;code>1&lt;/code>æ—¶è·³è½¬ã€‚&lt;/li>
&lt;/ul>
&lt;p>çŒœæµ‹è¿™ä¸ªå‡½æ•°åº”è¯¥æ˜¯&lt;code>strncmp&lt;/code>ã€‚ç»§ç»­å¾€å›çœ‹å‚æ•°æ˜¯æ€ä¹ˆæ¥çš„ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-6.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-6.png"
loading="lazy"
alt="image-20210914155544252">
&lt;/a>
&lt;figcaption>image-20210914155544252&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>&lt;code>eax&lt;/code>æ¥è‡ª&lt;code>sub.02x_40298c&lt;/code>è¿™ä¸ªå‡½æ•°ï¼Œåé¢ä¸¤ä¸ªè„±è£¤å­æ”¾å±çš„&lt;code>mov&lt;/code>å¿½ç•¥ã€‚&lt;code>ecx&lt;/code>åˆ™æ¥æ¥è‡ª&lt;code>mov ecx,dword [ebp-10h]&lt;/code>è¿™ä¸€è¡Œã€‚&lt;/p>
&lt;p>å…ˆä¸ç€æ€¥åˆ†æå‡½æ•°ï¼Œç»§ç»­å¾€å›æ‰¾ï¼Œæ‰¾åˆ°&lt;code>[ebp-10h]&lt;/code>çš„æ¥æºã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-7.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-7.png"
loading="lazy"
alt="image-20210914161814604">
&lt;/a>
&lt;figcaption>image-20210914161814604&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>åœ¨å…¥å£ç‚¹é™„è¿‘ï¼Œçœ‹åˆ°&lt;code>[ebp-10]&lt;/code>è¢«åˆå§‹åŒ–æˆäº†0ã€‚&lt;/p>
&lt;p>å› ä¸ºæ²¡æœ‰å¾ˆæ˜ç¡®çš„è·¯å¾„ï¼Œæ‰‹åŠ¨è®¡ç®—æ ˆä¸Šåç§»åˆéå¸¸éº»çƒ¦ï¼Œè¿™é‡Œæœ¬åº”è¯¥æå‡ºè°ƒè¯•å™¨â€”â€”ä½†å‡ºäºå­¦ä¹ ç»ƒæ‰‹çš„ç›®çš„ï¼Œè¿˜æ˜¯å…ˆå°è¯•è®¡ç®—ä¸‹ã€‚é¦–å…ˆå›é¡¾ä¸‹ç®€åŒ–çš„æ ˆå†…å­˜å¸ƒå±€ï¼Œä»ä¸Šå¾€ä¸‹å¢é•¿ï¼Œå¦‚å›¾ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-8.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-8.png"
loading="lazy"
alt="stack-layout">
&lt;/a>
&lt;figcaption>stack-layout&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æ¥ä¸‹æ¥ä»&lt;code>mov ebp,esp&lt;/code>å¼€å§‹ï¼Œå¾€ä¸‹åˆ—å‡ºæ‰€æœ‰å‡½æ•°è°ƒç”¨ï¼Œæ‹ä¸€æ‹é€»è¾‘ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-9.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-9.png"
loading="lazy"
alt="image-20210914214920437">
&lt;/a>
&lt;figcaption>image-20210914214920437&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>ç¬¬ä¸€ä¸ªæ¡†ï¼Œ&lt;code>[esp+2ch+Ix]&lt;/code> è®¡ç®—ç»“æœæ˜¯ &lt;code>[esp]&lt;/code>ï¼Œä¹Ÿå°±æ˜¯æ ˆé¡¶ï¼Œæ ˆé¡¶è®¾ç½®ä¸ºå­—ç¬¦ä¸² &lt;code>username:&lt;/code>ï¼Œæ¥ç€è°ƒç”¨ä¸€ä¸ªæœªçŸ¥å‡½æ•°ã€‚ä»å‚æ•°åˆ¤æ–­æˆ‘ä»¬å…ˆè®¤ä¸ºæ˜¯ä¸€ä¸ªè¾“å‡ºå­—ç¬¦ä¸²çš„å‡½æ•°ã€‚&lt;/p>
&lt;p>å†çœ‹ç¬¬äºŒä¸ªæ¡†ï¼Œ&lt;code>acrt_iob_func&lt;/code>ï¼Œç™¾åº¦ä¸€ä¸‹å°±ä¼šå‘ç°ï¼Œ&lt;code>__acrt_iob_func&lt;/code>å‡½æ•°æ˜¯å®šä¹‰äº c è¿è¡Œåº“é‡Œçš„å‡½æ•°ï¼Œä½œç”¨æ˜¯è¿”å› &lt;code>stdin/stdout/stderr&lt;/code> ã€‚æ ˆé¡¶è®¾ç½®ä¸º0ï¼Œæ‰€ä»¥è·å¾—çš„æ˜¯ &lt;code>stdin&lt;/code>ã€‚&lt;/p>
&lt;p>å†çœ‹ç¬¬ä¸‰ä¸ªæ¡†ï¼Œ&lt;code>edx&lt;/code>å’Œ&lt;code>ecx&lt;/code>èµ‹å€¼ä¸ºæ ˆä¸Šä¸¤ä¸ªå˜é‡çš„åœ°å€ï¼Œå†ä¸ºå‚æ•°ã€‚æŒ‰é¡ºåºå°±æ˜¯&lt;code>f(edx,ecx,stdin)&lt;/code>ã€‚æš‚æ—¶ä¸æ˜ã€‚å‡½æ•°è¿”å›å€¼è¢«èµ‹å€¼å›äº†&lt;code>[ebp-18h]&lt;/code>ã€‚&lt;/p>
&lt;p>ç¬¬å››ä¸ªæ¡†ï¼Œä»ç¬¬ä¸‰ä¸ªæ¡†å¾—åˆ°çš„è¿”å›å€¼è¢«å½“å‚æ•°ä¼ ç»™ä¸€ä¸ªæœªçŸ¥å‡½æ•°ã€‚&lt;code>f([ebp-8h], [ebp-18h])&lt;/code>ï¼Œè¿”å›å€¼è¢«èµ‹å€¼å› &lt;code>[ebp-0Ch]&lt;/code>ã€‚&lt;/p>
&lt;p>ç»“åˆæœ€åçš„ &lt;code>cmp&lt;/code> å’Œ &lt;code>jbe&lt;/code> æŒ‡ä»¤åˆ†æï¼Œäººè‚‰åç¼–è¯‘åç”¨ä¼ªä»£ç è¡¨ç¤ºï¼Œå°±æ˜¯ä¸‹é¢è¿™æ ·ã€‚&lt;code>jbe&lt;/code>æŒ‡ä»¤åªåœ¨&lt;code>cmp&lt;/code>å·¦æ“ä½œæ•°å°äºç­‰äºå³æ“ä½œæ•°æ—¶æ‰§è¡Œè·³è½¬ï¼ˆ&lt;code>CF&lt;/code>æ ‡å¿—ä½å’Œ&lt;code>ZF&lt;/code>æ ‡å¿—ä½å…¶ä¸­ä¸€ä¸ªä¸º1æ—¶ï¼‰ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">var&lt;/span> &lt;span class="n">var_8&lt;/span> &lt;span class="c1"># åç§»å€¼ ebp-8h&lt;/span>
&lt;span class="n">var&lt;/span> &lt;span class="n">var_0C&lt;/span> &lt;span class="c1"># åç§»å€¼ ebp-0Ch&lt;/span>
&lt;span class="n">var&lt;/span> &lt;span class="n">var_18&lt;/span> &lt;span class="c1"># åç§»å€¼ ebp-18h&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;username:&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">var_18&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">unknown_func1&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">var_8&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">var_0c&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">stdin&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">var_0c&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">unknown_func2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">var_8&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">var_18&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="n">var_0c&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="o">...&lt;/span> &lt;span class="c1"># jbe è·³è½¬æ‰§è¡Œ&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-10.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-10.png"
loading="lazy"
alt="image-20210914223919137">
&lt;/a>
&lt;figcaption>image-20210914223919137&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å¯ä»¥çœ‹å‡ºï¼Œå½“ &lt;code>var_0c&lt;/code> å°äº 8 æ—¶ï¼Œæç¤º &lt;code>username less than 8 letter&lt;/code> ã€‚å› æ­¤å¯ä»¥ç¡®å®š &lt;code>[ebp-0Ch]&lt;/code> è¿™ä¸ªå˜é‡å°±æ˜¯ &lt;code>username&lt;/code> å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œä¸Šä¸€ä¸ªå‡½æ•°ä¼šè®¡ç®—å­—ç¬¦ä¸²é•¿åº¦è¿”å›ã€‚æˆ‘ä»¬å†æ ¹æ®è¿™ä¸ªå‘ç°ä¿®æ”¹ä¸‹ä¼ªä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">var&lt;/span> &lt;span class="n">var_8&lt;/span> &lt;span class="c1"># åç§»å€¼ ebp-8h&lt;/span>
&lt;span class="n">var&lt;/span> &lt;span class="n">username_len&lt;/span> &lt;span class="c1"># åç§»å€¼ ebp-0Ch&lt;/span>
&lt;span class="n">var&lt;/span> &lt;span class="n">var_18&lt;/span> &lt;span class="c1"># åç§»å€¼ ebp-18h&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;username:&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">var_18&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">unknown_func1&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">var_8&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">username_len&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">stdin&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># var_8 å¯èƒ½æ˜¯ username æŒ‡é’ˆ&lt;/span>
&lt;span class="n">username_len&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">unknown_func2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">var_8&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">var_18&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># è®¡ç®—å­—ç¬¦ä¸²é•¿åº¦&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="n">username_len&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="o">...&lt;/span> &lt;span class="c1"># jbe è·³è½¬æ‰§è¡Œ&lt;/span>
&lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="c1"># jmp åˆ°å¼€å¤´&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç¬¬ä¸€ä¸ªæœªçŸ¥å‡½æ•°çœ‹èµ·æ¥å·²ç»å‘¼ä¹‹æ¬²å‡ºäº†ï¼Œ&lt;code>stdin&lt;/code>å’Œ&lt;code>&amp;amp;username_len&lt;/code>ä½œä¸ºå‚æ•°ï¼Œ&lt;code>var_8&lt;/code> æœ‰æå¤§å¯èƒ½å°±æ˜¯&lt;code>username&lt;/code>å­—ç¬¦ä¸²æŒ‡é’ˆã€‚ä¸è¿‡åœ¨è¿›å…¥è°ƒè¯•å™¨å‰ï¼Œè¿˜ä¸èƒ½é©¬ä¸Šä¸‹ç»“è®ºï¼Œç»§ç»­çœ‹æ­£ç¡®è·³è½¬çš„ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nf">cmp&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp-0Ch&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="nf">jnz&lt;/span> &lt;span class="no">...&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™æ¬¡æ˜¯æ¯”è¾ƒç”¨æˆ·åé•¿åº¦å’Œ0ï¼Œé0è·³è½¬ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-11.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-11.png"
loading="lazy"
alt="image-20210914224625891">
&lt;/a>
&lt;figcaption>image-20210914224625891&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å¯ä»¥çœ‹åˆ°ä¸ºé›¶æ—¶ï¼Œç»è¿‡ä¸€ä¸ªæœªçŸ¥å‡½æ•° &lt;code>sub_4036FC(var_8)&lt;/code> åï¼Œè·³å›å¼€å¤´ã€‚&lt;/p>
&lt;p>ç»§ç»­çœ‹æ­£ç¡®æµç¨‹ï¼Œ&lt;code>jmp $+5&lt;/code> ï¼Œ&lt;code>$&lt;/code> è¡¨ç¤ºå½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»£ç åœ¨ä»£ç æ®µå†…çš„åç§»é‡ï¼Œ+5å°±æ˜¯ä»å½“å‰ä»£ç å¼€å§‹å¾€åè·³è¿‡5ä¸ªå­—èŠ‚ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹IDAåˆ†æå¥½çš„è·³è½¬ä½ç½®ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-12.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-12.png"
loading="lazy"
alt="image-20210914225052452">
&lt;/a>
&lt;figcaption>image-20210914225052452&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>åˆæ˜¯éå¸¸ç†Ÿæ‚‰çš„ä»£ç ï¼Œå’Œè¯»å– &lt;code>username&lt;/code> çš„åˆ†ææ–¹å¼ç›¸åŒï¼Œä»¥ç›¸åŒçš„é¡ºåºè°ƒç”¨ç›¸åŒçš„å‡½æ•°ï¼Œå¯ä»¥å¾—åˆ°&lt;code>var_14&lt;/code>æ˜¯&lt;code>serial_len&lt;/code>ï¼Œ&lt;code>Str1&lt;/code>å¯èƒ½æ˜¯&lt;code>serial&lt;/code>å­—ç¬¦ä¸²æŒ‡é’ˆã€‚ä¸åšé‡å¤åˆ†æï¼Œç»§ç»­å¾€ä¸‹çœ‹ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-13.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-13.png"
loading="lazy"
alt="image-20210914225322787">
&lt;/a>
&lt;figcaption>image-20210914225322787&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å³è¾¹çš„ä»£ç å—æ˜¯å…³äºé•¿åº¦çš„åˆ¤æ–­ï¼Œåˆ†ææ–¹æ³•ä¸å†é‡å¤ã€‚å·¦ä¾§ä»£ç å°±æ˜¯æˆ‘ä»¬çš„å…³é”®è·³è½¬äº†ï¼Œå…¶ä¸­å‡ºç°ä¸¤ä¸ªå‡½æ•°è°ƒç”¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nf">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="no">var_C&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">ecx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="no">Block&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">esp&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="no">Ch&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="no">Ix&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">ecx&lt;/span> &lt;span class="c">; void *
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">mov&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">esp&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="no">Ch&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="no">Str2&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; size_t
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">call&lt;/span> &lt;span class="no">sub_401250&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="no">var_1C&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">eax&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>var_c&lt;/code>å…ˆå‰è¢«åˆ¤æ–­æ˜¯&lt;code>username_len&lt;/code>ï¼Œ&lt;code>Block&lt;/code>å°±æ˜¯&lt;code>var_8&lt;/code>ï¼Œå…ˆå‰è¢«æ€€ç–‘æ˜¯ç”¨æˆ·é”®å…¥çš„ç”¨æˆ·åå­—ç¬¦ä¸²æŒ‡é’ˆã€‚æœªçŸ¥å‡½æ•°çš„è¿”å›å€¼ä¿å­˜åœ¨ &lt;code>[ebp-1ch]&lt;/code>ä¸­ã€‚&lt;/p>
&lt;p>è¿™ä¸ª&lt;code>1c&lt;/code>åœ¨éšåçš„ä»£ç ä¸­ç«‹åˆ»è¢«ç”¨åˆ°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nf">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="no">var_1C&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">ecx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="no">Str1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">esp&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="no">Ch&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="no">Ix&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">ecx&lt;/span> &lt;span class="c">; Str1
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">mov&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">esp&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="no">Ch&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="no">Str2&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; Str2
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">mov&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">esp&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="no">Ch&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="no">MaxCount&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="no">h&lt;/span> &lt;span class="c">; MaxCount
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">call&lt;/span> &lt;span class="no">_strncmp&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="no">var_20&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">eax&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>Str1&lt;/code>åœ¨&lt;code>serial&lt;/code>è¾“å…¥è¿™ä¸€æ­¥è¢«æ€€ç–‘æ˜¯ç”¨æˆ·è¾“å…¥çš„åºåˆ—å·å­—ç¬¦ä¸²æŒ‡é’ˆï¼Œå®ƒå’Œä¸Šä¸€ä¸ªå‡½æ•°è°ƒç”¨è¿”å›çš„&lt;code>var_1c&lt;/code>è¢«ä½œä¸ºå‚æ•°ä¼ é€’ç»™&lt;code>strncmp&lt;/code>ï¼Œå­—ç¬¦ä¸²é•¿åº¦æœ€å¤§16å­—èŠ‚ã€‚ç”±æ­¤å¯è§ï¼Œ&lt;code>var_1c&lt;/code>åŸºæœ¬å¯ä»¥ç¡®å®šæ˜¯æ­£ç¡®åºåˆ—å·çš„æŒ‡é’ˆï¼Œä¹‹å‰çš„æœªçŸ¥å‡½æ•°å¯èƒ½å°±æ˜¯ç”Ÿæˆåºåˆ—å·çš„å‡½æ•°ã€‚&lt;/p>
&lt;p>ä¸‹ä¸€æ­¥åˆ†æåºåˆ—å·ç”Ÿæˆå‡½æ•°ã€‚&lt;/p>
&lt;h3 id="32-ç”Ÿæˆåºåˆ—å·">3.2 ç”Ÿæˆåºåˆ—å·&lt;/h3>
&lt;p>å…ˆçœ‹ä¸‹æ§åˆ¶æµå…¨è§ˆï¼Œèƒ½ä¾ç¨€åˆ†è¾¨å‡ºä¸‰ä¸ªå¾ªç¯ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-14.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-14.png"
loading="lazy"
alt="generate">
&lt;/a>
&lt;figcaption>generate&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>è‡ªåŠ¨åˆ†æå‡ºçš„å˜é‡è¡¨&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="c">; var uint32_t var_1ch @ ebp-0x1c
&lt;/span>&lt;span class="c">; var int32_t var_18h @ ebp-0x18
&lt;/span>&lt;span class="c">; var int32_t var_14h @ ebp-0x14
&lt;/span>&lt;span class="c">; var uint32_t var_10h @ ebp-0x10
&lt;/span>&lt;span class="c">; var uint32_t var_ch @ ebp-0xc
&lt;/span>&lt;span class="c">; var int32_t var_8h @ ebp-0x8
&lt;/span>&lt;span class="c">; var int32_t var_4h @ ebp-0x4
&lt;/span>&lt;span class="c">; arg uint32_t arg_8h @ ebp+0x8
&lt;/span>&lt;span class="c">; arg int32_t arg_ch @ ebp+0xc
&lt;/span>&lt;span class="c">; var int32_t var_sp_4h @ esp+0x4
&lt;/span>&lt;span class="c">; var int32_t var_sp_8h @ esp+0x8
&lt;/span>&lt;span class="c">; var int32_t var_sp_ch @ esp+0xc
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…ˆçœ‹å¾ªç¯å¤–çš„ä»£ç ï¼Œç®€å•æŒ‰ç”¨é€”åˆ’ä¸€ä¸‹åˆ†éš”çº¿ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="err">0&lt;/span>&lt;span class="nf">x004071f0&lt;/span> &lt;span class="no">push&lt;/span> &lt;span class="no">ebp&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x004071f1&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">ebp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">esp&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x004071f3&lt;/span> &lt;span class="no">sub&lt;/span> &lt;span class="no">esp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0x2c&lt;/span>
&lt;span class="c">; ---
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="err">0&lt;/span>&lt;span class="nf">x004071f6&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">arg_ch&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x004071f9&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">arg_8h&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="c">; ---
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="err">0&lt;/span>&lt;span class="nf">x004071fc&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_4h&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="mi">8&lt;/span>
&lt;span class="c">; ---
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="err">0&lt;/span>&lt;span class="nf">x00407203&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">esp&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="mi">8&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x0040720a&lt;/span> &lt;span class="no">call&lt;/span> &lt;span class="no">fcn.00401302&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x0040720f&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_8h&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">eax&lt;/span>
&lt;span class="c">; ---
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="err">0&lt;/span>&lt;span class="nf">x00407212&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_ch&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¼€å¤´æ˜¯æƒ¯ä¾‹çš„ä¸¤å¥æ ˆå¸§å‡†å¤‡åŠ¨ä½œï¼Œéšåå¼€è¾Ÿ 0x2c å¤§å°çš„æ ˆç©ºé—´ã€‚&lt;/p>
&lt;p>ä¸¤ä¸ªæ²¡ç”¨çš„ &lt;code>mov eax,...&lt;/code>ï¼Œä¹‹åæ˜¯&lt;code>[ebp-4h]&lt;/code>è®¾ç½®ä¸º8ï¼Œå†æŠŠ8ä½œä¸ºå‚æ•°è°ƒç”¨äº†ä¸€ä¸ªæœªçŸ¥å‡½æ•°ï¼Œè¿”å›å€¼èµ‹å€¼ç»™&lt;code>[ebp-8h]&lt;/code>ï¼Œå†åˆå§‹åŒ–&lt;code>[ebp-ch]&lt;/code>ä¸º 0ã€‚ä¼ªä»£ç è¡¨ç¤ºå°±æ˜¯ä¸‹é¢è¿™æ ·ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="kt">int&lt;/span> &lt;span class="n">var_4h&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">var_8h&lt;/span>&lt;span class="err">ï¼Œ&lt;/span> &lt;span class="n">var_ch&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// ebp-4h, ebp-8h, ebp-ch
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">var_4h&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mh">0x8&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">var_8h&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">unknown_func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mh">0x8&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">var_ch&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mh">0x0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶åæ˜¯ä¸€ä¸ªæ¡ä»¶è·³è½¬ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="err">0&lt;/span>&lt;span class="nf">x00407219&lt;/span> &lt;span class="no">cmp&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_ch&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="mi">8&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x0040721d&lt;/span> &lt;span class="no">jae&lt;/span> &lt;span class="mi">0x407242&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å­¦ä¹ ä¸‹&lt;code>jae&lt;/code>æŒ‡ä»¤ã€‚&lt;code>jae&lt;/code>æŒ‡ä»¤å’Œ&lt;code>jnc&lt;/code>æŒ‡ä»¤ç›¸åŒï¼Œ&lt;code>CF=0&lt;/code>åˆ™è·³è½¬ã€‚&lt;code>jae&lt;/code> å¯ä»¥çœ‹ä½œ &lt;em>Jump if above or equals&lt;/em>ã€‚ä¸Šä¸€å¥ &lt;code>cmp&lt;/code> è®¡ç®— &lt;code>var_ch - 0x8&lt;/code> ï¼Œå¯¹ç›¸å…³æ ‡å¿—ä½èµ‹å€¼ã€‚&lt;code>jae&lt;/code>æŒ‡ä»¤æ ¹æ®&lt;code>CF&lt;/code>æ ‡å¿—ä½åˆ¤æ–­ï¼Œç”±äº&lt;code>cmp&lt;/code>æŒ‡ä»¤æ˜¯å‡æ³•ï¼Œæ‰€ä»¥åˆ¤æ–­çš„æ˜¯å‡æ³•ä¸­æœ‰æ²¡æœ‰å‡ºç° &lt;em>å€Ÿä½&lt;/em> ã€‚&lt;/p>
&lt;p>ç®€å•çš„æè¿°å°±æ˜¯ï¼Œ&lt;code>cmp ax, bx&lt;/code>ï¼Œå¦‚æœ&lt;code>ax &amp;lt; bx&lt;/code> åˆ™ &lt;code>CF=1&lt;/code>ï¼Œå¦‚æœ &lt;code>ax &amp;gt;= bx&lt;/code> åˆ™ &lt;code>CF=0&lt;/code>ã€‚&lt;/p>
&lt;p>å› ä¸ºæˆ‘ä»¬çŸ¥é“ &lt;code>var_ch&lt;/code> åˆšè¢«åˆå§‹åŒ–æˆäº†0ï¼Œä¸æˆç«‹ï¼Œç»§ç»­çœ‹ä¸æˆç«‹çš„åˆ†æ”¯ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="err">0&lt;/span>&lt;span class="nf">x00407223&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_ch&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x00407226&lt;/span> &lt;span class="no">add&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0x52&lt;/span> &lt;span class="c">; 82
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="mi">0x00407229&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">dl&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">al&lt;/span>
&lt;span class="c">; ---
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="err">0&lt;/span>&lt;span class="nf">x0040722b&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_8h&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x0040722e&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">ecx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_ch&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x00407231&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">byte&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax&lt;/span> &lt;span class="err">+&lt;/span> &lt;span class="no">ecx&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">dl&lt;/span>
&lt;span class="c">; ---
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="err">0&lt;/span>&lt;span class="nf">x00407234&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_ch&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x00407237&lt;/span> &lt;span class="no">add&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x0040723a&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_ch&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">eax&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x0040723d&lt;/span> &lt;span class="no">jmp&lt;/span> &lt;span class="mi">0x407219&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æŠŠ&lt;code>var_ch&lt;/code>ç§»å…¥å¯„å­˜å™¨&lt;code>eax&lt;/code>åï¼ŒåŠ ä¸Š&lt;code>0x52&lt;/code>ï¼Œåˆç§»åŠ¨&lt;code>al&lt;/code>åˆ°&lt;code>dl&lt;/code>ã€‚åç»­&lt;code>eax&lt;/code>è¢«ç”¨ä½œåˆ«çš„ç”¨é€”ï¼Œè¿™ä¸€ç•ªæ“ä½œå…¶å®å°±æ˜¯ç»™&lt;code>dl&lt;/code>èµ‹å€¼äº†ä¸€ä¸ª&lt;code>(int16_t)0x52+var_ch&lt;/code>ã€‚&lt;/p>
&lt;p>éšåæŠŠ&lt;code>var_8h&lt;/code>å’Œ&lt;code>var_ch&lt;/code>ç›¸åŠ åçš„åœ°å€èµ‹å€¼ &lt;code>dl&lt;/code>ï¼Œä¹Ÿå°±æ˜¯&lt;code>0x52&lt;/code>ã€‚&lt;/p>
&lt;p>æ¥ç€&lt;code>var_ch&lt;/code>è‡ªå¢1ï¼Œè·³å› &lt;code>jae&lt;/code>åˆ¤æ–­å‰çš„ &lt;code>cmp&lt;/code>ï¼Œå½¢æˆå¾ªç¯ï¼Œæˆ‘ä»¬ç”¨ä¼ªä»£ç è¡¨ç¤ºã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="kt">int&lt;/span> &lt;span class="n">var_4h&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">var_8h&lt;/span>&lt;span class="err">ï¼Œ&lt;/span> &lt;span class="n">var_ch&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// ebp-4h, ebp-8h, ebp-ch
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">var_4h&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mh">0x8&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">var_8h&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">unknown_func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mh">0x8&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">var_ch&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mh">0x0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">while&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">var_ch&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">*&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">var_8h&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">var_ch&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mh">0x52&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">var_ch&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">var_ch&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»ç»“æ„ä¸Šçœ‹ï¼Œæ˜¯ä¸€ä¸ªå…¸å‹çš„ for å¾ªç¯ã€‚ &lt;code>var_8h&lt;/code> æ˜¯ä¸€ä¸ªæœªçŸ¥å‡½æ•°è¿”å›çš„æŒ‡é’ˆã€‚æˆ‘ä»¬ç¨å¾®æ”¹ä¸‹ä¼ªä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="kt">int&lt;/span> &lt;span class="n">var_4h&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">var_8h&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// ebp-4h, ebp-8h
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">var_4h&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mh">0x8&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">var_8h&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">unknown_func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mh">0x8&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">var_ch&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">var_ch&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">var_ch&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// var_ch -&amp;gt; ebp-ch
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">var_8h&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">var_ch&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mh">0x52&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">var_ch&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¥ç€ç»§ç»­çœ‹å¾ªç¯ç»“æŸåçš„ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="err">0&lt;/span>&lt;span class="nf">x00407242&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">arg_ch&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; ebp+ch å‡½æ•°å³å¾€å·¦æ•°ç¬¬äºŒä¸ªå…¥å‚
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="mi">0x00407245&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">ecx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">arg_8h&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; ebp+8h å‡½æ•°å³å¾€å·¦æ•°ç¬¬ä¸€ä¸ªå…¥å‚
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="mi">0x00407248&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">edx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_8h&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c">; ebp-8h
&lt;/span>&lt;span class="c">; ---
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="mi">0x0040724b&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">esp&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">edx&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x0040724e&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_sp_4h&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="mi">8&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x00407256&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_sp_8h&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">ecx&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x0040725a&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_sp_ch&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">eax&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x0040725e&lt;/span> &lt;span class="no">call&lt;/span> &lt;span class="no">fcn.00407310&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x00407263&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_10h&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»ä¹‹å‰åˆ†æä¸»å¾ªç¯çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç° &lt;code>arg_8h&lt;/code> å…¶å®æ˜¯ç”¨æˆ·åå­—ç¬¦ä¸²æŒ‡é’ˆï¼Œ&lt;code>arg_ch&lt;/code>æ˜¯ç”¨æˆ·åå­—ç¬¦ä¸²é•¿åº¦ã€‚&lt;/p>
&lt;p>æ¥ç€è¿™ä¸¤ä¸ªå…¥å‚ï¼Œå’Œ &lt;code>var_8h&lt;/code>ï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰å¾—åˆ°æŒ‡é’ˆï¼Œä¼ å…¥ä¸€ä¸ªæœªçŸ¥å‡½æ•°ï¼Œéšåå†åˆå§‹åŒ–äº†ä¸€ä¸ªå˜é‡ &lt;code>var_10h&lt;/code>ã€‚&lt;/p>
&lt;p>ä¼ªä»£ç å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="n">unknown_func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">var_8h&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mh">0x8&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">username&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">username_len&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// çŒœæµ‹çš„å‡½æ•°ç­¾å func(void*, int, void*, int)
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">var_10h&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¥ç€åˆæ˜¯ä¸€ä¸ªæ¡ä»¶è·³è½¬ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="err">0&lt;/span>&lt;span class="nf">x0040726a&lt;/span> &lt;span class="no">cmp&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_10h&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="mi">8&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x0040726e&lt;/span> &lt;span class="no">jae&lt;/span> &lt;span class="mi">0x407292&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å’Œå…ˆå‰çš„å¾ªç¯ç›¸åŒï¼Œä¸ä½œé‡å¤åˆ†æï¼Œç›´æ¥è¿›å…¥å¾ªç¯ä½“ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="err">0&lt;/span>&lt;span class="nf">x00407274&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_8h&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x00407277&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">ecx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_10h&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x0040727a&lt;/span> &lt;span class="no">movsx&lt;/span> &lt;span class="no">edx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">byte&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax&lt;/span> &lt;span class="err">+&lt;/span> &lt;span class="no">ecx&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x0040727e&lt;/span> &lt;span class="no">xor&lt;/span> &lt;span class="no">edx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0x25&lt;/span> &lt;span class="c">; 37
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="mi">0x00407281&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">byte&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax&lt;/span> &lt;span class="err">+&lt;/span> &lt;span class="no">ecx&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">dl&lt;/span>
&lt;span class="c">; ---
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="err">0&lt;/span>&lt;span class="nf">x00407284&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_10h&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x00407287&lt;/span> &lt;span class="no">add&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x0040728a&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_10h&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">eax&lt;/span>
&lt;span class="c">; ---
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="err">0&lt;/span>&lt;span class="nf">x0040728d&lt;/span> &lt;span class="no">jmp&lt;/span> &lt;span class="mi">0x40726a&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å‰ä¸¤æ¡æŒ‡ä»¤æ²¡ä»€ä¹ˆå¯è¯´çš„ï¼Œ&lt;code>movsx&lt;/code>è¿˜æ˜¯ç¬¬ä¸€æ¬¡è§ï¼Œå­¦ä¹ ä¸‹ã€‚&lt;/p>
&lt;p>&lt;code>movsx&lt;/code> ä»æ¥æºå–æ•°ï¼Œä¸è¶³çš„éƒ¨åˆ†ç”¨æ¥æºçš„ç¬¦å·ä½å¡«å……ï¼Œè¿™é‡Œå–çš„æ˜¯&lt;code>var_8h[var_10h]&lt;/code>ï¼Œä¸€å­—èŠ‚ï¼Œåˆ° &lt;code>edx&lt;/code> å¯„å­˜å™¨ã€‚&lt;code>movsx&lt;/code>çš„å¥½å¤„æ˜¯å¯ä»¥ä¿ç•™ç¬¦å·ä½ï¼ŒåŠ è½½ä¸åŒå¤§å°çš„æ•°æ®æ—¶ï¼ˆæ¯”å¦‚æ¥æºæ˜¯ &lt;code>word&lt;/code>ï¼Œç›®æ ‡æ˜¯ &lt;code>dword&lt;/code>ï¼‰ï¼Œå¦‚æœæ¥æºæ˜¯è´Ÿæ•°ï¼Œåˆ™å¡«å……ç¬¦å·ä½å¯ä»¥æ­£ç¡®è¡¨ç¤ºè¡¥ç å½¢å¼è¡¨ç¤ºçš„è´Ÿæ•°ã€‚&lt;/p>
&lt;p>ä»&lt;code>var_8h[var_10h]&lt;/code>å–æ•°ç§»å…¥&lt;code>edx&lt;/code> åï¼Œä¹‹åæ˜¯ä¸€å¥ç®€å•çš„ &lt;code>xor&lt;/code>ï¼Œé€»è¾‘å¼‚æˆ–è¿ç®—ã€‚ä¹‹åå°†&lt;code>xor&lt;/code>è¿ç®—ç»“æœå–ä½ä½1å­—èŠ‚ï¼ˆ&lt;code>dl&lt;/code>å¯„å­˜å™¨ï¼‰ç§»å›&lt;code>var_8h[var_10h]&lt;/code>ã€‚&lt;/p>
&lt;p>ä¹‹åè‡ªå¢ï¼Œè·³è½¬å¾ªç¯ï¼Œå’Œä¹‹å‰çš„å¾ªç¯ä¸€æ ·ã€‚å°†åˆ†æè¿‡çš„éƒ¨åˆ†ç”¨ä¼ªä»£ç è¡¨ç¤ºå¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="kt">int&lt;/span> &lt;span class="n">var_4h&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">var_8h&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// ebp-4h, ebp-8h
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">var_4h&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mh">0x8&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">var_8h&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">unknown_func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mh">0x8&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">var_ch&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">var_ch&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">var_ch&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// var_ch -&amp;gt; ebp-ch
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">var_8h&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">var_ch&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mh">0x52&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">var_ch&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">unknown_func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">var_8h&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mh">0x8&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">username&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">username_len&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// çŒœæµ‹çš„å‡½æ•°ç­¾å func(void*, int, void*, int)
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">var_10h&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">var_10h&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">var_10h&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// var_10h -&amp;gt; ebp-10h
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">var_8h&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">var_10h&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">^=&lt;/span> &lt;span class="mh">0x25&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç»§ç»­çœ‹å¾ªç¯ç»“æŸåçš„åŠ¨ä½œã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="err">0&lt;/span>&lt;span class="nf">x00407292&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_14h&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="mi">0x11&lt;/span> &lt;span class="c">; 17
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="mi">0x00407299&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">esp&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="mi">0x11&lt;/span> &lt;span class="c">; [0x11:4]=-1 ; 17
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="mi">0x004072a0&lt;/span> &lt;span class="no">call&lt;/span> &lt;span class="no">fcn.00401302&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x004072a5&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_18h&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">eax&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x004072a8&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_1ch&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œè¿”å›å€¼èµ‹å€¼ç»™&lt;code>var_18h&lt;/code>ï¼ŒåŒæ—¶åˆå§‹åŒ–&lt;code>var_1ch&lt;/code>ä¸º 0ã€‚ä¼ªä»£ç è¡¨ç¤ºå¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="kt">int&lt;/span> &lt;span class="n">var_14h&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mh">0x11&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">var_18h&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">unknown_func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mh">0x11&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">var_1ch&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mh">0x0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¥ä¸‹æ¥åˆæ˜¯ä¸€ä¸ªå¾ªç¯ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="err">0&lt;/span>&lt;span class="nf">x004072af&lt;/span> &lt;span class="no">cmp&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_1ch&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="mi">8&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x004072b3&lt;/span> &lt;span class="no">jae&lt;/span> &lt;span class="mi">0x4072f2&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸é‡å¤åˆ†æï¼Œè¿›å…¥å¾ªç¯ä½“ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="err">0&lt;/span>&lt;span class="nf">x004072b9&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_8h&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x004072bc&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">ecx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_1ch&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x004072bf&lt;/span> &lt;span class="no">movsx&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">byte&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax&lt;/span> &lt;span class="err">+&lt;/span> &lt;span class="no">ecx&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x004072c3&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">edx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_18h&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x004072c6&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">ecx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_1ch&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="c">; ---
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="err">0&lt;/span>&lt;span class="nf">x004072c9&lt;/span> &lt;span class="no">shl&lt;/span> &lt;span class="no">ecx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x004072cc&lt;/span> &lt;span class="no">add&lt;/span> &lt;span class="no">edx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">ecx&lt;/span>
&lt;span class="c">; ---
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="err">0&lt;/span>&lt;span class="nf">x004072ce&lt;/span> &lt;span class="no">lea&lt;/span> &lt;span class="no">ecx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">str.02x&lt;/span> &lt;span class="c">; 0x45de50ï¼Œå†…å®¹æ˜¯ %02x
&lt;/span>&lt;span class="c">; ---
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="mi">0x004072d4&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">esp&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">edx&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x004072d7&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_sp_4h&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">ecx&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x004072db&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_sp_8h&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">eax&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x004072df&lt;/span> &lt;span class="no">call&lt;/span> &lt;span class="no">fcn.00403dcd&lt;/span>
&lt;span class="c">; ---
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="err">0&lt;/span>&lt;span class="nf">x004072e4&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_1ch&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x004072e7&lt;/span> &lt;span class="no">add&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x004072ea&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_1ch&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">eax&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x004072ed&lt;/span> &lt;span class="no">jmp&lt;/span> &lt;span class="mi">0x4072af&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¾ç„¶æ˜¯ä» &lt;code>var_8h[var_1ch]&lt;/code> å–æ•°ï¼Œä¹‹åæŠŠ &lt;code>var_18h&lt;/code> å’Œ &lt;code>var_1ch&lt;/code> ä¹Ÿå–æ•°ï¼Œåˆ†åˆ«æ”¾åˆ° &lt;code>eax&lt;/code>ã€&lt;code>edx&lt;/code>ã€&lt;code>ecx&lt;/code>ã€‚&lt;/p>
&lt;p>æ¥ç€æ˜¯ä¸€ä¸ªæ²¡è§è¿‡çš„å‘½ä»¤ï¼Œ&lt;code>shl&lt;/code>ï¼Œå­¦ä¹ ä¸‹ã€‚&lt;/p>
&lt;p>&lt;code>shl&lt;/code>æ˜¯é€»è¾‘å·¦ç§»ï¼Œå’Œ c ä¸­çš„ &lt;code>&amp;lt;&amp;lt;&lt;/code> è¿ç®—ç¬¦ä¸€æ ·ï¼Œä¸¤ä¸ªæ“ä½œæ•°ï¼Œå‘½ä»¤æ ¼å¼&lt;code>shl å¯„å­˜å™¨,ç«‹å³æ•°&lt;/code>ã€‚&lt;/p>
&lt;p>è¿™é‡Œåšçš„å°±æ˜¯ &lt;code>ecx&lt;/code>ï¼Œä¹Ÿå°±æ˜¯ &lt;code>var_1ch&lt;/code> çš„å€¼å·¦ç§»1ä½ï¼Œä¼—æ‰€å‘¨çŸ¥å·¦ç§»nä½å¯ä»¥çœ‹ä½œä¹˜ä¸Š2^n^ ï¼Œæ‰€ä»¥è¿™å¥ &lt;code>shl&lt;/code> å…¶å®å°±æ˜¯ &lt;code>var_1ch*2&lt;/code>ã€‚å·¦ç§»åç»“æœåŠ åˆ°äº†&lt;code>edx&lt;/code>ï¼Œ&lt;code>edx&lt;/code>æ˜¯&lt;code>var_18h&lt;/code>ã€‚&lt;/p>
&lt;p>ä¹‹åæ˜¯ä¸€ä¸ª&lt;code>lea&lt;/code>ï¼ŒåŠ è½½åœ°å€ï¼Œå†…å®¹æ˜¯å¸¸é‡å­—ç¬¦ä¸² &lt;code>%02x&lt;/code>ï¼Œçœ‹èµ·æ¥æ˜¯ä¸€ä¸ª c æ ¼å¼åŒ–å­—ç¬¦ä¸²ã€‚&lt;/p>
&lt;p>æ¥ç€å‹æ ˆä¼ å‚ï¼Œè°ƒç”¨æœªçŸ¥å‡½æ•°ï¼Œç»“æœå¿½ç•¥ã€‚ä¼ªä»£ç è¡¨ç¤ºå¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="n">unknown_func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">var_18h&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">var_1ch&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;%02x&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">var_8h&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">var_1ch&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>éšåæ˜¯å˜é‡è‡ªå¢ï¼Œè·³è½¬å›å¾ªç¯å¼€å¤´ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬æŠŠåˆ†æå‡ºæ¥çš„ä¼ªä»£ç å†åˆå¹¶ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="kt">int&lt;/span> &lt;span class="n">var_4h&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">var_8h&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// ebp-4h, ebp-8h
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">var_4h&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mh">0x8&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">var_8h&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">unknown_func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mh">0x8&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">var_ch&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">var_ch&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">var_ch&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// var_ch -&amp;gt; ebp-ch
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">var_8h&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">var_ch&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mh">0x52&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">var_ch&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">unknown_func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">var_8h&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mh">0x8&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">username&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">username_len&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// çŒœæµ‹çš„å‡½æ•°ç­¾å func(void*, int, void*, int)
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">var_10h&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">var_10h&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">var_10h&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// var_10h -&amp;gt; ebp-10h
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">var_8h&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">var_10h&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">^=&lt;/span> &lt;span class="mh">0x25&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">var_14h&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mh">0x11&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">var_18h&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">unknown_func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mh">0x11&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">for&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">var_1ch&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mh">0x0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">var_1ch&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">var_1ch&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">unknown_func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">var_18h&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">var_1ch&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;%02x&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">var_8h&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">var_1ch&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ€åæ˜¯å¾ªç¯ç»“æŸåçš„ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="err">0&lt;/span>&lt;span class="nf">x004072f2&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_18h&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x004072f5&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">byte&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">eax&lt;/span> &lt;span class="err">+&lt;/span> &lt;span class="mi">0x10&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="c">; ---
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="err">0&lt;/span>&lt;span class="nf">x004072f9&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_8h&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x004072fc&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">esp&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">eax&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x004072ff&lt;/span> &lt;span class="no">call&lt;/span> &lt;span class="no">fcn.00402a36&lt;/span>
&lt;span class="c">; ---
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="err">0&lt;/span>&lt;span class="nf">x00407304&lt;/span> &lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">dword&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">var_18h&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="c">; ---
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="err">0&lt;/span>&lt;span class="nf">x00407307&lt;/span> &lt;span class="no">add&lt;/span> &lt;span class="no">esp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0x2c&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x0040730a&lt;/span> &lt;span class="no">pop&lt;/span> &lt;span class="no">ebp&lt;/span>
&lt;span class="err">0&lt;/span>&lt;span class="nf">x0040730b&lt;/span> &lt;span class="no">ret&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>é¦–å…ˆæ˜¯æŠŠ&lt;code>var_18h[0x10]&lt;/code> çš„å€¼è®¾ä¸º0ã€‚&lt;/p>
&lt;p>æ¥ç€&lt;code>var_8h&lt;/code>åšå‚æ•°è°ƒæœªçŸ¥å‡½æ•°ã€‚&lt;/p>
&lt;p>æŠŠ&lt;code>var_18h&lt;/code>ç§»åˆ°&lt;code>eax&lt;/code>ï¼Œä¹Ÿå°±æ˜¯&lt;code>cdecl&lt;/code>çº¦å®šä¸‹çš„è¿”å›å€¼ä½ç½®ã€‚&lt;/p>
&lt;p>æœ€åå¹³æ ˆï¼Œæ¢å¤&lt;code>ebp&lt;/code>ï¼Œè¿”å›ï¼Œå‡½æ•°ç»“æŸã€‚æˆ‘ä»¬æŠŠæ‰€æœ‰å†…å®¹çš„ä¼ªä»£ç åˆå¹¶èµ·æ¥ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="kt">int&lt;/span> &lt;span class="n">var_4h&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mh">0x8&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// ebp-4h
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="o">*&lt;/span> &lt;span class="n">var_8h&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">unknown_func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mh">0x8&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// ebp-8h
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">var_ch&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">var_ch&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">var_ch&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// var_ch -&amp;gt; ebp-ch
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">var_8h&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">var_ch&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mh">0x52&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">var_ch&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">unknown_func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">var_8h&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mh">0x8&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">username&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">username_len&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// çŒœæµ‹çš„å‡½æ•°ç­¾å func(void*, int, void*, int)
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">var_10h&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">var_10h&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">var_10h&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// var_10h -&amp;gt; ebp-10h
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">var_8h&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">var_10h&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">^=&lt;/span> &lt;span class="mh">0x25&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">var_14h&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mh">0x11&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">var_18h&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">unknown_func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mh">0x11&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">for&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">var_1ch&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mh">0x0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">var_1ch&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">var_1ch&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">unknown_func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">var_18h&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">var_1ch&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;%02x&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">var_8h&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">var_1ch&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">var_18h&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mh">0x10&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">unknown_func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">var_8h&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">var_18h&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»è¿™æˆ‘ä»¬å·²ç»èƒ½çœ‹å‡ºå…·ä½“ç®—æ³•äº†ï¼ŒæœªçŸ¥å‡½æ•°å¯ä»¥çŒœæµ‹è°ƒè¯•çœ‹çœ‹ã€‚&lt;/p>
&lt;h2 id="0x04-è°ƒè¯•å™¨---easy">0x04 è°ƒè¯•å™¨ - easy&lt;/h2>
&lt;p>è°ƒè¯•çš„ç›®æ ‡æ˜¯ç¡®è®¤ç”Ÿæˆåºåˆ—å·çš„ç®—æ³•ï¼ŒæŠŠåˆ†æå‡ºçš„ä¼ªä»£ç ä¸­è¿˜ä¸æ¸…æ¥šç”¨é€”çš„æœªçŸ¥å‡½æ•°ï¼Œåˆ†æå‡ºä½œç”¨ã€‚&lt;/p>
&lt;h3 id="41-x32dbg">4.1 x32dbg&lt;/h3>
&lt;p>æ‰“å¼€è°ƒè¯•å™¨åï¼Œå…ˆæ‰¾åˆ°å…³é”®è·³ï¼Œåœ¨å·¥å…·æ ç‚¹å‡»å­—ç¬¦ä¸²å·¥å…·å›¾æ ‡ï¼Œåœ¨ä¸‹æ–¹æœç´¢æ è¾“å…¥&lt;code>wrong pwd!&lt;/code>&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-15.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-15.png"
loading="lazy"
alt="image-20210915140718400">
&lt;/a>
&lt;figcaption>image-20210915140718400&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>è·³åˆ°å¼•ç”¨ä½ç½®ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-18.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-18.png"
loading="lazy"
alt="image-20210915111455604">
&lt;/a>
&lt;figcaption>image-20210915111455604&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-19.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-19.png"
loading="lazy"
alt="image-20210915111621678">
&lt;/a>
&lt;figcaption>image-20210915111621678&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>ä¹‹åå¯ä»¥æŒ‰gï¼Œè¿›å…¥æ§åˆ¶æµè§†å›¾ï¼Œä¸è¿‡è¿™ä¸ªæ§åˆ¶æµè§†å›¾æœ‰ç‚¹ä¸å¥½çœ‹ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥å‚è€ƒé™æ€åˆ†æä¸­çš„æ±‡ç¼–ï¼Œç›´æ¥æ‰¾åˆ°å‡½æ•°ï¼Œå¹¶åœ¨å…¥å£ä¸‹æ–­ç‚¹ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-20.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-20.png"
loading="lazy"
alt="image-20210915112358449">
&lt;/a>
&lt;figcaption>image-20210915112358449&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å°è¯•éšä¾¿è¾“å…¥ä¸€ç‚¹å†…å®¹ï¼Œè°ƒè¯•å™¨å‘½ä¸­ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-21.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-21.png"
loading="lazy"
alt="image-20210915112552389">
&lt;/a>
&lt;figcaption>image-20210915112552389&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æ¥ä¸‹æ¥å°±å¯ä»¥ç”¨å·¦ä¸Šè§’çš„å•æ­¥è°ƒè¯•äº†ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-22.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-22.png"
loading="lazy"
alt="image-20210915140939909">
&lt;/a>
&lt;figcaption>image-20210915140939909&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>ä¸åšæ›´å¤šä»‹ç»ï¼Œæ±‡ç¼–çš„åˆ†æå·²ç»è¿›è¡Œè¿‡ä¸€æ¬¡ã€‚è¿™æ¬¡æˆ‘ä»¬æ‰¾åˆ°å¯¹è¾“å…¥ &amp;ldquo;abc&amp;rdquo; çš„æ­£ç¡®åºåˆ—å·ï¼Œå®Œæˆä¸€æ¬¡è§£å¯†ã€‚&lt;/p>
&lt;p>åªéœ€è¦åœ¨æ–­ç‚¹å¤„ç‚¹å‡»&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-23.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-23.png"
loading="lazy"
alt="image-20210915141120060">
&lt;/a>
&lt;figcaption>image-20210915141120060&lt;/figcaption>
&lt;/figure>æŒ‰é’®ï¼Œç„¶åè§‚å¯Ÿ&lt;code>eax&lt;/code>å¯„å­˜å™¨ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-24.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-24.png"
loading="lazy"
alt="image-20210915141405302">
&lt;/a>
&lt;figcaption>image-20210915141405302&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æŠ„å‡ºæ¥ï¼ˆå±…ç„¶ä¸èƒ½å³é”®å¤åˆ¶åé¢çš„å­—ç¬¦ä¸²ï¼‰ï¼Œå†…å®¹æ˜¯&lt;code>4447467073727d7c&lt;/code>ã€‚&lt;/p>
&lt;p>æ¥ç€ç»§ç»­è¿è¡Œï¼Œå†æŠŠæŠ„å‡ºæ¥çš„ç­”æ¡ˆå¤åˆ¶è¿›å»çœ‹çœ‹ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-25.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-25.png"
loading="lazy"
alt="image-20210915141838395">
&lt;/a>
&lt;figcaption>image-20210915141838395&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬æ‹¿åˆ°äº†ä¸€ä¸ªå¯ä»¥ç”¨çš„åºåˆ—å·ã€‚&lt;/p>
&lt;h2 id="0x05-æ³¨å†Œæœº">0x05 æ³¨å†Œæœº&lt;/h2>
&lt;h3 id="51-python-è„šæœ¬æ³¨å†Œæœº">5.1 Python è„šæœ¬æ³¨å†Œæœº&lt;/h3>
&lt;p>å…ˆæŠŠå‰é¢çš„ä¼ªä»£ç è´´ä¸€ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="kt">int&lt;/span> &lt;span class="n">var_4h&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mh">0x8&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// ebp-4h
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="o">*&lt;/span> &lt;span class="n">var_8h&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">unknown_func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mh">0x8&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// ebp-8h
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">var_ch&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">var_ch&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">var_ch&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// var_ch -&amp;gt; ebp-ch
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">var_8h&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">var_ch&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mh">0x52&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">var_ch&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">unknown_func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">var_8h&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mh">0x8&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">username&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">username_len&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// çŒœæµ‹çš„å‡½æ•°ç­¾å func(void*, int, void*, int)
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">var_10h&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">var_10h&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">var_10h&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// var_10h -&amp;gt; ebp-10h
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">var_8h&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">var_10h&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">^=&lt;/span> &lt;span class="mh">0x25&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">var_14h&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mh">0x11&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">var_18h&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">unknown_func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mh">0x11&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">for&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">var_1ch&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mh">0x0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">var_1ch&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">var_1ch&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">unknown_func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">var_18h&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">var_1ch&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;%02x&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">var_8h&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">var_1ch&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">var_18h&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mh">0x10&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">unknown_func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">var_8h&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">var_18h&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>é‡Œé¢çš„æœªçŸ¥å‡½æ•°ï¼ˆå¤±ç­–ï¼Œclangé»˜è®¤é™æ€é“¾æ¥äº†libcmtï¼Œå¾ˆå¤šåº“å‡½æ•°åœ¨x32dbgé‡Œè®¤ä¸å‡ºæ¥ï¼‰çŒœä¸€çŒœå§ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">username&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">input&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;username:&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">encode&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="n">username_len&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">username&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">var_4h&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">8&lt;/span>
&lt;span class="n">var_8h&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">bytearray&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">8&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">8&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">var_8h&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mh">0x52&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">i&lt;/span>
&lt;span class="c1"># è¿™é‡Œçš„æœªçŸ¥å‡½æ•°é€šè¿‡è°ƒè¯•å™¨å¯ä»¥çœ‹å‡ºï¼ŒæŠŠå…¥å‚å¤åˆ¶åˆ°äº† var_8h é‡Œ&lt;/span>
&lt;span class="n">var_8h&lt;/span>&lt;span class="p">[:&lt;/span>&lt;span class="n">username_len&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">username&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">8&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">var_8h&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">^=&lt;/span> &lt;span class="mh">0x25&lt;/span>
&lt;span class="c1"># for(int var_1ch = 0x0; var_1ch &amp;lt; 8; var_1ch++) {&lt;/span>
&lt;span class="c1"># unknown_func(var_18h + var_1ch * 2, &amp;#34;%02x&amp;#34;, var_8h[var_1ch]);&lt;/span>
&lt;span class="c1"># }&lt;/span>
&lt;span class="c1">#&lt;/span>
&lt;span class="c1"># æœ€åçš„é‚£ä¸ªå¾ªç¯ä¸­ï¼Œå‡½æ•°åˆ¤æ–­ä¸º sprintf æˆ–å…¶ä»–å•¥ï¼Œæ ¼å¼åŒ–æ˜ç¡®æ˜¯2ä½å°å†™16è¿›åˆ¶æ•°&lt;/span>
&lt;span class="c1"># å‰é¢çš„è®¡ç®—çœ‹ä½œæ˜¯ç®—åç§»ï¼Œä¸€ä¸ª var_8h çš„å­—èŠ‚å¯¹åº” 2 å­—èŠ‚16è¿›åˆ¶è¡¨ç¤ºï¼Œæ‰€ä»¥ var_18h åŠ ä¸Š NUL ä¸€å…±æ˜¯ 0x11 ä¹Ÿå°±æ˜¯ 17 ä¸ªå­—èŠ‚&lt;/span>
&lt;span class="c1"># å¾ªç¯çš„ä½œç”¨æ˜¯æŠŠ var_8h è¿™ä¸ªå­—èŠ‚æ•°ç»„è½¬æ¢æˆ16è¿›åˆ¶è¡¨ç¤ºçš„å­—ç¬¦ä¸²ã€‚&lt;/span>
&lt;span class="c1">#&lt;/span>
&lt;span class="c1"># åœ¨ python é‡Œç”¨ hex() å°±è¡Œäº†ã€‚&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">var_8h&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">hex&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿è¡Œè„šæœ¬ï¼Œè¾“å…¥&lt;code>abc&lt;/code>ï¼Œè¾“å‡º&lt;code>4447467073727d7c&lt;/code>ï¼Œç¡®è®¤æ³¨å†Œæœºå¯ä»¥ç”Ÿæˆåºåˆ—å·ã€‚&lt;/p>
&lt;h2 id="0x06-ä¿®æ”¹-exe">0x06 ä¿®æ”¹ exe&lt;/h2>
&lt;h3 id="61-x32dbg-ä¿®æ”¹å…³é”®è·³">6.1 x32dbg ä¿®æ”¹å…³é”®è·³&lt;/h3>
&lt;p>ç”¨è°ƒè¯•å™¨æ‰“å¼€åæ‰¾åˆ°å†³å®šserialæ˜¯å¦æ­£ç¡®çš„å…³é”®è·³è½¬ï¼Œå³é”®äºŒè¿›åˆ¶é€‰æ‹©ç”¨NOPå¡«å……ï¼Œç¡®è®¤å³å¯ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-26.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-26.png"
loading="lazy"
alt="image-20210915150907420">
&lt;/a>
&lt;figcaption>image-20210915150907420&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>ä¿®æ”¹åæ•ˆæœå¦‚å›¾ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-27.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-27.png"
loading="lazy"
alt="image-20210915150953046">
&lt;/a>
&lt;figcaption>image-20210915150953046&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æ¥ç€æŠŠä¿®æ”¹åçš„exeä¿å­˜ä¸‹æ¥ï¼Œåœ¨æ–‡ä»¶èœå•é‡Œé€‰æ‹©è¡¥ä¸ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-28.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-28.png"
loading="lazy"
alt="image-20210915151220354">
&lt;/a>
&lt;figcaption>image-20210915151220354&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å…¨é€‰ï¼Œç‚¹ä¿®è¡¥æ–‡ä»¶ï¼Œé€‰æ‹©è·¯å¾„ä¿å­˜ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-29.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-29.png"
loading="lazy"
alt="image-20210915151322628">
&lt;/a>
&lt;figcaption>image-20210915151322628&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æˆ‘ä¿å­˜åœ¨&lt;code>cm02-easy-patched.exe&lt;/code>ï¼Œæ¥ç€æˆ‘ä»¬è¯•è¯•è¿è¡Œã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-30.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-30.png"
loading="lazy"
alt="image-20210915151903611">
&lt;/a>
&lt;figcaption>image-20210915151903611&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>é—æ†¾çš„æ˜¯è¢«x32dbgè¡¥ä¸åŠŸèƒ½å¯¼å‡ºçš„æ–‡ä»¶éœ€è¦ç®¡ç†å‘˜æƒé™è¿è¡Œï¼Œä¸ºäº†èƒ½æˆªåˆ°å›¾ï¼Œå›¾ä¸­ç”¨äº†åä¸º&lt;code>sudo&lt;/code>çš„å·¥å…·å‘½ä»¤ï¼Œå¯ä»¥ç”¨&lt;code>scoop install sudo&lt;/code>æ¥å®‰è£…&lt;code>sudo&lt;/code>ï¼Œç‚¹å‡»å»&lt;a class="link" href="https://scoop.sh" target="_blank" rel="noopener"
>scoopé¦–é¡µ&lt;/a>ã€‚&lt;/p>
&lt;h3 id="62-åç¼–è¯‘å™¨ä¿®æ”¹å…³é”®è·³">6.2 åç¼–è¯‘å™¨ä¿®æ”¹å…³é”®è·³&lt;/h3>
&lt;p>ä»¥Cutterä¸ºä¾‹ï¼Œæ‰¾åˆ°&lt;code>jne&lt;/code>æŒ‡ä»¤åï¼Œå³é”®ä¿®æ”¹ä¸º&lt;code>nop&lt;/code>å³å¯ã€‚è®°å¾—å…ˆå¤‡ä»½ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-31.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-31.png"
loading="lazy"
alt="image-20210915152428449">
&lt;/a>
&lt;figcaption>image-20210915152428449&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-32.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-02/cm02-easy-32.png"
loading="lazy"
alt="image-20210915152609774">
&lt;/a>
&lt;figcaption>image-20210915152609774&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>ä¿®æ”¹åä¹Ÿèƒ½å®ç°å’Œx32å¯¼å‡ºä¸€æ ·çš„æ•ˆæœï¼Œè€Œä¸”ä¸ç”¨ç®¡ç†å‘˜æƒé™ã€‚&lt;/p>
&lt;h2 id="ç»“è®º">ç»“è®º&lt;/h2>
&lt;p>æ€»å¾—æœ‰ä¸ªç»“è®ºã€‚&lt;/p>
&lt;p>è¿™æ¬¡é€†å‘åº”è¯¥èƒ½å¸®åŠ©å­¦åˆ°ä¸‹é¢çš„ä¸œè¥¿ï¼š&lt;/p>
&lt;ul>
&lt;li>æ ˆå¸§ç»“æ„å’Œå‡½æ•°è°ƒç”¨&lt;/li>
&lt;li>&lt;code>cmp&lt;/code>æŒ‡ä»¤&lt;/li>
&lt;li>&lt;code>jne&lt;/code>ã€&lt;code>jbe&lt;/code>ã€&lt;code>jnz&lt;/code>ã€&lt;code>jae&lt;/code>æŒ‡ä»¤&lt;/li>
&lt;li>&lt;code>movsx&lt;/code>æŒ‡ä»¤&lt;/li>
&lt;li>&lt;code>shl&lt;/code>æŒ‡ä»¤&lt;/li>
&lt;/ul>
&lt;p>åº“å‡½æ•°å› ä¸ºé™æ€é“¾æ¥çš„ç¼˜æ•…å·²ç»å˜æˆäº†æ–‡ä¸­çš„æœªçŸ¥å‡½æ•°ï¼Œé€ æˆäº†åˆ†æä¸Šçš„éšœç¢ã€‚è€å®è¯´å¦‚æœä¸æ˜¯è‡ªå·±å†™çš„æºç ï¼Œèƒ½ä¸èƒ½è¿™ä¹ˆé¡ºåˆ©é€†å‘å‡ºæ³¨å†Œæœºè¿˜çœŸä¸å¥½è¯´ã€‚&lt;/p>
&lt;p>å¼€å¯ä¼˜åŒ–çš„ &lt;em>normal&lt;/em> å’Œ &lt;em>hard&lt;/em> éš¾åº¦å°±ä¸è¿›ä¸€æ­¥åˆ†æäº†ï¼Œæœ‰å…´è¶£å¯ä»¥çœ‹çœ‹ã€‚&lt;/p></description></item><item><title>è‡ªå¨±è‡ªä¹ CrackMe-1</title><link>https://nnnewb.github.io/blog/p/crackme-01/</link><pubDate>Fri, 10 Sep 2021 09:49:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/crackme-01/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>æ€»ä¹‹å¾—æœ‰ä¸ªå‰è¨€ã€‚ä»å‰æœ‰ä¸ªè€å’Œå°šï¼ˆä¸æ˜¯ï¼Œæ‰å…‰äº†å¤´å‘çš„æ”»åŸç‹®ï¼‰ï¼Œ&amp;hellip;&amp;hellip;&lt;/p>
&lt;p>ä»¥ä¸Šç•¥ï¼Œäºæ˜¯ä½œä¸ºèŒæ–°å«é‡110%çš„èŒæ–°ï¼Œå‡ºäºç»ƒæ‰‹ã€ç†Ÿæ‚‰ä¸‹åæ±‡ç¼–è°ƒè¯•çš„ç¯å¢ƒä¹‹ç±»çš„ç›®çš„ï¼Œè¿˜æ˜¯è‡ªå·±å†™crackmeæ¥æŠŠç©å§ã€‚&lt;/p>
&lt;h2 id="cm01-ä»‹ç»">CM01 ä»‹ç»&lt;/h2>
&lt;p>äºæ˜¯è¿™ä¸ª CrackMe å°±å« CM01 å¥½äº†ï¼Œå‘½ä»¤è¡Œæ— ç•Œé¢ã€‚é€‚åˆå·®ä¸å¤šå¯¹è¿™äº›ä¸œè¥¿æ‡‚ä¸ªå¤§æ¦‚æˆ–è€…æ‰“ç®—å­¦ä¹ çš„èŒæ–°ï¼š&lt;/p>
&lt;ul>
&lt;li>åæ±‡ç¼–/è°ƒè¯•å·¥å…·&lt;/li>
&lt;li>å¯„å­˜å™¨ï¼ˆä¸»è¦æ˜¯ ebpã€espã€eipã€eaxï¼‰&lt;/li>
&lt;li>å‡½æ•°è°ƒç”¨ï¼ˆcdeclï¼‰&lt;/li>
&lt;li>æ ˆ/æ ˆå¸§&lt;/li>
&lt;li>å†…å­˜æ¨¡å‹å’Œå¯»å€&lt;/li>
&lt;/ul>
&lt;h2 id="cm01-æºç ">CM01 æºç &lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdio.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdlib.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;string.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="n">size_t&lt;/span> &lt;span class="nf">getline&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">lineptr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">size_t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">FILE&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">stream&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">bufptr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">p&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">bufptr&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">size_t&lt;/span> &lt;span class="n">size&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">c&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">lineptr&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">stream&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">n&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">bufptr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">lineptr&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">c&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fgetc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stream&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">c&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">EOF&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">bufptr&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">bufptr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">malloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">bufptr&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">128&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">p&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">bufptr&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">c&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">EOF&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">p&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">bufptr&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">size&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">size&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">128&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">bufptr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">realloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">bufptr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">size&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">bufptr&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="o">*&lt;/span>&lt;span class="n">p&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">c&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">c&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="sc">&amp;#39;\n&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">c&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fgetc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stream&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="o">*&lt;/span>&lt;span class="n">p&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="sc">&amp;#39;\0&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="o">*&lt;/span>&lt;span class="n">lineptr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">bufptr&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="o">*&lt;/span>&lt;span class="n">n&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">size&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">p&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">bufptr&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">pwd&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;secret&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">line&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">size_t&lt;/span> &lt;span class="n">len&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kt">long&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">linesize&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;password:&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">linesize&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">getline&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">line&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">len&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">stdin&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">rc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">strncmp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">line&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">pwd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">6&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">rc&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Good job!&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;wrong pwd!&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç¼–è¯‘å·¥å…·é“¾ï¼š&lt;/p>
&lt;ul>
&lt;li>å› ä¸ºVC++å¯¹å•çº¯Cçš„æ”¯æŒæ¯”è¾ƒåƒåœ¾ï¼Œæ‰€ä»¥ç”¨LLVMï¼ˆClangï¼‰-12.0.1ï¼ŒClang&lt;/li>
&lt;/ul>
&lt;p>ç¼–è¯‘æŒ‡ä»¤&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">clang cm01.c -o cm01-easy.exe -m32 -O0
clang cm01.c -o cm01-normal.exe -m32 -O1
clang cm01.c -o cm01-hard.exe -m32 -O2
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="è§‚å¯Ÿ">è§‚å¯Ÿ&lt;/h2>
&lt;p>å‡è£…æ²¡çœ‹åˆ°æºç ï¼Œå…ˆè§‚å¯Ÿä¸‹ç¨‹åºçš„è¡Œä¸ºï¼Œç¡®å®šç›®æ ‡ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">weakptr in assembly-play â¯ .\cm01-easy.exe
password:password?
wrong pwd!
password:asdf
wrong pwd!
password:wrong pwd!
password:
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸€ä¸ª &lt;em>password:&lt;/em> æç¤ºç¬¦ï¼Œéšä¾¿è¾“å…¥äº†ç‚¹ä»€ä¹ˆä¼šæç¤º &lt;em>wrong pwd!&lt;/em> ã€‚&lt;/p>
&lt;p>ç¡®å®šç›®æ ‡æ˜¯æ‰¾å‡ºæ­£ç¡®çš„å¯†ç ã€‚&lt;/p>
&lt;h2 id="é™æ€åˆ†æ">é™æ€åˆ†æ&lt;/h2>
&lt;h3 id="æ€è·¯">æ€è·¯&lt;/h3>
&lt;p>åœ¨é€†å‘ä¸­æœ‰ä¸ªè¯´æ³•å«*â€œå…³é”®è·³è½¬â€*ï¼Œå¦‚åˆ†æå›ºå®šå¯†ç ï¼Œå­—ç¬¦ä¸²æ¯”è¾ƒåè·³è½¬æˆåŠŸæˆ–è·³è½¬å¤±è´¥å°±æ˜¯å…³é”®è·³ã€‚å¯¹äºç®€å•çš„é—®é¢˜ï¼Œæ‰¾åˆ°å…³é”®è·³å³å¯ç ´å±€ã€‚&lt;/p>
&lt;h3 id="åæ±‡ç¼–---easy">åæ±‡ç¼– - Easy&lt;/h3>
&lt;p>Easyéš¾åº¦ä¸‹ï¼Œ&lt;code>-O0&lt;/code>å‚æ•°å…³é—­äº†ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œç”Ÿæˆçš„æ±‡ç¼–ä»£ç éå¸¸æ­»æ¿ï¼ŒåŸºæœ¬èƒ½ç›´æ¥å¯¹ç…§åˆ°Cæºç ä¸Šã€‚&lt;/p>
&lt;p>ç›´æ¥æ‹¿IDAæ‰“å¼€ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-01/cm01-easy-1.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-01/cm01-easy-1.png"
loading="lazy"
alt="image-20210912172521751">
&lt;/a>
&lt;figcaption>image-20210912172521751&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>ç›´æ¥è·³åˆ°äº†&lt;code>main&lt;/code>å‡½æ•°ã€‚æ¥ç€çœ‹IDAæ±‡ç¼–çª—å£ä¸­çš„çš„ç»†èŠ‚ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-01/cm01-easy-2.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-01/cm01-easy-2.png"
loading="lazy"
alt="image-20210912173539972">
&lt;/a>
&lt;figcaption>image-20210912173539972&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>IDAåæ±‡ç¼–ç•Œé¢æ˜¯åŒ…å«ä¸€äº›ä¼ªä»£ç çš„ï¼Œæœ‰åŠ©äºåˆ†æã€‚&lt;/p>
&lt;p>å·¦ä¾§æœ‰é•¿æ¡å’Œç®­å¤´çš„éƒ¨åˆ†æ˜¯æ§åˆ¶æµç¤ºæ„ï¼Œç®­å¤´æŒ‡çš„å°±æ˜¯è·³è½¬æ–¹å‘ã€‚&lt;/p>
&lt;p>è¶Šè¿‡ä¼ªä»£ç çš„éƒ¨åˆ†ï¼Œå°±èƒ½çœ‹åˆ°å‡½æ•°ä½“å¼€å¤´ä¾‹è¡Œå…¬äº‹çš„éƒ¨åˆ†äº†ã€‚éšåçš„ä¾¿æ˜¯å‡½æ•°ä½“ä»£ç ã€‚&lt;/p>
&lt;p>å…·ä½“çœ‹å‡½æ•°ä½“å‰ï¼Œå…ˆäº†è§£ä¸‹IDAè¿˜æä¾›äº†å¦ä¸€ç§æ§åˆ¶æµå¯è§†åŒ–çš„è§†å›¾ï¼Œå¯ä»¥æå¤§å¸®åŠ©å¯¹å‡½æ•°é€»è¾‘çš„åˆ†æã€‚&lt;/p>
&lt;p>åœ¨æ±‡ç¼–è§†å›¾é‡Œå³é”®ï¼Œé€‰æ‹© Graph Viewï¼Œå³å¯è¿›å…¥æ§åˆ¶æµè§†å›¾ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-01/cm01-easy-3.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-01/cm01-easy-3.png"
loading="lazy"
alt="image-20210912174233891">
&lt;/a>
&lt;figcaption>image-20210912174233891&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>åœ¨å›¾ç‰‡å·¦ä¸‹è§’çš„æ˜¯è§†å›¾çš„å…¨è§ˆï¼ŒåŸæœ¬çš„æ±‡ç¼–æ–‡æœ¬å˜æˆäº†å›¾ä¸­ç®­å¤´è¿æ¥çš„å°æ±‡ç¼–ä»£ç å—ï¼Œç®­å¤´æŒ‡ç¤ºäº†è·³è½¬çš„æ–¹å‘ã€‚&lt;/p>
&lt;p>åœ¨è¿™ä¸ªè§†å›¾å¯ä»¥å¾ˆæ¸…æ¥šåœ°çœ‹åˆ°æ‰€è°“çš„å…³é”®è·³ï¼š&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-01/cm01-easy-4.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-01/cm01-easy-4.png"
loading="lazy"
alt="image-20210912174738919">
&lt;/a>
&lt;figcaption>image-20210912174738919&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>&lt;code>_strncmp&lt;/code>æ˜¯ç»è¿‡äº† name mangling çš„ c æ ‡å‡†åº“å‡½æ•°&lt;code>strncmp&lt;/code>ï¼Œå‡½æ•°å¦‚åå­—æ‰€ç¤ºï¼Œç”¨é€”å°±æ˜¯æ¯”è¾ƒå­—ç¬¦ä¸²ã€‚&lt;/p>
&lt;p>åˆæ ¹æ®&lt;code>cdecl&lt;/code>è°ƒç”¨çº¦å®šï¼Œå‡½æ•°å‚æ•°é€šè¿‡æ ˆä¼ é€’ï¼Œå‚æ•°ä»å³å¾€å·¦å‹æ ˆã€‚æˆ‘ä»¬çœ‹è¿™ä¸ª&lt;code>call&lt;/code>æŒ‡ä»¤å‰çš„ä¸‰å¥&lt;code>mov&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nf">mov&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">esp&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">24&lt;/span>&lt;span class="no">h&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="no">Ix&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">ecx&lt;/span> &lt;span class="c">; Str1
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">mov&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">esp&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">24&lt;/span>&lt;span class="no">h&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="no">Str2&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; Str2
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">mov&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">esp&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">24&lt;/span>&lt;span class="no">h&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="no">MaxCount&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="mi">6&lt;/span> &lt;span class="c">; MaxCount
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>éœ€è¦æ³¨æ„çš„æ˜¯æ²¡æœ‰ç”¨&lt;code>push&lt;/code>æŒ‡ä»¤ï¼Œæ‰€ä»¥ä¸‰ä¸ª&lt;code>mov&lt;/code>åœ¨æ ˆä¸Šçš„é¡ºåºè¦æ ¹æ®åç§»ç®—ã€‚æˆ‘ä»¬å·ä¸ªæ‡’ç›´æ¥çœ‹&lt;code>strncmp&lt;/code>å‡½æ•°çš„ç­¾åå°±è¡Œï¼ŒIDAä¹Ÿåˆ†æå‡ºäº†å‹æ ˆçš„åœ°å€åœ¨æ³¨é‡Šé‡Œã€‚å¾€ä¸Šçœ‹ï¼Œçœ‹çœ‹&lt;code>ecx&lt;/code>å’Œ&lt;code>eax&lt;/code>åˆæ˜¯å“ªå„¿æ¥çš„ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nf">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="no">var_8&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">ecx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="no">Str1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å†çœ‹&lt;code>ebp+var_8&lt;/code>å’Œ&lt;code>ebp+str1&lt;/code>åˆæ˜¯ä»€ä¹ˆã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nf">lea&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">aSecret&lt;/span> &lt;span class="c">; &amp;#34;secret&amp;#34;
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">mov&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="no">var_8&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="no">eax&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰€ä»¥æœ‰ä¸€ä¸ªå‚æ•°æ˜¯å­—ç¬¦ä¸² &lt;code>&amp;quot;secret&amp;quot;&lt;/code>ï¼Œä½œä¸ºå…³é”®è·³å‰ &lt;code>_strncmp&lt;/code> çš„å‚æ•°ã€‚&lt;/p>
&lt;p>è®©æˆ‘ä»¬å°è¯•ä¸€ä¸‹ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-01/cm01-easy-7.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-01/cm01-easy-7.png"
loading="lazy"
alt="image-20210912181959230">
&lt;/a>
&lt;figcaption>image-20210912181959230&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æˆåŠŸå®Œæˆã€‚&lt;/p>
&lt;h3 id="åæ±‡ç¼–---normal">åæ±‡ç¼– - Normal&lt;/h3>
&lt;p>æ¥ä¸‹æ¥çœ‹ä½¿ç”¨&lt;code>-O1&lt;/code>ç¼–è¯‘ï¼Œå¼€å¯äº†éƒ¨åˆ†ç¼–è¯‘å™¨ä¼˜åŒ–çš„ç‰ˆæœ¬ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-01/cm01-normal-1.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-01/cm01-normal-1.png"
loading="lazy"
alt="image-20210912183427553">
&lt;/a>
&lt;figcaption>image-20210912183427553&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å¯ä»¥çœ‹åˆ°ï¼Œå› ä¸ºç¼–è¯‘å™¨ä¼˜åŒ–çš„ç¼˜æ•…ï¼ŒåŸæœ¬æ¸…æ™°çš„åˆ†æ”¯å˜æˆäº†ä¸€ä¸ªä»…æœ‰ä¸€ä¸ªå¾ªç¯ã€‚&lt;/p>
&lt;p>è¿˜æ˜¯å…ˆæ‰¾åˆ°å…³é”®è·³ï¼Œè‚‰çœ¼è¿‡ä¸€éå¾ªç¯ä¸­çš„å‡½æ•°è°ƒç”¨ï¼Œ&lt;code>sub_401180&lt;/code>ä»å‚æ•°çœ‹åº”è¯¥æ˜¯ä¸€ä¸ªå¾€ç»ˆç«¯æ‰“å°å­—ç¬¦ä¸²çš„å‡½æ•°ï¼Œå¿½ç•¥ã€‚&lt;code>___acrt_iob_func&lt;/code>æ„ä¹‰ä¸æ˜ä¹Ÿå¿½ç•¥ã€‚ä¸‹ä¸€ä¸ª&lt;code>sub_401000&lt;/code>ä¾ç„¶æœ‰ç‚¹æ„ä¹‰ä¸æ˜ï¼Œå…ˆè·³è¿‡ã€‚å†å¾€ä¸‹å°±çœ‹åˆ°äº†è€ç†Ÿäººäº†ï¼Œ&lt;code>_strncmp&lt;/code>ï¼Œ&lt;code>&amp;quot;secret&amp;quot;&lt;/code>å‚æ•°æ›´æ˜¯ç›´æ¥ç”¨ä¸€ä¸ªpushç»™å‹æ ˆäº†ï¼Œåˆ†æåˆ°æ­¤ç»“æŸï¼Ÿ&lt;/p>
&lt;p>ä¸è¿‡è¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ²¡è§£å†³ï¼šå¤±è´¥çš„æç¤ºæˆ‘ä»¬çœ‹åˆ°äº†ï¼ŒæˆåŠŸçš„è·³è½¬åœ¨å“ªå„¿å‘¢ï¼Ÿ&lt;/p>
&lt;p>ä»&lt;code>call _strncmp&lt;/code>å¼€å§‹å¾€ä¸‹çœ‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nf">call&lt;/span> &lt;span class="no">_strncmp&lt;/span> &lt;span class="c">; è°ƒç”¨ï¼Œcdeclçº¦å®šä¸‹ï¼Œè¿”å›å€¼åœ¨ eax
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">add&lt;/span> &lt;span class="no">esp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="no">Ch&lt;/span> &lt;span class="c">; æ¸…æ ˆ
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">mov&lt;/span> &lt;span class="no">esi&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; å‡½æ•°è¿”å›å€¼å­˜å…¥ esi
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">test&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; TEST æŒ‡ä»¤æŠŠæ“ä½œæ•°æŒ‰ä½ä¸å¹¶è®¾ç½®æ ‡å¿—ä½ï¼Œå¦‚æœ eax æ˜¯ 0 åˆ™ ZF ä¼šè®¾ç½®æˆ 1ï¼Œå¦åˆ™å°±æ˜¯ 0ã€‚
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">mov&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">offset&lt;/span> &lt;span class="no">aWrongPwd&lt;/span> &lt;span class="c">; eax = &amp;#34;wrong pwd!\n&amp;#34;
&lt;/span>&lt;span class="c">; ebp è¢«è®¾ç½®ä¸ºäº†å­—ç¬¦ä¸² &amp;#34;Good job!\n&amp;#34;
&lt;/span>&lt;span class="c">; cmovz æˆ–è€…è¯´ cmov* ç³»åˆ—çš„å‡½æ•°ç”¨åç¼€çš„å•ä¸ªå­—ç¬¦è¡¨ç¤ºç”¨å“ªä¸ªæ ‡å¿—ä½æ¥å†³å®šæ˜¯å¦movï¼Œæ¯”å¦‚cmovzå°±æ˜¯ç”¨ZFæ ‡å¿—ä½å†³å®šæ˜¯å¦æ‰§è¡Œmovã€‚
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">cmovz&lt;/span> &lt;span class="no">eax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">ebp&lt;/span>
&lt;span class="no">push&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; å¦‚æœ strncmp è¿”å› 0 åˆ™æ˜¯ Good job!\n ï¼Œååˆ™ wrong pwd!\n
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">call&lt;/span> &lt;span class="no">sub_401180&lt;/span> &lt;span class="c">; è°ƒç”¨ä¸€ä¸ªè¾“å‡ºå­—ç¬¦ä¸²çš„å‡½æ•°
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç”¨ä¼ªä»£ç æ¥è¡¨ç¤ºï¼Œå°±æ˜¯&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Good job!&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="n">compare_result&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="s2">&amp;#34;wrong pwd!&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="åæ±‡ç¼–---hard">åæ±‡ç¼– - Hard&lt;/h3>
&lt;p>Hardå¯ç”¨äº†&lt;code>-O2&lt;/code>ï¼Œä¹Ÿå°±æ˜¯å¼€å¯äº†å¤§éƒ¨åˆ†ç¼–è¯‘å™¨ä¼˜åŒ–ã€‚ç”¨IDAæ‰“å¼€ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-01/cm01-hard-1.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-01/cm01-hard-1.png"
loading="lazy"
alt="image-20210912185949657">
&lt;/a>
&lt;figcaption>image-20210912185949657&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å› ä¸ºç¼–è¯‘å™¨ååˆ†èªæ˜åœ°æŠŠä¸€äº›å‡½æ•°ç»™å†…è”ç¼–è¯‘è¿›äº† main å‡½æ•°ï¼Œç°åœ¨ main å‡½æ•°çš„æ§åˆ¶æµå·²ç»ä¹±çš„ä¸€æ‰¹ã€‚æŒ¨ä¸ªè¯»ä¸‹å»è™½ç„¶è¿˜å¯è¡Œï¼Œä½†å®åœ¨è´¹ç¥è´¹åŠ›ã€‚&lt;/p>
&lt;p>ä¸è¿‡åœ¨è¿™ä¸ªæ¡ä»¶ä¸‹ä¾ç„¶è¿˜æœ‰è§£å†³åŠæ³•ï¼šæˆ‘ä»¬å¯ä»¥é€šè¿‡é”™è¯¯æˆ–æˆåŠŸçš„æç¤ºå­—ç¬¦ä¸²æ‰¾å…³é”®è·³ã€‚&lt;/p>
&lt;p>å·²çŸ¥é”™è¯¯æ—¶ä¼šè¾“å‡º&amp;quot;wrong pwd!&amp;quot;ï¼Œæˆ‘ä»¬åœ¨IDAæ‰¾åˆ°å­—ç¬¦ä¸²è§†å›¾ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-01/cm01-hard-2.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-01/cm01-hard-2.png"
loading="lazy"
alt="image-20210912190657661">
&lt;/a>
&lt;figcaption>image-20210912190657661&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>ç„¶ååœ¨è§†å›¾ä¸­æ‰¾åˆ°å­—ç¬¦ä¸²ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-01/cm01-hard-3.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-01/cm01-hard-3.png"
loading="lazy"
alt="image-20210912190827657">
&lt;/a>
&lt;figcaption>image-20210912190827657&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å…¶å®å°±æ˜¯åœ¨å†…å­˜æ•°æ®æ®µï¼ˆData Segmentï¼‰æˆ–è€…PEçš„æ•°æ®èŠ‚ï¼ˆData Sectionï¼‰ä¸­çš„å­—ç¬¦ä¸²å•¦ï¼Œä¸€èˆ¬æ‰‹å†™çš„å­—ç¬¦ä¸²å­—é¢é‡éƒ½ä¼šç›´æ¥ç¼–è¯‘åˆ°è¿™é‡Œã€‚&lt;/p>
&lt;p>åœ¨æˆ‘ä»¬è¦æ‰¾çš„å­—ç¬¦ä¸²ä¸ŠåŒå‡»ï¼Œå°±ä¼šè·³åˆ°æ±‡ç¼–è§†å›¾ä¸­çš„å­—ç¬¦ä¸²ä½ç½®ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-01/cm01-hard-4.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-01/cm01-hard-4.png"
loading="lazy"
alt="image-20210912191125747">
&lt;/a>
&lt;figcaption>image-20210912191125747&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>ç„¶åå†åŒå‡»å›¾ä¸­ä½ç½®ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-01/cm01-hard-5.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-01/cm01-hard-5.png"
loading="lazy"
alt="image-20210912191344967">
&lt;/a>
&lt;figcaption>image-20210912191344967&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å³å¯è·³è½¬åˆ°å¼•ç”¨ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/crackme-01/cm01-hard-6.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/crackme-01/cm01-hard-6.png"
loading="lazy"
alt="image-20210912191435672">
&lt;/a>
&lt;figcaption>image-20210912191435672&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æ¥ç€çœ‹è·³è½¬åˆ°çš„ä¸Šä¸‹æ–‡ï¼Œåˆå˜æˆäº†ååˆ†ç†Ÿæ‚‰çš„æ­£ç¡®é”™è¯¯åˆ†æ”¯ã€‚å¾€å‰æ‰¾åˆ° &lt;code>_strncmp&lt;/code>çš„å‚æ•°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nf">push&lt;/span> &lt;span class="mi">6&lt;/span>
&lt;span class="nf">push&lt;/span> &lt;span class="no">offset&lt;/span> &lt;span class="no">Str2&lt;/span> &lt;span class="c">; &amp;#34;secret&amp;#34;
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">push&lt;/span> &lt;span class="no">edx&lt;/span> &lt;span class="c">; Str1
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">mov&lt;/span> &lt;span class="no">ebp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="no">edx&lt;/span>
&lt;span class="nf">call&lt;/span> &lt;span class="no">_strncmp&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¹Ÿå°±æ˜¯ &lt;code>strncmp(edx,&amp;quot;secret&amp;quot;,6)&lt;/code>ï¼Œå¯†é’¥å°±æ˜¯ &lt;code>&amp;quot;secret&amp;quot;&lt;/code>æ²¡é”™äº†ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>è¿™ä¸ª CrackMe ï¼ˆä»¥åä¹Ÿè®¸è¿˜æœ‰ï¼‰çš„ä¸»è¦ç”¨é€”æ˜¯å­¦ä¹ é€†å‘å’Œæ±‡ç¼–çš„åŸºç¡€çŸ¥è¯†ï¼Œå·©å›ºè®°å¿†ï¼Œå­¦ä¹ å’Œç†Ÿæ‚‰å·¥å…·ã€‚æ‰€ä»¥å°½å¯èƒ½å»é™¤å¹²æ‰°é¡¹ï¼Œåªä¿ç•™æƒ³è¦å·©å›ºå­¦ä¹ çš„éƒ¨åˆ†ï¼Œçœ‹èµ·æ¥å¾ˆå‚»ï¼ŒåŸºæœ¬æ²¡å•¥æŒ‘æˆ˜æ€§ã€‚&lt;/p>
&lt;p>æœ‰äº›å…¬å…±çš„å‰ç½®çŸ¥è¯†ï¼ˆæ¯”å¦‚å¯„å­˜å™¨å’Œæ ˆï¼Œè°ƒç”¨çº¦å®šï¼Œå†…å­˜æ¨¡å‹ï¼‰æˆ‘åšäº†ä¸ªç¬”è®°ï¼Œå¤§æ¦‚æ˜¯å…¥ä¸äº†å¤§ä½¬çš„çœ¼çš„ã€‚å¯ä»¥åœ¨[è¿™é‡Œ](&lt;a class="link" href="https://nnnewb.github.io/blog/p/assembly-learning-note/" target="_blank" rel="noopener"
>32ä½ Windows x86 æ±‡ç¼–è¯­è¨€å­¦ä¹  (nnnewb.github.io)&lt;/a>)çœ‹çœ‹ã€‚&lt;/p>
&lt;p>ç›®å‰èƒ½æ‰¾åˆ°å¾ˆå¤š Delphi å’Œ VB ç¼–å†™çš„ CrackMeï¼ŒDelphi ç°åœ¨æœæœè¿˜èƒ½çœ‹åˆ°äº› &lt;em>Delphi still alive&lt;/em> çš„æ–‡ç« ï¼Œä¸è¿‡ç¡®å®æ¯”è¾ƒå°‘è§äº†å§ã€‚æåˆ°å­¦ GUI ç¼–ç¨‹ï¼Œä¸æ˜¯æ¨è C++/Qt å°±æ˜¯ .Net å…¨å®¶æ¡¶ã€‚VB æ›´æ˜¯æ—©å·²å®Œè›‹ï¼ˆä¸æ˜¯VB.Netï¼‰ï¼Œè€å®è¯´è¿™äº› CrackMe ä¸çŸ¥é“è½¬äº†å‡ æ‰‹ï¼Œè¿˜èƒ½ç©æ˜¯è¿˜èƒ½ç©ï¼Œè™½ç„¶ä½†æ˜¯å§ï¼Œæ€»ä¹‹å¯¹æˆ‘è¿˜æ˜¯ç•¥éš¾ï¼Œçœ‹åˆ«äººçš„ CrackMe é¢˜è§£ä¹ŸæŒºè¿·èŒ«ã€‚&lt;/p>
&lt;p>ä¸è¿‡è‡ªå·±ä¼šç¼–ç¨‹å°±å¥½äº†å˜›ï¼&lt;/p></description></item><item><title>32ä½ Windows x86 æ±‡ç¼–è¯­è¨€å­¦ä¹ </title><link>https://nnnewb.github.io/blog/p/assembly-learning-note/</link><pubDate>Thu, 09 Sep 2021 16:14:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/assembly-learning-note/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>æœ€è¿‘è¿·ä¸Šäº† Crack Meï¼Œå…¥é—¨æ— æœã€‚è€æ˜¯çœ‹åˆ°æœ‰å¤§ä½¬å‘52pojieåˆæœ‰å“ªä¸ªä½¬æŠŠä»€ä¹ˆé»„æ²¹ç»™æ‰‹æ’•äº†ï¼Œå¿ƒç—’ç—’ã€‚å¹²è„†ä¹Ÿæ­£æ­£ç»ç»åœ°å»å­¦ä¸€ä¸‹å¥½äº†ã€‚&lt;/p>
&lt;p>è¿™å½“ç„¶ä¹Ÿç®—æ˜¯ç¨‹åºå‘˜æœ¬èŒçš„æ­£ç»çŸ¥è¯†ï¼ˆå¿ƒè™šè€Œä¸”è¶…å¤§å£°ï¼‰ã€‚&lt;/p>
&lt;h2 id="å¸¸è§„çŸ¥è¯†å’Œé€Ÿè®°">å¸¸è§„çŸ¥è¯†å’Œé€Ÿè®°&lt;/h2>
&lt;p>ç¬”è®°å†…å®¹æ˜¯å…³äº 8086/x86 æ±‡ç¼–ã€‚&lt;/p>
&lt;p>x86ä½“ç³»ç»“æ„ä¸‹å†…å­˜å’Œå¯„å­˜å™¨éƒ½æ˜¯å°ç«¯åºã€‚å°ç«¯åºæŒ‡ä½ä½åœ¨å³ï¼Œé«˜ä½åœ¨å·¦ã€‚å¦‚&lt;code>0x1&lt;/code>çš„å°ç«¯åºè¡¨ç¤ºæ˜¯&lt;code>0000 0001&lt;/code>ã€‚&lt;/p>
&lt;p>8æ¯”ç‰¹èƒ½è¡¨ç¤º2ä½16è¿›åˆ¶æ•°ï¼ˆ&lt;code>0xFF&lt;/code>ï¼Œä¹Ÿå°±æ˜¯&lt;code>255&lt;/code>ï¼‰ï¼Œ16æ¯”ç‰¹èƒ½è¡¨ç¤º4ä½16è¿›åˆ¶æ•°ï¼ˆ&lt;code>0xFFFF&lt;/code>ï¼Œ&lt;code>65535&lt;/code>ï¼‰ï¼Œ32æ¯”ç‰¹èƒ½è¡¨ç¤º8ä½16è¿›åˆ¶æ•°ï¼ˆ&lt;code>0XFFFFFFFF&lt;/code>ï¼Œ&lt;code>4294967295&lt;/code>ï¼‰ã€‚&lt;/p>
&lt;p>æ•°æ®ç±»å‹ï¼š&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>åŠ©è®°ç¬¦&lt;/th>
&lt;th>æè¿°&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;code>dword&lt;/code>&lt;/td>
&lt;td>åŒå­—ï¼ˆdouble wordï¼‰ï¼Œ32æ¯”ç‰¹æ•´å‹æ•°æ®ã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>word&lt;/code>&lt;/td>
&lt;td>å­—ï¼Œ16æ¯”ç‰¹æ•´å‹æ•°æ®ã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>byte&lt;/code>&lt;/td>
&lt;td>å­—èŠ‚ï¼Œ8æ¯”ç‰¹æ•´å‹æ•°æ®ã€‚&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>å¸¸ç”¨çš„16è¿›åˆ¶æ•°è®°æ³•ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>0x2A&lt;/code>ï¼Œå‰ç¼€&lt;code>0x&lt;/code>&lt;/li>
&lt;li>&lt;code>2AH&lt;/code>ï¼Œåç¼€&lt;code>H&lt;/code>&lt;/li>
&lt;/ul>
&lt;h2 id="å¯„å­˜å™¨">å¯„å­˜å™¨&lt;/h2>
&lt;h3 id="é€šç”¨å¯„å­˜å™¨">é€šç”¨å¯„å­˜å™¨&lt;/h3>
&lt;p>å‚è€ƒï¼š&lt;a class="link" href="https://zh.wikibooks.org/wiki/X86_%E6%B1%87%E7%BC%96/X86_%E6%9E%B6%E6%9E%84" target="_blank" rel="noopener"
>x86æ±‡ç¼– - ç»´åŸºç™¾ç§‘&lt;/a>&lt;/p>
&lt;p>å‚è€ƒï¼š&lt;a class="link" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/x64-architecture" target="_blank" rel="noopener"
>x64ä½“ç³»ç»“æ„ - windows hardware&lt;/a>&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>64ä½å¯„å­˜å™¨&lt;/th>
&lt;th>32ä½å¯„å­˜å™¨&lt;/th>
&lt;th>16ä½å¯„å­˜å™¨&lt;/th>
&lt;th>8ä½å¯„å­˜å™¨&lt;/th>
&lt;th>ç”¨é€”&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;code>RAX&lt;/code>æˆ–&lt;code>R0&lt;/code>&lt;/td>
&lt;td>&lt;code>EAX&lt;/code>&lt;/td>
&lt;td>&lt;code>AX&lt;/code>&lt;/td>
&lt;td>&lt;code>AL&lt;/code>å’Œ&lt;code>AH&lt;/code>&lt;/td>
&lt;td>Accumlatorï¼Œç´¯åŠ å¯„å­˜å™¨ï¼Œç”¨äºç®—æœ¯è¿ç®—ã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>RBX&lt;/code>æˆ–&lt;code>R3&lt;/code>&lt;/td>
&lt;td>&lt;code>EBX&lt;/code>&lt;/td>
&lt;td>&lt;code>BX&lt;/code>&lt;/td>
&lt;td>&lt;code>BL&lt;/code>å’Œ&lt;code>BH&lt;/code>&lt;/td>
&lt;td>Baseï¼ŒåŸºå€å¯„å­˜å™¨ï¼ŒæŒ‡å‘æ•°æ®å—åŸºå€ï¼ˆæ®µæ¨¡å¼å­˜äºæ®µå¯„å­˜å™¨&lt;code>DS&lt;/code>ï¼‰&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>RCX&lt;/code>æˆ–&lt;code>R1&lt;/code>&lt;/td>
&lt;td>&lt;code>ECX&lt;/code>&lt;/td>
&lt;td>&lt;code>CX&lt;/code>&lt;/td>
&lt;td>&lt;code>CL&lt;/code>å’Œ&lt;code>CH&lt;/code>&lt;/td>
&lt;td>Counterï¼Œç”¨äºç”¨äºç§»/ç¯æŒ‡ä»¤åŠå¾ªç¯ï¼ˆæ²¡æ‡‚ï¼‰ã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>RDX&lt;/code>æˆ–&lt;code>R2&lt;/code>&lt;/td>
&lt;td>&lt;code>EDX&lt;/code>&lt;/td>
&lt;td>&lt;code>DX&lt;/code>&lt;/td>
&lt;td>&lt;code>DL&lt;/code>å’Œ&lt;code>DH&lt;/code>&lt;/td>
&lt;td>Dataï¼Œç”¨äºæ•°å­¦è¿ç®—å’ŒIOæ“ä½œã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>RSI&lt;/code>æˆ–&lt;code>R6&lt;/code>&lt;/td>
&lt;td>&lt;code>ESI&lt;/code>&lt;/td>
&lt;td>&lt;code>SI&lt;/code>&lt;/td>
&lt;td>&lt;code>SIL&lt;/code>&lt;/td>
&lt;td>Source Indexï¼ŒæŒ‡å‘æŒ‡ä»¤æµæ“ä½œä¸­çš„æºã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>RDI&lt;/code>æˆ–&lt;code>R7&lt;/code>&lt;/td>
&lt;td>&lt;code>EDI&lt;/code>&lt;/td>
&lt;td>&lt;code>DI&lt;/code>&lt;/td>
&lt;td>&lt;code>DIL&lt;/code>&lt;/td>
&lt;td>Destination Indexï¼ŒæŒ‡å‘æŒ‡ä»¤æµæ“ä½œä¸­çš„ç›®æ ‡ã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>RBP&lt;/code>æˆ–&lt;code>R5&lt;/code>&lt;/td>
&lt;td>&lt;code>EBP&lt;/code>&lt;/td>
&lt;td>&lt;code>BP&lt;/code>&lt;/td>
&lt;td>&lt;code>BPL&lt;/code>&lt;/td>
&lt;td>Stack Base Pointerï¼ŒæŒ‡å‘æ ˆçš„åŸºåœ°å€ã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>RSP&lt;/code>æˆ–&lt;code>R4&lt;/code>&lt;/td>
&lt;td>&lt;code>ESP&lt;/code>&lt;/td>
&lt;td>&lt;code>SP&lt;/code>&lt;/td>
&lt;td>&lt;code>SPL&lt;/code>&lt;/td>
&lt;td>Stack Pointerï¼ŒæŒ‡å‘æ ˆé¡¶çš„åœ°å€ã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>R8&lt;/code>&lt;/td>
&lt;td>&lt;code>R8D&lt;/code>&lt;/td>
&lt;td>&lt;code>R8W&lt;/code>&lt;/td>
&lt;td>&lt;code>R8B&lt;/code>&lt;/td>
&lt;td>æ— åˆ«åã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>R9&lt;/code>&lt;/td>
&lt;td>&lt;code>R9D&lt;/code>&lt;/td>
&lt;td>&lt;code>R9W&lt;/code>&lt;/td>
&lt;td>&lt;code>R9B&lt;/code>&lt;/td>
&lt;td>æ— åˆ«åã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>R10&lt;/code>&lt;/td>
&lt;td>&lt;code>R10D&lt;/code>&lt;/td>
&lt;td>&lt;code>R10W&lt;/code>&lt;/td>
&lt;td>&lt;code>R10B&lt;/code>&lt;/td>
&lt;td>æ— åˆ«åã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>R11&lt;/code>&lt;/td>
&lt;td>&lt;code>R11D&lt;/code>&lt;/td>
&lt;td>&lt;code>R11W&lt;/code>&lt;/td>
&lt;td>&lt;code>R11B&lt;/code>&lt;/td>
&lt;td>æ— åˆ«åã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>R12&lt;/code>&lt;/td>
&lt;td>&lt;code>R12D&lt;/code>&lt;/td>
&lt;td>&lt;code>R12W&lt;/code>&lt;/td>
&lt;td>&lt;code>R12B&lt;/code>&lt;/td>
&lt;td>æ— åˆ«åã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>R13&lt;/code>&lt;/td>
&lt;td>&lt;code>R13D&lt;/code>&lt;/td>
&lt;td>&lt;code>R13W&lt;/code>&lt;/td>
&lt;td>&lt;code>R13B&lt;/code>&lt;/td>
&lt;td>æ— åˆ«åã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>R14&lt;/code>&lt;/td>
&lt;td>&lt;code>R14D&lt;/code>&lt;/td>
&lt;td>&lt;code>R14W&lt;/code>&lt;/td>
&lt;td>&lt;code>R14B&lt;/code>&lt;/td>
&lt;td>æ— åˆ«åã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>R15&lt;/code>&lt;/td>
&lt;td>&lt;code>R15D&lt;/code>&lt;/td>
&lt;td>&lt;code>R15W&lt;/code>&lt;/td>
&lt;td>&lt;code>R15B&lt;/code>&lt;/td>
&lt;td>æ— åˆ«åã€‚&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>åç»­è¿˜æ˜¯ç”¨ 32 ä½å¯„å­˜å™¨çš„åå­—ç§°å‘¼è¿™äº›å¯„å­˜å™¨ã€‚&lt;/p>
&lt;p>é€šç”¨å¯„å­˜å™¨çš„ç”¨é€”å¹¶ä¸æ˜¯ç»å¯¹çš„ï¼Œç¨‹åºå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦å°†é€šç”¨å¯„å­˜å™¨æŒªä½œå®ƒç”¨ã€‚&lt;/p>
&lt;p>å…¶ä¸­ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>16ä½å¯„å­˜å™¨æœ¬èº«æ˜¯32ä½å¯„å­˜å™¨çš„ä½16ä½ã€‚32ä½å¯„å­˜å™¨çš„é«˜16ä½æ²¡æœ‰å•ç‹¬çš„åŠ©è®°ç¬¦ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>16ä½å¯„å­˜å™¨åˆå¯ä»¥å•ç‹¬åˆ†æˆä¸¤ä¸ª8ä½å¯„å­˜å™¨ä½¿ç”¨ã€‚å…¶ä¸­å¦‚&lt;code>AH&lt;/code>å½¢å¼çš„å¯„å­˜å™¨è¡¨ç¤º&lt;code>AX&lt;/code>é«˜ä½8æ¯”ç‰¹ï¼Œ&lt;code>AL&lt;/code>åˆ™è¡¨ç¤ºä½ä½8æ¯”ç‰¹ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="edi-å’Œ-esi">EDI å’Œ ESI&lt;/h3>
&lt;p>å…³äº&lt;code>EDI&lt;/code>å’Œ&lt;code>ESI&lt;/code>è¿™ä¸¤ä¸ªå¯„å­˜å™¨çš„ç”¨é€”å¯ä»¥å‚è€ƒ &lt;a class="link" href="https://stackoverflow.com/questions/1856320/purpose-of-esi-edi-registers" target="_blank" rel="noopener"
>stack overflow çš„è¿™ç¯‡é—®ç­”&lt;/a>ã€‚æ‘˜ä¸€æ®µä¾‹å­ï¼Œä¸‹é¢çš„Cä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="n">srcp&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">srcidx&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥è¢«ç¼–è¯‘æˆä¸‹é¢çš„æ±‡ç¼–è¯­å¥ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nf">mov&lt;/span> &lt;span class="no">edx&lt;/span>&lt;span class="p">,[&lt;/span>&lt;span class="no">ebp&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="no">c&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">ecx&lt;/span>&lt;span class="p">,[&lt;/span>&lt;span class="no">edx&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">*&lt;/span>&lt;span class="no">ebx&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ebp&lt;/span>&lt;span class="err">+&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">*&lt;/span>&lt;span class="no">edi-54&lt;/span>&lt;span class="p">],&lt;/span>&lt;span class="no">ecx&lt;/span>
&lt;span class="nf">inc&lt;/span> &lt;span class="no">edi&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>ebp+0c&lt;/code>åŒ…å«äº†&lt;code>argv&lt;/code>å†…å®¹ï¼Œ&lt;code>ebx&lt;/code>å°±æ˜¯&lt;code>j&lt;/code>ï¼Œ&lt;code>edi&lt;/code>å°±æ˜¯&lt;code>srcidx&lt;/code>ã€‚&lt;/p>
&lt;h3 id="æ®µå¯„å­˜å™¨">æ®µå¯„å­˜å™¨&lt;/h3>
&lt;p>ç°ä»£æ“ä½œç³»ç»Ÿé‡‡ç”¨å†…å­˜åˆ†é¡µæ¨¡å¼ï¼ŒæŠŠæ‰€æœ‰æ®µå¯„å­˜å™¨æŒ‡å‘åŒå€æ¥ç¦ç”¨å†…å­˜åˆ†æ®µæ¨¡å¼ã€‚ç„¶è€Œ&lt;code>FS&lt;/code>å’Œ&lt;code>GS&lt;/code>ä¾ç„¶ç”¨äºå†…å­˜åˆ†æ®µæ¨¡å¼ï¼Œç”¨äºçº¿ç¨‹å†…æ•°æ®å­˜å–ã€‚&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>æ®µå¯„å­˜å™¨åŠ©è®°ç¬¦&lt;/th>
&lt;th>æè¿°&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;code>SS&lt;/code>&lt;/td>
&lt;td>Stack Segmentï¼Œæ ˆæ®µ&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>CS&lt;/code>&lt;/td>
&lt;td>Code Segmentï¼Œä»£ç æ®µ&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>DS&lt;/code>&lt;/td>
&lt;td>Data Segmentï¼Œæ•°æ®æ®µ&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>ES&lt;/code>&lt;/td>
&lt;td>Extra Segmentï¼Œé¢å¤–æ•°æ®æ®µ&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>FS&lt;/code>&lt;/td>
&lt;td>æ›´é¢å¤–çš„æ•°æ®æ®µ&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>GS&lt;/code>&lt;/td>
&lt;td>æ›´é¢å¤–çš„æ•°æ®æ®µ&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>x86ä¸€å…±æœ‰6ä¸ªæ®µå¯„å­˜å™¨ï¼Œæ‰€æœ‰æ®µå¯„å­˜å™¨éƒ½æ˜¯16æ¯”ç‰¹ä½å®½ã€‚&lt;/p>
&lt;p>å…³äºæ®µå¯„å­˜å™¨ç”¨é€”å’Œè®¡ç®—æ”¾åœ¨ä¸»å­˜ä¸€èŠ‚ä¸­ã€‚&lt;/p>
&lt;h3 id="æŒ‡ä»¤æŒ‡é’ˆ-eip">æŒ‡ä»¤æŒ‡é’ˆ EIP&lt;/h3>
&lt;p>IP å¯„å­˜å™¨å…¨ç§°æ˜¯ Instruction Pointer å¯„å­˜å™¨ï¼Œä¿å­˜æ€»æ˜¯ä¿å­˜ä¸‹ä¸€æŒ‡ä»¤çš„åœ°å€ã€‚&lt;/p>
&lt;p>x86å®æ¨¡å¼ä¸‹ä½¿ç”¨æ®µå†…å­˜ç®¡ç†ï¼Œå¯å¯»å€1MBå†…å­˜ç©ºé—´ï¼Œé‡‡ç”¨åŸºå€ï¼ˆæ®µå¯„å­˜å™¨ï¼‰å·¦ç§»4ä½åŠ ä¸Šåç§»é‡ï¼Œç›¸å½“äº20æ¯”ç‰¹ä½å®½åœ°å€æ€»çº¿ã€‚å®æ¨¡å¼ä¸‹EIPå¯ä»¥å’ŒCSä»£ç æ®µå¯„å­˜å™¨ç»“åˆæ±‚å–ä¸‹ä¸€æŒ‡ä»¤çš„å…·ä½“åœ°å€ã€‚&lt;/p>
&lt;h3 id="æ ‡å¿—å¯„å­˜å™¨">æ ‡å¿—å¯„å­˜å™¨&lt;/h3>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>åŠ©è®°ç¬¦&lt;/th>
&lt;th>æè¿°&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;code>CF&lt;/code>&lt;/td>
&lt;td>Carry Flagï¼Œè¿›ä½æˆ–å€Ÿä½æº¢å‡ºæ—¶è®°ä¸º1ï¼Œå¦åˆ™0&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>PF&lt;/code>&lt;/td>
&lt;td>Parity Flagï¼Œè¿ç®—ç»“æœæœ€ä½å­—èŠ‚æœ‰å¶æ•°ä¸ª1ä½æ—¶è®°ä¸º1ï¼Œå¦åˆ™0&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>AF&lt;/code>&lt;/td>
&lt;td>Auxiliary Flagï¼ŒBCDç ç®—æœ¯è¿ç®—ä¸­è¿›ä½æˆ–å€Ÿä½æº¢å‡ºï¼Œå³è¿ç®—ç»“æœç¬¬ä¸‰ä½å‘ç”Ÿè¿›å€Ÿä½æ—¶è®°1ï¼Œå¦åˆ™0&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>ZF&lt;/code>&lt;/td>
&lt;td>Zero Flagï¼Œè¿ç®—ç»“æœä¸º0æ—¶è®°1ï¼Œå¦åˆ™0&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>SF&lt;/code>&lt;/td>
&lt;td>Sign Flagï¼Œè®°è¿ç®—ç»“æœæœ€é«˜ä½ï¼ˆç¬¦å·ä½ï¼‰&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>TF&lt;/code>&lt;/td>
&lt;td>Trap Flagï¼Œå•æ­¥è°ƒè¯•è®°1ï¼Œå¦åˆ™0&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>IF&lt;/code>&lt;/td>
&lt;td>Interrupt Enable Flagï¼Œæ˜¯å¦å…è®¸å“åº”ä¸­æ–­&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>DF&lt;/code>&lt;/td>
&lt;td>Direction Flagï¼Œä¸²æ–¹å‘æ ‡è®°ï¼ŒæŒ‡ç¤ºä¸²æŒ‡ä»¤ä»é«˜åœ°å€å‘ä½åœ°å€è¿˜æ˜¯ä½åœ°å€å‘é«˜åœ°å€å¤„ç†ã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>OF&lt;/code>&lt;/td>
&lt;td>Overflow Flagï¼ŒæŒ‡ç¤ºç®—æœ¯è¿ç®—æ˜¯å¦æº¢å‡ºã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>IOPL&lt;/code>&lt;/td>
&lt;td>I/O Privilege Levelï¼ŒI/Oç‰¹æƒçº§ï¼Œ2æ¯”ç‰¹å®½ï¼Œ&lt;code>CPL&lt;/code>å°äºç­‰äº&lt;code>IOPL&lt;/code>æ‰å…è®¸è®¿é—®I/Oåœ°å€ç©ºé—´ã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>NT&lt;/code>&lt;/td>
&lt;td>Nested Task Flagï¼Œå½“å‰ä»»åŠ¡é“¾æ¥ä¸Šè¡£ä»»åŠ¡æ—¶ç½®1ï¼Œå¦åˆ™0ã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>RF&lt;/code>&lt;/td>
&lt;td>Resume Flagï¼Œæ§åˆ¶å¤„ç†å™¨å¯¹é™¤éšœå¼‚å¸¸çš„å“åº”ã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>VM&lt;/code>&lt;/td>
&lt;td>Virtual-8086 Mode Flagï¼Œè™šæ‹Ÿ8086æ¨¡å¼æ ‡å¿—ï¼Œç½®1æ—¶è¿›å…¥è™šæ‹Ÿ8086æ¨¡å¼ï¼Œæ¸…0è¿”å›ä¿æŠ¤æ¨¡å¼ã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>AC&lt;/code>&lt;/td>
&lt;td>Alignment Check Flagï¼Œè¯¥æ ‡å¿—ä»¥åŠåœ¨CR0å¯„å­˜å™¨ä¸­çš„AMä½ç½®1æ—¶å°†å…è®¸å†…å­˜å¼•ç”¨çš„å¯¹é½æ£€æŸ¥ï¼Œä»¥ä¸Šä¸¤ä¸ªæ ‡å¿—ä¸­è‡³å°‘æœ‰ä¸€ä¸ªè¢«æ¸…é›¶åˆ™ç¦ç”¨å¯¹é½æ£€æŸ¥ã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>VIF&lt;/code>&lt;/td>
&lt;td>Virtual interrupt flagï¼Œè¯¥æ ‡å¿—æ˜¯IFæ ‡å¿—çš„è™šæ‹Ÿé•œåƒ(Virtual image)ï¼Œä¸VIPæ ‡å¿—ç»“åˆèµ·æ¥ä½¿ç”¨ã€‚ä½¿ç”¨è¿™ä¸ªæ ‡å¿—ä»¥åŠVIPæ ‡å¿—ï¼Œå¹¶è®¾ç½®CR4æ§åˆ¶å¯„å­˜å™¨ä¸­çš„VMEæ ‡å¿—å°±å¯ä»¥å…è®¸è™šæ‹Ÿæ¨¡å¼æ‰©å±•(virtual mode extensions)ã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>VIP&lt;/code>&lt;/td>
&lt;td>Virtual interrupt pending flagï¼Œè¯¥ä½ç½®1ä»¥æŒ‡ç¤ºä¸€ä¸ªä¸­æ–­æ­£åœ¨è¢«æŒ‚èµ·ï¼Œå½“æ²¡æœ‰ä¸­æ–­æŒ‚èµ·æ—¶è¯¥ä½æ¸…é›¶ã€‚ä¸VIFæ ‡å¿—ç»“åˆä½¿ç”¨ã€‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>ID&lt;/code>&lt;/td>
&lt;td>Identification flagï¼Œç¨‹åºèƒ½å¤Ÿè®¾ç½®æˆ–æ¸…é™¤è¿™ä¸ªæ ‡å¿—æŒ‡ç¤ºäº†å¤„ç†å™¨å¯¹CPUIDæŒ‡ä»¤çš„æ”¯æŒã€‚&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="ä¸»å­˜">ä¸»å­˜&lt;/h2>
&lt;h3 id="è¿è¡Œæ¨¡å¼å’Œåœ°å€æ¨¡å‹">è¿è¡Œæ¨¡å¼å’Œåœ°å€æ¨¡å‹&lt;/h3>
&lt;p>x86 CPU è¿è¡Œæ¨¡å¼ä¸»è¦è€ƒè™‘&lt;strong>å®æ¨¡å¼&lt;/strong>å’Œ&lt;strong>ä¿æŠ¤æ¨¡å¼&lt;/strong>ï¼Œä»¥åŠç‰¹æ®Šçš„&lt;strong>è™šæ‹Ÿ8086æ¨¡å¼&lt;/strong>ã€‚&lt;/p>
&lt;p>å®æ¨¡å¼æœ‰è‡ªå·±çš„ç‹¬ç‰¹åœ°å€ç©ºé—´æ¨¡å‹ï¼Œä¸‹å¯è§†ä½œ16ä½CPU+20æ¯”ç‰¹æ— ä¿æŠ¤åœ°å€ç©ºé—´ï¼Œä½¿ç”¨æ®µå¯„å­˜å™¨å’Œé€šç”¨16ä½é€šç”¨å¯„å­˜å™¨ç»„åˆå¯»å€ï¼Œç®—æ³•&lt;code>base&amp;lt;&amp;lt;4+offset&lt;/code>ã€‚æœ€å¤§å¯å¯»å€1MBã€‚&lt;/p>
&lt;p>è™šæ‹Ÿ8086æ¨¡å¼ç”¨äºåœ¨ä¿æŠ¤æ¨¡å¼ä¸‹è¿è¡Œå®æ¨¡å¼ç¨‹åºï¼Œå¹¶ä¸æ˜¯çœŸæ­£çš„CPUæ¨¡å¼ï¼ŒCPUå®é™…è¿˜æ˜¯è¿è¡Œåœ¨ä¿æŠ¤æ¨¡å¼ã€‚ä¸€äº›ç¨‹åºåˆ©ç”¨è™šæ‹Ÿ8086æ¨¡å¼å¯ä»¥å®ç°åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹è¿è¡Œå®æ¨¡å¼ç¨‹åºï¼Œå¦‚ dosboxã€dosemu ã€‚&lt;/p>
&lt;p>ä¿æŠ¤æ¨¡å¼ä¸‹å¯ä»¥ç”¨&lt;strong>é€»è¾‘åœ°å€&lt;/strong>è®¿é—®ä¸»å­˜ï¼Œé€»è¾‘åœ°å€åˆç§°&lt;strong>è¿œæŒ‡é’ˆ&lt;/strong>ï¼ˆ&lt;code>far ptr&lt;/code>ï¼‰ï¼Œé€»è¾‘åœ°å€ç”±æ®µé€‰æ‹©å™¨åŠ ä¸Šåç§»å¯»å€ç»„æˆã€‚è¿è¡Œäº IA-32 ä½“ç³»çš„ç¨‹åºï¼Œæ®µé€‰æ‹©å™¨æœ€å¤šå¯ä»¥é€‰æ‹© 2^14^-1 ä¸ªæ®µï¼Œæ¯ä¸ªæ®µå¯ä»¥é•¿è¾¾ 2^32^ å­—èŠ‚ã€‚&lt;/p>
&lt;h3 id="nearfarhuge-æŒ‡é’ˆ">near/far/huge æŒ‡é’ˆ&lt;/h3>
&lt;p>near æŒ‡é’ˆæ˜¯ç»™å®šæ®µå†…ç”¨16æ¯”ç‰¹è¡¨ç¤ºçš„åç§»å€¼ï¼Œæœ€å¤§è®¿é—®åœ°å€ç©ºé—´64KBã€‚&lt;/p>
&lt;p>far æŒ‡é’ˆæ˜¯32æ¯”ç‰¹è¡¨ç¤ºçš„åç§»å€¼ï¼Œåœ¨16ä½æ¶æ„ä¸‹å¯ä»¥è®¿é—®æ®µå¤–çš„å†…å­˜ï¼Œ32/64ä½æ¶æ„ä¸‹åˆ™ä¾ç„¶æ˜¯æ®µå†…ã€‚&lt;/p>
&lt;p>hugeæŒ‡é’ˆå’ŒfaræŒ‡é’ˆå¤§å°ç›¸åŒï¼Œå¤§ä½“ç›®æ ‡å°±æ˜¯åœ¨16ä½é™åˆ¶ä¸‹è®¿é—®æ›´å¤§çš„åœ°å€ç©ºé—´ã€‚&lt;/p>
&lt;h3 id="å¹³å¦å†…å­˜æ¨¡å‹çº¿æ€§å†…å­˜æ¨¡å‹">å¹³å¦å†…å­˜æ¨¡å‹/çº¿æ€§å†…å­˜æ¨¡å‹&lt;/h3>
&lt;p>å‚è€ƒï¼š&lt;a class="link" href="https://en.wikipedia.org/wiki/Flat_memory_model" target="_blank" rel="noopener"
>flat memory model - wiki&lt;/a>&lt;/p>
&lt;p>å¹³å¦å†…å­˜æ¨¡å‹ä¹Ÿå«çº¿æ€§å†…å­˜æ¨¡å‹ï¼Œå®šä¹‰æ˜¯ç¨‹åºä¸­çš„å†…å­˜åœ¨åŒä¸€ä¸ªè¿ç»­çš„åœ°å€ç©ºé—´ä¸­ï¼Œä¸éœ€è¦é€šè¿‡åˆ†æ®µæˆ–åˆ†é¡µæœºåˆ¶é—´æ¥å–å€ã€‚ï¼ˆä»æ“ä½œç³»ç»Ÿæˆ–ç¡¬ä»¶è§’åº¦æ¥è¯´ï¼Œå¯èƒ½ä¾ç„¶æœ‰åˆ†é¡µæˆ–åˆ†æ®µï¼Œä½†å¯¹ç”¨æˆ·ç¨‹åºæ¥è¯´æ— æ„ŸçŸ¥ï¼‰ã€‚&lt;/p>
&lt;h3 id="intel-å†…å­˜æ¨¡å‹">Intel å†…å­˜æ¨¡å‹&lt;/h3>
&lt;p>ä¸‹è¿°å†…å­˜æ¨¡å‹æ˜¯å®æ¨¡å¼ä¸‹çš„ï¼Œä¿æŠ¤æ¨¡å¼ä¸‹æ›´è¿‘ä¼¼äºçº¿æ€§æ¨¡å‹ã€‚&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>æ¨¡å‹&lt;/th>
&lt;th>æ•°æ®æ®µæŒ‡é’ˆ&lt;/th>
&lt;th>ä»£ç æ®µæŒ‡é’ˆ&lt;/th>
&lt;th>å®šä¹‰&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Tiny&lt;/td>
&lt;td>near&lt;/td>
&lt;td>near&lt;/td>
&lt;td>CS=DS=SS&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Small&lt;/td>
&lt;td>near&lt;/td>
&lt;td>near&lt;/td>
&lt;td>DS=SS&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Medium&lt;/td>
&lt;td>near&lt;/td>
&lt;td>far&lt;/td>
&lt;td>DS=SSï¼Œå¤šä¸ªä»£ç æ®µ&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Compact&lt;/td>
&lt;td>far&lt;/td>
&lt;td>near&lt;/td>
&lt;td>ä¸€ä¸ªä»£ç æ®µï¼Œå¤šä¸ªæ•°æ®æ®µ&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Large&lt;/td>
&lt;td>far&lt;/td>
&lt;td>far&lt;/td>
&lt;td>å¤šä¸ªä»£ç æ®µå’Œæ•°æ®æ®µ&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Huge&lt;/td>
&lt;td>huge&lt;/td>
&lt;td>far&lt;/td>
&lt;td>å¤šä¸ªä»£ç æ®µå’Œæ•°æ®æ®µï¼Œå•ä¸ªæ•°ç»„å¯èƒ½è¶…è¿‡64KB&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;ul>
&lt;li>åœ¨Tinyæ¨¡å‹ä¸‹ï¼Œæ‰€æœ‰æ®µå¯„å­˜å™¨æŒ‡é’ˆæŒ‡å‘ç›¸åŒçš„æ®µã€‚&lt;/li>
&lt;li>åœ¨æ‰€æœ‰DS=SSçš„æ¨¡å‹é‡Œï¼Œæ•°æ®æ®µæŒ‡é’ˆæ€»æ˜¯nearã€‚&lt;/li>
&lt;li>æ ˆæ€»æ˜¯é™åˆ¶åœ¨æœ€é«˜64KBã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="å‡½æ•°">å‡½æ•°&lt;/h2>
&lt;h3 id="æ ˆ">æ ˆ&lt;/h3>
&lt;p>å‚è€ƒï¼š&lt;a class="link" href="https://www.zhihu.com/question/36103513" target="_blank" rel="noopener"
>æ ˆçš„å¢é•¿æ–¹å‘ï¼Ÿ - çŸ¥ä¹&lt;/a>&lt;/p>
&lt;p>è®¨è®ºå¯¹è±¡æ˜¯ Windows x86 32ä½ç¨‹åºã€‚æ ˆä»é«˜ä½å‘ä½ä½å¢é•¿ï¼Œéœ€è¦æ³¨æ„çœ‹æ ˆè§†å›¾çš„åœ°å€æ˜¯é«˜åœ°å€åœ¨ä¸Šè¿˜æ˜¯ä½åœ°å€åœ¨ä¸Šï¼Œè¢«è°ƒç”¨æ–¹çš„æ ˆå¸§æ€»æ˜¯åœ¨è°ƒç”¨æ–¹çš„å¢é•¿æ–¹å‘ä¸Šã€‚&lt;/p>
&lt;p>ä¾‹å¦‚ä¸‹é¢çš„æ±‡ç¼–æŒ‡ä»¤ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nf">push&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; æŠŠeaxå½“å‚æ•°å…¥æ ˆ esp=75f888
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">push&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; æŠŠeaxå½“å‚æ•°å…¥æ ˆ esp=75f884
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">push&lt;/span> &lt;span class="no">eax&lt;/span> &lt;span class="c">; æŠŠeaxå½“å‚æ•°å…¥æ ˆ esp=75f880
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">call&lt;/span> &lt;span class="no">example.fn&lt;/span> &lt;span class="c">; è°ƒç”¨
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">add&lt;/span> &lt;span class="no">esp&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">0xc&lt;/span> &lt;span class="c">; è°ƒç”¨æ–¹æ¸…æ ˆï¼Œcdeclè°ƒç”¨çº¦å®š
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰§è¡ŒcallæŒ‡ä»¤ï¼Œè·³è½¬åˆ°è¢«è°ƒç”¨å‡½æ•°æ—¶ï¼Œæ ˆä¸Šä¼šå‹å…¥å‡½æ•°çš„è¿”å›åœ°å€ã€‚&lt;/p>
&lt;h3 id="æ ˆæŒ‡é’ˆ-frame-pointer">æ ˆæŒ‡é’ˆ frame pointer&lt;/h3>
&lt;p>æ ˆæŒ‡é’ˆå¯ä»¥é€šè¿‡ç¼–è¯‘å‚æ•° &lt;code>-fomit-frame-pointer&lt;/code> æˆ– &lt;code>/Oy-&lt;/code> æ¥å…³é—­ã€‚&lt;/p>
&lt;p>åœ¨æœ‰æ ˆæŒ‡é’ˆï¼ˆframe pointerï¼‰çš„æƒ…å†µä¸‹ï¼Œæ¯ä¸ªå‡½æ•°å¼€å¤´ä¼šåšä¸€ä¸ª&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nf">push&lt;/span> &lt;span class="no">ebp&lt;/span>
&lt;span class="nf">mov&lt;/span> &lt;span class="no">ebp&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="no">esp&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>çš„åŠ¨ä½œï¼Œè¿™ä¸ªåŠ¨ä½œåšå®Œåï¼Œæ–°æ ˆå¸§çš„æ ˆåº•å°±æ˜¯ ebp äº†ï¼Œebpæ­£å¥½æŒ‡å‘æ—§æ ˆå¸§åŸºåœ°å€ï¼Œåœ¨ebpä¸‹ï¼ˆå’Œæ ˆå¢é•¿æ–¹å‘ç›¸åï¼‰å°±æ˜¯å‡½æ•°è¿”å›åœ°å€å’Œè°ƒç”¨æ–¹ç»™çš„å®å‚ã€‚&lt;/p>
&lt;p>åœ¨å‡½æ•°è¿”å›å‰ï¼Œåˆä¼šåšä¸€ä¸ª&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nf">pop&lt;/span> &lt;span class="no">ebp&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¥å®Œæˆå¹³æ ˆã€‚&lt;/p>
&lt;p>ä¸‹é¢å°±æ˜¯è¢«è°ƒå‡½æ•°æ‰§è¡Œå®Œå‡½æ•°å¼€å¤´çš„æŒ‡ä»¤åçš„æ ˆã€‚&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>åœ°å€ï¼ˆæ ˆå‘ä¸‹å¢é•¿ï¼‰&lt;/th>
&lt;th>å†…å®¹å«ä¹‰&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;code>[ebp+0x10]&lt;/code>&lt;/td>
&lt;td>ç¬¬3ä¸ªå‚æ•°&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>[ebp+0xc]&lt;/code>&lt;/td>
&lt;td>ç¬¬2ä¸ªå‚æ•°&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>[ebp+0x8]&lt;/code>&lt;/td>
&lt;td>ç¬¬1ä¸ªå‚æ•°&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>[ebp+0x4]&lt;/code>&lt;/td>
&lt;td>å‡½æ•°çš„è¿”å›åœ°å€&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>[ebp]&lt;/code>&lt;/td>
&lt;td>ä¸Šä¸€ä¸ªæ ˆå¸§åŸºåœ°å€ï¼Œæ­¤æ—¶&lt;code>esp&lt;/code>å’Œ&lt;code>ebp&lt;/code>ç›¸åŒã€‚&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>å…³é—­æ ˆæŒ‡é’ˆçš„æƒ…å†µä¸‹ï¼Œå‡½æ•°ä¸ä¼šåœ¨å¼€å¤´ä¿å­˜ebpäº†ï¼Œå¯¹å‡½æ•°å‚æ•°çš„å¼•ç”¨ä¹Ÿä¼šæ”¹ä¸ºç›¸å¯¹espçš„åç§»ã€‚&lt;/p>
&lt;h3 id="è°ƒç”¨çº¦å®š">è°ƒç”¨çº¦å®š&lt;/h3>
&lt;p>å…ˆè®¨è®º cdecl è°ƒç”¨çº¦å®šï¼Œå‡½æ•°è°ƒç”¨çš„ä¸€èˆ¬è¿‡ç¨‹æ˜¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nf">push&lt;/span> &lt;span class="mi">0x0&lt;/span> &lt;span class="c">; å‹æ ˆå‚æ•° 0
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">push&lt;/span> &lt;span class="no">example.50be50&lt;/span> &lt;span class="c">; å‹æ ˆå‚æ•° &amp;#34;%d&amp;#34;
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">call&lt;/span> &lt;span class="no">example._printf&lt;/span> &lt;span class="c">; è°ƒç”¨ printf(&amp;#34;%d&amp;#34;, 0)
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="no">add&lt;/span> &lt;span class="no">esp&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">0x8&lt;/span> &lt;span class="c">; cdecl çº¦å®šä¸‹ï¼Œè°ƒç”¨è€…æ¸…æ ˆ
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>stdcall&lt;/code>è°ƒç”¨çº¦å®šå’Œ&lt;code>cdecl&lt;/code>è°ƒç”¨çº¦å®šçš„åŒºåˆ«åœ¨äº&lt;code>stdcall&lt;/code>æ˜¯è¢«è°ƒç”¨æ–¹æ¸…æ ˆï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nf">ret&lt;/span> &lt;span class="mi">0x8&lt;/span> &lt;span class="c">; ret æœ‰ä¸€ä¸ªçš„å¯é€‰å‚æ•°ï¼ŒæŒ‡ç¤ºè¦ä»æ ˆä¸Šå¼¹å‡ºå¤šå°‘ç©ºé—´ã€‚ç›¸å½“äºæ˜¯å…ˆ add esp,0x8 å† ret
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>cdecl&lt;/code>æ˜¯å¤§éƒ¨åˆ†ç¼–è¯‘å™¨åŒ…æ‹¬å¾®è½¯VC++é»˜è®¤çš„è°ƒç”¨çº¦å®šï¼Œ&lt;code>stdcall&lt;/code>æ˜¯æ‰€æœ‰ Windows API çš„è°ƒç”¨çº¦å®šã€‚&lt;/p>
&lt;h3 id="name-mangling">name mangling&lt;/h3>
&lt;p>å¥½åƒæ²¡æœ‰å¹¿æ³›ä½¿ç”¨çš„è¯‘åï¼Œå¯ä»¥å«åå­—ä¿®é¥°ã€åå­—é‡æ•´æˆ–æ”¹ç¼–ï¼Œæ„ä¼šå§ã€‚&lt;/p>
&lt;p>å¯¹äºæœ‰ä½¿ç”¨c/c++ç¼–ç¨‹ç»éªŒçš„äººå¯èƒ½å·²ç»è§è¿‡å¾ˆå¤šé“¾æ¥é”™è¯¯ï¼š&lt;/p>
&lt;ul>
&lt;li>undefined reference to &amp;hellip;&lt;/li>
&lt;li>æ— æ³•è§£æçš„å¤–éƒ¨ç¬¦å· &amp;hellip;&lt;/li>
&lt;/ul>
&lt;p>å¦‚æœæ³¨æ„è¿‡æç¤ºä¸­çš„ç¬¦å·ååº”è¯¥ä¼šå‘ç°è¿™äº›ç¬¦å·åç§°éƒ½ä¸æ˜¯ä»£ç é‡Œå†™çš„å‡½æ•°åç§°ï¼Œè€Œæ˜¯ç»è¿‡äº†å˜å½¢çš„ã€‚&lt;/p>
&lt;p>&lt;code>cdecl&lt;/code>è°ƒç”¨çº¦å®šä¸‹ï¼Œname mangling çš„è§„åˆ™æ˜¯åœ¨ç¬¦å·å‰åŠ ä¸‹åˆ’çº¿ã€‚æ¯”å¦‚Cåº“çš„&lt;code>printf&lt;/code>å‡½æ•°ï¼Œç»è¿‡name manglingåæ˜¯&lt;code>_printf&lt;/code>ã€‚&lt;/p>
&lt;p>&lt;code>stdcall&lt;/code>è°ƒç”¨çº¦å®šä¸‹ï¼Œname mangling çš„è§„åˆ™æ˜¯åœ¨ç¬¦å·å‰åŠ ä¸‹åˆ’çº¿ï¼Œç¬¦å·ååŠ  &lt;em>@å‚æ•°é•¿åº¦&lt;/em>ã€‚éœ€è¦æ³¨æ„çš„æ˜¯å¯¹äºCä¸­çš„å˜é•¿å‚æ•° variadic functionï¼Œæ˜¯ä¸èƒ½ç”¨ &lt;code>stdcall&lt;/code> è°ƒç”¨çº¦å®šçš„ã€‚&lt;/p>
&lt;p>ç”¨å‡½æ•° &lt;code>int fn(int a, int b)&lt;/code> ä¸¾ä¾‹ï¼Œè®¤ä¸º int æ˜¯ 4 å­—èŠ‚é•¿ï¼Œæ­¤æ—¶&lt;code>cdecl&lt;/code>ä¸‹å«&lt;code>_fn&lt;/code>ï¼Œ&lt;code>stdcall&lt;/code>ä¸‹å«&lt;code>_fn@8&lt;/code>ã€‚&lt;/p></description></item><item><title>ä¿¡å·é‡ vs äº’æ–¥é”</title><link>https://nnnewb.github.io/blog/p/%E4%BF%A1%E5%8F%B7%E9%87%8F-vs-%E4%BA%92%E6%96%A5%E9%94%81/</link><pubDate>Thu, 26 Aug 2021 00:00:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/%E4%BF%A1%E5%8F%B7%E9%87%8F-vs-%E4%BA%92%E6%96%A5%E9%94%81/</guid><description>&lt;p>çœ‹ &lt;a class="link" href="https://github.com/tmrts/go-patterns/blob/master/synchronization/semaphore.md" target="_blank" rel="noopener"
>go-patterns/semaphore.md at master Â· tmrts/go-patterns (github.com)&lt;/a> æ—¶äº§ç”Ÿäº†ç–‘é—®ï¼Œä¿¡å·é‡ä¸ºå•¥é•¿å¾—å’Œäº’æ–¥é”æ²¡å•¥åŒºåˆ«å‘¢ã€‚äºæ˜¯å°±è°·æ­Œäº†ä¸€åœˆï¼Œé‡æ¸©ä¸‹ä¸€äº›å…³äºå¹¶å‘çš„çŸ¥è¯†ï¼Œå¯¹æ¯”ä¿¡å·é‡ &lt;em>semaphore&lt;/em> å’Œäº’æ–¥é” &lt;em>mutex&lt;/em> ã€‚&lt;/p>
&lt;h2 id="äº’æ–¥é”-mutex">äº’æ–¥é” mutex&lt;/h2>
&lt;p>ä»¥ &lt;em>pthread&lt;/em> è‡ªå¸¦çš„äº’æ–¥é”ä¸ºä¾‹ï¼Œæä¾›äº†ä¸‰ç§ä¸åŒç±»å‹çš„äº’æ–¥é”ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;em>PTHREAD_MUTEX_NORMAL&lt;/em> ï¼Œæ™®é€šçš„äº’æ–¥é”ï¼Œä¸æ”¯æŒæ­»é”æ£€æµ‹ï¼ˆ&lt;em>does not detect deadlock&lt;/em>ï¼‰ï¼Œä¸æ”¯æŒé€’å½’åŠ é”ï¼ˆ&lt;em>relock without first unlocking it&lt;/em> ä¼šå¯¼è‡´æ­»é”ï¼‰ï¼Œä¸æ£€æµ‹è§£é”çº¿ç¨‹ï¼Œè§£é”ä¸€ä¸ªæœªåŠ é”çš„äº’æ–¥é”æ˜¯æœªå®šä¹‰è¡Œä¸ºï¼ˆ&lt;em>undefined behavior&lt;/em>ï¼‰ã€‚&lt;/li>
&lt;li>&lt;em>PTHREAD_MUTEX_ERRORCHECK&lt;/em>ï¼Œå¸¦é”™è¯¯æ£€æŸ¥çš„äº’æ–¥é”ï¼Œä¸æ”¯æŒé€’å½’åŠ é”ï¼ˆä¼šè¿”å›é”™è¯¯ï¼‰ï¼Œè§£é”å…¶ä»–çº¿ç¨‹çš„äº’æ–¥é”ä¼šè¿”å›é”™è¯¯ï¼Œè§£é”æœªåŠ é”çš„äº’æ–¥é”ä¼šè¿”å›é”™è¯¯ã€‚&lt;/li>
&lt;li>&lt;em>PTHREAD_MUTEX_RECURSIVE&lt;/em>ï¼Œé€’å½’åŠ é”ï¼ˆ&lt;em>relock with out unlocking it&lt;/em>ï¼‰ä¼šæˆåŠŸï¼Œè§£é”æ—¶éœ€è¦è°ƒç”¨è§£é”çš„æ¬¡æ•°å’ŒåŠ é”æ—¶è°ƒç”¨åŠ é”çš„æ¬¡æ•°ç›¸åŒã€‚è§£é”å…¶ä»–çº¿ç¨‹çš„äº’æ–¥é”ä¼šè¿”å›é”™è¯¯ã€‚è§£é”æœªåŠ é”çš„äº’æ–¥é”ä¼šè¿”å›é”™è¯¯ã€‚&lt;/li>
&lt;li>&lt;em>PTHREAD_MUTEX_DEFAULT&lt;/em>ï¼Œé»˜è®¤äº’æ–¥é”ç±»å‹ï¼Œå¯¹è¿™ä¸€ç±»å‹çš„äº’æ–¥é”é€’å½’åŠ é”æ—¶è¡Œä¸ºæ˜¯æœªå®šä¹‰çš„ï¼Œè§£é”æœªåŠ é”çš„äº’æ–¥é”è¡Œä¸ºæ˜¯æœªå®šä¹‰çš„ï¼Œè§£é”å…¶ä»–çº¿ç¨‹çš„äº’æ–¥é”è¡Œä¸ºæ˜¯æœªå®šä¹‰çš„ã€‚è¿™ä¸€ç±»å‹çš„äº’æ–¥é”é€šå¸¸æ˜ å°„ä¸ºå¦å¤–å‡ ç§äº’æ–¥é”ä¹‹ä¸€ã€‚&lt;/li>
&lt;/ul>
&lt;p>å¯ä»¥æ¯”è¾ƒæ¸…æ¥šåœ°çœ‹å‡ºï¼Œäº’æ–¥é”æœ‰ä¸‰ä¸ªåŸºæœ¬ç‰¹å¾ï¼š&lt;/p>
&lt;ul>
&lt;li>æ˜¯å¦å¯é‡å¤åŠ é”&lt;/li>
&lt;li>æ˜¯å¦å¯è§£é”æœªåŠ é”çš„äº’æ–¥é”&lt;/li>
&lt;li>æ˜¯å¦å¯è§£é”è¢«å…¶ä»–äººåŠ é”çš„äº’æ–¥é”&lt;/li>
&lt;/ul>
&lt;p>æœ€ä¸¥æ ¼çš„ &lt;em>PTHREAD_MUTEX_ERRORCHECK&lt;/em> ç±»å‹äº’æ–¥é”ï¼Œå¯¹æ­¤å®šä¹‰æ˜¯ NOã€NOã€NO ã€‚&lt;/p>
&lt;p>äº’æ–¥é”çš„åŸºæœ¬ä½¿ç”¨æ–¹å¼å’Œä½¿ç”¨åœºæ™¯æœ‰ç‚¹åƒå•æ‰€çš„å‘ä½ï¼š&lt;/p>
&lt;ol>
&lt;li>æŠ¢å‘ä½ï¼Œé”é—¨&lt;/li>
&lt;li>ä½ æ‡‚çš„&lt;/li>
&lt;li>è§£é”ï¼Œå‡ºé—¨&lt;/li>
&lt;/ol>
&lt;p>å…¶ä¸­æœ‰éšå«çš„ä¿¡æ¯åŒ…æ‹¬ï¼š&lt;/p>
&lt;ol>
&lt;li>å‘ä½æ˜¯æå‰é€‰æ‹©å¥½çš„ï¼Œä½ åªèƒ½æŠ¢ä¸€ä¸ªå‘ä½ï¼Œä¸èƒ½æŠ¢å¤šä¸ªå‘ä½ã€‚&lt;/li>
&lt;li>å‘ä½åœ¨ä½¿ç”¨æœŸé—´æ˜¯ç‹¬å çš„ï¼Œä½ ä¸èƒ½å’Œåˆ«äººåˆ†äº«ä¸€ä¸ªå‘ä½ã€‚&lt;/li>
&lt;li>åªæœ‰ä½ è‡ªå·±èƒ½è§£é”å‘ä½ï¼Œè°ä¹Ÿä¸æƒ³åŠäº‹å„¿çš„æ—¶å€™æœ‰äººé—¯è¿›æ¥å§ï¼Ÿ&lt;/li>
&lt;/ol>
&lt;p>è€Œé€’å½’åŠ é”è¿™ä¸€ç‰¹æ®Šåœºæ™¯ï¼Œæˆ‘å¯»æ€å§ï¼Œæœ‰ç‚¹éš¾æ‹¿å‘ä½æ¯”å–»ã€‚åæ­£ä¹Ÿä¸é‡è¦ï¼Œå°±åˆ«ç®¡äº†ã€‚&lt;/p>
&lt;h2 id="ä¿¡å·é‡-semaphore">ä¿¡å·é‡ semaphore&lt;/h2>
&lt;p>ä¿¡å·é‡æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ•´å‹å€¼ï¼Œä¸ç»†åˆ†ä»€ä¹ˆç±»å‹äº†ã€‚è¿˜æ˜¯ç”¨ &lt;em>pthread&lt;/em> ä¸¾ä¾‹å§ï¼Œä¾æ® &lt;em>POSIX&lt;/em> æ ‡å‡†ã€‚&lt;/p>
&lt;p>å¯¹ä¿¡å·é‡çš„æ“ä½œå¯ä»¥å…ˆç®€å•åˆ†5ç§ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;code>sem_init(sem,pshared,value)&lt;/code>ï¼Œåˆå§‹åŒ–ä¸€ä¸ªä¿¡å·é‡ï¼Œå¯ä»¥æŒ‡å®šè¦ä¸è¦åœ¨ &lt;code>fork()&lt;/code> åˆ›å»ºçš„è¿›ç¨‹é—´å…±äº«ï¼Œè¿˜å¯ä»¥æŒ‡å®šä¿¡å·é‡åˆå§‹å€¼ã€‚&lt;/li>
&lt;li>&lt;code>sem_wait(sem)&lt;/code>ï¼Œç­‰å¾…ä¿¡å·é‡ï¼Œä¿¡å·é‡ç­‰äº0æ—¶é˜»å¡ï¼Œå…¶ä»–çº¿ç¨‹é€šè¿‡&lt;code>sem_post&lt;/code>å”¤é†’ã€‚&lt;/li>
&lt;li>&lt;code>sem_post(sem)&lt;/code>ï¼Œå‘é€ä¿¡å·é‡ï¼Œå”¤é†’é˜»å¡åœ¨&lt;code>sem_wait&lt;/code>çš„çº¿ç¨‹ã€‚&lt;/li>
&lt;li>&lt;code>sem_getvalue(sem,valp)&lt;/code>ï¼Œè·å–ä¿¡å·é‡å½“å‰å€¼ã€‚&lt;/li>
&lt;li>&lt;code>sem_destroy(sem)&lt;/code>ï¼Œé”€æ¯ä¿¡å·é‡ã€‚&lt;/li>
&lt;/ul>
&lt;p>ä¿¡å·é‡çš„ä¸»è¦ç‰¹å¾å°±æ˜¯å®ƒçš„å€¼ï¼š&lt;/p>
&lt;ul>
&lt;li>å½“å€¼ç­‰äº0æ—¶ï¼Œ&lt;code>sem_wait&lt;/code> ä¼šé˜»å¡ã€‚&lt;/li>
&lt;li>å½“å€¼å¤§äº0æ—¶ï¼Œ&lt;code>sem_wait&lt;/code> è¿”å›å¹¶ä½¿å€¼-1ã€‚&lt;/li>
&lt;/ul>
&lt;p>å¯ä»¥æ³¨æ„åˆ°ï¼Œä¿¡å·é‡çš„ç¡®å¯ä»¥åšåˆ°äº’æ–¥é”èƒ½åšåˆ°çš„äº‹æƒ…ï¼šè®¾å®šå¥½åˆå§‹å€¼1ï¼Œç„¶å&lt;code>sem_wait&lt;/code>ç­‰åŒäºåŠ é”ï¼Œ&lt;code>sem_post&lt;/code>ç­‰åŒäºè§£é”ï¼Œçš„ç¡®æ¨¡æ‹Ÿå‡ºäº†äº’æ–¥é”çš„åŠŸèƒ½ã€‚&lt;/p>
&lt;p>ä¸è¿‡ä¿¡å·é‡å»æ¨¡æ‹Ÿäº’æ–¥é”ä¼šæœ‰ä¸€äº›é—®é¢˜ã€‚æ¯”å¦‚è¯´æ— æ³•å®ç°é€’å½’åŠ é”ï¼ˆä¿¡å·é‡å€¼ç­‰äº0æ—¶ï¼Œ&lt;code>sem_wait&lt;/code>ä¼šé˜»å¡ï¼‰ï¼Œæ— æ³•æ£€æµ‹è§£é”çº¿ç¨‹æ˜¯ä¸æ˜¯åŠ é”çº¿ç¨‹ï¼ˆé™¤éä½ è‡ªå·±å†å°è£…ä¸€æ¬¡ï¼ŒæŠŠä¿¡å·é‡å’Œçº¿ç¨‹IDç»‘å®šï¼‰ï¼Œè§£é”æœªåŠ é”ä¼šå¯¼è‡´ä¿¡å·é‡å€¼å¤§äº1ï¼Œè¿›è€Œé€ æˆ&lt;code>sem_wait&lt;/code>ä¼šå…è®¸å¤šä¸ªçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œï¼ˆè¿˜æ˜¯ä¸€æ ·ï¼Œä½ å¾—è‡ªå·±å°è£…ï¼Œåœ¨&lt;code>sem_post&lt;/code>å‰æ£€æŸ¥å½“å‰ä¿¡å·é‡çš„å€¼ï¼‰ã€‚&lt;/p>
&lt;p>å¥½ï¼Œæ¨¡æ‹Ÿäº’æ–¥é”çš„è¯é¢˜åˆ°æ­¤ä¸ºæ­¢ã€‚å›åˆ°å±å°¿å±çš„æ¯”å–»ä¸Šã€‚äº’æ–¥é”å¯ä»¥æ¯”ä½œå…¬å•æ”¶è´¹çš„è€å¤§çˆ·ã€‚&lt;/p>
&lt;ul>
&lt;li>è€è§„çŸ©ï¼Œä¸æ’é˜Ÿï¼Œå¤§å®¶ä»è€å¤§çˆ·æ‰‹é‡ŒæŠ¢å‘ä½ã€‚&lt;/li>
&lt;li>å‘ä½æ»¡å‘˜çš„æ—¶å€™è€å¤§çˆ·è°ä¹Ÿä¸è®©è¿›ã€‚&lt;/li>
&lt;li>æ¯å‡ºæ¥ä¸€ä¸ªäººï¼Œè€å¤§çˆ·å°±æ”¾è¿›å»ä¸€ä¸ªäººã€‚&lt;/li>
&lt;/ul>
&lt;p>å…¶ä¸­éšå«çš„ä¿¡æ¯åŒ…æ‹¬ï¼š&lt;/p>
&lt;ul>
&lt;li>å½“ç„¶ï¼Œå¯ç”¨çš„å‘ä½æˆ–è€…è¯´èµ„æºä¾ç„¶æ˜¯æœ‰é™çš„ï¼Œæ•°é‡ä¸ç¡®å®šã€‚&lt;/li>
&lt;li>ä½ åªèƒ½ç‹¬å ä¸€éƒ¨åˆ†èµ„æºï¼Œè€Œä¸”æ¯ä¸ªäººç‹¬å çš„èµ„æºéƒ½ä¸€æ ·å¤šã€‚ä¸ç„¶è€å¤§çˆ·çœ‹åˆ°æœ‰ä¸€ä¸ªå‘ä½æ”¾ä½ è¿›å»äº†ï¼Œä½†ä½ æƒ³è¦ç”¨ä¸¤ä¸ªå‘ä½ï¼Œé‚£ä½ å°±åªèƒ½ç»§ç»­ç­‰ç€ï¼Œæˆ–è€…å’Œåˆ«äººåˆ†äº«å‘ä½äº†ã€‚&lt;/li>
&lt;/ul>
&lt;p>ä¿¡å·é‡æœ€å¥½ç”¨çš„åœºæ™¯è¿˜æ˜¯ &lt;strong>ç”Ÿäº§è€…-æ¶ˆè´¹è€…&lt;/strong> æ¨¡å‹çš„é˜Ÿåˆ—ï¼Œæ¥ç»Ÿè®¡é˜Ÿåˆ—ä¸­å…ƒç´ æ•°é‡ã€‚æ¶ˆè´¹è€…å¯ä»¥ç”¨ä¸€ä¸ªç®€å•çš„ &lt;code>sem_timedwait&lt;/code> è°ƒç”¨å®ç°ç­‰å¾…æ–°å…ƒç´ åŠ å…¥é˜Ÿåˆ—ï¼Œç”¨äº’æ–¥é”æ¥ç¡®ä¿é˜Ÿåˆ—æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚&lt;/p>
&lt;p>å¯è§ç®¡å…¬å•çš„è€å¤§çˆ·ä¹Ÿæ˜¯éå¸¸æœ‰ç”Ÿæ´»æ™ºæ…§å“ˆï¼Œå……åˆ†åˆ©ç”¨äº†å¹´è½»æ—¶çš„ç¼–ç¨‹ç»éªŒæ¥æé«˜æ™šå¹´ç”Ÿæ´»è´¨é‡ã€‚&lt;/p>
&lt;h2 id="ç»“è®º">ç»“è®º&lt;/h2>
&lt;p>äº’æ–¥é”å’Œä¿¡å·é‡éƒ½èƒ½å¤„ç†æ•°æ®ç«äº‰ï¼Œä½†å„æœ‰ä¾§é‡ã€‚&lt;/p>
&lt;p>å…¸å‹çš„æ•°æ®ç«äº‰åœºæ™¯å½“ç„¶æ˜¯äº’æ–¥é”å¥½ç”¨ï¼Œä½†ä¿¡å·é‡ä¹Ÿä¸æ˜¯å®Œå…¨ä¸è¡Œã€‚&lt;/p>
&lt;p>ä¿¡å·é‡çš„å…¸å‹åœºæ™¯ä¹Ÿä¸€æ ·ï¼Œäº’æ–¥é”å³ä¾¿èƒ½è¡Œä¹Ÿä¼šæ˜¾å¾—åˆ«æ‰­ã€‚&lt;/p></description></item><item><title>é¢è¯•é¢˜ä¹‹ goroutine è¿è¡Œé¡ºåº</title><link>https://nnnewb.github.io/blog/p/%E9%9D%A2%E8%AF%95%E9%A2%98%E4%B9%8B-goroutine-%E8%BF%90%E8%A1%8C%E9%A1%BA%E5%BA%8F/</link><pubDate>Wed, 04 Aug 2021 10:37:24 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/%E9%9D%A2%E8%AF%95%E9%A2%98%E4%B9%8B-goroutine-%E8%BF%90%E8%A1%8C%E9%A1%BA%E5%BA%8F/</guid><description>&lt;p>ä¸æ˜¯æˆ‘åšçš„æ²™é›•é¢è¯•é¢˜ï¼Œåœ¨ segmentfault ä¸Šçœ‹åˆ°çš„ã€‚&lt;/p>
&lt;!-- more -->
&lt;h2 id="åŸé¢˜">åŸé¢˜&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;runtime&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;sync&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">runtime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GOMAXPROCS&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">wg&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">WaitGroup&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;A:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Done&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">num&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;B:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">num&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Done&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}(&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Wait&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>é—®ï¼šä»£ç è¾“å‡ºç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ&lt;/p>
&lt;h2 id="èƒ¡ä¹±åˆ†æ">èƒ¡ä¹±åˆ†æ&lt;/h2>
&lt;p>ç¬¬ä¸€çœ¼è¿›å»çœ‹åˆ° &lt;code>runtime.GOMAXPROCS(1)&lt;/code> ï¼Œåˆæ­¥æ€€ç–‘æ˜¯åˆåœ¨è€ƒä»€ä¹ˆ GMP é¢è¯•é¢˜äº†ã€‚&lt;/p>
&lt;p>ä½†å‡¡è¯´åˆ° Go é¢è¯•å¥½åƒå°±ä¸€å®šè¦è€ƒä¸€ä¸‹ goroutine è°ƒåº¦å’Œ GMP æ¨¡å‹ï¼Œæ‹›è¿›æ¥åˆåªè®©ä½ å†™ curd ã€‚æå¾—é¢è¯•è·Ÿè€ƒè¯•èƒŒä¹¦ä¸€æ ·ã€‚&lt;/p>
&lt;p>å…ˆä¸åæ§½ï¼Œç»§ç»­çœ‹ã€‚è·³è¿‡ä¸¤è¡Œ &lt;code>sync.WaitGroup&lt;/code> ä¹‹åå°±æ˜¯ä¸€ä¸ªç»å…¸ for å¾ªç¯é™·é˜±ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;A:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Done&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å°±æ˜¯ä¸ªå…¸å‹çš„é—­åŒ…æ•è·é—®é¢˜ï¼Œ&lt;code>i&lt;/code> è¢«ä»¥å¼•ç”¨å½¢å¼æ•è·è¿›åŒ¿åå‡½æ•°ï¼Œå¾ªç¯ä¸­çš„ &lt;code>i++&lt;/code> ä¼šå¯¼è‡´æ‰€æœ‰åŒ¿åå‡½æ•°æ•è·çš„ &lt;code>i&lt;/code> çš„å€¼éƒ½è·Ÿç€å˜ã€‚&lt;/p>
&lt;p>ä½†æœ‰æ‰€åŒºåˆ«çš„æ˜¯ï¼Œè¿™ä¸ªåŒ¿åå‡½æ•°è¢«å½“ goroutine æ‰§è¡Œäº†ã€‚ä¹‹åå†ç»†è¯´ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">num&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;B:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">num&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Done&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}(&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™å°±æ˜¯ä¸Šé¢é”™è¯¯ä¾‹å­çš„æ­£ç¡®å†™æ³•ï¼ŒæŠŠé—­åŒ…æ•è·å˜æˆäº†å‚æ•°ä¼ é€’ï¼Œå°† &lt;code>i&lt;/code> å¤åˆ¶äº†ä¸€ä»½è¿›åŒ¿åå‡½æ•°ã€‚&lt;/p>
&lt;p>å¥½äº†ï¼Œé‚£ä¹ˆæ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œæœ€ç»ˆç»“æœæ˜¯&amp;hellip;ï¼Ÿ&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">A: 5
A: 5
A: 5
A: 5
A: 5
B: 0
B: 1
B: 2
B: 3
B: 4
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ˜¯è¿™æ ·å—ï¼Ÿ&lt;/p>
&lt;h2 id="å†æ¬¡èƒ¡ä¹±åˆ†æ">å†æ¬¡èƒ¡ä¹±åˆ†æ&lt;/h2>
&lt;p>é—æ†¾çš„æ˜¯å®é™…è·‘èµ·æ¥ç»“æœæ˜¯&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">B: 4
A: 5
A: 5
A: 5
A: 5
A: 5
B: 0
B: 1
B: 2
B: 3
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°æœ€åä¸€ä¸ªå¯åŠ¨çš„ goroutine çš„è¾“å‡ºè·‘åˆ°äº†æœ€å¼€å¤´ã€‚å…¶ä»–é¡ºåºå€’æ˜¯æ²¡å•¥å˜åŒ–ã€‚ä¸ºå•¥å‘¢ï¼Ÿ&lt;/p>
&lt;p>å…ˆçœ‹ &lt;code>runtime.GOMAXPROCS(1)&lt;/code> ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/goroutines-schedule-order/G-M-P.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/goroutines-schedule-order/G-M-P.png"
loading="lazy"
alt="GMP">
&lt;/a>
&lt;figcaption>GMP&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>ä» GMP æ¨¡å‹å¯ä»¥å¾—çŸ¥è¿™ä¸€å¥ä»£ç å®é™…é™åˆ¶äº†æ‰€æœ‰ goroutine åªèƒ½è¢«é¡ºåºä¸²è¡Œæ‰§è¡Œï¼ˆæ‰€æœ‰ g éƒ½åªèƒ½åœ¨è¿™å”¯ä¸€ä¸€ä¸ª p çš„æœ¬åœ°é˜Ÿåˆ—é‡Œç­‰å¾… mï¼‰ã€‚&lt;/p>
&lt;p>è€Œ &lt;code>main()&lt;/code> å‡½æ•°é‡Œåˆ›å»º goroutine çš„é¡ºåºæ˜¯æ˜ç¡®çš„ï¼Œ5 ä¸ª Aï¼Œ5 ä¸ª Bã€‚&lt;/p>
&lt;p>æŒ‰ç…§ä¸€èˆ¬ç†è§£çš„è¯ï¼Œé˜Ÿåˆ—æ˜¯å…ˆè¿›å…ˆå‡º FIFO çš„ç»“æ„ï¼Œä¸€ä¸ª p åˆé™åˆ¶äº†å…¶ä»– m å³ä½¿å”¤é†’äº†ï¼ŒæŠ¢å äº† pï¼Œä¹Ÿä¸èƒ½åš work stealingï¼ˆä¹Ÿç”¨ä¸ç€åšï¼‰ï¼Œé‚£ä¹ˆ goroutine çš„æ‰§è¡Œé¡ºåºè‡ªç„¶åªèƒ½æ˜¯å…ˆè¿›å…ˆå‡ºäº†ã€‚&lt;/p>
&lt;p>é‚£ä¹ˆè¿™ä¸ªç¨‹åºçš„è¡Œä¸ºå°±å¾ˆå¥‡æ€ªäº†ï¼Œå…ˆåˆ›å»ºçš„ goroutine å…ˆæ‰§è¡Œçš„è¯ï¼Œé‚£ä¹ˆè¾“å‡ºé¡ºåºåº”è¯¥å’Œæˆ‘ä»¬é¢„æ–™çš„ä¸€æ ·ã€‚å®é™…è¿è¡Œç»“æœä¸ºä»€ä¹ˆä¼šå˜æˆè¿™æ ·å‘¢ï¼Ÿ&lt;/p>
&lt;h2 id="ä¸å–å…³å­äº†">ä¸å–å…³å­äº†&lt;/h2>
&lt;p>ç›´æ¥è¯´ç»“è®ºå—·ã€‚&lt;/p>
&lt;p>&lt;strong>ä¸çŸ¥é“ã€‚&lt;/strong>&lt;/p>
&lt;p>åˆ«ç¬‘ï¼ŒçœŸçš„ä¸çŸ¥é“ã€‚ç‰¹åœ°ä¸Š&lt;a class="link" href="https://stackoverflow.com/questions/35153010/goroutines-always-execute-last-in-first-out" target="_blank" rel="noopener"
>çˆ†æ ˆæœäº†ä¸‹&lt;/a>ï¼Œå¾—åˆ°çš„ç»“è®ºå°±æ˜¯ï¼Œä¸çŸ¥é“ã€‚&lt;/p>
&lt;blockquote>
&lt;p>In Go 1.5, the order in which goroutines are scheduled has been changed. &lt;strong>The properties of the scheduler were never defined by the language&lt;/strong>, but programs that depend on the scheduling order may be broken by this change. We have seen a few (erroneous) programs affected by this change. If you have programs that implicitly depend on the scheduling order, you will need to update them.&lt;/p>
&lt;/blockquote>
&lt;p>ä»ä¸€ä¸ª Go è¯­è¨€ä½¿ç”¨è€…çš„è§’åº¦æ¥è¯´ï¼Œgoroutine è°ƒåº¦å™¨çš„å®ç°ç»†èŠ‚ï¼ˆåƒæ˜¯å¤šä¸ª goroutine ä¹‹é—´çš„è¿è¡Œé¡ºåºï¼‰å¹¶ä¸æ˜¯èƒ½ä¾èµ–çš„ä¸œè¥¿ã€‚&lt;/p>
&lt;p>å¦‚æœå†™è¿‡ä¸€æ®µæ—¶é—´çš„ C/C++ ï¼Œé‚£ä¹ˆé¢è¯•å®˜åº”è¯¥å¾ˆæ¸…æ¥šï¼ŒC/C++ æœ‰å‡ æ ·è‡­åæ˜­è‘—çš„ä¸œè¥¿ï¼š &lt;em>Undefined Behavior&lt;/em>, &lt;em>Unspecified Behavior&lt;/em>ã€‚è€Œ goroutine æ‰§è¡Œé¡ºåºå°±æ˜¯ä¸€ä¸ª Go ä¸­çš„ &lt;em>Undefined Behavior&lt;/em>ã€‚&lt;/p>
&lt;h2 id="ç»“è®º">ç»“è®º&lt;/h2>
&lt;p>æˆ‘ç†è§£ä¸­çš„æ‹¿æ¥ä¸»ä¹‰ï¼Œæ—¢ä¸èƒ½è¢«åŠ¨åœ°ç­‰å¾…ï¼Œä¹Ÿä¸èƒ½ä¸åŠ åˆ†è¾¨åœ°æ‹¿æ¥ï¼Œè€Œæ—¢ç„¶åŠ ä»¥åˆ†è¾¨äº†ï¼Œè‡ªç„¶æ›´ä¸åº”è¯¥å°†æ‹¿æ¥çš„äº‹ç‰©å½“æˆè§£å†³ä¸€åˆ‡é—®é¢˜çš„ä¸‡èƒ½è¯ã€‚&lt;/p>
&lt;p>Go è™½ç„¶æ˜¯ä¸€é—¨ä¸é”™çš„è¯­è¨€ï¼Œè¯•å›¾å°†è¯­è¨€ç»†èŠ‚å°½å¯èƒ½æ˜ç¡®å®šä¹‰æ¥é¿å…å†æ¬¡é™·å…¥ C/C++çš„é™·é˜±ï¼Œä½†æ˜¾ç„¶ Go ç”¨æˆ·ä¸è¿™ä¹ˆæƒ³ã€‚è‡³å°‘ï¼Œæœ‰éƒ¨åˆ† Go ç”¨æˆ·ä¸è¿™ä¹ˆæƒ³ï¼Œä»–ä»¬æƒ³ææ¸…æ¥š Go çš„ä¸€åˆ‡ï¼Œç„¶åæŠŠè¿™ä¸€åˆ‡éƒ½å½“ä½œè‡³é«˜æ— ä¸Šçš„å‡†åˆ™ï¼Œæ¥é­æŒå…¶ä½™äººã€‚&lt;/p>
&lt;p>ç›®å‰ä¸ºæ­¢ï¼ŒGMP å¾ˆå¥½ï¼Œä½œä¸ºé¢è¯•é¢˜ä¹Ÿè¯´å¾—è¿‡å»ã€‚&lt;/p>
&lt;p>åˆ°åº•æˆ‘åªæ˜¯åŒæ¶è¿™ä¸–ä¸Šçš„ä¸€éƒ¨åˆ†äººç½¢äº†ã€‚&lt;/p></description></item><item><title>ç”¨ tree-sitter å†™ä¸€ä¸ªä»£ç é«˜äº®</title><link>https://nnnewb.github.io/blog/p/%E7%94%A8-tree-sitter-%E5%86%99%E4%B8%80%E4%B8%AA%E4%BB%A3%E7%A0%81%E9%AB%98%E4%BA%AE/</link><pubDate>Tue, 03 Aug 2021 15:52:21 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/%E7%94%A8-tree-sitter-%E5%86%99%E4%B8%80%E4%B8%AA%E4%BB%A3%E7%A0%81%E9%AB%98%E4%BA%AE/</guid><description>&lt;p>è¿™æ¬¡ç”¨ tree-sitter å†™ä¸€ä¸ªç®€å•çš„ä»£ç é«˜äº®ã€‚&lt;/p>
&lt;!-- more -->
&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>æˆ‘å¯»æ€ä»£ç é«˜äº®æ˜¯ä»€ä¹ˆåº”è¯¥æ²¡å•¥å¯è§£é‡Šçš„ï¼Œä¹Ÿæœ‰å«â€œè¯­æ³•é«˜äº®â€ï¼Œæ€»ä¹‹éƒ½æ˜¯ä¸€ä¸ªæ„æ€ã€‚å°±æ˜¯ç»™ç¼–è¾‘å™¨é‡Œçš„ä»£ç æ¶‚ä¸Šé¢œè‰²ï¼Œä¾¿äºé˜…è¯»ã€‚&lt;/p>
&lt;p>ä¸€èˆ¬æ¥è¯´ï¼Œç®€å•çš„ä»£ç é«˜äº®åªéœ€è¦æ­£åˆ™è¡¨è¾¾å¼å°±èƒ½æå®šï¼ˆæ¯”å¦‚è¯´å…³é”®å­—é«˜äº®ï¼ŒCamel Case æ ‡è¯†ç¬¦é«˜äº®ç­‰ï¼‰ï¼Œä¸è¿‡æ­£åˆ™è¡¨è¾¾å¼æ¥å®ç°é«˜äº®è¿˜æ˜¯æœ‰å¾ˆå¤§çš„å±€é™æ€§ã€‚&lt;/p>
&lt;p>ä¸¾ä¾‹æ¥è¯´ï¼Œå½“æˆ‘æŠŠå‡½æ•°å½“å‚æ•°ä¼ ç»™å¦ä¸€ä¸ªå‡½æ•°çš„æ—¶å€™â€”â€”&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-javascript" data-lang="javascript">&lt;span class="kd">function&lt;/span> &lt;span class="nx">f&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;span class="kd">function&lt;/span> &lt;span class="nx">higher&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="p">()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">fn&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">higher&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">f&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨ &lt;code>higher(f)&lt;/code> è¿™ä¸€è¡Œä¸­çš„ &lt;code>f&lt;/code> ä¸ä¼šä»¥å‡½æ•°åçš„é¢œè‰²æ ‡å‡ºã€‚è¿™å°±å¼•å‡ºäº†ä¸€ç§æ–°åŸºäºè¯­ä¹‰çš„ä»£ç é«˜äº®ï¼Œè®©ç¼–è¾‘å™¨çœŸæ­£â€œè®¤è¯†â€ä½ çš„ä»£ç ï¼Œå¹¶æä¾›æ›´èªæ˜çš„æç¤ºã€‚&lt;/p>
&lt;h2 id="å¼€å§‹">å¼€å§‹&lt;/h2>
&lt;p>è¿˜æ˜¯åœ¨ vscode æŠ˜è…¾ã€‚&lt;/p>
&lt;p>å…ˆåˆ›å»ºä¸€ä¸ª vscode æ’ä»¶é¡¹ç›®ï¼Œç”¨ &lt;code>yo code&lt;/code> å®Œæˆã€‚&lt;/p>
&lt;p>ç„¶åç¼–è¾‘ &lt;code>package.json&lt;/code> ï¼Œæ·»åŠ ä½ çš„è¯­è¨€å’Œæ’ä»¶çš„æ¿€æ´»äº‹ä»¶ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;activationEvents&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;onLanguage:proto&amp;#34;&lt;/span>&lt;span class="p">],&lt;/span>
&lt;span class="nt">&amp;#34;contributes&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;languages&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;id&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;proto&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;extensions&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;.proto&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">]&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶åä¿®æ”¹ &lt;code>src/extension.ts&lt;/code>ï¼Œå»æ‰é»˜è®¤åˆ›å»ºçš„ hello world ä»£ç ï¼Œç•™ä¸€ä¸ª &lt;code>console.log&lt;/code>ï¼Œç„¶å F5 å¯åŠ¨ï¼Œæ‰“å¼€ä¸€ä¸ª &lt;code>.proto&lt;/code> æ–‡ä»¶ï¼Œæ£€æŸ¥æ’ä»¶æ˜¯å¦å·²ç»æ¿€æ´»ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-typescript" data-lang="typescript">&lt;span class="c1">// The module &amp;#39;vscode&amp;#39; contains the VS Code extensibility API
&lt;/span>&lt;span class="c1">// Import the module and reference it with the alias vscode in your code below
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kr">import&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="kr">as&lt;/span> &lt;span class="nx">vscode&lt;/span> &lt;span class="kr">from&lt;/span> &lt;span class="s2">&amp;#34;vscode&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// this method is called when your extension is activated
&lt;/span>&lt;span class="c1">// your extension is activated the very first time the command is executed
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kr">export&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="nx">activate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>: &lt;span class="kt">vscode.ExtensionContext&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;activated!&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// this method is called when your extension is deactivated
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kr">export&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="nx">deactivate() {&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="åˆ›å»ºå’Œæ³¨å†Œ-documentsemantictokensprovider">åˆ›å»ºå’Œæ³¨å†Œ DocumentSemanticTokensProvider&lt;/h2>
&lt;p>åˆ›å»ºæ–‡ä»¶ &lt;code>src/providers/SemanticTokensProvider.ts&lt;/code> ï¼Œç¼–å†™ä¸€ä¸ªç±»ï¼Œå®ç°æ¥å£ &lt;code>vscode.DocumentSemanticTokensProvider&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-typescript" data-lang="typescript">&lt;span class="kr">import&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="kr">as&lt;/span> &lt;span class="nx">vscode&lt;/span> &lt;span class="kr">from&lt;/span> &lt;span class="s2">&amp;#34;vscode&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kr">const&lt;/span> &lt;span class="nx">Parser&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;web-tree-sitter&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kr">export&lt;/span> &lt;span class="k">default&lt;/span> &lt;span class="kr">class&lt;/span> &lt;span class="nx">SemanticTokenProvider&lt;/span>
&lt;span class="kr">implements&lt;/span> &lt;span class="nx">vscode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DocumentSemanticTokensProvider&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="kr">constructor&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kr">public&lt;/span> &lt;span class="nx">legend&lt;/span>: &lt;span class="kt">vscode.SemanticTokensLegend&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Parser&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">init&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nx">then&lt;/span>&lt;span class="p">(()&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Parser&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Language&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">load&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">path&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">resolve&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">__dirname&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;../../assets/tree-sitter-proto.wasm&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">).&lt;/span>&lt;span class="nx">then&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="nx">lang&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">parser&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">Parser&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">parser&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">setLanguage&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">lang&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">});&lt;/span>
&lt;span class="p">});&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">onDidChangeSemanticTokens?&lt;/span>: &lt;span class="kt">vscode.Event&lt;/span>&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">void&lt;/span>&lt;span class="p">&amp;gt;&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="kc">undefined&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="nx">provideDocumentSemanticTokens&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nb">document&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">vscode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TextDocument&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">token&lt;/span>: &lt;span class="kt">vscode.CancellationToken&lt;/span>
&lt;span class="p">)&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">vscode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ProviderResult&lt;/span>&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">vscode.SemanticTokens&lt;/span>&lt;span class="p">&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nb">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Not implemented&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å†åˆ° &lt;code>src/extension.ts&lt;/code> é‡Œæ³¨å†Œã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-ts" data-lang="ts">&lt;span class="kr">export&lt;/span> &lt;span class="kd">function&lt;/span> &lt;span class="nx">activate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>: &lt;span class="kt">vscode.ExtensionContext&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;activated!&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// register semantic tokens provider
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kr">const&lt;/span> &lt;span class="nx">tokenTypes&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>
&lt;span class="s2">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s2">&amp;#34;enum&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s2">&amp;#34;class&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s2">&amp;#34;function&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s2">&amp;#34;comment&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s2">&amp;#34;string&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s2">&amp;#34;number&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s2">&amp;#34;keyword&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s2">&amp;#34;parameter&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">];&lt;/span>
&lt;span class="kr">const&lt;/span> &lt;span class="nx">modifiers&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;definition&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;deprecated&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;documentation&amp;#34;&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="kr">const&lt;/span> &lt;span class="nx">selector&lt;/span>: &lt;span class="kt">vscode.DocumentSelector&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">language&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;proto&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">scheme&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;file&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">};&lt;/span>
&lt;span class="kr">const&lt;/span> &lt;span class="nx">legend&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">vscode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SemanticTokensLegend&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">tokenTypes&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">modifiers&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kr">const&lt;/span> &lt;span class="nx">provider&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">SemanticTokenProvider&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">legend&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">subscriptions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">push&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">vscode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">languages&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">registerDocumentSemanticTokensProvider&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">selector&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">provider&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">legend&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ä¸ª &lt;code>tree-sitter-proto.wasm&lt;/code> æ˜¯ç¼–è¯‘å¥½çš„è¯­æ³•å®šä¹‰ï¼Œå‚è€ƒ&lt;a class="link" href="./play-with-tree-sitter.md" >å¦ä¸€ç¯‡æ–‡ç« &lt;/a>ã€‚&lt;/p>
&lt;p>è¿™æ ·ä¸€æ¥ï¼Œ&lt;code>new SemanticTokenProvider(legend)&lt;/code> æ—¶å°±ä¼šåˆå§‹åŒ– parser äº†ã€‚&lt;/p>
&lt;h2 id="å®ç°">å®ç°&lt;/h2>
&lt;p>å…ˆå†™ä¸ªç®€å•çš„ &lt;code>provideDocumentSemanticTokens&lt;/code> å®ç°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-typescript" data-lang="typescript">&lt;span class="kr">class&lt;/span> &lt;span class="nx">SemanticTokenProvider&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">provideDocumentSemanticTokens&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nb">document&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">vscode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TextDocument&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">token&lt;/span>: &lt;span class="kt">vscode.CancellationToken&lt;/span>
&lt;span class="p">)&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">vscode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ProviderResult&lt;/span>&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">vscode.SemanticTokens&lt;/span>&lt;span class="p">&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kr">const&lt;/span> &lt;span class="nx">tree&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">parser&lt;/span>&lt;span class="o">?&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">parse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">document&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">getText&lt;/span>&lt;span class="p">());&lt;/span>
&lt;span class="kr">const&lt;/span> &lt;span class="nx">query&lt;/span>: &lt;span class="kt">Parser.Query&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">parser&lt;/span>
&lt;span class="o">?&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">getLanguage&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">.&lt;/span>&lt;span class="nx">query&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;(&amp;#34;message&amp;#34;) @keyword&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kr">const&lt;/span> &lt;span class="nx">captures&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">query&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">captures&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">tree&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">rootNode&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kr">const&lt;/span> &lt;span class="nx">tokenBuilder&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">vscode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SemanticTokensBuilder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">legend&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kr">const&lt;/span> &lt;span class="nx">capture&lt;/span> &lt;span class="k">of&lt;/span> &lt;span class="nx">captures&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">tokenBuilder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">push&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="k">new&lt;/span> &lt;span class="nx">vscode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Range&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="k">new&lt;/span> &lt;span class="nx">vscode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Position&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">capture&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">node&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">startPosition&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">row&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">capture&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">node&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">startPosition&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">column&lt;/span>
&lt;span class="p">),&lt;/span>
&lt;span class="k">new&lt;/span> &lt;span class="nx">vscode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Position&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">capture&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">node&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">endPosition&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">row&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">capture&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">node&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">endPosition&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">column&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="p">),&lt;/span>
&lt;span class="nx">capture&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">name&lt;/span>
&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kr">const&lt;/span> &lt;span class="nx">tokens&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">tokenBuilder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">build&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">Promise&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">resolve&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">tokens&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ€æ ¸å¿ƒçš„éƒ¨åˆ†å°±æ˜¯ &lt;code>getLanguage().query()&lt;/code> äº†ï¼Œè¿™é‡Œç”¨äº† tree-sitter çš„æŸ¥è¯¢è¯­è¨€ DSL å®ç°å¿«é€Ÿä»è¯­æ³•æ ‘é‡Œæå–å¯¹åº”çš„èŠ‚ç‚¹ã€‚&lt;/p>
&lt;p>æ”¾ä¸ª&lt;a class="link" href="https://tree-sitter.github.io/tree-sitter/using-parsers#query-syntax" target="_blank" rel="noopener"
>æŸ¥è¯¢è¯­è¨€çš„æ–‡æ¡£&lt;/a>ï¼Œå†ç®€è¦ä»‹ç»ä¸‹ã€‚&lt;/p>
&lt;blockquote>
&lt;p>A query consists of one or more patterns, where each pattern is an S-expression that matches a certain set of nodes in a syntax tree.&lt;/p>
&lt;/blockquote>
&lt;p>æœ¬è´¨ä¸ŠæŸ¥è¯¢è¯­è¨€æ˜¯ä¸ªæ¨¡å¼åŒ¹é…å·¥å…·ï¼Œä»¥ s-expression ä½œä¸ºæ¨¡å¼è¯­è¨€ã€‚ä¾‹å¦‚ä¸‹é¢çš„æŸ¥è¯¢ã€‚&lt;/p>
&lt;pre>&lt;code>(number)
&lt;/code>&lt;/pre>&lt;p>å°±æ˜¯æŸ¥è¯¢ ast é‡Œæ‰€æœ‰çš„ number èŠ‚ç‚¹ã€‚è€Œ number èŠ‚ç‚¹çš„å®šä¹‰åœ¨ tree-sitter é¡¹ç›®è¯­æ³•å®šä¹‰ &lt;code>grammar.js&lt;/code> ä¸­ç»™å‡ºã€‚&lt;/p>
&lt;p>å†çœ‹å¤æ‚ä¸€ç‚¹çš„æŸ¥è¯¢ï¼š&lt;/p>
&lt;pre>&lt;code>(binary_expression
(number)
(number)
)
&lt;/code>&lt;/pre>&lt;p>å°±æ˜¯æŸ¥è¯¢è¯­æ³•æ ‘ä¸­çš„ åŒ…å«ä¸¤ä¸ª number å­èŠ‚ç‚¹çš„ binary_expression èŠ‚ç‚¹ï¼Œä¸é™å®š number èŠ‚ç‚¹çš„ä½ç½®ï¼Œåªè¦æ˜¯å­èŠ‚ç‚¹å°±è¡Œã€‚&lt;/p>
&lt;p>è¯­æ³•æ ‘çš„ç»“æ„å¯ä»¥å‚è€ƒ &lt;code>tree-sitter parse&lt;/code> å‘½ä»¤çš„è¾“å‡ºã€‚&lt;/p>
&lt;p>å½“ç„¶ä¹Ÿå¯ä»¥ä»¥å­èŠ‚ç‚¹çš„å€¼ä¸ºæ¡ä»¶æ¥æŸ¥è¯¢ã€‚&lt;/p>
&lt;pre>&lt;code>(binary_expression
left:(number)
)
&lt;/code>&lt;/pre>&lt;p>å†çœ‹å¦‚ä½•æ•è·æŸ¥è¯¢ç»“æœã€‚&lt;/p>
&lt;pre>&lt;code>(function
name: (identifier) @function_name
)
&lt;/code>&lt;/pre>&lt;p>ç”¨ &lt;code>@&lt;/code> å¼€å¤´çš„æ ‡è¯†ç¬¦æŒ‡å®šæ•è·çš„åç§°ï¼Œé€šè¿‡ &lt;code>query.captures()&lt;/code> å³å¯å®Œæˆæ•è·ï¼Œè¿”å› &lt;code>{name: string, node: Node}&lt;/code> è¿™æ ·å­çš„å¯¹è±¡çš„åˆ—è¡¨ã€‚&lt;/p>
&lt;p>è¿™æ ·ä¸€æ¥ï¼Œä¸Šé¢çš„ä»£ç å°±å¾ˆå®¹æ˜“ç†è§£äº†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-ts" data-lang="ts">&lt;span class="kr">const&lt;/span> &lt;span class="nx">query&lt;/span>: &lt;span class="kt">Parser.Query&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">parser&lt;/span>
&lt;span class="o">?&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">getLanguage&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">.&lt;/span>&lt;span class="nx">query&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;(&amp;#34;message&amp;#34;) @keyword&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kr">const&lt;/span> &lt;span class="nx">captures&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">query&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">captures&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">tree&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">rootNode&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ä¸¤å¥è¯æŸ¥è¯¢å‡ºäº†è¯­æ³•æ ‘é‡Œæ‰€æœ‰çš„ &lt;code>message&lt;/code> å…³é”®å­—&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-ts" data-lang="ts">&lt;span class="kr">const&lt;/span> &lt;span class="nx">tokenBuilder&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">vscode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SemanticTokensBuilder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">legend&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kr">const&lt;/span> &lt;span class="nx">capture&lt;/span> &lt;span class="k">of&lt;/span> &lt;span class="nx">captures&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">tokenBuilder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">push&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="k">new&lt;/span> &lt;span class="nx">vscode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Range&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="k">new&lt;/span> &lt;span class="nx">vscode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Position&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">capture&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">node&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">startPosition&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">row&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">capture&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">node&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">startPosition&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">column&lt;/span>
&lt;span class="p">),&lt;/span>
&lt;span class="k">new&lt;/span> &lt;span class="nx">vscode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Position&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">capture&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">node&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">endPosition&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">row&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">capture&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">node&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">endPosition&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">column&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="p">),&lt;/span>
&lt;span class="nx">capture&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">name&lt;/span>
&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ä¸€æ®µå¾ªç¯å°†æ•è·çš„ç»“æœæ„é€ å‡ºé«˜äº® tokenï¼Œæ³¨æ„è¿™é‡Œç”¨äº† &lt;code>capture.name&lt;/code> ä½œä¸ºæ ‡è¯†ç¬¦çš„ç±»å‹ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„ query é‡ŒæŒ‡å®šçš„ &lt;code>keyword&lt;/code> ã€‚&lt;/p>
&lt;p>æœ€ç»ˆï¼Œå°†åˆ†è¯çš„ç»“æœè¿”å›å‡ºå»ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-ts" data-lang="ts">&lt;span class="kr">const&lt;/span> &lt;span class="nx">tokens&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">tokenBuilder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">build&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">Promise&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">resolve&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">tokens&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>F5 è¿è¡Œå³å¯çœ‹åˆ°æºç ä¸­æ‰€æœ‰ &lt;code>message&lt;/code> éƒ½è¢«æ ‡ä¸Šäº†å…³é”®å­—çš„é¢œè‰²ã€‚&lt;/p></description></item><item><title>ç©ç© tree-sitter</title><link>https://nnnewb.github.io/blog/p/%E7%8E%A9%E7%8E%A9-tree-sitter/</link><pubDate>Thu, 29 Jul 2021 10:14:36 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/%E7%8E%A9%E7%8E%A9-tree-sitter/</guid><description>&lt;p>ä»€ä¹ˆæ˜¯tree-sitterå‘¢ï¼Ÿ&lt;/p>
&lt;p>tree-sitter æ˜¯ä¸€ä¸ª parser-generatorï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå¢é‡è§£æåº“ï¼ˆincremental parsing libraryï¼‰ã€‚å®ƒå¯ä»¥ä¸ºæºæ–‡ä»¶æ„å»ºå®Œæ•´çš„è¯­æ³•æ ‘ï¼Œå¹¶åœ¨æºæ–‡ä»¶è¢«ç¼–è¾‘æ—¶é«˜æ•ˆåœ°æ›´æ–°ã€‚&lt;/p>
&lt;!-- more -->
&lt;h2 id="å¿«é€Ÿå¼€å§‹">å¿«é€Ÿå¼€å§‹&lt;/h2>
&lt;p>tree-sitter æœ¬èº«æ˜¯ä¸€ä¸ª parser generator ï¼Œä½¿ç”¨ javascript æ¥ä½œä¸ºæè¿°è¯­æ³•è§„åˆ™çš„è¯­è¨€ï¼ˆä¸åƒå…¶ä»–ï¼Œå¦‚ yacc ä¸€ç±»çš„å·¥å…·ï¼Œä»¥ç±»ä¼¼ EBNF çš„ DSL æ¥æè¿°è¯­æ³•è§„åˆ™ï¼‰ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å†™ tree-sitter è¯­æ³•è§„åˆ™æœ¬è´¨ä¸Šæ˜¯ç±»ä¼¼äºå†™ä¸€ä¸ª tree-sitter çš„è¯­æ³•æ”¯æŒåŒ…ï¼Œå¯ä»¥å‚è€ƒä¸‹ &lt;a class="link" href="https://github.com/tree-sitter/tree-sitter-go" target="_blank" rel="noopener"
>tree-sitter/tree-sitter-go: Go grammar for tree-sitter (github.com)&lt;/a> çš„é¡¹ç›®ç»“æ„ã€‚&lt;/p>
&lt;p>åºŸè¯ä¸å¤šè¯´ï¼Œå…ˆå†™ä¸ªç®€å•çš„ demo è·‘èµ·æ¥ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">mkdir tree-sitter-hello &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nb">cd&lt;/span> tree-sitter-hello
npm init
npm i --save nan
npm i --save-dev tree-sitter-cli
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆå§‹åŒ–å¥½é¡¹ç›®ç›®å½•ï¼Œåœ¨ package.json é‡Œå†™ä¸ªç®€å•çš„å‘½ä»¤ï¼Œæ–¹ä¾¿ä¹‹åç”¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;scripts&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>
&lt;span class="nt">&amp;#34;test&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;tree-sitter generate &amp;amp;&amp;amp; tree-sitter parse test.txt&amp;#34;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç°åœ¨å¼€å§‹å¹²æ­£äº‹å„¿ï¼Œåˆ›å»ºä¸€ä¸ª grammar.js&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="nx">module&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">exports&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">grammar&lt;/span>&lt;span class="p">({&lt;/span>
&lt;span class="nx">name&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;hello&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">rules&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">source_file&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">$&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">repeat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">word&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="c1">// éç»ˆç»“ç¬¦ï¼Œ0æˆ–æ›´å¤šçš„ word
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">word&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">$&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="err">\&lt;/span>&lt;span class="nx">w&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="sr">/ /&lt;/span>&lt;span class="o">/&lt;/span> &lt;span class="nx">éå¸¸ç®€å•çš„ç»ˆç»“ç¬¦&lt;/span>&lt;span class="err">ï¼Œ&lt;/span>&lt;span class="nx">è¡¨ç¤ºä¸€ä¸ªè¯&lt;/span>&lt;span class="err">ï¼Œ&lt;/span>&lt;span class="nx">å¯ä»¥æ˜¯æ•°å­—å­—æ¯ä¸‹åˆ’çº¿ç»„æˆ&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å†å†™ä¸€ä¸ª test.txt ä½œä¸ºè¾“å…¥&lt;/p>
&lt;pre>&lt;code>amazing tree sitter
&lt;/code>&lt;/pre>&lt;p>æœ€åè¿è¡Œã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">npm run &lt;span class="nb">test&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¾“å‡ºç»“æœ&lt;/p>
&lt;pre>&lt;code>
&amp;gt; tree-sitter-hello@0.1.0 test
&amp;gt; tree-sitter generate &amp;amp;&amp;amp; tree-sitter parse test.txt
(source_file [0, 0] - [1, 0]
(word [0, 0] - [0, 7])
(word [0, 8] - [0, 12])
(word [0, 13] - [0, 19]))
&lt;/code>&lt;/pre>&lt;p>å°±æ˜¯è¿™æ ·ï¼&lt;/p>
&lt;h2 id="è§„åˆ™-dsl">è§„åˆ™ DSL&lt;/h2>
&lt;p>æ‰€æœ‰è§„åˆ™éƒ½ç”¨è¿™ç§æ ¼å¼ç¼–å†™&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="nx">rule_name1&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">$&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="nx">terminal&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">symbol&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">rule_name2&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">$&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;non&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;terminal&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;symbol&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ­£åˆ™è¡¨è¾¾å¼æˆ–å­—ç¬¦ä¸²è¡¨ç¤ºç»ˆç»“ç¬¦ï¼Œè§„åˆ™å‡½æ•°è¡¨ç¤ºéç»ˆç»“ç¬¦ï¼ˆtokenå‡½æ•°æ˜¯ä¾‹å¤–ï¼‰&lt;/p>
&lt;p>ä¸€äº›å‡½æ•°æ¥æ ‡è¯† ENBF é‡Œå‡ºç°çš„è§„åˆ™ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>repeat&lt;/code> å°±æ˜¯é‡å¤0æˆ–å¤šæ¬¡ï¼Œç±»ä¼¼ EBNF çš„ &lt;code>{ }&lt;/code> å«ä¹‰&lt;/li>
&lt;li>&lt;code>repeat1&lt;/code> è‡³å°‘å‡ºç°ä¸€æ¬¡ï¼Œå¯ä»¥é‡å¤å¤šæ¬¡ï¼Œç±»ä¼¼ EBNF çš„ &lt;code> SYM { SYM }&lt;/code> è¿™æ ·çš„å½¢å¼&lt;/li>
&lt;li>&lt;code>optional&lt;/code> å¯é€‰ï¼Œç±»ä¼¼ EBNF çš„ &lt;code>[ ]&lt;/code> å«ä¹‰&lt;/li>
&lt;li>&lt;code>choice&lt;/code> å¤šé€‰ä¸€ï¼Œç±»ä¼¼ EBNF çš„ &lt;code>|&lt;/code> å«ä¹‰&lt;/li>
&lt;li>&lt;code>seq&lt;/code> åºåˆ—ï¼Œè¡¨ç¤ºå‰åé¡ºåºï¼Œåœ¨ EBNF é‡Œå°±æ˜¯ç¬¦å·å‡ºç°çš„é¡ºåº&lt;/li>
&lt;li>&lt;code>token&lt;/code> ï¼ŒæŠŠä¸€ä¸ªå¤æ‚è§„åˆ™åˆå¹¶æˆä¸€ä¸ª tokenï¼Œä¸€èˆ¬æ˜¯éš¾ä»¥ç”¨ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼è§£å†³çš„ç»ˆç»“ç¬¦ä¼šç”¨ &lt;code>token(choice(/hex/,/octal/,/decimals/))&lt;/code> è¿™ç§å½¢å¼ç¼–å†™ã€‚&lt;/li>
&lt;/ul>
&lt;p>è¿˜æœ‰å…¶ä»–çš„ï¼Œç”¨äºè®¾ç½®å·¦å³è”ç»“æ€§ä¼˜å…ˆçº§ä»€ä¹ˆçš„ï¼Œå°±ä¸å¤šä»‹ç»äº†ã€‚å¯ä»¥è‡ªå·±çœ‹tree-sitterçš„æ–‡æ¡£ã€‚&lt;/p>
&lt;h2 id="æ›´å¤æ‚ä¸€ç‚¹çš„ä¾‹å­">æ›´å¤æ‚ä¸€ç‚¹çš„ä¾‹å­&lt;/h2>
&lt;p>è´´ä¸€ä¸ªå‚è€ƒ protocol buffer 3 çš„ spec å†™å‡ºæ¥çš„ grammar.js&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="nx">module&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">exports&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">grammar&lt;/span>&lt;span class="p">({&lt;/span>
&lt;span class="nx">name&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;protobuf&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">extras&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">comment&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sr">/\s/&lt;/span>&lt;span class="p">],&lt;/span>
&lt;span class="nx">rules&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// top
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">source_file&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span>
&lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">syntax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">repeat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">choice&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="kr">import&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="kr">package&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">option&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">emptyStatement&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="kr">enum&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">message&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">service&lt;/span>&lt;span class="p">))),&lt;/span>
&lt;span class="c1">// comment
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">comment&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">token&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;//&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sr">/.*/&lt;/span>&lt;span class="p">)),&lt;/span>
&lt;span class="c1">// syntax
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">syntax&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;syntax&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;=&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sr">/&amp;#34;proto3&amp;#34;/&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;;&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="c1">// package
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kr">package&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;package&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fullIdent&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;;&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="c1">// imports
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kr">import&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;import&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">strLit&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;;&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="c1">// option
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">option&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;option&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">optionName&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;=&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">constant&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;;&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">optionName&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">choice&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;(&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fullIdent&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;)&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fullIdent&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="c1">// enum
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kr">enum&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;enum&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">enumName&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">enumBody&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">enumBody&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;{&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">repeat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">choice&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">option&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">enumField&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">emptyStatement&lt;/span>&lt;span class="p">)),&lt;/span> &lt;span class="s1">&amp;#39;}&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">enumField&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span>
&lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ident&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;=&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">optional&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;-&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">intLit&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">optional&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;[&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">enumValueOption&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">repeat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;,&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">enumValueOption&lt;/span>&lt;span class="p">)),&lt;/span> &lt;span class="s1">&amp;#39;]&amp;#39;&lt;/span>&lt;span class="p">)),&lt;/span>
&lt;span class="s1">&amp;#39;;&amp;#39;&lt;/span>
&lt;span class="p">),&lt;/span>
&lt;span class="nx">enumValueOption&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">optionName&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;=&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">constant&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="c1">// message
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">message&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;message&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">messageName&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">messageBody&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">messageBody&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span>
&lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="s1">&amp;#39;{&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">repeat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">choice&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">field&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="kr">enum&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">message&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">option&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">oneof&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">mapField&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">reserved&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">emptyStatement&lt;/span>&lt;span class="p">)),&lt;/span>
&lt;span class="s1">&amp;#39;}&amp;#39;&lt;/span>
&lt;span class="p">),&lt;/span>
&lt;span class="c1">// service
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">service&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;service&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">serviceName&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;{&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">repeat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">choice&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">option&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">rpc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">emptyStatement&lt;/span>&lt;span class="p">)),&lt;/span> &lt;span class="s1">&amp;#39;}&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">rpc&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span>
&lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="s1">&amp;#39;rpc&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">rpcName&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;(&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">optional&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;stream&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">enumMessageType&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;)&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;returns&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;(&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">optional&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;stream&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">enumMessageType&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;)&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">choice&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;{&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">repeat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">choice&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">option&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">emptyStatement&lt;/span>&lt;span class="p">)),&lt;/span> &lt;span class="s1">&amp;#39;}&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="s1">&amp;#39;;&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">),&lt;/span>
&lt;span class="c1">// field and inline option
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">field&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span>
&lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">optional&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;repeated&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">type&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fieldName&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;=&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fieldNumber&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">optional&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;[&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fieldOptions&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;]&amp;#39;&lt;/span>&lt;span class="p">)),&lt;/span> &lt;span class="s1">&amp;#39;;&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">fieldOptions&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fieldOption&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">repeat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;,&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fieldOption&lt;/span>&lt;span class="p">))),&lt;/span>
&lt;span class="nx">fieldOption&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">optionName&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;=&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">constant&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="c1">// oneof
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">oneof&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;oneof&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">oneofName&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;{&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">repeat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">choice&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">option&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">oneofField&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">emptyStatement&lt;/span>&lt;span class="p">)),&lt;/span> &lt;span class="s1">&amp;#39;}&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">oneofField&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">type&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fieldName&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;=&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fieldNumber&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">optional&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;[&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fieldOptions&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;]&amp;#39;&lt;/span>&lt;span class="p">)),&lt;/span> &lt;span class="s1">&amp;#39;;&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="c1">// map
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">mapField&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span>
&lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="s1">&amp;#39;map&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;&amp;lt;&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">keyType&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;,&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">type&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;&amp;gt;&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">mapName&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;=&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fieldNumber&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">optional&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;[&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fieldOptions&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;]&amp;#39;&lt;/span>&lt;span class="p">)),&lt;/span>
&lt;span class="s1">&amp;#39;;&amp;#39;&lt;/span>
&lt;span class="p">),&lt;/span>
&lt;span class="nx">keyType&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span>
&lt;span class="nx">choice&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="s1">&amp;#39;int32&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;int64&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;uint32&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;uint64&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;sint32&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;sint64&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;fixed32&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;fixed64&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;sfixed32&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;sfixed64&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;bool&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;string&amp;#39;&lt;/span>
&lt;span class="p">),&lt;/span>
&lt;span class="c1">// reserved
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">reserved&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;reserved&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">choice&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ranges&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fieldNames&lt;/span>&lt;span class="p">)),&lt;/span>
&lt;span class="nx">ranges&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">range&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">repeat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;,&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">range&lt;/span>&lt;span class="p">))),&lt;/span>
&lt;span class="nx">range&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">intLit&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">optional&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;to&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">choice&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">intLit&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;max&amp;#39;&lt;/span>&lt;span class="p">)))),&lt;/span>
&lt;span class="nx">fieldNames&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fieldName&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">repeat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;,&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fieldName&lt;/span>&lt;span class="p">))),&lt;/span>
&lt;span class="c1">// integer literals
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">intLit&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">\&lt;/span>&lt;span class="nx">d&lt;/span>&lt;span class="err">\&lt;/span>&lt;span class="nx">d&lt;/span>&lt;span class="o">*|&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">7&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">*|&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">xX&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="err">\&lt;/span>&lt;span class="nx">da&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">fA&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">F&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="c1">// floating-point literals
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">floatLit&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">choice&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sr">/\d\.\d*([eE][+-]\d*)?/&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sr">/\d*[eE][+-]\d*/&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sr">/\.\d*[eE][+-]\d*/&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;inf&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;nan&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="c1">// boolean literals
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">boolLit&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="c1">// string literals
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">strLit&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span>
&lt;span class="nx">choice&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;&amp;#34;&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sr">/([^&amp;#34;\n\\]|\\[xX][\da-fA-F]{2}|\\[0-7]{3}|\\[abfnrtv\\&amp;#39;&amp;#34;])*/&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&amp;#39;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sr">/([^&amp;#39;\n\\]|\\[xX][\da-fA-F]{2}|\\[0-7]{3}|\\[abfnrtv\\&amp;#39;&amp;#34;])*/&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;&amp;#39;&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">),&lt;/span>
&lt;span class="c1">// built-in field type
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">type&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span>
&lt;span class="nx">choice&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="s1">&amp;#39;double&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;float&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;int32&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;int64&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;uint32&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;uint64&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;sint32&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;sint64&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;fixed32&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;fixed64&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;sfixed32&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;sfixed64&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;bool&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;string&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;bytes&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">enumMessageType&lt;/span>
&lt;span class="p">),&lt;/span>
&lt;span class="nx">fieldNumber&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">intLit&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="c1">// empty statement
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">emptyStatement&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="s1">&amp;#39;;&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="c1">// constant
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">constant&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span>
&lt;span class="nx">choice&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fullIdent&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">optional&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sr">/[+-]/&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">intLit&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">optional&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sr">/[+-]/&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">floatLit&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">strLit&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">boolLit&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">msgLit&lt;/span>
&lt;span class="p">),&lt;/span>
&lt;span class="nx">msgLit&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;{&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">repeat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fieldName&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;:&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">constant&lt;/span>&lt;span class="p">)),&lt;/span> &lt;span class="s1">&amp;#39;}&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="c1">// identifier
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">ident&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">a&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">zA&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">Z_&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">\&lt;/span>&lt;span class="nx">w&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="err">/,&lt;/span>
&lt;span class="nx">fullIdent&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ident&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">repeat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;.&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ident&lt;/span>&lt;span class="p">))),&lt;/span>
&lt;span class="nx">messageName&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ident&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">mapName&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ident&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">enumName&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ident&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">fieldName&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ident&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">oneofName&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ident&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">serviceName&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ident&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">rpcName&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ident&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">enumMessageType&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">optional&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;.&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">repeat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">seq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ident&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;.&amp;#39;&lt;/span>&lt;span class="p">)),&lt;/span> &lt;span class="nx">$&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">messageName&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="p">});&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="ç¼–è¯‘å’Œä½¿ç”¨">ç¼–è¯‘å’Œä½¿ç”¨&lt;/h2>
&lt;p>ç”Ÿæˆçš„æ˜¯cä»£ç ï¼Œé»˜è®¤æ˜¯ç¼–è¯‘æˆæœºå™¨ç ï¼Œå’ŒcpuæŒ‡ä»¤é›†æ¶æ„å¼ºç›¸å…³ã€‚æœ‰å¾ˆå¤šè¯­è¨€æä¾›äº†åŸºäº C æ¥å£çš„ç»‘å®šã€‚&lt;/p>
&lt;p>ä¸è¿‡ç°åœ¨ä¹Ÿæ”¯æŒç¼–è¯‘æˆ wasmï¼Œåªéœ€è¦ç”¨ä¸‹é¢çš„å‘½ä»¤&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">tree-sitter build-wasm
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åŠ è½½æ–¹å¼ä¹Ÿæ˜¯ç”¨ &lt;code>Language.load&lt;/code> ï¼Œä¸è¿‡åªæœ‰ web-tree-sitter èƒ½åŠ è½½ã€‚web-tree-sitter å¯ä»¥ç”¨ &lt;code>npm i --save tree-sitter&lt;/code> æ¥å®‰è£…ã€‚&lt;/p>
&lt;p>äºæ˜¯å†™ä¸ª main.js ï¼ŒåŠ è½½ä»£ç å¦‚ä¸‹&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="kr">const&lt;/span> &lt;span class="nx">Parser&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;web-tree-sitter&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="nx">Parser&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">init&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nx">then&lt;/span>&lt;span class="p">(()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Parser&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Language&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">load&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;tree-sitter-hello.wasm&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">then&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="nx">lang&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kr">const&lt;/span> &lt;span class="nx">parser&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">Parser&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="nx">parser&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">setLanguage&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">lang&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kr">const&lt;/span> &lt;span class="nx">ast&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">parser&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">parse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;amazing tree parser&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">rootNode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">toString&lt;/span>&lt;span class="p">());&lt;/span>
&lt;span class="p">});&lt;/span>
&lt;span class="p">});&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ€ç»ˆè¾“å‡ºæ˜¯&lt;/p>
&lt;pre>&lt;code>(source_file (word) (word) (word))
&lt;/code>&lt;/pre>&lt;h2 id="ç¼–è¾‘å’Œæ›´æ–°">ç¼–è¾‘å’Œæ›´æ–°&lt;/h2>
&lt;p>è¿™ä¸ªè¿˜æ²¡ææ˜ç™½ã€‚&lt;/p>
&lt;p>å›å¤´å‚è€ƒä¸‹åˆ«çš„ repo çš„ä»£ç ï¼Œçœ‹çœ‹åˆ«äººæ˜¯æ€ä¹ˆåšè¯­æ³•æ ‘æ›´æ–°çš„ã€‚&lt;/p></description></item><item><title>csr æ–¹å¼åˆ›å»º kubernetes ç”¨æˆ·å‡ºäº†ç‚¹å·®é”™</title><link>https://nnnewb.github.io/blog/p/csr-%E6%96%B9%E5%BC%8F%E5%88%9B%E5%BB%BA-kubernetes-%E7%94%A8%E6%88%B7%E5%87%BA%E4%BA%86%E7%82%B9%E5%B7%AE%E9%94%99/</link><pubDate>Mon, 19 Jul 2021 09:52:38 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/csr-%E6%96%B9%E5%BC%8F%E5%88%9B%E5%BB%BA-kubernetes-%E7%94%A8%E6%88%B7%E5%87%BA%E4%BA%86%E7%82%B9%E5%B7%AE%E9%94%99/</guid><description>&lt;p>è¶Šæ˜¯åœ¨ kubernetes çš„æµ‘æ°´é‡Œæ‘¸ç´¢ï¼Œè¶Šæ˜¯å‘ç°è¿™å°±æ˜¯ä¸ªä¸é¡ºæ‰‹çš„é”¤å­ã€‚&lt;/p>
&lt;p>ç½‘ä¸Šå¾ˆå¤šäººå–œæ¬¢æŠŠä¸œè¥¿ç”¨ä¸æƒ¯å«åšæ‡’ï¼Œè ¢ï¼Œè¦æ˜¯å¤šåé©³å‡ å¥ï¼Œé‚£å°±è¿˜å¾—æ­ä¸Šä¸ªâ€œåâ€çš„å¸½å­ã€‚æ„Ÿè§‰å§ï¼Œå°±è¿™å¸®äººçœ‹æ¥ï¼Œå¤§ç¥æ”¾ä¸ªå±ä¹Ÿå€¼å¾—å­¦ä¹ ï¼Œä»é‡Œé¢â€œæ‚Ÿâ€å‡ºä»€ä¹ˆé“ç†ã€‚&lt;/p>
&lt;p>è¿™å¸®äººå°±è·Ÿä¼ æ•™å£«ä¸€æ ·ï¼Œä½†å‡¡è¯´ä¸ªä¸å­—ï¼Œå°±æ˜¯åœ¨äºµæ¸ä»–ä»¬çš„â€œå¤§ç¥â€ã€‚å¯è°“äººç±»è¿·æƒ‘è¡Œä¸ºã€‚&lt;/p>
&lt;p>å¥½å§ã€‚æŠ€æœ¯åˆ«é¥­åœˆåŒ–è¡Œå—ï¼Ÿ&lt;/p>
&lt;p>ä½ è¯´å°¤å¤§å¼ºå—ï¼ŸRichard Stallman æ˜¯ä¸æ˜¯å€¼å¾—å°Šæ•¬ï¼ŸGoogle æ˜¯ä¸æ˜¯æœ€å¥½çš„æŠ€æœ¯å…¬å¸ï¼ŸAndroid å¤©ä¸‹æ— æ•Œï¼Ÿ&lt;/p>
&lt;p>ç„¶åå…¨æ‘†ä¸Šç¥å›ï¼ŒæŒ‚ä¸Šèµ›åšå¤©ç¥çš„ç‰ŒåŒ¾ï¼Œæ’ä¸Šç½‘çº¿ä¸€å¤© 25 å°æ—¶è†œæ‹œï¼Ÿ&lt;/p>
&lt;p>è¿™å¸®äººå“ªå¤©æä¸ªå´‡æ‹œäº’è”ç½‘å’Œè®¡ç®—æœºçš„æ•™æ´¾ï¼ŒæŠŠå†¯Â·è¯ºä¾æ›¼å¥‰ä¸ºå…ˆçŸ¥æˆ‘éƒ½ä¸å¥‡æ€ªã€‚&lt;/p>
&lt;p>æ‹œæ‰˜ï¼Œä½ ä»¬çœŸçš„å¥½æ€ªæ¬¸ã€‚&lt;/p>
&lt;!-- more -->
&lt;h2 id="å®Œæ•´è„šæœ¬">å®Œæ•´è„šæœ¬&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="cp">#!/bin/bash -e
&lt;/span>&lt;span class="cp">&lt;/span>&lt;span class="c1">#&lt;/span>
&lt;span class="c1"># åˆ›å»ºç”¨æˆ· gitlab å¹¶æˆäºˆæƒé™&lt;/span>
&lt;span class="c1">#&lt;/span>
&lt;span class="c1"># reference:&lt;/span>
&lt;span class="c1"># https://kubernetes.io/zh/docs/reference/access-authn-authz/certificate-signing-requests/#normal-user&lt;/span>
&lt;span class="c1"># if `gitlab` does not exists,&lt;/span>
&lt;span class="c1"># create csr and approve&lt;/span>
&lt;span class="k">if&lt;/span> ! kubectl get csr gitlab &amp;gt;/dev/null&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;span class="c1"># create credential&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> ! -f gitlab.csr &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
openssl genrsa -out gitlab.key &lt;span class="m">2048&lt;/span>
openssl req -new -key gitlab.key -out gitlab.csr
&lt;span class="k">fi&lt;/span>
&lt;span class="nv">csr&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>cat gitlab.csr &lt;span class="p">|&lt;/span> base64 &lt;span class="p">|&lt;/span> tr -d &lt;span class="s2">&amp;#34;\n&amp;#34;&lt;/span>&lt;span class="k">)&lt;/span>
cat &lt;span class="s">&amp;lt;&amp;lt;EOF | tee gitlab-csr.yaml
&lt;/span>&lt;span class="s">apiVersion: certificates.k8s.io/v1beta1
&lt;/span>&lt;span class="s">kind: CertificateSigningRequest
&lt;/span>&lt;span class="s">metadata:
&lt;/span>&lt;span class="s"> name: gitlab
&lt;/span>&lt;span class="s">spec:
&lt;/span>&lt;span class="s"> groups:
&lt;/span>&lt;span class="s"> - system:authenticated
&lt;/span>&lt;span class="s"> request: $csr
&lt;/span>&lt;span class="s"> signerName: kubernetes.io/kube-apiserver-client
&lt;/span>&lt;span class="s"> usages:
&lt;/span>&lt;span class="s"> - client auth
&lt;/span>&lt;span class="s">EOF&lt;/span>
kubectl create -f gitlab-csr.yaml
kubectl certificate approve gitlab
&lt;span class="k">fi&lt;/span>
&lt;span class="c1"># get signed credential&lt;/span>
kubectl get csr gitlab -o &lt;span class="nv">jsonpath&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;{.status.certificate}&amp;#39;&lt;/span>&lt;span class="p">|&lt;/span> base64 -d &amp;gt; gitlab.crt
&lt;span class="c1"># create role and rolebinding&lt;/span>
kubectl create role gitlab-ci &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> --verb&lt;span class="o">=&lt;/span>create &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> --verb&lt;span class="o">=&lt;/span>git &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> --verb&lt;span class="o">=&lt;/span>list &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> --verb&lt;span class="o">=&lt;/span>update &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> --verb&lt;span class="o">=&lt;/span>delete &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> --resource&lt;span class="o">=&lt;/span>pods &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> --resource&lt;span class="o">=&lt;/span>deployment &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> --resource&lt;span class="o">=&lt;/span>statefulset &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> --resource&lt;span class="o">=&lt;/span>service &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> --resource&lt;span class="o">=&lt;/span>configmap
kubectl create rolebinding gitlab-ci-binding-gitlab --role&lt;span class="o">=&lt;/span>gitlab-ci --user&lt;span class="o">=&lt;/span>gitlab
kubectl config set-credentials gitlab --client-key&lt;span class="o">=&lt;/span>gitlab.key --client-certificate&lt;span class="o">=&lt;/span>gitlab.crt --embed-certs&lt;span class="o">=&lt;/span>&lt;span class="nb">true&lt;/span>
kubectl config set-context ci --cluster&lt;span class="o">=&lt;/span>office --user&lt;span class="o">=&lt;/span>gitlab --namespace&lt;span class="o">=&lt;/span>version4
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å­˜åœ¨çš„é—®é¢˜">å­˜åœ¨çš„é—®é¢˜&lt;/h2>
&lt;p>è„šæœ¬è·‘å®Œåå‘ç°è¿˜ä¸èƒ½ä½¿ç”¨ &lt;code>kubectl get pods&lt;/code>ï¼Œé”™è¯¯ Unauthorizedã€‚&lt;/p>
&lt;p>å†çœ‹äº†ä¸€éæ–‡æ¡£ï¼Œå‘ç°æœ‰è¿™ä¹ˆä¸€å¥ã€‚&lt;/p>
&lt;blockquote>
&lt;p>ä¸‹é¢çš„è„šæœ¬å±•ç¤ºäº†å¦‚ä½•ç”Ÿæˆ PKI ç§é’¥å’Œ CSRã€‚ è®¾ç½® CSR çš„ CN å’Œ O å±æ€§å¾ˆé‡è¦ã€‚CN æ˜¯ç”¨æˆ·åï¼ŒO æ˜¯è¯¥ç”¨æˆ·å½’å±çš„ç»„ã€‚ ä½ å¯ä»¥å‚è€ƒ RBAC äº†è§£æ ‡å‡†ç»„çš„ä¿¡æ¯ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>é¡ºç€é“¾æ¥å»çœ‹äº†ä¸‹ RBACï¼Œç»“æœä¹Ÿæ²¡æ‰¾åˆ°ä»€ä¹ˆâ€œæ ‡å‡†ç»„â€ã€‚&lt;/p>
&lt;p>å¯¹äºæ–‡ä¸­è¯´çš„ä¸¤ä¸ªâ€œå¾ˆé‡è¦â€çš„å­—æ®µï¼ŒCN æˆ‘çŒœæµ‹æ˜¯ Common Nameï¼ŒO å°±æ˜¯ Organizationã€‚ç°åœ¨å°±ä¸çŸ¥é“æ€ä¹ˆå¡« Oï¼Œè¡Œå§ã€‚&lt;/p>
&lt;p>ç­‰å•¥æ—¶å€™ææ¸…æ¥šäº†å†è¡¥ä¸€ç¯‡ã€‚&lt;/p></description></item><item><title>å‡çº§å…¬å¸çš„ GitLab</title><link>https://nnnewb.github.io/blog/p/%E5%8D%87%E7%BA%A7%E5%85%AC%E5%8F%B8%E7%9A%84-gitlab/</link><pubDate>Thu, 15 Jul 2021 16:02:41 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/%E5%8D%87%E7%BA%A7%E5%85%AC%E5%8F%B8%E7%9A%84-gitlab/</guid><description>&lt;p>å…¬å¸ç›®å‰è·‘çš„ gitlab æ˜¯å¾ˆä¹…ä»¥å‰éƒ¨ç½²çš„ï¼Œå½“å‰ç‰ˆæœ¬ &lt;em>8.4.2&lt;/em> ã€‚å‡çº§ç›®æ ‡æ˜¯ &lt;em>13.12.Z&lt;/em> ã€‚éƒ¨ç½²æ–¹å¼æ˜¯ docker ã€‚&lt;/p>
&lt;!-- more -->
&lt;p>å®¿ä¸»æœºé…ç½®ä¸é«˜ï¼Œç³»ç»Ÿ &lt;em>Ubuntu 15.04&lt;/em> ã€‚çœ¼ä¸‹è¿™ä¸ªæ—¶é—´ï¼Œè¿™ä¸ªUbuntuç‰ˆæœ¬ï¼ŒåŸºæœ¬å®£å‘Šæ²¡æ³•ç”¨äº†ã€‚ç›´æ¥åœ¨çº¿å‡çº§å®¹æ˜“æŠŠå¼•å¯¼ææŒ‚ï¼Œåˆ°æ—¶å€™è¿˜å¾—äº²è‡ªå»å®ä½“æœºä¸ŠæŠ˜è…¾å¼•å¯¼ï¼Œéº»çƒ¦ã€‚æš‚æ—¶ä¸ç®¡å®¿ä¸»æœºã€‚&lt;/p>
&lt;h2 id="æƒ…å†µæ¦‚è¿°">æƒ…å†µæ¦‚è¿°&lt;/h2>
&lt;p>å› ä¸º GitLab ç‰ˆæœ¬å®åœ¨å¤ªä½äº†ï¼Œä»¥è‡³äºè¿ä¸€ä¸ªèƒ½é›†æˆçš„ CI/CD å·¥å…·éƒ½æ‰¾ä¸åˆ°ã€‚å³ä½¿ jenkins éƒ½åªèƒ½å¾ˆå‹‰å¼ºåœ°åŠ¨èµ·æ¥ï¼Œåå jenkins è¿˜ä¸èƒ½æ»¡è¶³éœ€è¦ï¼ˆä¹Ÿå¯èƒ½æ˜¯æˆ‘å¤ªèœï¼Œåæ­£å…¬å¸æ²¡äººç©å¾—è½¬ jenkinsï¼‰ã€‚&lt;/p>
&lt;p>ä½†å¼€å‘éœ€è¦ CI/CD æ¥è§£å†³æŒç»­æ„å»ºå’Œéƒ¨ç½²çš„é—®é¢˜ï¼Œä¸å¾—ä¸è€ƒè™‘å‡çº§äº†ã€‚&lt;/p>
&lt;h2 id="1-å¤‡ä»½">1. å¤‡ä»½&lt;/h2>
&lt;p>ä»€ä¹ˆéƒ½åˆ«è¯´äº†ï¼Œå¼€å¹²å‰æœ€é‡è¦çš„äº‹æƒ…å°±æ˜¯å¤‡ä»½ï¼Œå…å¾—æŠŠè‡ªå·±ç©æ­»ã€‚&lt;/p>
&lt;p>æœ€å¸¸ç”¨çš„å¤‡ä»½æ‰‹æ®µè‡ªç„¶æ˜¯ &lt;code>tar&lt;/code> ã€‚ä¸è¿‡ gitlab æ•°æ®ç›®å½•å®åœ¨å¤ªå¤§äº†ï¼Œè¦æ˜¯ç›´æ¥è¿è¡Œ &lt;code>tar -czpf gitlab.tar.gz ./gitlab&lt;/code> ä¸çŸ¥é“è·‘å¤šä¹…ï¼Œä¹Ÿä¸çŸ¥é“æœ‰æ²¡æœ‰å¡æ­»ã€‚&lt;/p>
&lt;p>äºæ˜¯ä¸ŠæŠ€æœ¯æ‰‹æ®µï¼šç”¨ &lt;code>pv&lt;/code> æ˜¾ç¤ºä¸ªè¿›åº¦æ¡ã€‚&lt;/p>
&lt;p>pv é¡¹ç›®çš„é¦–é¡µåœ¨ &lt;a class="link" href="http://www.ivarch.com/programs/pv.shtml" target="_blank" rel="noopener"
>ivarch.com&lt;/a>ã€‚å› ä¸ºæœåŠ¡å™¨è¿˜åœ¨è·‘&lt;em>ubuntu 15.10&lt;/em>ï¼Œç°åœ¨è¿ä¸ªèƒ½ç”¨çš„æºéƒ½æ²¡å•¦ã€‚åªå¥½ä¸‹è½½äº†æºç ï¼Œåœ¨ wsl é‡Œç¼–è¯‘å¥½æ¨ä¸Šå»ã€‚&lt;/p>
&lt;p>æœ€ç»ˆå‘½ä»¤å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">sudo tar cf - ./gitlab -P &lt;span class="p">|&lt;/span> pv -s &lt;span class="k">$(&lt;/span>sudo du -sb ./gitlab &lt;span class="p">|&lt;/span> awk &lt;span class="s1">&amp;#39;{print $1}&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span> &lt;span class="p">|&lt;/span> gzip &amp;gt; gitlab.tar.gz
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸ºå•¥ sudo å‘¢ï¼Œpostgres æ•°æ®åº“å’Œ redis æ•°æ®éƒ½æ²¡æœ‰è¯»æƒé™ï¼Œæ²¡è¾™ã€‚&lt;/p>
&lt;h2 id="2-å‡çº§æ€»ä½“æ€è·¯">2. å‡çº§æ€»ä½“æ€è·¯&lt;/h2>
&lt;p>gitlab çš„æ‰‹å†Œè¿˜æ˜¯æ¯”è¾ƒå…¨é¢çš„ã€‚åœ¨&lt;a class="link" href="https://docs.gitlab.com/ee/update/index.html#upgrading-to-a-new-major-version" target="_blank" rel="noopener"
>upgrading to a new major version&lt;/a> è¿™ç¯‡æ–‡æ¡£æåˆ°çš„è¯´æ³•ï¼Œè·¨å¤§ç‰ˆæœ¬å‡çº§ä¸»è¦åˆ†ä¸‰æ­¥ï¼š&lt;/p>
&lt;ol>
&lt;li>å‡çº§è‡³å½“å‰å¤§ç‰ˆæœ¬(&lt;em>major version&lt;/em>)çš„æœ€æ–°å°ç‰ˆæœ¬(&lt;em>latest minor version&lt;/em>)&lt;/li>
&lt;li>å‡çº§è‡³ç›®æ ‡å¤§ç‰ˆæœ¬(&lt;em>target major version&lt;/em>)çš„é¦–ä¸ªå°ç‰ˆæœ¬(&lt;em>first minor version&lt;/em>)&lt;/li>
&lt;li>ç»§ç»­å‡çº§è‡³æ›´æ–°çš„ç‰ˆæœ¬&lt;/li>
&lt;/ol>
&lt;p>æ ¹æ® &lt;a class="link" href="https://docs.gitlab.com/ee/update/index.html#upgrades-from-versions-earlier-than-812" target="_blank" rel="noopener"
>gitlab upgrading guide çš„è¯´æ³•&lt;/a>ï¼Œç‰ˆæœ¬ä½äº &lt;em>8.11.Z&lt;/em> æ—¶ï¼Œå…ˆæ›´æ–°åˆ° &lt;em>8.12.0&lt;/em> æ˜¯æ¯”è¾ƒç¨³å¦¥çš„æ–¹æ¡ˆã€‚&lt;/p>
&lt;p>so å¼€å¹²ã€‚&lt;/p>
&lt;h2 id="3-å‡çº§è‡³-8120">3. å‡çº§è‡³ 8.12.0&lt;/h2>
&lt;p>ç”±äºéƒ¨ç½²æ–¹å¼æ˜¯ dockerï¼ˆå‡†ç¡®çš„è¯´æ˜¯ docker-composeï¼‰ï¼Œæ‰€ä»¥æŒ‰ç…§&lt;a class="link" href="https://docs.gitlab.com/ee/install/docker.html#update-gitlab-using-docker-engine" target="_blank" rel="noopener"
>Update GitLab Using Docker Engine&lt;/a> çš„è¯´æ³•ï¼Œæˆ‘ä»¬å…ˆåœæ­¢å®¹å™¨ï¼Œç„¶åç›´æ¥ä¿®æ”¹é•œåƒæ ‡ç­¾ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">docker-compose stop
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">gitlab&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">restart&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">always&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sameersbn/gitlab:8.12.0&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># &amp;lt;= sameersbn/gitlab:8.4.2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å†å¯åŠ¨&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">docker-compose up -d
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æ•…éšœgitlab_secrets_otp_key_base-must-set">æ•…éšœï¼šGITLAB_SECRETS_OTP_KEY_BASE must set&lt;/h3>
&lt;p>ä½¿ç”¨çš„é•œåƒ &lt;code>sameersbn/docker-gitlab&lt;/code> éœ€è¦è¿™å‡ ä¸ªç¯å¢ƒå˜é‡ï¼Œ&lt;a class="link" href="https://github.com/sameersbn/docker-gitlab#quick-start" target="_blank" rel="noopener"
>å‚è€ƒæ–‡æ¡£&lt;/a>å®Œæˆè®¾ç½®ã€‚&lt;/p>
&lt;h3 id="æ•…éšœyou-must-enable-the-pg_trgm-extension">æ•…éšœï¼šYou must enable the pg_trgm extension&lt;/h3>
&lt;p>è¿™ä¸ªæ•…éšœå°±æ¯”è¾ƒå¥‡æ€ªäº†ï¼Œä½†è¿˜æ˜¯å¯ä»¥å¤„ç†ã€‚&lt;/p>
&lt;p>å…ˆè®¾ç½®ä¸€ä¸‹ postgres è´¦å·å¯†ç &lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">docker &lt;span class="nb">exec&lt;/span> -it gitlab_postgresql_1 psql -U postgres
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶å&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="err">\&lt;/span>&lt;span class="n">password&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">postgres&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¾“å…¥æ–°å¯†ç ï¼ŒæŒ‰ ctrl+d é€€å‡ºã€‚&lt;/p>
&lt;p>å†ç”¨éšä¾¿å•¥è¿æ¥ä¸Šå»ï¼Œè¿è¡Œ &lt;code>create extension pg_trgm;&lt;/code> å°±å®Œäº‹äº†ã€‚&lt;/p>
&lt;p>æœ€åå°±æ˜¯é‡å¯ä¸‹å®¹å™¨ï¼Œgitlab è‡ªåŠ¨è¿ç§»å®Œæˆåå³å¯è®¿é—®ã€‚&lt;/p>
&lt;h2 id="4-å‡çº§è‡³-v8174">4. å‡çº§è‡³ v8.17.4&lt;/h2>
&lt;p>åŸæœ¬åº”è¯¥å‡çº§åˆ° v8.17.7ï¼Œä½† &lt;code>sameersbn/docker-gitlab&lt;/code> æ²¡æä¾›è¿™ä¸ªç‰ˆæœ¬çš„é•œåƒï¼Œåªèƒ½å…ˆå‡çº§åˆ° v8.17.4 ï¼Œæ±‚è€å¤©ä¿ä½‘åˆ«æŠ˜è…¾å‡ºé—®é¢˜ã€‚&lt;/p>
&lt;p>è€è§„çŸ©æ”¹äº† docker-compose ï¼Œç„¶å up ã€‚&lt;/p>
&lt;p>ç›´æ¥æˆåŠŸï¼Œæ²¡æœ‰é”™è¯¯ã€‚&lt;/p>
&lt;h2 id="5-å‡çº§è‡³-v955">5. å‡çº§è‡³ v9.5.5&lt;/h2>
&lt;p>è€è§„çŸ©ï¼Œè¿˜æ˜¯ç¼ºå°‘é•œåƒï¼ŒåŸæœ¬åº”è¯¥å‡çº§åˆ° v9.5.10ã€‚&lt;/p>
&lt;p>æ”¹äº† docker-compose å† upã€‚&lt;/p>
&lt;p>æˆåŠŸã€‚&lt;/p>
&lt;h2 id="6-å‡çº§è‡³-v1084">6. å‡çº§è‡³ v10.8.4&lt;/h2>
&lt;p>åŸæœ¬åº”è¯¥å‡çº§ v10.8.7 ã€‚æ‡’å¾—è¯´äº†ã€‚æ”¹äº† compose å† up ã€‚&lt;/p>
&lt;h3 id="æ•…éšœthis-probably-isnt-the-expected-value-for-this-secret">æ•…éšœï¼šThis probably isn&amp;rsquo;t the expected value for this secret&lt;/h3>
&lt;p>é”™è¯¯å†…å®¹&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">This probably isn&amp;#39;t the expected value for this secret. To keep using a literal Erb string in config/secrets.yml, replace &amp;amp;lt;%with&amp;amp;lt;%%.
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œé‡å¯äº†ä¸€æ¬¡å®¹å™¨åå°±æ¢å¤äº†ã€‚&lt;/p>
&lt;p>å¯ä»¥å‚è€ƒä¸‹&lt;a class="link" href="https://github.com/sameersbn/docker-gitlab/issues/1625" target="_blank" rel="noopener"
>è¿™ä¸ª&lt;/a>ã€‚&lt;/p>
&lt;h2 id="7-å‡çº§è‡³-v11113">7. å‡çº§è‡³ v11.11.3&lt;/h2>
&lt;p>æ ¹æ® v12 çš„å‡çº§æŒ‡å¼•ï¼Œ&lt;/p>
&lt;blockquote>
&lt;p>In 12.0.0 we made various database related changes. These changes require that users first upgrade to the latest 11.11 patch release.&lt;/p>
&lt;/blockquote>
&lt;p>å¿…é¡»å…ˆå‡çº§åˆ° v11.11.Z ç‰ˆæœ¬ï¼Œå†å‡çº§ v12.0.Z æ‰èƒ½å®Œæˆæ•°æ®åº“è¿ç§»ã€‚&lt;/p>
&lt;p>äºæ˜¯å…ˆå‡çº§åˆ° v11.11.3 (ä¹Ÿæ˜¯å› ä¸ºæ²¡æœ‰ v11.11.8 çš„é•œåƒ)ã€‚&lt;/p>
&lt;p>æˆåŠŸã€‚&lt;/p>
&lt;h2 id="8-å‡çº§è‡³-v1204">8. å‡çº§è‡³ v12.0.4&lt;/h2>
&lt;p>æ ¹æ® 12.0 å‡çº§æŒ‡å¼•ï¼Œå…ˆå‡çº§åˆ° 12.0.Z ç‰ˆæœ¬æ¥å®Œæˆ 11-&amp;gt;12 çš„è¿ç§»ï¼Œå†ç»§ç»­å‡çº§ã€‚&lt;/p>
&lt;p>æˆåŠŸã€‚&lt;/p>
&lt;h2 id="9-å‡çº§è‡³-v1216">9. å‡çº§è‡³ v12.1.6&lt;/h2>
&lt;p>æ ¹æ® 12.1 å‡çº§æŒ‡å¼•ï¼Œåœ¨å‡çº§åˆ° 12.10.Z ä¹‹å‰ï¼Œå¿…é¡»å…ˆå‡çº§åˆ° 12.1.Z ã€‚&lt;/p>
&lt;blockquote>
&lt;p>If you are planning to upgrade from 12.0.Z to 12.10.Z, it is necessary to perform an intermediary upgrade to 12.1.Z before upgrading to 12.10.Z to avoid issues like #215141.&lt;/p>
&lt;/blockquote>
&lt;p>æˆåŠŸã€‚&lt;/p>
&lt;h2 id="10-å‡çº§è‡³-v12106-1">10. å‡çº§è‡³ v12.10.6-1&lt;/h2>
&lt;p>ç¼ºå°‘æœ€æ–°çš„ 12.10.Z é•œåƒï¼Œå…ˆå‡çº§åˆ°èƒ½å‡çº§åˆ°çš„ 12.10.Z æœ€é«˜ç‰ˆæœ¬ã€‚&lt;/p>
&lt;p>æˆåŠŸã€‚&lt;/p>
&lt;h2 id="11-å‡çº§è‡³-v1306">11. å‡çº§è‡³ v13.0.6&lt;/h2>
&lt;p>è¿™ä¸ªç‰ˆæœ¬å¯¹ postgres æ•°æ®åº“ç‰ˆæœ¬æœ‰è¦æ±‚ï¼Œæ•…å‡çº§ postgresql åˆ° 9.6.4 ç‰ˆæœ¬ã€‚é•œåƒè‡ªåŠ¨å®Œæˆäº†æ•°æ®è¿ç§»ã€‚&lt;/p>
&lt;p>ä¹‹åå¯åŠ¨ gitlab å®Œæˆå‡çº§ã€‚&lt;/p>
&lt;p>æˆåŠŸã€‚&lt;/p>
&lt;h2 id="12-å‡çº§è‡³-v13124">12. å‡çº§è‡³ v13.12.4&lt;/h2>
&lt;p>è¿™ä¸ªç‰ˆæœ¬å¯¹ postgres æ•°æ®åº“ç‰ˆæœ¬åˆæœ‰è¦æ±‚ï¼Œæœ€ä½åœ¨ 11 ä»¥ä¸Šï¼Œæ•…å‡çº§ postgresql åˆ° 11-20200524 (sameersbn/postgresql)ã€‚&lt;/p>
&lt;p>åŒæ—¶ï¼Œéœ€è¦å®‰è£…æ’ä»¶ &lt;code>btree_gist&lt;/code>ï¼Œæ•…è¿æ¥ postgresql æ•°æ®åº“åˆ›å»ºã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="k">create&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">extension&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">not&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">exists&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">btree_gist&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¹‹åå¯åŠ¨ gitlab å®Œæˆå‡çº§ã€‚&lt;/p>
&lt;h2 id="13-æ€»ç»“">13. æ€»ç»“&lt;/h2>
&lt;p>ç”±äº gitlab è®¾è®¡è‰¯å¥½ï¼Œå‡çº§åŸºæœ¬æ²¡æœ‰å¤ªå¤§éš¾åº¦ã€‚æŒ‰ç…§æ–‡æ¡£çš„å‡çº§è·¯çº¿é€ä¸ªç‰ˆæœ¬å‡çº§å³å¯ã€‚&lt;/p>
&lt;p>ä¹Ÿæ˜¯æˆ‘è¿æ°”å¥½ï¼Œåœ¨å‡çº§ 10.8.Z ç‰ˆæœ¬çš„æ—¶å€™é‡åˆ°çš„é—®é¢˜é‡å¯åè‡ªå·±æ¶ˆå¤±äº†ï¼Œä¸ç„¶å…‰æ˜¯è¿™ä¸ªé—®é¢˜å¯èƒ½å°±è¦æŠ˜è…¾å¾ˆä¹…ã€‚&lt;/p>
&lt;p>æœ€ç»ˆ gitlab ç‰ˆæœ¬åœç•™åœ¨ 13.12.Z ï¼Œ14.0 è™½ç„¶å·²ç»å‘å¸ƒäº†ï¼Œä½†å‡ºäºç¨³å®šè€ƒè™‘è¿˜æ˜¯å…ˆä¸å‡çº§ã€‚&lt;/p></description></item><item><title>MySQL XA äº‹åŠ¡å’Œåˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†æ¨¡å‹ï¼š2é˜¶æ®µæäº¤</title><link>https://nnnewb.github.io/blog/p/mysql-xa-distributed-transaction-processing-model-2pc/</link><pubDate>Fri, 09 Jul 2021 09:29:22 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/mysql-xa-distributed-transaction-processing-model-2pc/</guid><description>&lt;p>å…³äº MySQL XA äº‹åŠ¡å’Œ 2PCï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†æ¨¡å‹ï¼ˆ&lt;em>Distributed Transaction Processing, DTP Model&lt;/em>ï¼‰çš„å­¦ä¹ ç¬”è®°ã€‚&lt;/p>
&lt;!-- more -->
&lt;h2 id="äº‹åŠ¡">äº‹åŠ¡&lt;/h2>
&lt;h3 id="åˆ†å¸ƒå¼äº‹åŠ¡xa">åˆ†å¸ƒå¼äº‹åŠ¡XA&lt;/h3>
&lt;h4 id="ä»‹ç»">ä»‹ç»&lt;/h4>
&lt;p>MySQLå†…å»ºåˆ†å¸ƒå¼äº‹åŠ¡æ”¯æŒï¼ˆ&lt;code>XA&lt;/code>ï¼‰ï¼Œå‚è€ƒæ–‡æ¡£åˆ—å‡ºå¦‚ä¸‹&lt;/p>
&lt;ul>
&lt;li>[MySQL Manual - XA](&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_xa" target="_blank" rel="noopener"
>MySQL :: MySQL 8.0 Reference Manual :: MySQL Glossary&lt;/a>)&lt;/li>
&lt;li>[MySQL Manual - XA Transaction](&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/xa.html" target="_blank" rel="noopener"
>MySQL :: MySQL 8.0 Reference Manual :: 13.3.8 XA Transactions&lt;/a>)&lt;/li>
&lt;li>[MySQL Manual - XA Transaction Statements](&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/xa-statements.html" target="_blank" rel="noopener"
>MySQL :: MySQL 8.0 Reference Manual :: 13.3.8.1 XA Transaction SQL Statements&lt;/a>)&lt;/li>
&lt;li>[MySQL Manual - XA Transaction State](&lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/xa-states.html" target="_blank" rel="noopener"
>MySQL :: MySQL 8.0 Reference Manual :: 13.3.8.2 XA Transaction States&lt;/a>)&lt;/li>
&lt;/ul>
&lt;p>XA äº‹åŠ¡åœ¨ InnoDB å¼•æ“ä¸­å¯ç”¨ã€‚MySQL XA äº‹åŠ¡å®ç°åŸºäº X/Open CAE æ–‡æ¡£ ã€ŠDistributed Transaction Processing: The XA Specificationã€‹ã€‚è¿™ä»½æ–‡æ¡£ç”± &lt;em>Open Group&lt;/em> å‘å¸ƒï¼Œå¯ä»¥åœ¨ &lt;a class="link" href="http://www.opengroup.org/public/pubs/catalog/c193.htm" target="_blank" rel="noopener"
>http://www.opengroup.org/public/pubs/catalog/c193.htm&lt;/a> è®¿é—®ã€‚å½“å‰ XA å®ç°çš„å±€é™å¯ä»¥åœ¨ &lt;a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/xa-restrictions.html" target="_blank" rel="noopener"
>Section 13.3.8.3, â€œRestrictions on XA Transactionsâ€&lt;/a> æŸ¥çœ‹ã€‚&lt;/p>
&lt;p>&amp;hellip;&lt;/p>
&lt;p>XA äº‹åŠ¡æ˜¯å…¨å±€äº‹åŠ¡å…³è”çš„ä¸€ç»„äº‹åŠ¡æ€§åŠ¨ä½œï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»šã€‚æœ¬è´¨ä¸Šï¼Œè¿™æ˜¯è®© ACID å±æ€§â€œæå‡äº†ä¸€å±‚â€ï¼Œè®©å¤šä¸ªACIDäº‹åŠ¡å¯ä»¥ä½œä¸ºä¸€ä¸ªå…¨å±€æ“ä½œçš„ä¸€éƒ¨åˆ†æ‰§è¡Œï¼Œä½¿å¾—è¿™ä¸ªå…¨å±€æ“ä½œä¹Ÿå…·å¤‡ACIDå±æ€§ã€‚ï¼ˆå¯¹äºéåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œåº”ç”¨å¦‚æœå¯¹è¯»æ•æ„Ÿï¼Œåˆ™&lt;code>SERIALIZABLE&lt;/code>æ›´æ¨èã€‚&lt;code>REPEATABLE READ&lt;/code> åœ¨åˆ†å¸ƒå¼äº‹åŠ¡ä¸­å¹¶ä¸æ˜¯å¾ˆæœ‰æ•ˆã€‚ï¼‰&lt;/p>
&lt;h4 id="äº‹åŠ¡æ¨¡å‹">äº‹åŠ¡æ¨¡å‹&lt;/h4>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/MySQL-XA-and-2PC-DTP-model/%e4%ba%8b%e5%8a%a1%e6%a8%a1%e5%9e%8b.webp" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/MySQL-XA-and-2PC-DTP-model/%e4%ba%8b%e5%8a%a1%e6%a8%a1%e5%9e%8b.webp"
loading="lazy"
alt="DTM">
&lt;/a>
&lt;figcaption>DTM&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å…¶ä¸­ï¼š&lt;/p>
&lt;ul>
&lt;li>**APï¼š**ç”¨æˆ·ç¨‹åº&lt;/li>
&lt;li>**RMsï¼š**æ•°æ®åº“&lt;/li>
&lt;li>**TMï¼š**äº‹åŠ¡ç®¡ç†å™¨&lt;/li>
&lt;/ul>
&lt;p>ç”¨æˆ·ç¨‹åºä¸ç”¨ä»‹ç»ã€‚&lt;/p>
&lt;p>æ ¹æ® Open Group åœ¨ Distributed Transaction Processing Model ä¸­çš„å®šä¹‰ï¼Œä¸€ä¸ªå…¸å‹çš„ RM å¯ä»¥æ˜¯ä¸€ä¸ªæ”¯æŒäº‹åŠ¡çš„æ•°æ®åº“ï¼ˆDBMSï¼‰ã€‚&lt;/p>
&lt;p>TM åˆ™æ˜¯åè°ƒæ•´ä¸ªäºŒé˜¶æ®µæäº¤è¿‡ç¨‹çš„ä¸­ä»‹ã€‚APä»TMè·å¾—XIDï¼Œå®Œæˆ &lt;code>XA START&lt;/code> åˆ° &lt;code>XA END&lt;/code> ï¼Œç„¶åå‘ŠçŸ¥ TM å°±ç»ªã€‚TMæå–æœ¬æ¬¡äº‹åŠ¡çš„æ‰€æœ‰XIDï¼Œå‘RMså‘å‡º&lt;code>XA PREPARE&lt;/code>è¯·æ±‚ï¼Œå¦‚æœå¤±è´¥åˆ™å¯¹æ¯ä¸ª XID å‘å‡º &lt;code>XA ROLLBACK&lt;/code> ï¼ŒæˆåŠŸåˆ™ç»§ç»­å‘å‡º &lt;code>XA COMMIT&lt;/code> ã€‚&lt;/p>
&lt;p>éœ€æ³¨æ„çš„æ˜¯ï¼Œ&lt;code>XA PREPARE&lt;/code> å¤±è´¥å¯ä»¥é€šçŸ¥å…¶ä»–äº‹åŠ¡å›æ»šï¼Œä½†&lt;code>XA COMMIT&lt;/code> å¤±è´¥åˆ™åªèƒ½ç­‰å¾…æ•°æ®åº“æ¢å¤ï¼Œå†è¡Œé‡è¯•ã€‚&lt;code>XA PREPARE&lt;/code>ä¸€æ—¦æˆåŠŸï¼Œåˆ™&lt;code>XA COMMIT&lt;/code> ä¸€å®šæˆåŠŸï¼ˆæˆ–è€…è¯´å¿…é¡»æˆåŠŸï¼‰ã€‚&lt;/p>
&lt;p>TM å®ç°è¦æ±‚è‡ªèº«å´©æºƒåå¿…é¡»èƒ½æ¸…ç†æ¢å¤ï¼Œé˜²æ­¢å‡ºç°XAäº‹åŠ¡æ­»é”ã€‚&lt;/p>
&lt;ul>
&lt;li>ç»§ç»­ PREPARE éœ€è¦æäº¤çš„äº‹åŠ¡&lt;/li>
&lt;li>ç»§ç»­ ROLLBACK æœªå®Œæˆ ROLLBACK çš„äº‹åŠ¡&lt;/li>
&lt;li>ç»§ç»­ COMMIT æœªèƒ½ COMMIT çš„äº‹åŠ¡
&lt;ul>
&lt;li>æœªèƒ½ COMMIT æˆåŠŸåˆ™éœ€è¦é‡è¯•ç›´åˆ°æˆåŠŸ&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>å‡ ä¸ª TM è§’è‰²ï¼ˆæˆ–æ•´å¥—æ–¹æ¡ˆï¼‰çš„å®ç°ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;a class="link" href="https://github.com/seata/seata/" target="_blank" rel="noopener"
>seata/seata: Seata is an easy-to-use, high-performance, open source distributed transaction solution. (github.com)&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://open.unionpay.com/tjweb/product/detail?proId=43" target="_blank" rel="noopener"
>UPSQL Proxy-æŠ€æœ¯äº§å“- ä¸­å›½é“¶è”å¼€æ”¾å¹³å° (unionpay.com)&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://cloud.tencent.com/product/dcdb/" target="_blank" rel="noopener"
>åˆ†å¸ƒå¼æ•°æ®åº“TDSQL MySQLç‰ˆ_ä¼ä¸šçº§åˆ†å¸ƒå¼æ•°æ®åº“è§£å†³æ–¹æ¡ˆ - è…¾è®¯äº‘ (tencent.com)&lt;/a>&lt;/li>
&lt;/ul>
&lt;h4 id="åŸºæœ¬ç”¨æ³•">åŸºæœ¬ç”¨æ³•&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-mysql" data-lang="mysql">&lt;span class="n">XA&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">{&lt;/span>&lt;span class="n">START&lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="n">BEGIN&lt;/span>&lt;span class="err">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">xid&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="k">JOIN&lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="n">RESUME&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="n">XA&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">END&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">xid&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">SUSPEND&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="k">FOR&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">MIGRATE&lt;/span>&lt;span class="p">]]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="n">XA&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">PREPARE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">xid&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="n">XA&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">COMMIT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">xid&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">ONE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">PHASE&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="n">XA&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ROLLBACK&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">xid&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="n">XA&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RECOVER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="k">CONVERT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">XID&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…¶ä¸­ &lt;code>XA START&lt;/code> åè·Ÿéšçš„ &lt;code>JOIN&lt;/code>å’Œ&lt;code>RESUME&lt;/code>å­å¥æ²¡æœ‰ä»»ä½•æ•ˆæœã€‚&lt;/p>
&lt;p>&lt;code>XA END&lt;/code> åè·Ÿéšçš„ &lt;code>SUSPEND&lt;/code> å’Œ &lt;code>FOR MIGRATE&lt;/code> å­å¥ä¹Ÿæ²¡æœ‰ä»»ä½•æ•ˆæœã€‚&lt;/p>
&lt;p>ä»»ä½•&lt;code>XA&lt;/code>è¯­å¥éƒ½ä»¥&lt;code>XA&lt;/code>å…³é”®å­—å¼€å¤´ï¼Œå¤§å¤š&lt;code>XA&lt;/code>è¯­å¥éƒ½éœ€è¦&lt;code>xid&lt;/code>å€¼ã€‚&lt;code>xid&lt;/code> æ˜¯ &lt;strong>XAäº‹åŠ¡çš„æ ‡è¯†ç¬¦&lt;/strong> ï¼Œå®ƒç¡®å®šè¯­å¥åº”ç”¨åˆ°å“ªä¸ªXAäº‹åŠ¡ä¸Šã€‚&lt;/p>
&lt;p>&lt;code>xid&lt;/code>å€¼å¯ä»¥ç”±å®¢æˆ·ç«¯æŒ‡å®šæˆ– MySQL æœåŠ¡å™¨ç”Ÿæˆã€‚&lt;/p>
&lt;p>ä¸€ä¸ª&lt;code>xid&lt;/code>å€¼æœ‰ä¸€åˆ°ä¸‰ä¸ªéƒ¨åˆ†ï¼š&lt;/p>
&lt;pre>&lt;code>xid: gtrid [, bqual [, formatID ]]
&lt;/code>&lt;/pre>&lt;p>&lt;code>gtrid&lt;/code> æ˜¯&lt;strong>å…¨å±€äº‹åŠ¡æ ‡è¯†ç¬¦&lt;/strong> ï¼Œ&lt;code>bqual&lt;/code> æ˜¯&lt;strong>åˆ†æ”¯ä¿®é¥°ç¬¦&lt;/strong>ï¼Œ&lt;code>formatID&lt;/code>æ˜¯ä¸€ä¸ªæ ‡è®° &lt;code>gtrid&lt;/code> å’Œ &lt;code>bqual&lt;/code> æ ¼å¼çš„æ•°å­—ã€‚&lt;/p>
&lt;p>&lt;code>gtrid&lt;/code> å’Œ &lt;code>bqual&lt;/code> å¿…é¡»æ˜¯å­—ç¬¦ä¸²å­—é¢é‡ï¼Œæœ€å¤šä¸è¶…è¿‡ 64 &lt;strong>å­—èŠ‚&lt;/strong> é•¿ã€‚&lt;code>gtrid&lt;/code> å’Œ &lt;code>bqual&lt;/code> å¯ä»¥ä»¥å¤šç§æ–¹å¼æŒ‡å®šï¼Œå¯ä»¥ç”¨å¼•å·åŒ…å›´çš„å­—ç¬¦ä¸²ï¼ˆ&lt;code>'ab'&lt;/code>ï¼‰ï¼›åå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼ˆ&lt;code>X'6162'&lt;/code>ï¼Œ&lt;code>0x6162&lt;/code>ï¼‰ï¼›æˆ–è€…äºŒè¿›åˆ¶å€¼ï¼ˆ&lt;code>b'nnn'&lt;/code>ï¼‰ã€‚&lt;/p>
&lt;p>&lt;code>formatID&lt;/code> å¿…é¡»æ˜¯ä¸€ä¸ªæ— ç¬¦å·æ•´æ•°ã€‚&lt;/p>
&lt;p>&lt;code>gtrid&lt;/code> å’Œ &lt;code>bqual&lt;/code> å€¼åœ¨ MySQL æœåŠ¡å™¨çš„åº•å±‚ XA æ”¯æŒç¨‹åºä¸­è¢«è§£é‡Šä¸ºå­—èŠ‚ã€‚ä¸è¿‡ï¼ŒæœåŠ¡å™¨åœ¨è§£é‡ŠåŒ…å«XAè¯­å¥çš„SQLæ—¶ï¼Œå¯èƒ½è®¾ç½®äº†ç‰¹å®šå­—ç¬¦é›†ã€‚å®‰å…¨èµ·è§ï¼Œæœ€å¥½å°† &lt;code>gtrid&lt;/code> å’Œ &lt;code>bqual&lt;/code> å†™ä½œåå…­è¿›åˆ¶å­—ç¬¦ä¸²å½¢å¼ã€‚&lt;/p>
&lt;p>&lt;code>xid&lt;/code> å€¼é€šå¸¸æ˜¯ç”±äº‹åŠ¡ç®¡ç†å™¨ç”Ÿæˆã€‚ä¸€ä¸ªäº‹åŠ¡ç®¡ç†å™¨äº§ç”Ÿçš„&lt;code>xid&lt;/code>å¿…é¡»ä¸å¦ä¸€ä¸ªäº‹åŠ¡ç®¡ç†å™¨äº§ç”Ÿçš„&lt;code>xid&lt;/code>ä¸åŒã€‚ä¸€ä¸ªç»™å®šçš„äº‹åŠ¡ç®¡ç†å™¨å¿…é¡»èƒ½åœ¨ &lt;code>XA RECOVER&lt;/code> è¿”å›çš„ &lt;code>xid&lt;/code> åˆ—è¡¨ä¸­è¯†åˆ«å‡ºå±äºè‡ªå·±çš„ &lt;code>xid&lt;/code> ã€‚&lt;/p>
&lt;p>&lt;code>XA START xid&lt;/code> ä»¥æŒ‡å®šçš„ &lt;code>xid&lt;/code> å¼€å¯ä¸€ä¸ªæ–° XA äº‹åŠ¡ã€‚æ¯ä¸ª XA äº‹åŠ¡å¿…é¡»åŒ…å«ä¸€ä¸ªå”¯ä¸€çš„ &lt;code>xid&lt;/code> ï¼Œ&lt;code>xid&lt;/code> ä¸èƒ½æ­£åœ¨è¢«å¦ä¸€ä¸ª XA äº‹åŠ¡ä½¿ç”¨ã€‚å”¯ä¸€æ€§é€šè¿‡ &lt;code>gtrid&lt;/code> ä¸ &lt;code>bqual&lt;/code> è¯„ä¼°ã€‚è¯¥ XA äº‹åŠ¡çš„åç»­ XA è¯­å¥éƒ½å¿…é¡»æŒ‡å®š&lt;code>XA START&lt;/code>ä¸­æŒ‡å®šçš„ &lt;code>xid&lt;/code>ã€‚å¦‚æœä½¿ç”¨XAè¯­å¥ä½†æ²¡æœ‰æŒ‡å®šä¸€ä¸ªå¯¹åº”XAäº‹åŠ¡çš„&lt;code>xid&lt;/code>ï¼Œåˆ™äº§ç”Ÿä¸€ä¸ªé”™è¯¯ã€‚&lt;/p>
&lt;p>å¤šä¸ªXAäº‹åŠ¡å¯ä»¥æ˜¯åŒä¸€ä¸ªå…¨å±€äº‹åŠ¡çš„ç»„æˆéƒ¨åˆ†ã€‚åœ¨åŒä¸€ä¸ªå…¨å±€äº‹åŠ¡ä¸­æ‰€æœ‰XAäº‹åŠ¡çš„&lt;code>xid&lt;/code>å¿…é¡»ä½¿ç”¨åŒä¸€ä¸ª &lt;code>gtrid&lt;/code> å€¼ã€‚å› æ­¤ï¼Œ&lt;code>gtrid&lt;/code> å¿…é¡»å…¨å±€å”¯ä¸€ä»¥é¿å…æ··æ·†ã€‚å…¨å±€äº‹åŠ¡ä¸­XAäº‹åŠ¡&lt;code>xid&lt;/code> çš„ &lt;code>bqual&lt;/code> éƒ¨åˆ†å¿…é¡»äº’ä¸ç›¸åŒã€‚ï¼ˆè¦æ±‚ &lt;code>bqual&lt;/code> ä¸åŒæ˜¯å½“å‰MySQLå®ç°çš„é™åˆ¶ï¼Œå¹¶ä¸æ˜¯XAè§„èŒƒçš„ä¸€éƒ¨åˆ†ã€‚ï¼‰&lt;/p>
&lt;p>&lt;code>XA RECOVER&lt;/code> è¯­å¥è¿”å› MySQL æœåŠ¡å™¨ä¸­å¤„äº &lt;code>PREPARED&lt;/code> çŠ¶æ€çš„ XA äº‹åŠ¡ä¿¡æ¯ã€‚è¾“å‡ºä¸­æ¯ä¸€è¡Œéƒ½æ˜¯ä¸€ä¸ªæœåŠ¡å™¨ä¸Šçš„ XA äº‹åŠ¡ï¼Œä¸è®ºæ˜¯å“ªä¸ªå®¢æˆ·ç«¯å¯åŠ¨çš„äº‹åŠ¡ã€‚&lt;/p>
&lt;p>æ‰§è¡Œ &lt;code>XA RECOVER&lt;/code> éœ€è¦ &lt;code>XA_RECOVER_ADMIN&lt;/code> ç‰¹æƒã€‚è¿™ä¸ªç‰¹æƒéœ€æ±‚æ˜¯ä¸ºäº†é˜²æ­¢ç”¨æˆ·å‘ç°å…¶ä»–ä¸å±äºè‡ªå·±çš„äº‹åŠ¡&lt;code>xid&lt;/code>ï¼Œä¸å½±å“XAäº‹åŠ¡çš„æ­£å¸¸æäº¤å’Œå›æ»šã€‚&lt;/p>
&lt;p>&lt;code>XA RECOVER&lt;/code> è¾“å‡ºç±»ä¼¼ä¸‹é¢è¿™æ ·&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-mysql" data-lang="mysql">&lt;span class="n">mysql&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">XA&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RECOVER&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="o">+----------+--------------+--------------+--------+&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">formatID&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">gtrid_length&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">bqual_length&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="o">+----------+--------------+--------------+--------+&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">7&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">abcdef&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="o">+----------+--------------+--------------+--------+&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…¶ä¸­ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>formatID&lt;/code> æ˜¯ &lt;code>xid&lt;/code> ä¸­çš„ &lt;code>formatID&lt;/code> éƒ¨åˆ†&lt;/li>
&lt;li>&lt;code>gtrid_length&lt;/code> æ˜¯ &lt;code>xid&lt;/code> ä¸­ &lt;code>gtrid&lt;/code> éƒ¨åˆ†çš„é•¿åº¦ï¼ˆå­—èŠ‚å•ä½ï¼‰&lt;/li>
&lt;li>&lt;code>bqual_length&lt;/code> æ˜¯ &lt;code>xid&lt;/code> ä¸­ &lt;code>bqual&lt;/code> éƒ¨åˆ†çš„é•¿åº¦ï¼ˆå­—èŠ‚å•ä½ï¼‰&lt;/li>
&lt;/ul>
&lt;p>XIDå€¼å¯èƒ½åŒ…å«ä¸å¯æ‰“å°çš„å­—ç¬¦ã€‚&lt;code>XA RECOVER&lt;/code> å…è®¸ä¸€ä¸ªå¯é€‰çš„ &lt;code>CONVERT XID&lt;/code> å­å¥ï¼Œä»¥ä¾¿å®¢æˆ·ç«¯å¯ä»¥è¯·æ±‚åå…­è¿›åˆ¶æ ¼å¼çš„ XID å€¼ã€‚&lt;/p>
&lt;h4 id="äº‹åŠ¡çŠ¶æ€">äº‹åŠ¡çŠ¶æ€&lt;/h4>
&lt;p>ä¸€ä¸ª XA äº‹åŠ¡ç»å†ä»¥ä¸‹çŠ¶æ€&lt;/p>
&lt;ol>
&lt;li>ä½¿ç”¨&lt;code>XA START&lt;/code>å¯åŠ¨çš„XAäº‹åŠ¡ï¼Œè¿›å…¥&lt;code>ACTIVE&lt;/code>çŠ¶æ€ã€‚&lt;/li>
&lt;li>ä¸€ä¸ªå¤„äº&lt;code>ACTIVE&lt;/code>çŠ¶æ€çš„XAäº‹åŠ¡ï¼Œå¯ä»¥å‘å‡ºSQLè¯­å¥å¡«å……äº‹åŠ¡ï¼Œç„¶åå‘å‡º&lt;code>XA END&lt;/code>è¯­å¥ã€‚&lt;code>XA END&lt;/code>è¯­å¥ä»¤XAäº‹åŠ¡è¿›å…¥&lt;code>IDLE&lt;/code>çŠ¶æ€ã€‚&lt;/li>
&lt;li>ä¸€ä¸ªå¤„äº&lt;code>IDLE&lt;/code>çŠ¶æ€çš„XAäº‹åŠ¡ï¼Œå¯ä»¥å‘å‡º&lt;code>XA PREPARE&lt;/code>è¯­å¥æˆ–&lt;code>XA COMMIT ... ONE PHASE&lt;/code>è¯­å¥ã€‚
&lt;ul>
&lt;li>&lt;code>XA PREPARE&lt;/code> è¯­å¥ä»¤XAäº‹åŠ¡è¿›å…¥&lt;code>PREPARED&lt;/code> çŠ¶æ€ã€‚&lt;code>XA RECOVER&lt;/code> è¯­å¥æ­¤æ—¶å¯ä»¥å‘ç°å¹¶åˆ—å‡ºæ­¤äº‹åŠ¡çš„ XIDã€‚&lt;code>XA RECOVER&lt;/code> å¯ä»¥åˆ—å‡ºæ‰€æœ‰å¤„äº &lt;code>PREPARED&lt;/code> çŠ¶æ€çš„ XA äº‹åŠ¡çš„ XIDã€‚&lt;/li>
&lt;li>&lt;code>XA COMMIT ... ONE PHASE&lt;/code> å‡†å¤‡å¹¶æäº¤XAäº‹åŠ¡ã€‚&lt;code>xid&lt;/code>ä¸ä¼šåˆ—å‡ºåœ¨&lt;code>XA RECOVER&lt;/code>ä¸­ï¼Œå› ä¸ºXAäº‹åŠ¡å®é™…åœ¨æ‰§è¡Œè¯­å¥åå°±ç»“æŸäº†ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>ä¸€ä¸ªå¤„äº&lt;code>PREPARED&lt;/code>çŠ¶æ€çš„XAäº‹åŠ¡ï¼Œå¯ä»¥å‘å‡º&lt;code>XA COMMIT&lt;/code>è¯­å¥æ¥æäº¤å¹¶ç»“æŸXAäº‹åŠ¡ï¼Œæˆ–å‘å‡º&lt;code>XA ROLLBACK&lt;/code>æ¥å›æ»šå¹¶ç»“æŸäº‹åŠ¡ã€‚&lt;/li>
&lt;/ol>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/MySQL-XA-and-2PC-DTP-model/xa-state-transition-diagram.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/MySQL-XA-and-2PC-DTP-model/xa-state-transition-diagram.png"
loading="lazy"
alt="image-20210831105435330">
&lt;/a>
&lt;figcaption>image-20210831105435330&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„XAäº‹åŠ¡ä¾‹å­ï¼Œä½œä¸ºä¸€ä¸ªå…¨å±€äº‹åŠ¡ï¼Œæ’å…¥ä¸€ä¸ªè¡Œã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-mysql" data-lang="mysql">&lt;span class="n">mysql&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">XA&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">START&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;xatest&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="n">Query&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">OK&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rows&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">affected&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">00&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sec&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="n">mysql&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INSERT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INTO&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">mytable&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">VALUES&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="n">Query&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">OK&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">row&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">affected&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">04&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sec&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="n">mysql&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">XA&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">END&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;xatest&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="n">Query&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">OK&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rows&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">affected&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">00&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sec&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="n">mysql&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">XA&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">PREPARE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;xatest&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="n">Query&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">OK&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rows&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">affected&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">00&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sec&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="n">mysql&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">XA&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">COMMIT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;xatest&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="n">Query&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">OK&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rows&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">affected&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">00&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sec&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨ç»™å®šå®¢æˆ·ç«¯è¿æ¥çš„ä¸Šä¸‹æ–‡ä¸­ï¼ŒXAäº‹åŠ¡å’Œæœ¬åœ°äº‹åŠ¡å½¼æ­¤äº’æ–¥ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœ&lt;code>XA START&lt;/code>å‘å‡ºå¹¶å¯åŠ¨äº†ä¸€ä¸ªXAäº‹åŠ¡ï¼Œæ­¤æ—¶ä¸èƒ½å†å¯åŠ¨ä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ç›´åˆ°XAäº‹åŠ¡è¢«æäº¤æˆ–å›æ»šã€‚åè¿‡æ¥è¯´ï¼Œå¦‚æœä¸€ä¸ªæœ¬åœ°äº‹åŠ¡å·²ç»é€šè¿‡&lt;code>START TRANSACTION&lt;/code>å¯åŠ¨ï¼Œåˆ™ä¸èƒ½æ‰§è¡Œä»»ä½•XAè¯­å¥ç›´åˆ°æœ¬åœ°äº‹åŠ¡è¢«æäº¤æˆ–å›æ»šã€‚&lt;/p>
&lt;p>å¦‚æœä¸€ä¸ªXAäº‹åŠ¡åœ¨&lt;code>ACTIVE&lt;/code>çŠ¶æ€ï¼Œåˆ™ä¸èƒ½å‘å‡ºä»»ä½•äº§ç”Ÿéšå¼æäº¤çš„è¯­å¥ï¼ˆå¦‚ &lt;code>create table&lt;/code>ï¼‰ï¼Œå› ä¸ºè¿™è¿åäº†XAåè®®ï¼Œå¯¼è‡´ä¸èƒ½å›æ»šXAäº‹åŠ¡ã€‚å°è¯•æ‰§è¡Œè¿™ç±»è¯­å¥ä¼šå¯¼è‡´ä¸€ä¸ªé”™è¯¯ï¼š&lt;/p>
&lt;pre>&lt;code>ERROR 1399 (XAE07): XAER_RMFAIL: The command cannot be executed
when global transaction is in the ACTIVE state
&lt;/code>&lt;/pre>&lt;h4 id="xa-äº‹åŠ¡å®éªŒ">XA äº‹åŠ¡å®éªŒ&lt;/h4>
&lt;p>å‡†å¤‡æ•°æ®åº“&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-mysql" data-lang="mysql">&lt;span class="k">create&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">database&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">not&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">exists&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">create&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">table&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">not&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">exists&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">test123&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">bigint&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">primary&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">key&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kp">auto_increment&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">64&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">not&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">null&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯åŠ¨ä¸€ä¸ª XA äº‹åŠ¡ï¼Œæ’å…¥è¡¨ï¼Œæœ€åæäº¤ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-mysql" data-lang="mysql">&lt;span class="n">xa&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">start&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;this-is-gtrid&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s1">&amp;#39;this-is-bqual&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">insert&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">into&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">test123&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">values&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;distributed transaction!&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="n">xa&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">end&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;this-is-gtrid&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s1">&amp;#39;this-is-bqual&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c1">-- å‡†å¤‡
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">xa&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">prepare&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;this-is-gtrid&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s1">&amp;#39;this-is-bqual&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c1">-- åº”è¯¥çœ‹åˆ°ä¸Šä¸€æ­¥ prepare çš„ xa äº‹åŠ¡
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">xa&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">recover&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c1">-- æäº¤ xa äº‹åŠ¡ã€‚
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">xa&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">commit&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;this-is-gtrid&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s1">&amp;#39;this-is-bqual&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c1">-- æˆ–è€… rollback
&lt;/span>&lt;span class="c1">-- xa rollback &amp;#39;this-is-gtrid&amp;#39;,&amp;#39;this-is-bqual&amp;#39;;
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰§è¡Œå®Œæˆåï¼Œå¯ä»¥å‘ç°è¡¨ä¸­å¤šäº†ä¸€æ¡è®°å½•&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-mysql" data-lang="mysql">&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">test123&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>ä¸å¸¸ç”¨çš„ Git å‘½ä»¤</title><link>https://nnnewb.github.io/blog/p/%E4%B8%8D%E5%B8%B8%E7%94%A8%E7%9A%84-git-%E5%91%BD%E4%BB%A4/</link><pubDate>Fri, 09 Jul 2021 09:25:16 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/%E4%B8%8D%E5%B8%B8%E7%94%A8%E7%9A%84-git-%E5%91%BD%E4%BB%A4/</guid><description>&lt;p>å¤§æ¦‚æ˜¯ä¸å¤ªå¸¸ç”¨çš„ä¸€äº› Git å‘½ä»¤ã€‚&lt;/p>
&lt;!-- more -->
&lt;h2 id="æ‰¾å›æ•°æ®">æ‰¾å›æ•°æ®&lt;/h2>
&lt;p>ä¸¤ç§åŠæ³•ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">git reflog show
git reset --hard HEAD@&lt;span class="o">{&lt;/span>1&lt;span class="o">}&lt;/span> &lt;span class="c1"># ä»ä¸Šä¸€æ­¥æ‰¾åˆ°å¸Œæœ›å›é€€çš„ä½ç½®&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ–è€…&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">git fsck --lost-found
&lt;span class="nb">cd&lt;/span> .git/lost-found/
&lt;span class="c1"># ç”¨ git show hash æŸ¥çœ‹æ‚¬ç©ºå¯¹è±¡çš„å†…å®¹&lt;/span>
&lt;span class="c1"># ç”¨ git merge hash æˆ–è€… git rebase hash æ¥æ¢å¤åˆ°å½“å‰åˆ†æ”¯é‡Œ&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="åˆå¹¶åˆ†æ”¯æ—¶åˆ›å»ºåˆå¹¶commit">åˆå¹¶åˆ†æ”¯æ—¶åˆ›å»ºåˆå¹¶commit&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">git config branch.master.mergeoptions &lt;span class="s2">&amp;#34;--no-ff&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="åˆ é™¤è¿œç¨‹åˆ†æ”¯">åˆ é™¤è¿œç¨‹åˆ†æ”¯&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">git push --delete origin branch
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="åˆ é™¤å·²ç»åˆå¹¶çš„åˆ†æ”¯">åˆ é™¤å·²ç»åˆå¹¶çš„åˆ†æ”¯&lt;/h2>
&lt;p>&lt;a class="link" href="https://stackoverflow.com/questions/6127328/how-can-i-delete-all-git-branches-which-have-been-merged" target="_blank" rel="noopener"
>å‚è€ƒ&lt;/a>&lt;/p>
&lt;h3 id="åˆ é™¤å·²åˆå¹¶çš„æœ¬åœ°åˆ†æ”¯">åˆ é™¤å·²åˆå¹¶çš„æœ¬åœ°åˆ†æ”¯&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">git branch --merged &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="p">|&lt;/span> grep -E &lt;span class="s2">&amp;#34;^\\s+(patch|feat|refactor|test|misc)&amp;#34;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="p">|&lt;/span> xargs -I&lt;span class="o">{}&lt;/span> git branch -d &lt;span class="o">{}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="åˆ é™¤å·²åˆå¹¶çš„è¿œç¨‹åˆ†æ”¯">åˆ é™¤å·²åˆå¹¶çš„è¿œç¨‹åˆ†æ”¯&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">git branch -r --merged &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="p">|&lt;/span> grep -E &lt;span class="s2">&amp;#34;^\\s+origin/(patch|feat|refactor|test|misc)&amp;#34;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="p">|&lt;/span> sed &lt;span class="s1">&amp;#39;s/origin\///&amp;#39;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="p">|&lt;/span> xargs -I&lt;span class="o">{}&lt;/span> &lt;span class="nb">echo&lt;/span> git push --delete origin &lt;span class="o">{}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>ä»é›¶å®ç°ä¸€ä¸ªå®¹å™¨</title><link>https://nnnewb.github.io/blog/p/%E4%BB%8E%E9%9B%B6%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E5%AE%B9%E5%99%A8/</link><pubDate>Mon, 31 May 2021 16:16:52 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/%E4%BB%8E%E9%9B%B6%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E5%AE%B9%E5%99%A8/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>è‡ªä»çœ‹äº†&lt;code>cocker&lt;/code>é¡¹ç›®çš„ ppt ä¹‹åå°±æœ‰ç‚¹å¿µå¿µä¸å¿˜çš„æ„æ€äº†ï¼Œå®ç°ä¸€ä¸ª docker æˆ– docker çš„ç±»ä¼¼ç‰©çœ‹èµ·æ¥å¹¶ä¸æ˜¯åšä¸åˆ°çš„äº‹æƒ…ã€‚&lt;/p>
&lt;p>äºæ˜¯å°±åŠ¨æ‰‹è¯•ä¸€è¯•ã€‚&lt;/p>
&lt;h2 id="æ ¸å¿ƒæŠ€æœ¯">æ ¸å¿ƒæŠ€æœ¯&lt;/h2>
&lt;h3 id="namespace">namespace&lt;/h3>
&lt;p>å‘½åç©ºé—´åŒ…è£…å…¨å±€ç³»ç»Ÿèµ„æºï¼Œè®©åœ¨å‘½åç©ºé—´ä¸­çš„è¿›ç¨‹çœ‹èµ·æ¥å°±åƒæ˜¯æœ‰è‡ªå·±ç‹¬ç«‹éš”ç¦»çš„å…¨å±€èµ„æºä¸€æ ·ã€‚å‘½åç©ºé—´ä¸­çš„å…¨å±€èµ„æºå¯¹å‘½åç©ºé—´ä¸­çš„å…¶ä»–è¿›ç¨‹éƒ½æ˜¯å¯è§çš„ï¼Œä½†å¯¹å‘½åç©ºé—´å¤–çš„è¿›ç¨‹ä¸å¯è§ã€‚å‘½åç©ºé—´ç”¨é€”ä¹‹ä¸€å°±æ˜¯å®ç°å®¹å™¨ã€‚&lt;/p>
&lt;blockquote>
&lt;pre>&lt;code>Linux provides the following namespaces:
Namespace Constant Isolates
Cgroup CLONE_NEWCGROUP Cgroup root directory
IPC CLONE_NEWIPC System V IPC, POSIX message queues
Network CLONE_NEWNET Network devices, stacks, ports, etc.
Mount CLONE_NEWNS Mount points
PID CLONE_NEWPID Process IDs
User CLONE_NEWUSER User and group IDs
UTS CLONE_NEWUTS Hostname and NIS domain name
&lt;/code>&lt;/pre>
&lt;/blockquote>
&lt;p>å‡ ä¸ªå‘½åç©ºé—´çš„ API&lt;/p>
&lt;ul>
&lt;li>&lt;code>clone&lt;/code>&lt;/li>
&lt;li>&lt;code>setns&lt;/code>&lt;/li>
&lt;li>&lt;code>unshare&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>ä¸å¾—ä¸è¯´ &lt;code>man 7 namespaces&lt;/code> å¯¹ &lt;code>namespace&lt;/code> çš„è§£é‡Šå·²ç»éå¸¸åˆ°ä½äº†ã€‚&lt;/p>
&lt;h3 id="chroot">chroot&lt;/h3>
&lt;p>è¿™ä¸ª Linux ç”¨æˆ·åº”è¯¥è¿˜æ˜¯æ¯”è¾ƒç†Ÿæ‚‰çš„ï¼Œå¦‚ Arch Linux è¿™æ ·çš„å‘è¡Œç‰ˆåœ¨å®‰è£…æ—¶å°±æœ‰ç”¨åˆ°ã€‚&lt;/p>
&lt;p>ä½¿ç”¨ &lt;code>man 2 chroot&lt;/code> æŸ¥çœ‹è¿™ä¸ª api çš„æ–‡æ¡£ã€‚&lt;/p>
&lt;blockquote>
&lt;p>chroot() changes the root directory of the calling process to that specified in path. This directory will be used for pathnames beginning with /. The root directory is inherited by all children of the calling process.&lt;/p>
&lt;p>Only a privileged process (Linux: one with the CAP_SYS_CHROOT capability in its user namespace) may call chroot().&lt;/p>
&lt;/blockquote>
&lt;p>åŸºæœ¬ä½œç”¨æ˜¯æŠŠè°ƒç”¨è¿›ç¨‹çš„æ ¹ç›®å½• &lt;code>/&lt;/code> åˆ‡æ¢åˆ°æŒ‡å®šç›®å½•ï¼Œå­è¿›ç¨‹ä¼šç»§æ‰¿è¿™ä¸ª &lt;code>/&lt;/code> ä½ç½®ï¼›è°ƒç”¨ API éœ€è¦ç‰¹æƒã€‚&lt;/p>
&lt;p>ä¸¾ä¾‹è¯´è°ƒå®Œ &lt;code>chroot(&amp;quot;/home/xxx&amp;quot;)&lt;/code>ï¼Œä½ å†ç”¨ &lt;code>ls&lt;/code> ä¹‹ç±»çš„å‘½ä»¤çœ‹ &lt;code>/&lt;/code> ä¸‹æœ‰ä»€ä¹ˆæ–‡ä»¶ï¼Œçœ‹åˆ°çš„å°±æ˜¯ &lt;code>/home/xxx&lt;/code> ä¸‹çš„å†…å®¹äº†ã€‚&lt;/p>
&lt;p>&lt;code>man 2 chroot&lt;/code> è¿˜æœ‰ä¸€äº›æœ‰æ„æ€çš„å†…å®¹ï¼Œä¸åšèµ˜è¿°ã€‚&lt;/p>
&lt;h3 id="mount">mount&lt;/h3>
&lt;p>ä¹Ÿæ˜¯ Linux ç”¨æˆ·å¾ˆç†Ÿæ‚‰çš„ä¸œè¥¿ã€‚è€è§„çŸ©ï¼Œ&lt;code>man 2 mount&lt;/code> çœ‹çœ‹æ–‡æ¡£ã€‚&lt;/p>
&lt;blockquote>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;sys/mount.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">mount&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">source&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">target&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">filesystemtype&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">unsigned&lt;/span> &lt;span class="kt">long&lt;/span> &lt;span class="n">mountflags&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="k">const&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>mount() attaches the filesystem specified by source (which is often a pathname referring to a device, but can also be the pathname of a directory or file, or a dummy string) to the location (a directory or file) specified by the pathname in target.&lt;/p>
&lt;/blockquote>
&lt;p>&lt;code>mount&lt;/code> ä¼šæŒ‚è½½(attaches) &lt;code>source&lt;/code> å‚æ•°æŒ‡å®šçš„æ–‡ä»¶ç³»ç»Ÿï¼ˆé€šå¸¸æ˜¯è®¾å¤‡è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯æ–‡ä»¶å¤¹ã€æ–‡ä»¶çš„è·¯å¾„æˆ–è™šæ‹Ÿå­—ç¬¦ä¸²ï¼ˆå¦‚&lt;code>proc&lt;/code>ï¼‰ï¼‰åˆ° &lt;code>target&lt;/code> æŒ‡å®šçš„ä½ç½®ï¼ˆç›®å½•æˆ–æ–‡ä»¶ï¼‰ã€‚åŒæ ·éœ€è¦ç‰¹æƒæ¥æ‰§è¡Œã€‚&lt;/p>
&lt;p>&lt;code>source&lt;/code>/&lt;code>target&lt;/code> éƒ½ä¸éš¾ç†è§£ï¼Œ&lt;code>filesystemtype&lt;/code>å¯ä»¥ä»&lt;code>/proc/filesystems&lt;/code>é‡Œè¯»åˆ°å¯ç”¨å€¼ï¼Œæˆ–è€…è‡ªå·±æœä¸€æœï¼›æ¯”è¾ƒé‡è¦çš„å°±æ˜¯ &lt;code>mountflags&lt;/code> äº†ï¼Œå¯ä»¥æŒ‡å®šè¯¸å¦‚&lt;code>MS_RDONLY&lt;/code>ä¹‹ç±»çš„é€‰é¡¹æ¥æŒ‚è½½åªè¯»æ–‡ä»¶ç³»ç»Ÿç­‰ç­‰ã€‚å…·ä½“è¿˜æ˜¯è‡ªå·±æŸ¥æ‰‹å†Œã€‚&lt;/p>
&lt;h3 id="clone">clone&lt;/h3>
&lt;p>æœ€åå°±æ˜¯ç³»ç»Ÿè°ƒç”¨ &lt;code>clone&lt;/code> äº†ã€‚è¿˜æ˜¯å…ˆ &lt;code>man 2 clone&lt;/code>ã€‚&lt;/p>
&lt;blockquote>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cm">/* Prototype for the glibc wrapper function */&lt;/span>
&lt;span class="cp">#define _GNU_SOURCE
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;sched.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">clone&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">fn&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">child_stack&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">flags&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">arg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">...&lt;/span>
&lt;span class="cm">/* pid_t *ptid, void *newtls, pid_t *ctid */&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="cm">/* For the prototype of the raw system call, see NOTES */&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>clone() creates a new process, in a manner similar to fork(2).&lt;/p>
&lt;/blockquote>
&lt;p>æ€»ä½“ç±»ä¼¼äº&lt;code>fork()&lt;/code>ï¼Œä½†å¯ä»¥æŒ‡å®šä¸€ä¸ªå…¥å£å‡½æ•°ï¼Œå‡½æ•°ç»“æŸåˆ™å­è¿›ç¨‹é€€å‡ºï¼Œä¹Ÿå¯ä»¥å…±äº«å†…å­˜ç©ºé—´ï¼Œæ‰€ä»¥è¡Œä¸ºä¹Ÿå¯ä»¥ç±»ä¼¼çº¿ç¨‹ã€‚çœ‹æ€ä¹ˆç”¨ã€‚&lt;/p>
&lt;p>&lt;code>flags&lt;/code>ä¾ç„¶æ˜¯å…³æ³¨çš„é‡ç‚¹ï¼Œ&lt;code>CLONE_NEWUTS&lt;/code>ã€&lt;code>CLONE_NEWNS&lt;/code>ã€&lt;code>CLONE_NEWPID&lt;/code>è¿™äº›å‚æ•°å…è®¸å°†å­è¿›ç¨‹è¿è¡Œåœ¨ç‹¬ç«‹çš„å‘½åç©ºé—´é‡Œã€‚&lt;/p>
&lt;p>&lt;code>man 2 clone&lt;/code> è¿˜æä¾›äº†ä¸€ä¸ª C è¯­è¨€ç¼–å†™çš„ä¾‹å­å¯ä»¥å‚è€ƒã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#define _GNU_SOURCE
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;sys/wait.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;sys/utsname.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;sched.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;string.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdio.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdlib.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;unistd.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="cp">#define errExit(msg) \
&lt;/span>&lt;span class="cp"> do \
&lt;/span>&lt;span class="cp"> { \
&lt;/span>&lt;span class="cp"> perror(msg); \
&lt;/span>&lt;span class="cp"> exit(EXIT_FAILURE); \
&lt;/span>&lt;span class="cp"> } while (0)
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="k">static&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="cm">/* Start function for cloned child */&lt;/span>
&lt;span class="n">childFunc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">arg&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="k">struct&lt;/span> &lt;span class="n">utsname&lt;/span> &lt;span class="n">uts&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="cm">/* Change hostname in UTS namespace of child */&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">sethostname&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">arg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">strlen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">arg&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">errExit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;sethostname&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="cm">/* Retrieve and display hostname */&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">uname&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">uts&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">errExit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;uname&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;uts.nodename in child: %s&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">uts&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">nodename&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="cm">/* Keep the namespace open for a while, by sleeping.
&lt;/span>&lt;span class="cm"> This allows some experimentation--for example, another
&lt;/span>&lt;span class="cm"> process might join the namespace. */&lt;/span>
&lt;span class="n">sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="cm">/* Child terminates now */&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="cp">#define STACK_SIZE (1024 * 1024) &lt;/span>&lt;span class="cm">/* Stack size for cloned child */&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">argc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[])&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">stack&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="cm">/* Start of stack buffer */&lt;/span>
&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">stackTop&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="cm">/* End of stack buffer */&lt;/span>
&lt;span class="n">pid_t&lt;/span> &lt;span class="n">pid&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">struct&lt;/span> &lt;span class="n">utsname&lt;/span> &lt;span class="n">uts&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">argc&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="n">fprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stderr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;Usage: %s &amp;lt;child-hostname&amp;gt;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="n">exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">EXIT_SUCCESS&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="cm">/* Allocate stack for child */&lt;/span>
&lt;span class="n">stack&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">malloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">STACK_SIZE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">stack&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">errExit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;malloc&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">stackTop&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">stack&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">STACK_SIZE&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="cm">/* Assume stack grows downward */&lt;/span>
&lt;span class="cm">/* Create child that has its own UTS namespace;
&lt;/span>&lt;span class="cm"> child commences execution in childFunc() */&lt;/span>
&lt;span class="n">pid&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">clone&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">childFunc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">stackTop&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">CLONE_NEWUTS&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">SIGCHLD&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">pid&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">errExit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;clone&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;clone() returned %ld&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">long&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">pid&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="cm">/* Parent falls through to here */&lt;/span>
&lt;span class="n">sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="cm">/* Give child time to change its hostname */&lt;/span>
&lt;span class="cm">/* Display hostname in parent&amp;#39;s UTS namespace. This will be
&lt;/span>&lt;span class="cm"> different from hostname in child&amp;#39;s UTS namespace. */&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">uname&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">uts&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">errExit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;uname&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;uts.nodename in parent: %s&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">uts&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">nodename&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">waitpid&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pid&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="cm">/* Wait for child */&lt;/span>
&lt;span class="n">errExit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;waitpid&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;child has terminated&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">EXIT_SUCCESS&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æŠŠä¸Šé¢çš„ä»£ç ä¿å­˜åˆ° &lt;code>main.c&lt;/code> ä¹‹åï¼Œä½¿ç”¨å‘½ä»¤ &lt;code>gcc main.c -o clone-demo&lt;/code> ç¼–è¯‘ã€‚&lt;/p>
&lt;p>ç¼–è¯‘å®Œæˆåï¼Œ&lt;code>sudo ./clone-demo new-hostname&lt;/code> æ‰§è¡Œã€‚&lt;/p>
&lt;p>æœ€ç»ˆç»“æœç±»ä¼¼è¿™æ ·&lt;/p>
&lt;pre>&lt;code>DESKTOP-HEKKTQ9 :: ~/repos/container Â» sudo ./clone-demo new-hostname
clone() returned 1515
uts.nodename in child: new-hostname
uts.nodename in parent: DESKTOP-HEKKTQ9
child has terminated
DESKTOP-HEKKTQ9 :: ~/repos/container Â»
&lt;/code>&lt;/pre>&lt;h3 id="setns">setns&lt;/h3>
&lt;p>&lt;code>setns&lt;/code> æŠŠè°ƒç”¨è¿™ä¸ªå‡½æ•°çš„çº¿ç¨‹åŠ å…¥æŒ‡å®š fd çš„å‘½åç©ºé—´é‡Œã€‚è¿™ä¸ª &lt;code>fd&lt;/code> æŒ‡çš„æ˜¯ &lt;code>/proc/1234/ns/uts&lt;/code> è¿™äº›ç‰¹æ®Šæ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ã€‚&lt;/p>
&lt;p>ä¸¾ä¾‹æ¥è¯´ï¼Œæˆ‘ä»¬æŠŠ &lt;code>clone-demo&lt;/code> çš„æºç é‡Œï¼Œ&lt;code>sleep(3)&lt;/code> æ”¹ä¸º &lt;code>sleep(200)&lt;/code>ï¼Œå†æ‰§è¡Œ&lt;code>sudo clone-demo new-hostname &amp;amp;&lt;/code> æŠŠè¿›ç¨‹æ”¾åˆ°åå°ã€‚&lt;/p>
&lt;p>ç„¶åç¼–è¯‘ä¸‹é¢çš„ä»£ç å¹¶æµ‹è¯•åŠ å…¥ clone-demo çš„ uts åç§°ç©ºé—´ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#define _GNU_SOURCE
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;fcntl.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;sched.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;unistd.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdlib.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdio.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="cp">#define errExit(msg) \
&lt;/span>&lt;span class="cp"> do \
&lt;/span>&lt;span class="cp"> { \
&lt;/span>&lt;span class="cp"> perror(msg); \
&lt;/span>&lt;span class="cp"> exit(EXIT_FAILURE); \
&lt;/span>&lt;span class="cp"> } while (0)
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">argc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[])&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">fd&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">argc&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="n">fprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stderr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;%s /proc/PID/ns/FILE cmd args...&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="n">exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">EXIT_FAILURE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">fd&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">O_RDONLY&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="cm">/* Get file descriptor for namespace */&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">fd&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">errExit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;open&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">setns&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="cm">/* Join that namespace */&lt;/span>
&lt;span class="n">errExit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;setns&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">execvp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">]);&lt;/span> &lt;span class="cm">/* Execute a command in namespace */&lt;/span>
&lt;span class="n">errExit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;execvp&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ€ç»ˆç»“æœå¦‚ä¸‹&lt;/p>
&lt;pre>&lt;code>root@DESKTOP-HEKKTQ9:/home/weakptr/repos/container# ./clone-demo new-hostname &amp;amp;
[1] 1826
clone() returned 1827
uts.nodename in child: new-hostname
uts.nodename in parent: DESKTOP-HEKKTQ9
root@DESKTOP-HEKKTQ9:/home/weakptr/repos/container# ./setns-demo /proc/1827/ns/uts /bin/bash
root@new-hostname:/home/weakptr/repos/container# uname -n
new-hostname
root@new-hostname:/home/weakptr/repos/container# exit
root@DESKTOP-HEKKTQ9:/home/weakptr/repos/container# exit
DESKTOP-HEKKTQ9 :: ~/repos/container Â» uname -n
DESKTOP-HEKKTQ9
&lt;/code>&lt;/pre>&lt;h3 id="unshare">unshare&lt;/h3>
&lt;blockquote>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#define _GNU_SOURCE
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;sched.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">unshare&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">flags&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/blockquote>
&lt;p>&lt;code>unshare&lt;/code> ç”¨äºä¸»åŠ¨è§£é™¤å½“å‰è¿›ç¨‹æˆ–çº¿ç¨‹ä»çˆ¶è¿›ç¨‹ç»§æ‰¿çš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆä¾‹å¦‚å‘½åç©ºé—´ï¼‰ã€‚&lt;/p>
&lt;p>&lt;code>unshare&lt;/code>çš„ä¸»è¦ç”¨é€”å°±æ˜¯åœ¨ä¸åˆ›å»ºæ–°çš„è¿›ç¨‹çš„å‰æä¸‹ï¼Œæ§åˆ¶è‡ªå·±çš„å…±äº«æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆè¿˜æ˜¯æŒ‡å‘½åç©ºé—´ï¼‰ã€‚&lt;/p>
&lt;p>å‚æ•° &lt;code>flags&lt;/code> ä¾ç„¶æ˜¯ &lt;code>CLONE_NEWNS&lt;/code> è¿™äº›å¸¸é‡ã€‚æƒ¯ä¾‹è¿˜æ˜¯æœ‰ä¸ª demo ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cm">/* unshare.c
&lt;/span>&lt;span class="cm">
&lt;/span>&lt;span class="cm"> A simple implementation of the unshare(1) command: unshare
&lt;/span>&lt;span class="cm"> namespaces and execute a command.
&lt;/span>&lt;span class="cm">*/&lt;/span>
&lt;span class="cp">#define _GNU_SOURCE
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;sched.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;unistd.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdlib.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdio.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;wait.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="cm">/* A simple error-handling function: print an error message based
&lt;/span>&lt;span class="cm"> on the value in &amp;#39;errno&amp;#39; and terminate the calling process */&lt;/span>
&lt;span class="cp">#define errExit(msg) \
&lt;/span>&lt;span class="cp"> do \
&lt;/span>&lt;span class="cp"> { \
&lt;/span>&lt;span class="cp"> perror(msg); \
&lt;/span>&lt;span class="cp"> exit(EXIT_FAILURE); \
&lt;/span>&lt;span class="cp"> } while (0)
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="k">static&lt;/span> &lt;span class="kt">void&lt;/span>
&lt;span class="nf">usage&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">pname&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="n">fprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stderr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;Usage: %s [options] program [arg...]&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">pname&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">fprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stderr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;Options can be:&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">fprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stderr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34; -i unshare IPC namespace&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">fprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stderr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34; -m unshare mount namespace&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">fprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stderr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34; -n unshare network namespace&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">fprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stderr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34; -p unshare PID namespace&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">fprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stderr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34; -u unshare UTS namespace&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">fprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stderr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34; -U unshare user namespace&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">EXIT_FAILURE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">argc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[])&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">flags&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">opt&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">flags&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">while&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">opt&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">getopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">argc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">argv&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;imnpuU&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">opt&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="sc">&amp;#39;i&amp;#39;&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">flags&lt;/span> &lt;span class="o">|=&lt;/span> &lt;span class="n">CLONE_NEWIPC&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="sc">&amp;#39;m&amp;#39;&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">flags&lt;/span> &lt;span class="o">|=&lt;/span> &lt;span class="n">CLONE_NEWNS&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="sc">&amp;#39;n&amp;#39;&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">flags&lt;/span> &lt;span class="o">|=&lt;/span> &lt;span class="n">CLONE_NEWNET&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="sc">&amp;#39;p&amp;#39;&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">flags&lt;/span> &lt;span class="o">|=&lt;/span> &lt;span class="n">CLONE_NEWPID&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="sc">&amp;#39;u&amp;#39;&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">flags&lt;/span> &lt;span class="o">|=&lt;/span> &lt;span class="n">CLONE_NEWUTS&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="sc">&amp;#39;U&amp;#39;&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">flags&lt;/span> &lt;span class="o">|=&lt;/span> &lt;span class="n">CLONE_NEWUSER&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">usage&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">optind&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="n">argc&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">usage&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">unshare&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">flags&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">errExit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;unshare&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">pid_t&lt;/span> &lt;span class="n">pid&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fork&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">pid&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;child process&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">execvp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">optind&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">optind&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="n">errExit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;execvp&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">else&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;waitpid %ld&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">pid&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">waitpid&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pid&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¿å­˜æˆ &lt;code>unshare.c&lt;/code>ï¼Œä½¿ç”¨&lt;code>gcc unshare.c -o unshare&lt;/code> ç¼–è¯‘ã€‚&lt;/p>
&lt;p>ä¹‹åå¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤æ¥æ£€æŸ¥æ•ˆæœã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">sudo ./unshare -pm /bin/bash &lt;span class="c1"># éš”ç¦» mount å’Œ pid ä¸¤ä¸ª namespace&lt;/span>
waitpid &lt;span class="m">2178&lt;/span>
root@DESKTOP-HEKKTQ9:/home/weakptr/repos/container# mount -t proc proc /proc
root@DESKTOP-HEKKTQ9:/home/weakptr/repos/container# ps -ef
UID PID PPID C STIME TTY TIME CMD
root &lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> 15:22 pts/0 00:00:00 /bin/bash
root &lt;span class="m">3&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> 15:22 pts/0 00:00:00 ps -ef
root@DESKTOP-HEKKTQ9:/home/weakptr/repos/container#
&lt;/code>&lt;/pre>&lt;/div>&lt;p>éœ€è¦æ³¨æ„å‡ ä¸ªç‚¹ï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;code>unshare&lt;/code> æœ€åå¿…é¡»æ˜¯ &lt;code>fork&lt;/code> æ–°è¿›ç¨‹å† &lt;code>execvp&lt;/code>ï¼Œå¦åˆ™ä¼šå‡ºç° &lt;code>cannot allocate memory&lt;/code> é”™è¯¯&lt;/li>
&lt;li>&lt;code>unshare&lt;/code> å¯åŠ¨æ–°çš„ &lt;code>/bin/bash&lt;/code> è¿›ç¨‹åï¼Œ&lt;code>/proc&lt;/code> æŒ‚è½½ç‚¹è¿˜æ²¡æœ‰çœŸæ­£éš”ç¦»ï¼Œæ­¤æ—¶å¯ä»¥æ‰‹åŠ¨ä½¿ç”¨ &lt;code>mount -t proc proc /proc&lt;/code> å‘½ä»¤æŒ‚è½½å½“å‰å‘½åç©ºé—´çš„ &lt;code>procfs&lt;/code>ã€‚&lt;/li>
&lt;li>mount namespace ä¸­æŒ‚è½½äº‹ä»¶ä¼ æ’­ï¼Œå¯ä»¥æŸ¥çœ‹æ–‡æ¡£ &lt;code>man 7 mount_namespaces&lt;/code>ã€‚&lt;/li>
&lt;/ol>
&lt;p>debian ç³»çš„ Linux å‘è¡Œç‰ˆåœ¨ util-linux åŒ…é‡Œæä¾›äº†ä¸€ä¸ª &lt;code>unshare&lt;/code> ç¨‹åºï¼Œæ¯”ä¸Šé¢çš„ demo æ›´å¼ºå¤§ï¼Œç”šè‡³å¯ä»¥ç”¨ä¸€è¡Œå‘½ä»¤å®ç°ä¸€ä¸ªåŸºæœ¬çš„&lt;em>å®¹å™¨&lt;/em>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="c1"># æˆ‘åœ¨ workspace ç›®å½•é‡Œè£…äº† busyboxï¼Œæ‰€ä»¥èƒ½ç›´æ¥è·‘èµ·æ¥ chroot å’Œ /bin/ash&lt;/span>
&lt;span class="c1"># busybox çš„å®‰è£…æ–¹æ³•å‚è€ƒ busybox æºç ç›®å½•ä¸‹çš„ INSTALL æ–‡ä»¶&lt;/span>
&lt;span class="c1"># vim Config.in ä¿®æ”¹ config STATIC ä¸‹çš„ default ä¸º y&lt;/span>
&lt;span class="c1"># make defconfig &amp;amp;&amp;amp; make &amp;amp;&amp;amp; make install CONFIG_PREFIX=ä½ çš„workspaceç›®å½•&lt;/span>
sudo unshare -pumf --mount-proc&lt;span class="o">=&lt;/span>workspace/proc chroot workspace /bin/ash
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç»“æœï¼š&lt;/p>
&lt;pre>&lt;code>/ # ps -ef
PID USER TIME COMMAND
1 0 0:00 /bin/ash
2 0 0:00 ps -ef
/ # ls
bin linuxrc proc sbin usr
/ # mount
proc on /proc type proc (rw,nosuid,nodev,noexec,relatime)
/ #
&lt;/code>&lt;/pre>&lt;h2 id="ç”¨-go-å®ç°">ç”¨ go å®ç°&lt;/h2>
&lt;h3 id="syscall">syscall&lt;/h3>
&lt;p>go å¯¹ç³»ç»Ÿè°ƒç”¨å…¶å®åšäº†ä¸å°‘å°è£…ï¼ŒåŸºæœ¬åœ¨ &lt;code>os&lt;/code> å’Œ &lt;code>syscall&lt;/code> ä¸‹ï¼Œä½†æœ‰å¾ˆå¤šåŒºåˆ«ã€‚æ¯”å¦‚åœ¨ go é‡Œæ‰¾ä¸åˆ° &lt;code>clone&lt;/code>ã€&lt;code>setns&lt;/code> è¿™äº›æ¥å£ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ &lt;code>os/exec&lt;/code> ä¸‹çš„ &lt;code>Cmd&lt;/code> ç»“æ„ã€‚ä¸è¿‡ &lt;code>syscall.Unshare&lt;/code> å€’æ˜¯å¾ˆå¿ å®çš„è¿˜åŸäº†ã€‚è¯¸å¦‚ &lt;code>CLONE_NEWNS&lt;/code> è¿™äº›å¸¸é‡ä¹Ÿå¯ä»¥æ‰¾åˆ°å¯¹åº”çš„ &lt;code>syscall.CLONE_NEWNS&lt;/code>ã€‚&lt;/p>
&lt;p>ä¸é‡å¤ä¸Šé¢çš„ä»£ç äº†ï¼Œå†™ä¸€ä¸ªç®€çŸ­çš„å¯åŠ¨ busybox å®¹å™¨çš„ go ç¨‹åºã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;flag&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;os&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;os/exec&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;syscall&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">flagBootstrap&lt;/span> &lt;span class="kt">bool&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">init&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">BoolVar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">flagBootstrap&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;bootstrap&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;bootstrap busybox container&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">must&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">runBusybox&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Start `busybox ash` in process %d\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Getpid&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="nx">cmd&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">exec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Command&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/bin/busybox&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;ash&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stdin&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stdin&lt;/span>
&lt;span class="nx">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stdout&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stdout&lt;/span>
&lt;span class="nx">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stderr&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stderr&lt;/span>
&lt;span class="nx">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Env&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Env&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;PATH=/bin:/sbin:/usr/bin:/usr/sbin&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">must&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Chroot&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;workspace&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="nf">must&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Chdir&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="nf">must&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Mount&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;proc&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;/proc&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;proc&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="nf">must&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Run&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="nb">println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;unmount proc&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">must&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unmount&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;proc&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">runContainerizedCommand&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">cmd&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">exec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Command&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/proc/self/exe&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Path&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;/proc/self/exe&amp;#34;&lt;/span>
&lt;span class="nx">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Args&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Args&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;-bootstrap&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stdin&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stdin&lt;/span>
&lt;span class="nx">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stdout&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stdout&lt;/span>
&lt;span class="nx">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stderr&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stderr&lt;/span>
&lt;span class="nx">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SysProcAttr&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SysProcAttr&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Cloneflags&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CLONE_NEWUTS&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CLONE_NEWNS&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CLONE_NEWPID&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Unshareflags&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CLONE_NEWNS&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;starting current process %d\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Getpid&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="nf">must&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Run&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Parse&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">flagBootstrap&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">runBusybox&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nf">runContainerizedCommand&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¿å­˜ä¸º &lt;code>demo.go&lt;/code> åç”¨ &lt;code>go build -o demo demo.go&lt;/code> ç¼–è¯‘ï¼Œç„¶åæ‰§è¡Œ &lt;code>sudo ./demo&lt;/code> ã€‚&lt;/p>
&lt;p>ç»“æœåƒæ˜¯è¿™æ ·ï¼š&lt;/p>
&lt;pre>&lt;code>DESKTOP-HEKKTQ9 :: ~/repos/container Â» sudo ./demo
starting current process 2954
Start `busybox ash` in process 1
/ # ps -ef
PID USER TIME COMMAND
1 0 0:00 /proc/self/exe -bootstrap
6 0 0:00 /bin/busybox ash
7 0 0:00 ps -ef
/ # mount
proc on /proc type proc (rw,relatime)
/ #
unmount proc
DESKTOP-HEKKTQ9 :: ~/repos/container Â»
&lt;/code>&lt;/pre>&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>ä¸Šé¢çš„ demo ä»…ä»…æ˜¯åˆ›å»ºäº†ä¸€ä¸ªçœ‹èµ·æ¥åƒå®¹å™¨çš„ç©å…·ï¼Œè¿ cgroup éƒ½æ²¡æœ‰ï¼Œè·ç¦»çœŸæ­£çš„ OCI è¿è¡Œæ—¶è¿˜æœ‰ä¸å°å·®è·ã€‚ä¸è¿‡å·²ç»è¶³å¤Ÿå±•ç¤ºåˆ›å»ºä¸€ä¸ªéš”ç¦»çš„ç¯å¢ƒå¹¶ä¸æ˜¯ç‰¹åˆ«å›°éš¾çš„äº‹æƒ…ï¼Œè¿™å¿…é¡»æ„Ÿè°¢ Linux å†…æ ¸çš„å¼€å‘è€…ä»¬è®©å®¹å™¨æŠ€æœ¯æœ‰äº†å­˜åœ¨çš„å¯èƒ½ï¼Œè€Œä¸”è¿˜èƒ½è¿™ä¹ˆç®€å•åœ°ä½¿ç”¨ã€‚&lt;/p>
&lt;p>å¯ä»¥ç‚¹å‡»[è¿™ä¸ªé“¾æ¥](&lt;a class="link" href="https://github.com/opencontainers/runtime-spec/blob/master/spec.md" target="_blank" rel="noopener"
>runtime-spec/spec.md at master Â· opencontainers/runtime-spec (github.com)&lt;/a>)æŸ¥çœ‹ OCI è¿è¡Œæ—¶çš„è§„æ ¼è¯´æ˜ã€‚&lt;/p>
&lt;p>æ¶‰åŠæ¦‚å¿µï¼š&lt;/p>
&lt;ul>
&lt;li>namespace&lt;/li>
&lt;/ul>
&lt;p>é‡è¦ç³»ç»Ÿè°ƒç”¨&lt;/p>
&lt;ul>
&lt;li>&lt;code>clone&lt;/code>&lt;/li>
&lt;li>&lt;code>setns&lt;/code>&lt;/li>
&lt;li>&lt;code>unshare&lt;/code>&lt;/li>
&lt;li>&lt;code>mount&lt;/code>&lt;/li>
&lt;li>&amp;hellip;&lt;/li>
&lt;/ul>
&lt;p>æœ¬ç¯‡è¿˜ä¸æ¶‰åŠç½‘ç»œï¼Œä»…åœ¨æ–‡ä»¶ç³»ç»Ÿå’Œ PIDã€ç”¨æˆ·ç­‰å±‚çº§åšäº†éš”ç¦»ã€‚ç½‘ç»œéš”ç¦»å¯ä»¥å‚è€ƒ &lt;code>man 7 network_namespaces&lt;/code> ï¼Œä¸è¿‡è°·æ­Œæœäº†ä¸€å¤§åœˆä¹Ÿè¿˜æ²¡æ‰¾åˆ°æ€ä¹ˆåˆ›å»ºè™šæ‹Ÿç½‘å¡ï¼Œæš‚ä¸”å…ˆæ”¾ç€äº†ã€‚&lt;/p></description></item><item><title>2021-04-25 æ— äº‹å‘ç”Ÿ</title><link>https://nnnewb.github.io/blog/p/2021-04-25-%E6%97%A0%E4%BA%8B%E5%8F%91%E7%94%9F/</link><pubDate>Sun, 25 Apr 2021 10:40:30 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/2021-04-25-%E6%97%A0%E4%BA%8B%E5%8F%91%E7%94%9F/</guid><description>&lt;p>4æœˆ25æ—¥å¥½åƒä¹Ÿä¸æ˜¯ä»€ä¹ˆèŠ‚æ—¥ï¼Œå¯¹æˆ‘ä¸ªäººæ¥è¯´ä¹Ÿæ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šæ„ä¹‰ã€‚ä»…ä»…æ˜¯æ™®é€šçš„ä¸€å¤©â€”â€”å¦‚æœä¸ç®—äº”ä¸€è°ƒä¼‘å¯¼è‡´ä»Šå¤©æ˜æ˜æ˜¯å‘¨æ—¥ä½†è¿˜è¦ä¸Šç­è¿™ä¸€ç‚¹çš„è¯ã€‚&lt;/p>
&lt;p>æƒ³æƒ³ä¹ŸæŒºä¸å¯æ€è®®çš„ï¼Œä¸çŸ¥ä¸è§‰å·²ç»åˆ°2021å¹´è¿™ä¸ªåœ¨ä¸å°‘ç§‘å­¦å¹»æƒ³ä¸­çš„â€œæœªæ¥â€æ—¶ä»£äº†ï¼Œå…‰ç®—å·¥ä½œå¹´é™ï¼Œæˆ‘ä¹Ÿå¹²äº†æœ‰å››äº”å¹´çš„ç¨‹åºäº†å§ã€‚&lt;/p>
&lt;p>ä»æœ€å¼€å§‹æŠ±ç€â€œä¸å†™ä»£ç è¿˜èƒ½å¹²å•¥â€åˆ°â€œå†™ä»£ç ä¹ŸæŒºä¸é”™çš„â€ï¼Œå†åˆ°ç°åœ¨ï¼Œâ€œè¿˜èƒ½å†™å‡ å¹´ä»£ç å‘¢â€ã€‚&lt;/p>
&lt;p>åæ€ä¸€ä¸‹è¿™å‡ å¹´ï¼Œå‡ ä¹æ²¡å¹²å‡ºä»€ä¹ˆæˆç»©ï¼Œå·¥ä½œä¸€å¹´ä¸€æ¢ï¼Œå·¥ä½œå‡ å¹´ä¸‹æ¥ï¼Œä¹Ÿæ²¡å‡ ä¸ªè®¤è¯†ã€ç†Ÿæ‚‰åˆ°å¯ä»¥ç§°ä¹‹ä¸ºâ€œæœ‹å‹â€çš„äººã€‚å€’ä¸æ˜¯æˆ‘å­¤åƒ»ï¼ˆè¿™ä¹ˆè¯´çš„äººä¸€èˆ¬éƒ½ç¡®å®å­¤åƒ»å§ï¼‰ï¼Œä¸»è¦æ˜¯ç¡®å®æ²¡ä»€ä¹ˆä¸»è§‚èƒ½åŠ¨æ€§ã€‚&lt;/p>
&lt;p>å¦‚ä»Šè¿™å®¶å…¬å¸å†™å†™ goï¼ŒæŠ˜è…¾æŠ˜è…¾ kubernetesï¼Œä¹Ÿç®—æ¸…é—²ï¼Œåå€’å¼€å§‹å¿§å¿ƒèµ·å°†æ¥äº†ã€‚&lt;/p>
&lt;p>ç°åœ¨çš„å·¥ä½œï¼Œè¯´å¥½ï¼Œä¹Ÿå°±é‚£æ ·ã€‚è¯´ä¸å¥½ï¼Œè¿™ä¸ªå¤§ç¯å¢ƒä¸‹ï¼Œä½†å‡¡æ²¡å¤±ä¸šï¼Œæˆ‘è§‰å¾—éƒ½ç®—ä¸ä¸Šä¸å¥½å§ã€‚&lt;/p>
&lt;p>åˆæ˜¯ç–«æƒ…ï¼Œåˆæ˜¯æ–°å†·æˆ˜ï¼Œåˆæ˜¯å„ç§å„æ ·çš„å¥‡è‘©äº‹ã€‚å½“ç¬‘è¯çœ‹ï¼Œçœ‹ä¹…äº†ä¹Ÿç¬‘ä¸å‡ºæ¥äº†ã€‚&lt;/p>
&lt;p>æˆ‘è¿™äººçˆ±çœ‹å°è¯´ï¼Œä»¥å‰ä¹Ÿæ˜¯åŠ¨ç”»æ¼«ç”»æ¥è€…ä¸æ‹’ï¼Œç‰¹æ•ˆå¤§ç‰‡å°±é¥­ï¼Œæ€»ä¹‹è›®å¿«ä¹çš„ã€‚è¿‡å»è¿˜å†™è¿‡åŒäººå°è¯´ï¼Œå¯æƒœæ²¡å¾—å®¶é‡Œæ”¯æŒï¼Œæœ€åä¹Ÿå°±æ˜¯40ä¸‡å­—å·¦å³å°±åˆ‡äº†ã€‚&lt;/p>
&lt;p>ä¸è¿‡èµ·ç è¿™æ®µç»å†ç®—æ˜¯ç»™æˆ‘æ‰¾ç¬¬ä¸€ä»½ç å†œå·¥ä½œåŠ äº†ç‚¹åŠ©åŠ›ï¼ˆå¤§æ¦‚ï¼‰ã€‚è‡ªä»å¼€å§‹å†™ä»£ç æ‹¿å·¥èµ„ï¼Œå¥½åƒå†™å°è¯´è¿™å›äº‹å°±å’Œæˆ‘æ²¡ä»€ä¹ˆå…³ç³»äº†çš„æ ·å­ã€‚&lt;/p>
&lt;p>ä¸è¿‡æˆ‘è¿˜æ˜¯ä¸€ç›´æƒ³å†™çš„ï¼Œå‡ ä¹æ¯æ¬¡æ¢å·¥ä½œï¼Œå¿ƒé‡Œæƒ³çš„éƒ½æ˜¯ç©ºé—²çš„æ—¶é—´å¤šäº†ï¼Œå°±ä¼šç”¨æ¥åšç‚¹æœ‰æ„ä¹‰çš„äº‹æƒ…ã€‚æ¯”å¦‚å­¦å­¦é’¢ç´å•Šï¼ˆä¹°äº†ç”µé’¢ç´åƒç°ä¸­ï¼‰ï¼Œæ¯”å¦‚å†™å†™å°è¯´å•Šï¼ˆä¹Ÿå°±å¼€äº†ä¸ªå¤´ï¼‰ï¼Œæ¯”å¦‚å­¦ç‚¹æ–°æŠ€æœ¯å•Šï¼ˆæœ‰å€’æ˜¯æœ‰ï¼Œæ–°å·¥ä½œæ–°æŠ€æœ¯æ ˆï¼‰ï¼Œæ€»ä¹‹å°±æ˜¯è‡ªæˆ‘æå‡ä¸‹ã€‚&lt;/p>
&lt;p>ç»“æœå½“ç„¶æ˜¯æ²¡æœ‰çš„ã€‚&lt;/p>
&lt;p>å¥½åƒä»å‰è¯»ä¹¦çš„æ—¶å€™æ§ç€æœ¬ C Primer Plus/C++ Primer çœ‹çš„æ¿€æƒ…å·²ç»å®Œå…¨ä»èº«ä½“é‡Œæ¶ˆå¤±äº†ä¸€æ ·ã€‚ä¸ç®¡æ˜¯ä»€ä¹ˆäº‹æƒ…ï¼Œè™½ç„¶æ€»æ˜¯æƒ³åˆ°ï¼Œå•Šï¼Œè¿™ä¸ªæƒ³è¦ï¼Œé‚£ä¸ªæƒ³è¦ã€‚ä½†ä¸€åˆ°è¡ŒåŠ¨ï¼Œå°±å®Œå…¨æ²¡äº†åŠ¨åŠ›ã€‚â€œåšäº†ä¹Ÿæ²¡ç”¨â€ï¼Œâ€œå­¦äº†ä¹Ÿæ˜¯æµªè´¹æ—¶é—´â€è¿™ç§æƒ³æ³•å°±ä»è„‘å­é‡Œå†’å‡ºæ¥äº†ã€‚&lt;/p>
&lt;p>ä¸èƒ½è¯´å’Œå®¶åº­å®Œå…¨æ²¡å…³ç³»â€”â€”ä½†æŠŠè´£ä»»éƒ½æ¨ç»™çˆ¶æ¯ã€è€å¸ˆï¼Œå¤§æ¦‚ä¹Ÿä¸åˆé€‚ã€‚&lt;/p>
&lt;p>æˆ‘æ˜¯ç›¸ä¿¡ç¯å¢ƒä¼šæ”¹å˜äººçš„ï¼Œå½“ç„¶äººä¹Ÿèƒ½å‘æŒ¥ä¸»è§‚èƒ½åŠ¨æ€§ï¼Œæ”¹é€ ç¯å¢ƒã€‚åƒæ˜¯å¶å­éšæ³¢é€æµè¿›äº†ä¸‹æ°´é“ï¼Œä¸èƒ½è¯´æ˜¯æ°´æœ‰é”™ï¼Œä¹Ÿä¸èƒ½æ€ªå¶å­æ²¡æœ‰å¥‹åŠ›é—ªèº²ï¼Œç§‹é£æ›´æ˜¯æ— è¾œã€‚äºæ˜¯ç¯è§†å››å‘¨ï¼Œæœ€åæ‚²å“€åœ°å‘ç°åªèƒ½æ„Ÿå¹ä¸€å¥å‘½è¿æ— å¸¸ã€‚&lt;/p>
&lt;p>è¯¸å¦‚æœªæ¥å¯ä»¥æ”¹å˜ä¹‹ç±»çš„é¸¡æ±¤å–äº†åˆå–ï¼Œè„‘å­ä¹Ÿæœ‰äº†æŠ—æ€§ï¼Œä¸åˆ‡å®é™…çš„æœŸå¾…ä¹Ÿè¶Šæ¥è¶Šå°‘ï¼Œç„¶åå‘ç°å³ä½¿æ˜¯åˆ‡å®å¯è¡Œçš„æœŸå¾…ä¹Ÿå¼€å§‹è½å‘ä¸åˆ‡å®é™…çš„ä¸€ä¾§ã€‚&lt;/p>
&lt;p>é‚£ä¾¿ä¸æƒ³æœªæ¥äº†å§ã€‚ä¿—è¯è¯´ï¼Œâ€œæŠŠæ¡å½“ä¸‹â€ã€‚äºæ˜¯ä¾¿æ¥ä¸Šç­ï¼Œå¯¹ç€å±å¹•ï¼Œæ— äº‹å¯åšï¼Œç­‰å¾… call of workã€‚&lt;/p>
&lt;p>é‚£ä¾¿æ˜¯è¿™æ ·äº†å§ã€‚&lt;/p>
&lt;p>2021å¹´4æœˆ25æ—¥ï¼Œæ— äº‹å‘ç”Ÿã€‚&lt;/p></description></item><item><title>pattern-match-in-python310</title><link>https://nnnewb.github.io/blog/p/pattern-match-in-python310/</link><pubDate>Fri, 19 Mar 2021 10:19:06 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/pattern-match-in-python310/</guid><description>&lt;h2 id="è¯´æ˜">è¯´æ˜&lt;/h2>
&lt;p>ç®€å•æœºç¿»æ¶¦è‰²ä¸€ä¸‹ PEP-636&lt;/p>
&lt;h2 id="æ¦‚è¦">æ¦‚è¦&lt;/h2>
&lt;p>è¿™ä¸ªPEPæ˜¯PEP 634å¼•å…¥çš„æ¨¡å¼åŒ¹é…æ•™ç¨‹ã€‚&lt;/p>
&lt;p>PEP 622æå‡ºäº†æ¨¡å¼åŒ¹é…çš„è¯­æ³•ï¼Œç¤¾åŒºå’ŒæŒ‡å¯¼å§”å‘˜ä¼šå¯¹æ­¤è¿›è¡Œäº†è¯¦ç»†è®¨è®ºã€‚ä¸€ä¸ªå¸¸è§çš„é—®é¢˜æ˜¯è§£é‡Š(å’Œå­¦ä¹ )è¿™ä¸ªç‰¹æ€§æ˜¯å¦å®¹æ˜“ã€‚è¿™ä¸ªPEPå…³æ³¨çš„æ˜¯æä¾›å¼€å‘äººå‘˜å¯ä»¥ç”¨æ¥å­¦ä¹ Pythonä¸­çš„æ¨¡å¼åŒ¹é…çš„æ–‡æ¡£ç±»å‹ã€‚&lt;/p>
&lt;p>PEP 636 è¢«è®¤ä¸ºæ˜¯PEP 634(æ¨¡å¼åŒ¹é…çš„æŠ€æœ¯è§„èŒƒ)å’ŒPEP 635(æ¨¡å¼åŒ¹é…çš„æ·»åŠ åŠ¨æœºå’Œç†ç”±ä¸è®¾è®¡è€ƒè™‘)çš„æ”¯æŒææ–™ã€‚&lt;/p>
&lt;p>å¯¹äºæƒ³è¦å¿«é€Ÿå›é¡¾è€Œä¸æ˜¯æ•™ç¨‹çš„è¯»è€…ï¼Œè¯·å‚é˜…é™„å½•aã€‚&lt;/p>
&lt;h2 id="æ•™ç¨‹">æ•™ç¨‹&lt;/h2>
&lt;p>ä½œä¸ºæœ¬æ•™ç¨‹çš„ä¸€ä¸ªä¾‹å­ï¼Œä½ å°†ç¼–å†™ä¸€ä¸ªæ–‡æœ¬å†’é™©æ¸¸æˆã€‚è¿™æ˜¯ä¸€ç§äº’åŠ¨å°è¯´å½¢å¼ï¼Œç”¨æˆ·è¾“å…¥æ–‡æœ¬å‘½ä»¤ä¸è™šæ„ä¸–ç•Œè¿›è¡Œäº’åŠ¨ï¼Œå¹¶æ¥æ”¶å…³äºæ‰€å‘ç”Ÿäº‹æƒ…çš„æ–‡æœ¬æè¿°ã€‚å‘½ä»¤å°†æ˜¯ç®€åŒ–å½¢å¼çš„è‡ªç„¶è¯­è¨€ï¼Œå¦‚&lt;code>get sword&lt;/code>ï¼Œ&lt;code>attack dragon&lt;/code>ï¼Œ&lt;code>go north&lt;/code>ï¼Œ&lt;code>enter shop&lt;/code>æˆ–&lt;code>but cheese&lt;/code>ã€‚&lt;/p>
&lt;h3 id="åŒ¹é…åºåˆ—">åŒ¹é…åºåˆ—&lt;/h3>
&lt;p>ä½ çš„ä¸»å¾ªç¯å°†éœ€è¦ä»ç”¨æˆ·é‚£é‡Œè·å–è¾“å…¥ï¼Œå¹¶å°†å®ƒåˆ†å‰²æˆå•è¯ï¼Œä¾‹å¦‚ä¸€ä¸ªåƒè¿™æ ·çš„å­—ç¬¦ä¸²åˆ—è¡¨:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">command&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">input&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;What are you doing next? &amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1"># analyze the result of command.split()&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸‹ä¸€æ­¥æ˜¯è§£è¯»è¿™äº›å•è¯ã€‚æˆ‘ä»¬çš„å¤§å¤šæ•°å‘½ä»¤éƒ½æœ‰ä¸¤ä¸ªè¯:ä¸€ä¸ªåŠ¨ä½œå’Œä¸€ä¸ªå¯¹è±¡ã€‚æ‰€ä»¥ä½ å¯èƒ½ä¼šå¿ä¸ä½è¿™æ ·åš:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="p">[&lt;/span>&lt;span class="n">action&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">obj&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">command&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="o">...&lt;/span> &lt;span class="c1"># interpret action, obj&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™è¡Œä»£ç çš„é—®é¢˜åœ¨äºå®ƒé—æ¼äº†ä¸€äº›ä¸œè¥¿ï¼šå¦‚æœç”¨æˆ·è¾“å…¥çš„å•è¯å¤šäºæˆ–å°‘äº2ä¸ªå•è¯æ€ä¹ˆåŠ?ä¸ºäº†é˜²æ­¢è¿™ä¸ªé—®é¢˜ï¼Œæ‚¨å¯ä»¥æ£€æŸ¥å•è¯åˆ—è¡¨çš„é•¿åº¦ï¼Œæˆ–è€…æ•è·ä¸Šé¢çš„è¯­å¥å°†å¼•å‘çš„&lt;code>ValueError&lt;/code>ã€‚&lt;/p>
&lt;p>æˆ–è€…ï¼Œä½ å¯ä»¥ä½¿ç”¨&lt;code>match&lt;/code>è¯­å¥æ¥ä»£æ›¿:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">match&lt;/span> &lt;span class="n">command&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">():&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">action&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">obj&lt;/span>&lt;span class="p">]:&lt;/span>
&lt;span class="o">...&lt;/span> &lt;span class="c1"># interpret action, obj&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>match&lt;/code>è¯­å¥è®¡ç®—**â€œsubjectâ€**(&lt;code>match&lt;/code>å…³é”®å­—åé¢çš„å€¼)ï¼Œå¹¶æ ¹æ®æ¨¡å¼(&lt;code>case&lt;/code>æ—è¾¹çš„ä»£ç )æ£€æŸ¥å®ƒã€‚ä¸€ä¸ªæ¨¡å¼å¯ä»¥åšä¸¤ä»¶ä¸åŒçš„äº‹æƒ…:&lt;/p>
&lt;ul>
&lt;li>éªŒè¯ subject å…·æœ‰ä¸€å®šçš„ç»“æ„ã€‚åœ¨æ‚¨çš„ç¤ºä¾‹ä¸­ï¼Œ&lt;code>[action, obj]&lt;/code>æ¨¡å¼åŒ¹é…ä»»ä½•æ°å¥½åŒ…å«ä¸¤ä¸ªå…ƒç´ çš„åºåˆ—ã€‚è¿™å«åš &lt;strong>maching&lt;/strong>ã€‚&lt;/li>
&lt;li>å®ƒå°†æ¨¡å¼ä¸­çš„ä¸€äº›åç§°ç»‘å®šåˆ° subject çš„ç»„ä»¶å…ƒç´ ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œå¦‚æœåˆ—è¡¨æœ‰ä¸¤ä¸ªå…ƒç´ ï¼Œå®ƒå°†ç»‘å®š&lt;code>action = subject[0]&lt;/code>å’Œ&lt;code>obj = subject[1]&lt;/code>ã€‚&lt;/li>
&lt;/ul>
&lt;p>å¦‚æœåŒ¹é…ï¼Œåˆ™&lt;code>case&lt;/code>å—å†…çš„è¯­å¥å°†ä¸ç»‘å®šçš„å˜é‡ä¸€èµ·æ‰§è¡Œã€‚å¦‚æœæ²¡æœ‰åŒ¹é…ï¼Œåˆ™ä»€ä¹ˆä¹Ÿä¸å‘ç”Ÿï¼Œç„¶åæ‰§è¡Œ&lt;code>match&lt;/code>ä¹‹åçš„è¯­å¥ã€‚&lt;/p>
&lt;p>æ³¨æ„ï¼Œä¸è§£åŒ…èµ‹å€¼(unpacking assignments)çš„æ–¹å¼ç±»ä¼¼ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨åœ†æ‹¬å·ã€æ–¹æ‹¬å·æˆ–é€—å·åˆ†éš”ï¼Œå®ƒä»¬å«ä¹‰ç›¸åŒã€‚æ‰€ä»¥ä½ å¯ä»¥å†™&lt;code>case action, obj&lt;/code>æˆ–è€…&lt;code>case (action, obj)&lt;/code>ã€‚ä¸Šè¿°ä»»æ„å½¢å¼éƒ½å°†åŒ¹é…åºåˆ—ç±»å‹(ä¾‹å¦‚&lt;code>list&lt;/code>æˆ–&lt;code>tuple&lt;/code>)ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="c1"># è¯‘è€…è¡¥å……ï¼Œä¸‹è¿°caseç­‰æ•ˆ&lt;/span>
&lt;span class="n">match&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">]:&lt;/span> &lt;span class="c1"># match (1,2,3) ä¹Ÿä¸€æ ·&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="n">a&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">b&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">b&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">b&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="p">]:&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="åŒ¹é…å¤šä¸ªæ¨¡å¼">åŒ¹é…å¤šä¸ªæ¨¡å¼&lt;/h3>
&lt;p>å³ä½¿å¤§å¤šæ•°å‘½ä»¤éƒ½æ˜¯åŠ¨ä½œ/å¯¹è±¡å½¢å¼ï¼Œä½ ä¹Ÿå¯èƒ½æƒ³è¦ä¸åŒé•¿åº¦çš„ç”¨æˆ·å‘½ä»¤ã€‚ä¾‹å¦‚ï¼Œä½ å¯èƒ½å¸Œæœ›æ·»åŠ æ²¡æœ‰å¯¹è±¡(å¦‚&lt;code>look&lt;/code>æˆ–&lt;code>quit&lt;/code>)çš„å•ä¸ªåŠ¨è¯ã€‚ä¸€ä¸ª&lt;code>match&lt;/code>è¯­å¥å¯ä»¥(è€Œä¸”å¾ˆå¯èƒ½)æœ‰ä¸æ­¢ä¸€ç§æƒ…å†µ:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">match&lt;/span> &lt;span class="n">command&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">():&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">action&lt;/span>&lt;span class="p">]:&lt;/span>
&lt;span class="o">...&lt;/span> &lt;span class="c1"># interpret single-verb action&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">action&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">obj&lt;/span>&lt;span class="p">]:&lt;/span>
&lt;span class="o">...&lt;/span> &lt;span class="c1"># interpret action, obj&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>match&lt;/code>è¯­å¥å°†ä»ä¸Šåˆ°ä¸‹æ£€æŸ¥æ¨¡å¼ã€‚å¦‚æœæ¨¡å¼ä¸ subject ä¸åŒ¹é…ï¼Œå°†å°è¯•ä¸‹ä¸€ä¸ªæ¨¡å¼ã€‚ä½†æ˜¯ï¼Œä¸€æ—¦æ‰¾åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…çš„æ¨¡å¼ï¼Œå°±ä¼šæ‰§è¡Œè¯¥&lt;code>case&lt;/code>çš„ä¸»ä½“ï¼Œå¹¶å¿½ç•¥æ‰€æœ‰åç»­çš„&lt;code>case&lt;/code>ã€‚è¿™ç±»ä¼¼äº&lt;code>if&lt;/code>/&lt;code>elif&lt;/code>/&lt;code>elif&lt;/code>/â€¦è¯­å¥çš„å·¥ä½œæ–¹å¼ã€‚&lt;/p>
&lt;h3 id="åŒ¹é…ç‰¹å®šå€¼">åŒ¹é…ç‰¹å®šå€¼&lt;/h3>
&lt;p>ä½ çš„ä»£ç ä»ç„¶éœ€è¦æŸ¥çœ‹ç‰¹å®šçš„æ“ä½œï¼Œå¹¶æ ¹æ®ç‰¹å®šçš„æ“ä½œæœ‰æ¡ä»¶åœ°æ‰§è¡Œä¸åŒçš„é€»è¾‘(ä¾‹å¦‚ï¼Œ&lt;code>quit&lt;/code>ã€&lt;code>attack&lt;/code>æˆ–&lt;code>buy&lt;/code>)ã€‚ä½ å¯ä»¥ä½¿ç”¨&lt;code>if&lt;/code>/&lt;code>elif&lt;/code>/&lt;code>elif&lt;/code>/â€¦ï¼Œæˆ–è€…ä½¿ç”¨å‡½æ•°å­—å…¸ï¼Œä½†æ˜¯è¿™é‡Œæˆ‘ä»¬å°†åˆ©ç”¨æ¨¡å¼åŒ¹é…æ¥è§£å†³è¿™ä¸ªä»»åŠ¡ã€‚é™¤äº†å˜é‡ï¼Œä½ å¯ä»¥åœ¨æ¨¡å¼ä¸­ä½¿ç”¨å­—é¢å€¼(å¦‚&lt;code>&amp;quot;quit&amp;quot;&lt;/code>ã€&lt;code>42&lt;/code>æˆ–&lt;code>None&lt;/code>)ã€‚è¿™å…è®¸ä½ è¿™æ ·å†™:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">match&lt;/span> &lt;span class="n">command&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">():&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;quit&amp;#34;&lt;/span>&lt;span class="p">]:&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Goodbye!&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">quit_game&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;look&amp;#34;&lt;/span>&lt;span class="p">]:&lt;/span>
&lt;span class="n">current_room&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">describe&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;get&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">obj&lt;/span>&lt;span class="p">]:&lt;/span>
&lt;span class="n">character&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">obj&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">current_room&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;go&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">direction&lt;/span>&lt;span class="p">]:&lt;/span>
&lt;span class="n">current_room&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">current_room&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">neighbor&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">direction&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1"># The rest of your commands go here&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åƒ&lt;code>[&amp;quot;get&amp;quot;ï¼Œ obj]&lt;/code>è¿™æ ·çš„æ¨¡å¼å°†åªåŒ¹é…ç¬¬ä¸€ä¸ªå…ƒç´ ç­‰äº&lt;code>&amp;quot;get&amp;quot;&lt;/code>çš„2ä¸ªå…ƒç´ çš„åºåˆ—ã€‚å®ƒè¿˜å°†ç»‘å®š&lt;code>obj = subject[1]&lt;/code>ã€‚&lt;/p>
&lt;p>æ­£å¦‚æ‚¨åœ¨ä¸Šè¿°ä»£ç çš„&lt;code>go&lt;/code>æ¨¡å¼ä¸­çœ‹åˆ°çš„ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åœ¨ä¸åŒçš„æ¨¡å¼ä¸­ä½¿ç”¨ä¸åŒçš„å˜é‡åã€‚&lt;/p>
&lt;p>é™¤äº†ä¸&lt;code>is&lt;/code>æ“ä½œç¬¦æ¯”è¾ƒçš„å¸¸é‡&lt;code>True&lt;/code>ã€&lt;code>False&lt;/code>å’Œ&lt;code>None&lt;/code>ä¹‹å¤–ï¼Œå…¶ä»–å­—é¢å€¼æ˜¯ç”¨&lt;code>==&lt;/code>æ“ä½œç¬¦æ¯”è¾ƒçš„ã€‚&lt;/p>
&lt;h3 id="åŒ¹é…å¤šä¸ªå€¼">åŒ¹é…å¤šä¸ªå€¼&lt;/h3>
&lt;p>ç©å®¶å¯ä»¥é€šè¿‡ä½¿ç”¨ä¸€ç³»åˆ—çš„å‘½ä»¤æ¥æŠ•æ·å¤šä¸ªç‰©å“ï¼Œå¦‚:&lt;code>drop key&lt;/code>, &lt;code>drop sword&lt;/code>, &lt;code>drop cheese&lt;/code>ã€‚è¿™ä¸ªæ¥å£å¯èƒ½å¾ˆéº»çƒ¦ï¼Œæ‚¨å¯èƒ½å¸Œæœ›å…è®¸åœ¨ä¸€ä¸ªå‘½ä»¤ä¸­æ·»åŠ å¤šä¸ªé¡¹ï¼Œæ¯”å¦‚&lt;code>drop key sword cheese&lt;/code>ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ äº‹å…ˆä¸çŸ¥é“å‘½ä»¤ä¸­æœ‰å¤šå°‘ä¸ªå•è¯ï¼Œä½†æ˜¯ä½ å¯ä»¥åœ¨æ¨¡å¼ä¸­ä½¿ç”¨æ‰©å±•è§£åŒ…(extended unpacking)ï¼Œå°±åƒå®ƒä»¬åœ¨è§£åŒ…èµ‹å€¼é‡Œçš„å†™æ³•:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">match&lt;/span> &lt;span class="n">command&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">():&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;drop&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">objects&lt;/span>&lt;span class="p">]:&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="n">obj&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">objects&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">character&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">drop&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">obj&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">current_room&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1"># The rest of your commands go here&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™å°†åŒ¹é…ä»»ä½•ä»¥&lt;code>â€œdropâ€&lt;/code>ä½œä¸ºç¬¬ä¸€ä¸ªå…ƒç´ çš„åºåˆ—ã€‚æ‰€æœ‰å‰©ä½™çš„å…ƒç´ éƒ½å°†åœ¨ä¸€ä¸ªåˆ—è¡¨å¯¹è±¡ä¸­è¢«æ•è·ï¼Œè¯¥åˆ—è¡¨å¯¹è±¡å°†ç»‘å®šåˆ°&lt;code>objects&lt;/code>å˜é‡ã€‚&lt;/p>
&lt;p>è¿™ç§è¯­æ³•ä¸åºåˆ—è§£åŒ…æœ‰ç±»ä¼¼çš„é™åˆ¶:åœ¨ä¸€ä¸ªæ¨¡å¼ä¸­ä¸èƒ½æœ‰å¤šä¸ªå¸¦æ˜Ÿå·çš„åç§°ã€‚&lt;/p>
&lt;h3 id="æ·»åŠ é€šé…ç¬¦">æ·»åŠ é€šé…ç¬¦&lt;/h3>
&lt;p>æ‚¨å¯èƒ½å¸Œæœ›æ‰“å°ä¸€æ¡é”™è¯¯æ¶ˆæ¯ï¼Œè¯´æ˜å½“æ‰€æœ‰æ¨¡å¼éƒ½å¤±è´¥æ—¶ï¼Œæ— æ³•è¯†åˆ«è¯¥å‘½ä»¤ã€‚æ‚¨å¯ä»¥ä½¿ç”¨æˆ‘ä»¬åˆšåˆšå­¦ä¹ çš„ç‰¹æ€§ï¼Œå¹¶å°†&lt;code>case [*ignored_words]&lt;/code>ä½œä¸ºæ‚¨çš„æœ€åä¸€ä¸ªæ¨¡å¼ã€‚ç„¶è€Œï¼Œæœ‰ä¸€ä¸ªæ›´ç®€å•çš„æ–¹æ³•:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">match&lt;/span> &lt;span class="n">command&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">():&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;quit&amp;#34;&lt;/span>&lt;span class="p">]:&lt;/span> &lt;span class="o">...&lt;/span> &lt;span class="c1"># Code omitted for brevity&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;go&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">direction&lt;/span>&lt;span class="p">]:&lt;/span> &lt;span class="o">...&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;drop&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">objects&lt;/span>&lt;span class="p">]:&lt;/span> &lt;span class="o">...&lt;/span>
&lt;span class="o">...&lt;/span> &lt;span class="c1"># Other cases&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="n">_&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;Sorry, I couldn&amp;#39;t understand &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">command&lt;/span>&lt;span class="si">!r}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ä¸ªç‰¹æ®Šçš„æ¨¡å¼è¢«å†™æˆ&lt;code>_&lt;/code>(ç§°ä¸ºé€šé…ç¬¦)ã€‚ä¸ç®¡ subject æ˜¯ä»€ä¹ˆå®ƒæ€»æ˜¯èƒ½åŒ¹é…åˆ°ï¼Œä½†å®ƒä¸ç»‘å®šä»»ä½•å˜é‡ã€‚&lt;/p>
&lt;p>æ³¨æ„ï¼Œè¿™å°†åŒ¹é…ä»»ä½•å¯¹è±¡ï¼Œè€Œä¸ä»…ä»…æ˜¯åºåˆ—ã€‚å› æ­¤ï¼Œåªæœ‰å°†å®ƒå•ç‹¬ä½œä¸ºæœ€åä¸€ä¸ªæ¨¡å¼æ‰æœ‰æ„ä¹‰(ä¸ºäº†é˜²æ­¢é”™è¯¯ï¼ŒPythonä¼šé˜»æ­¢æ‚¨åœ¨å…¶ä»–&lt;code>case&lt;/code>ä¹‹å‰ä½¿ç”¨å®ƒ)ã€‚&lt;/p>
&lt;h3 id="æ¨¡å¼ç»„åˆ">æ¨¡å¼ç»„åˆ&lt;/h3>
&lt;p>è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ—¶æœºï¼Œå¯ä»¥ä»ç¤ºä¾‹ä¸­é€€åä¸€æ­¥ï¼Œäº†è§£æ‚¨ä¸€ç›´åœ¨ä½¿ç”¨çš„æ¨¡å¼æ˜¯å¦‚ä½•æ„å»ºçš„ã€‚æ¨¡å¼å¯ä»¥ç›¸äº’åµŒå¥—ï¼Œæˆ‘ä»¬å·²ç»åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­éšå¼åœ°è¿™æ ·åšäº†ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å·²ç»çœ‹åˆ°äº†ä¸€äº›â€œç®€å•â€æ¨¡å¼(è¿™é‡Œçš„â€œç®€å•â€æ„å‘³ç€å®ƒä»¬ä¸åŒ…å«å…¶ä»–æ¨¡å¼):&lt;/p>
&lt;ul>
&lt;li>æ•è·æ¨¡å¼ Capture patterns (ç‹¬ç«‹åç§°ï¼Œå¦‚æ–¹å‘ã€åŠ¨ä½œã€å¯¹è±¡)ã€‚æˆ‘ä»¬ä»æœªå•ç‹¬è®¨è®ºè¿‡è¿™äº›ï¼Œè€Œæ˜¯å°†å®ƒä»¬ä½œä¸ºå…¶ä»–æ¨¡å¼çš„ä¸€éƒ¨åˆ†ä½¿ç”¨ã€‚&lt;/li>
&lt;li>å­—é¢å€¼æ¨¡å¼ Literal patterns (å­—ç¬¦ä¸²å­—é¢å€¼ã€æ•°å­—å­—é¢å€¼ã€&lt;code>True&lt;/code>ã€&lt;code>False&lt;/code>å’Œ&lt;code>None&lt;/code>)&lt;/li>
&lt;li>é€šé…ç¬¦æ¨¡å¼ Wildcard pattern &lt;code>_&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å®éªŒè¿‡çš„å”¯ä¸€ä¸€ä¸ªéç®€å•æ¨¡å¼æ˜¯åºåˆ—æ¨¡å¼ã€‚åºåˆ—æ¨¡å¼ä¸­çš„æ¯ä¸ªå…ƒç´ å®é™…ä¸Šéƒ½å¯ä»¥æ˜¯ä»»ä½•å…¶ä»–æ¨¡å¼ã€‚è¿™æ„å‘³ç€æ‚¨å¯ä»¥ç¼–å†™åƒ&lt;code>[&amp;quot;first&amp;quot;ï¼Œ (left, right)ï¼Œ _ï¼Œ *rest]&lt;/code>è¿™æ ·çš„æ¨¡å¼ã€‚åŒ¹é…çš„ subject æ˜¯ä¸€ä¸ªè‡³å°‘åŒ…å«ä¸‰ä¸ªå…ƒç´ çš„åºåˆ—ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ ç­‰äº&lt;code>&amp;quot;first&amp;quot;&lt;/code>ï¼Œç¬¬äºŒä¸ªå…ƒç´ ä¾æ¬¡æ˜¯ä¸¤ä¸ªå…ƒç´ çš„åºåˆ—ã€‚å®ƒä¹Ÿä¼šç»‘å®š&lt;code>left=subject[1][0]&lt;/code>ï¼Œ &lt;code>right=subject[1][1]&lt;/code>ï¼Œ&lt;code>rest =subject[3:]&lt;/code>&lt;/p>
&lt;h3 id="or-æ¨¡å¼">or æ¨¡å¼&lt;/h3>
&lt;p>å›åˆ°å†’é™©æ¸¸æˆçš„ä¾‹å­ä¸­ï¼Œä½ å¯èƒ½ä¼šå‘ç°ä½ æƒ³è¦ä¸€äº›å¯¼è‡´ç›¸åŒç»“æœçš„æ¨¡å¼ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯èƒ½å¸Œæœ›å‘½ä»¤&lt;code>north&lt;/code>å’Œ&lt;code>go north&lt;/code>ç›¸ç­‰ã€‚æ‚¨å¯èƒ½è¿˜å¸Œæœ›ä¸º&lt;code>get X&lt;/code>å¯ä»¥æœ‰ä¸€äº›åˆ«åå¦‚&lt;code>pick x up&lt;/code>å’Œ&lt;code>pick up x&lt;/code>ã€‚&lt;/p>
&lt;p>æ¨¡å¼ä¸­çš„|ç¬¦å·å°†å®ƒä»¬ç»„åˆä¸ºå¯é€‰é¡¹ã€‚ä½ å¯ä»¥è¿™æ ·å†™:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">match&lt;/span> &lt;span class="n">command&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">():&lt;/span>
&lt;span class="o">...&lt;/span> &lt;span class="c1"># Other cases&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;north&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;go&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;north&amp;#34;&lt;/span>&lt;span class="p">]:&lt;/span>
&lt;span class="n">current_room&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">current_room&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">neighbor&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;north&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;get&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">obj&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;pick&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;up&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">obj&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;pick&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">obj&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;up&amp;#34;&lt;/span>&lt;span class="p">]:&lt;/span>
&lt;span class="o">...&lt;/span> &lt;span class="c1"># Code for picking up the given object&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™è¢«ç§°ä¸º&lt;strong>oræ¨¡å¼&lt;/strong>ï¼Œå¹¶å°†äº§ç”Ÿé¢„æœŸçš„ç»“æœã€‚æ¨¡å¼ä»å·¦åˆ°å³å°è¯•ï¼›å¦‚æœæœ‰å¤šä¸ªå¯é€‰åŒ¹é…ï¼Œé€šè¿‡ä»å·¦è‡³å³è¿™ä¸€è§„åˆ™å¯ä»¥çŸ¥é“æ˜¯åŒ¹é…åˆ°äº†å“ªä¸ªæ¨¡å¼ã€‚åœ¨ç¼–å†™oræ¨¡å¼æ—¶ï¼Œä¸€ä¸ªé‡è¦çš„é™åˆ¶æ˜¯æ‰€æœ‰å¤‡é€‰é¡¹éƒ½åº”è¯¥ç»‘å®šç›¸åŒçš„å˜é‡ã€‚æ‰€ä»¥æ¨¡å¼&lt;code>[1,x] | [2, y]&lt;/code>æ˜¯ä¸å…è®¸çš„ï¼Œå› ä¸ºå®ƒä¼šä½¿åŒ¹é…æˆåŠŸåç»‘å®šå“ªä¸ªå˜é‡å˜å¾—ä¸æ¸…æ¥šã€‚&lt;code>[1, x] | [2, x]&lt;/code>éå¸¸å¥½ï¼Œå¦‚æœæˆåŠŸï¼Œå°†å§‹ç»ˆç»‘å®š&lt;code>x&lt;/code>ã€‚&lt;/p>
&lt;h3 id="æ•è·åŒ¹é…çš„å­æ¨¡å¼">æ•è·åŒ¹é…çš„å­æ¨¡å¼&lt;/h3>
&lt;p>æˆ‘ä»¬çš„&lt;code>â€œgoâ€&lt;/code>å‘½ä»¤çš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬æ˜¯ç”¨&lt;code>[â€œgoâ€ï¼Œdirection]&lt;/code>æ¨¡å¼ç¼–å†™çš„ã€‚æˆ‘ä»¬åœ¨ä¸Šä¸€ä¸ªç‰ˆæœ¬ä¸­ä½¿ç”¨æ¨¡å¼&lt;code>[&amp;quot;north&amp;quot;] | [&amp;quot;go&amp;quot;ï¼Œ &amp;quot;north&amp;quot;]&lt;/code>æ‰€åšçš„æ”¹å˜æœ‰ä¸€äº›å¥½å¤„ï¼Œä½†ä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹:æœ€æ–°ç‰ˆæœ¬å…è®¸åˆ«åï¼Œä½†ä¹Ÿæœ‰ç¡¬ç¼–ç çš„æ–¹å‘åˆ«å&lt;code>&amp;quot;north&amp;quot;&lt;/code>ï¼Œè¿™å°†è¿«ä½¿æˆ‘ä»¬å®é™…ä¸Šæœ‰ç‹¬ç«‹çš„æ¨¡å¼ï¼Œ&lt;code>north&lt;/code>/&lt;code>south&lt;/code>/&lt;code>east&lt;/code>/&lt;code>west&lt;/code>ã€‚è¿™å°†å¯¼è‡´ä¸€äº›ä»£ç é‡å¤ï¼Œä½†åŒæ—¶æˆ‘ä»¬å¾—åˆ°äº†æ›´å¥½çš„è¾“å…¥éªŒè¯ï¼Œå¹¶ä¸”å¦‚æœç”¨æˆ·è¾“å…¥çš„å‘½ä»¤æ˜¯&lt;code>â€œgo figure!â€&lt;/code>è€Œä¸æ˜¯æ–¹å‘ï¼Œæˆ‘ä»¬å°†ä¸ä¼šè¿›å…¥é‚£ä¸ªåˆ†æ”¯ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å¯ä»¥è¯•ç€åœ¨ä¸¤ä¸ªæ–¹é¢éƒ½åšåˆ°æœ€å¥½(ä¸ºäº†ç®€æ´ï¼Œæˆ‘çœç•¥äº†ä¸ä½¿ç”¨&lt;code>â€œgoâ€&lt;/code>çš„åˆ«åç‰ˆæœ¬):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">match&lt;/span> &lt;span class="n">command&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">():&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;go&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;north&amp;#34;&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="s2">&amp;#34;south&amp;#34;&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="s2">&amp;#34;east&amp;#34;&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="s2">&amp;#34;west&amp;#34;&lt;/span>&lt;span class="p">)]:&lt;/span>
&lt;span class="n">current_room&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">current_room&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">neighbor&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1"># how do I know which direction to go?&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™æ®µä»£ç æ˜¯ä¸€ä¸ªå•ç‹¬çš„åˆ†æ”¯ï¼Œå®ƒéªŒè¯&lt;code>â€œgoâ€&lt;/code>ä¹‹åçš„å•è¯æ˜¯å¦ç¡®å®æ˜¯ä¸€ä¸ªæ–¹å‘ã€‚ä½†ç§»åŠ¨ç©å®¶çš„ä»£ç éœ€è¦çŸ¥é“é€‰æ‹©äº†å“ªä¸€ä¸ªï¼Œä½†å´æ— æ³•åšåˆ°è¿™ä¸€ç‚¹ã€‚æˆ‘ä»¬éœ€è¦çš„æ˜¯ä¸€ä¸ªè¡Œä¸ºç±»ä¼¼äºoræ¨¡å¼ä½†åŒæ—¶è¿›è¡Œæ•è·çš„æ¨¡å¼ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨&lt;strong>asæ¨¡å¼&lt;/strong>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">match&lt;/span> &lt;span class="n">command&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">():&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;go&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;north&amp;#34;&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="s2">&amp;#34;south&amp;#34;&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="s2">&amp;#34;east&amp;#34;&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="s2">&amp;#34;west&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">direction&lt;/span>&lt;span class="p">]:&lt;/span>
&lt;span class="n">current_room&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">current_room&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">neighbor&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">direction&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>asæ¨¡å¼åŒ¹é…å·¦è¾¹çš„ä»»ä½•æ¨¡å¼ï¼ŒåŒæ—¶ä¹Ÿå°†å€¼ç»‘å®šåˆ°åç§°ã€‚&lt;/p>
&lt;h3 id="æ·»åŠ æ¡ä»¶åˆ°æ¨¡å¼">æ·»åŠ æ¡ä»¶åˆ°æ¨¡å¼&lt;/h3>
&lt;p>æˆ‘ä»¬ä¸Šé¢æ¢è®¨çš„æ¨¡å¼å¯ä»¥åšä¸€äº›å¼ºå¤§çš„æ•°æ®è¿‡æ»¤ï¼Œä½†æœ‰æ—¶æ‚¨å¯èƒ½å¸Œæœ›å¾—åˆ°å¸ƒå°”è¡¨è¾¾å¼çš„å…¨éƒ¨åŠŸèƒ½ã€‚å‡è®¾æ‚¨å®é™…ä¸Šå¸Œæœ›åªå…è®¸&lt;code>â€œgoâ€&lt;/code>å‘½ä»¤å‡ºç°åœ¨åŸºäºä»&lt;code>current_room&lt;/code>çš„å¯èƒ½å‡ºå£çš„å—é™æ–¹å‘é›†åˆä¸­ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­å¢åŠ ä¸€ä¸ª &lt;strong>guard&lt;/strong> æ¥å®ç°è¿™ä¸€ç‚¹ã€‚guard ç”± if å…³é”®å­—åè·Ÿä»»æ„è¡¨è¾¾å¼ç»„æˆ:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">match&lt;/span> &lt;span class="n">command&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">():&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;go&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">direction&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="n">direction&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">current_room&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">exits&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">current_room&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">current_room&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">neighbor&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">direction&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;go&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">_&lt;/span>&lt;span class="p">]:&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Sorry, you can&amp;#39;t go that way&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>guard ä¸æ˜¯æ¨¡å¼çš„ä¸€éƒ¨åˆ†ï¼Œè€Œæ˜¯ case çš„ä¸€éƒ¨åˆ†ã€‚å®ƒåªåœ¨æ¨¡å¼åŒ¹é…ï¼Œå¹¶ä¸”æ‰€æœ‰æ¨¡å¼å˜é‡éƒ½è¢«ç»‘å®šä¹‹åæ£€æŸ¥(è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ¡ä»¶å¯ä»¥åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ä½¿ç”¨&lt;code>direction&lt;/code>å˜é‡)ã€‚å¦‚æœæ¨¡å¼åŒ¹é…ä¸”æ¡ä»¶ä¸ºçœŸï¼Œåˆ™ case body æ­£å¸¸æ‰§è¡Œã€‚å¦‚æœæ¨¡å¼åŒ¹é…ï¼Œä½†æ¡ä»¶ä¸ºå‡ï¼Œ&lt;code>match&lt;/code>è¯­å¥ç»§ç»­æ£€æŸ¥ä¸‹ä¸€ä¸ªæ¡ä»¶ï¼Œå°±å¥½åƒæ¨¡å¼æ²¡æœ‰åŒ¹é…ä¸€æ ·(å¯èƒ½çš„å‰¯ä½œç”¨æ˜¯å·²ç»ç»‘å®šäº†ä¸€äº›å˜é‡)ã€‚&lt;/p>
&lt;h3 id="æ·»åŠ ui-åŒ¹é…å¯¹è±¡">æ·»åŠ UI: åŒ¹é…å¯¹è±¡&lt;/h3>
&lt;p>ä½ çš„å†’é™©æ¸¸æˆæ­£èµ°å‘æˆåŠŸï¼Œä½ è¢«è¯·æ±‚ä¸ºæ¸¸æˆå®ç°ä¸€ä¸ªå›¾å½¢ç•Œé¢ã€‚æ‚¨æ‰€é€‰æ‹©çš„UIå·¥å…·åŒ…å…è®¸æ‚¨ç¼–å†™ä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼Œæ‚¨å¯ä»¥é€šè¿‡è°ƒç”¨&lt;code>event.get()&lt;/code>æ¥è·å–ä¸€ä¸ªæ–°çš„äº‹ä»¶å¯¹è±¡ã€‚æ ¹æ®ç”¨æˆ·çš„åŠ¨ä½œï¼Œç»“æœå¯¹è±¡å¯ä»¥æœ‰ä¸åŒçš„ç±»å‹å’Œå±æ€§ï¼Œä¾‹å¦‚:&lt;/p>
&lt;ul>
&lt;li>å½“ç”¨æˆ·æŒ‰ä¸‹æŸä¸ªé”®æ—¶ï¼Œå°†ç”Ÿæˆ&lt;code>KeyPress&lt;/code>å¯¹è±¡ã€‚å®ƒæœ‰ä¸€ä¸ª&lt;code>key_name&lt;/code>å±æ€§ï¼Œå…¶ä¸­åŒ…å«æ‰€æŒ‰é”®çš„åç§°ï¼Œä»¥åŠä¸€äº›æœ‰å…³ä¿®é¥°ç¬¦çš„å…¶ä»–å±æ€§ã€‚&lt;/li>
&lt;li>å½“ç”¨æˆ·å•å‡»é¼ æ ‡æ—¶ï¼Œå°†ç”Ÿæˆä¸€ä¸ª&lt;code>Click&lt;/code>å¯¹è±¡ã€‚å®ƒæœ‰ä¸€ä¸ªæŒ‡é’ˆåæ ‡çš„å±æ€§&lt;code>position&lt;/code>ã€‚&lt;/li>
&lt;li>å½“ç”¨æˆ·ç‚¹å‡»æ¸¸æˆçª—å£çš„å…³é—­æŒ‰é’®æ—¶ï¼Œä¼šç”Ÿæˆä¸€ä¸ª&lt;code>Quit&lt;/code>å¯¹è±¡ã€‚&lt;/li>
&lt;/ul>
&lt;p>ä¸å…¶ç¼–å†™å¤šä¸ª&lt;code>isinstance()&lt;/code>æ£€æŸ¥ï¼Œä½ å¯ä»¥ä½¿ç”¨æ¨¡å¼æ¥è¯†åˆ«ä¸åŒç±»å‹çš„å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥å°†æ¨¡å¼åº”ç”¨åˆ°å…¶å±æ€§ä¸Š:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">match&lt;/span> &lt;span class="n">event&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">():&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="n">Click&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">position&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">)):&lt;/span>
&lt;span class="n">handle_click_at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="n">KeyPress&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key_name&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;Q&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">Quit&lt;/span>&lt;span class="p">():&lt;/span>
&lt;span class="n">game&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">quit&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="n">KeyPress&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key_name&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;up arrow&amp;#34;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">game&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">go_north&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="n">KeyPress&lt;/span>&lt;span class="p">():&lt;/span>
&lt;span class="k">pass&lt;/span> &lt;span class="c1"># Ignore other keystrokes&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="n">other_event&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">raise&lt;/span> &lt;span class="ne">ValueError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;Unrecognized event: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">other_event&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åƒ&lt;code>Click(position=(x, y))&lt;/code>è¿™æ ·çš„æ¨¡å¼ä»…åœ¨äº‹ä»¶ç±»å‹æ˜¯&lt;code>Click&lt;/code>ç±»çš„å­ç±»æ—¶æ‰åŒ¹é…ã€‚å®ƒè¿˜è¦æ±‚äº‹ä»¶å…·æœ‰ä¸€ä¸ªä¸&lt;code>(x, y)&lt;/code>æ¨¡å¼åŒ¹é…çš„ä½ç½®å±æ€§ã€‚å¦‚æœåŒ¹é…ï¼Œåˆ™å±€éƒ¨å˜é‡&lt;code>x&lt;/code>å’Œ&lt;code>y&lt;/code>å°†å¾—åˆ°æœŸæœ›çš„å€¼ã€‚&lt;/p>
&lt;p>åƒ&lt;code>KeyPress()&lt;/code>è¿™æ ·ä¸å¸¦å‚æ•°çš„æ¨¡å¼å°†åŒ¹é…ä»»ä½•&lt;code>KeyPress&lt;/code>ç±»å®ä¾‹çš„å¯¹è±¡ã€‚åªæœ‰åœ¨æ¨¡å¼ä¸­æŒ‡å®šçš„å±æ€§æ‰ä¼šåŒ¹é…ï¼Œå…¶ä»–ä»»ä½•å±æ€§éƒ½å°†è¢«å¿½ç•¥ã€‚&lt;/p>
&lt;h3 id="åŒ¹é…ä½ç½®å±æ€§">åŒ¹é…ä½ç½®å±æ€§&lt;/h3>
&lt;p>å‰ä¸€èŠ‚æè¿°äº†åœ¨è¿›è¡Œå¯¹è±¡åŒ¹é…æ—¶å¦‚ä½•åŒ¹é…å‘½åå±æ€§ã€‚å¯¹äºæŸäº›å¯¹è±¡ï¼Œå¯ä»¥æ–¹ä¾¿åœ°æ ¹æ®ä½ç½®æè¿°åŒ¹é…çš„å‚æ•°(ç‰¹åˆ«æ˜¯å½“åªæœ‰å‡ ä¸ªå±æ€§å¹¶ä¸”å®ƒä»¬æœ‰â€œæ ‡å‡†â€æ’åºæ—¶)ã€‚å¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨çš„ç±»æ˜¯å‘½åå…ƒç»„ &lt;code>namedtuple&lt;/code> æˆ–æ•°æ®ç±» &lt;code>dataclass&lt;/code>ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥æŒ‰ç…§æ„é€ å¯¹è±¡æ—¶ä½¿ç”¨çš„ç›¸åŒé¡ºåºæ¥å®ç°è¿™ä¸€ç‚¹ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸Šé¢çš„UIæ¡†æ¶åƒè¿™æ ·å®šä¹‰å®ƒä»¬çš„ç±»:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="kn">from&lt;/span> &lt;span class="nn">dataclasses&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">dataclass&lt;/span>
&lt;span class="nd">@dataclass&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">Click&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">position&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">tuple&lt;/span>
&lt;span class="n">button&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">Button&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶åä½ å¯ä»¥é‡å†™ä½ çš„åŒ¹é…è¯­å¥æ¥åŒ¹é…ä¸Šé¢çš„ subject:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">match&lt;/span> &lt;span class="n">event&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">():&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="n">Click&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">)):&lt;/span>
&lt;span class="n">handle_click_at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>(x, y)&lt;/code>æ¨¡å¼å°†è‡ªåŠ¨åŒ¹é…&lt;code>position&lt;/code>å±æ€§ï¼Œå› ä¸ºæ¨¡å¼ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°å¯¹åº”äºæ•°æ®ç±»å®šä¹‰ä¸­çš„ç¬¬ä¸€ä¸ªå±æ€§ã€‚&lt;/p>
&lt;p>å…¶ä»–ç±»çš„å±æ€§æ²¡æœ‰è‡ªç„¶çš„é¡ºåºï¼Œå› æ­¤éœ€è¦åœ¨æ¨¡å¼ä¸­ä½¿ç”¨æ˜¾å¼åç§°æ¥åŒ¹é…å®ƒä»¬çš„å±æ€§ã€‚ä½†æ˜¯ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨æŒ‡å®šå±æ€§çš„é¡ºåºï¼Œå…è®¸ä½ç½®åŒ¹é…ï¼Œå°±åƒä¸‹é¢è¿™ä¸ªæ›¿ä»£å®šä¹‰:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">class&lt;/span> &lt;span class="nc">Click&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">__match_args__&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;position&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;button&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="fm">__init__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">position&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">button&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>__match_args__&lt;/code>ç‰¹æ®Šå±æ€§å®šä¹‰äº†å¯ä»¥åœ¨&lt;code>case Click((x,y))&lt;/code>ç­‰æ¨¡å¼ä¸­ä½¿ç”¨çš„å±æ€§çš„æ˜¾å¼é¡ºåºã€‚&lt;/p>
&lt;h3 id="åŒ¹é…å¸¸é‡å’Œæšä¸¾">åŒ¹é…å¸¸é‡å’Œæšä¸¾&lt;/h3>
&lt;p>ä¸Šé¢çš„æ¨¡å¼å¯¹æ‰€æœ‰é¼ æ ‡æŒ‰é’®éƒ½ä¸€è§†åŒä»ï¼Œä½†æ‚¨å·²ç»å†³å®šåªæ¥å—é¼ æ ‡å·¦é”®å•å‡»äº‹ä»¶ï¼Œè€Œå¿½ç•¥å…¶ä»–é¼ æ ‡æŒ‰é”®ã€‚åœ¨åšè¿™ä¸€ä¿®æ”¹æ—¶ï¼Œæ‚¨æ³¨æ„åˆ°&lt;code>button&lt;/code>å±æ€§è¢«å®šä¹‰ä¸ºä¸€ä¸ª&lt;code>Button&lt;/code>ï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨&lt;code>enum.Enum&lt;/code>æ„å»ºçš„æšä¸¾ã€‚å®é™…ä¸Šï¼Œä½ å¯ä»¥åƒè¿™æ ·åŒ¹é…æšä¸¾å€¼:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">match&lt;/span> &lt;span class="n">event&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">():&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="n">Click&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">button&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">Button&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">LEFT&lt;/span>&lt;span class="p">):&lt;/span> &lt;span class="c1"># This is a left click&lt;/span>
&lt;span class="n">handle_click_at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="n">Click&lt;/span>&lt;span class="p">():&lt;/span>
&lt;span class="k">pass&lt;/span> &lt;span class="c1"># ignore other clicks&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™å°†é€‚ç”¨äºä»»ä½•å¸¦ç‚¹çš„åç§°(å¦‚&lt;code>math.pi&lt;/code>)ã€‚ç„¶è€Œï¼Œéé™å®šåç§°(å³æ²¡æœ‰ç‚¹çš„è£¸åç§°)å°†æ€»æ˜¯è¢«è§£é‡Šä¸ºæ•è·æ¨¡å¼ï¼Œå› æ­¤åœ¨æ¨¡å¼ä¸­å§‹ç»ˆä½¿ç”¨é™å®šå¸¸é‡å¯ä»¥é¿å…è¿™ç§æ­§ä¹‰ã€‚&lt;/p>
&lt;h3 id="èµ°è¿›äº‘æœåŠ¡åŒ¹é…å­—å…¸">èµ°è¿›äº‘æœåŠ¡ï¼šåŒ¹é…å­—å…¸&lt;/h3>
&lt;p>ä½ å†³å®šåˆ¶ä½œæ¸¸æˆçš„åœ¨çº¿ç‰ˆæœ¬ã€‚æ‚¨çš„æ‰€æœ‰é€»è¾‘éƒ½å°†åœ¨æœåŠ¡å™¨ä¸­ï¼Œè€Œå®¢æˆ·ç«¯ä¸­çš„UIå°†ä½¿ç”¨JSONæ¶ˆæ¯è¿›è¡Œé€šä¿¡ã€‚é€šè¿‡jsonæ¨¡å—ï¼Œè¿™äº›å°†è¢«æ˜ å°„åˆ°Pythonå­—å…¸ã€åˆ—è¡¨å’Œå…¶ä»–å†…ç½®å¯¹è±¡ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬çš„å®¢æˆ·ç«¯å°†æ”¶åˆ°ä¸€ä¸ªå­—å…¸åˆ—è¡¨(ä»JSONè§£æ)ï¼ŒåŒ…å«äº†è¦é‡‡å–çš„åŠ¨ä½œï¼Œæ¯ä¸ªå…ƒç´ çš„æŸ¥æ‰¾ç¤ºä¾‹å¦‚ä¸‹:&lt;/p>
&lt;ul>
&lt;li>&lt;code>{&amp;quot;text&amp;quot;: &amp;quot;The shop keeper says 'Ah! We have Camembert, yes sir'&amp;quot;, &amp;quot;color&amp;quot;: &amp;quot;blue&amp;quot;}&lt;/code>&lt;/li>
&lt;li>å¦‚æœå®¢æˆ·ç«¯åº”è¯¥æš‚åœ&lt;code>{&amp;quot;sleep&amp;quot;: 3}&lt;/code>&lt;/li>
&lt;li>æ’­æ”¾å£°éŸ³ &lt;code>{&amp;quot;sound&amp;quot;: &amp;quot;filename.ogg&amp;quot;, &amp;quot;format&amp;quot;: &amp;quot;ogg&amp;quot;}&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬çš„æ¨¡å¼å·²ç»å¤„ç†äº†åºåˆ—ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸€äº›æ¨¡å¼å¯ä»¥æ ¹æ®å®ƒä»¬å½“å‰çš„é”®åŒ¹é…æ˜ å°„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">for&lt;/span> &lt;span class="n">action&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">actions&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">match&lt;/span> &lt;span class="n">action&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s2">&amp;#34;text&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">message&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;color&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">c&lt;/span>&lt;span class="p">}:&lt;/span>
&lt;span class="n">ui&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set_text_color&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">ui&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">display&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">message&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s2">&amp;#34;sleep&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">duration&lt;/span>&lt;span class="p">}:&lt;/span>
&lt;span class="n">ui&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">wait&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">duration&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s2">&amp;#34;sound&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">url&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;format&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;ogg&amp;#34;&lt;/span>&lt;span class="p">}:&lt;/span>
&lt;span class="n">ui&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">play&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">url&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s2">&amp;#34;sound&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;format&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">_&lt;/span>&lt;span class="p">}:&lt;/span>
&lt;span class="n">warning&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Unsupported audio format&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ˜ å°„æ¨¡å¼ä¸­çš„é”®éœ€è¦æ˜¯å­—é¢å€¼ï¼Œä½†æ˜¯å€¼å¯ä»¥æ˜¯ä»»ä½•æ¨¡å¼ã€‚ä¸åºåˆ—æ¨¡å¼ä¸€æ ·ï¼Œæ‰€æœ‰å­æ¨¡å¼éƒ½å¿…é¡»åŒ¹é…é€šç”¨æ¨¡å¼æ‰èƒ½åŒ¹é…ã€‚&lt;/p>
&lt;p>æ‚¨å¯ä»¥åœ¨æ˜ å°„æ¨¡å¼ä¸­ä½¿ç”¨&lt;code>**rest&lt;/code>æ¥æ•è· subject ä¸­çš„é™„åŠ é”®ã€‚è¯·æ³¨æ„ï¼Œå¦‚æœä½ å¿½ç•¥äº†è¿™ä¸€ç‚¹ï¼Œåœ¨åŒ¹é…æ—¶ï¼Œä¸»é¢˜ä¸­çš„é¢å¤–é”®å°†è¢«å¿½ç•¥ï¼Œä¾‹å¦‚ï¼Œæ¶ˆæ¯&lt;code>{&amp;quot;text&amp;quot;: &amp;quot;foo&amp;quot;ï¼Œ &amp;quot;color&amp;quot;: &amp;quot;red&amp;quot;ï¼Œ &amp;quot;style&amp;quot;: &amp;quot;bold&amp;quot;}&lt;/code>å°†åŒ¹é…ä¸Šé¢ä¾‹å­ä¸­çš„ç¬¬ä¸€ä¸ªæ¨¡å¼ã€‚&lt;/p>
&lt;h3 id="åŒ¹é…å†…å»ºç±»-builtin-classes">åŒ¹é…å†…å»ºç±» builtin classes&lt;/h3>
&lt;p>ä¸Šé¢çš„ä»£ç å¯ä»¥éœ€è¦ä¸€äº›éªŒè¯ã€‚å¦‚æœæ¶ˆæ¯æ¥è‡ªå¤–éƒ¨æºï¼Œåˆ™å­—æ®µçš„ç±»å‹å¯èƒ½æ˜¯é”™è¯¯çš„ï¼Œä»è€Œå¯¼è‡´é”™è¯¯æˆ–å®‰å…¨é—®é¢˜ã€‚&lt;/p>
&lt;p>ä»»ä½•ç±»éƒ½æ˜¯æœ‰æ•ˆçš„åŒ¹é…ç›®æ ‡ï¼Œå…¶ä¸­åŒ…æ‹¬&lt;code>bool&lt;/code>ã€&lt;code>str&lt;/code>æˆ–&lt;code>int&lt;/code>ç­‰å†…ç½®ç±»ï¼Œè¿™å…è®¸æˆ‘ä»¬å°†ä¸Šé¢çš„ä»£ç ä¸ç±»æ¨¡å¼ç»“åˆèµ·æ¥ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ &lt;code>{&amp;quot;text&amp;quot;: str() as message, &amp;quot;color&amp;quot;: str() as c}&lt;/code>æ¥ä»£æ›¿&lt;code>{&amp;quot;text&amp;quot;: message, &amp;quot;color&amp;quot;: c}&lt;/code>æ¥ç¡®ä¿&lt;code>message&lt;/code>å’Œ&lt;code>c&lt;/code>éƒ½æ˜¯å­—ç¬¦ä¸²ã€‚å¯¹äºè®¸å¤šå†…ç½®ç±»(å‚è§PEP-634äº†è§£æ•´ä¸ªåˆ—è¡¨)ï¼Œå¯ä»¥ä½¿ç”¨ä½ç½®å‚æ•°ä½œä¸ºç®€å†™ï¼Œå†™æˆ&lt;code>str(c)&lt;/code>è€Œä¸æ˜¯&lt;code>str() as c&lt;/code>ã€‚å®Œå…¨é‡å†™çš„ç‰ˆæœ¬å¦‚ä¸‹æ‰€ç¤º:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">for&lt;/span> &lt;span class="n">action&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">actions&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">match&lt;/span> &lt;span class="n">action&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s2">&amp;#34;text&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">message&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="s2">&amp;#34;color&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="p">)}:&lt;/span>
&lt;span class="n">ui&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set_text_color&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">ui&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">display&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">message&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s2">&amp;#34;sleep&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">float&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">duration&lt;/span>&lt;span class="p">)}:&lt;/span>
&lt;span class="n">ui&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">wait&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">duration&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s2">&amp;#34;sound&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">url&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="s2">&amp;#34;format&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;ogg&amp;#34;&lt;/span>&lt;span class="p">}:&lt;/span>
&lt;span class="n">ui&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">play&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">url&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s2">&amp;#34;sound&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;format&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">_&lt;/span>&lt;span class="p">}:&lt;/span>
&lt;span class="n">warning&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Unsupported audio format&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="é™„å½•a----å¿«é€Ÿå…¥é—¨">é™„å½•A &amp;ndash; å¿«é€Ÿå…¥é—¨&lt;/h2>
&lt;p>&lt;code>match&lt;/code>è¯­å¥æ¥å—ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œå¹¶å°†å…¶å€¼ä¸ä½œä¸ºä¸€ä¸ªæˆ–å¤šä¸ª&lt;code>case&lt;/code>å—ç»™å‡ºçš„æ¨¡å¼è¿›è¡Œæ¯”è¾ƒã€‚è¿™çœ‹èµ·æ¥ç±»ä¼¼äºCã€Javaæˆ–JavaScript(ä»¥åŠè®¸å¤šå…¶ä»–è¯­è¨€)ä¸­çš„&lt;code>switch&lt;/code>è¯­å¥ï¼Œä½†åŠŸèƒ½è¦å¼ºå¤§å¾—å¤šã€‚&lt;/p>
&lt;p>æœ€ç®€å•çš„å½¢å¼æ˜¯å°†ä¸€ä¸ª subject å€¼ä¸ä¸€ä¸ªæˆ–å¤šä¸ªå­—é¢å€¼è¿›è¡Œæ¯”è¾ƒ:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">def&lt;/span> &lt;span class="nf">http_error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">status&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">match&lt;/span> &lt;span class="n">status&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="mi">400&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s2">&amp;#34;Bad request&amp;#34;&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="mi">404&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s2">&amp;#34;Not found&amp;#34;&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="mi">418&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s2">&amp;#34;I&amp;#39;m a teapot&amp;#34;&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="n">_&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s2">&amp;#34;Something&amp;#39;s wrong with the Internet&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ³¨æ„æœ€åä¸€å—:â€œå˜é‡åâ€&lt;code>_&lt;/code>å……å½“é€šé…ç¬¦ï¼Œæ°¸è¿œä¸ä¼šå¤±è´¥ã€‚&lt;/p>
&lt;p>ä½ å¯ä»¥ä½¿ç”¨&lt;code>|&lt;/code> (&amp;ldquo;or&amp;rdquo;)å°†å‡ ä¸ªå­—é¢å€¼ç»„åˆåœ¨ä¸€ä¸ªæ¨¡å¼ä¸­:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">case&lt;/span> &lt;span class="mi">401&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="mi">403&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="mi">404&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s2">&amp;#34;Not allowed&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¨¡å¼çœ‹èµ·æ¥å°±åƒè§£åŒ…èµ‹å€¼ï¼Œå¯ä»¥ç”¨æ¥ç»‘å®šå˜é‡:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="c1"># point is an (x, y) tuple&lt;/span>
&lt;span class="n">match&lt;/span> &lt;span class="n">point&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Origin&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;Y=&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;X=&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;X=&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">, Y=&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="n">_&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">raise&lt;/span> &lt;span class="ne">ValueError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Not a point&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»”ç»†ç ”ç©¶ä¸€ä¸‹é‚£ä¸ª!ç¬¬ä¸€ä¸ªæ¨¡å¼æœ‰ä¸¤ä¸ªå­—é¢é‡ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ä¸Šé¢æ‰€ç¤ºå­—é¢é‡æ¨¡å¼çš„æ‰©å±•ã€‚ä½†æ˜¯æ¥ä¸‹æ¥çš„ä¸¤ä¸ªæ¨¡å¼ç»„åˆäº†ä¸€ä¸ªå­—é¢é‡å’Œä¸€ä¸ªå˜é‡ï¼Œå˜é‡ç»‘å®šæ¥è‡ª subject (&lt;code>point&lt;/code>)çš„å€¼ã€‚ç¬¬å››ä¸ªæ¨¡å¼æ•è·ä¸¤ä¸ªå€¼ï¼Œè¿™ä½¿å¾—å®ƒåœ¨æ¦‚å¿µä¸Šç±»ä¼¼äºè§£åŒ…èµ‹å€¼&lt;code>(x, y) = point&lt;/code>ã€‚&lt;/p>
&lt;p>å¦‚æœä½ ä½¿ç”¨ç±»æ¥æ„é€ æ•°æ®ï¼Œä½ å¯ä»¥ä½¿ç”¨ç±»ååè·Ÿä¸€ä¸ªç±»ä¼¼æ„é€ å‡½æ•°çš„å‚æ•°åˆ—è¡¨ï¼Œä½†æ˜¯å¯ä»¥å°†å±æ€§æ•è·åˆ°å˜é‡ä¸­:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">class&lt;/span> &lt;span class="nc">Point&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">x&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">int&lt;/span>
&lt;span class="n">y&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">int&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">where_is&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">point&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">match&lt;/span> &lt;span class="n">point&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="n">Point&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Origin&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="n">Point&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;Y=&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="n">Point&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;X=&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="n">Point&lt;/span>&lt;span class="p">():&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Somewhere else&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="n">_&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Not a point&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½ å¯ä»¥åœ¨ä¸€äº›å†…ç½®ç±»ä¸­ä½¿ç”¨ä½ç½®å‚æ•°ï¼Œè¿™äº›ç±»ä¸ºå®ƒä»¬çš„å±æ€§(ä¾‹å¦‚æ•°æ®ç±»)æä¾›æ’åºã€‚ä½ ä¹Ÿå¯ä»¥é€šè¿‡åœ¨ä½ çš„ç±»ä¸­è®¾ç½®&lt;code>__match_args__&lt;/code>ç‰¹æ®Šå±æ€§æ¥å®šä¹‰æ¨¡å¼ä¸­å±æ€§çš„ç‰¹å®šä½ç½®ã€‚å¦‚æœå®ƒè¢«è®¾ç½®ä¸º&lt;code>(&amp;quot;x&amp;quot;ï¼Œ &amp;quot;y&amp;quot;)&lt;/code>ï¼Œä»¥ä¸‹æ¨¡å¼éƒ½æ˜¯ç­‰ä»·çš„(å¹¶ä¸”éƒ½å°†&lt;code>y&lt;/code>å±æ€§ç»‘å®šåˆ°&lt;code>var&lt;/code>å˜é‡):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">Point&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">var&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">Point&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">var&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">Point&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">var&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">Point&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">var&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¨¡å¼å¯ä»¥ä»»æ„åµŒå¥—ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªç®€çŸ­çš„ç‚¹åˆ—è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·åŒ¹é…:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">match&lt;/span> &lt;span class="n">points&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">[]:&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;No points&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">Point&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)]:&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;The origin&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">Point&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">)]:&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;Single point &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">, &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">Point&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y1&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">Point&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y2&lt;/span>&lt;span class="p">)]:&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;Two on the Y axis at &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">y1&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">, &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">y2&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="n">_&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Something else&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ‘ä»¬å¯ä»¥å‘æ¨¡å¼æ·»åŠ ä¸€ä¸ª&lt;code>if&lt;/code>å­å¥ï¼Œç§°ä¸ºâ€œguardâ€ã€‚å¦‚æœ guard ä¸ºå‡ï¼Œ&lt;code>match&lt;/code> ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ª&lt;code>case&lt;/code>å—ã€‚æ³¨æ„ï¼Œå€¼æ•è·å‘ç”Ÿåœ¨guardæ±‚å€¼ä¹‹å‰:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">match&lt;/span> &lt;span class="n">point&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="n">Point&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;Y=X at &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="n">Point&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;Not on the diagonal&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…¶ä»–å‡ ä¸ªå…³é”®åŠŸèƒ½:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>ä¸è§£åŒ…èµ‹å€¼ä¸€æ ·ï¼Œå…ƒç»„å’Œåˆ—è¡¨æ¨¡å¼å…·æœ‰å®Œå…¨ç›¸åŒçš„å«ä¹‰ï¼Œå¹¶ä¸”å®é™…ä¸ŠåŒ¹é…ä»»æ„åºåˆ—ã€‚ä¸€ä¸ªé‡è¦çš„å¼‚å¸¸æ˜¯å®ƒä»¬&lt;strong>ä¸åŒ¹é…&lt;/strong>è¿­ä»£å™¨æˆ–å­—ç¬¦ä¸²ã€‚(æŠ€æœ¯ä¸Šè®²ï¼Œsubject å¿…é¡»æ˜¯&lt;code>collections.abc.Sequence&lt;/code>çš„ä¸€ä¸ªå®ä¾‹ã€‚)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åºåˆ—æ¨¡å¼æ”¯æŒé€šé…ç¬¦:&lt;code>[x, yï¼Œ *rest]&lt;/code>å’Œ&lt;code>(x, yï¼Œ *rest)&lt;/code>åœ¨è§£åŒ…èµ‹å€¼æ—¶çš„å·¥ä½œç±»ä¼¼äºé€šé…ç¬¦ã€‚*åé¢çš„åç§°ä¹Ÿå¯ä»¥æ˜¯&lt;code>_&lt;/code>ï¼Œæ‰€ä»¥&lt;code>(x, yï¼Œ *_)&lt;/code>åŒ¹é…è‡³å°‘æœ‰ä¸¤ä¸ªé¡¹çš„åºåˆ—ï¼Œè€Œä¸ç»‘å®šå…¶ä½™çš„é¡¹ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ˜ å°„æ¨¡å¼:&lt;code>{&amp;quot;bandwidth&amp;quot;: bï¼Œ &amp;quot;latency&amp;quot;: l}&lt;/code>ä»å­—å…¸ä¸­æ•è·&lt;code>&amp;quot;bandwidth&amp;quot;&lt;/code>å’Œ&lt;code>&amp;quot;latency&amp;quot;&lt;/code>å€¼ã€‚ä¸åºåˆ—æ¨¡å¼ä¸åŒï¼Œé¢å¤–çš„é”®è¢«å¿½ç•¥ã€‚è¿˜æ”¯æŒé€šé…ç¬¦&lt;code>**rest&lt;/code>ã€‚(ä½†æ˜¯&lt;code>**_&lt;/code>æ˜¯å¤šä½™çš„ï¼Œæ‰€ä»¥ä¸å…è®¸ã€‚)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¯ä»¥ä½¿ç”¨aså…³é”®å­—æ•è·å­æ¨¡å¼:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">case&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">Point&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">x1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y1&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">Point&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">x2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y2&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">p2&lt;/span>&lt;span class="p">):&lt;/span> &lt;span class="o">...&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>å¤§å¤šæ•°å­—é¢å€¼çš„æ¯”è¾ƒæ˜¯&lt;code>==&lt;/code>çš„ï¼Œä½†æ˜¯å•ä¾‹çš„&lt;code>True&lt;/code>ã€&lt;code>False&lt;/code>å’Œ&lt;code>None&lt;/code>æ˜¯é€šè¿‡&lt;code>id&lt;/code>è¿›è¡Œæ¯”è¾ƒçš„ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ¨¡å¼å¯ä»¥ä½¿ç”¨å‘½åçš„å¸¸é‡ã€‚è¿™äº›å¿…é¡»ç”¨ç‚¹å‘½åï¼Œä»¥é˜²æ­¢å®ƒä»¬è¢«è§£é‡Šä¸ºæ•è·å˜é‡:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="kn">from&lt;/span> &lt;span class="nn">enum&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">Enum&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">Color&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Enum&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">RED&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="n">GREEN&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="n">BLUE&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;span class="n">match&lt;/span> &lt;span class="n">color&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="n">Color&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">RED&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;I see red!&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="n">Color&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">GREEN&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Grass is green&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">case&lt;/span> &lt;span class="n">Color&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">BLUE&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;I&amp;#39;m feeling the blues :(&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;h2 id="åŸæ–‡æ¡£ç‰ˆæƒå£°æ˜">åŸæ–‡æ¡£ç‰ˆæƒå£°æ˜&lt;/h2>
&lt;p>This document is placed in the public domain or under the CC0-1.0-Universal license, whichever is more permissive.&lt;/p>
&lt;p>Source: &lt;a class="link" href="https://github.com/python/peps/blob/master/pep-0636.rst" target="_blank" rel="noopener"
>https://github.com/python/peps/blob/master/pep-0636.rst&lt;/a>&lt;/p></description></item><item><title>go çš„ defer è¯­å¥</title><link>https://nnnewb.github.io/blog/p/go-%E7%9A%84-defer-%E8%AF%AD%E5%8F%A5/</link><pubDate>Tue, 05 Jan 2021 10:01:48 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/go-%E7%9A%84-defer-%E8%AF%AD%E5%8F%A5/</guid><description>&lt;p>æ˜¨å¤©å¯¹é¡¹ç›®åšäº†ä¸ªå°é‡æ„ï¼Œä¸»è¦æ˜¯å¯¹ä»¥å‰æ‰‹å†™çš„ stmt.Close æ²¡å¤„ç†è¿”å›å€¼çš„é—®é¢˜ã€è¿˜æœ‰å„ç§è¯¥è®°å½•æ—¥å¿—çš„åœ°æ–¹æ²¡è®°æ—¥å¿—ç­‰ç­‰ï¼Œåšäº†ä¸‹å¤„ç†ã€‚&lt;/p>
&lt;p>è€å®è¯´è¿™äº‹å„¿åšç€åšç€è¿˜æœ‰ç§å¥‡å¦™çš„å¿«æ„Ÿï¼Œç±»ä¼¼äºçœ‹é«˜å‹æ°´æªæ¸…æ±¡è§†é¢‘çš„æ„Ÿè§‰ã€‚å“ˆå“ˆï¼Œä¹Ÿäºé¢†å¯¼ä¸ç®¡äº‹ï¼Œä»£ç ä¹Ÿä¸ Review ï¼Œæµ‹è¯•=æ‘†è®¾ã€‚&lt;/p>
&lt;p>è¿™ä¸ä¸€ä¸Šç­å°±å‘ç°å¥½å¤šé—®é¢˜ï¼Œå¹¸å¥½åªæ¨é€åˆ°å†…ç½‘ã€‚&lt;/p>
&lt;p>ç¬‘ä¸­å¸¦æ³ª.gif&lt;/p>
&lt;!-- more -->
&lt;h2 id="0x01-é—®é¢˜æè¿°">0x01 é—®é¢˜æè¿°&lt;/h2>
&lt;p>é—®é¢˜å€’æ˜¯æŒºç®€å•çš„ï¼Œçœ‹ä¸‹é¢çš„ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">stmt&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Prepare&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">query&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nf">SilentLogError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">stmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="s">&amp;#34;stmt close failed&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">row&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">stmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">QueryRow&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">params&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">row&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">row&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Scan&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">vars&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">vars&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>é‚£ä¹ˆï¼Œè¯·é—®ä¸Šé¢çš„ä»£ç æœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ&lt;/p>
&lt;p>æ ‡é¢˜éƒ½è¯´äº† defer äº†ï¼Œé‚£é—®é¢˜è‚¯å®šæ˜¯å‡ºåœ¨ defer è¿™ä¸€è¡Œä¸Šã€‚&lt;/p>
&lt;h2 id="0x02-defer-çš„æ±‚å€¼">0x02 defer çš„æ±‚å€¼&lt;/h2>
&lt;p>ç®€å•çš„ç»“è®ºå°±æ˜¯: &lt;em>defer f() çš„å‚æ•°åœ¨ defer è¿™ä¸€è¡Œæ±‚å€¼&lt;/em>&lt;/p>
&lt;p>å…·ä½“åˆ°ä¸Šé¢çš„ä¾‹å­ï¼Œ&lt;code>defer f(i())&lt;/code> è¿™æ ·çš„å½¢å¼ï¼Œå¯ä»¥å…ˆåˆ†æˆä¸‰ä¸ªéƒ¨åˆ†ã€‚&lt;/p>
&lt;ol>
&lt;li>&lt;code>defer&lt;/code> æœ¬èº«çš„æ‰§è¡Œæ—¶æœº&lt;/li>
&lt;li>&lt;code>i()&lt;/code> çš„æ±‚å€¼æ—¶æœº&lt;/li>
&lt;li>&lt;code>f()&lt;/code> çš„æ±‚å€¼æ—¶æœº&lt;/li>
&lt;/ol>
&lt;p>æŠŠè¿™ä¸‰éƒ¨åˆ†æ’ä¸€ä¸‹åº:&lt;/p>
&lt;ol>
&lt;li>&lt;code>i()&lt;/code>&lt;/li>
&lt;li>&lt;code>defer&lt;/code>
&lt;blockquote>
&lt;p>defer æŠŠå‚æ•°æ±‚å€¼ååŒ…è£…æˆä¸€ä¸ªæ–°å‡½æ•°å»¶è¿Ÿæ‰§è¡Œ&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;li>&lt;code>f()&lt;/code>&lt;/li>
&lt;/ol>
&lt;h2 id="0x03-å¾ªç¯å†…-defer">0x03 å¾ªç¯å†… defer&lt;/h2>
&lt;p>å¾ªç¯å†… defer ä¸»è¦æœ‰ä¸¤ä¸ªé—®é¢˜&lt;/p>
&lt;ol>
&lt;li>å¯èƒ½äº§ç”Ÿé€ æˆå·¨é‡çš„ defer å‡½æ•°ï¼Œè€—å°½å†…å­˜æˆ–æ‹–å®æ‰§è¡Œé€Ÿåº¦&lt;/li>
&lt;li>åœ¨ä¸€äº›æƒ…å†µä¸‹ä¼šé€ æˆæ„æ–™å¤–çš„ç»“æœ&lt;/li>
&lt;/ol>
&lt;p>çœ‹ä¾‹å­&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">Conn&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">ID&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewConn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">id&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Conn&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">Conn&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">ID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">id&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Conn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;close %d!\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ID&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">arr&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="nx">Conn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">arr&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">arr&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="nx">ID&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">i&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">conn&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">arr&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ€ç»ˆè¾“å‡ºæ˜¯&lt;/p>
&lt;pre>&lt;code>close 4!
close 4!
close 4!
close 4!
close 4!
&lt;/code>&lt;/pre>&lt;p>é€ æˆè¿™ä¸€ç»“æœçš„åŸå› æ˜¯æ¥æ”¶å™¨(receiver)ä¹Ÿä½œä¸ºå‡½æ•°å‚æ•°çš„ä¸€éƒ¨åˆ†åœ¨ defer æ—¶è¢«æ±‚å€¼ã€‚&lt;/p>
&lt;p>&lt;code>for _, conn := range arr&lt;/code> è¿™ä¸€è¡Œä»£ç ä¸­ï¼Œ&lt;code>conn&lt;/code> æœ¬è´¨æ˜¯ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œå…¶å†…å­˜åœ¨å¾ªç¯æœŸé—´å¯ä»¥è§†ä½œå›ºå®šçš„ï¼Œè€Œ&lt;code>func (c *Conn) Close() error&lt;/code> æ¥æ”¶å™¨å–äº†è¿™ä¸ªå±€éƒ¨å˜é‡çš„åœ°å€ï¼šæ¯ä¸€æ¬¡å¾ªç¯ï¼Œè°ƒç”¨ Close æ—¶ï¼Œå–å¾—çš„éƒ½æ˜¯åŒä¸€ä¸ªåœ°å€ã€‚æœ€ç»ˆå¯¼è‡´ Close çš„å…¨éƒ¨éƒ½æ˜¯ conn åœ¨å‡½æ•°ç»“æŸæ—¶æœ€åå¾—åˆ°çš„å€¼ã€‚&lt;/p>
&lt;p>ç±»ä¼¼çš„ï¼Œå¦‚æœæŠŠæ¥æ”¶å™¨ä»æŒ‡é’ˆæ”¹æˆå€¼å‘¢ï¼Ÿæ¥æ”¶å™¨å˜æˆäº†å€¼ä¼ é€’ï¼Œå°†&lt;code>conn&lt;/code>å¤åˆ¶ä¸€æ¬¡åä¿ç•™ä½œä¸º defer å‡½æ•°æ‰§è¡Œæ—¶çš„å‚æ•°ï¼Œå°±ä¼šæœ‰æ­£å¸¸çš„ç»“æœã€‚&lt;/p>
&lt;p>ä½†å¹¶ä¸æ˜¯è¯´å¾ªç¯å†… defer &lt;strong>ä¸€å®šæ˜¯&lt;/strong> ä¸å¥½çš„ã€‚&lt;/p>
&lt;p>æ¯”å¦‚ä¸€ä¸ªå¸¸è§çš„åœºæ™¯ï¼Œåœ¨å¾ªç¯é‡Œä½¿ç”¨ SQL æŸ¥è¯¢ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">for&lt;/span> &lt;span class="nx">query&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">queries&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">rows&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Query&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">query&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">rows&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥æ˜ç¡®çŸ¥é“ &lt;code>rows&lt;/code> æ˜¯æŒ‡é’ˆï¼Œè€Œä¸” &lt;code>rows.Close&lt;/code> æœ‰æŒ‡é’ˆæ¥æ”¶å™¨ï¼Œå°±å¯ä»¥ç¡®å®šä¸ä¼šæœ‰é—®é¢˜ã€‚&lt;/p>
&lt;h2 id="0x04-defer-å’Œé—­åŒ…">0x04 defer å’Œé—­åŒ…&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">Conn&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">ID&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewConn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">id&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Conn&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">Conn&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">ID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">id&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Conn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;close %d!\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ID&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">conn&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">Conn&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">}()&lt;/span>
&lt;span class="nx">conn&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">Conn&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">}()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å’Œä¸Šé¢ç±»ä¼¼ï¼Œè¿™æ¬¡è¾“å‡ºæ˜¯:&lt;/p>
&lt;pre>&lt;code>close 2!
close 2!
&lt;/code>&lt;/pre>&lt;p>é—®é¢˜å‡ºç°åœ¨ defer åé¢è¿™ä¸ªç”»è›‡æ·»è¶³çš„ &lt;code>func(){}()&lt;/code> ä¸Šã€‚ä¼—æ‰€å‘¨çŸ¥ defer ä¼šå¯¹å‚æ•°æ±‚å€¼ï¼Œä½†é—­åŒ…æ•è·çš„å˜é‡å¹¶ä¸ä¼šã€‚&lt;/p>
&lt;p>å› æ­¤ï¼Œå³ä½¿ &lt;code>defer conn.Close()&lt;/code> å·¥ä½œæ­£å¸¸ï¼Œä½† defer &lt;code>defer func() {conn.Close()}()&lt;/code> å°±ä¸ä¸€å®šäº†ã€‚ä¸¤è€…åœ¨éƒ¨åˆ†æƒ…å†µä¸‹å¹¶ä¸èƒ½ç­‰ä»·ä»£æ¢ï¼Œé™¤éä½ ç¡®ä¿¡äº†è§£è‡ªå·±åšäº†ä»€ä¹ˆã€‚&lt;/p>
&lt;p>å¦‚æœä¸€å®šè¦ç”¨ &lt;code>func(){}()&lt;/code> çš„å½¢å¼ï¼Œé‚£ä¹ˆ conn åªèƒ½é€šè¿‡å‚æ•°å½¢å¼ä¼ é€’ç»™è¿™ä¸ªåŒ¿åå‡½æ•°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">conn&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Conn&lt;/span>&lt;span class="p">){&lt;/span>
&lt;span class="nx">_&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}(&lt;/span>&lt;span class="nx">conn&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯¹ï¼Œè¯´çš„å°±æ˜¯çƒ¦äººçš„&lt;em>æœªå¤„ç†çš„é”™è¯¯&lt;/em>è­¦å‘Šã€‚&lt;/p>
&lt;h2 id="0x05-happy-hacking">0x05 Happy Hacking!&lt;/h2>
&lt;p>æƒ¯ä¾‹ï¼Œå®Œã€‚&lt;/p></description></item><item><title>åœ¨ slackware ä¸Šå®‰è£… neovim</title><link>https://nnnewb.github.io/blog/p/%E5%9C%A8-slackware-%E4%B8%8A%E5%AE%89%E8%A3%85-neovim/</link><pubDate>Mon, 04 Jan 2021 15:00:20 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/%E5%9C%A8-slackware-%E4%B8%8A%E5%AE%89%E8%A3%85-neovim/</guid><description>&lt;p>æœ€è¿‘åœ¨è™šæ‹Ÿæœºé‡ŒæŠ˜è…¾ slackware ï¼Œå‘ç° slackware 14.2 çš„ vim ç‰ˆæœ¬è¿˜åœç•™åœ¨ 7.4 ï¼Œäºæ˜¯è€ƒè™‘è¿˜æ˜¯è£…ä¸ª neovim ç®—äº†ã€‚æ¯•ç«Ÿå‡çº§ vim8 è¿˜å¾—è‡ªå·±å†™ SlackBuildï¼Œä¸‡ä¸€å’ŒåŸæœ¬çš„ vim 7.4 å†²çªå°±æ›´å¤´ç–¼äº†ã€‚&lt;/p>
&lt;!-- more -->
&lt;h2 id="0x01-ç¡®å®šä¾èµ–">0x01 ç¡®å®šä¾èµ–&lt;/h2>
&lt;p>åˆ°å¤„ç¿» slackbuild ä¹‹é—´ä¾èµ–å…³ç³»çš„æ—¶å€™å‘ç° sbopkg æä¾›äº†ä¸€ä¸ªè§£å†³ä¾èµ–çš„è„šæœ¬ï¼Œ&lt;code>sqg&lt;/code>ã€‚&lt;/p>
&lt;p>äºæ˜¯ç®€å•ç‚¹ï¼Œæ‹¿ &lt;code>sqg -p neovim&lt;/code> ç”Ÿæˆ neovim çš„å®‰è£…é˜Ÿåˆ— neovim.sqf æ–‡ä»¶ã€‚&lt;/p>
&lt;p>sqg å’Œ sbopkg ä¸€èµ·æä¾›äº†ï¼Œæ‰€ä»¥ä¸ç”¨å¦å¤–å®‰è£…ã€‚&lt;/p>
&lt;h2 id="0x02-å®‰è£…">0x02 å®‰è£…&lt;/h2>
&lt;p>ä¸€æ¡å‘½ä»¤ï¼š&lt;code>sudo sbopkg -i neovim.sqf&lt;/code>&lt;/p>
&lt;p>ç„¶åç­‰å®Œæˆå§ã€‚&lt;/p>
&lt;h2 id="0x03-å¯é€‰ä¾èµ–">0x03 å¯é€‰ä¾èµ–&lt;/h2>
&lt;p>ä¸Šè¿°æ­¥éª¤å®Œæˆåè¿˜åªæ˜¯è£…å¥½åŸºæœ¬çš„ neovim ï¼Œä½† python2/python3/ruby/nodejs æ”¯æŒéƒ½æ˜¯æ²¡æœ‰çš„ã€‚&lt;/p>
&lt;p>æ‰“å¼€ nvimï¼Œè¾“å…¥å‘½ä»¤ &lt;code>:checkhealth&lt;/code> åä¼šæ˜¾ç¤ºç¼ºå°‘æ”¯æŒï¼ŒåŒæ—¶ä¹Ÿæä¾›äº†è§£å†³åŠæ³•ï¼š&lt;code>pip install pynvim&lt;/code>ã€‚&lt;/p>
&lt;p>ç„¶åå°±æ˜¯å¦ä¸€ä¸ªå‘ï¼špip ä¹Ÿä¸åœ¨é»˜è®¤çš„ python2 åŒ…é‡Œã€‚äºæ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¿˜å¾—å…ˆè£…ä¸Š pip : &lt;code>sudo sbopkg -i python-pip&lt;/code>&lt;/p>
&lt;p>ç„¶åæ‰§è¡Œ &lt;code>sudo pip install pynvim&lt;/code>ï¼Œæ­¤æ—¶ python2 æ”¯æŒå·²ç»è£…å¥½ã€‚&lt;/p>
&lt;p>ä¸è¿‡ä¼—æ‰€å‘¨çŸ¥ python2 çš„ç”Ÿå‘½å‘¨æœŸå·²ç»ç»“æŸäº†ï¼Œpython3 æ‰æ˜¯æ­£é“ã€‚æ‰€ä»¥è¿˜å¾—è£…ä¸€ä¸‹ python3 : &lt;code>sudo sbopkg -i python3&lt;/code>&lt;/p>
&lt;p>slackbuild çš„ python3 åŒ…è‡ªå¸¦äº† pip æ‰€ä»¥ä¸€åˆ‡å®‰å¥½ã€‚å®Œæˆåç›´æ¥è£… pynvim å³å¯: &lt;code>sudo pip3 install pynvim&lt;/code>&lt;/p>
&lt;p>nodejs å’Œ ruby ä¸æ˜¯æˆ‘çš„å·¥ä½œè¯­è¨€å°±ä¸ç®¡äº†ã€‚&lt;/p>
&lt;h2 id="0x04-ä½¿ç”¨-vim-é…ç½®">0x04 ä½¿ç”¨ vim é…ç½®&lt;/h2>
&lt;p>å¦ä¸€ä¸ªé—®é¢˜æ˜¯æˆ‘çš„ vimrc é…ç½®æ˜¯é’ˆå¯¹ vim8 å†™çš„ï¼Œneovim ä¸è®¤ .vimrc å’Œ .vim ã€‚è¿™ä¸ªé—®é¢˜ç½‘ä¸Šæœ‰å¾ˆå¤šè§£å†³åŠæ³•ï¼Œæˆ‘å¤åˆ¶ç²˜è´´ä¸‹ã€‚&lt;/p>
&lt;blockquote>
&lt;p>Transitioning from Vim &lt;em>nvim-from-vim&lt;/em>&lt;/p>
&lt;ol>
&lt;li>
&lt;p>To start the transition, create your |init.vim| (user config) file:&lt;/p>
&lt;p>:call mkdir(stdpath(&amp;lsquo;config&amp;rsquo;), &amp;lsquo;p&amp;rsquo;)
:exe &amp;lsquo;edit &amp;lsquo;.stdpath(&amp;lsquo;config&amp;rsquo;).'/init.vim&amp;rsquo;&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Add these contents to the file:&lt;/p>
&lt;p>set runtimepath^=~/.vim runtimepath+=~/.vim/after
let &amp;amp;packpath = &amp;amp;runtimepath
source ~/.vimrc&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Restart Nvim, your existing Vim config will be loaded.&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/blockquote>
&lt;p>å®Œäº‹å³å¯è®¤å‡º vim é…ç½®ã€‚&lt;/p>
&lt;h2 id="0x05-happy-hacking-">0x05 Happy Hacking !&lt;/h2>
&lt;p>&lt;em>å®Œ&lt;/em>&lt;/p></description></item><item><title>slackware å’Œè™šæ‹ŸæœºåŸºæœ¬é…ç½®</title><link>https://nnnewb.github.io/blog/p/slackware-%E5%92%8C%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE/</link><pubDate>Wed, 30 Dec 2020 11:11:56 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/slackware-%E5%92%8C%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE/</guid><description>&lt;p>slackware æ˜¯ä¸€ä¸ªéå¸¸æœ‰æå®¢å‘³çš„ Linux å‘è¡Œç‰ˆï¼Œå› ä¸ºå®˜æ–¹ç»´æŠ¤çš„åŒ…ä¸å¤šï¼ŒåŸºæœ¬é  slackbuilds ç»­å‘½ã€‚&lt;/p>
&lt;p>slackware çš„ä¸€ä¸ªç‰¹è‰²æ˜¯åŒ…ç®¡ç†ç³»ç»Ÿä¸å¤„ç†ä¾èµ–å…³ç³»ï¼Œè¿™ä¸€ç‚¹åŠé€€ä¸å°‘äººã€‚&lt;/p>
&lt;p>å®é™…ä¸Šï¼Œè™½ç„¶æˆ‘ä¸æ˜¯å¾ˆèµåŒ &lt;a class="link" href="https://docs.slackware.com/start?id=slackware:package_and_dependency_management_shouldn_t_put_you_off_slackware" target="_blank" rel="noopener"
>è¿™ä¸ªè§‚ç‚¹&lt;/a> ï¼Œä¸è¿‡å¹¶ä¸å¦¨ç¢ slackware æˆä¸ºå¯ç©æ€§ç›¸å¯¹é«˜çš„ Linux å‘è¡Œç‰ˆä¹‹ä¸€ï¼ˆå¦å¤–å‡ ä¸ªå¯ç©æ€§ä¸é”™çš„å‘è¡Œç‰ˆåŒ…æ‹¬ Arch Linux å’Œ Gentooï¼‰ã€‚&lt;/p>
&lt;p>è¿™ç¯‡åšæ–‡å®é™…ä¸Šå°±æ˜¯å®‰åˆ©ä¸‹ slackware å¹¶ä¸”ç®€è¦ä»‹ç»ä¸‹æ€ä¹ˆåœ¨è™šæ‹Ÿæœºé‡Œæ­å»ºä¸ªåŸºæœ¬ç¯å¢ƒæ¥ä½“éªŒæ¸¸ç©ã€‚&lt;/p>
&lt;!-- more -->
&lt;h2 id="0x01-å®‰è£…">0x01 å®‰è£…&lt;/h2>
&lt;p>å®‰è£…çš„å‚è€ƒæ–‡æ¡£å¤ªå¤šäº†ï¼Œä¸ªäººè®¤ä¸ºä¸»è¦çš„éš¾ç‚¹åœ¨åˆ†åŒºå’Œå¼•å¯¼ã€‚æ¯•ç«Ÿä¸åƒå…¶ä»–æ›´æµè¡Œçš„å‘è¡Œç‰ˆçš„ GUI å®‰è£…å¼•å¯¼ï¼Œå¯¹ fdisk å’Œ parted è¿™äº›å·¥å…·ä¸ç†Ÿæ‚‰ã€å¯¹æ“ä½œç³»ç»Ÿå¼•å¯¼å¯åŠ¨çš„ä¸€äº›åŸºæœ¬æ¦‚å¿µã€åŸç†ä¸äº†è§£çš„äººå¾ˆå®¹æ˜“çŠ¯ä¸‹é”™è¯¯è€Œä¸è‡ªçŸ¥ã€‚&lt;/p>
&lt;p>è¿™é‡Œæä¾›ä¸€ç¯‡ä¹‹å‰åœ¨è´´å§å†™çš„ &lt;a class="link" href="https://tieba.baidu.com/p/4863103375" target="_blank" rel="noopener"
>å®‰è£…æ•™ç¨‹&lt;/a> ï¼Œä¸åšèµ˜è¿°äº†ã€‚&lt;/p>
&lt;h2 id="0x02-æ¡Œé¢">0x02 æ¡Œé¢&lt;/h2>
&lt;p>å¯¹ä¹ æƒ¯äº†è£…å®Œå°±æœ‰æ¡Œé¢çš„ç”¨æˆ·æ¥è¯´ï¼Œå®‰è£…å®Œ slackware ä¹‹åé‡åˆ°çš„ç¬¬ä¸€ä¸ªé—®é¢˜å°±æ˜¯æ€ä¹ˆè¿›å…¥æ¡Œé¢â€”â€”ç”šè‡³ä¼šé—®æ€ä¹ˆç™»é™†ã€‚&lt;/p>
&lt;p>è¿™é‡Œå°±æŒ‚ä¸€å¼  gif å¥½äº†ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/slackware-vm-setup/01.gif" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/slackware-vm-setup/01.gif"
loading="lazy"
alt="01">
&lt;/a>
&lt;figcaption>01&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å‡è®¾æ²¡æ‰‹è´±åœ¨å®‰è£…çš„æ—¶å€™æŠŠ x/kde/xfce ä¹‹ç±»çš„è½¯ä»¶åŒ…ç»„ç»™å»æ‰çš„è¯ï¼Œå°±ä¸ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ã€‚&lt;/p>
&lt;p>å¦‚æœéœ€è¦è‡ªåŠ¨è¿›å…¥æ¡Œé¢ï¼Œéœ€è¦æ‰‹åŠ¨ä¿®æ”¹ &lt;code>/etc/inittab&lt;/code> æ–‡ä»¶ï¼ŒæŠŠé»˜è®¤çš„ runlevel ä¿®æ”¹ä¸º 4 ã€‚&lt;/p>
&lt;p>å…·ä½“æ€ä¹ˆæ”¹ï¼Œçœ‹ gif ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/slackware-vm-setup/02.gif" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/slackware-vm-setup/02.gif"
loading="lazy"
alt="02">
&lt;/a>
&lt;figcaption>02&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;h2 id="0x03-slackpkg-åŒ…ç®¡ç†">0x03 slackpkg åŒ…ç®¡ç†&lt;/h2>
&lt;p>å¦‚æœç”¨è¿‡ ubuntu ï¼Œé‚£ä¹ˆä¸‹ä¸€ä¸ªé—®é¢˜å¯èƒ½å°±æ˜¯ &amp;ldquo;æ€ä¹ˆæ²¡æœ‰ apt-get å‘½ä»¤ï¼Ÿ&amp;rdquo; æˆ–è€… &amp;ldquo;slackware ç”¨ä»€ä¹ˆå‘½ä»¤å®‰è£…è½¯ä»¶ï¼Ÿ&amp;rdquo;&lt;/p>
&lt;p>ç­”æ¡ˆæ˜¯æœ‰å¥½å‡ ä¸ªç›¸å…³å‘½ä»¤ã€‚&lt;/p>
&lt;ul>
&lt;li>installpkg&lt;/li>
&lt;li>removepkg&lt;/li>
&lt;li>upgradepkg&lt;/li>
&lt;li>makepkg&lt;/li>
&lt;li>explodepkg&lt;/li>
&lt;li>rpm2targz&lt;/li>
&lt;/ul>
&lt;p>å¤§éƒ¨åˆ†å‘½ä»¤é¡¾åæ€ä¹‰ï¼Œä¹Ÿä¸éœ€è¦é¢å¤–è¯´æ˜ã€‚å¦‚æœè¯´å’Œ apt æˆ–è€… pacman ç±»ä¼¼çš„ä¸€ä¸ªç»Ÿä¸€çš„åŒ…ç®¡ç†å™¨çš„è¯ï¼Œé‚£å°±æ˜¯ slackpkg ã€‚&lt;/p>
&lt;p>ä½¿ç”¨ slackpkg ä¹‹å‰ï¼Œéœ€è¦æ‰‹åŠ¨ä¿®æ”¹ /etc/slackpkg/mirrors æ–‡ä»¶ï¼Œé€‰æ‹©ä¸€ä¸ªç½‘ç»œçŠ¶å†µæ¯”è¾ƒå¥½çš„è½¯ä»¶æºåœ°å€ï¼ŒæŠŠè¡Œå¼€å¤´çš„ # å·å»æ‰ã€‚&lt;/p>
&lt;p>å®Œäº‹ä¹‹åç”¨å‘½ä»¤ &lt;code>slackpkg update&lt;/code> æ›´æ–°ä¸€ä¸‹æœ¬åœ°ç´¢å¼•ï¼Œå°±å¯ä»¥æ­£å¸¸ç”¨äº†ã€‚&lt;/p>
&lt;p>å¸¸ç”¨çš„å‘½ä»¤åŒ…æ‹¬&lt;/p>
&lt;ul>
&lt;li>slackpkg search&lt;/li>
&lt;li>slackpkg file-search&lt;/li>
&lt;li>slackpkg install&lt;/li>
&lt;li>slackpkg install-new&lt;/li>
&lt;li>slackpkg upgrade&lt;/li>
&lt;li>slackpkg upgrade-all&lt;/li>
&lt;/ul>
&lt;p>å…·ä½“ä¸ç»†è¯´äº†ï¼Œçœ‹å‚è€ƒé“¾æ¥ï¼Œæˆ–è€…è‡ªå·±çœ‹çœ‹ &lt;code>man slackpkg&lt;/code> æˆ–è€… &lt;code>slackpkg help&lt;/code>&lt;/p>
&lt;p>æ­¤å¤–è¿˜æœ‰ä¸ªä¸å¸¸ç”¨çš„ï¼Œå’Œå®‰è£…æ—¶çš„ &lt;code>setup&lt;/code> é£æ ¼æ¯”è¾ƒç±»ä¼¼çš„å·¥å…·ï¼Œ&lt;code>pkgtool&lt;/code>ã€‚å…·ä½“å¯ä»¥è‡ªå·±çœ‹çœ‹å‘½ä»¤ã€‚&lt;/p>
&lt;h2 id="0x04-slackbuilds">0x04 SlackBuilds&lt;/h2>
&lt;p>ç”¨è¿‡ Arch Linux çš„ AUR çš„ç”¨æˆ·å¯¹è¿™ç§ç¬¬ä¸‰æ–¹ç»´æŠ¤çš„è½¯ä»¶åŒ…ä¼šæ¯”è¾ƒç†Ÿæ‚‰ï¼Œ SlackBuilds å¯¹è¿™äº›ç”¨æˆ·æ¥è¯´å°±æ˜¯å¦ä¸€ä¸ª AUR è€Œå·²ã€‚&lt;/p>
&lt;p>ä¸åŒä¹‹å¤„åœ¨äºï¼ŒSlackBuilds éœ€è¦æ‰‹åŠ¨ä¸‹è½½è„šæœ¬å’Œæºç ï¼Œç„¶åè‡ªå·±çœ‹ README å†è¿è¡Œç¼–è¯‘ã€‚&lt;/p>
&lt;p>å½“ç„¶è¿™ä¸æ˜¯è¯´ SlackBuilds æ²¡æœ‰ç±»ä¼¼ yaourt æˆ–è€… yay ä¹‹ç±»çš„è‡ªåŠ¨å·¥å…·ï¼Œä½ å¯ä»¥è¯•è¯• sbopkg ã€‚&lt;/p>
&lt;p>è¿™é‡Œç»™ä¸ªç®€å•çš„ä¾‹å­ï¼Œç”¨ sbopkg å®‰è£… fbterm ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/slackware-vm-setup/03.gif" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/slackware-vm-setup/03.gif"
loading="lazy"
alt="03.gif">
&lt;/a>
&lt;figcaption>03.gif&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;h2 id="0x05-ç¼–å†™-slackbuilds">0x05 ç¼–å†™ SlackBuilds&lt;/h2>
&lt;p>è®²é“ç†ï¼Œslackware å¸¸ç”¨çš„è½¯ä»¶å¤ªå°‘ï¼ŒåŸºæœ¬å…¨é  slackbuilds æ’‘åœºé¢ã€‚å¦‚æœ SlackBuilds ä¸Šä¹Ÿæ²¡æœ‰å‘¢ï¼Ÿ&lt;/p>
&lt;p>é‚£åªèƒ½è‡ªå·±å†™å§ã€‚&lt;/p>
&lt;p>å¯¹äºç†Ÿæ‚‰ bash è„šæœ¬çš„ç”¨æˆ·æ¥è¯´è¿™ä¸æ˜¯ä»€ä¹ˆéš¾äº‹ã€‚è¿™ç¯‡ &lt;a class="link" href="https://slackwiki.com/Writing_A_SlackBuild_Script" target="_blank" rel="noopener"
>HOWTO æ–‡ç« &lt;/a> å¾ˆå¥½åœ°è¯´æ˜äº†æ€ä¹ˆå†™ä¸€ä¸ª SlackBuilds è„šæœ¬ã€‚&lt;/p>
&lt;h2 id="0x06-å‚ä¸ç¤¾åŒº">0x06 å‚ä¸ç¤¾åŒº&lt;/h2>
&lt;p>slackware ä¸­æ–‡ç¤¾åŒºå¤ªå°äº†ï¼Œæˆ–è€…è¯´æ ¹æœ¬ä¸å­˜åœ¨ã€‚&lt;/p>
&lt;p>èƒ½èŠå‡ å¥çš„åŸºæœ¬åªæœ‰è´´å§ï¼ˆå®é™…ä¸Šç°åœ¨ä¹Ÿæ‰¾ä¸åˆ°äººäº†ï¼‰æˆ–è€… GitHub ä¸Šï¼ˆslackwarecn ç¤¾åŒºä¹Ÿä¸æ´»è·ƒï¼‰ã€‚&lt;/p>
&lt;p>å¦‚æœå¯¹ slackware æ„Ÿå…´è¶£ï¼Œå¯ä»¥ç©ä¸€ç©ï¼Œå†™å‡ ä¸ªå¸¸ç”¨è½¯ä»¶çš„ SlackBuilds è„šæœ¬ä»€ä¹ˆçš„ã€‚&lt;/p>
&lt;p>å°±è¿™æ ·å§ã€‚&lt;/p></description></item><item><title>ä¸€ä¸ªå®‰å“åº”ç”¨çš„é€†å‘åˆ†æ</title><link>https://nnnewb.github.io/blog/p/%E4%B8%80%E4%B8%AA%E5%AE%89%E5%8D%93%E5%BA%94%E7%94%A8%E7%9A%84%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/</link><pubDate>Tue, 29 Dec 2020 14:04:02 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/%E4%B8%80%E4%B8%AA%E5%AE%89%E5%8D%93%E5%BA%94%E7%94%A8%E7%9A%84%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/</guid><description>&lt;p>è¯´èµ·æ¥ä¹Ÿä¸ç®—ä»€ä¹ˆæ–°é²œçš„ä¸œè¥¿ï¼Œç°æˆçš„å·¥å…·æ‹¼æ‹¼å‡‘å‡‘å°±æå®šäº†ï¼Œå•çº¯ç®—æ˜¯ç‚¹äº®äº†æ–°çš„æŠ€èƒ½ã€‚&lt;/p>
&lt;p>å¾…ç ´è§£åº”ç”¨çš„åå­—ä¸é€éœ²äº†ï¼Œé¿å…å¼•ç«çƒ§èº«ã€‚&lt;/p>
&lt;p>éœ€è¦å‡†å¤‡çš„å·¥å…·åŒ…æ‹¬&lt;/p>
&lt;ul>
&lt;li>mumu æ¨¡æ‹Ÿå™¨(æˆ–è€…åˆ«çš„ä»€ä¹ˆæœ‰ root æƒé™ã€èƒ½è£… xposed çš„æ¨¡æ‹Ÿå™¨)&lt;/li>
&lt;li>FDex2 è„±å£³&lt;/li>
&lt;li>jadx åç¼–è¯‘ dex æºç &lt;/li>
&lt;li>apktools æ‹†è§£ apk&lt;/li>
&lt;li>mitmproxy ä¸­é—´äººæ‹¦æˆªç½‘ç»œè¯·æ±‚&lt;/li>
&lt;/ul>
&lt;!-- more -->
&lt;h2 id="0x01-ç›®æ ‡å’Œæ–¹å‘é€‰æ‹©">0x01 ç›®æ ‡å’Œæ–¹å‘é€‰æ‹©&lt;/h2>
&lt;p>é¦–è¦çš„ç›®æ ‡æ˜¯ç ´è§£è¿™ä¸ªè½¯ä»¶çš„ api åŠ å¯†ã€‚&lt;/p>
&lt;p>ä½¿ç”¨ mitmproxy æŠ“åˆ° https æµé‡ï¼Œå‘ç°è¯·æ±‚ä½“å…¨éƒ¨æ˜¯ base64 ï¼Œè§£ç å‘ç°ä¹±ç ã€‚åŸºæœ¬æ–­å®šæ˜¯åŠ å¯†äº†ã€‚&lt;/p>
&lt;blockquote>
&lt;p>mitmproxy æ€ä¹ˆæŠ“ https æµé‡ä¸å¤šè¯´äº†ï¼ŒåŸºæœ¬æµç¨‹å°±æ˜¯è£…è¯ä¹¦ï¼Œç„¶åé…ç½®ä»£ç†ã€‚èƒ½çœ‹åˆ°æœ‰æµé‡è¿› mitmproxy å°±ç®—æˆåŠŸäº†ã€‚&lt;/p>
&lt;p>ç›´æ¥å‚è€ƒ mitmproxy çš„æ–‡æ¡£å¿«ä¸€ç‚¹ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/01.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/01.png"
loading="lazy"
alt="01">
&lt;/a>
&lt;figcaption>01&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æœäº†ä¸€åœˆæ²¡æœ‰ä»€ä¹ˆç°æˆçš„å¯¹è¿™ä¸ª App çš„ç ´è§£çš„æ–‡ç« ï¼Œäºæ˜¯å†³å®šè‡ªå·±åŠ¨æ‰‹ã€‚&lt;/p>
&lt;h2 id="0x02-è§£åŒ…å’Œè„±å£³">0x02 è§£åŒ…å’Œè„±å£³&lt;/h2>
&lt;p>å…ˆç¡®è®¤ä¸‹ç”µè„‘ä¸Šè£…äº† JDK æˆ–è€… JRE ï¼Œæ²¡æœ‰çš„è¯å°±è£…å¥½ã€‚&lt;/p>
&lt;p>æ¨èä¸€ä¸ª vscode çš„æ’ä»¶ï¼Œ&lt;code>apklab&lt;/code>ã€‚ä¼šå¸®ä½ è£…å¥½ jadx å’Œ apktools / signer è¿™äº›å·¥å…·ã€‚&lt;/p>
&lt;p>æ¥ä¸‹æ¥ç›´æ¥ç”¨ &lt;code>apklab&lt;/code> æ‰“å¼€éœ€è¦ç ´è§£çš„ apk æ–‡ä»¶ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/02.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/02.png"
loading="lazy"
alt="02">
&lt;/a>
&lt;figcaption>02&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/03.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/03.png"
loading="lazy"
alt="03">
&lt;/a>
&lt;figcaption>03&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/04.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/04.png"
loading="lazy"
alt="04">
&lt;/a>
&lt;figcaption>04&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>apklab ä¼šè‡ªåŠ¨ç”¨ apktools å’Œ jadx å®Œæˆæ‹†åŒ…å’Œåç¼–è¯‘ã€‚&lt;/p>
&lt;p>ç„¶åç®€å•è§‚å¯Ÿ&amp;hellip;&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/05.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/05.png"
loading="lazy"
alt="05">
&lt;/a>
&lt;figcaption>05&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>åº”è¯¥æ˜¯è¢« 360 åŠ å›ºäº†ã€‚&lt;/p>
&lt;p>apk åŠ å›ºçš„åŸºæœ¬åŸç†å°±æ˜¯æŠŠæ˜“è¢«åç¼–è¯‘çš„ java å­—èŠ‚ç è½¬è¯‘æˆ–è€…åŠ å¯†åä¿å­˜ï¼Œè¿è¡Œçš„æ—¶å€™å†é‡Šæ”¾å‡ºæ¥ã€‚ç”¨è¿‡ upx ä¸€ç±»çš„è½¯ä»¶åº”è¯¥ä¼šè”æƒ³åˆ°ï¼Œå°±æ˜¯åŠ å£³ã€åè°ƒè¯•ä»€ä¹ˆçš„è¿™ä¸€å¥—ã€‚&lt;/p>
&lt;p>xposed æä¾›äº†ä¸€ä¸ª&lt;a class="link" href="https://api.xposed.info/reference/de/robv/android/xposed/IXposedHookLoadPackage.html" target="_blank" rel="noopener"
>åœ¨å®‰å“åŒ…åŠ è½½æ—¶è®¾ç½®é’©å­çš„æœºä¼š&lt;/a>ï¼Œå°† ClassLoader Hook æ‰ï¼Œä»¥æ­¤è·å¾—çœŸæ­£çš„åº”ç”¨å­—èŠ‚ç ã€‚&lt;/p>
&lt;p>ä»£ç çœ‹å‚è€ƒèµ„æ–™ã€‚&lt;/p>
&lt;p>å®‰è£… xposed æ¡†æ¶å’Œ FDex2 ä¹‹åå¯åŠ¨ç›®æ ‡åº”ç”¨ï¼Œå³å¯è·å¾—å¯¹åº”çš„å­—èŠ‚ç  dex æ–‡ä»¶ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/06.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/06.png"
loading="lazy"
alt="06">
&lt;/a>
&lt;figcaption>06&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/07.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/07.png"
loading="lazy"
alt="07">
&lt;/a>
&lt;figcaption>07&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æ¥ç€æŠŠè¿™äº› dex æ–‡ä»¶å¤åˆ¶å‡ºæ¥ï¼Œå³å¯ä½¿ç”¨ jadx åç¼–è¯‘åˆ° java äº†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">jadx -d out *.dex
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å°†åç¼–è¯‘çš„ç»“æœç”¨ vscode æ‰“å¼€ï¼Œå¯ä»¥çœ‹åˆ°ç›®æ ‡å·²ç»è¢«æˆ‘ä»¬è„±å¹²å‡€äº†ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/08.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/08.png"
loading="lazy"
alt="08">
&lt;/a>
&lt;figcaption>08&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;h2 id="0x03-å¯»æ‰¾åŠ è§£å¯†ä»£ç ">0x03 å¯»æ‰¾åŠ è§£å¯†ä»£ç &lt;/h2>
&lt;p>ç›®æ ‡æ˜¯è§£å¯† Api è¯·æ±‚çš„å†…å®¹ï¼Œæ‰€ä»¥ä¸‹ä¸€æ­¥å°±æ˜¯æ‰¾åˆ°å“ªé‡Œä¿å­˜äº†åŠ å¯†ä»£ç ã€‚&lt;/p>
&lt;p>å¹¸è¿çš„æ˜¯è¿™ä¸ª App æ²¡æœ‰åšè¿‡æ··æ·†ï¼Œå®Œæˆè„±å£³åå°±å·²ç»æ˜¯å…¨èº«èµ¤è£¸çš„ç«™åœ¨æˆ‘ä»¬é¢å‰äº†ã€‚&lt;/p>
&lt;p>ç›´æ¥åœ¨ä»£ç é‡Œæœç´¢ä¹‹å‰æˆ‘ä»¬è§‚å¯Ÿåˆ°çš„ urlï¼š&lt;code>index_des.php&lt;/code>ï¼Œä»…æœ‰ä¸€ä¸ªç»“æœã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/09.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/09.png"
loading="lazy"
alt="09">
&lt;/a>
&lt;figcaption>09&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>ç›¸å…³å‡½æ•°éå¸¸çŸ­ï¼Œè¿™ä¸ª HTTP æ¡†æ¶æˆ‘æ²¡æœ‰ä½¿ç”¨è¿‡ï¼Œä¸è¿‡ä»å‡½æ•°åçœ‹åº”è¯¥æ˜¯ä¸€ä¸ªä¸­é—´ä»¶æ¨¡å¼ï¼Œå¯¹æ‰€æœ‰ Web è¯·æ±‚è¿›è¡ŒåŠ å¯†å¤„ç†ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/10.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/10.png"
loading="lazy"
alt="10">
&lt;/a>
&lt;figcaption>10&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>&lt;code>getOverPost2&lt;/code> æºç å¦‚ä¸‹&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/11.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/11.png"
loading="lazy"
alt="11">
&lt;/a>
&lt;figcaption>11&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>ä»ä»£ç é‡Œå¯ä»¥å¾—å‡ºï¼š&lt;/p>
&lt;ul>
&lt;li>g çš„å«ä¹‰æ˜¯ Get è¯·æ±‚çš„å‚æ•°ï¼Œåº”è¯¥å°±æ˜¯ QueryStringã€‚å‡½æ•°å &lt;code>getOverPost2&lt;/code> å­—é¢æ„ä¹‰å°±æ˜¯æŠŠ GET è¯·æ±‚ä»¥ POST æ–¹å¼å‘é€å‡ºå»ã€‚&lt;/li>
&lt;li>p çš„å«ä¹‰å¤§æ¦‚å°±æ˜¯ Post çš„å‚æ•°äº†ã€‚&lt;/li>
&lt;li>åŠ å¯†ä»£ç åœ¨ &lt;code>encryptByte&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>å¦‚æ­¤çœ‹æ¥å·²ç»æ¥è¿‘ç»ˆç‚¹äº†ï¼Œå†ç‚¹å¼€ &lt;code>encryptByte&lt;/code> çš„å®šä¹‰&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/12.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/12.png"
loading="lazy"
alt="12">
&lt;/a>
&lt;figcaption>12&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å¯†é’¥ä¿å­˜åœ¨ &lt;code>DesLib.sharedInstance().getAuthKey()&lt;/code> ä¸­ã€‚&lt;/p>
&lt;p>æ¥ç€ç‚¹å¼€ &lt;code>getAuthKey&lt;/code> çš„å®šä¹‰:&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/13.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/13.png"
loading="lazy"
alt="13">
&lt;/a>
&lt;figcaption>13&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>&lt;code>native&lt;/code> å…³é”®å­—ä¸€å‡ºï¼Œå¾—ï¼Œç™½é«˜å…´äº†ã€‚å·®ç‚¹åŠé€€æˆåŠŸã€‚&lt;/p>
&lt;p>è¿˜æ˜¯å…ˆçœ‹ä¸‹æ€ä¹ˆåŠ å¯†çš„ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/14.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/14.png"
loading="lazy"
alt="14">
&lt;/a>
&lt;figcaption>14&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å†å¾€å›ç¿»ä¸€ä¸‹å“åº”è§£å¯†çš„ä»£ç ï¼Œå…å¾—æ‹†é™¤å¯†é’¥æ¥åˆç™½é«˜å…´ä¸€åœºã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/15.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/15.png"
loading="lazy"
alt="15">
&lt;/a>
&lt;figcaption>15&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/16.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/16.png"
loading="lazy"
alt="16">
&lt;/a>
&lt;figcaption>16&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å¾ˆå¥½ï¼Œä¹Ÿæ˜¯ DES ã€‚&lt;/p>
&lt;p>å…¶å®åˆ°è¿™ä¸€æ­¥å·²ç»åŸºæœ¬å®Œæˆè§£å¯†äº†ï¼Œå”¯ä¸€æ¬ ç¼ºçš„å°±æ˜¯å¯†é’¥ã€‚&lt;/p>
&lt;p>æŠ±ç€è¯•ä¸€è¯•çš„å¿ƒæƒ…ï¼Œè¿˜æ˜¯æ‰¾åˆ°äº† &lt;code>libencry.so&lt;/code> ï¼Œç”¨ IDA æ‰“å¼€åˆ†æäº†ä¸€ä¸‹ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/17.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/17.png"
loading="lazy"
alt="17">
&lt;/a>
&lt;figcaption>17&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>ä¸€é€šæ“ä½œçŒ›å¦‚è™ï¼Œç»“æœå‘ç°çœ‹ä¸æ‡‚æ±‡ç¼–ã€‚=w=&lt;/p>
&lt;p>æŒ‰ä¸‹ F5ï¼Œçœ‹çœ‹ä¼ªä»£ç ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/18.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/18.png"
loading="lazy"
alt="18">
&lt;/a>
&lt;figcaption>18&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>è¿˜æ˜¯çœ‹ä¸æ‡‚ã€‚è¿™éƒ½è°ƒçš„ä»€ä¹ˆå‡½æ•°&amp;hellip; &lt;code>a1 + 668&lt;/code> è¿™ä¸ªèœœæ±åç§»ä¹Ÿä¸çŸ¥é“æ˜¯åœ¨ç®—ä»€ä¹ˆã€‚&lt;/p>
&lt;p>ç½‘ä¸Šæœç´¢äº†ä¸€åœˆï¼Œè¯´é“å¯ä»¥æ‰‹åŠ¨æ”¹ä¸€ä¸‹å‡½æ•°ç­¾åï¼ŒIDA å°±èƒ½æç¤ºå‡ºå‡½æ•°äº†ã€‚è¯•è¯•çœ‹ã€‚&lt;/p>
&lt;p>å…ˆæŠŠå‡½æ•°ç­¾åçº æ­£&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/19.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/19.png"
loading="lazy"
alt="19">
&lt;/a>
&lt;figcaption>19&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/20.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/20.png"
loading="lazy"
alt="20">
&lt;/a>
&lt;figcaption>20&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å†å…³æ‰ç±»å‹è½¬æ¢&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/21.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/21.png"
loading="lazy"
alt="21">
&lt;/a>
&lt;figcaption>21&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æœ€ç»ˆå…³é”®ä»£ç æ¸…æ™°äº†å¾ˆå¤šï¼Œçœ‹èµ·æ¥å°±æ˜¯ä¸ªç›´æ¥è¿”å›å­—ç¬¦ä¸²å¸¸é‡çš„å‡½æ•°ã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/22.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/22.png"
loading="lazy"
alt="22">
&lt;/a>
&lt;figcaption>22&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æ¯”è¾ƒå…·æœ‰è¿·æƒ‘æ€§çš„æ˜¯ä¸Šé¢çš„ v5-v9ï¼Œå¯ä»¥çœ‹åˆ° v5-v9 åœ°å€æ˜¯å¢é•¿ã€è¿ç»­çš„ï¼Œåªæœ‰ v5 å’Œ v6 æœ‰å€¼ã€‚v7/v8/v9 éƒ½æ˜¯ 0 ã€‚è€Œ v5 çš„åœ°å€è¢«ç”¨ä½œ &lt;code>NewStringUTF&lt;/code> å‡½æ•°çš„å‚æ•°ã€‚æŸ¥é˜… JNI æ¥å£ä¹Ÿå¯ä»¥çœ‹åˆ°è¿™ä¸ªå‚æ•°åº”è¯¥æ˜¯ &lt;code>const char*&lt;/code> ç±»å‹ã€‚&lt;/p>
&lt;p>æ‰€ä»¥ &amp;hellip;&lt;/p>
&lt;p>æŠŠæ•°å€¼è½¬æ¢æˆ 16 è¿›åˆ¶å†åšè§‚å¯Ÿã€‚&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/23.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/23.png"
loading="lazy"
alt="23">
&lt;/a>
&lt;figcaption>23&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>å‘ç°å¾ˆæœ‰è§„å¾‹ï¼Œæ¯ä¸ªå­—èŠ‚çš„å€¼éƒ½åœ¨ ASCII èŒƒå›´å†…ã€‚äºæ˜¯å³é”®è½¬æ¢æˆå­—ç¬¦ä¸²ï¼Œå†æŒ‰å­—èŠ‚åºç¿»è½¬ä¸€ä¸‹ï¼Œå³å¯å¾—åˆ°å¯†é’¥ã€‚&lt;/p>
&lt;p>åˆ°æ­¤ï¼Œè§£å¯†æ–¹æ³•çš„æ¢ç´¢å·²ç»å®Œæˆã€‚&lt;/p>
&lt;h2 id="0x04-mitmproxy-è§£å¯†">0x04 mitmproxy è§£å¯†&lt;/h2>
&lt;p>mitmproxy æ”¯æŒä½¿ç”¨ python è„šæœ¬æ‰©å±•ï¼Œç”¨æ³•å¾ˆç®€å•å°±æ˜¯ &lt;code>mitmweb.exe -s decrypt.py&lt;/code>&lt;/p>
&lt;p>å¯ä»¥å‚è€ƒ mitmproxy çš„&lt;a class="link" href="https://github.com/mitmproxy/mitmproxy/blob/master/examples/addons/contentview.py" target="_blank" rel="noopener"
>ä¾‹å­&lt;/a>&lt;/p>
&lt;p>æœ€ç»ˆæ•ˆæœåº”è¯¥æ˜¯è¿™æ ·&lt;/p>
&lt;p>&lt;figure
>
&lt;a href="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/25.png" >
&lt;img src="https://nnnewb.github.io/blog/blog/image/Just-crack-an-android-app/25.png"
loading="lazy"
alt="24">
&lt;/a>
&lt;figcaption>24&lt;/figcaption>
&lt;/figure>&lt;/p>
&lt;p>æ ¸å¿ƒçš„è§£å¯†ä»£ç å°±ä¸€å¥ï¼Œåˆ©ç”¨ mitmproxy çš„æ‰©å±•å³å¯å¯¹æ¯ä¸ªè¯·æ±‚è¿›è¡Œç»Ÿä¸€çš„å¤„ç†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="kn">from&lt;/span> &lt;span class="nn">pyDes&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">des&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PAD_PKCS5&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">decrypt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">Union&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nb">str&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">bytes&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="nb">bytes&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">des&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">decrypt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">padmode&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">PAD_PKCS5&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="0x05-ç»“è¯­">0x05 ç»“è¯­&lt;/h2>
&lt;p>è¿™ä¸ªç ´è§£çš„æœ€å¤§æ„ä¹‰è¿˜æ˜¯å®Œæˆäº†ä¸€æ¬¡å®Œæ•´çš„å®‰å“é€†å‘ï¼Œç®—æ˜¯ç‚¹äº®äº†æ–°æŠ€èƒ½ã€‚&lt;/p>
&lt;p>ä»¥åå†é‡åˆ°ä¸€äº›å‚»é€¼è½¯ä»¶æˆ–è€…å¼ºåˆ¶æ¨å¹¿çš„ä¸œè¥¿å°±å¯ä»¥ç”¨è¿™ä¸€æ‰‹æŠ€èƒ½æ¥ç ”ç©¶åæ§½ä¸‹éƒ½ä»€ä¹ˆå‚»é€¼ä»£ç äº†ã€‚&lt;/p>
&lt;p>å½“ç„¶éæ³•çš„äº‹æƒ…æ˜¯ä¸å¯èƒ½åšçš„ã€‚&lt;/p>
&lt;p>è¿™ç©æ„å„¿ç ´è§£å®Œä¹‹åå‘ç°æœ‰æ³„éœ²éšç§ã€è¢«è„±è£¤çš„ä¸¥é‡æ¼æ´ï¼Œæˆ‘ä¹Ÿç»™å¸‚æ”¿å¹³å°å‘äº†ä»¶ã€‚&lt;/p>
&lt;p>æ‰€ä»¥æ˜å¹´å¦‚æœå†ç¡¬æ¨ä¸€æ¬¡çš„è¯ï¼Œåˆ°æ—¶å€™å†æ‹†äº†çœ‹çœ‹æ˜¯ä¸æ˜¯æœ‰ç‚¹é•¿è¿›ã€‚å½“ç„¶ï¼Œæ²¡äººç®¡åº”è¯¥æ‰æ˜¯å¸¸æ€ã€‚&lt;/p></description></item><item><title>åœ¨C++ä¸­åµŒå…¥Pythonè§£é‡Šå™¨</title><link>https://nnnewb.github.io/blog/p/%E5%9C%A8c-%E4%B8%AD%E5%B5%8C%E5%85%A5python%E8%A7%A3%E9%87%8A%E5%99%A8/</link><pubDate>Fri, 07 Feb 2020 21:59:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/%E5%9C%A8c-%E4%B8%AD%E5%B5%8C%E5%85%A5python%E8%A7%A3%E9%87%8A%E5%99%A8/</guid><description>&lt;p>å…ˆä¸è¯´åºŸè¯ï¼Œé¡¹ç›®åœ°å€ï¼šhttps://github.com/nnnewb/CQPy ã€‚æ¬¢è¿ç»™ä¸ª Star ä»€ä¹ˆçš„ã€‚&lt;/p>
&lt;h2 id="èƒŒæ™¯">èƒŒæ™¯&lt;/h2>
&lt;p>æƒ³ç»™æœ€è¿‘åœ¨ç©çš„é…· Q å†™ä¸ªæ’ä»¶ï¼Œå‘ç°æ²¡æœ‰åˆé€‚çš„ç›´æ¥ä½¿ç”¨ Python çš„è§£å†³æ–¹æ¡ˆã€‚&lt;/p>
&lt;p>Richard Chien æä¾›äº†ä¸€ä¸ªæ¯”è¾ƒé€šç”¨çš„æ’ä»¶ï¼Œ&lt;code>CQHttp&lt;/code>ã€‚&lt;code>CQHttp&lt;/code>æœ¬ä½“æ˜¯ç”¨ C++ ç¼–å†™çš„æ’ä»¶ï¼Œå°†é…· Q çš„å›è°ƒåŒ…è£…æˆ HTTP è¯·æ±‚è½¬å‘è‡³æŒ‡å®šçš„åœ°å€ï¼Œæ”¯æŒ&lt;code>http&lt;/code>å’Œ&lt;code>websocket&lt;/code>ä¸¤ç§åè®®ã€‚&lt;/p>
&lt;p>ä¸è¿‡ç”±äºä¸ªäººæƒ³æŠ˜è…¾æŠ˜è…¾çš„æƒ³æ³•ï¼Œæ‰“ç®—è¯•è¯•æŠŠ Python è§£é‡Šå™¨ç›´æ¥åµŒå…¥åˆ° C++ é‡Œå¾—äº†ã€‚&lt;/p>
&lt;!-- more -->
&lt;p>æ•´ä¸ªæ€è·¯å¦‚ä¸‹ã€‚&lt;/p>
&lt;pre>&lt;code class="language-mermaid" data-lang="mermaid">graph LR;
CQP[é…·Q] --äº‹ä»¶å›è°ƒ--&amp;gt; dll[æ’ä»¶DLL];
dll --äº‹ä»¶å›è°ƒ--&amp;gt; python[Pythonè„šæœ¬];
python --è°ƒç”¨API--&amp;gt; dll;
dll --è°ƒç”¨API--&amp;gt; CQP;
&lt;/code>&lt;/pre>&lt;h2 id="ä¾èµ–">ä¾èµ–&lt;/h2>
&lt;p>ä¸ºäº†ç®€åŒ–æ“ä½œ Python æ¥å£ï¼Œæˆ‘æ²¡æœ‰ä½¿ç”¨ Python è‡ªå¸¦çš„ C APIï¼Œè€Œæ˜¯&lt;code>pybind11&lt;/code>ï¼Œä½¿ç”¨&lt;code>vcpkg&lt;/code>ç®¡ç†ä¾èµ–ã€‚&lt;/p>
&lt;p>å®‰è£…å‘½ä»¤ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-batch" data-lang="batch">vcpkg install pybind11:x86-windows
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="0x1-ç¼–è¯‘-dll">0x1 ç¼–è¯‘ DLL&lt;/h2>
&lt;p>æˆ‘ä½¿ç”¨ CMake ä½œä¸ºç¼–è¯‘ç³»ç»Ÿï¼Œå› æ­¤å¯ä»¥å¾ˆç®€å•åœ°å†™ä¸€ä¸ªç¼–è¯‘å‡º DLL çš„ &lt;code>CMakeLists.txt&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-cmake" data-lang="cmake">&lt;span class="nb">cmake_minimum_required&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">VERSION&lt;/span> &lt;span class="s">3.15&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="nb">project&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">top.weak-ptr.cqpy&lt;/span> &lt;span class="s">LANGUAGES&lt;/span> &lt;span class="s">CXX&lt;/span> &lt;span class="s">VERSION&lt;/span> &lt;span class="s">0.1.0&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="nb">include_directories&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">src&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="nb">aux_source_directory&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">src&lt;/span> &lt;span class="s">SOURCES&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="nb">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">CMAKE_CXX_STANDARD&lt;/span> &lt;span class="s">17&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># å¼•å…¥ pybind11
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="nb">find_package&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">pybind11&lt;/span> &lt;span class="s">CONFIG&lt;/span> &lt;span class="s">REQUIRED&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># æ·»åŠ  target
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="nb">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">OUT_NAME&lt;/span> &lt;span class="s2">&amp;#34;app&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="nb">add_library&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">${&lt;/span>&lt;span class="nv">OUT_NAME&lt;/span>&lt;span class="o">}&lt;/span> &lt;span class="s">SHARED&lt;/span> &lt;span class="o">${&lt;/span>&lt;span class="nv">SOURCES&lt;/span>&lt;span class="o">}&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="nb">set_target_properties&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">${&lt;/span>&lt;span class="nv">OUT_NAME&lt;/span>&lt;span class="o">}&lt;/span> &lt;span class="s">PROPERTIES&lt;/span> &lt;span class="s">LINKER_LANGUAGE&lt;/span> &lt;span class="s">CXX&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="nb">target_link_libraries&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">${&lt;/span>&lt;span class="nv">OUT_NAME&lt;/span>&lt;span class="o">}&lt;/span> &lt;span class="s">PRIVATE&lt;/span> &lt;span class="s">pybind11::embed&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æºä»£ç ä½¿ç”¨ MSVC å’Œ MinGW ç¼–è¯‘ï¼Œå¦å¤–å†å¤„ç†ä¸‹æºç ç¼–ç çš„é—®é¢˜å’Œå®ã€‚&lt;/p>
&lt;p>ä¸»è¦æ¶‰åŠçš„å‡ ä¸ªé—®é¢˜ï¼š&lt;/p>
&lt;ol>
&lt;li>MSVC ç¼–è¯‘æ—¶é€šè¿‡&lt;code>/utf-8&lt;/code>ç¼–è¯‘å‚æ•°æŒ‡å®šæºç æ–‡ä»¶çš„ç¼–ç ã€‚&lt;/li>
&lt;li>MSVC ç¼–è¯‘&lt;code>pybind11&lt;/code>æ—¶éœ€è¦æŒ‡å®š &lt;code>-DNOMINMAX&lt;/code>ï¼Œè¿™æ˜¯&lt;code>pybind11&lt;/code>è¦æ±‚çš„ã€‚&lt;/li>
&lt;li>å› ä¸ºä½¿ç”¨ VCPKG ç®¡ç†ä¾èµ–ï¼ŒMSVC ç¼–è¯‘æ—¶è¿˜éœ€è¦è®¾ç½®é“¾æ¥å±æ€§ã€‚&lt;/li>
&lt;li>MinGW ç¼–è¯‘æ—¶ï¼ŒæŒ‡å®š &lt;code>-static&lt;/code> é¿å…ä¾èµ– &lt;code>libgcc&lt;/code> ä¹‹ç±»çš„ dllï¼Œæœ€ç»ˆç¼–è¯‘ç»“æœåªä¾èµ–äº &lt;code>libpython3.7.dll&lt;/code>ã€‚&lt;/li>
&lt;li>MinGW ç¼–è¯‘æ—¶ï¼ŒæŒ‡å®š &lt;code>-Wl,--kill-at,--enable-stdcall-fixup&lt;/code>ï¼Œæ¥ç¡®ä¿å¯¼å‡ºçš„ DLL API åå­—æ²¡æœ‰ä¸‹åˆ’çº¿å¼€å¤´å’Œ&lt;code>@&amp;lt;å‚æ•°å¤§å°&amp;gt;&lt;/code>çš„åç¼€ã€‚&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-cmake" data-lang="cmake">&lt;span class="c"># æ·»åŠ ç¼–è¯‘å‚æ•°
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="nb">add_compile_definitions&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">APP_ID=&lt;/span>&lt;span class="s2">&amp;#34;${PROJECT_NAME}&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="nb">add_definitions&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">-DAPP_ID=&lt;/span>&lt;span class="s2">&amp;#34;top.weak-ptr.cqpy&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="nb">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="s">MSVC&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="nb">add_compile_options&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">/utf-8&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="nb">add_definitions&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">-DNOMINMAX&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="c"># è®¾ç½®é™æ€é“¾æ¥
&lt;/span>&lt;span class="c">&lt;/span> &lt;span class="nb">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">VCPKG_CRT_LINKAGE&lt;/span> &lt;span class="s">STATIC&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="nb">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">VCPKG_LIBRARY_LINKAGE&lt;/span> &lt;span class="s">STATIC&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="nb">else&lt;/span> &lt;span class="p">()&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="nb">add_link_options&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">-static&lt;/span> &lt;span class="s">-Wl,--kill-at,--enable-stdcall-fixup&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="nb">endif&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="s">MSVC&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ€åçš„æ„å»ºå‘½ä»¤ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-batch" data-lang="batch">&lt;span class="k">mkdir&lt;/span> build
&lt;span class="k">cd&lt;/span> build
cmake .. \
&lt;span class="s2">&amp;#34;-GVisual Studio 16 2019&amp;#34;&lt;/span> \
-AWin32 \
-DCMAKE_TOOLCHAIN_FILE=/path/to/your/vcpkg/scripts/buildsystems/vcpkg.cmake \
cmake --build .
cmake install
&lt;/code>&lt;/pre>&lt;/div>&lt;p>MinGW å¯¹åº”æ”¹ä¸‹ Generatorï¼Œå»æ‰&lt;code>-AWin32&lt;/code>å’Œåé¢çš„&lt;code>-DCMAKE_TOOLCHAIN_FILE=/path/to/your/vcpkg/scripts/buildsystems/vcpkg.cmake&lt;/code>å³å¯ã€‚&lt;/p>
&lt;h2 id="0x2-msvc-ç¼–è¯‘å¯¼å‡º-dll-çš„é—®é¢˜">0x2 MSVC ç¼–è¯‘å¯¼å‡º DLL çš„é—®é¢˜&lt;/h2>
&lt;p>å‚è€ƒ MSDN çš„æ–‡æ¡£ï¼Œä½¿ç”¨ä¸‹é¢çš„æ–¹å¼æ— æ³•æ­£ç¡®å¯¼å‡º DLL æ¥å£ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="k">extern&lt;/span> &lt;span class="s">&amp;#34;C&amp;#34;&lt;/span> &lt;span class="kr">__declspec&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dllexport&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="kr">__stdcall&lt;/span> &lt;span class="n">test&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ€ç»ˆé‡‡ç”¨çš„æ˜¯&lt;code>__pragma&lt;/code>çš„æ–¹å¼æŒ‡å®šå¯¼å‡ºåï¼Œå¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="cp">#define DLL_EXPORT extern &amp;#34;C&amp;#34; __declspec(dllexport)
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="cp">#define CQ_EXPORT(ReturnType, FuncName, ParamsSize, ...) \
&lt;/span>&lt;span class="cp"> __pragma( \
&lt;/span>&lt;span class="cp"> comment(linker, &amp;#34;/EXPORT:&amp;#34; #FuncName &amp;#34;=_&amp;#34; #FuncName &amp;#34;@&amp;#34; #ParamsSize)) \
&lt;/span>&lt;span class="cp"> DLL_EXPORT ReturnType __stdcall FuncName(__VA_ARGS__)
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ³¨æ„&lt;code>__pragma&lt;/code>åªèƒ½åœ¨ MSVC ä¸­ä½¿ç”¨ï¼Œæ‰€ä»¥è¦åŠ ä¸Šæ¡ä»¶åˆ¤æ–­ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="cp">#define DLL_EXPORT extern &amp;#34;C&amp;#34; __declspec(dllexport)
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="cp">#if defined(_MSC_VER)
&lt;/span>&lt;span class="cp">#define CQ_EXPORT(ReturnType, FuncName, ParamsSize, ...) \
&lt;/span>&lt;span class="cp"> __pragma( \
&lt;/span>&lt;span class="cp"> comment(linker, &amp;#34;/EXPORT:&amp;#34; #FuncName &amp;#34;=_&amp;#34; #FuncName &amp;#34;@&amp;#34; #ParamsSize)) \
&lt;/span>&lt;span class="cp"> DLL_EXPORT ReturnType __stdcall FuncName(__VA_ARGS__)
&lt;/span>&lt;span class="cp">#else
&lt;/span>&lt;span class="cp">#define CQ_EXPORT(ReturnType, FuncName, ParamsSize, ...) \
&lt;/span>&lt;span class="cp"> DLL_EXPORT ReturnType __stdcall FuncName(__VA_ARGS__)
&lt;/span>&lt;span class="cp">#endif
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç†è®ºä¸Šä¹Ÿèƒ½ç”¨&lt;code>.def&lt;/code>æ–‡ä»¶æ¥å®šä¹‰å¯¼å‡ºè¡¨ï¼Œå¯ä»¥è‡ªè¡Œå°è¯•ä¸‹ã€‚&lt;/p>
&lt;h2 id="0x3-å¯¼å…¥-cqpdll-çš„-api-çš„é—®é¢˜">0x3 å¯¼å…¥ CQP.dll çš„ API çš„é—®é¢˜&lt;/h2>
&lt;p>é¦–å…ˆè¦çŸ¥é“&lt;code>CQP.dll&lt;/code>ä¹Ÿä¼šåŠ è½½åˆ°&lt;code>CQP.exe&lt;/code>ä¸­ï¼Œæ’ä»¶ä¹Ÿä¼šåŠ è½½åˆ°&lt;code>CQP.exe&lt;/code>ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦çš„å°±æ˜¯ä½¿ç”¨ Windows API è·å–åˆ°&lt;code>CQP.dll&lt;/code>çš„ Handle å†è¿›è¡Œæ“ä½œã€‚&lt;/p>
&lt;p>å¤§è‡´ä»£ç å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="k">const&lt;/span> &lt;span class="k">auto&lt;/span> &lt;span class="n">dll&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">GetModuleHandleW&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">L&lt;/span>&lt;span class="s">&amp;#34;CQP.dll&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">const&lt;/span> &lt;span class="k">auto&lt;/span> &lt;span class="n">CQ_addLog&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">reinterpret_cast&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int32_t&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kr">__stdcall&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="kt">int32_t&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="kt">int32_t&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">GetProcAddress&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dll&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;CQ_addLog&amp;#34;&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>é€šè¿‡ä¸¤ä¸ª API è°ƒç”¨å³å¯è·å¾—éœ€è¦çš„å‡½æ•°æŒ‡é’ˆäº†ã€‚&lt;/p>
&lt;h2 id="0x4-åµŒå…¥-python-è§£é‡Šå™¨">0x4 åµŒå…¥ Python è§£é‡Šå™¨&lt;/h2>
&lt;p>åˆ°äº†è¿™ä¸€æ­¥å·²ç»éå¸¸ç®€å•äº†ï¼Œ&lt;code>pybind11&lt;/code>æä¾›äº†é«˜åº¦å°è£…çš„ C++ APIã€‚å¯ä»¥ç›´æ¥å‚è€ƒ&lt;a class="link" href="https://pybind11.readthedocs.io/en/stable/advanced/embedding.html" target="_blank" rel="noopener"
>è¿™ä¸ªæ–‡æ¡£&lt;/a>ã€‚&lt;/p>
&lt;p>å†ç»™ä¸ªç®€å•çš„ä¾‹å­ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c++" data-lang="c++">&lt;span class="k">template&lt;/span> &lt;span class="o">&amp;lt;&lt;/span>&lt;span class="k">typename&lt;/span>&lt;span class="p">...&lt;/span> &lt;span class="n">Args&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>
&lt;span class="kr">inline&lt;/span> &lt;span class="kt">int32_t&lt;/span> &lt;span class="n">py_callback&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">string&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">py_func&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Args&lt;/span>&lt;span class="p">...&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">guard&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">lock_guard&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">lock&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">m&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">py&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">module&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">import&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;cqpy._callback&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">attr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">py_func&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">c_str&lt;/span>&lt;span class="p">())(&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">...).&lt;/span>&lt;span class="k">template&lt;/span> &lt;span class="n">cast&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int32_t&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="n">py&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">error_already_set&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">logging&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">what&lt;/span>&lt;span class="p">());&lt;/span> &lt;span class="c1">// è®°å½• python é”™è¯¯åˆ°æ—¥å¿—
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// å¯ç”¨æ’ä»¶
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">CQ_EXPORT&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int32_t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">cq_event_enable&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">py&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">initialize_interpreter&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="c1">// è®¾ç½® AUTH_CODEï¼Œä½†æ˜¯æš‚æ—¶è¿˜ä¸èƒ½ä½¿ç”¨é…·Qçš„API
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">auto&lt;/span> &lt;span class="n">_embed&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">py&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">module&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">import&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;_embed&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">_embed&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">attr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;AUTH_CODE&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">AUTH_CODE&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// åˆå§‹åŒ– Python è§£é‡Šå™¨ç¯å¢ƒï¼ŒæŠŠæ•°æ®ç›®å½•åŠ å…¥ python path
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">auto&lt;/span> &lt;span class="n">raw_app_dir&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">string&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">CQ_getAppDirectory&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">AUTH_CODE&lt;/span>&lt;span class="p">));&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">app_dir&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">py&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">bytes&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">raw_app_dir&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="n">attr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;decode&amp;#34;&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="s">&amp;#34;gb18030&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="n">cast&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">py&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">str&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">sys&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">py&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">module&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">import&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;sys&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">sys&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">attr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;path&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="n">attr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;append&amp;#34;&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">app_dir&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// åˆå§‹åŒ–å®Œæˆ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">logging&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Python interpreter initialized.&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nf">py_callback&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;on_enable&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶åœ¨å‰é¢é€šè¿‡ç›¸å…³å‚æ•°æŒ‡å®šäº†é™æ€é“¾æ¥ï¼Œä½†å®é™…&lt;code>Python3.7.dll&lt;/code>è¿˜æ˜¯åŠ¨æ€é“¾æ¥ä¸Šå»çš„ã€‚&lt;/p>
&lt;p>æ‰€ä»¥åˆ†å‘è¿™æ ·ç¼–è¯‘å‡ºæ¥çš„ dllï¼Œä¾ç„¶éœ€è¦ç”¨æˆ·å…ˆå®‰è£…ä¸€ä¸ª &lt;code>Python3.7&lt;/code>ï¼Œæˆ–è€…æŠŠ &lt;code>Python3.7.dll&lt;/code> ä¹Ÿä¸€èµ·åˆ†å‘å‡ºå»ã€‚&lt;/p>
&lt;p>å¦‚æœè¦å®Œå…¨çš„é™æ€é“¾æ¥ï¼Œå¯èƒ½è¦è‡ªè¡Œç¼–è¯‘ Python æºä»£ç ã€‚å®åœ¨å¤ªéº»çƒ¦ï¼Œå°±æ‡’å¾—å¼„äº†ã€‚&lt;/p>
&lt;h2 id="0x5-è¸©çš„å‘">0x5 è¸©çš„å‘&lt;/h2>
&lt;p>é€šè¿‡ Python è°ƒç”¨ C++ ç«¯æä¾›çš„ API æ—¶ï¼Œç‰¹åˆ«æ³¨æ„å‚æ•°ä¸€å®šè¦ä¸€ä¸€å¯¹åº”ï¼Œç‰¹åˆ«æ˜¯æ•°æ®ç±»å‹ï¼Œä¸€æ—¦ä¸åŒ¹é…æˆ–ä¼ å…¥æ•°æ®æœ‰è¯¯ï¼ˆä¾‹å¦‚ Noneï¼‰ï¼Œå¯èƒ½é€ æˆ C++ ç«¯å†…å­˜å¼‚å¸¸ï¼Œéœ€è¦æŒ‚è°ƒè¯•å™¨æ‰èƒ½å‘ç°åŸå› ï¼Œéå¸¸éº»çƒ¦ã€‚&lt;/p>
&lt;p>&lt;code>sys&lt;/code>æ˜¯&lt;code>builtin&lt;/code>çš„åº“ï¼Œå’Œ&lt;code>os&lt;/code>ä¸åŒï¼Œå¦‚æœåˆ†å‘çš„ç”¨æˆ·æ²¡æœ‰å®‰è£… Pythonï¼Œåªæœ‰ä¸€ä¸ª &lt;code>Python3.7.dll&lt;/code>çš„è¯ï¼Œå¾ˆå¤š Python è‡ªå¸¦çš„åº“æ˜¯ç”¨ä¸äº†çš„ã€‚ä¾‹å¦‚è¯´&lt;code>json&lt;/code>ã€&lt;code>logging&lt;/code>ã€ç”šè‡³&lt;code>os&lt;/code>ã€‚è¿™ä¸ªåº”è¯¥ç®—æ˜¯å¸¸è¯†ï¼Œä½†æœ€å¥½ä¸€å¼€å§‹å°±æ„è¯†åˆ°ï¼šä½ çš„ç”¨æˆ·è¿˜æ˜¯è¦è£…ä¸€ä¸ª Python æ‰è¡Œã€‚&lt;/p>
&lt;p>å…³äº VirtualEnv æ”¯æŒï¼Œå»ºè®®ç›´æ¥å‚è€ƒ&lt;a class="link" href="https://www.python.org/dev/peps/pep-0405/" target="_blank" rel="noopener"
>PEP 405&lt;/a>ã€‚ä¸å¤šèµ˜è¿°ã€‚æ¯”è¾ƒç®€å•çš„å¤„ç†å°±æ˜¯æŠŠ&lt;code>VENV\Lib\site-packages&lt;/code>åŠ å…¥åˆ°&lt;code>sys.path&lt;/code>é‡Œã€‚&lt;/p>
&lt;p>èƒ½ä¸èƒ½æŠŠæ‰€æœ‰ Python ä»£ç å’Œ dll éƒ½æ‰“åŒ…è¿› dll é‡Œï¼Ÿå¤§è‡´åŸç†å°±æ˜¯ä¸¢è¿›&lt;code>rc&lt;/code>é‡Œï¼Œä½†å®é™…å¾ˆéº»çƒ¦ï¼Œçœ‹&lt;code>py2exe&lt;/code>è¿„ä»Šä¸ºæ­¢è¿˜æœ‰ä¸€å¤§å †å‘å°±çŸ¥é“æœ‰å¤šéº»çƒ¦äº†ã€‚&lt;/p></description></item><item><title>Flaskæºç é˜…è¯»ç¬”è®°ï¼šWSGI</title><link>https://nnnewb.github.io/blog/p/flask%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0wsgi/</link><pubDate>Sun, 17 Mar 2019 00:00:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/flask%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0wsgi/</guid><description>&lt;h2 id="0-intro">0. Intro&lt;/h2>
&lt;p>Flask æ˜¯ä¸€ä¸ªåŸºäº WSGI åè®®çš„ä¸Šå±‚åº”ç”¨æ¡†æ¶ï¼Œæ®æˆ‘äº†è§£åº”è¯¥æ˜¯å’Œ Tornadoã€Django æµè¡Œç¨‹åº¦ç›¸è¿‘ï¼Œå½“ç„¶ Django è€å¤§å“¥å§‹ç»ˆå æ®äº†æœ€å¤šçš„ä»½é¢ã€‚Flask æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ Micro Frameworkï¼Œæºç å€¼å¾—ä¸€è¯»ã€‚&lt;/p>
&lt;h2 id="1-å›é¡¾-wsgi">1. å›é¡¾ WSGI&lt;/h2>
&lt;p>å¼€å§‹ä¹‹å‰ï¼Œéœ€è¦å…ˆå›é¡¾ä»¥ä¸‹ WSGI åè®®ã€‚&lt;/p>
&lt;p>WSGI æ˜¯ä¸€ä¸ªé’ˆå¯¹ Python çš„åè®®ï¼Œæ•…è¯´åˆ°çš„ Appã€Serverã€å‡½æ•°ã€å‚æ•°ç­‰æè¿°éƒ½æ˜¯æŒ‡ Python å¯¹åº”çš„æ¦‚å¿µæˆ–å®ç°ã€‚&lt;/p>
&lt;h3 id="11-pep-0333-åˆ°-pep-3333">1.1 PEP-0333 åˆ° PEP-3333&lt;/h3>
&lt;p>PEP-0333 æ˜¯åˆç‰ˆçš„ WSGI åè®®ææ¡ˆï¼ŒPEP-3333 æ˜¯ 1.0.1 ç‰ˆæœ¬çš„ WSGI ææ¡ˆï¼Œå·®åˆ«ä¸å¤§ï¼Œä¸»è¦æ˜¯å¯¹ py3 å’Œ py2 ä¸å…¼å®¹çš„éƒ¨åˆ†ä½œäº†æ›´æ–°è¯´æ˜ï¼ˆ&lt;code>str&lt;/code>å’Œ&lt;code>unicode&lt;/code>æ–¹é¢çš„é—®é¢˜ï¼Œpython2 çš„ str åœ¨ python3 æ˜¯ bytesï¼Œæ•… python3 ç¼–å†™çš„ wsgi app å¿…é¡»è¿”å› bytesï¼‰ã€‚&lt;/p>
&lt;p>WSGI åè®®è§„èŒƒäº† Python Web åº”ç”¨çš„ä¸¤ä¸ªå±‚çº§ï¼šæœåŠ¡å™¨å±‚ï¼ˆServerï¼‰å’Œåº”ç”¨å±‚ï¼ˆApplicationï¼‰ï¼Œä¸¤è€…é€šè¿‡ WSGI åè®®è¿›è¡Œé€šä¿¡ã€‚&lt;/p>
&lt;p>å…¶ä¸­ Server è´Ÿè´£å¤„ç†è¯·æ±‚ï¼Œå°†è¯·æ±‚è½¬æ¢æˆç¬¦åˆ WSGI è¦æ±‚çš„æ¨¡å¼ï¼ˆ&lt;code>environ&lt;/code>å‚æ•°ï¼‰ã€‚ Application å®Œæˆå¤„ç†åå†é€šçŸ¥ Server è¿”å› Responseï¼ˆ&lt;code>start_response&lt;/code>å‚æ•°ï¼‰ã€‚&lt;/p>
&lt;p>WSGI è§„å®š App å¿…é¡»æ˜¯ä¸€ä¸ªå¯ä»¥è¢«è°ƒç”¨çš„å¯¹è±¡ï¼Œæ¥å—æŒ‡å®šæ•°é‡çš„å‚æ•°ï¼ŒWSGI Server ä¸å…³æ³¨ä»»ä½•å…¶ä»– App å®ç°ç»†èŠ‚ã€‚è€Œ WSGI App ä¹Ÿåº”å½“éµå®ˆè¿™ä¸€è¦æ±‚ï¼Œå¯¹ &lt;code>start_response&lt;/code> å‚æ•°ä¹Ÿéµå®ˆä¸ä¾èµ–äºä»»ä½• WSGI Server çš„å®ç°ç»†èŠ‚ã€‚&lt;/p>
&lt;p>WSGI App çš„æ¥å£è§„èŒƒå£°æ˜å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">def&lt;/span> &lt;span class="nf">app&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">environ&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">start_response&lt;/span>&lt;span class="p">):&lt;/span> &lt;span class="o">...&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>start_response&lt;/code>çš„å£°æ˜å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">def&lt;/span> &lt;span class="nf">start_response&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">status&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">response_headers&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">exc_info&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">):&lt;/span> &lt;span class="o">...&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="12-wsgi-server">1.2 WSGI Server&lt;/h3>
&lt;p>å¸¸è§çš„ WSGI Server æœ‰å‡ ä¸ªã€‚Nginx å’Œ Apache éƒ½æœ‰ WSGI æ’ä»¶ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰ gunicornã€gevent.wsgi ç­‰ã€‚&lt;/p>
&lt;p>ä¸¾ä¸€ä¸ªå…¸å‹çš„ä¾‹å­æ¥è¯´ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="c1"># app.py&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">wsgiserver&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">app&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">environ&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">start_response&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">start_response&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;200 OK&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[(&lt;/span>&lt;span class="s1">&amp;#39;Content-Type&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s1">&amp;#39;text-plain&amp;#39;&lt;/span>&lt;span class="p">)])&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="sa">b&lt;/span>&lt;span class="s2">&amp;#34;Hello world!&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="n">wsgiserver&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">WSGIServer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">app&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">host&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;127.0.0.1&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">port&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;5000&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">start&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨ windows ä¸‹ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å®‰è£… wsgiserver&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">pip install wsgiserver
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ€åæ‰§è¡Œ&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">python app.py
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="2-å…¥å£ç‚¹">2. å…¥å£ç‚¹&lt;/h2>
&lt;p>çœ‹å®Œ WSGI ï¼Œæ¥ä¸‹æ¥çœ‹ Flask è¯·æ±‚çš„å…¥å£ç‚¹åœ¨å“ªå„¿ã€‚&lt;/p>
&lt;h3 id="21-wsgi-server-ä¸-run">2.1 WSGI Server ä¸ &lt;code>.run&lt;/code>&lt;/h3>
&lt;p>&lt;code>Flask&lt;/code>è¿™ä¸ªç±»å®šä¹‰äº&lt;code>flask.app&lt;/code>ï¼Œçœ‹è¿™é‡Œçš„ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">class&lt;/span> &lt;span class="nc">Flask&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">_PackageBoundObject&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…ˆä¸å»ç®¡ &lt;code>_PackageBoundObject&lt;/code> æ˜¯å•¥ã€‚æˆ‘ä»¬çŸ¥é“ &lt;code>Flask&lt;/code>æœ‰ä¸€ä¸ª&lt;code>run&lt;/code>æ–¹æ³•å¯ä»¥å¿«é€Ÿå¯åŠ¨æœåŠ¡ï¼Œç›´æ¥è·³è½¬åˆ°é‚£å„¿ã€‚&lt;/p>
&lt;blockquote>
&lt;p>&lt;a class="link" href="https://github.com/pallets/flask/blob/master/flask/app.py" target="_blank" rel="noopener"
>flask/app.py&lt;/a>
COMMIT a74864e , Line 844 ~ 949&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python"> &lt;span class="k">def&lt;/span> &lt;span class="nf">run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">host&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">port&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">debug&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">load_dotenv&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">options&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34; ç•¥ &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;span class="c1"># Change this into a no-op if the server is invoked from the&lt;/span>
&lt;span class="c1"># command line. Have a look at cli.py for more information.&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">environ&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;FLASK_RUN_FROM_CLI&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;true&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="kn">from&lt;/span> &lt;span class="nn">.debughelpers&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">explain_ignored_app_run&lt;/span>
&lt;span class="n">explain_ignored_app_run&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="n">get_load_dotenv&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">load_dotenv&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">cli&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">load_dotenv&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="c1"># if set, let env vars override previous values&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="s1">&amp;#39;FLASK_ENV&amp;#39;&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">environ&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">env&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">get_env&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">debug&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">get_debug_flag&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">elif&lt;/span> &lt;span class="s1">&amp;#39;FLASK_DEBUG&amp;#39;&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">environ&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">debug&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">get_debug_flag&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="c1"># debug passed to method overrides all other sources&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="n">debug&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">debug&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">bool&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">debug&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">_host&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;127.0.0.1&amp;#39;&lt;/span>
&lt;span class="n">_port&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">5000&lt;/span>
&lt;span class="n">server_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">config&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;SERVER_NAME&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">sn_host&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sn_port&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">None&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="n">server_name&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">sn_host&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sn_port&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">server_name&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">partition&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;:&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">host&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">host&lt;/span> &lt;span class="ow">or&lt;/span> &lt;span class="n">sn_host&lt;/span> &lt;span class="ow">or&lt;/span> &lt;span class="n">_host&lt;/span>
&lt;span class="n">port&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">port&lt;/span> &lt;span class="ow">or&lt;/span> &lt;span class="n">sn_port&lt;/span> &lt;span class="ow">or&lt;/span> &lt;span class="n">_port&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">options&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">setdefault&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;use_reloader&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">debug&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">options&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">setdefault&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;use_debugger&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">debug&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">options&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">setdefault&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;threaded&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">True&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">cli&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">show_server_banner&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">env&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">debug&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">False&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kn">from&lt;/span> &lt;span class="nn">werkzeug.serving&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">run_simple&lt;/span>
&lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">run_simple&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">host&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">port&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">options&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">finally&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="c1"># reset the first request information if the development server&lt;/span>
&lt;span class="c1"># reset normally. This makes it possible to restart the server&lt;/span>
&lt;span class="c1"># without reloader and that stuff from an interactive shell.&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_got_first_request&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">False&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/blockquote>
&lt;p>é¦–å…ˆè¿›å…¥çœ¼å¸˜çš„æ˜¯å…³äº flask/cli çš„å†…å®¹ã€‚ ç‚¹è¿› &lt;code>explain_ignored_app_run&lt;/code> å¯ä»¥å¾—çŸ¥è¿™æ˜¯ä¸€ä¸ªé˜²æ­¢ç”¨æˆ·çŠ¯è ¢å†™ä¸‹ app.run() ååˆç”¨ &lt;code>flask run&lt;/code>åœ¨å‘½ä»¤è¡Œå¯åŠ¨ç•™ä¸‹çš„è¯´æ˜æ€§è¾“å‡ºã€‚&lt;/p>
&lt;p>å…¶æ¬¡æ˜¯ dotenv ç›¸å…³çš„ç©æ„å„¿ï¼Œæ²¡ç”¨è¿‡ dotenv æ¨èå»äº†è§£ä¸‹ python-dotenv è¿™ä¸ªåŒ…ã€‚å¯ä»¥å¾ˆæ–¹ä¾¿åœ°é…ç½®å¥½å¼€å‘ç¯å¢ƒä¸‹çš„ç¯å¢ƒå˜é‡ã€‚&lt;/p>
&lt;p>ç»è¿‡ä¸€å †ç±»å‹è½¬æ¢å’Œæ£€æŸ¥ä¹‹åï¼Œç»ˆäºçœ‹åˆ°äº†è¿™å‡ è¡Œã€‚&lt;/p>
&lt;blockquote>
&lt;p>&lt;a class="link" href="https://github.com/pallets/flask/blob/master/flask/app.py" target="_blank" rel="noopener"
>flask/app.py&lt;/a>
COMMIT a74864e , Line 941 ~ 949&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python"> &lt;span class="kn">from&lt;/span> &lt;span class="nn">werkzeug.serving&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">run_simple&lt;/span>
&lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">run_simple&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">host&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">port&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">options&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">finally&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="c1"># reset the first request information if the development server&lt;/span>
&lt;span class="c1"># reset normally. This makes it possible to restart the server&lt;/span>
&lt;span class="c1"># without reloader and that stuff from an interactive shell.&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_got_first_request&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">False&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/blockquote>
&lt;p>&lt;code>run_simple&lt;/code>ï¼Ÿè¿™å°±æ˜¯ WSGI Server å¯åŠ¨çš„åœ°æ–¹äº†ã€‚&lt;/p>
&lt;p>&lt;a class="link" href="http://werkzeug.pocoo.org/docs/0.14/serving/" target="_blank" rel="noopener"
>çœ‹çœ‹ werkzeug æ–‡æ¡£å§&lt;/a>ï¼Œæˆ‘è¿™é‡Œæ‘˜ä¸€æ®µã€‚&lt;/p>
&lt;blockquote>
&lt;p>Serving WSGI Applications
There are many ways to serve a WSGI application. While youâ€™re developing it, you usually donâ€™t want to have a full-blown webserver like Apache up and running, but instead a simple standalone one. Because of that Werkzeug comes with a builtin development server.
The easiest way is creating a small start-myproject.py file that runs the application using the builtin server:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="ch">#!/usr/bin/env python&lt;/span>
&lt;span class="c1"># -*- coding: utf-8 -*-&lt;/span>
&lt;span class="kn">from&lt;/span> &lt;span class="nn">werkzeug.serving&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">run_simple&lt;/span>
&lt;span class="kn">from&lt;/span> &lt;span class="nn">myproject&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">make_app&lt;/span>
&lt;span class="n">app&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">make_app&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">run_simple&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;localhost&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">8080&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">app&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">use_reloader&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/blockquote>
&lt;p>ä»å‡½æ•°ç­¾åå¯ä»¥çœ‹å¾—å‡ºï¼Œ&lt;code>run_simple&lt;/code>å¯åŠ¨æ—¶ï¼Œflask å°†è‡ªå·±ä½œä¸º wsgi app å‚æ•°ä¼ ç»™äº† werkzeugï¼Œä¸éš¾çŒœæµ‹å‡ºï¼ŒFlask æœ¬èº«æ˜¯ä¸€ä¸ªå¯è°ƒç”¨å¯¹è±¡ï¼Œå³é‡å†™äº† &lt;code>__call__&lt;/code> æ–¹æ³•ã€‚&lt;/p>
&lt;h3 id="22-__call__">2.2 &lt;code>__call__&lt;/code>&lt;/h3>
&lt;p>æ¥åˆ°&lt;code>__call__&lt;/code>ï¼Œå‘ç°å®ƒè°ƒç”¨äº†&lt;code>self.wsgi_app&lt;/code>ï¼Œæœ¬èº«æ²¡åšä»»ä½•äº‹ã€‚&lt;/p>
&lt;blockquote>
&lt;p>&lt;a class="link" href="https://github.com/pallets/flask/blob/master/flask/app.py" target="_blank" rel="noopener"
>flask/app.py&lt;/a>
COMMIT a74864e , Line 2323 ~ 2327&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__call__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">environ&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">start_response&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;The WSGI server calls the Flask application object as the
&lt;/span>&lt;span class="s2"> WSGI application. This calls :meth:`wsgi_app` which can be
&lt;/span>&lt;span class="s2"> wrapped to applying middleware.&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">wsgi_app&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">environ&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">start_response&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/blockquote>
&lt;p>å†æ¥åˆ° &lt;code>wsgi_app&lt;/code> çš„å®šä¹‰ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python"> &lt;span class="k">def&lt;/span> &lt;span class="nf">wsgi_app&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">environ&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">start_response&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34; ç•¥ &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;span class="n">ctx&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">request_context&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">environ&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">error&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">None&lt;/span>
&lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">ctx&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">push&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="n">response&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">full_dispatch_request&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">except&lt;/span> &lt;span class="ne">Exception&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">error&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">e&lt;/span>
&lt;span class="n">response&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">handle_exception&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">except&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">error&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">exc_info&lt;/span>&lt;span class="p">()[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="k">raise&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">response&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">environ&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">start_response&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">finally&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">should_ignore_error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">error&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">error&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">None&lt;/span>
&lt;span class="n">ctx&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">auto_pop&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œï¼Œå°±æ˜¯æ•´ä¸ª Flask ä½œä¸º wsgi appï¼Œå¤„ç† request çš„å…¥å£ç‚¹äº†ã€‚&lt;/p>
&lt;p>ä»è¿™å„¿æˆ‘ä»¬èƒ½é¸Ÿç°æ•´ä¸ª flask æ¡†æ¶çš„æ ¸å¿ƒé€»è¾‘ã€‚&lt;code>environ&lt;/code>è¢«åŒ…è£…æˆ &lt;code>request&lt;/code>ï¼Œå‹æ ˆï¼Œ&lt;code>full_dispatch_request&lt;/code>è·¯ç”±è‡³è§†å›¾ï¼Œå¤„ç†å¼‚å¸¸ï¼Œä¸€åˆ‡ç»“æŸåæ¸…æ ˆã€‚&lt;/p></description></item><item><title>Django çš„å„ç§å…³ç³»å­—æ®µè¯¦è§£</title><link>https://nnnewb.github.io/blog/p/django-%E7%9A%84%E5%90%84%E7%A7%8D%E5%85%B3%E7%B3%BB%E5%AD%97%E6%AE%B5%E8%AF%A6%E8%A7%A3/</link><pubDate>Wed, 06 Mar 2019 21:11:35 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/django-%E7%9A%84%E5%90%84%E7%A7%8D%E5%85%B3%E7%B3%BB%E5%AD%97%E6%AE%B5%E8%AF%A6%E8%A7%A3/</guid><description>&lt;blockquote>
&lt;p>å‚è€ƒèµ„æ–™å¦‚ä¸‹&lt;/p>
&lt;ul>
&lt;li>&lt;a class="link" href="https://docs.djangoproject.com/zh-hans/2.1/ref/models/fields/" target="_blank" rel="noopener"
>Django æ–‡æ¡£ - Model field reference&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://graycarl.me/2014/03/24/sqlalchemy-cascade-delete.html" target="_blank" rel="noopener"
>SQLAlchemy ä¸­çš„çº§è”åˆ é™¤&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;h2 id="1-foreignkey">1. ForeignKey&lt;/h2>
&lt;p>&lt;code>ForeignKey&lt;/code>ç”¨äºå¤šå¯¹ä¸€å…³ç³»ï¼Œç›´æ¥å¯¹åº”åˆ°æ•°æ®åº“å¤–é”®çš„æ¦‚å¿µã€‚ä½¿ç”¨&lt;code>ForeignKey&lt;/code>éœ€è¦æŒ‡å®šå¼•ç”¨çš„ç›®æ ‡è¡¨ï¼Œä¼šè‡ªåŠ¨å…³è”åˆ°ç›®æ ‡è¡¨çš„ä¸»é”®ï¼ˆä¸€èˆ¬æ˜¯&lt;code>id&lt;/code>å­—æ®µï¼‰ã€‚&lt;/p>
&lt;p>ä¾‹å­å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="kn">from&lt;/span> &lt;span class="nn">django.db&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">models&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">Child&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">models&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Model&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">parent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">models&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ForeignKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Parent&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">on_delete&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">models&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">CASCADE&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">)&lt;/span>
&lt;span class="c1"># ...&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">Parent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">models&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Model&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="c1"># ...&lt;/span>
&lt;span class="k">pass&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯¹æ¯”ä¹‹ sqlalchemyï¼Œä¸€è¡Œ&lt;code>parent=models.ForeignKey(...)&lt;/code>åŒ…å«äº† sqlalchemy ä¸­çš„&lt;code>ForeignKey&lt;/code>å’Œ&lt;code>relationship&lt;/code>ä¸¤éƒ¨åˆ†å†…å®¹ã€‚&lt;/p>
&lt;h3 id="11-å‚æ•°on_delete">1.1 å‚æ•°ï¼šon_delete&lt;/h3>
&lt;p>&lt;code>on_delete&lt;/code>æ„ä¸ºå½“&lt;code>ForeignKey&lt;/code>å¼•ç”¨çš„å¯¹è±¡è¢«åˆ é™¤æ—¶è¿›è¡Œçš„æ“ä½œã€‚&lt;/p>
&lt;p>æœ‰å‡ ä¸ªå¯ä»¥è€ƒè™‘çš„é€‰é¡¹ã€‚&lt;/p>
&lt;h4 id="111-modelscascade">1.1.1 models.CASCADE&lt;/h4>
&lt;p>&lt;code>CASCADE&lt;/code>æ„ä¸ºçº§è”ï¼Œ&lt;code>on_delete&lt;/code>è®¾ç½®ä¸º&lt;code>CASCADE&lt;/code>æ—¶æ„ä¸ºæ‰§è¡Œçº§è”åˆ é™¤ã€‚ä¾æ®æ–‡æ¡£ï¼ŒDjango ä¼šæ¨¡ä»¿ SQL çš„&lt;code>ON DELETE CASCADE&lt;/code>ï¼Œå¯¹åŒ…å«äº†&lt;code>ForeignKey&lt;/code>çš„å¯¹è±¡æ‰§è¡Œåˆ é™¤ã€‚&lt;/p>
&lt;p>éœ€è¦æ³¨æ„çš„æ˜¯ä¸ä¼šè°ƒç”¨è¢«çº§è”åˆ é™¤å¯¹è±¡ä¸Šçš„&lt;code>model.delete()&lt;/code>ï¼Œä½†æ˜¯ä¼šå‘é€&lt;a class="link" href="https://docs.djangoproject.com/zh-hans/2.1/ref/signals/#django.db.models.signals.pre_delete" target="_blank" rel="noopener"
>&lt;code>pre_delete&lt;/code>&lt;/a>å’Œ&lt;a class="link" href="https://docs.djangoproject.com/zh-hans/2.1/ref/signals/#django.db.models.signals.post_delete" target="_blank" rel="noopener"
>&lt;code>post_delete&lt;/code>&lt;/a>ä¿¡å·ã€‚&lt;/p>
&lt;h4 id="1112-modelsprotect">1.1.1.2 models.PROTECT&lt;/h4>
&lt;p>&lt;code>PROTECT&lt;/code>æ„ä¸ºä¿æŠ¤ï¼Œ&lt;code>on_delete&lt;/code>è®¾ç½®ä¸º&lt;code>PROTECT&lt;/code>æ„å‘³ç€è¦é˜»æ­¢åˆ é™¤æ“ä½œå‘ç”Ÿã€‚åˆ é™¤å…³è”çš„å¯¹è±¡æ—¶ï¼Œ&lt;code>ForeignKey&lt;/code>çš„&lt;code>on_delete&lt;/code>è®¾ç½®ä¸º&lt;code>PROTECT&lt;/code>ä¼šè§¦å‘&lt;code>ProtectedError&lt;/code>ã€‚&lt;/p>
&lt;h4 id="1113-modelsset_null">1.1.1.3 models.SET_NULL&lt;/h4>
&lt;p>å¦‚å…¶åæ‰€è¿°ï¼Œå¦‚æœè¿™ä¸ª&lt;code>ForeignKey&lt;/code>æ˜¯ nullable çš„ï¼Œåˆ™å…³è”çš„å¯¹è±¡åˆ é™¤æ—¶å°†å¤–é”®è®¾ç½®ä¸º nullã€‚&lt;/p>
&lt;h4 id="1114-modelsset_default">1.1.1.4 models.SET_DEFAULT&lt;/h4>
&lt;p>å¦‚å…¶åæ‰€è¿°ï¼Œå¦‚æœè¿™ä¸ª&lt;code>ForeignKey&lt;/code>è®¾ç½®äº†&lt;code>DEFAULT&lt;/code>ï¼Œåˆ™å…³è”çš„å¯¹è±¡åˆ é™¤æ—¶è®¾ç½®è¿™ä¸ªå¤–é”®ä¸º&lt;code>DEFAULT&lt;/code>å€¼ã€‚&lt;/p>
&lt;h4 id="1115-modelsset">1.1.1.5 models.SET&lt;/h4>
&lt;p>åœ¨å…³è”çš„å¯¹è±¡åˆ é™¤æ—¶ï¼Œè®¾ç½®ä¸ºä¸€ä¸ªæŒ‡å®šçš„å€¼ã€‚è¿™ä¸ªå‚æ•°å¯ä»¥æ¥å—ä¸€ä¸ªå¯ä»¥èµ‹å€¼ç»™è¿™ä¸ª ForeignKey çš„å¯¹è±¡æˆ–è€…ä¸€ä¸ªå¯è°ƒç”¨å¯¹è±¡ã€‚&lt;/p>
&lt;p>å®˜æ–¹ä¾‹å­å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="kn">from&lt;/span> &lt;span class="nn">django.conf&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">settings&lt;/span>
&lt;span class="kn">from&lt;/span> &lt;span class="nn">django.contrib.auth&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">get_user_model&lt;/span>
&lt;span class="kn">from&lt;/span> &lt;span class="nn">django.db&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">models&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">get_sentinel_user&lt;/span>&lt;span class="p">():&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">get_user_model&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">objects&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get_or_create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">username&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;deleted&amp;#39;&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">MyModel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">models&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Model&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">user&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">models&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ForeignKey&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="n">settings&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">AUTH_USER_MODEL&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="n">on_delete&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">models&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">SET&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">get_sentinel_user&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="1116-modelsdo_nothing">1.1.1.6 models.DO_NOTHING&lt;/h4>
&lt;p>åº”è¯¥ä¸ç”¨å¤šè¯´äº†å§ã€‚Django ä¸ä¼šåšå¤šä½™çš„äº‹æƒ…ï¼Œä½†æ˜¯å¦‚æœåç«¯çš„æ•°æ®åº“æœåŠ¡æœ‰å¼ºåˆ¶å®Œæ•´æ€§çº¦æŸï¼Œé™¤éä½ åœ¨æ•°æ®åº“ä¸€ç«¯è‡ªå·±å®šä¹‰äº†&lt;code>ON DELETE&lt;/code>ï¼Œå¦åˆ™ä¼šè§¦å‘&lt;code>IntegrityError&lt;/code>ã€‚&lt;/p>
&lt;h3 id="12-å‚æ•°limited_choice_to">1.2 å‚æ•°ï¼šlimited_choice_to&lt;/h3>
&lt;p>å¼ºåˆ¶çº¦æŸä¸º django.admin æˆ–è€… ModelForm æ¸²æŸ“æ—¶æä¾›æœ‰é™çš„å¯é€‰é¡¹ã€‚&lt;/p>
&lt;p>æ¥å—å‚æ•°ä¸º&lt;code>dict&lt;/code>æˆ–è€…&lt;code>Q&lt;/code>å¯¹è±¡ã€è¿”å›&lt;code>Q&lt;/code>å¯¹è±¡çš„å¯è°ƒç”¨å¯¹è±¡ã€‚&lt;/p>
&lt;p>å®˜æ–¹ä¾‹å­ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">staff_member&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">models&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ForeignKey&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="n">User&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="n">on_delete&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">models&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">CASCADE&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="n">limit_choices_to&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;is_staff&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">True&lt;/span>&lt;span class="p">},&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Q å¯¹è±¡æ˜¯ä»€ä¹ˆç©æ„å„¿è¿™ä¸ªæˆ‘ææ˜ç™½äº†å†è¯´&amp;hellip;&lt;/p>
&lt;h3 id="13-å‚æ•°related_name">1.3 å‚æ•°ï¼šrelated_name&lt;/h3>
&lt;p>è®¾ç½®åå‘å…³è”çš„å­—æ®µåï¼Œå’Œ&lt;code>sqlalchemy&lt;/code>çš„&lt;code>backref&lt;/code>ç±»ä¼¼ã€‚&lt;/p>
&lt;p>ä¸¾ä¾‹æ¥è¯´ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">class&lt;/span> &lt;span class="nc">Child&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">models&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Model&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">parent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">models&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ForeignKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Parent&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">Parent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">models&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Model&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="k">pass&lt;/span>
&lt;span class="n">Parent&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">child_set&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">all&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1"># æœªè®¾ç½® related_name&lt;/span>
&lt;span class="n">Parent&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">children&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">all&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1"># è®¾ç½® related_name=children&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="14-å‚æ•°related_query_name">1.4 å‚æ•°ï¼šrelated_query_name&lt;/h3>
&lt;p>related_query_name å’Œ related_name ç±»ä¼¼ï¼Œè®¾ç½®åå‘å¼•ç”¨æŸ¥è¯¢æ—¶æ¡ä»¶çš„å‰ç¼€åã€‚ä¸¾ä¾‹æ¥è¯´ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">class&lt;/span> &lt;span class="nc">Child&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">models&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Model&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">parent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">models&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ForeignKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Parent&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">models&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">CharField&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">max_length&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">Parent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">models&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Model&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="k">pass&lt;/span>
&lt;span class="n">Parent&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">objects&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">filter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Child__name&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;æ²™é›•ç½‘å‹&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># æœªè®¾ç½® related_query_name&lt;/span>
&lt;span class="n">Parent&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">objects&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">filter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">myboy__name&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;æ²™é›•ç½‘å‹&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># è®¾ç½® related_query_name=myboy&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="15-å‚æ•°to_field">1.5 å‚æ•°ï¼što_field&lt;/h3>
&lt;p>å¾—åˆ°&lt;code>ForeignKey&lt;/code>å…³è”çš„æ¨¡å‹çš„å­—æ®µï¼Œé»˜è®¤æ˜¯ä¸»é”®ï¼Œå¦‚æœæŒ‡å®šçš„ä¸æ˜¯ä¸»é”®é‚£ä¹ˆå¿…é¡»æœ‰&lt;code>unique&lt;/code>çº¦æŸæ‰è¡Œã€‚&lt;/p>
&lt;h3 id="16-å‚æ•°db_constraint">1.6 å‚æ•°ï¼šdb_constraint&lt;/h3>
&lt;p>è¦ä¸è¦åˆ›å»ºæ•°æ®åº“å±‚çº§çš„çº¦æŸï¼Œä¹Ÿå°±æ˜¯é€šè¿‡åç«¯æ•°æ®åº“æœåŠ¡ç¡®ä¿æ•°æ®å®Œæ•´æ€§ä¸å—ç ´åã€‚å¦‚æœè®¾ç½®ä¸º False é‚£ä¹ˆè®¿é—®ä¸å­˜åœ¨çš„å¯¹è±¡æ—¶ä¼šè§¦å‘ DoesNotExists å¼‚å¸¸ã€‚&lt;/p>
&lt;h3 id="17-å‚æ•°swappable">1.7 å‚æ•°ï¼šswappable&lt;/h3>
&lt;p>ç”¨äºå¤„ç†â€œæˆ‘æœ‰ä¸€ä¸ªæŠ½è±¡ç±»æ¨¡å‹ä½†æ˜¯è¿™ä¸ªæ¨¡å‹æœ‰ä¸€ä¸ªå¤–é”®â€çš„æƒ…å†µï¼Œå…¸å‹å°±æ˜¯&lt;code>AUTH_USER_MODEL&lt;/code>ã€‚&lt;/p>
&lt;p>ä¸€èˆ¬ä¸ç”¨æ”¹åˆ°ï¼Œè¿™ä¸ªå±æ€§æ§åˆ¶äº†æ•°æ®åº“è¿ç§»æ—¶å¦‚ä½•å¤„ç†è¿™ä¸ªå¤–é”®å…³è”çš„è¡¨ï¼Œæ€»ä¹‹ä¿æŒé»˜è®¤å€¼å°±è¡Œäº†ã€‚&lt;/p>
&lt;p>è¿™ä¸ªåŠŸèƒ½æ”¯æŒäº†ä½¿ç”¨è‡ªå®šä¹‰çš„ç”¨æˆ·æ¨¡å‹æ›¿ä»£ &lt;code>django.auth.models.User&lt;/code> ä¹‹ç±»çš„ç©æ„å„¿ã€‚&lt;/p>
&lt;h2 id="2-onetoonefield">2. OneToOneField&lt;/h2>
&lt;p>&lt;code>OneToOneField&lt;/code> åŸºæœ¬å°±æ˜¯ä¸€ä¸ªåŠ äº†&lt;code>unique&lt;/code>çº¦æŸçš„&lt;code>ForeignKey&lt;/code>ã€‚ä½¿ç”¨ä¸Šä¸ ForeignKey ç•¥æœ‰ä¸åŒã€‚&lt;/p>
&lt;p>é¦–å…ˆæ˜¯è®¿é—® &lt;code>OneToOneField&lt;/code> æ—¶ï¼Œå¾—åˆ°çš„ä¸æ˜¯ &lt;code>QuerySet&lt;/code> è€Œæ˜¯ä¸€ä¸ªå¯¹è±¡å®ä¾‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="c1"># ä¼˜ç”Ÿä¼˜è‚²æ”¿ç­–ï¼ˆ&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">Parent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">models&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Model&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">child&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">OneToOneField&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Child&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">Child&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">models&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Model&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="k">pass&lt;/span>
&lt;span class="n">parent&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">child&lt;/span> &lt;span class="c1"># =&amp;gt; å¾—åˆ°ä¸€ä¸ª Child å®ä¾‹&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…¶æ¬¡æ˜¯åå‘å¼•ç”¨çš„åå­—æ˜¯æ¨¡å‹åå­—å°å†™ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">child&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parent&lt;/span> &lt;span class="c1"># =&amp;gt; å¾—åˆ°ä¸€ä¸ª Parent å®ä¾‹&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦‚æœæŒ‡å®š &lt;code>related_name&lt;/code> é‚£å°±å’Œ &lt;code>ForeignKey&lt;/code> ä¸€ä¸ªè¡¨ç°ã€‚&lt;/p>
&lt;h2 id="3-manytomanyfield">3. ManyToManyField&lt;/h2>
&lt;p>åŸºæœ¬å’Œ&lt;code>ForeignKey&lt;/code>ç›¸åŒã€‚&lt;/p>
&lt;h3 id="31-å’Œ-foreignkey-ç›¸åŒçš„å‚æ•°">3.1 å’Œ &lt;code>ForeignKey&lt;/code> ç›¸åŒçš„å‚æ•°&lt;/h3>
&lt;ul>
&lt;li>related_name&lt;/li>
&lt;li>related_query_name&lt;/li>
&lt;li>limited_choices_to&lt;/li>
&lt;li>db_constraint&lt;/li>
&lt;li>swappable&lt;/li>
&lt;/ul>
&lt;p>limited_choices_to åœ¨æŒ‡å®šè‡ªå®šä¹‰ä¸­é—´è¡¨çš„æƒ…å†µä¸‹æ— æ•ˆã€‚&lt;/p>
&lt;h3 id="32-å‚æ•°symmetrical">3.2 å‚æ•°ï¼šsymmetrical&lt;/h3>
&lt;p>ç”¨äºå¤„ç†ä¸€ä¸ªè¡¨è‡ªå·±å¯¹è‡ªå·±çš„å¤šå¯¹å¤šå¼•ç”¨å¯¹ç§°æ€§ã€‚&lt;/p>
&lt;p>Django çš„é»˜è®¤è¡Œä¸ºæ˜¯ï¼Œæˆ‘æ˜¯ä½ çš„æœ‹å‹ï¼Œé‚£ä¹ˆä½ å°±æ˜¯æˆ‘çš„æœ‹å‹ã€‚&lt;/p>
&lt;p>è®¾ç½®äº†è¿™ä¸ªå‚æ•°åˆ™å¼ºè¿« Django æ”¹å˜è¿™ä¸ªè¡Œä¸ºï¼Œå…è®¸â€œè¢«æœ‹å‹â€ã€‚&lt;/p>
&lt;h3 id="33-å‚æ•°through">3.3 å‚æ•°ï¼šthrough&lt;/h3>
&lt;p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒDjango ä¼šè‡ªè¡Œåˆ›å»ºä¸­é—´è¡¨ï¼Œè¿™ä¸ªå‚æ•°å¼ºåˆ¶æŒ‡å®šä¸­é—´è¡¨ã€‚&lt;/p>
&lt;p>é»˜è®¤ä¸­é—´è¡¨æ¨¡å‹é‡ŒåŒ…å«ä¸‰ä¸ªå­—æ®µã€‚&lt;/p>
&lt;ul>
&lt;li>id&lt;/li>
&lt;li>&amp;lt;containing_model&amp;gt;_id&lt;/li>
&lt;li>&amp;lt;other_model&amp;gt;_id&lt;/li>
&lt;/ul>
&lt;p>å¦‚æœæ˜¯è‡ªå·±å’Œè‡ªå·±çš„å¤šå¯¹å¤šå…³ç³»ï¼Œåˆ™&lt;/p>
&lt;ul>
&lt;li>id&lt;/li>
&lt;li>from_&amp;lt;model&amp;gt;_id&lt;/li>
&lt;li>to_&amp;lt;model&amp;gt;_id&lt;/li>
&lt;/ul>
&lt;h3 id="34-å‚æ•°through_fields">3.4 å‚æ•°ï¼šthrough_fields&lt;/h3>
&lt;p>å½“è‡ªè¡ŒæŒ‡å®šä¸­é—´è¡¨ï¼Œä¸­é—´è¡¨åˆåŒ…å«äº†å¤šä¸ªå¤–é”®æ—¶ï¼ŒæŒ‡å®šå…³è”çš„å¤–é”®ç”¨ã€‚&lt;/p>
&lt;p>ä¸¾ä¾‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">class&lt;/span> &lt;span class="nc">ModelA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">models&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Model&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">b&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">models&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ManyToManyField&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ModelB&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">through&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;ModelC&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">ModelB&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">models&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Model&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="k">pass&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">ModelC&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">models&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Model&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">a&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">models&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ForeignKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;ModelA&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">b&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">models&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ForeignKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;ModelB&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">c&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">models&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ForeignKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;ModelA&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ­¤æ—¶åœ¨ä¸­é—´è¡¨ä¸­&lt;code>a&lt;/code>å’Œ&lt;code>c&lt;/code>éƒ½æ˜¯å¯¹&lt;code>ModelA&lt;/code>çš„å¤–é”®ï¼Œäº§ç”Ÿäº†æ­§ä¹‰ï¼ŒDjango æ— æ³•è‡ªè¡Œå†³å®šç”¨å“ªä¸ªå¤–é”®æ¥å…³è” AB ä¸¤ä¸ªè¡¨ã€‚&lt;/p>
&lt;p>è¿™æ—¶æä¾›å‚æ•°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">b&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">models&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ManyToManyField&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;ModelB&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">through&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;ModelC&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">through_fields&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">b&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>ManyToManyField&lt;/code> å…³è”ä¸¤ä¸ªè¡¨æ€»æ˜¯ä¸å¯¹ç§°çš„å…³ç³»ï¼ˆæŒ‡æˆ‘æŠŠä½ å½“å…„å¼Ÿï¼Œä½ å´æƒ³å½“æˆ‘çˆ¸çˆ¸è¿™æ ·çš„å…³ç³»ã€‚æ­¤æ—¶â€œæˆ‘â€å¯¹â€œä½ â€çš„â€œå…„å¼Ÿâ€å…³ç³»å°±æ˜¯å•å‘çš„ã€‚ï¼‰ï¼Œè¿™å°±å½¢æˆäº†&lt;strong>æ¥æº&lt;/strong>å’Œ&lt;strong>ç›®æ ‡&lt;/strong>çš„æ¦‚å¿µã€‚&lt;/p>
&lt;p>&lt;code>through_fields&lt;/code> çš„ç¬¬ä¸€ä¸ªå…ƒç´ æ€»è¢«è®¤ä¸ºæ˜¯&lt;strong>æ¥æº&lt;/strong>å­—æ®µï¼Œç¬¬äºŒä¸ªå…ƒç´ æ˜¯&lt;strong>ç›®æ ‡&lt;/strong>å­—æ®µã€‚&lt;/p>
&lt;h3 id="35-å‚æ•°db_table">3.5 å‚æ•°ï¼šdb_table&lt;/h3>
&lt;p>æŒ‡å®š Django åˆ›å»ºçš„ä¸­é—´è¡¨çš„åå­—ï¼Œé»˜è®¤æ ¹æ®ä¸¤ä¸ªè¡¨è¡¨åå’Œ &lt;code>ManyToManyField&lt;/code> çš„åå­—å†³å®šã€‚&lt;/p></description></item><item><title>è½»é‡çº§ django é˜…è¯»ç¬”è®°ï¼šæœ€å°çš„ django åº”ç”¨</title><link>https://nnnewb.github.io/blog/p/%E8%BD%BB%E9%87%8F%E7%BA%A7-django-%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%E6%9C%80%E5%B0%8F%E7%9A%84-django-%E5%BA%94%E7%94%A8/</link><pubDate>Sun, 03 Mar 2019 12:26:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/%E8%BD%BB%E9%87%8F%E7%BA%A7-django-%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%E6%9C%80%E5%B0%8F%E7%9A%84-django-%E5%BA%94%E7%94%A8/</guid><description>&lt;h2 id="intro">Intro&lt;/h2>
&lt;p>æ‰¾ä¸åˆ°å·¥ä½œååˆ†éš¾å—ï¼Œåœ¨å®¶çœ‹ä¹¦ï¼Œæ°å·§ç¿»åˆ°è¿™æœ¬ã€Šè½»é‡çº§ Djangoã€‹ï¼Œçœ‹èµ·æ¥è¿˜è›®æœ‰æ„æ€çš„ï¼Œåšä¸ªè¯»ä¹¦ç¬”è®°ã€‚&lt;/p>
&lt;h2 id="1-æœ€å°çš„-django-app">1. æœ€å°çš„ Django App&lt;/h2>
&lt;p>Django æ˜¯ä¸ªé‡é‡çº§æ¡†æ¶ï¼Œæ‰€è°“æœ€å°æŒ‡çš„æ˜¯å†™æœ€å°‘çš„ä»£ç ï¼Œç†è§£ä¸€ä¸ª Django App çš„æœ€å°ç»„æˆå…ƒç´ ã€‚&lt;/p>
&lt;p>ä½œä¸ºå¼€åœºï¼Œå…ˆåˆ›å»ºä¸€ä¸ª &lt;code>app.py&lt;/code> æ–‡ä»¶ï¼Œä½œä¸ºæ•´ä¸ª Django App å­˜å‚¨çš„åœ°æ–¹ã€‚&lt;/p>
&lt;h3 id="11-djangoconfsettings">1.1 django.conf.settings&lt;/h3>
&lt;p>ä¹¦ä¸­ä½¿ç”¨ &lt;code>django.core.management.execute_from_command_line&lt;/code> ä½œä¸ºå¯åŠ¨ Django app çš„æ‰‹æ®µã€‚&lt;/p>
&lt;p>&lt;code>execute_from_command_line&lt;/code>ï¼Œå°±æ˜¯é€šè¿‡ &lt;code>django startproject&lt;/code>çš„æ–¹å¼åˆ›å»ºçš„&lt;code>manage.py&lt;/code>å†…çš„ä¸»è¦å†…å®¹ï¼Œè¿™ç§æ–¹å¼å¯åŠ¨å¿…é¡»è¦é…ç½®&lt;code>settings&lt;/code>æ‰è¡Œã€‚&lt;/p>
&lt;p>åœ¨ä¸€ä¸ªå¸¸è§„æ–¹å¼åˆ›å»ºçš„ Django App ä¸­ï¼Œ&lt;code>settings.py&lt;/code>æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ python æ¨¡å—ï¼Œ&lt;code>Django&lt;/code>é€šè¿‡&lt;code>DJANGO_SETTINGS_MODULE&lt;/code>è¿™ä¸ªç¯å¢ƒå˜é‡æ¥ç¡®å®šé…ç½®ä¿¡æ¯å­˜å‚¨ä½ç½®ã€‚&lt;/p>
&lt;p>ä½†æ˜¯æ¢ä¸€ç§æ–¹å¼ï¼Œ&lt;code>django.conf.settings.configure()&lt;/code>å¯ä»¥æ‰‹åŠ¨å®Œæˆé…ç½®ã€‚&lt;/p>
&lt;p>çœ‹ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="kn">from&lt;/span> &lt;span class="nn">django.conf&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">settings&lt;/span>
&lt;span class="n">settings&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">configure&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">DEBUG&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ROOT_URLCONF&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="vm">__name__&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¯ä¸€ä¸ª keyword argument éƒ½å’Œ &lt;code>settings.py&lt;/code>è¿™ä¸ªæ¨¡å—å†…çš„åå­—ç›¸åŒï¼Œå»é™¤æ‰€æœ‰ä¸å¿…è¦çš„å…ƒç´ ä¹‹åï¼Œå‰©ä¸‹çš„å°±æ˜¯&lt;code>DEBUG&lt;/code>å’Œ&lt;code>ROOT_URLCONF&lt;/code>äº†ã€‚&lt;/p>
&lt;p>é˜…è¯»æºç å¯çŸ¥&lt;code>configure&lt;/code>åªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="c1"># æ‘˜è‡ª django.conf.settings.configure æºç &lt;/span>
&lt;span class="c1"># Django ç‰ˆæœ¬å·:&lt;/span>
&lt;span class="c1"># VERSION = (2, 1, 7, &amp;#39;final&amp;#39;, 0)&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">configure&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">default_settings&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">global_settings&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">options&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;
&lt;/span>&lt;span class="s2"> Called to manually configure the settings. The &amp;#39;default_settings&amp;#39;
&lt;/span>&lt;span class="s2"> parameter sets where to retrieve any unspecified values from (its
&lt;/span>&lt;span class="s2"> argument must support attribute access (__getattr__)).
&lt;/span>&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_wrapped&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">empty&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">raise&lt;/span> &lt;span class="ne">RuntimeError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Settings already configured.&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">holder&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">UserSettingsHolder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">default_settings&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">value&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">options&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">items&lt;/span>&lt;span class="p">():&lt;/span>
&lt;span class="nb">setattr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">holder&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_wrapped&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">holder&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="12-urlpatterns">1.2 urlpatterns&lt;/h3>
&lt;p>éƒ½çŸ¥é“ &lt;code>Django&lt;/code> çš„è·¯ç”±æ˜¯éœ€è¦æ‰‹åŠ¨å†™æ˜çš„ï¼Œå’Œ&lt;code>flask&lt;/code>ç­‰ä»¥è£…é¥°å™¨çš„æ–¹å¼é…ç½®è·¯ç”±çš„é£æ ¼è¿¥å¼‚ã€‚å“ªç§é£æ ¼æ›´å¥½ï¼Œå°±çœ‹ç”¨æˆ·è‡ªå·±è§ä»è§æ™ºäº†ã€‚&lt;/p>
&lt;p>ä¸Šæ–‡çš„&lt;code>settings.configure&lt;/code>ä¸­å¯ä»¥çœ‹åˆ°æœ‰ä¸€å¥&lt;code>ROOT_URLCONF=__name__&lt;/code>ï¼Œæ„ä¹‰æ˜ç¡®ï¼Œå°±æ˜¯æŒ‡å®šå“ªä¸ª python æ¨¡å—ä¿å­˜äº†è·¯ç”±é…ç½®ä¿¡æ¯ï¼Œè€Œè¿™é‡ŒæŒ‡å®šçš„&lt;code>__name__&lt;/code>æ­£æ˜¯è‡ªå·±ã€‚&lt;/p>
&lt;p>æ‰€ä»¥æˆ‘ä»¬çš„&lt;code>urlpatterns&lt;/code>ä¹Ÿåº”å½“å¦‚é…ç½®æ‰€è¿°ï¼Œå†™åˆ°è¿™ä¸ªæ–‡ä»¶ä¸­ã€‚&lt;/p>
&lt;p>è§ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="kn">from&lt;/span> &lt;span class="nn">django.urls&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">path&lt;/span>
&lt;span class="kn">from&lt;/span> &lt;span class="nn">django.http&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">HttpResponse&lt;/span>
&lt;span class="n">urlpatterns&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">lambda&lt;/span> &lt;span class="n">req&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">HttpResponse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Hello world&amp;#39;&lt;/span>&lt;span class="p">))]&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="13-__main__">1.3 &lt;code>__main__&lt;/code>&lt;/h3>
&lt;p>æœ€åå°†æ‰€æœ‰çš„ä»£ç æ•´åˆèµ·æ¥ï¼Œå°±å½¢æˆäº†è¿™æ ·ä¸€ä¸ª python ç¨‹åºã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="kn">import&lt;/span> &lt;span class="nn">sys&lt;/span>
&lt;span class="kn">from&lt;/span> &lt;span class="nn">django.conf&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">settings&lt;/span>
&lt;span class="kn">from&lt;/span> &lt;span class="nn">django.core.management&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">execute_from_command_line&lt;/span>
&lt;span class="kn">from&lt;/span> &lt;span class="nn">django.http&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">HttpResponse&lt;/span>
&lt;span class="kn">from&lt;/span> &lt;span class="nn">django.urls&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">path&lt;/span>
&lt;span class="n">settings&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">configure&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">DEBUG&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ROOT_URLCONF&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="vm">__name__&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">)&lt;/span>
&lt;span class="n">urlpatterns&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">lambda&lt;/span> &lt;span class="n">req&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">HttpResponse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Hello world&amp;#39;&lt;/span>&lt;span class="p">))]&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="vm">__name__&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;__main__&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">execute_from_command_line&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç®—ä¸Šæ‰€æœ‰çš„ import åœ¨å†…å…± 12 è¡Œï¼Œ4 è¡Œç©ºè¡Œï¼Œ5 è¡Œ importï¼Œ3 è¡Œä»£ç ï¼Œå³æ„æˆäº†ä¸€ä¸ªéº»é›€è™½å°äº”è„ä¿±å…¨çš„ Django hello worldã€‚&lt;/p>
&lt;p>åœ¨å‘½ä»¤è¡Œæ‰§è¡Œ&lt;code>python app.py runserver&lt;/code>å³å¯çœ‹åˆ°ä»¥ä¸‹è¾“å‡ºã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">PS&lt;/span> &lt;span class="n">D&lt;/span>&lt;span class="p">:&lt;/span>\&lt;span class="n">GitHub&lt;/span>\&lt;span class="n">minimum&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">django&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">python&lt;/span> &lt;span class="o">.&lt;/span>\&lt;span class="n">app&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">py&lt;/span> &lt;span class="n">runserver&lt;/span>
&lt;span class="n">Performing&lt;/span> &lt;span class="n">system&lt;/span> &lt;span class="n">checks&lt;/span>&lt;span class="o">...&lt;/span>
&lt;span class="n">System&lt;/span> &lt;span class="n">check&lt;/span> &lt;span class="n">identified&lt;/span> &lt;span class="n">no&lt;/span> &lt;span class="n">issues&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span> &lt;span class="n">silenced&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>
&lt;span class="n">March&lt;/span> &lt;span class="mi">03&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2019&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">12&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">21&lt;/span>
&lt;span class="n">Django&lt;/span> &lt;span class="n">version&lt;/span> &lt;span class="mf">2.1.7&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">using&lt;/span> &lt;span class="n">settings&lt;/span> &lt;span class="kc">None&lt;/span>
&lt;span class="n">Starting&lt;/span> &lt;span class="n">development&lt;/span> &lt;span class="n">server&lt;/span> &lt;span class="n">at&lt;/span> &lt;span class="n">http&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="mf">127.0.0.1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">8000&lt;/span>&lt;span class="o">/&lt;/span>
&lt;span class="n">Quit&lt;/span> &lt;span class="n">the&lt;/span> &lt;span class="n">server&lt;/span> &lt;span class="k">with&lt;/span> &lt;span class="n">CTRL&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">BREAK&lt;/span>&lt;span class="o">.&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="14-wsgi">1.4 wsgi&lt;/h3>
&lt;p>å®Œæˆäº†æœ€å°çš„ django appï¼Œä¾ç„¶æœ‰ä¸€ä¸ªé—®é¢˜ã€‚&lt;/p>
&lt;p>å¦‚ä½•éƒ¨ç½²è¿™ä¸ª django appï¼Ÿ&lt;/p>
&lt;p>å›ºç„¶ï¼Œä½¿ç”¨ runserver çš„æ–¹å¼æ‰§è¡Œï¼Œå† nginx åå‘ä»£ç†æ˜¯ä¸€ä¸ªä¸é”™çš„ä¸»æ„ï¼Œä½† uwsgi ä¹‹ç±»çš„éƒ¨ç½²æ–¹å¼ä¾ç„¶æœ‰å…¶ç‹¬åˆ°çš„ä¼˜åŠ¿ã€‚&lt;/p>
&lt;p>ä½¿ç”¨ uwsgi æˆ–è€… gunicorn ä¹‹ç±»çš„åŸºäº wsgi åè®®çš„æœåŠ¡å™¨å°±å¿…é¡»å–å¾—ä¸€ä¸ª wsgi app å®ä¾‹æ‰è¡Œã€‚&lt;/p>
&lt;p>Django æä¾›äº†å‡½æ•° &lt;code>django.core.wsgi.get_wsgi_application&lt;/code> ç”¨äºå–å¾— wsgi appã€‚&lt;/p>
&lt;p>æ‰‹å¤´æ²¡ linux æœºå™¨ï¼Œæ‡’å¾—æ¼”ç¤º output äº†ã€‚å°±è¿™æ ·å§ã€‚&lt;/p>
&lt;p>æœ€ç»ˆä»£ç å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="kn">import&lt;/span> &lt;span class="nn">sys&lt;/span>
&lt;span class="kn">from&lt;/span> &lt;span class="nn">django.conf&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">settings&lt;/span>
&lt;span class="kn">from&lt;/span> &lt;span class="nn">django.core.management&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">execute_from_command_line&lt;/span>
&lt;span class="kn">from&lt;/span> &lt;span class="nn">django.core.wsgi&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">get_wsgi_application&lt;/span>
&lt;span class="kn">from&lt;/span> &lt;span class="nn">django.http&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">HttpResponse&lt;/span>
&lt;span class="kn">from&lt;/span> &lt;span class="nn">django.urls&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">path&lt;/span>
&lt;span class="n">settings&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">configure&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">DEBUG&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ROOT_URLCONF&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="vm">__name__&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">)&lt;/span>
&lt;span class="n">urlpatterns&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">lambda&lt;/span> &lt;span class="n">req&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">HttpResponse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Hello world&amp;#39;&lt;/span>&lt;span class="p">))]&lt;/span>
&lt;span class="n">application&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">get_wsgi_application&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="vm">__name__&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;__main__&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">execute_from_command_line&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½¿ç”¨&lt;code>gunicorn app.py --log-file=-&lt;/code>å¯åŠ¨ã€‚&lt;/p></description></item><item><title>sqlalchemy å„ç§è¡¨å…³ç³»</title><link>https://nnnewb.github.io/blog/p/sqlalchemy-%E5%90%84%E7%A7%8D%E8%A1%A8%E5%85%B3%E7%B3%BB/</link><pubDate>Fri, 01 Mar 2019 15:52:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/sqlalchemy-%E5%90%84%E7%A7%8D%E8%A1%A8%E5%85%B3%E7%B3%BB/</guid><description>&lt;h2 id="æ³¨æ„äº‹é¡¹">æ³¨æ„äº‹é¡¹&lt;/h2>
&lt;h3 id="foreignkey">ForeignKey&lt;/h3>
&lt;p>&lt;code>db.ForeginKey&lt;/code>çš„å‚æ•°æ˜¯&lt;code>&amp;lt;è¡¨å&amp;gt;.&amp;lt;é”®å&amp;gt;&lt;/code>ï¼Œè€Œä¸æ˜¯&lt;code>&amp;lt;ç±»å&amp;gt;.&amp;lt;å­—æ®µå&amp;gt;&lt;/code>ï¼ŒåŠ¡å¿…æ³¨æ„è¿™ä¸ªåŒºåˆ«ã€‚&lt;/p>
&lt;h3 id="back_populates-å’Œ-backref-åœ¨å¤šå¯¹å¤šå…³ç³»ä¸­ä½¿ç”¨çš„åŒºåˆ«">back_populates å’Œ backref åœ¨å¤šå¯¹å¤šå…³ç³»ä¸­ä½¿ç”¨çš„åŒºåˆ«&lt;/h3>
&lt;p>&lt;code>back_populates&lt;/code>æ˜¯æ›´æ¨èçš„å†™æ³•ã€‚&lt;/p>
&lt;p>å¤šå¯¹å¤šå…³ç³»ä¸­ä½¿ç”¨&lt;code>backref&lt;/code>å¹¶æŒ‡å®šäº†&lt;code>secondary&lt;/code>çš„è¯ï¼Œå¦ä¸€å¼ è¡¨å…³è”çš„&lt;code>relationship&lt;/code>å­—æ®µä¼šä½¿ç”¨ç›¸åŒçš„&lt;code>secondary&lt;/code>ã€‚&lt;/p>
&lt;p>&lt;code>back_populates&lt;/code>åˆ™éœ€è¦åœ¨ä¸¤å¼ è¡¨çš„&lt;code>relationship&lt;/code>ä¸­éƒ½å†™ä¸Šç›¸åŒçš„&lt;code>secondary&lt;/code>ä¸­é—´è¡¨ã€‚&lt;/p>
&lt;h3 id="å¯è°ƒç”¨çš„-secondary">å¯è°ƒç”¨çš„ secondary&lt;/h3>
&lt;p>&lt;code>secondary&lt;/code>å‚æ•°å¯ä»¥æ˜¯ä¸€ä¸ªå¯è°ƒç”¨å¯¹è±¡ï¼Œåšä¸€äº› trick çš„æ—¶å€™åº”è¯¥æœ‰ç”¨ã€‚å§‘ä¸”è®°ä¸‹ã€‚&lt;/p>
&lt;h2 id="ä¸€å¯¹å¤šå…³ç³»">ä¸€å¯¹å¤šå…³ç³»&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">class&lt;/span> &lt;span class="nc">Parent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Base&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">__tablename__&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;parent&amp;#39;&lt;/span>
&lt;span class="nb">id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Column&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">primary_key&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">child&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">relationship&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Child&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">back_populates&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;parent&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">Child&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Base&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">__tablename__&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;child&amp;#39;&lt;/span>
&lt;span class="nb">id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Column&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">primary_key&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">parent_id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Column&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ForeignKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;parent.id&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="n">parent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">relationship&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Parent&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">back_populates&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;child&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>parent&lt;/code>åŒ…å«å¤šä¸ª&lt;code>child&lt;/code>çš„ä¸€å¯¹å¤šå…³ç³»ã€‚&lt;code>child&lt;/code>é‡Œå†™&lt;code>ForeignKey&lt;/code>ä¸º&lt;code>parent&lt;/code>çš„ä¸»é”®ï¼Œ&lt;code>child&lt;/code>é‡Œå†™&lt;code>relationship&lt;/code>ï¼Œ&lt;code>parent&lt;/code>é‡ŒåŒæ ·å†™&lt;code>relationship&lt;/code>ï¼Œ&lt;code>back_populates&lt;/code>å¡«å……ä¸Šï¼Œå®Œäº‹ã€‚&lt;/p>
&lt;h2 id="ä¸€å¯¹ä¸€å…³ç³»">ä¸€å¯¹ä¸€å…³ç³»&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">class&lt;/span> &lt;span class="nc">Parent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Base&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">__tablename__&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;parent&amp;#39;&lt;/span>
&lt;span class="nb">id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Column&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">primary_key&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">child&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">relationship&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Child&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">uselist&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">False&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">back_populates&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;parent&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">Child&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Base&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">__tablename__&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;child&amp;#39;&lt;/span>
&lt;span class="nb">id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Column&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">primary_key&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">parent_id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Column&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ForeignKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;parent.id&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="n">parent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">relationship&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Parent&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">back_populates&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;child&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸€å¯¹ä¸€å…³ç³»ä¸­&lt;code>parent&lt;/code>éœ€è¦åœ¨&lt;code>relationship&lt;/code>é‡ŒåŠ å…¥å‚æ•°&lt;code>uselist&lt;/code>ï¼Œå…¶ä»–ç›¸åŒï¼Œå®Œäº‹å„¿ã€‚&lt;/p>
&lt;h2 id="å¤šå¯¹å¤šå…³ç³»">å¤šå¯¹å¤šå…³ç³»&lt;/h2>
&lt;p>å¤šå¯¹å¤šå…³ç³»éœ€è¦ä¸€ä¸ªä¸­é—´è¡¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">association_table&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Table&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;association&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Base&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">metadata&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="n">Column&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;left_id&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Integer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ForeignKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;left.id&amp;#39;&lt;/span>&lt;span class="p">)),&lt;/span>
&lt;span class="n">Column&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;right_id&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Integer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ForeignKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;right.id&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">Parent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Base&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">__tablename__&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;left&amp;#39;&lt;/span>
&lt;span class="nb">id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Column&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">primary_key&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">children&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">relationship&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="s2">&amp;#34;Child&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="n">secondary&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">association_table&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="n">back_populates&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;parents&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">Child&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Base&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">__tablename__&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;right&amp;#39;&lt;/span>
&lt;span class="nb">id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Column&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">primary_key&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">parents&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">relationship&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="s2">&amp;#34;Parent&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="n">secondary&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">association_table&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="n">back_populates&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;children&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸­é—´è¡¨é‡Œå†™ä¸Š&lt;code>parent&lt;/code>å’Œ&lt;code>child&lt;/code>çš„ä¸»é”®ä½œä¸º&lt;code>foreignkey&lt;/code>ï¼Œ&lt;code>parent&lt;/code>å’Œ&lt;code>child&lt;/code>é‡Œçš„&lt;code>relationship&lt;/code>åŠ å…¥å‚æ•°&lt;code>secondary&lt;/code>ï¼ŒæŒ‡å®šä¸ºä¸­é—´è¡¨ã€‚&lt;/p></description></item><item><title>åˆ©ç”¨ descriptor å®ç°è‡ªå·±çš„ property</title><link>https://nnnewb.github.io/blog/p/%E5%88%A9%E7%94%A8-descriptor-%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%B7%B1%E7%9A%84-property/</link><pubDate>Thu, 21 Feb 2019 17:53:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/%E5%88%A9%E7%94%A8-descriptor-%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%B7%B1%E7%9A%84-property/</guid><description>&lt;h2 id="1æ¦‚å¿µç®€ä»‹">1.æ¦‚å¿µç®€ä»‹&lt;/h2>
&lt;h3 id="11-property">1.1 property&lt;/h3>
&lt;p>åœ¨ python ä»£ç ä¸­ï¼Œproperty æ˜¯éå¸¸å¸¸è§çš„ä¸€ä¸ªå†…ç½®å‡½æ•°ã€‚property å¯ä»¥ä¸ºä¸€ä¸ª python ç±»çš„ attribute è®¾ç½® getter/setterï¼Œå¯ä»¥ç±»æ¯”ä¹‹ C# çš„ &lt;a class="link" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/language-reference/language-specification/classes#properties" target="_blank" rel="noopener"
>properties&lt;/a>ã€‚&lt;/p>
&lt;p>è§ä¸‹é¢çš„ä¾‹å­ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">class&lt;/span> &lt;span class="nc">A&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="fm">__init__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="nd">@property&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">hello&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">a&lt;/span>
&lt;span class="nd">@hello&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">setter&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">hell&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">value&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">A&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">hello&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1"># output:&lt;/span>
&lt;span class="c1"># 1&lt;/span>
&lt;span class="n">obj&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">A&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="n">obj&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">hello&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;hello world&amp;#34;&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">obj&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">hello&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1"># output:&lt;/span>
&lt;span class="c1"># hello world&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="12-descriptor">1.2 descriptor&lt;/h3>
&lt;p>python ä¸­çš„ descriptor æŒ‡çš„æ˜¯å®ç°äº†&lt;code>__get__&lt;/code>ã€&lt;code>__set__&lt;/code>ã€&lt;code>__delete__&lt;/code>ä¸‰ä¸ªæ–¹æ³•ä¹‹ä¸€çš„ç±»ã€‚&lt;/p>
&lt;p>å½“ä¸€ä¸ª descriptor ç±»çš„å®ä¾‹ä½œä¸ºå…¶ä»–ç±»çš„æˆå‘˜æ—¶ï¼Œé€šè¿‡&lt;code>obj.attr&lt;/code>è¯­æ³•è®¿é—®è¯¥å®ä¾‹å°†ä¼šè°ƒç”¨ descriptor å®ä¾‹çš„&lt;code>__get__&lt;/code>æ–¹æ³•ã€‚åŒç†ï¼Œ&lt;code>__set__&lt;/code>å’Œ&lt;code>__delete__&lt;/code>ä¹Ÿæ˜¯ç›¸ä¼¼çš„é€»è¾‘ã€‚&lt;/p>
&lt;p>å…ˆçœ‹ä¸ªä¾‹å­ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">class&lt;/span> &lt;span class="nc">DescriptorClass&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="fm">__get__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">instance&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">owner&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">owner&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s1">&amp;#39;some value&amp;#39;&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">SomeClass&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">some_attr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">DescriptorClass&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">SomeClass&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">some_attr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1"># output:&lt;/span>
&lt;span class="c1"># &amp;lt;__main__.DescriptorClass object at 0x0000027AAE777160&amp;gt;&lt;/span>
&lt;span class="c1"># &amp;lt;__main__.SomeClass object at 0x0000027AAE777198&amp;gt;&lt;/span>
&lt;span class="c1"># &amp;lt;class &amp;#39;__main__.SomeClass&amp;#39;&amp;gt;&lt;/span>
&lt;span class="c1"># some value&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="2-å®ç°">2. å®ç°&lt;/h2>
&lt;p>property çš„é€»è¾‘åœ¨äºï¼Œ&lt;strong>å½“å®ä¾‹è®¿é—®è¿™ä¸ªå±æ€§æ—¶ï¼Œè°ƒç”¨æ–¹æ³•&lt;/strong>ã€‚descriptor åˆšå¥½å¤„åœ¨é‚£ä¸ªæ­£ç¡®çš„ä½ç½®ä¸Šã€‚&lt;/p>
&lt;p>çœ‹ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">class&lt;/span> &lt;span class="nc">PropertyDescriptor&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="fm">__init__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">fn&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">getter&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fn&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="fm">__get__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">instance&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">owner&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">getter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="fm">__set__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">instance&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">setter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">setter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">func&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">setter&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">func&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">my_property&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">func&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">PropertyDescriptor&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">func&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">SimpleClass&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nd">@my_property&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">simple_attr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s1">&amp;#39;a simple property&amp;#39;&lt;/span>
&lt;span class="nd">@simple_attr&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">setter&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">simple_attr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;simple attr setter&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">SimpleClass&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">simple_attr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">SimpleClass&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">simple_attr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;something&amp;#39;&lt;/span>
&lt;span class="c1"># output:&lt;/span>
&lt;span class="c1"># a simple property&lt;/span>
&lt;span class="c1"># simple attr setter&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="3-æ€»ç»“">3. æ€»ç»“&lt;/h2>
&lt;blockquote>
&lt;p>ä¸ªäººçœ‹æ³•ï¼Œè°¨æ…å‚è€ƒ&lt;/p>
&lt;/blockquote>
&lt;p>descriptor é¿å…äº†é‡å¤ç¼–å†™&lt;code>getter&lt;/code>å’Œ&lt;code>setter&lt;/code>æ–¹æ³•ï¼Œéå¸¸ç›´è§‰çš„ä¸€ç§ç”¨é€”å°±æ˜¯ç±»ä¼¼äº&lt;code>SQLAlchemy&lt;/code>è¿™æ ·çš„ ORM æ¡†æ¶çš„çš„å­—æ®µæ˜ å°„ã€‚ä¸éœ€è¦ä¸ºæ¯ä¸€ä¸ªç‰¹å®šç±»å‹çš„å­—æ®µåœ¨åŸºç±»æˆ–å…ƒç±»é‡Œç¼–å†™å¤§é‡æ ·æ¿ä»£ç ã€‚&lt;/p>
&lt;p>ä½†è¿™ç§è®¾è®¡æ˜¯ä¾µå…¥å¼çš„ï¼ˆéœ€è¦ä¿®æ”¹ç›®æ ‡ç±»çš„ä»£ç ï¼‰ï¼Œè€Œä¸”éå¸¸ä¸ç›´è§‚ã€‚åœ¨åˆé€‚çš„åœ°æ–¹ä½¿ç”¨ç›¸ä¿¡å¯ä»¥æœ‰å…¶å‘å…‰å‘çƒ­çš„ç©ºé—´ã€‚&lt;/p>
&lt;p>å¯¹å¯è¯»æ€§æ¥è®²ï¼Œç»“åˆå…ƒç±»ï¼Œè¿™ä¿©è¢«ä¸€èµ·æ»¥ç”¨çš„è¯å¯¹ç»´æŠ¤è€…è€Œè¨€å®Œå…¨æ˜¯åœ°ç‹±å§&amp;hellip;&lt;/p></description></item><item><title>python3å…ƒç±»æ·±å…¥è§£è¯»</title><link>https://nnnewb.github.io/blog/p/python3%E5%85%83%E7%B1%BB%E6%B7%B1%E5%85%A5%E8%A7%A3%E8%AF%BB/</link><pubDate>Thu, 20 Dec 2018 19:46:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/python3%E5%85%83%E7%B1%BB%E6%B7%B1%E5%85%A5%E8%A7%A3%E8%AF%BB/</guid><description>&lt;h2 id="0-intro">0. intro&lt;/h2>
&lt;p>å…ƒç±»æ˜¯ python é‡Œè¢«è¯´çƒ‚äº†çš„ä¸€ä¸ªä¸œè¥¿ï¼Œç„¶è€Œæ—¥å¸¸ç”¨åˆ°çš„åœ°æ–¹å®åœ¨ä¸å¤šï¼Œæ¯æ¬¡æƒ³åˆ°éƒ½å¾—æŸ¥ä¸€ä¸‹è°·æ­Œï¼Œæƒ³æƒ³å¹²è„†åœ¨åšå®¢ç•™ä¸ªç¬”è®°å¥½äº†ã€‚&lt;/p>
&lt;p>å…ƒç±»çš„ä¸»è¦ç”¨é€”æ˜¯å®šåˆ¶&lt;strong>ç±»&lt;/strong>çš„äº§ç”Ÿè¿‡ç¨‹ï¼Œä»¥ä¾¿äºæ ¹æ®ç±»å£°æ˜åŒ…å«çš„ä¿¡æ¯æ¥åˆ›å»ºå‡ºä¸åŒçš„ç±»ã€‚&lt;/p>
&lt;h2 id="1-type">1. type&lt;/h2>
&lt;p>æåˆ°å…ƒç±»ä¸å¾—ä¸è¯´ä¸€ä¸‹ python çš„ç±»å‹ç³»ç»Ÿã€‚&lt;/p>
&lt;p>python çš„ class ä¹Ÿè¢«è§†ä½œä¸€ä¸ªå¯¹è±¡ï¼Œå®šåˆ¶ä¸€ä¸ª class çš„æ„é€ è¿‡ç¨‹å…¶å®å°±å’Œå¹³æ—¶åœ¨ class å®šä¹‰é‡Œå†™&lt;code>__init__&lt;/code>æ²¡å•¥åŒºåˆ«ã€‚&lt;/p>
&lt;p>python3 é‡Œç±»çš„ç±»å‹æ˜¯&lt;code>type&lt;/code>ï¼Œ&lt;code>type&lt;/code>åˆç»§æ‰¿è‡ª&lt;code>object&lt;/code>ï¼Œ&lt;code>object&lt;/code>çš„çˆ¶ç±»æ˜¯è‡ªå·±ï¼Œæ„æˆä¸€ä¸ªå¥‡æ€ªçš„é—­ç¯ã€‚å…¶ä¸­ï¼Œ&lt;code>type&lt;/code>æœ¬èº«æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ç±»ï¼Œä»–æ˜¯è‡ªå·±çš„å®ä¾‹ã€‚&lt;/p>
&lt;pre>&lt;code class="language-mermaid" data-lang="mermaid">graph TB;
type --&amp;gt; |inherite|object;
type --&amp;gt; |instance-of| type;
object --&amp;gt; |instance-of|type;
other-cls --&amp;gt; |instance-of| type;
other-cls --&amp;gt; |inherite| object;
other-cls-instance --&amp;gt; |instance-of|other-cls;
&lt;/code>&lt;/pre>&lt;p>&lt;code>type&lt;/code>æœ‰ä¸¤ç§è°ƒç”¨æ–¹å¼ï¼Œä¸€ç§æ˜¯æœ€å¸¸ç”¨çš„æ¥å—ä¸€ä¸ªå¯¹è±¡å‚æ•°ï¼Œè¿”å›è¯¥å¯¹è±¡çš„ç±»å‹ï¼Œå¦ä¸€ç§æ˜¯ä¸æ€ä¹ˆå¸¸ç”¨çš„ï¼Œç›´æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ç±»å‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="c1"># usage with one argument&lt;/span>
&lt;span class="nb">type&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">object&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># è¿”å›å¯¹è±¡çš„ç±»å‹ï¼Œè¿™é‡Œè¿”å›çš„æ˜¯ `type`&lt;/span>
&lt;span class="c1"># usage with three arguments&lt;/span>
&lt;span class="nb">type&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">bases&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">attr&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># è¿”å›æ–°åˆ›å»ºçš„ç±»å‹&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="2-meta-class">2. meta class&lt;/h2>
&lt;p>å…ƒç±»è¯­æ³•å¦‚ä¸‹&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">class&lt;/span> &lt;span class="nc">MyClass&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">basecls1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">basecls2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">metaclass&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">MetaClass&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">named1&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">arg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">named2&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">arg&lt;/span>&lt;span class="p">):&lt;/span> &lt;span class="o">...&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸€èˆ¬çš„å…ƒç±»å¯ä»¥æ˜¯ä¸€ä¸ªçœŸæ­£çš„&lt;code>class&lt;/code>æˆ–è€…ä¸€ä¸ªå‡½æ•°ã€‚&lt;/p>
&lt;p>ä»¥å‡½æ•°ä¸ºä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">def&lt;/span> &lt;span class="nf">meta_f&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">bases&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">attr&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">type&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">bases&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">attr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">A&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">metaclass&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">meta_f&lt;/span>&lt;span class="p">):&lt;/span> &lt;span class="o">...&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»¥ç±»ä¸ºä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">class&lt;/span> &lt;span class="nc">MetaC&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">type&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="fm">__new__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">mcs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">bases&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">attr&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">type&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="fm">__new__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">mcs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">bases&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">attr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">A&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">metaclass&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">MetaC&lt;/span>&lt;span class="p">):&lt;/span> &lt;span class="o">...&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…ƒç±»å¯ä»¥æ¥å—å‚æ•°ï¼Œå‚æ•°å¿…é¡»æ˜¯å‘½åçš„ï¼Œä¼ é€’å‚æ•°çš„æ–¹å¼æ˜¯å†™åœ¨ç±»å£°æ˜çš„ç»§æ‰¿åˆ—è¡¨é‡Œã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">def&lt;/span> &lt;span class="nf">meta&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">bases&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">attr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">named_arg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">optional_arg&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">type&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">bases&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">dict&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">**&lt;/span>&lt;span class="n">attr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">arg&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">named_arg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">option&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">optional_arg&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">A&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">metaclass&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">meta&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">named_arg&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;hi&amp;#34;&lt;/span>&lt;span class="p">):&lt;/span> &lt;span class="o">...&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">A&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">arg&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># output: hi&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½ç½®å‚æ•°éƒ½ä¼šè¢«å½“æˆç»§æ‰¿åˆ—è¡¨ï¼Œä½œä¸º&lt;code>bases&lt;/code>å‚æ•°(list)çš„ä¸€éƒ¨åˆ†ä¼ å…¥å…ƒç±»ã€‚&lt;/p>
&lt;h2 id="3-å…ƒç±»ç»§æ‰¿è§„åˆ™">3. å…ƒç±»ç»§æ‰¿è§„åˆ™&lt;/h2>
&lt;p>æœ‰äº†å…ƒç±»é‚£ä¹ˆå°±æœ‰äº†ç›¸åº”ç»§æ‰¿è§„åˆ™ï¼Œæ˜¾è€Œæ˜“è§ã€‚å…ƒç±»ç”¨äºæ„é€ ä¸€ä¸ªç±»ï¼Œä¸¤ä¸ªçˆ¶ç±»åˆ†åˆ«æœ‰ä¸€ä¸ªä¸åŒçš„å…ƒç±»æ˜¾ç„¶ä¼šé€ æˆå†²çªï¼šè¿™ä¸ªå­ç±»ç”¨å“ªä¸ªå…ƒç±»æ„é€ ï¼Ÿ&lt;/p>
&lt;p>é¦–å…ˆçœ‹å…ƒç±»çš„åœ¨åˆ›å»ºç±»çš„è¿‡ç¨‹ä¸­çš„ä½ç½®ï¼Œæ‘˜è‡ª python æ–‡æ¡£&lt;a class="link" href="https://docs.python.org/3/reference/datamodel.html#metaclasses" target="_blank" rel="noopener"
>3.3.3.1. Metaclasses&lt;/a>&lt;/p>
&lt;blockquote>
&lt;ul>
&lt;li>MRO entries are resolved&lt;/li>
&lt;li>the appropriate metaclass is determined&lt;/li>
&lt;li>the class namespace is prepared&lt;/li>
&lt;li>the class body is executed&lt;/li>
&lt;li>the class object is created&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>ä¸€æ—¦å¤„ç†å®Œç»§æ‰¿é“¾ï¼ˆmro, method resolve orderï¼‰ä¹‹åï¼Œå°±ä¼šå†³å®šé‡‡ç”¨å“ªä¸ª metaclass ä½œä¸ºæ„é€ è¿™ä¸ªç±»çš„å…ƒç±»ã€‚&lt;/p>
&lt;p>åœ¨ python æ–‡æ¡£çš„&lt;a class="link" href="https://docs.python.org/3/reference/datamodel.html#determining-the-appropriate-metaclass" target="_blank" rel="noopener"
>3.3.3.3 determining the appropriate metaclass&lt;/a>ä¸­æè¿°äº†å¦‚ä½•ç¡®å®šåˆé€‚çš„å…ƒç±»ï¼Œæ‘˜å½•å¦‚ä¸‹ã€‚&lt;/p>
&lt;blockquote>
&lt;ul>
&lt;li>if no bases and no explicit metaclass are given, then type() is used&lt;/li>
&lt;li>if an explicit metaclass is given and it is not an instance of type(), then it is used directly as the metaclass&lt;/li>
&lt;li>if an instance of type() is given as the explicit metaclass, or bases are defined, then the most derived metaclass is used&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>ç¿»è¯‘å¦‚ä¸‹&lt;/p>
&lt;ul>
&lt;li>å¦‚æœæ²¡æœ‰åŸºç±»ä¹Ÿæ²¡æœ‰æŒ‡å®š metaclassï¼Œé‚£ä¹ˆ&lt;code>type()&lt;/code>å°†ä½œä¸ºå…ƒç±»ä½¿ç”¨ã€‚&lt;/li>
&lt;li>å¦‚æœæŒ‡å®šäº†å…ƒç±»ï¼Œå¹¶ä¸”è¯¥å…ƒç±»ä¸æ˜¯ type çš„å®ä¾‹ï¼Œé‚£ä¹ˆç›´æ¥ä½¿ç”¨è¿™ä¸ªå…ƒç±»ã€‚&lt;/li>
&lt;li>å¦‚æœå…ƒç±»æ˜¯ä¸€ä¸ª type çš„å®ä¾‹ï¼Œæˆ–è€…å­˜åœ¨åŸºç±»ï¼Œé‚£ä¹ˆä½¿ç”¨æœ€è¡ç”Ÿçš„å…ƒç±»ã€‚&lt;/li>
&lt;/ul>
&lt;p>æœ‰ä¸€ä¸ªæ¯”è¾ƒéš¾ç†è§£çš„ç‚¹æ˜¯&lt;/p>
&lt;blockquote>
&lt;p>most derived metaclass&lt;/p>
&lt;/blockquote>
&lt;p>ä¹Ÿå°±æ˜¯æ‰€è°“çš„&lt;strong>æœ€è¡ç”Ÿçš„å…ƒç±»&lt;/strong>ã€‚æƒ¯ä¾‹ï¼Œå…ˆæ”¾æ–‡æ¡£è§£é‡Š&lt;/p>
&lt;blockquote>
&lt;p>The most derived metaclass is selected from the explicitly specified metaclass (if any) and the metaclasses (i.e. type(cls)) of all specified base classes. The most derived metaclass is one which is a subtype of all of these candidate metaclasses. If none of the candidate metaclasses meets that criterion, then the class definition will fail with TypeError.&lt;/p>
&lt;/blockquote>
&lt;p>ç®€å•ç¿»è¯‘å¦‚ä¸‹&lt;/p>
&lt;blockquote>
&lt;p>æœ€è¡ç”Ÿçš„å…ƒç±»ä¼šä»ç±»å£°æ˜ä¸­æ˜ç¡®æä¾›çš„å…ƒç±»ï¼Œè¿˜æœ‰æ‰€æœ‰æ˜ç¡®ç»§æ‰¿çš„åŸºç±»çš„å…ƒç±»ä¸­é€‰æ‹©ã€‚æœ€è¡ç”Ÿçš„å…ƒç±»æ˜¯ä»¥ä¸Šæ‰€æœ‰å€™é€‰å…ƒç±»çš„å­ç±»å‹ï¼Œå¦‚æœæ²¡æœ‰ç±»å‹ç¬¦åˆè¿™ä¸€æ¡ä»¶ï¼Œåˆ™æŠ›å‡º&lt;code>TypeError&lt;/code>å¼‚å¸¸ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>é‡ç‚¹åœ¨äºï¼Œ&lt;strong>æœ€è¡ç”Ÿçš„å…ƒç±»å¿…é¡»æ˜¯&lt;/strong>ï¼Œæ‰€æœ‰ç»§æ‰¿çš„åŸºç±»çš„å…ƒç±»å’ŒæŒ‡å®šå…ƒç±»çš„&lt;strong>å­ç±»å‹&lt;/strong>ã€‚&lt;/p>
&lt;p>åœ¨è¿™é‡Œæé†’ä¸€ä¸‹ï¼Œ&lt;code>issubclass(cls, cls)&lt;/code>çš„ç»“æœæ˜¯&lt;code>True&lt;/code>ã€‚æ¢å¥è¯è¯´ï¼Œå¿…é¡»æœ‰ä¸€ä¸ªç±»æ˜¯æ‰€æœ‰å…ƒç±»çš„å­ç±»ï¼Œæˆ–è€…æ‰€æœ‰åŸºç±»æœ‰ç›¸åŒçš„å…ƒç±»ã€‚&lt;/p>
&lt;p>ä»£ç ä¸¾ä¾‹å¦‚ä¸‹&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">class&lt;/span> &lt;span class="nc">MetaA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">type&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="fm">__new__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">mcs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">bases&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">attr&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;MetaA &amp;lt;- &amp;#39;&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">type&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="fm">__new__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">mcs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">bases&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">attr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">MetaB&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">type&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="fm">__new__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">mcs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">bases&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">attr&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;MetaB &amp;lt;- &amp;#39;&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">type&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="fm">__new__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">mcs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">bases&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">attr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">BaseA&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">...&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">BaseB&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">metaclass&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">MetaA&lt;/span>&lt;span class="p">):&lt;/span> &lt;span class="o">...&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">BaseC&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">metaclass&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">MetaB&lt;/span>&lt;span class="p">):&lt;/span> &lt;span class="o">...&lt;/span>
&lt;span class="c1"># æœªæŒ‡å®šå…ƒç±»ï¼ŒåŸºç±»å…ƒç±»åˆ†åˆ«æ˜¯typeå’Œtypeçš„å­ç±»ï¼Œåˆ™é€‰æ‹©ç»§æ‰¿é“¾åº•éƒ¨çš„é‚£ä¸ªç±»&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">A&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">BaseA&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">BaseB&lt;/span>&lt;span class="p">):&lt;/span> &lt;span class="o">...&lt;/span> &lt;span class="c1"># Ok,å…ƒç±»æ˜¯ MetaA&lt;/span>
&lt;span class="c1"># æŒ‡å®šå…ƒç±»ï¼Œå…ƒç±»å’ŒåŸºç±»å…ƒç±»ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œå…ƒç±»å°±æ˜¯é‚£ä¸ªå…ƒç±»&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">C&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">BaseB&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">metaclass&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">MetaA&lt;/span>&lt;span class="p">):&lt;/span> &lt;span class="o">...&lt;/span> &lt;span class="c1"># Okï¼Œå…ƒç±»æ˜¯ MetaA&lt;/span>
&lt;span class="c1"># æŒ‡å®šå…ƒç±»ï¼Œå…ƒç±»å¹¶ä¸å¤„äºç»§æ‰¿é“¾åº•ç«¯çš„æƒ…å†µä¸‹ï¼Œå…ƒç±»é€‰æ‹©ç»§æ‰¿é“¾åº•ç«¯çš„ç±»&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">D&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">BaseB&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">metaclass&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nb">type&lt;/span>&lt;span class="p">):&lt;/span> &lt;span class="o">...&lt;/span> &lt;span class="c1"># Okï¼Œå…ƒç±»æ˜¯ MetaA&lt;/span>
&lt;span class="c1"># æŒ‡å®šå…ƒç±»ï¼Œä½†å…ƒç±»å’Œçˆ¶ç±»æ— çˆ¶å­ç±»å…³ç³»&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">E&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">BaseC&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">metaclass&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">MetaA&lt;/span>&lt;span class="p">):&lt;/span> &lt;span class="o">...&lt;/span> &lt;span class="c1"># TypeError&lt;/span>
&lt;span class="c1"># ä¸æŒ‡å®šå…ƒç±»ï¼ŒåŸºç±»å…·æœ‰ä¸åŒçš„å…ƒç±»&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">F&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">BaseA&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">BaseB&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">BaseC&lt;/span>&lt;span class="p">):&lt;/span> &lt;span class="o">...&lt;/span> &lt;span class="c1"># TypeError&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¾“å‡ºå¦‚ä¸‹&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">MetaA &amp;lt;- A
MetaA &amp;lt;- C
MetaA &amp;lt;- D
In [71]: class E(BaseC, metaclass=MetaA): ... # TypeError
---------------------------------------------------------------------------
TypeError Traceback (most recent call last)
&amp;lt;ipython-input-71-9129a36c52b2&amp;gt; in &amp;lt;module&amp;gt;
----&amp;gt; 1 class E(BaseC, metaclass=MetaA): ... # TypeError
TypeError: metaclass conflict: the metaclass of a derived class must be a (non-strict) subclass of the metaclasses of all its bases
In [72]: class F(BaseA,BaseB,BaseC): ... # TypeError
---------------------------------------------------------------------------
TypeError Traceback (most recent call last)
&amp;lt;ipython-input-72-1c510edd69d1&amp;gt; in &amp;lt;module&amp;gt;
----&amp;gt; 1 class F(BaseA,BaseB,BaseC): ... # TypeError
TypeError: metaclass conflict: the metaclass of a derived class must be a (non-strict) subclass of the metaclasses of all its bases
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½†å…ƒç±»æ˜¯å‡½æ•°çš„æƒ…å†µä¸‹ä¼šæœ‰æ¯”è¾ƒç‰¹æ®Šçš„è¡¨ç°ï¼Œæ³¨æ„è§„åˆ™äºŒã€‚&lt;/p>
&lt;blockquote>
&lt;ul>
&lt;li>å¦‚æœæŒ‡å®šäº†å…ƒç±»ï¼Œå¹¶ä¸”è¯¥å…ƒç±»ä¸æ˜¯ type çš„å®ä¾‹ï¼Œé‚£ä¹ˆç›´æ¥ä½¿ç”¨è¿™ä¸ªå…ƒç±»ã€‚&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>å¦‚æœå‡½æ•°å½¢å¼çš„å…ƒç±»ä½œä¸ºçˆ¶ç±»çš„å…ƒç±»æ—¶ä¸ä¼šåˆ—å…¥é€‰æ‹©ï¼Œé™¤éæŒ‡å®šå½“å‰ç±»çš„å…ƒç±»ä¸ºå‡½æ•°ï¼Œæ‰ä¼šè°ƒç”¨å‡½æ•°å½¢å¼çš„å…ƒç±»ï¼Œè€Œä¸”æ˜¯æ— æ¡ä»¶é€‰æ‹©è¿™ä¸ªå‡½æ•°å½¢å¼çš„å…ƒç±»ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">def&lt;/span> &lt;span class="nf">MetaA&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">bases&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">attr&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;MetaA &amp;lt;- &amp;#34;&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">type&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">bases&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">attr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">MetaB&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">type&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="fm">__new__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">mcs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">bases&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">attr&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">type&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="fm">__new__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">mcs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">bases&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">attr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">A&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">MetaB&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">metaclass&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">MetaA&lt;/span>&lt;span class="p">):&lt;/span> &lt;span class="o">...&lt;/span> &lt;span class="c1"># Okï¼Œæ— æ¡ä»¶é€‰æ‹©å…ƒç±» MetaA&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>python å®ç° redis åˆ†å¸ƒå¼é”</title><link>https://nnnewb.github.io/blog/p/python-%E5%AE%9E%E7%8E%B0-redis-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/</link><pubDate>Mon, 17 Dec 2018 14:57:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/python-%E5%AE%9E%E7%8E%B0-redis-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/</guid><description>&lt;h2 id="intro">Intro&lt;/h2>
&lt;p>åˆ†å¸ƒå¼ä¸æ˜¯å•¥é»‘é­”æ³•ï¼Œç©¶å…¶ç†å¿µæ— éæ˜¯ç”¨å¤šå°æœåŠ¡å™¨å¤„ç†æ›´å¤šçš„è¯·æ±‚ã€‚æé«˜æ¯ç§’å¤„ç†çš„æ•°æ®é‡ï¼Œå¹¶å‘å°±ä¸å¯é¿å…äº†ã€‚&lt;/p>
&lt;p>åœ¨å•æœºå¹¶å‘çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ mutexï¼Œå¯ä»¥ç”¨ os çš„æ–‡ä»¶é”ï¼Œå…¨å±€é”ï¼Œå¤šå°æœåŠ¡å™¨çš„å¹¶å‘å°±éœ€è¦å¦ä¸€ä¸ªæŒæœ‰å¹¶ä¿æŠ¤é”çš„è§’è‰²äº†ã€‚&lt;/p>
&lt;p>æ¦‚è¿°å¦‚ä½•ä½¿ç”¨ redis å®ç°ä¸€ä¸ªåˆ†å¸ƒå¼é”ã€‚&lt;/p>
&lt;h2 id="ä¸ºä½•æ˜¯-lua">ä¸ºä½•æ˜¯ Lua&lt;/h2>
&lt;p>redis ä¿è¯äº† lua è§£é‡Šå™¨æ‰§è¡Œè„šæœ¬çš„äº‹åŠ¡æ€§ï¼Œå³æ‰§è¡Œç»“æœè¦ä¹ˆä¸å¯è§ï¼Œè¦ä¹ˆå·²å®Œæˆã€‚&lt;/p>
&lt;p>å‚è€ƒ&lt;a class="link" href="http://redisdoc.com/script/eval.html" target="_blank" rel="noopener"
>è¿™ç¯‡æ–‡æ¡£&lt;/a>ã€‚&lt;/p>
&lt;h2 id="ç®€å•é”">ç®€å•é”&lt;/h2>
&lt;p>ç®€å•é”æŒ‡çš„æ˜¯ç®€å•äº’æ–¥é”ï¼Œä¸€æ—¦é”å®šï¼Œåˆ™å…¶ä»–é”å®šè¯·æ±‚éƒ½å¿…é¡»ç­‰å¾…ã€‚&lt;/p>
&lt;h3 id="åŠ é”">åŠ é”&lt;/h3>
&lt;p>ç›´è§‰çš„æƒ³æ³•æ˜¯é€šè¿‡ redis çš„é”®æ¥ä¿æŒé”ï¼Œæ•…å‡†å¤‡ä¸€ä¸ªç”¨äºé”å®šäº’æ–¥çš„åå­—ï¼ˆæ¯”å¦‚è¯´ mutex-1ï¼‰ç„¶åæŒ‡å®šä¸ºé”®ã€‚&lt;/p>
&lt;p>ç›´æ¥ä½¿ç”¨ set æ˜¯æ˜¾ç„¶ä¸æ­£ç¡®çš„ï¼Œå¦‚æœä¸´ç•ŒåŒºå†…ç¨‹åºå´©æºƒæˆ–æ„å¤–æ–­ç½‘å°†å¯¼è‡´æ­»é”ï¼Œæ‰€ä»¥ setnx å’Œ expire æ˜¯å¿…é€‰é¡¹ã€‚&lt;/p>
&lt;p>åŠ é”éœ€è¦åˆ¤æ–­é”çš„é”®ä¸ºç©ºï¼Œæ‰èƒ½åŠ é”ï¼Œè¿™ä¸¤æ­¥å¿…é¡»ä¿è¯åŸå­æ€§ï¼Œè¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆä¸€ä¸ªéƒ½ä¸æ‰§è¡Œã€‚å¹¸å¥½ redis æä¾›äº†è¿™æ–¹é¢ä¿è¯ï¼Œåªè¦ä½¿ç”¨ lua è„šæœ¬çš„è¯ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="c1">-- åŠ é”&lt;/span>
&lt;span class="kr">if&lt;/span> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;get&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">KEYS&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;span class="kr">if&lt;/span> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;setnx&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">KEYS&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">ARGV&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;expire&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">KEYS&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">ARGV&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">])&lt;/span>
&lt;span class="kr">return&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="kr">else&lt;/span>
&lt;span class="kr">return&lt;/span>
&lt;span class="kr">end&lt;/span>
&lt;span class="kr">end&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸Šé¢çš„ lua ä»£ç ç”¨ python å†å°è£…ä¸€å±‚ï¼Œå°±æ˜¯è¿™æ ·&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">def&lt;/span> &lt;span class="nf">lock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">expire&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">redis&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">eval&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="s1">&amp;#39;&amp;#39;&amp;#39;
&lt;/span>&lt;span class="s1">-- åŠ é”
&lt;/span>&lt;span class="s1">if redis.call(&amp;#34;get&amp;#34;, KEYS[1]) == nil then
&lt;/span>&lt;span class="s1"> if redis.call(&amp;#34;setnx&amp;#34;, KEYS[1], ARGV[1]) ~= nil then
&lt;/span>&lt;span class="s1"> redis.call(&amp;#34;expire&amp;#34;, KEYS[1], ARGV[2])
&lt;/span>&lt;span class="s1"> return 1
&lt;/span>&lt;span class="s1"> else
&lt;/span>&lt;span class="s1"> return
&lt;/span>&lt;span class="s1"> end
&lt;/span>&lt;span class="s1">end
&lt;/span>&lt;span class="s1"> &amp;#39;&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;lock&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">expire&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="è§£é”">è§£é”&lt;/h3>
&lt;p>è§£é”ä»£ç åŒæ ·æ˜¯é€šè¿‡ lua å®ç°ã€‚&lt;/p>
&lt;p>ä¸‹é¢æ˜¯&lt;strong>é”™è¯¯å®ç°ä¾‹å­&lt;/strong>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="kr">return&lt;/span> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;del&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">KEYS&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>é”™è¯¯ä¹‹å¤„åœ¨äºä¼šè§£é™¤éè‡ªå·±åŠ çš„é”ã€‚å¦‚æœä¸´ç•ŒåŒºå†…çš„å·¥ä½œæ—¶é—´è¶…è¿‡é¢„æœŸæ—¶é—´ï¼Œé‚£ä¹ˆå°±ä¼šé€ æˆè¯¯è§£é”çš„é—®é¢˜ã€‚&lt;/p>
&lt;p>ä¸‹é¢æ˜¯&lt;strong>æ­£ç¡®ä¾‹å­&lt;/strong>ã€‚&lt;/p>
&lt;p>ä¸ºäº†æ ‡è®°é”æŒæœ‰è€…ï¼Œéœ€è¦ä¿®æ”¹åŠ é”ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">def&lt;/span> &lt;span class="nf">lock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">owner&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">expire&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">redis&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">eval&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="s1">&amp;#39;&amp;#39;&amp;#39;
&lt;/span>&lt;span class="s1">-- åŠ é”
&lt;/span>&lt;span class="s1">if redis.call(&amp;#34;get&amp;#34;, KEYS[1]) == nil then
&lt;/span>&lt;span class="s1"> if redis.call(&amp;#34;setnx&amp;#34;, KEYS[1], ARGV[1]) ~= nil then
&lt;/span>&lt;span class="s1"> redis.call(&amp;#34;expire&amp;#34;, KEYS[1], ARGV[2])
&lt;/span>&lt;span class="s1"> return 1
&lt;/span>&lt;span class="s1"> else
&lt;/span>&lt;span class="s1"> return
&lt;/span>&lt;span class="s1"> end
&lt;/span>&lt;span class="s1">end
&lt;/span>&lt;span class="s1"> &amp;#39;&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">owner&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">expire&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è§£é”çš„ lua ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="c1">-- è§£é”&lt;/span>
&lt;span class="kr">if&lt;/span> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;get&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">KEYS&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">ARGV&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;span class="kr">return&lt;/span> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;del&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">KEYS&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span>
&lt;span class="kr">else&lt;/span>
&lt;span class="kr">return&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="kr">end&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è§£é”çš„ python ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">def&lt;/span> &lt;span class="nf">unlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">lock&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">redis&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">eval&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="s1">&amp;#39;&amp;#39;&amp;#39;
&lt;/span>&lt;span class="s1">-- è§£é”
&lt;/span>&lt;span class="s1">if redis.call(&amp;#34;get&amp;#34;, KEYS[1]) == ARGV[1] then
&lt;/span>&lt;span class="s1"> return redis.call(&amp;#34;del&amp;#34;, KEYS[1])
&lt;/span>&lt;span class="s1">else
&lt;/span>&lt;span class="s1"> return 0
&lt;/span>&lt;span class="s1">end
&lt;/span>&lt;span class="s1"> &amp;#39;&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">lock&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="è¶…æ—¶å’Œä¸€è‡´æ€§">è¶…æ—¶å’Œä¸€è‡´æ€§&lt;/h3>
&lt;p>å…³äºè¶…æ—¶æœ‰è¿™æ ·ä¸€ä¸ªé—®é¢˜åœ¨ã€‚å¦‚æœè¶…æ—¶æ—¶é—´è¿‡é•¿ï¼Œé‚£ä¹ˆè¶…æ—¶çš„è®¾ç½®æ„ä¹‰å°±ä¸å¤§ï¼ŒæœåŠ¡å®•æœº 1 å°æ—¶å’Œå®•æœº 24 å°æ—¶éƒ½æ˜¯äº‹æ•…ã€‚å¦‚æœè¶…æ—¶æ—¶é—´è¿‡çŸ­ï¼Œé‚£ä¹ˆè¶…æ—¶å°±å¯èƒ½é€ æˆä¸€è‡´æ€§ä¸Šçš„æŸå®³ã€‚&lt;/p>
&lt;p>ä¸¾ä¾‹æ¥è¯´ï¼Œä»˜æ¬¾å¤„ç†èŠ±äº† 2.1sï¼Œä½†æ˜¯é”è¶…æ—¶ 2.0sã€‚è¿™ 0.1s çš„æ•°æ®ç«äº‰æ—¶é—´é‡Œï¼Œæ›´æ–°&lt;code>update balance where id = xxx&lt;/code>å’Œä¸‹ä¸€ä¸ªæ›´æ–° blance çš„è¯·æ±‚å°±æŒ‡ä¸å®šè°å…ˆæ‰§è¡Œäº†ã€‚&lt;/p>
&lt;pre>&lt;code class="language-mermaid" data-lang="mermaid">sequenceDiagram
participant ä»˜æ¬¾
participant æ±‡æ¬¾
participant é”
ä»˜æ¬¾-&amp;gt;&amp;gt;é”:è¯·æ±‚é”
é”--&amp;gt;&amp;gt;ä»˜æ¬¾:å·²é”å®š
æ±‡æ¬¾-&amp;gt;&amp;gt;é”:è¯·æ±‚é”
note over ä»˜æ¬¾,é”: é”åœ¨2ç§’åè¶…æ—¶ï¼Œä»˜æ¬¾ç¨‹åºåœ¨2.1ç§’åå®Œæˆ
note over é”: 2.0såˆ°äº†ï¼Œè¶…æ—¶è§£é”
é”--&amp;gt;&amp;gt;æ±‡æ¬¾:å·²é”å®š
note over ä»˜æ¬¾,æ±‡æ¬¾:æ•°æ®ç«äº‰
note over ä»˜æ¬¾:å®Œæˆã€‚
&lt;/code>&lt;/pre>&lt;p>æ‰€ä»¥ï¼Œè®¾ç½®äº†è¶…æ—¶ï¼Œé‚£ä¹ˆå¿…é¡»ä¿è¯ä¸€è‡´æ€§ï¼Œæ•´ä¸ªå¤„ç†è¦ä¹ˆå…¨éƒ¨å®Œæˆï¼Œè¦ä¹ˆè¶…æ—¶å…¨éƒ¨æœªå®Œæˆï¼Œå¯¹ç¼–ç¨‹èƒ½åŠ›æå‡ºäº†æŒ‘æˆ˜ã€‚&lt;/p>
&lt;p>åç»­å†æƒ³æƒ³èƒ½ä¸èƒ½å†™ç¯‡åšæ–‡ã€‚&lt;/p>
&lt;h2 id="è¯»å†™é”">è¯»å†™é”&lt;/h2>
&lt;p>è¯»å†™é”çš„å®ç°å’Œç®€å•é”åˆ«æ— äºŒè‡´ï¼Œç‰¹å¾æ˜¯å¤šä¸ªè¯»ï¼Œä¸€ä¸ªå†™ã€‚åœ¨å¤§é‡è¯»å–ï¼Œå°‘é‡å†™å…¥çš„æƒ…å†µä¸‹ï¼Œè¯»å†™é”å¯ä»¥æœ‰æ•ˆæé«˜æ•ˆç‡ã€‚&lt;/p>
&lt;h3 id="åŠ è¯»é”">åŠ è¯»é”&lt;/h3>
&lt;p>è¯»é”å®ç°å’Œç®€å•é”å·®åˆ«ä¸å¤§ï¼Œåœ¨ç®€å•é”åŸºç¡€ä¸Šç¨ä½œä¿®æ”¹å³å¯ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="c1">-- è¯»é”&lt;/span>
&lt;span class="kr">if&lt;/span> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;get&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">KEYS&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">..&lt;/span>&lt;span class="s2">&amp;#34;:write&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;span class="kr">return&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="kr">else&lt;/span>
&lt;span class="kr">return&lt;/span> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;hset&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">KEYS&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">..&lt;/span>&lt;span class="s2">&amp;#34;:read&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ARGV&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kr">end&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="åŠ å†™é”">åŠ å†™é”&lt;/h3>
&lt;p>å†™é”å®ç°å·®åˆ«ä¹Ÿä¸å¤§ï¼Œè¿™é‡Œä½¿ç”¨ hash table è§£å†³æ ‡è®°æŒæœ‰äººçš„é—®é¢˜ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="c1">-- å†™é”&lt;/span>
&lt;span class="kr">if&lt;/span> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;hlen&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">KEYS&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">..&lt;/span>&lt;span class="s2">&amp;#34;:read&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;span class="kr">return&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="kr">else&lt;/span>
&lt;span class="kr">return&lt;/span> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;setnx&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">KEYS&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">..&lt;/span>&lt;span class="s2">&amp;#34;:write&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ARGV&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span>
&lt;span class="kr">end&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="è§£è¯»é”">è§£è¯»é”&lt;/h3>
&lt;p>è¯»é”çš„è§£é™¤åªéœ€è¦åˆ é™¤ hash table é‡Œçš„è‡ªå·±å°±è¡Œäº†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="c1">-- è§£è¯»é”&lt;/span>
&lt;span class="kr">return&lt;/span> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;hdel&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">KEYS&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">..&lt;/span>&lt;span class="s2">&amp;#34;:read&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ARGV&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="è§£å†™é”">è§£å†™é”&lt;/h3>
&lt;p>å†™é”è§£é™¤å¦‚è§£é™¤ç®€å•é”ä¸€æ ·ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="c1">-- è§£é”&lt;/span>
&lt;span class="kr">if&lt;/span> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;get&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">KEYS&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">..&lt;/span>&lt;span class="s2">&amp;#34;:write&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">ARGV&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;span class="kr">return&lt;/span> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;del&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">KEYS&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">..&lt;/span>&lt;span class="s2">&amp;#34;:write&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kr">else&lt;/span>
&lt;span class="kr">return&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="kr">end&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>unity3d é”®ç›˜æ§åˆ¶ç§»åŠ¨</title><link>https://nnnewb.github.io/blog/p/unity3d-%E9%94%AE%E7%9B%98%E6%8E%A7%E5%88%B6%E7%A7%BB%E5%8A%A8/</link><pubDate>Mon, 17 Dec 2018 02:29:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/unity3d-%E9%94%AE%E7%9B%98%E6%8E%A7%E5%88%B6%E7%A7%BB%E5%8A%A8/</guid><description>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c#" data-lang="c#">&lt;span class="k">void&lt;/span> &lt;span class="n">HandleKeyboardAction&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="kt">var&lt;/span> &lt;span class="n">horizontal&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="n">Input&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">GetAxis&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Horizontal&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">PlayerMotionScaleLevel&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">Time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">deltaTime&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kt">var&lt;/span> &lt;span class="n">vertical&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="n">Input&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">GetAxis&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Vertical&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">PlayerMotionScaleLevel&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">Time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">deltaTime&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kt">var&lt;/span> &lt;span class="n">motion&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="n">transform&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">rotation&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Vector3&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">horizontal&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="m">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">vertical&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kt">var&lt;/span> &lt;span class="n">mag&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="n">motion&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">magnitude&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">motion&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="m">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">Player&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">transform&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">position&lt;/span> &lt;span class="p">+=&lt;/span> &lt;span class="n">motion&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">normalized&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">mag&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æå…¶ç®€å•çš„åšæ³•ï¼Œè·å–åˆ°é”®ç›˜ç§»åŠ¨çš„è½´ä¹‹åï¼Œç”¨æ‘„åƒæœºçš„æ—‹è½¬å››å…ƒæ•°ä¹˜ä¸€ä¸‹ï¼Œå³å¯å¾—åˆ°æ—‹è½¬åçš„å‘é‡ï¼ŒåŠ ä¸Šå»å°± ok äº†ã€‚&lt;/p>
&lt;p>éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œç”¨æ‘„åƒæœºçš„å››å…ƒæ•°æ—‹è½¬è¦æ±‚æ‘„åƒæœºå¿…é¡»åªåœ¨ x å’Œ y ä¸¤ä¸ªè½´æ—‹è½¬ã€‚&lt;/p>
&lt;p>å…ˆå¤‡ä»½ä¸€ä¸‹ä¸‰ç»´å‘é‡çš„æ•°é‡å€¼ï¼Œè¿™æ˜¯ä¸ºäº†èƒ½ä¿è¯æ‘„åƒæœºå‘ä¸Šå’Œå‘ä¸‹çœ‹æ—¶ï¼Œå¹³é¢ x å’Œ z è½´ä¸Šçš„åˆ†é‡ä¸ä¼šè¿‡å°ï¼Œä¿æŒä¸€è‡´çš„ç§»åŠ¨é€Ÿåº¦ã€‚&lt;/p>
&lt;p>ç”¨å››å…ƒæ•°æ—‹è½¬å®Œæˆåï¼Œå»é™¤ y è½´çš„å€¼ï¼Œä½¿ç›®æ ‡åªåœ¨å½“å‰å¹³é¢ä¸Šç§»åŠ¨ã€‚å†ç”¨ç®—å‡ºæ¥çš„å‘é‡çš„å•ä½å‘é‡ä¹˜ä¸Šä¹‹å‰å¤‡ä»½çš„æ•°é‡å€¼ï¼Œå¾—åˆ°å¹³é¢ä¸Šç§»åŠ¨çš„åç§»å‘é‡ã€‚&lt;/p>
&lt;p>æœ€åï¼Œç®—å‡ºæ–°çš„ä½ç½®åæ ‡ã€‚&lt;/p></description></item><item><title>goè¯­è¨€å®æˆ˜ä¹‹è§£å¯†onsè„šæœ¬</title><link>https://nnnewb.github.io/blog/p/go%E8%AF%AD%E8%A8%80%E5%AE%9E%E6%88%98%E4%B9%8B%E8%A7%A3%E5%AF%86ons%E8%84%9A%E6%9C%AC/</link><pubDate>Sun, 16 Dec 2018 23:44:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/go%E8%AF%AD%E8%A8%80%E5%AE%9E%E6%88%98%E4%B9%8B%E8%A7%A3%E5%AF%86ons%E8%84%9A%E6%9C%AC/</guid><description>&lt;h2 id="intro">Intro&lt;/h2>
&lt;p>ons æ˜¯ä¸€ä¸ªå¼€æ”¾æºä»£ç çš„è§†è§‰å°è¯´å¼•æ“ï¼Œä»¥ç®€å•å®ç”¨å‡ºåã€‚æœ¬åšç”¨ golang æ¥è§£å¯† ons å¼•æ“çš„&lt;code>.dat&lt;/code>å’Œ&lt;code>.nt2&lt;/code>è„šæœ¬ï¼Œä¸»è¦å®è·µç›®æ ‡æ˜¯å¼‚æ­¥è§£å¯†è¾“å‡ºã€‚&lt;/p>
&lt;h2 id="ç®—æ³•">ç®—æ³•&lt;/h2>
&lt;p>&lt;code>.dat&lt;/code>çš„åŠ å¯†éå¸¸ç®€å•ï¼Œä¸€æ¬¡å¼‚æˆ–ã€‚å¯†ç æ˜¯&lt;code>0x84&lt;/code>ã€‚&lt;/p>
&lt;p>å¯ä»¥ç”¨ go éå¸¸ç®€å•ç²—æš´åœ°å†™å‡ºä»¥ä¸‹ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">buf&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">^=&lt;/span> &lt;span class="mh">0x84&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>.nt2&lt;/code>çš„åŠ å¯†åŒæ ·ç®€å•ï¼Œä¸€æ¬¡å¼‚æˆ–ï¼Œå¯†ç æ˜¯&lt;code>0x85 &amp;amp; 0x97&lt;/code>ã€‚&lt;/p>
&lt;p>å¯ä»¥ç”¨ go éå¸¸ç²—æš´åœ°å†™å‡ºä»¥ä¸‹ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">buf&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">^&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mh">0x85&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mh">0x97&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å¼‚æ­¥è¯»æ–‡ä»¶">å¼‚æ­¥è¯»æ–‡ä»¶&lt;/h2>
&lt;p>go æ–¹å¼æ¯”è¾ƒå¤šï¼Œ&lt;code>ioutil&lt;/code>æˆ–è€…&lt;code>bufio&lt;/code>æˆ–è€…&lt;code>os&lt;/code>éƒ½æœ‰æ–‡ä»¶æ¨¡å—ã€‚è¿™é‡Œé‡‡ç”¨&lt;code>bufio&lt;/code>å¥—&lt;code>os.Open&lt;/code>çš„æ–¹å¼è¯»æ–‡ä»¶ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">readFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">outChannel&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// åªè¯»æ–¹å¼æ‰“å¼€æ–‡ä»¶
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">OpenFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">O_RDONLY&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mo">0644&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// åŒ…è£…ä¸€å±‚ bufio
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">reader&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">bufio&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewReader&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">file&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// å‡†å¤‡ä¸€ä¸ªä¿å­˜è¯»å–ç»“æœçš„buf
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">var&lt;/span> &lt;span class="nx">buf&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">new&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="mi">1024000&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// å¾ªç¯è¯»
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">reader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">[:])&lt;/span>
&lt;span class="c1">// æ²¡æœ‰å†…å®¹äº†å°±é€€å‡ºå¾ªç¯
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">break&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// æŠŠè¯»åˆ°çš„ç»“æœç”¨ channel ä¼ é€’ç»™ä¸‹ä¸€é“å¤„ç†å·¥åº
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">outChannel&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">buf&lt;/span>&lt;span class="p">[:&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">outChannel&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å¼‚æ­¥å†™æ–‡ä»¶">å¼‚æ­¥å†™æ–‡ä»¶&lt;/h2>
&lt;p>å†™æ–‡ä»¶çš„æ–¹å¼å’Œè¯»æ–‡ä»¶çš„æ–¹å¼å·®ä¸å¤šï¼Œç”±é‚£å‡ ä¸ªåŒ…æä¾›ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">writeFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">outChannel&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">done&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// åªè¯»æ–¹å¼æ‰“å¼€æ–‡ä»¶ï¼Œå·²å­˜åœ¨æ–‡ä»¶åˆ™æ¸…ç©ºå†…å®¹ï¼Œæœªå­˜åœ¨æ–‡ä»¶åˆ™åˆ›å»ºï¼Œæ–‡ä»¶æƒé™ rw-r--r--
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">OpenFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">O_WRONLY&lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">O_TRUNC&lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">O_CREATE&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mo">0644&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">writer&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">bufio&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewWriter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">file&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ä»ä¸Šä¸€é“å·¥åºå–å¾—è§£å¯†åçš„æ•°æ®
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">buf&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">more&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">outChannel&lt;/span>
&lt;span class="c1">// å¦‚æœæ‰€æœ‰æ•°æ®å…¨éƒ¨å–å¾—ï¼Œåˆ™ç»“æŸå†™å…¥
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">more&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">break&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// å†™å…¥
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">writer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">writer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Flush&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">done&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å¼‚æ­¥è§£å¯†">å¼‚æ­¥è§£å¯†&lt;/h2>
&lt;p>è§£å¯†è¿‡ç¨‹å°±åƒæ˜¯æ°´ç®¡ä¸Šçš„è¿‡æ»¤å™¨ï¼Œæ°´æµè¿›æ¥å¤„ç†å¥½ï¼Œæµå‡ºå»ã€‚å†…å®¹ä¹å–„å¯é™ˆï¼Œå°±ç›´æ¥ä¸¢ä»£ç å¥½äº†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">decodeDat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inChannel&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">outChannel&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">buf&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">more&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">inChannel&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">more&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">break&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">buf&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">^=&lt;/span> &lt;span class="mh">0x84&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">outChannel&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">buf&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">outChannel&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">decodeNt2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inChannel&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">outChannel&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">buf&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">more&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">inChannel&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">more&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">break&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">buf&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">^&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mh">0x85&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mh">0x97&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">outChannel&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">buf&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">outChannel&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="è°ƒåº¦">è°ƒåº¦&lt;/h2>
&lt;p>ä¸¥è‚ƒåœ°è¯´ï¼Œæˆ‘è®¤ä¸ºè¿™ç§è°ƒåº¦æ¨¡å¼æ˜¯æ˜¾ç„¶ä¸å¯¹çš„ã€‚æ­£ç¡®çš„è°ƒåº¦æ–¹å¼åº”è¯¥æ˜¯è¿™æ ·ã€‚&lt;/p>
&lt;pre>&lt;code class="language-mermaid" data-lang="mermaid">graph TB;
A[cli] --&amp;gt; |å¯åŠ¨|B[read worker];
A --&amp;gt; |å¯åŠ¨| C[write worker];
A --&amp;gt; |å¯åŠ¨| D[decode worker];
A --&amp;gt; |å¯åŠ¨| E[scheduler];
E --&amp;gt; |å‘å‡ºè¯»æŒ‡ä»¤| B;
B --&amp;gt; |å‘é€æ¥æºæ ‡è¯†ç¬¦+å†…å®¹| D;
D --&amp;gt; |å‘é€æ¥æºæ ‡è¯†ç¬¦+å¤„ç†åçš„å†…å®¹| C;
&lt;/code>&lt;/pre>&lt;p>å¯¹äºæœ‰å¤šä¸ª worker çš„æƒ…å†µï¼Œä¹Ÿéœ€è¦è°ƒåº¦å™¨åè°ƒæ‰è¡Œï¼Œä¸è¿‡ç›´è§‰ä¸Šæ¥è¯´ç¡¬ç›˜è¯»å†™æ€§èƒ½ä¼šæ˜¯å…ˆä¸€æ­¥çš„ç“¶é¢ˆã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Args&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">decodeChannel&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">outChannel&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">done&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">p&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Args&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="nf">readFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">decodeChannel&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="nx">path&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Ext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="s">&amp;#34;.dat&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="nf">decodeDat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">decodeChannel&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">outChannel&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="s">&amp;#34;.nt2&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="nf">decodeNt2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">decodeChannel&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">outChannel&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">path&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Ext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Input file should be .dat or .nt2 encrypted script!&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="nf">writeFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">path&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Base&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="s">&amp;#34;.txt&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">outChannel&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">done&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">done&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å®Œæ•´ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;bufio&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;log&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;os&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;path&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Args&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">decodeChannel&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">outChannel&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">done&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">p&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Args&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="nf">readFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">decodeChannel&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="nx">path&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Ext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="s">&amp;#34;.dat&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="nf">decodeDat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">decodeChannel&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">outChannel&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="s">&amp;#34;.nt2&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="nf">decodeNt2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">decodeChannel&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">outChannel&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">path&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Ext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Input file should be .dat or .nt2 encrypted script!&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="nf">writeFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">path&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Base&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="s">&amp;#34;.txt&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">outChannel&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">done&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">done&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">readFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">outChannel&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">OpenFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">O_RDONLY&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mo">0644&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">reader&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">bufio&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewReader&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">file&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">buf&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">new&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="mi">1024000&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">reader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">[:])&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">break&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">outChannel&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">buf&lt;/span>&lt;span class="p">[:&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">outChannel&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">writeFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">outChannel&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">done&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">OpenFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">O_WRONLY&lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">O_TRUNC&lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">O_CREATE&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mo">0644&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">writer&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">bufio&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewWriter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">file&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">buf&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">more&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">outChannel&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">more&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">break&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">writer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">writer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Flush&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">done&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">decodeDat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inChannel&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">outChannel&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">buf&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">more&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">inChannel&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">more&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">break&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">buf&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">^=&lt;/span> &lt;span class="mh">0x84&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">outChannel&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">buf&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">outChannel&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">decodeNt2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inChannel&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">outChannel&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">buf&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">more&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">inChannel&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">more&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">break&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">buf&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">^&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mh">0x85&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mh">0x97&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">outChannel&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">buf&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">outChannel&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>å…³äºç¬”è®°çš„è€ƒè™‘</title><link>https://nnnewb.github.io/blog/p/%E5%85%B3%E4%BA%8E%E7%AC%94%E8%AE%B0%E7%9A%84%E8%80%83%E8%99%91/</link><pubDate>Sun, 16 Dec 2018 23:30:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/%E5%85%B3%E4%BA%8E%E7%AC%94%E8%AE%B0%E7%9A%84%E8%80%83%E8%99%91/</guid><description>&lt;p>ä½¿ç”¨äº†ä¸¤å¹´å¤šçš„ One Noteï¼Œä½†æ˜¯ One Note å¯¹ä»£ç çš„æ”¯æŒå®åœ¨æ˜¯éš¾å—ï¼Œäºæ˜¯æ•°æ¬¡æŠ˜è…¾ä¹‹åæœ€ç»ˆè¿˜æ˜¯é€‰æ‹©å†æ‰¾ä¸ªæ›´åˆé€‚çš„ç¬”è®°å·¥å…·ã€‚&lt;/p>
&lt;p>åœ¨çŸ¥ä¹ä¸Šæœäº†ä¸€åœˆä¹‹åï¼Œå¤§å¤šæ•°ç¬”è®°å·¥å…·æ”¶è´¹ä¸”ä¸è®ºï¼Œæœ€ä¸¥é‡çš„é—®é¢˜åè€Œæ˜¯å¯¹ç¬”è®°èƒ½å¦ç”Ÿå­˜ä¸‹å»çš„æ€€ç–‘ã€‚&lt;/p>
&lt;p>å¤§å¤šç¬”è®°å·¥å…·ç”¨ç§æœ‰æ ¼å¼æ¥å¤„ç†å¯Œæ–‡æœ¬ï¼ˆæ¯”å¦‚å¯ç”¨æ ·å¼æ’ç‰ˆæœ‰é™çš„ HTMLï¼‰ï¼Œæˆ–è€…å…¶ä»–å¥‡å¥‡æ€ªæ€ªçš„æ ¼å¼ã€‚ä¸”ä¸è¯´è¿™äº›ä¸œè¥¿å¯¼å‡ºæ¥æ€ä¹ˆåŠ&amp;hellip;..æŠŠç¬”è®°å¤šåœ°å¤‡ä»½æœ¬èº«å°±å¤Ÿéš¾å—äº†ã€‚&lt;/p>
&lt;p>å†è€…ï¼Œç¬”è®°è¿™ç©æ„å„¿è®°äº†è‡ªå·±éƒ½ä¸ä¸€å®šçœ‹ã€‚å¶å°”æƒ³èµ·æ¥ç¿»ä¸€ä¸‹ï¼Œè¿˜è¦æ€€ç–‘è‡ªå·±å½“åˆå†™çš„ä»€ä¹ˆç‹—å±ç©æ„å„¿ã€‚&lt;/p>
&lt;p>æ‰€ä»¥ç»è¿‡è¿™ä¹ˆå¤šè€ƒè™‘&amp;hellip;&amp;hellip;è¿˜æ˜¯ç›´æ¥æ­ä¸ªåšå®¢æœ€è‡ªç”±ä¸”ä¸ä¼šå¤ªæ‹…å¿ƒä¿å­˜çš„é—®é¢˜äº†ã€‚&lt;/p>
&lt;p>æ¯”è¾ƒåˆ«çš„ç¬”è®°å·¥å…·å¯èƒ½å¯†ç å¿˜äº†æˆ–é•¿æ—¶é—´ä¸ç™»é™†ï¼Œgit å¤©å¤©ç”¨ï¼ˆè¿™é‡Œåº”æœ‰è‡ªå˜²ï¼‰ï¼Œæ ¹æœ¬ç¦»ä¸å¼€ã€‚&lt;/p>
&lt;p>æ‰€ä»¥æƒ³äº†æƒ³ï¼Œè¿˜æ˜¯è½¬ç§»ç¬”è®°åˆ°åšå®¢å¥½äº†ã€‚å†™ç¬”è®°å¯èƒ½å¾ˆéšä¾¿ï¼Œå†™åšå®¢æ€»è¦è€ƒæ®ä¸¤ä¸‹çš„ã€‚å†è¯´ï¼Œè¿˜å¯ä»¥è‡ªå®šä¹‰é¡µé¢æ•ˆæœï¼Œå¯¹æˆ‘è¿™ç§å–œæ¬¢æŠ˜è…¾çš„äººè¿˜æ˜¯è›®å¯¹èƒƒå£çš„ã€‚&lt;/p>
&lt;p>æ€»è€Œè¨€ä¹‹ï¼Œå…ˆæŒ‚ä¸Šå»äº†ï¼Œå°±è¿™æ ·ã€‚&lt;/p></description></item><item><title>AudioContext æŠ€æœ¯å’ŒéŸ³ä¹å¯è§†åŒ–ï¼ˆ2ï¼‰</title><link>https://nnnewb.github.io/blog/p/audiocontext-%E6%8A%80%E6%9C%AF%E5%92%8C%E9%9F%B3%E4%B9%90%E5%8F%AF%E8%A7%86%E5%8C%962/</link><pubDate>Thu, 08 Nov 2018 21:41:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/audiocontext-%E6%8A%80%E6%9C%AF%E5%92%8C%E9%9F%B3%E4%B9%90%E5%8F%AF%E8%A7%86%E5%8C%962/</guid><description>&lt;h2 id="intro">Intro&lt;/h2>
&lt;p>è½¬è½½è¯·æ³¨æ˜æ¥æºï¼Œå¯ä»¥åœ¨&lt;a class="link" href="https://th-zxj.club" target="_blank" rel="noopener"
>æµ‹è¯•åšå®¢&lt;/a>æŸ¥çœ‹å®Œæˆæ•ˆæœã€‚&lt;/p>
&lt;p>æœ¬ç¯‡è®²è¿°å¦‚ä½•ä»é¢‘åŸŸæ•°æ®ç»˜åˆ¶åŠ¨æ€çš„æ˜Ÿç©ºã€‚&lt;/p>
&lt;h2 id="ä¸€ä½¿ç”¨-canvas-ç»˜å›¾">ä¸€ã€ä½¿ç”¨ Canvas ç»˜å›¾&lt;/h2>
&lt;h3 id="11-ä½ç½®å’Œå¤§å°">1.1 ä½ç½®å’Œå¤§å°&lt;/h3>
&lt;p>ç»˜åˆ¶èƒŒæ™¯çš„ç¬¬ä¸€è¦åŠ¡ä¾¿æ˜¯æŠŠ canvas å…ƒç´ æ”¾ç½®åœ¨èƒŒæ™¯è¿™ä¸€å±‚æ¬¡ä¸Šï¼Œé¿å…é®ç›–å…¶ä»–å…ƒç´ ã€‚&lt;/p>
&lt;p>å¯¹æˆ‘è€Œè¨€ï¼Œä¸ªäººä¹ æƒ¯ç”¨ css æ¥è®¾ç½®å¤§å°å’Œä½ç½®ï¼Œç”¨ html æ¥ç¡®å®šæ¸²æŸ“é¡ºåºè€Œä¸æ˜¯ z-indexã€‚&lt;/p>
&lt;p>ä¸‹é¢æ˜¯ html ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-html" data-lang="html">&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">html&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">body&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">canvas&lt;/span> &lt;span class="na">id&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;background-canvas&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&amp;lt;/&lt;/span>&lt;span class="nt">canvas&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;span class="c">&amp;lt;!-- other elements --&amp;gt;&lt;/span>
&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">body&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">html&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸‹é¢æ˜¯ css ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-css" data-lang="css">&lt;span class="p">#&lt;/span>&lt;span class="nn">background-canvas&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">position&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">fixed&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">left&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">top&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">width&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="kt">vw&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">height&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="kt">vh&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">background-color&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">black&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>fixed&lt;/code>ç¡®ä¿æ‹–åŠ¨é¡µé¢ä¸ä¼šä»¤èƒŒæ™¯ä¹Ÿè·Ÿéšç§»åŠ¨ã€‚&lt;/p>
&lt;p>å…¶ä½™éƒ¨åˆ†æˆ‘æƒ³åº”è¯¥æ²¡ä»€ä¹ˆæœ‰ç–‘é—®çš„åœ°æ–¹ã€‚&lt;/p>
&lt;h3 id="12-canvascontext2d">1.2 CanvasContext2D&lt;/h3>
&lt;p>å¯¹äº canvas å…ƒç´ çš„ç»˜å›¾æ“ä½œæˆ‘æƒ³å¾ˆå¤šäººåº”è¯¥æ¥è§¦è¿‡ã€‚&lt;/p>
&lt;p>ä»¥ç»˜åˆ¶åœ†å½¢ä¸ºä¾‹ï¼Œä½¿ç”¨å¦‚ä¸‹ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="kr">const&lt;/span> &lt;span class="nx">canvas&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">document&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">getElementById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;background-canvas&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kr">const&lt;/span> &lt;span class="nx">ctx&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">getContext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;2d&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fillStyle&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;#fff&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">beginPath&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">arc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">100&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">50&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">Math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PI&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// å‚æ•°åˆ†åˆ«ä¸ºåæ ‡x,y,åŠå¾„ï¼Œèµ·å§‹å¼§åº¦ï¼Œç»“æŸå¼§åº¦
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fill&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™æ ·å°±ç”»å®Œäº†ä¸€ä¸ªå®å¿ƒåœ†ã€‚&lt;/p>
&lt;p>éœ€è¦æ³¨æ„ï¼Œcanvas çš„å¤§å°é€šè¿‡ css è®¾ç½®å¯èƒ½å¯¼è‡´ç”»é¢è¢«æ‹‰ä¼¸å˜å½¢æ¨¡ç³Šï¼Œæ‰€ä»¥æœ€å¥½çš„åŠæ³•æ˜¯ç»˜åˆ¶å‰ç¡®å®šä¸€ä¸‹ canvas çš„å¤§å°ã€‚&lt;/p>
&lt;p>æ­¤å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé‡ç½®å¤§å°ä¼šå¯¼è‡´ç”»é¢æ¸…ç©ºï¼Œç”¨è¿™ç§æ–¹å¼å¯ä»¥æ›¿ä»£&lt;code>fillRect&lt;/code>æˆ–è€…&lt;code>clearRect&lt;/code>ï¼Œæœ‰çš„æµè§ˆå™¨å¹³å°æ›´å¿«ä½†ä¹Ÿæœ‰æµè§ˆå™¨æ›´æ…¢ã€‚å¯ä»¥æŸ¥é˜…è¿™ç¯‡&lt;a class="link" href="https://www.html5rocks.com/en/tutorials/canvas/performance/#toc-pre-render?tdsourcetag=s_pctim_aiomsg" target="_blank" rel="noopener"
>åšæ–‡&lt;/a>æ¥å‚è€ƒå¦‚ä½•æå‡ canvas ç»˜å›¾æ€§èƒ½ã€‚&lt;/p>
&lt;p>&lt;code>fillStyle&lt;/code>å¯ä»¥ä½¿ç”¨ css çš„é¢œè‰²ä»£ç ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥å†™ä¸‹è¯¸å¦‚&lt;code>rgba&lt;/code>ã€&lt;code>hsla&lt;/code>ä¹‹ç±»çš„é¢œè‰²ï¼Œè¿™ç»™æˆ‘ä»¬ç¼–å†™ä»£ç æä¾›äº†å¾ˆå¤šæ–¹ä¾¿ã€‚&lt;/p>
&lt;h3 id="13-ç»˜åˆ¶æ˜Ÿæ˜Ÿ">1.3 ç»˜åˆ¶æ˜Ÿæ˜Ÿ&lt;/h3>
&lt;p>æ˜Ÿç©ºæ˜¯ç”±æ˜Ÿæ˜Ÿç»„æˆçš„è¿™æ˜¾ç„¶ä¸ç”¨å¤šè¯´äº†ï¼Œå…ˆæ¥çœ‹å¦‚ä½•ç»˜åˆ¶å•ä¸ªæ˜Ÿæ˜Ÿã€‚&lt;/p>
&lt;p>æ˜Ÿæ˜Ÿçš„ç»˜åˆ¶æ–¹æ³•å¾ˆå¤šï¼Œè´´å›¾è™½ç„¶ä¾¿åˆ©ä½†æ˜¾ç„¶ä¸å¤Ÿçµæ´»ï¼Œæˆ‘ä»¬çš„æ˜Ÿæ˜Ÿæ˜¯è¦éšèŠ‚å¥æ”¹å˜äº®åº¦å’Œå¤§å°çš„ï¼Œåˆ©ç”¨è´´å›¾çš„è¯å°±åªèƒ½åœ¨&lt;code>alpha&lt;/code>å€¼å’Œ&lt;code>drawImage&lt;/code>ç¼©æ”¾æ¥å¤„ç†äº†ã€‚è™½ç„¶æ˜¯ä¸€ç§ä¸é”™çš„åŠæ³•ï¼Œä¸è¿‡è¿™é‡Œæˆ‘ä½¿ç”¨äº†&lt;code>RadialGradient&lt;/code>æ¥æ§åˆ¶ç»˜å›¾ã€‚&lt;/p>
&lt;blockquote>
&lt;p>PSï¼š&lt;code>RadialGradient&lt;/code> çš„æ€§èƒ½æ¯”è¾ƒå·®ï¼Œå¤§é‡ä½¿ç”¨ä¼šå¯¼è‡´æ˜æ˜¾çš„æ€§èƒ½ä¸‹é™ï¼Œè¿™æ˜¯ä¸€ä¸ªæ˜¾è‘—é™ä½ç»˜åˆ¶æ•ˆç‡çš„åœ°æ–¹ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>é‚£ä¹ˆï¼Œæˆ‘ä»¬å…ˆç”»ä¸€ä¸ªåœ†ï¼ˆåŠ ç‚¹ç»†èŠ‚é¢„è­¦ï¼‰ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="kr">const&lt;/span> &lt;span class="nx">canvas&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">document&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">getElementById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;background-canvas&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kr">const&lt;/span> &lt;span class="nx">ctx&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">getContext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;2d&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// ç¡®ä¿ä¸ä¼šå˜å½¢
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">width&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">offsetWidth&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">height&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">offsetHeight&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// å‚æ•°åˆ†åˆ«ä¸ºèµ·å§‹åæ ‡x,y,åŠå¾„ï¼Œç»“æŸåæ ‡x,y,åŠå¾„
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kr">const&lt;/span> &lt;span class="nx">gradient&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">createRadialGradient&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">100&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">50&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="nx">gradient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">addColorStop&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">0.025&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;#fff&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// ä¸­å¿ƒçš„äº®ç™½è‰²
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">gradient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">addColorStop&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">0.1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;rgba(255, 255, 255, 0.9)&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// æ ¸å¿ƒå…‰ç‚¹å’Œå››å‘¨çš„åˆ†ç•Œçº¿
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">gradient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">addColorStop&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">0.25&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;hsla(198, 66%, 75%, 0.9)&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// æ ¸å¿ƒäº®ç‚¹å¾€å››å‘¨å‘æ•£çš„è“å…‰
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">gradient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">addColorStop&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">0.75&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;hsla(198, 64%, 33%, 0.4)&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// è“å…‰è¾¹ç¼˜
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">gradient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">addColorStop&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;hsla(198, 64%, 33%, 0)&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// æ·¡åŒ–ç›´è‡³é€æ˜
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fillStyle&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">gradient&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">beginPath&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">arc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">100&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">50&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">Math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PI&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fill&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥åœ¨&lt;a class="link" href="https://codepen.io/weak_ptr/pen/KrzwPV" target="_blank" rel="noopener"
>codepen&lt;/a>æŸ¥çœ‹æ•ˆæœæˆ–ç›´æ¥ç¼–è¾‘ä½ çš„æ˜Ÿï¼ˆåœˆï¼‰æ˜Ÿï¼ˆåœˆï¼‰ã€‚&lt;/p>
&lt;p>çœ‹ä¸Šå»è¿˜ä¸é”™ï¼Ÿ&lt;/p>
&lt;p>è®©æˆ‘ä»¬ç”¨ä»£ç æ§åˆ¶å®ƒçš„äº®åº¦å’Œå¤§å°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="kr">const&lt;/span> &lt;span class="nx">canvas&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">document&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">getElementById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;background-canvas&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kr">const&lt;/span> &lt;span class="nx">ctx&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">getContext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;2d&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// ç¡®ä¿ä¸ä¼šå˜å½¢
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">width&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">offsetWidth&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">height&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">offsetHeight&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// é€šè¿‡energyæ§åˆ¶äº®åº¦å’Œå¤§å°
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">let&lt;/span> &lt;span class="nx">energy&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">255&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kd">let&lt;/span> &lt;span class="nx">radius&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">50&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kd">let&lt;/span> &lt;span class="nx">energyChangeRate&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kd">function&lt;/span> &lt;span class="nx">draw&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">requestAnimationFrame&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">draw&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// å®šæ—¶ç»˜åˆ¶ï¼ŒrequestAnimationFrameæ¯”setTimeoutæ›´å¥½ã€‚
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">energy&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="nx">energyChangeRate&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// è§è¿‡å‘¼å¸ç¯å§ï¼Ÿæˆ‘ä»¬è®©å®ƒå˜äº®~å†å˜æš—~åå¤å¾ªç¯~
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">energy&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">energy&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="mi">255&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">energyChangeRate&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="nx">energyChangeRate&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// è®¡ç®—å‡ºå½“å‰çš„å¤§å°
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kr">const&lt;/span> &lt;span class="nx">r&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">radius&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nx">energy&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mf">0.1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// æ¸…ç©ºå±å¹•
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fillStyle&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;black&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fillRect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">width&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">height&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// å‚æ•°åˆ†åˆ«ä¸ºèµ·å§‹åæ ‡x,y,åŠå¾„ï¼Œç»“æŸåæ ‡x,y,åŠå¾„
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kr">const&lt;/span> &lt;span class="nx">gradient&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">createRadialGradient&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">100&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="nx">gradient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">addColorStop&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">0.025&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;#fff&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// ä¸­å¿ƒçš„äº®ç™½è‰²
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">gradient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">addColorStop&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">0.1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;rgba(255, 255, 255, 0.9)&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// æ ¸å¿ƒå…‰ç‚¹å’Œå››å‘¨çš„åˆ†ç•Œçº¿
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">gradient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">addColorStop&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="mf">0.25&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="sb">`hsla(198, 66%, &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nb">Math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">min&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">75&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nx">energy&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mf">0.01&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="sb">%, 0.9)`&lt;/span>
&lt;span class="p">);&lt;/span> &lt;span class="c1">// æ ¸å¿ƒäº®ç‚¹å¾€å››å‘¨å‘æ•£çš„è“å…‰
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">gradient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">addColorStop&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="mf">0.75&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="sb">`hsla(198, 64%, &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nb">Math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">min&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">33&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nx">energy&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mf">0.01&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="sb">%, 0.4)`&lt;/span>
&lt;span class="p">);&lt;/span> &lt;span class="c1">// è“å…‰è¾¹ç¼˜
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">gradient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">addColorStop&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;hsla(198, 64%, 33%, 0)&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// æ·¡åŒ–ç›´è‡³é€æ˜
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fillStyle&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">gradient&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">beginPath&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">arc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">100&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">Math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PI&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fill&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">draw&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥åœ¨&lt;a class="link" href="https://codepen.io/weak_ptr/pen/LXNEaa" target="_blank" rel="noopener"
>codepen&lt;/a>æŸ¥çœ‹å¹¶ç¼–è¾‘æ•ˆæœã€‚&lt;/p>
&lt;h3 id="14-å°è£…æ˜Ÿæ˜Ÿ">1.4 å°è£…æ˜Ÿæ˜Ÿ&lt;/h3>
&lt;p>é€šå¸¸æ¥è¯´ç²’å­ç³»ç»Ÿä¸å¤§ä¼šæŠŠå•ä¸ªç²’å­å°è£…æˆç±»ï¼Œå› ä¸ºå‡½æ•°è°ƒç”¨çš„å¼€é”€è¿˜æ˜¯è›®å¤§çš„ã€‚ã€‚ã€‚&lt;/p>
&lt;p>ä¸è¿‡åœ¨è¿™é‡Œæˆ‘ä»¬è¿™é‡Œå°±å…ˆè¿™æ ·äº†ï¼Œæ–¹ä¾¿ç†è§£å’Œé˜…è¯»ã€‚æ¸²æŸ“çš„ç“¶é¢ˆè§£å†³ä¹‹å‰ï¼Œç²’å­å‡½æ•°è°ƒç”¨è¿™ç‚¹å¼€é”€æ ¹æœ¬ä¸æ˜¯å›äº‹å„¿ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="kr">const&lt;/span> &lt;span class="nx">canvas&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">document&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">getElementById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;background-canvas&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kr">const&lt;/span> &lt;span class="nx">ctx&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">getContext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;2d&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// ç¡®ä¿ä¸ä¼šå˜å½¢
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">width&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">offsetWidth&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">height&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">offsetHeight&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// ç”¨javascriptåŸç”Ÿçš„classè€Œä¸æ˜¯prototype
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kr">class&lt;/span> &lt;span class="nx">Star&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">constructor&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">radius&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">lightness&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">radius&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">radius&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">x&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">y&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">y&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lightness&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">draw&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">energy&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// è®¡ç®—å‡ºå½“å‰çš„å¤§å°
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kr">const&lt;/span> &lt;span class="nx">r&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">radius&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nx">energy&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mf">0.1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// å‚æ•°åˆ†åˆ«ä¸ºèµ·å§‹åæ ‡x,y,åŠå¾„ï¼Œç»“æŸåæ ‡x,y,åŠå¾„
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kr">const&lt;/span> &lt;span class="nx">gradient&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">createRadialGradient&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">x&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">y&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">x&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">y&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">r&lt;/span>
&lt;span class="p">);&lt;/span>
&lt;span class="nx">gradient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">addColorStop&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">0.025&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;#fff&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// ä¸­å¿ƒçš„äº®ç™½è‰²
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">gradient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">addColorStop&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">0.1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;rgba(255, 255, 255, 0.9)&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// æ ¸å¿ƒå…‰ç‚¹å’Œå››å‘¨çš„åˆ†ç•Œçº¿
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">gradient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">addColorStop&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="mf">0.25&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="sb">`hsla(198, 66%, &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nb">Math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">min&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">75&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nx">energy&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mf">0.01&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="sb">%, 0.9)`&lt;/span>
&lt;span class="p">);&lt;/span> &lt;span class="c1">// æ ¸å¿ƒäº®ç‚¹å¾€å››å‘¨å‘æ•£çš„è“å…‰
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">gradient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">addColorStop&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="mf">0.75&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="sb">`hsla(198, 64%, &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nb">Math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">min&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">33&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nx">energy&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mf">0.01&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="sb">%, 0.4)`&lt;/span>
&lt;span class="p">);&lt;/span> &lt;span class="c1">// è“å…‰è¾¹ç¼˜
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">gradient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">addColorStop&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;hsla(198, 64%, 33%, 0)&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// æ·¡åŒ–ç›´è‡³é€æ˜
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fillStyle&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">gradient&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">beginPath&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">arc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">Math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PI&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fill&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kr">const&lt;/span> &lt;span class="nx">star&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">Star&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">100&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">50&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kd">let&lt;/span> &lt;span class="nx">energy&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">255&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kd">let&lt;/span> &lt;span class="nx">energyChangeRate&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// æ¸²æŸ“å‡½æ•°æ¥å¾ªç¯æ¸²æŸ“ï¼
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">function&lt;/span> &lt;span class="nx">render&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">requestAnimationFrame&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">render&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="nx">energy&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="nx">energyChangeRate&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">energy&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">energy&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="mi">255&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">energyChangeRate&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="nx">energyChangeRate&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// æ¸…ç©ºå±å¹•
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fillStyle&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;black&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fillRect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">width&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">height&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="nx">star&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">draw&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">energy&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// å¼€å§‹æ¸²æŸ“åŠ¨ç”»ï¼
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">render&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥åœ¨&lt;a class="link" href="https://codepen.io/weak_ptr/pen/pQyJQQ" target="_blank" rel="noopener"
>codepen&lt;/a>æŸ¥çœ‹ä»£ç æ•ˆæœã€‚&lt;/p>
&lt;p>å®Œæˆï¼&lt;/p>
&lt;h3 id="15-é“¶æ²³">1.5 é“¶æ²³&lt;/h3>
&lt;p>ç»˜åˆ¶é“¶æ²³çš„æ ¸å¿ƒåœ¨äºéšæœºåˆ†å¸ƒçš„æ˜Ÿæ˜Ÿç»•ç€åŒä¸€ä¸­å¿ƒç‚¹æ—‹è½¬ï¼Œåˆ†ä¸ºä¸¤æ­¥æ¥è®²ï¼Œç¬¬ä¸€æ­¥æ˜¯éšæœºåˆ†å¸ƒï¼Œè¿™å¾ˆç®€å•ï¼Œç”¨&lt;code>Math.random&lt;/code>å°±å¥½äº†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="c1">// star éƒ¨åˆ†ç•¥
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="kr">class&lt;/span> &lt;span class="nx">Galaxy&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">constructor&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">canvas&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">stars&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[];&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">canvas&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">canvas&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">getContext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;2d&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">energy&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">255&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">energyChangeRate&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">init&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">num&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">let&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="nx">num&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">stars&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">push&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="c1">// éšæœºç”Ÿæˆä¸€å®šæ•°é‡çš„æ˜Ÿæ˜Ÿï¼Œåˆå§‹åŒ–æ˜Ÿæ˜Ÿä½ç½®å’Œå¤§å°ã€‚
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">Star&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nb">Math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">random&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">width&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nb">Math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">random&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">height&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nb">Math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">random&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nb">Math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">random&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">30&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">33&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">render&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">energy&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">energyChangeRate&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">energy&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">energy&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="mi">255&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">energyChangeRate&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">energyChangeRate&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// æ¸…ç©ºå±å¹•
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fillStyle&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;black&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fillRect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">width&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">height&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kr">const&lt;/span> &lt;span class="nx">star&lt;/span> &lt;span class="k">of&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">stars&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">star&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">draw&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">energy&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kr">const&lt;/span> &lt;span class="nx">canvas&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">document&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">getElementById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;background-canvas&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// ç¡®ä¿ä¸ä¼šå˜å½¢
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">width&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">offsetWidth&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">height&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">offsetHeight&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kr">const&lt;/span> &lt;span class="nx">galaxy&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">Galaxy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">canvas&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="nx">galaxy&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">init&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">50&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kd">function&lt;/span> &lt;span class="nx">render&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">requestAnimationFrame&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">render&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="nx">galaxy&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">render&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">render&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥åœ¨&lt;a class="link" href="https://codepen.io/weak_ptr/pen/jQqPoQ" target="_blank" rel="noopener"
>codepen&lt;/a>æŸ¥çœ‹æ•ˆæœå’Œå®Œæ•´ä»£ç ã€‚&lt;/p>
&lt;h3 id="16-æ—‹è½¬èµ·æ¥">1.6 æ—‹è½¬èµ·æ¥ï¼&lt;/h3>
&lt;p>ã€åŠ ç‚¹ç»†èŠ‚é¢„è­¦ã€‘&lt;/p>
&lt;p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¸ºæ˜Ÿæ˜Ÿå‡†å¤‡è½¨é“å‚æ•°ï¼Œè®©å®ƒä»¬åŠ¨èµ·æ¥ï¼&lt;/p>
&lt;p>é¦–å…ˆä¿®æ”¹&lt;code>Star&lt;/code>ç±»ï¼ŒåŠ å…¥å‡ ä¸ªå­—æ®µã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="kr">class&lt;/span> &lt;span class="nx">Star&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">constructor&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">radius&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">lightness&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">orbit&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">speed&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">t&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">radius&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">radius&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">x&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">y&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">y&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lightness&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">orbit&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">orbit&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// è½¨é“
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">speed&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">speed&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// è¿åŠ¨é€Ÿåº¦
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">t&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">t&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// ä¸‰è§’å‡½æ•°xè½´å‚æ•°ï¼Œç”¨ sin/cos ç»„åˆè®¡ç®—ä½ç½®
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="c1">// ä¸‹ç•¥
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¿®æ”¹åˆå§‹åŒ–ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="c1">// å‰ç•¥
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">init&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">num&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kr">const&lt;/span> &lt;span class="nx">longerAxis&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">Math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">max&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">width&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">height&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kr">const&lt;/span> &lt;span class="nx">diameter&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">Math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">round&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nb">Math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sqrt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">longerAxis&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">longerAxis&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nx">longerAxis&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">longerAxis&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">);&lt;/span>
&lt;span class="kr">const&lt;/span> &lt;span class="nx">maxOrbit&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">diameter&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">let&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="nx">num&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">stars&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">push&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="c1">// éšæœºç”Ÿæˆä¸€å®šæ•°é‡çš„æ˜Ÿæ˜Ÿï¼Œåˆå§‹åŒ–æ˜Ÿæ˜Ÿä½ç½®å’Œå¤§å°ã€‚
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">Star&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nb">Math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">random&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">width&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nb">Math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">random&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">height&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nb">Math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">random&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nb">Math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">random&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">30&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">33&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nb">Math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">random&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">maxOrbit&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// éšæœºè½¨é“
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nb">Math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">random&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">1000&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// éšæœºé€Ÿåº¦
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nb">Math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">random&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">100&lt;/span> &lt;span class="c1">// éšæœºä½ç½®
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">)&lt;/span>
&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// åç•¥
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶ååœ¨&lt;code>Galaxy&lt;/code>é‡ŒåŠ å…¥æ§åˆ¶ç§»åŠ¨çš„ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="nx">move&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kr">const&lt;/span> &lt;span class="nx">star&lt;/span> &lt;span class="k">of&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">stars&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">star&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">orbit&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">star&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">width&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="o">+&lt;/span> &lt;span class="nb">Math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">cos&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">star&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">star&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">orbit&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="nx">star&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">y&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">canvas&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">height&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="o">+&lt;/span> &lt;span class="nb">Math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sin&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">star&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">star&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">orbit&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="nx">star&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">t&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="nx">star&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">speed&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶åæ¯ä¸€å¸§è¿›è¡Œç§»åŠ¨ï¼&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="kd">function&lt;/span> &lt;span class="nx">render&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">requestAnimationFrame&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">render&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="nx">galaxy&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">render&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="nx">galaxy&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">move&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="c1">// åŠ¨èµ·æ¥ï¼
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¤§åŠŸå‘Šæˆï¼&lt;/p>
&lt;p>åœ¨&lt;a class="link" href="https://codepen.io/weak_ptr/pen/NENGYm" target="_blank" rel="noopener"
>codepen&lt;/a>æŸ¥çœ‹å®Œæ•´æºç ï¼&lt;/p>
&lt;h3 id="17-å¾…ç»­">1.7 å¾…ç»­&lt;/h3>
&lt;blockquote>
&lt;p>PSï¼šä¸ä¿è¯ç²˜è´´çš„ä»£ç éƒ½èƒ½è·‘ï¼Œåæ­£ codepen ä¸Šæ˜¯éƒ½èƒ½çš„ã€‚&lt;/p>
&lt;/blockquote></description></item><item><title>AudioContextæŠ€æœ¯å’ŒéŸ³ä¹å¯è§†åŒ–ï¼ˆ1ï¼‰</title><link>https://nnnewb.github.io/blog/p/audiocontext%E6%8A%80%E6%9C%AF%E5%92%8C%E9%9F%B3%E4%B9%90%E5%8F%AF%E8%A7%86%E5%8C%961/</link><pubDate>Wed, 07 Nov 2018 02:48:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/audiocontext%E6%8A%80%E6%9C%AF%E5%92%8C%E9%9F%B3%E4%B9%90%E5%8F%AF%E8%A7%86%E5%8C%961/</guid><description>&lt;h2 id="intro">Intro&lt;/h2>
&lt;p>å› ä¸ºè‡ªå·±æ­äº†ä¸ªåšå®¢ï¼Œä¸€æ—¶å…´èµ·ï¼Œå°±æƒ³å†™ä¸ªåŠ¨æ€çš„åšå®¢èƒŒæ™¯ã€‚æ¯•ç«Ÿç”¨ django åç«¯æ¸²æŸ“ï¼Œå‰ç«¯åªæœ‰ jquery å’Œ bootstrap å·²ç»å¤Ÿ low äº†ï¼Œè™½è¯´æç®€é£æ ¼ä¹Ÿå¾ˆæ£’ï¼Œä½†æ˜¯å¤šå°‘æœ‰ç‚¹äº®çœ¼çš„ä¸œè¥¿æ‰å¥½åŠä¸æ˜¯å—ã€‚&lt;/p>
&lt;p>è½¬è½½æ³¨æ˜æ¥æºã€‚&lt;/p>
&lt;p>ä¸ºäº†æ–¹ä¾¿è®²è§£ï¼Œæ•´ä¸ªæ€è·¯åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šéŸ³ä¹æ’­æ”¾å’ŒèƒŒæ™¯ç»˜åˆ¶ã€‚&lt;/p>
&lt;h2 id="ä¸€éŸ³ä¹æ’­æ”¾">ä¸€ã€éŸ³ä¹æ’­æ”¾&lt;/h2>
&lt;h3 id="11-audiocontext">1.1 AudioContext&lt;/h3>
&lt;p>æ¦‚è¿°éƒ¨åˆ†æ‡’å¾—è‡ªå·±å†™ï¼Œå‚è€ƒ MDN çš„æè¿°ã€‚&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>AudioContext&lt;/strong>æ¥å£è¡¨ç¤ºç”±éŸ³é¢‘æ¨¡å—è¿æ¥è€Œæˆçš„éŸ³é¢‘å¤„ç†å›¾ï¼Œæ¯ä¸ªæ¨¡å—å¯¹åº”ä¸€ä¸ª&lt;a class="link" href="https://developer.mozilla.org/zh-CN/docs/Web/API/AudioNode" target="_blank" rel="noopener"
>&lt;code>AudioNode&lt;/code>&lt;/a>ã€‚&lt;strong>AudioContext&lt;/strong>å¯ä»¥æ§åˆ¶å®ƒæ‰€åŒ…å«çš„èŠ‚ç‚¹çš„åˆ›å»ºï¼Œä»¥åŠéŸ³é¢‘å¤„ç†ã€è§£ç æ“ä½œçš„æ‰§è¡Œã€‚åšä»»ä½•äº‹æƒ…ä¹‹å‰éƒ½è¦å…ˆåˆ›å»º&lt;strong>AudioContext&lt;/strong>å¯¹è±¡ï¼Œå› ä¸ºä¸€åˆ‡éƒ½å‘ç”Ÿåœ¨è¿™ä¸ªç¯å¢ƒä¹‹ä¸­ã€‚&lt;/p>
&lt;/blockquote>
&lt;h3 id="12-æµè§ˆå™¨æ”¯æŒçŠ¶å†µ">1.2 æµè§ˆå™¨æ”¯æŒçŠ¶å†µ&lt;/h3>
&lt;p>&lt;code>AudioContextæ ‡å‡†&lt;/code>ç›®å‰è¿˜æ˜¯è‰æ¡ˆï¼Œä¸è¿‡æ–° chrome å·²ç»å®ç°äº†ã€‚æˆ‘ä½¿ç”¨çš„ chrome ç‰ˆæœ¬å¦‚ä¸‹ã€‚&lt;/p>
&lt;pre>&lt;code>ç‰ˆæœ¬ 70.0.3538.77ï¼ˆæ­£å¼ç‰ˆæœ¬ï¼‰ ï¼ˆ64 ä½ï¼‰
&lt;/code>&lt;/pre>&lt;p>å¦‚æœå‘ç° console æŠ¥é”™æˆ–è€…å…¶ä»–é—®é¢˜è¯·æ£€æŸ¥æµè§ˆå™¨ç‰ˆæœ¬ï¼Œæ‰€æœ‰æ”¯æŒçš„æµè§ˆå™¨å¯ä»¥åœ¨è¿™ä¸ª&lt;a class="link" href="https://developer.mozilla.org/en-US/docs/Web/API/AudioContext" target="_blank" rel="noopener"
>é“¾æ¥&lt;/a>æŸ¥çœ‹ã€‚&lt;/p>
&lt;h3 id="13-audiocontext-å’ŒéŸ³é¢‘å¤„ç†å›¾">1.3 AudioContext å’ŒéŸ³é¢‘å¤„ç†å›¾&lt;/h3>
&lt;p>å…³äº&lt;code>AudioContext&lt;/code>æˆ‘çš„äº†è§£ä¸æ˜¯å¾ˆæ·±å…¥ï¼Œæ‰€ä»¥åªåœ¨éœ€è¦ç”¨åˆ°çš„éƒ¨åˆ†è¿›è¡Œæ¦‚è¿°ã€‚&lt;/p>
&lt;p>é¦–å…ˆï¼Œå…³äº&lt;strong>éŸ³é¢‘å¤„ç†å›¾&lt;/strong>çš„æ¦‚å¿µã€‚&lt;/p>
&lt;p>è¿™ä¸ªåè¯ä¸ç”šç›´è§‚ï¼Œæˆ‘ç”¨è¿‡è™šå¹»ï¼Œæ‰€ä»¥ç”¨è™šå¹»çš„&lt;code>Blueprint&lt;/code>æ¥ç±»æ¯”ç†è§£ã€‚éŸ³é¢‘å¤„ç†å›¾ï¼Œå…¶å®æ˜¯ä¸€ç³»åˆ—éŸ³é¢‘å¤„ç†çš„æ¨¡å—ï¼Œè¿æ¥æ„æˆä¸€å¼ æ•°æ®ç»“æ„ä¸­çš„â€œå›¾â€ï¼Œä»ä¸€èˆ¬ä½¿ç”¨çš„è§’åº¦æ¥è®²ï¼Œä¸€ä¸ªæ’­æ”¾éŸ³é¢‘çš„å›¾ï¼Œå°±æ˜¯&lt;code>AudioSource -&amp;gt; AudioContext.destination&lt;/code>ï¼Œä¸¤ä¸ªèŠ‚ç‚¹æ„æˆçš„å›¾ã€‚å…¶ä¸­æœ‰å¾ˆå¤šç‰¹æ®Šçš„èŠ‚ç‚¹å¯ä»¥å¯¹éŸ³é¢‘è¿›è¡Œå¤„ç†ï¼Œæ¯”å¦‚éŸ³é¢‘å¢ç›ŠèŠ‚ç‚¹&lt;code>GainNode&lt;/code>ã€‚&lt;/p>
&lt;p>å¯¹äºéŸ³é¢‘å¤„ç†çš„éƒ¨åˆ†ä»‹ç»å°±åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œæ¯•ç«ŸçœŸçš„äº†è§£ä¸å¤šï¼Œä¸è¿‡ä» MDN çš„æ–‡æ¡£çœ‹ï¼Œå¯ç”¨çš„å¤„ç†èŠ‚ç‚¹è¿˜æ˜¯éå¸¸å¤šçš„ï¼Œå°±ç­‰æ ‡å‡†åˆ¶è®¢å®Œæˆäº†ã€‚&lt;/p>
&lt;h3 id="14-åŠ è½½éŸ³é¢‘æ–‡ä»¶å¹¶æ’­æ”¾">1.4 åŠ è½½éŸ³é¢‘æ–‡ä»¶å¹¶æ’­æ”¾&lt;/h3>
&lt;p>éŸ³é¢‘æ–‡ä»¶åŠ è½½ä½¿ç”¨å…¸å‹çš„&lt;code>JavaScript&lt;/code>æ¥å£&lt;code>FileReader&lt;/code>å®ç°ã€‚&lt;/p>
&lt;p>ä¸€ä¸ªéå¸¸ç®€å•çš„å®ä¾‹æ˜¯è¿™æ ·&lt;/p>
&lt;p>é¦–å…ˆæ˜¯ html é‡Œå†™ä¸Š input&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-html" data-lang="html">&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">html&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">body&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">input&lt;/span> &lt;span class="na">type&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;file&amp;#34;&lt;/span> &lt;span class="na">accept&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;audio/*&amp;#34;&lt;/span> &lt;span class="na">onchange&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;onInputChange&amp;#34;&lt;/span> &lt;span class="p">/&amp;gt;&lt;/span>
&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">body&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">html&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶ååœ¨ javascript é‡Œè¯»æ–‡ä»¶å†…å®¹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-javascript" data-lang="javascript">&lt;span class="kd">function&lt;/span> &lt;span class="nx">onInputChange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">files&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kr">const&lt;/span> &lt;span class="nx">reader&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">FileReader&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="nx">reader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">onload&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">event&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// event.target.result å°±æ˜¯æˆ‘ä»¬çš„æ–‡ä»¶å†…å®¹äº†
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">};&lt;/span>
&lt;span class="nx">reader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">readAsArrayBuffer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">files&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ–‡ä»¶è¯»å–å°±æ˜¯è¿™ä¹ˆç®€å•ï¼Œæ‰€ä»¥å›åˆ°é‚£ä¸ªé—®é¢˜ï¼šè¯´äº†é‚£ä¹ˆå¤šï¼ŒéŸ³ä¹åˆ°åº•æ€ä¹ˆæ”¾ï¼Ÿ&lt;/p>
&lt;p>ç­”æ¡ˆæ˜¯ç”¨&lt;code>AudioContext&lt;/code>çš„&lt;code>decodeAudioData&lt;/code>æ–¹æ³•ã€‚&lt;/p>
&lt;p>æ‰€ä»¥ä»ä¸Šé¢çš„ js é‡Œåšå°‘è®¸ä¿®æ”¹â€”â€”&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-javascript" data-lang="javascript">&lt;span class="c1">// åˆ›å»ºä¸€ä¸ªæ–°çš„ AudioContext
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kr">const&lt;/span> &lt;span class="nx">ctx&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">AudioContext&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="kd">function&lt;/span> &lt;span class="nx">onInputChange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">files&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kr">const&lt;/span> &lt;span class="nx">reader&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">FileReader&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="nx">reader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">onload&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">event&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// event.target.result å°±æ˜¯æˆ‘ä»¬çš„æ–‡ä»¶å†…å®¹äº†
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// è§£ç å®ƒ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">decodeAudioData&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">event&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">target&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">result&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">then&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="nx">decoded&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// è§£ç åçš„éŸ³é¢‘æ•°æ®ä½œä¸ºéŸ³é¢‘æº
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kr">const&lt;/span> &lt;span class="nx">audioBufferSourceNode&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">createBufferSource&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="nx">audioBufferSourceNode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">buffer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">decoded&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// æŠŠéŸ³æº node å’Œè¾“å‡º node è¿æ¥ï¼Œboomâ€”â€”
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">audioBufferSourceNode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">connect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">destination&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="nx">audioBufferSourceNode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">start&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// æ”¶å·¥ã€‚
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">});&lt;/span>
&lt;span class="p">};&lt;/span>
&lt;span class="nx">reader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">readAsArrayBuffer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">files&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="15-åˆ†æé¢‘è°±">1.5 åˆ†æé¢‘è°±&lt;/h3>
&lt;p>é¢‘è°±çš„æ¦‚å¿µæˆ‘å»ºè®®æœä¸€ä¸‹&lt;strong>å‚…é‡Œå¶å˜æ¢&lt;/strong>ï¼Œå…³äºæ—¶åŸŸå’Œé¢‘åŸŸè½¬æ¢çš„è®¡ç®—è¿‡ç¨‹å’Œæ•°å­¦åŸç†ç›´æ¥ç•¥ï¼ˆå› ä¸ºä¸æ‡‚ï¼‰ï¼Œè‡³ä»Šæˆ‘è¿˜åªç†è§£åˆ°æ—¶åŸŸå’Œé¢‘åŸŸçš„æ¦‚å¿µä»¥åŠå‚…é‡Œå¶å˜æ¢çš„å®ç°æ¥å—é‡‡æ ·è¿”å›é‡‡æ ·æ•°ä¸€åŠé•¿çš„é¢‘åŸŸæ•°æ®&amp;hellip;&amp;hellip;&lt;/p>
&lt;p>ä¸ç­é—¨å¼„æ–§äº†ã€‚&lt;/p>
&lt;p>ä»¥å‰å†™&lt;code>python&lt;/code>çš„æ—¶å€™ç”¨çš„&lt;code>numpy&lt;/code>æ¥è¿›è¡Œå‚…é‡Œå¶å˜æ¢å–å¾—é¢‘åŸŸæ•°æ®ï¼Œç°åœ¨åœ¨æµè§ˆå™¨ä¸Šç”¨ js ç€å®æœ‰äº›éš¾å—ã€‚ä¸è¿‡å¹¸å¥½ï¼Œ&lt;code>AudioContext&lt;/code>ç›´æ¥æ”¯æŒäº†ä¸€ä¸ªéŸ³é¢‘åˆ†æçš„ nodeï¼Œå«åš&lt;code>AudioAnalyserNode&lt;/code>ã€‚&lt;/p>
&lt;p>è¿™ä¸ª Node å¤„äºéŸ³æº Node å’Œæ’­æ”¾è¾“å‡º Node ä¹‹é—´ï¼Œæƒ³è±¡ä¸€é“æ•°æ®æµï¼ŒéŸ³æº Node æŠŠç¦»æ•£çš„é‡‡æ ·æ•°æ®äº¤ç»™ Analyserï¼ŒAnalyser å†äº¤ç»™è¾“å‡º Nodeã€‚&lt;/p>
&lt;p>ç›´æ¥çœ‹ä»£ç å®ä¾‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-javascript" data-lang="javascript">&lt;span class="c1">// åˆ›å»ºä¸€ä¸ªæ–°çš„ AudioContext
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kr">const&lt;/span> &lt;span class="nx">ctx&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">AudioContext&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="c1">// è§£ç åçš„éŸ³é¢‘æ•°æ®ä½œä¸ºéŸ³é¢‘æº
&lt;/span>&lt;span class="c1">// ä¸ºäº†æ–¹ä¾¿ç®¡ç†ï¼Œå°†è¿™äº›Nodeéƒ½æ”¾ç½®åœ¨å›è°ƒå‡½æ•°å¤–éƒ¨
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kr">const&lt;/span> &lt;span class="nx">audioBufferSourceNode&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">createBufferSource&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="c1">// åˆ›å»ºéŸ³é¢‘åˆ†æNode!
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kr">const&lt;/span> &lt;span class="nx">audioAnalyser&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">createAnalyser&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="c1">// æ³¨æ„æ³¨æ„ï¼è¿™é‡Œé…ç½®å‚…é‡Œå¶å˜æ¢ä½¿ç”¨çš„é‡‡æ ·çª—å£å¤§å°ï¼æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬è¦256ä¸ªé¢‘åŸŸæ•°æ®ï¼Œé‚£ä¹ˆé‡‡æ ·å°±åº”è¯¥æ˜¯512ã€‚
&lt;/span>&lt;span class="c1">// å…·ä½“å¯¹åº”é¢‘ç‡è¯·è‡ªè¡Œæœå‚…é‡Œå¶å˜æ¢ç›¸å…³åšæ–‡ã€‚
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">audioAnalyser&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fftSize&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">512&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kd">function&lt;/span> &lt;span class="nx">onInputChange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">files&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kr">const&lt;/span> &lt;span class="nx">reader&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">FileReader&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="nx">reader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">onload&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">event&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// event.target.result å°±æ˜¯æˆ‘ä»¬çš„æ–‡ä»¶å†…å®¹äº†
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// è§£ç å®ƒ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">decodeAudioData&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">event&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">target&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">result&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">then&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="nx">decoded&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// åœæ­¢åŸå…ˆçš„éŸ³é¢‘æº
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">audioBufferSourceNode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">stop&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="c1">// å…ˆæŠŠéŸ³é¢‘æºNodeå’ŒAnalyserè¿æ¥ã€‚
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">audioBufferSourceNode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">connect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">audioAnalyser&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// ç„¶åæŠŠAnalyserå’Œdestinationè¿æ¥ã€‚
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">audioAnalyser&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">connect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">destination&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// ä¿®æ”¹éŸ³é¢‘æºæ•°æ®
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">audioBufferSourceNode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">buffer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">decoded&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="nx">audioBufferSourceNode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">start&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// æ”¶å·¥ã€‚
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">});&lt;/span>
&lt;span class="p">};&lt;/span>
&lt;span class="nx">reader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">readAsArrayBuffer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">files&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nb">window&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">requestAnimationFrame&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">function&lt;/span> &lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// è¯»å–é¢‘åŸŸæ•°æ®
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kr">const&lt;/span> &lt;span class="nx">freqData&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">Uint8Array&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">audioAnalyser&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">frequencyBinCount&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">freqData&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">});&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>é¢‘åŸŸæ•°æ®æ˜¯äºŒç»´çš„ï¼Œé¢‘ç‡ï¼ˆæ•°ç»„ä¸‹æ ‡ï¼‰å’Œèƒ½é‡ï¼ˆä¸‹æ ‡å¯¹åº”å€¼ï¼‰ã€‚æ‚„æ‚„è¡¥ä¸€å¥ï¼Œæ•°å­¦ä¸Šåº”è¯¥è¯´æ˜¯è¯¥é¢‘ç‡å‡½æ•°å›¾åƒçš„æŒ¯å¹…ï¼Ÿ&lt;/p>
&lt;p>å…¶å®è·å¾—äº†è¿™ä¸ªé¢‘åŸŸæ•°æ®ï¼Œç»§ç»­ç”»å‡ºæˆ‘ä»¬å¸¸è§çš„æ¡çŠ¶é¢‘åŸŸå›¾å°±å¾ˆå®¹æ˜“äº†ã€‚å‚è€ƒæˆ‘ä¸€æœ‹å‹çš„åšå®¢ã€‚&lt;a class="link" href="https://misuzu.moe/music/index.html" target="_blank" rel="noopener"
>misuzu.moe&lt;/a>ï¼Œå¯ä»¥çœ‹çœ‹æ•ˆæœã€‚&lt;/p>
&lt;p>å…³äº&lt;code>AudioContext&lt;/code>çš„ä»‹ç»å…ˆåˆ°æ­¤ä¸ºæ­¢ï¼Œç­‰æˆ‘æ‰¾æ—¶é—´ç»§ç»­å†™ã€‚&lt;/p>
&lt;blockquote>
&lt;p>PSï¼šä»£ç ä¸ä¿è¯å¤åˆ¶ç²˜è´´å°±èƒ½è¿è¡Œï¼Œé¢†ä¼šç²¾ç¥ï¼Œé‡åˆ°é—®é¢˜æŸ¥æŸ¥æ–‡æ¡£ã€‚MDN æ¯”æˆ‘è¿™åšå®¢è¯¦ç»†å¤šäº†ã€‚&lt;/p>
&lt;/blockquote></description></item><item><title>Unity3D é”®ç›˜æ§åˆ¶ç‰©ä½“å¹³é¢ç§»åŠ¨ï¼ˆæ“ä½œç›¸å¯¹äºæ‘„åƒæœºæ–¹å‘ï¼‰</title><link>https://nnnewb.github.io/blog/p/unity3d-%E9%94%AE%E7%9B%98%E6%8E%A7%E5%88%B6%E7%89%A9%E4%BD%93%E5%B9%B3%E9%9D%A2%E7%A7%BB%E5%8A%A8%E6%93%8D%E4%BD%9C%E7%9B%B8%E5%AF%B9%E4%BA%8E%E6%91%84%E5%83%8F%E6%9C%BA%E6%96%B9%E5%90%91/</link><pubDate>Sat, 03 Nov 2018 18:57:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/unity3d-%E9%94%AE%E7%9B%98%E6%8E%A7%E5%88%B6%E7%89%A9%E4%BD%93%E5%B9%B3%E9%9D%A2%E7%A7%BB%E5%8A%A8%E6%93%8D%E4%BD%9C%E7%9B%B8%E5%AF%B9%E4%BA%8E%E6%91%84%E5%83%8F%E6%9C%BA%E6%96%B9%E5%90%91/</guid><description>&lt;h2 id="intro">Intro&lt;/h2>
&lt;p>ç›®æ ‡æ˜¯å®ç°ç›®æ ‡éšæ‘„åƒæœºæ–¹å‘çš„ä¸åŒè€Œè¿›è¡Œä¸åŒæ–¹å‘ç§»åŠ¨â€”â€”è€Œä¸”ï¼Œç›®æ ‡ä¸éœ€è¦éšæ‘„åƒæœºä¸€èµ·æ—‹è½¬ã€‚&lt;/p>
&lt;h2 id="ä½¿ç”¨æ‘„åƒæœºçš„å››å…ƒæ•°æ—‹è½¬">ä½¿ç”¨æ‘„åƒæœºçš„å››å…ƒæ•°æ—‹è½¬&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c#" data-lang="c#"> &lt;span class="k">void&lt;/span> &lt;span class="n">HandleKeyboardAction&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="kt">var&lt;/span> &lt;span class="n">horizontal&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="n">Input&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">GetAxis&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Horizontal&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">PlayerMotionScaleLevel&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">Time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">deltaTime&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kt">var&lt;/span> &lt;span class="n">vertical&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="n">Input&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">GetAxis&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Vertical&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">PlayerMotionScaleLevel&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">Time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">deltaTime&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kt">var&lt;/span> &lt;span class="n">motion&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="n">transform&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">rotation&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Vector3&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">horizontal&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="m">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">vertical&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kt">var&lt;/span> &lt;span class="n">mag&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="n">motion&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">magnitude&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">motion&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="m">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">Player&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">transform&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">position&lt;/span> &lt;span class="p">+=&lt;/span> &lt;span class="n">motion&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">normalized&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">mag&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æå…¶ç®€å•çš„åšæ³•ï¼Œè·å–åˆ°é”®ç›˜ç§»åŠ¨çš„è½´ä¹‹åï¼Œç”¨æ‘„åƒæœºçš„æ—‹è½¬å››å…ƒæ•°ä¹˜ä¸€ä¸‹ï¼Œå³å¯å¾—åˆ°æ—‹è½¬åçš„å‘é‡ï¼ŒåŠ ä¸Šå»å°± ok äº†ã€‚&lt;/p>
&lt;p>éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œç”¨æ‘„åƒæœºçš„å››å…ƒæ•°æ—‹è½¬è¦æ±‚æ‘„åƒæœºå¿…é¡»åªåœ¨ x å’Œ y ä¸¤ä¸ªè½´æ—‹è½¬ã€‚&lt;/p>
&lt;p>å…ˆå¤‡ä»½ä¸€ä¸‹ä¸‰ç»´å‘é‡çš„æ•°é‡å€¼ï¼Œè¿™æ˜¯ä¸ºäº†èƒ½ä¿è¯æ‘„åƒæœºå‘ä¸Šå’Œå‘ä¸‹çœ‹æ—¶ï¼Œå¹³é¢ x å’Œ z è½´ä¸Šçš„åˆ†é‡ä¸ä¼šè¿‡å°ï¼Œä¿æŒä¸€è‡´çš„ç§»åŠ¨é€Ÿåº¦ã€‚&lt;/p>
&lt;p>ç”¨å››å…ƒæ•°æ—‹è½¬å®Œæˆåï¼Œå»é™¤ y è½´çš„å€¼ï¼Œä½¿ç›®æ ‡åªåœ¨å½“å‰å¹³é¢ä¸Šç§»åŠ¨ã€‚å†ç”¨ç®—å‡ºæ¥çš„å‘é‡çš„å•ä½å‘é‡ä¹˜ä¸Šä¹‹å‰å¤‡ä»½çš„æ•°é‡å€¼ï¼Œå¾—åˆ°å¹³é¢ä¸Šç§»åŠ¨çš„åç§»å‘é‡ã€‚&lt;/p>
&lt;p>æœ€åï¼Œç®—å‡ºæ–°çš„ä½ç½®åæ ‡ï¼Œèµ‹å€¼ï¼Œå®Œäº‹å„¿ã€‚&lt;/p></description></item><item><title>Unity3d æ‘„åƒæœºè·Ÿéšæ—‹è½¬çš„æ–¹æ¡ˆ</title><link>https://nnnewb.github.io/blog/p/unity3d-%E6%91%84%E5%83%8F%E6%9C%BA%E8%B7%9F%E9%9A%8F%E6%97%8B%E8%BD%AC%E7%9A%84%E6%96%B9%E6%A1%88/</link><pubDate>Sat, 03 Nov 2018 18:20:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/unity3d-%E6%91%84%E5%83%8F%E6%9C%BA%E8%B7%9F%E9%9A%8F%E6%97%8B%E8%BD%AC%E7%9A%84%E6%96%B9%E6%A1%88/</guid><description>&lt;h2 id="intro">Intro&lt;/h2>
&lt;p>ä¸»è¦æƒ³æ¢è®¨çš„æ˜¯å¦‚ä½•ä»¤æ‘„åƒæœºéšé¼ æ ‡æ“ä½œè¿›è¡Œæ—‹è½¬å’Œç§»åŠ¨ï¼Œæ‘„åƒæœºè·Ÿéšçš„è„šæœ¬å®˜æ–¹å°±æœ‰ Exampleã€‚&lt;/p>
&lt;h2 id="æ–¹æ¡ˆç‹¬ç«‹çš„è§’åº¦å˜é‡">æ–¹æ¡ˆï¼šç‹¬ç«‹çš„è§’åº¦å˜é‡&lt;/h2>
&lt;p>ä¸»è¦çš„ç‰¹ç‚¹æ˜¯ä½¿ç”¨ç‹¬ç«‹çš„è§’åº¦å˜é‡ï¼Œæ¯æ¬¡å¤„ç†é¼ æ ‡ç§»åŠ¨æ“ä½œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„&lt;code>Quaternion&lt;/code>ç”¨äºè®¡ç®—ã€‚&lt;/p>
&lt;p>å…ˆçœ‹ Demoã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c#" data-lang="c#">&lt;span class="k">public&lt;/span> &lt;span class="k">class&lt;/span> &lt;span class="nc">PlayerControls&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">MonoBehaviour&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="k">public&lt;/span> &lt;span class="n">GameObject&lt;/span> &lt;span class="n">Player&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">public&lt;/span> &lt;span class="kt">float&lt;/span> &lt;span class="n">Distance&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">//public float CameraRepositionSpeed;
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">public&lt;/span> &lt;span class="kt">float&lt;/span> &lt;span class="n">MouseMotionScaleLevel&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">public&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="n">ReverseAxisY&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">public&lt;/span> &lt;span class="kt">float&lt;/span> &lt;span class="n">PitchMaximum&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">public&lt;/span> &lt;span class="kt">float&lt;/span> &lt;span class="n">PitchMinimum&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">private&lt;/span> &lt;span class="kt">float&lt;/span> &lt;span class="m">_&lt;/span>&lt;span class="n">CurrentCameraAngleAroundX&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">private&lt;/span> &lt;span class="kt">float&lt;/span> &lt;span class="m">_&lt;/span>&lt;span class="n">CurrentCameraAngleAroundY&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">private&lt;/span> &lt;span class="n">Vector3&lt;/span> &lt;span class="m">_&lt;/span>&lt;span class="n">PositionTarget&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// Use this for initialization
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">void&lt;/span> &lt;span class="n">Start&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Update is called once per frame
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">void&lt;/span> &lt;span class="n">Update&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="m">_&lt;/span>&lt;span class="n">CurrentCameraAngleAroundX&lt;/span> &lt;span class="p">+=&lt;/span> &lt;span class="n">Input&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">GetAxis&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Mouse Y&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">MouseMotionScaleLevel&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">Time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">deltaTime&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">ReverseAxisY&lt;/span> &lt;span class="p">?&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="m">1&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="m">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="m">_&lt;/span>&lt;span class="n">CurrentCameraAngleAroundY&lt;/span> &lt;span class="p">+=&lt;/span> &lt;span class="n">Input&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">GetAxis&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Mouse X&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">MouseMotionScaleLevel&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">Time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">deltaTime&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="m">_&lt;/span>&lt;span class="n">CurrentCameraAngleAroundX&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="n">Mathf&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Clamp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="m">_&lt;/span>&lt;span class="n">CurrentCameraAngleAroundX&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PitchMinimum&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PitchMaximum&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="m">_&lt;/span>&lt;span class="n">PositionTarget&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="n">Player&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">transform&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">position&lt;/span> &lt;span class="p">+&lt;/span> &lt;span class="n">Quaternion&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Euler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="m">_&lt;/span>&lt;span class="n">CurrentCameraAngleAroundX&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="m">_&lt;/span>&lt;span class="n">CurrentCameraAngleAroundY&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="m">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="p">(-&lt;/span>&lt;span class="n">Player&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">transform&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">forward&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">Distance&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">//transform.position = Vector3.Lerp(transform.position, _PositionTarget, Time.deltaTime * CameraRepositionSpeed);
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">transform&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">position&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="m">_&lt;/span>&lt;span class="n">PositionTarget&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">transform&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">LookAt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Player&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">transform&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ ¸å¿ƒåœ¨äº&lt;code>_CurrentCameraAngleAroundX&lt;/code>å’Œ&lt;code>_CurrentCameraAngleAroundY&lt;/code>ä»¥åŠ&lt;code>Distance&lt;/code>ï¼Œè¿™ä¸‰ä¸ªå˜é‡å…±åŒå†³å®šäº†ä»¥ç©å®¶&lt;code>Player&lt;/code>ä¸ºåŸç‚¹çš„æåæ ‡ç³»ä¸‹æ‘„åƒæœºæ‰€å¤„çš„ç©ºé—´ä½ç½®ã€‚&lt;/p>
&lt;p>è®¡ç®—åæ ‡æ—¶åªéœ€è¦é€šè¿‡&lt;code>Quaternion.Euler&lt;/code>æ¥å–å¾—æ—‹è½¬å››å…ƒæ•°ï¼Œä»¥ç©å®¶ä¸ºåŸç‚¹è¡ç”Ÿä¸€æ¡ï¼ˆ0,0,-1ï¼‰çš„å‘é‡å¹¶ä¹˜ä¸Šå››å…ƒæ•°ä»¥æ—‹è½¬è‡³&lt;code>Player&lt;/code>æŒ‡å‘æ‘„åƒæœºçš„æ–¹å‘ï¼Œæœ€åä¹˜ä¸Š&lt;code>Distance&lt;/code>ï¼Œå³å¯å¾—åˆ°æ‘„åƒæœºç›¸å¯¹ç©å®¶çš„åç§»ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c#" data-lang="c#">&lt;span class="m">_&lt;/span>&lt;span class="n">PositionTarget&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="n">Player&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">transform&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">position&lt;/span> &lt;span class="p">+&lt;/span>
&lt;span class="n">Quaternion&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Euler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="m">_&lt;/span>&lt;span class="n">CurrentCameraAngleAroundX&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="m">_&lt;/span>&lt;span class="n">CurrentCameraAngleAroundY&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="m">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">*&lt;/span>
&lt;span class="p">(-&lt;/span>&lt;span class="n">Player&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">transform&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">forward&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">Distance&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ€ååªè¦å°†æ‘„åƒæœºæ”¾ç½®åœ¨é‚£ä¸ªä½ç½®ï¼Œç„¶å&lt;code>LookAt&lt;/code>æ—‹è½¬åˆ°&lt;code>z&lt;/code>è½´æ­£æ–¹å‘æŒ‡å‘ç©å®¶å°±å®Œäº‹å„¿äº†ã€‚&lt;/p></description></item><item><title>GameHollywood é¢è¯•ç¬”è®°</title><link>https://nnnewb.github.io/blog/p/gamehollywood-%E9%9D%A2%E8%AF%95%E7%AC%94%E8%AE%B0/</link><pubDate>Tue, 26 Jun 2018 17:22:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/gamehollywood-%E9%9D%A2%E8%AF%95%E7%AC%94%E8%AE%B0/</guid><description>&lt;h2 id="intro">Intro&lt;/h2>
&lt;p>é¢è¯•çš„èŒä½æ˜¯ C++åç«¯å¼€å‘å·¥ç¨‹å¸ˆï¼Œä¸»è¦èŠçš„è¿˜æ˜¯ C++ã€‚åœ¨è¿‡ç¨‹ä¸­è‡ªæˆ‘æ„Ÿè§‰é¢å¾—è¿˜è¡Œï¼Œè‡³å°‘æ²¡&lt;a class="link" href="https://my.oschina.net/u/3888259/blog/1833040" target="_blank" rel="noopener"
>ä¸Šæ¬¡&lt;/a>é‚£ä¹ˆè ¢ã€‚&lt;/p>
&lt;p>èŠçš„å†…å®¹ä¸»è¦é›†ä¸­åœ¨ STL å’Œçº¿ç¨‹å®‰å…¨ã€èµ„æºç®¡ç†çš„å±‚é¢ã€‚&lt;/p>
&lt;p>æƒ¯ä¾‹çš„ï¼Œå¡«å®Œé¢è¯•ä¿¡æ¯è¡¨å¹¶ç®€å†ä¸€èµ·ä¸Šäº¤ï¼Œç„¶åç­‰é¢è¯•å®˜æ¥å®¢å¥—å®Œï¼Œå°±å¼€å§‹èŠæŠ€æœ¯äº†ã€‚&lt;/p>
&lt;blockquote>
&lt;p>æ³¨æ„ï¼Œé¢è¯•å®˜çš„æé—®å¹¶éåŸè¯ï¼Œæœ‰ä¿®é¥°å’Œè„‘è¡¥ã€‚&lt;/p>
&lt;/blockquote>
&lt;h2 id="0-é¢„çƒ­ä½ ç”¨å“ªä¸ªç‰ˆæœ¬çš„-c">0. é¢„çƒ­ï¼šä½ ç”¨å“ªä¸ªç‰ˆæœ¬çš„ C++ï¼Ÿ&lt;/h2>
&lt;p>å®¢å¥—è¯ä»€ä¹ˆçš„å°±ç•¥äº†ã€‚&lt;/p>
&lt;blockquote>
&lt;p>é¢è¯•å®˜ï¼š&amp;hellip;è¡Œï¼Œé‚£æˆ‘ä»¬å°±èŠèŠ C++å§ã€‚ä½ å¸¸ç”¨å“ªä¸ªç‰ˆæœ¬çš„ C++ï¼Ÿ&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>æˆ‘ï¼šæˆ‘æ¯”è¾ƒå¸¸ç”¨çš„æ˜¯ C++11ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>C++ç‰ˆæœ¬è¿™ä¸ªé—®é¢˜é¢è¯•é‡Œåº”è¯¥ä¸å¤šè§ï¼Œä¸è¿‡ä½œä¸ºå¼•å…¥çš„è¯é¢˜è¿˜è¡Œï¼Œæ ‡å‡†ä¹‹ç¥ä¼šç‘ç›®çš„ã€‚&lt;/p>
&lt;p>å¯¹äº&lt;strong>C++ç‰ˆæœ¬&lt;/strong>è¿™ä¸ªè¯ï¼Œå¾ˆå¤§æ¦‚ç‡ä¸Šå¤§å®¶è¯´çš„åº”è¯¥å°±æ˜¯ C++æ ‡å‡†å§”å‘˜ä¼š&lt;a class="link" href="http://www.open-std.org/JTC1/SC22/WG21/" target="_blank" rel="noopener"
>WG21&lt;/a>åˆ¶å®šçš„ C++æ ‡å‡†äº†ï¼Œæœ€æ–°ç‰ˆæœ¬çš„æ ‡å‡†æ–‡æ¡£æ˜¯ C++17 å®šç¨¿&lt;a class="link" href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2017/n4659.pdf" target="_blank" rel="noopener"
>N4659&lt;/a>ï¼Œåˆ¶å®šä¸­çš„ C++20 æ ‡å‡†æ–‡æ¡£å¯ä»¥è®¿é—®&lt;a class="link" href="http://www.open-std.org/JTC1/SC22/WG21/docs/papers/2018/" target="_blank" rel="noopener"
>WG21/docs/papers/2018&lt;/a>æŸ¥é˜…ã€‚&lt;/p>
&lt;p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœç­”æˆäº†&lt;strong>æˆ‘ç”¨ VC6&lt;/strong>ä¹‹ç±»çš„éªšè¯ï¼Œå¾ˆå¤§æ¦‚ç‡ä¼šç•™ä¸‹ä¸å¥½çš„æ˜ åƒâ€”â€”æˆ–è€…å¯¹æ–¹ä¹Ÿæ˜¯å¿ å®çš„ VC6 ç¥æ•™æ•™å¾’çš„è¯ï¼Œè¾¾æˆå…±è¯†ä¹Ÿè¯´ä¸å®šã€‚&lt;/p>
&lt;p>é—²è¯å°‘å™ã€‚&lt;/p>
&lt;h2 id="1-èµ·æ‰‹å¼stdshared_ptr">1. èµ·æ‰‹å¼ï¼š&lt;code>std::shared_ptr&lt;/code>&lt;/h2>
&lt;blockquote>
&lt;p>é¢è¯•å®˜ï¼šè¯´è¯´&lt;code>std::shared_ptr&lt;/code>æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿä¸€èˆ¬æ€ä¹ˆå»ä½¿ç”¨å®ƒï¼Ÿ&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>ç­”ï¼š&lt;code>shared_ptr&lt;/code>æ˜¯é€šè¿‡&lt;strong>å¼•ç”¨è®¡æ•°&lt;/strong>å®ç°çš„ï¼Œå®ƒå¯ä»¥ä½œä¸ºå®¹å™¨å…ƒç´ ï¼Œåœ¨ç¨‹åºé‡Œä¼ é€’ blabal&amp;hellip;..è€Œä¸”&lt;code>shared_ptr&lt;/code>&lt;strong>ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„&lt;/strong>ï¼Œå®ƒä¸èƒ½è·¨çº¿ç¨‹ä¼ é€’ï¼Œè¦é¢å¤–åšä¸€å±‚åŒ…è£… blabla&amp;hellip;&amp;hellip;&lt;/p>
&lt;/blockquote>
&lt;p>æ­£å·§æœ€è¿‘æœ‰æƒ³å†™ä¸€ç¯‡æ™ºèƒ½æŒ‡é’ˆç›¸å…³çš„åšå®¢ï¼Œé¢è¯•å®˜çš„ç¬¬ä¸€é—®å°±æåˆ°äº†ã€‚&lt;/p>
&lt;p>è¯´åˆ°æ™ºèƒ½æŒ‡é’ˆï¼Œå°±å¿…é¡»æä¸€ä¸‹ RAII äº†ã€‚&lt;/p>
&lt;h3 id="11-å¼‚å¸¸å®‰å…¨å’Œ-raii">1.1 å¼‚å¸¸å®‰å…¨å’Œ RAII&lt;/h3>
&lt;p>&lt;code>std::shared_ptr&lt;/code>å’Œå…¶ä»–æ™ºèƒ½æŒ‡é’ˆç±»å‹éƒ½åœ¨&lt;code>&amp;lt;memory&amp;gt;&lt;/code>å¤´æ–‡ä»¶é‡Œå®šä¹‰ï¼Œä¸»è¦çš„ä½œç”¨æ˜¯å®ç°è‡ªåŠ¨åŒ–çš„èµ„æºç®¡ç†ï¼ŒåŸºäº&lt;strong>RAII&lt;/strong>çš„ç†å¿µè®¾è®¡å’Œå®ç°ã€‚&lt;/p>
&lt;p>&lt;strong>RAII&lt;/strong>æŒ‡çš„æ˜¯&lt;strong>è·å–èµ„æºå³åˆå§‹åŒ–&lt;/strong>ï¼Œè‹±æ–‡å…¨å†™æ˜¯&lt;strong>Resource Acquisition Is Initialization&lt;/strong>ï¼Œå±äºä¸€ç§é¢å‘å¯¹è±¡ç¼–ç¨‹è¯­è¨€ä¸­å¸¸è§çš„æƒ¯ç”¨æ³•ã€‚&lt;/p>
&lt;p>å®ƒçš„æ€è·¯æ˜¯è¿™æ ·å­çš„ï¼šåˆå§‹åŒ–å³è·å–èµ„æºï¼Œç¦»å¼€ä½œç”¨åŸŸå°±è‡ªåŠ¨é”€æ¯ã€‚&lt;/p>
&lt;p>RAII è§£å†³çš„é—®é¢˜æ˜¯ï¼Œå½“å¼‚å¸¸å‘ç”Ÿæ—¶ï¼Œå¦‚ä½•ç¡®ä¿èµ„æºé‡Šæ”¾ã€‚è¿™æ˜¯ä¸ª&lt;strong>å¼‚å¸¸å®‰å…¨&lt;/strong>çš„é—®é¢˜ã€‚&lt;/p>
&lt;p>å¸¸è§çš„é RAII é£æ ¼ä»£ç é‡Œï¼Œå¦‚æœè¦ç¡®ä¿èµ„æºè¢«æ­£ç¡®é‡Šæ”¾ï¼Œå°±è¦ç”¨&lt;code>try {} catch() {} finally {}&lt;/code>å—æ•è·å¼‚å¸¸ï¼Œç„¶åæ‰§è¡Œèµ„æºé‡Šæ”¾çš„ä»£ç ï¼Œå†å°†å¼‚å¸¸é‡æ–°æŠ›å‡ºã€‚&lt;/p>
&lt;p>è€Œ RAII çš„ç†å¿µæ˜¯ï¼Œè®©èµ„æºçš„ç”Ÿå‘½å‘¨æœŸå’Œä¸€ä¸ªæ ˆä¸Šçš„å¯¹è±¡ä¸¥æ ¼ç»‘å®šï¼Œç¡®ä¿æ ˆä¸Šå¯¹è±¡è¢«ææ„çš„æ—¶å€™ï¼Œèµ„æºä¹Ÿå°±è¢«ä¸€åŒé‡Šæ”¾äº†ã€‚&lt;/p>
&lt;p>åœ¨ C++ä¸­ï¼Œæœ‰å¤§é‡çš„ä»£ç éƒ½æ˜¯ä»¥ RAII é£æ ¼è¿›è¡Œè®¾è®¡çš„ï¼Œå…¶ä¸­æ™ºèƒ½æŒ‡é’ˆä¹Ÿæ˜¯ã€‚&lt;/p>
&lt;h3 id="12-stdshared_ptrçš„å®ç°">1.2 &lt;code>std::shared_ptr&lt;/code>çš„å®ç°&lt;/h3>
&lt;p>å¼•ç”¨è®¡æ•°ï¼Œå¤§æ¦‚äº†è§£è¿‡æ™ºèƒ½æŒ‡é’ˆçš„äººéƒ½èƒ½å›ç­”å¾—å‡ºæ¥ã€‚&lt;/p>
&lt;p>è™½ç„¶è¯´å®ç°æ–¹å¼å¹¶æ²¡æœ‰è§„å®šåªèƒ½æ˜¯å¼•ç”¨è®¡æ•°ï¼Œä½†å®é™…ä¸Šå¤§å®¶éƒ½æ˜¯è¿™ä¹ˆå†™çš„ï¼Œä¸‡ä¸€å“ªå¤©æœ‰ä¸ª GC å®ç°çš„&lt;code>std::shared_ptr&lt;/code>ä¹Ÿåˆ«å¤ªéœ‡æƒŠã€‚&lt;/p>
&lt;p>å®ç°æ€è·¯ä¹ŸæŒºç®€å•ã€‚&lt;/p>
&lt;p>æ‰€æœ‰æŒ‡å‘åŒä¸€å®ä¾‹çš„&lt;code>std::shared_ptr&lt;/code>åº”å½“æŒæœ‰åŒä¸€ä¸ªå¼•ç”¨è®¡æ•°ï¼Œæ¥ä¿æŒæ‰€æœ‰&lt;code>std::shared_ptr&lt;/code>è®¡æ•°åŒæ­¥ï¼Œæ‰€ä»¥å®ƒä»¬å…±åŒæ‹¥æœ‰ä¸€ä¸ªè®¡æ•°å™¨æŒ‡é’ˆ&lt;code>long *p&lt;/code>ã€‚&lt;/p>
&lt;p>åœ¨å¤åˆ¶æ—¶ï¼Œ&lt;code>shared_ptr&lt;/code>ç®¡ç†çš„å¯¹è±¡æŒ‡é’ˆå’Œå¼•ç”¨è®¡æ•°å™¨æŒ‡é’ˆè¢«åŒæ—¶å¤åˆ¶ï¼Œç„¶åå¼•ç”¨è®¡æ•°å™¨æŒ‡é’ˆä¿å­˜çš„å¼•ç”¨è®¡æ•°+1â€”â€”é”€æ¯åŒç†ï¼Œå‡å°‘å¼•ç”¨ï¼Œç›´åˆ°åˆ é™¤ã€‚&lt;/p>
&lt;h3 id="13-stdshared_ptrå’Œcopyassignable">1.3 &lt;code>std::shared_ptr&lt;/code>å’Œ&lt;code>CopyAssignable&lt;/code>&lt;/h3>
&lt;p>&lt;code>std::shared_ptr&lt;/code>æ»¡è¶³&lt;code>CopyContructiable&lt;/code>ã€&lt;code>CopyAssignable&lt;/code>å’Œ&lt;code>LessThanComparable&lt;/code>è¿™äº›æ ‡å‡†åº“çš„&lt;a class="link" href="https://zh.cppreference.com/w/cpp/named_req" target="_blank" rel="noopener"
>å…·åè¦æ±‚&lt;/a>ï¼Œå› æ­¤å¯ä»¥ä½œä¸º STL å®¹å™¨çš„å…ƒç´ ã€‚&lt;/p>
&lt;blockquote>
&lt;p>é¡ºä¾¿ä¸€æ &lt;code>Concept&lt;/code> æœ‰å¾ˆå¤§å¯èƒ½å‡ºç°åœ¨ C++20 æ ‡å‡†é‡Œã€‚&lt;/p>
&lt;/blockquote>
&lt;h3 id="14-çº¿ç¨‹å®‰å…¨æ€§">1.4 çº¿ç¨‹å®‰å…¨æ€§&lt;/h3>
&lt;p>&lt;code>std::shared_ptr&lt;/code>ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸ç„¶ä¸æ»¡è¶³ C++å¯¹&lt;code>Zero Cost Abstraction&lt;/code>çš„è¦ï¼ˆå¹ï¼‰æ±‚ï¼ˆé€¼ï¼‰ã€‚&lt;/p>
&lt;p>ä¾æ®å®˜æ–¹è¯´æ³•ï¼Œå¤šçº¿ç¨‹è®¿é—®ä¸åŒçš„&lt;code>std::shared_ptr&lt;/code>å®ä¾‹æ˜¯æ²¡é—®é¢˜çš„ï¼ˆå¤§å¤šå®¹å™¨ä¹Ÿæ˜¯ï¼‰ï¼›å¤šçº¿ç¨‹è®¿é—®åŒä¸€ä¸ª&lt;code>std::shared_ptr&lt;/code>å®ä¾‹ï¼Œä½†æ˜¯åªè°ƒç”¨&lt;code>const&lt;/code>æ–¹æ³•ï¼Œé‚£ä¹ˆä¹Ÿæ˜¯æ²¡é—®é¢˜çš„ï¼ˆå¤šçº¿ç¨‹è¯»ï¼‰ï¼›å¤šçº¿ç¨‹è®¿é—®åŒä¸€ä¸ª&lt;code>std::shared_ptr&lt;/code>å®ä¾‹ï¼Œè°ƒç”¨é&lt;code>const&lt;/code>æ–¹æ³•ï¼Œé‚£ä¹ˆä¼šäº§ç”Ÿæ•°æ®ç«äº‰ï¼ˆå¤šçº¿ç¨‹è¯»å†™ï¼‰ã€‚&lt;/p>
&lt;p>å¦‚æœå¸Œæœ›åœ¨çº¿ç¨‹é—´ä¼ é€’ &lt;code>std::shared_ptr&lt;/code> å¾—é  STL æä¾›çš„åŸå­æ“ä½œåº“&lt;code>std::atomic&lt;/code>ã€‚&lt;/p>
&lt;p>&lt;code>std::atomic&lt;/code>å¯ä»¥å¿«é€Ÿå¸®åŠ©åŒ…è£…ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„å¯¹è±¡æˆ–è€…æŒ‡é’ˆï¼Œä¸è¿‡è¿™ä¸œè¥¿å¯¹&lt;code>std::shared_ptr&lt;/code>çš„ç‰¹åŒ–æ˜¯ç›®å‰è¿˜åœ¨åˆ¶å®šçš„&lt;code>C++20&lt;/code>æ ‡å‡†çš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥èƒ½ä¸ç”¨åˆ™ä¸ç”¨ï¼Œç›´åˆ°æ ‡å‡†åˆ¶å®šå®Œæˆç¨³å®šï¼Œå¹¶ä¸”å„ç¼–è¯‘å™¨æ”¯æŒå®Œå–„åå†è¡Œè€ƒè™‘ã€‚&lt;/p>
&lt;p>é™¤æ­¤ä¹‹å¤–ï¼Œå¦‚æœç¡®å®æœ‰è¿™æ–¹é¢çš„è€ƒè™‘ï¼Œå¼•å…¥&lt;code>boost&lt;/code>æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚&lt;/p>
&lt;p>æ— è®ºå¦‚ä½•ï¼Œè·¨çº¿ç¨‹ä½¿ç”¨&lt;code>std::shared_ptr&lt;/code>æˆ‘ä¸æ€ä¹ˆæ”¯æŒã€‚&lt;/p>
&lt;p>è·¨çº¿ç¨‹ä¼ é€’&lt;code>std::shared_ptr&lt;/code>æœ¬èº«å°±æ˜¯ä¸ªéå¸¸å±é™©çš„è¡Œä¸ºã€‚&lt;code>std::shared_ptr&lt;/code>ä½œä¸ºæ ‡å‡†åº“çš„ä¸€å‘˜ï¼ŒèƒŒè´Ÿäº† C++çš„å†å²åŒ…è¢±ï¼Œå®ƒéšæ—¶å¯èƒ½è¢«å–å‡ºè£¸æŒ‡é’ˆä½¿ç”¨ï¼Œæˆ–è€…æ„å¤–å¤åˆ¶äº†ä¸€æ¬¡æˆ–å‡ æ¬¡ï¼Œè€Œè¿™äº›å¯¹çº¿ç¨‹å®‰å…¨å‡ ä¹å°±æ˜¯æ„å‘³ç€ä½œæ­»çš„è¡Œä¸ºå´æ²¡æœ‰ä»»ä½•ç®¡æŸã€‚&lt;/p>
&lt;h3 id="15-å…¶ä»–æ™ºèƒ½æŒ‡é’ˆ">1.5 å…¶ä»–æ™ºèƒ½æŒ‡é’ˆ&lt;/h3>
&lt;ul>
&lt;li>&lt;code>std::auto_ptr&lt;/code>&lt;/li>
&lt;li>&lt;code>std::weak_ptr&lt;/code>&lt;/li>
&lt;li>&lt;code>std::unique_ptr&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>å…¶ä¸­&lt;code>std::auto_ptr&lt;/code>å·²ç»è¢«æ‰«è¿›å†å²çš„åƒåœ¾å †äº†ï¼Œä½œä¸ºæ›¿ä»£è€…ï¼Œ&lt;code>std::unique_ptr&lt;/code>æœ‰æ›´æ˜ç¡®çš„è¯­ä¹‰å’Œæ›´é«˜çš„å¯å®šåˆ¶æ€§ã€‚&lt;/p>
&lt;p>&lt;code>std::weak_ptr&lt;/code>æ˜¯å¯¹äº&lt;code>std::shared_ptr&lt;/code>çš„è¡¥å……ï¼Œå¯¹äºå¸Œæœ›ä½¿ç”¨&lt;code>std::shared_ptr&lt;/code>ä½œä¸ºä½¿ç”¨äº†æŒ‡é’ˆçš„æ•°æ®ç»“æ„ä¹‹é—´çš„è¿æ¥æ–¹å¼ï¼Œåˆä¸å¸Œæœ›äº§ç”Ÿå¾ªç¯å¼•ç”¨æ¶åŠ£æƒ…å†µçš„ä¸€ä¸ªè§£å†³æ–¹æ¡ˆã€‚å¼±æŒ‡é’ˆçš„å­˜åœ¨ä¸å½±å“å¼•ç”¨è®¡æ•°å·¥ä½œã€‚&lt;/p>
&lt;p>æœ€åæ˜¯&lt;code>std::unique_ptr&lt;/code>ï¼Œå®ƒçš„è¯­ä¹‰æ˜¯æ˜ç¡®å”¯ä¸€æŒæœ‰æŸä¸€èµ„æºï¼Œä¾ç…§çº¦å®šï¼Œè¢«&lt;code>std::unique_ptr&lt;/code>æŒæœ‰çš„èµ„æºä¸åº”è¯¥å†æœ‰ç¬¬äºŒäººæŒæœ‰ï¼Œ&lt;code>std::unique_ptr&lt;/code>æ˜¯å”¯ä¸€è®¿é—®è¯¥èµ„æºçš„å…¥å£ã€‚&lt;/p>
&lt;p>è¿™äº›æ™ºèƒ½æŒ‡é’ˆéƒ½æœ‰ä¸€ä¸ªå…±åŒç‚¹ï¼šä¸ºäº†å…¼å®¹ C ä»£ç ï¼Œæ‰€ä»¥å®ƒä»¬éšæ—¶å¯ä»¥è¢«å–å‡ºè£¸æŒ‡é’ˆè€Œä¸å½±å“è‡ªèº«çš„å·¥ä½œï¼Œä½†è¿™ç§ä½¿ç”¨æ–¹å¼é€ æˆçš„ä¸€åˆ‡åæœè‡ªè´Ÿã€‚&lt;/p>
&lt;h2 id="2-stdvector">2. &lt;code>std::vector&lt;/code>&lt;/h2>
&lt;blockquote>
&lt;p>é¢è¯•å®˜ï¼š&amp;hellip;çŸ¥é“&lt;code>std::vector&lt;/code>å§ï¼Ÿè®²è®²å®ƒæ˜¯æ€ä¹ˆå®ç°çš„ã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>æˆ‘ï¼švector ä¿å­˜äº†ä¸€ä¸ªä¸€å®šé•¿åº¦çš„ bufferï¼Œå½“æ’å…¥æ—¶å¯ä»¥é¿å…æ’å…¥ä¸€æ¬¡å°±åˆ†é…ä¸€æ¬¡ç©ºé—´ blabla&amp;hellip;å½“æ’å…¥é•¿åº¦è¶…è¿‡äº† buffer é•¿åº¦ï¼Œbuffer ä¼šä¾ç…§å†…éƒ¨ç®—æ³•æ¥é‡æ–°åˆ†é…ä¸€æ¬¡å†…å­˜ï¼Œæ‰©å¼ é•¿åº¦ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>å›ç­”ä¸å…¨å¯¹ã€‚å…¶å®é¢è¯•å®˜ä¹‹ååˆå¼ºè°ƒäº†ä¸€æ¬¡ï¼Œä½†é¢è¯•æ—¶æ²¡æœ‰å¬å‡ºæ¥ã€‚&lt;/p>
&lt;blockquote>
&lt;p>é¢è¯•å®˜ï¼šé‚£ä¹‹å‰åˆ†é…çš„ buffer å‘¢ï¼Ÿ&lt;/p>
&lt;p>æˆ‘ï¼šä¹‹å‰åˆ†é…çš„ buffer å…ˆå¤åˆ¶åˆ°æ–°çš„ buffer é‡Œï¼Œç„¶åæ—§ buffer ä¼šè¢«é‡Šæ”¾ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>è¿™é‡Œå¯¹äºé‡Šæ”¾æ—§ buffer çš„è¯´æ³•å…¶å®æ˜¯æœ‰é—®é¢˜çš„ï¼Œå¯ä»¥å…·ä½“çœ‹çœ‹ä¸‹é¢ã€‚&lt;/p>
&lt;h3 id="21-å†…å­˜å¸ƒå±€">2.1 å†…å­˜å¸ƒå±€&lt;/h3>
&lt;p>&lt;code>std::vector&lt;/code>çš„&lt;strong>å†…å­˜å¸ƒå±€æ˜¯è¿ç»­çš„&lt;/strong>ï¼Œè¿™ä¸€ç‚¹é™¤äº†å‡ ä¹æ¯ä¸ªäººéƒ½æœ‰æ‰€äº†è§£ä¹‹å¤–ï¼ˆ&amp;hellip;ï¼‰ï¼Œæ ‡å‡†ç»™å‡ºçš„è¦æ±‚ä¹Ÿå¯ä»¥çœ‹å‡ºç‚¹ç«¯å€ªã€‚&lt;/p>
&lt;blockquote>
&lt;p>26.3.11.1 Class template vector overview&lt;/p>
&lt;p>A vector is a sequence container that supports (amortized) constant time insert and erase operations at the end; insert and erase in the middle take linear time. Storage management is handled automatically, though hints can be given to improve eï¬ƒciency.&lt;/p>
&lt;/blockquote>
&lt;p>å…³é”®ç‚¹é›†ä¸­åœ¨è¿™é‡Œï¼š&lt;/p>
&lt;blockquote>
&lt;p>&amp;hellip; constant time insert and erase operations at the end;&lt;/p>
&lt;/blockquote>
&lt;p>æœ«ç«¯æ’å…¥å’Œåˆ é™¤æ˜¯å¸¸æ•°æ—¶é—´&lt;/p>
&lt;blockquote>
&lt;p>&amp;hellip; insert and erase in the middle take linear time.&lt;/p>
&lt;/blockquote>
&lt;p>ä¸­é—´æ’å…¥å’Œåˆ é™¤éœ€è¦çº¿æ€§æ—¶é—´ï¼ˆå°±æ˜¯ &lt;code>O(n)&lt;/code>ï¼‰ã€‚&lt;/p>
&lt;p>å…¸å‹çš„æ•°ç»„æ’å…¥å’Œåˆ é™¤çš„ç‰¹å¾ï¼Œä¸åŒçš„æ˜¯&lt;code>std::vector&lt;/code>å¯ä»¥å˜é•¿ï¼Œæ‰€ä»¥çœŸæ­£æ’å…¥å¤§é‡æ•°æ®çš„æ—¶å€™ä¼šæœ‰å¤šæ¬¡é‡æ–°åˆ†é…å†…å­˜å’Œå¤åˆ¶çš„æ“ä½œã€‚&lt;/p>
&lt;h3 id="22-copyassignableçš„çº¦å®š">2.2 &lt;code>CopyAssignable&lt;/code>çš„çº¦å®š&lt;/h3>
&lt;p>&lt;code>std::vector&lt;/code>è¦æ±‚å‚¨å­˜çš„å¯¹è±¡æ»¡è¶³&lt;code>DefautConstructible&lt;/code>ã€&lt;code>CopyContructiable&lt;/code>å’Œ&lt;code>CopyAssignable&lt;/code>çš„å…·åè¦æ±‚ï¼Œæ–‡æ¡£å‚è€ƒ&lt;code>26.3.11.1&lt;/code>ç¬¬ 2 èŠ‚ã€‚&lt;/p>
&lt;blockquote>
&lt;p>26.3.11.1&lt;/p>
&lt;p>A vector satisï¬es all of the requirements of a container and of a reversible container (given in two tables in 26.2), of a sequence container, including most of the optional sequence container requirements (26.2.3), of an allocator-aware container (Table 86), and, for an element type other than bool, of a contiguous container (26.2.1).&lt;/p>
&lt;/blockquote>
&lt;p>å…¶ä¸­æåˆ°çš„&lt;code>Table 86&lt;/code>ä¸­åˆ—å‡ºäº†&lt;code>DefaultConstructible&lt;/code>ã€&lt;code>CopyAssignable&lt;/code>å’Œ&lt;code>CopyConstructiable&lt;/code>ã€‚&lt;/p>
&lt;p>å‘æŒ¥ä¸€ä¸‹è„‘æ´ï¼Œè¿™äº›è¦æ±‚å®Œç¾ç¬¦åˆäº†ä¹‹å‰å¯¹äºé‡æ–°åˆ†é…å†…å­˜çš„çŒœæµ‹å¯¹ä¸å¯¹ï¼Ÿ&lt;/p>
&lt;p>å¯¹è±¡è¦å¯ä»¥è¢«é»˜è®¤æ„é€ ï¼Œå› ä¸º&lt;code>vector&lt;/code>çš„å®ç°å¯èƒ½æ˜¯&lt;code>new&lt;/code>äº†ä¸€ä¸ªæ–°çš„å¯¹è±¡æ•°ç»„ï¼ˆæ›´å¯èƒ½æ˜¯å­—èŠ‚æ•°ç»„ï¼Œåˆ°æ—¶å€™å†&lt;code>placement new&lt;/code>ï¼‰ï¼›å¯¹è±¡è¦å¯ä»¥è¢«å¤åˆ¶æ„é€ ï¼Œå› ä¸ºå¯¹è±¡å¯èƒ½è¢«ä»æ—§æ•°ç»„ç§»åŠ¨åˆ°æ–°æ•°ç»„ï¼›å¯¹è±¡è¦å¯ä»¥è¢«å¤åˆ¶æ„é€ &amp;hellip;..&lt;/p>
&lt;p>å½“ç„¶æ›´å¯èƒ½çš„åŸå› æ˜¯&lt;code>vector&lt;/code>æœ¬èº«æ˜¯å¯å¤åˆ¶çš„ï¼Œä¸Šé¢çš„å°±å½“æˆ‘å¹é€¼å§ã€‚&lt;/p>
&lt;p>é™¤æ­¤ä¹‹å¤–è¿˜æœ‰&lt;code>CopyInsertable&lt;/code>å’Œ&lt;code>MoveInsertable&lt;/code>çš„å…·åéœ€æ±‚ï¼Œå°±åƒå…¶å­—é¢æ„ä¹‰é‚£æ ·ï¼Œä¸å¤šåšè§£é‡Šã€‚&lt;/p>
&lt;h3 id="23-å†…å­˜é‡æ–°åˆ†é…çš„æ–¹å¼">2.3 å†…å­˜é‡æ–°åˆ†é…çš„æ–¹å¼&lt;/h3>
&lt;p>å¯¹ C ç¨æœ‰ç»éªŒçš„äººåº”è¯¥çŸ¥é“ C è¯­è¨€æœ‰ä¸€ä¸ª API å«åš&lt;code>realloc&lt;/code>ï¼Œå®ƒåšçš„äº‹æƒ…æ˜¯è¿™æ ·çš„ï¼š&lt;/p>
&lt;ol>
&lt;li>å¦‚æœå¯èƒ½çš„è¯ï¼Œæ‰©å¼ åŸå…ˆåˆ†é…çš„å†…å­˜çš„é•¿åº¦ã€‚&lt;/li>
&lt;li>å¦åˆ™é‡æ–°åˆ†é…ä¸€å—å†…å­˜ï¼Œç„¶åæŠŠæ—§çš„å†…å­˜å¤åˆ¶è¿‡å»ï¼Œé‡Šæ”¾æ—§å†…å­˜ï¼Œè¿”å›æ–°æŒ‡é’ˆã€‚&lt;/li>
&lt;li>å¦‚æœæ‰¾ä¸åˆ°è¶³å¤Ÿé•¿åº¦çš„è¿ç»­å†…å­˜ï¼Œåˆ™è¿”å› NULLï¼Œä¸é‡Šæ”¾æ—§å†…å­˜ã€‚&lt;/li>
&lt;/ol>
&lt;p>C++è‡ªç„¶ä¸ä¼šå°‘ã€‚&lt;/p>
&lt;p>é¢è¯•æ—¶æ²¡æœ‰æƒ³èµ·æ¥ï¼Œæœ¬æ¥è®¤ä¸ºæ˜¯ä¸€ç§ä¼˜åŒ–æ–¹æ¡ˆï¼Œä½† STL æœ¬èº«å°±ç®—æ˜¯ä¼˜åŒ–æ–¹æ¡ˆäº†å§ï¼ˆ&amp;hellip;ï¼‰ã€‚æ­£ç¡®çš„è§£ç­”åº”è¯¥æ˜¯&lt;/p>
&lt;blockquote>
&lt;p>ç”¨ realloc çš„æ–¹å¼å°è¯•æ‰©å±• buffer é•¿åº¦ï¼Œå¦‚æœæ— æ³•æ‰©å±•é•¿åº¦ï¼Œåˆ™æ‹·è´æ—§ buffer åˆ°æ–° bufferï¼Œå†é‡Šæ”¾æ—§ bufferã€‚&lt;/p>
&lt;/blockquote>
&lt;p>è¿˜è¡Œï¼Œå¤±è¯¯å°±æ˜¯å¤±è¯¯ï¼Œè®¤é”™å¤ä¹ ä¸€éã€‚&lt;/p>
&lt;h2 id="3-æ¯”è¾ƒä¸‰ä¸ªå®¹å™¨vectormaplist">3. æ¯”è¾ƒä¸‰ä¸ªå®¹å™¨ï¼š&lt;code>vector&lt;/code>,&lt;code>map&lt;/code>,&lt;code>list&lt;/code>&lt;/h2>
&lt;blockquote>
&lt;p>é¢è¯•å®˜ï¼šè¯´è¯´çœ‹&lt;code>vector&lt;/code>ã€&lt;code>list&lt;/code>ã€&lt;code>map&lt;/code>æœ‰ä»€ä¹ˆä¸åŒï¼Œåˆ†åˆ«åœ¨ä»€ä¹ˆæ ·çš„ä¸Šä¸‹æ–‡ç¯å¢ƒé‡Œå»ä½¿ç”¨å®ƒä»¬å§ã€‚&lt;/p>
&lt;p>æˆ‘ï¼švector å¯ä»¥è¢«éšæœºè®¿é—®ï¼Œæ”¯æŒéšæœºè®¿é—®è¿­ä»£å™¨ï¼Œè¿­ä»£å™¨ç®—æ³•æœ‰äº›ä¸é€‚ç”¨åœ¨&lt;code>list&lt;/code>å’Œ&lt;code>map&lt;/code>ä¸Š blabla&amp;hellip;&lt;code>list&lt;/code>é€šå¸¸æ˜¯é“¾è¡¨å®ç°ï¼Œåœ¨æ’å…¥åˆ é™¤çš„æ€§èƒ½ä¸Šæœ‰ä¼˜åŠ¿ blabla&amp;hellip;&amp;hellip;&lt;/p>
&lt;/blockquote>
&lt;p>é¡ºä¾¿ä¸€æè¿˜æ²¡è¯´åˆ°&lt;code>map&lt;/code>ï¼Œé¢è¯•å®˜å°±æ¢è¯é¢˜äº†ã€‚&lt;/p>
&lt;p>è¿™ä¸€é¢˜æˆ‘å¤§æ¦‚åˆæ²¡æœ‰ get åˆ°é¢è¯•å®˜çš„ pointï¼Œå•è°ˆè®ºå®¹å™¨çš„è¯å¯è¯´çš„ä¸œè¥¿ä¸å°‘ï¼Œæˆ‘è§‰å¾—é¢è¯•å®˜å¯èƒ½æ›´æƒ³äº†è§£ä¸‹æˆ‘å¯¹è¿™äº›å®¹å™¨çš„æ€§èƒ½å’Œå†…å­˜æ–¹é¢çš„è®¤çŸ¥ï¼Œå¯æƒœæˆ‘ç­”çš„æœ‰äº›å¤ªæµ…ç™½äº†ã€‚&lt;/p>
&lt;h3 id="31-è¿­ä»£å™¨">3.1 è¿­ä»£å™¨&lt;/h3>
&lt;p>å…ˆä»è¿­ä»£å™¨çš„è§’åº¦æ¯”è¾ƒä¸‰ä¸ªå®¹å™¨ã€‚&lt;/p>
&lt;p>&lt;code>vector&lt;/code>æ˜¯ä¸ªå…¸å‹çš„éšæœºè®¿é—®å®¹å™¨ï¼Œæ˜¾ç„¶æ”¯æŒ&lt;code>forward iterator&lt;/code>ã€&lt;code>reversible iterator&lt;/code>å’Œ&lt;code>random access iterator&lt;/code>ã€‚å…¸å‹çš„å®ç°æ˜¯&lt;a class="link" href="https://en.wikipedia.org/wiki/Dynamic_array" target="_blank" rel="noopener"
>&lt;code>dynamic array&lt;/code>&lt;/a>ã€‚&lt;/p>
&lt;p>&lt;code>list&lt;/code>æ˜¯ä¸ªçº¿æ€§ç»“æ„å®¹å™¨ï¼Œæ”¯æŒ&lt;code>forward iterator&lt;/code>ã€&lt;code>reversible iterator&lt;/code>ã€‚å…¸å‹çš„å®ç°æ˜¯é“¾è¡¨ã€‚&lt;/p>
&lt;p>&lt;code>map&lt;/code>æ˜¯ä¸ªæ ‘å½¢å®¹å™¨ï¼Œæ”¯æŒ&lt;code>forward iterator&lt;/code>å’Œ&lt;code>reversible iterator&lt;/code>ã€‚å…¸å‹çš„å®ç°æ˜¯çº¢é»‘æ ‘ã€‚&lt;/p>
&lt;h3 id="32-å†…å­˜å¸ƒå±€å’Œè®¿é—®æ•ˆç‡">3.2 å†…å­˜å¸ƒå±€å’Œè®¿é—®æ•ˆç‡&lt;/h3>
&lt;p>è®¨è®ºå¸¸è§å®ç°ã€‚&lt;/p>
&lt;p>&lt;code>vector&lt;/code>æ˜¯è¿ç»­åˆ†é…ï¼Œè®¿é—®æˆæœ¬ä½ï¼Œæ’å…¥å’Œåˆ é™¤çš„æˆæœ¬é«˜ï¼Œä¼šé‡åˆ†é…å†…å­˜ã€‚&lt;/p>
&lt;p>&lt;code>list&lt;/code>æ˜¯ä¸è¿ç»­åˆ†é…ï¼Œè®¿é—®æˆæœ¬é«˜ï¼Œä»»æ„ä½ç½®æ’å…¥åˆ é™¤æˆæœ¬ç›¸å¯¹ä½ï¼Œæ’å…¥åˆ é™¤ä¸ä¼šå¯¼è‡´é‡æ–°åˆ†é…æ•´å—å†…å­˜ã€‚&lt;/p>
&lt;p>&lt;code>map&lt;/code>æ˜¯ä¸è¿ç»­åˆ†é…ï¼Œæ’å…¥åˆ é™¤è®¿é—®æˆæœ¬ä¸åº”å’Œçº¿æ€§å®¹å™¨æ¯”è¾ƒï¼Œæ¯•ç«Ÿå®ƒæ˜¯å…³è”å®¹å™¨ã€‚æ’å…¥åˆ é™¤çš„æˆæœ¬éƒ½æ¯”è¾ƒé«˜ï¼Œå› ä¸ºéœ€è¦é‡æ–°å¹³è¡¡æ ‘ã€‚è®¿é—®æ—¶é—´åœ¨æ ‡å‡†ä¸­çš„è¦æ±‚æ˜¯å¯¹æ•°æ—¶é—´å¤æ‚åº¦ï¼Œæ’å…¥æ—¶é—´æ‡’å¾—ç»§ç»­ç¿»æ ‡å‡†æ–‡æ¡£äº†ã€‚&lt;/p>
&lt;h3 id="33-ä½¿ç”¨ä¸Šä¸‹æ–‡">3.3 ä½¿ç”¨ä¸Šä¸‹æ–‡&lt;/h3>
&lt;p>æ˜¾è€Œæ˜“è§&lt;code>vector&lt;/code>é€‚åˆé«˜é¢‘è¯»ï¼Œè€Œ&lt;code>list&lt;/code>é€‚åˆå¤§é‡æ’å…¥åˆ é™¤ï¼Œ&lt;code>map&lt;/code>å’Œå‰é¢ä¸¤ä¸ªè¿­ä»£å™¨éƒ½æ­ä¸ä¸Šè°ƒï¼Œåœ¨éœ€è¦å¤æ‚ç´¢å¼•çš„åœ°æ–¹å†åˆé€‚ä¸è¿‡äº†ã€‚&lt;/p>
&lt;h3 id="34-çº¿ç¨‹å®‰å…¨æ€§">3.4 çº¿ç¨‹å®‰å…¨æ€§&lt;/h3>
&lt;p>è¿™äº›å®¹å™¨éƒ½ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚&lt;/p>
&lt;p>ä¾ç…§æ ‡å‡†ï¼Œå¤šçº¿ç¨‹è®¿é—®ä¸åŒçš„å®¹å™¨å®ä¾‹ä¸€åˆ‡éƒ½å®‰å¥½ï¼Œè®¿é—®åŒä¸€ä¸ªå®ä¾‹çš„&lt;code>const&lt;/code>æ–¹æ³•ä¹Ÿ okï¼Œä½†æ˜¯é&lt;code>const&lt;/code>æ–¹æ³•å°±ä¼šå¼•èµ·æ•°æ®ç«äº‰ã€‚&lt;/p>
&lt;p>å°¤å…¶æ³¨æ„è¿­ä»£å™¨çš„é€‰æ‹©ï¼Œè¿™ç©æ„å„¿æœ‰æ—¶å€™ä¸æ¯”æŒ‡é’ˆå¥½å¤šå°‘ã€‚&lt;/p>
&lt;h2 id="4-å¦‚ä½•ç®¡ç†å†…å­˜èµ„æº">4. å¦‚ä½•ç®¡ç†å†…å­˜èµ„æº&lt;/h2>
&lt;blockquote>
&lt;p>é¢è¯•å®˜ï¼šä½ åœ¨é¡¹ç›®é‡Œä¸€èˆ¬æ˜¯æ€ä¹ˆç®¡ç†å†…å­˜çš„å‘¢ï¼Ÿ&lt;/p>
&lt;p>æˆ‘ï¼šä¸€ä¸ªæ˜¯å°½å¯èƒ½ç”¨æ™ºèƒ½æŒ‡é’ˆï¼Œç„¶åæ˜¯éœ€è¦é¢‘ç¹æ„é€ å¯¹è±¡çš„åœºåˆä¸‹å¯ä»¥ç”¨ placement new blabla&amp;hellip;&lt;/p>
&lt;/blockquote>
&lt;p>å†…å­˜ç®¡ç†æ˜¯ä¸€ä¸ªéå¸¸å¹¿é˜”çš„è¯é¢˜ï¼Œæˆ‘çš„å›ç­”å¤ªè¿‡äºæµ…æ˜¾äº†ã€‚å¸¸è§çš„å†…å­˜ç®¡ç†ç­–ç•¥æœ‰å¾ˆå¤šï¼Œæ™ºèƒ½æŒ‡é’ˆåªèƒ½ç®—æ˜¯ RAII è¿™ç§å¸¸è§çš„èŒƒå¼ï¼Œplacement new ç®—æ˜¯å†…å­˜æ± /å¯¹è±¡æ± çš„ä¸€ç§å†™æ³•å¤§æ¦‚ï¼Œè¿˜æœ‰å…¶ä»–å¾ˆå¤šç­–ç•¥æˆ‘å¹¶ä¸äº†è§£ä¹Ÿæœªèƒ½æ¶‰åŠã€‚&lt;/p>
&lt;h3 id="41-å†è®º-raii">4.1 å†è®º RAII&lt;/h3>
&lt;p>RAII çš„èŒƒå¼å¯ä»¥ç¡®ä¿å¼‚å¸¸å®‰å…¨ï¼Œé¿å…æ‰‹è´±å¿˜è®°å›æ”¶å†…å­˜ä»¥åŠåº•å±‚è®¾è®¡å˜æ›´æŠ›å‡ºçš„å¼‚å¸¸æ— æ³•å¤„ç†æ—¶å¯¼è‡´æ„å¤–çš„èµ„æºæ³„éœ²ã€‚&lt;/p>
&lt;p>è¯¸å¦‚æ­¤ç±»ç­‰ç­‰ã€‚&lt;/p>
&lt;p>æœ‰ä¸€äº›çº¦å®šå¯ä»¥å…³æ³¨ä¸€ä¸‹ã€‚&lt;/p>
&lt;h4 id="411-è·å–èµ„æºå¤±è´¥æŠ›å¼‚å¸¸">4.1.1 è·å–èµ„æºå¤±è´¥æŠ›å¼‚å¸¸&lt;/h4>
&lt;p>é¦–å…ˆ RAII çš„å…¨å†™æ˜¯&lt;strong>è·å–èµ„æºå³åˆå§‹åŒ–&lt;/strong>ï¼Œè¿èµ„æºéƒ½æ²¡èƒ½è·å–çš„è¯ï¼Œæ„é€ ç†åº”å¤±è´¥ï¼Œè€Œä¸æ˜¯é™é»˜ç»™å‡ºä¸€ä¸ªæ— æ•ˆçš„å¯¹è±¡ã€‚&lt;/p>
&lt;h4 id="412-ææ„ç»ä¸æŠ›å¼‚å¸¸">4.1.2 ææ„ç»ä¸æŠ›å¼‚å¸¸&lt;/h4>
&lt;p>å¾ˆå¥½ç†è§£ï¼Œå¦‚æœææ„åˆæŠ›ä¸ªå¼‚å¸¸å‡ºæ¥çš„è¯ï¼Œè¿™ä¸ªå¯¹è±¡è¿˜ææ„ä¸ææ„ï¼Ÿçˆ¶ç±»è¿˜ææ„ä¸ææ„ï¼Ÿ&lt;/p>
&lt;h4 id="423-å¸¸è§è®¾è®¡">4.2.3 å¸¸è§è®¾è®¡&lt;/h4>
&lt;p>åœ¨ STL é‡Œé™¤äº†æ™ºèƒ½æŒ‡é’ˆä»¥ RAII è®¾è®¡ä»¥å¤–ï¼Œè¿˜æœ‰åŠ é”è§£é”ç›¸å…³çš„å†…å®¹ä¹Ÿæ˜¯ï¼š&lt;code>std::lock_guard&lt;/code>ã€‚&lt;/p>
&lt;p>è¯¸å¦‚æ­¤ç±»çš„&lt;code>guard&lt;/code>æ¨¡å¼ä¹Ÿåœ¨å…¶ä»–è¯­è¨€ä¸­æœ‰å‡ºç°ï¼šæ¯”å¦‚è¯´ C#çš„&lt;code>using (var file = File.Open(...)) {}&lt;/code>ã€‚&lt;/p>
&lt;h3 id="42-å†…å­˜æ± å’Œå¯¹è±¡æ± ">4.2 å†…å­˜æ± å’Œå¯¹è±¡æ± &lt;/h3>
&lt;p>å†…å­˜æ± å’Œå¯¹è±¡æ± ç®—æ˜¯å¸¸è§çš„è®¾è®¡èŒƒå¼ï¼ŒåŸºæœ¬è€ƒè™‘åˆ°å¤§é‡å¯¹è±¡çš„æ„é€ åˆ é™¤çš„æƒ…å†µéƒ½ä¼šè€ƒè™‘åˆ°ä½¿ç”¨è¿™ä¸¤ä¸ªæ¨¡å¼ï¼Œå› ä¸ºçœŸçš„å¾ˆå¥½ç”¨ï¼ˆ&lt;/p>
&lt;p>å†…å­˜æ± çš„æ¨¡å¼ä¸»è¦æ˜¯é¢„å…ˆåˆ†é…å†…å­˜ï¼Œç„¶ååœ¨è¿™ç‰‡å†…å­˜ä¸Šæ„é€ å¯¹è±¡ï¼Œä¸»è¦çš„é€‚ç”¨åœºæ™¯æ˜¯å¤§é‡é¢‘ç¹æ„é€ å°å¯¹è±¡ï¼Œæ„é€ æˆæœ¬ä½ï¼Œç”Ÿå‘½å‘¨æœŸçŸ­ï¼Œå†…å­˜åˆ†é…æˆæœ¬å±…é«˜ä¸ä¸‹çš„æƒ…å†µã€‚å½“ç„¶ï¼Œä¸ä»…æ˜¯è¿™é‡Œæåˆ°çš„åœºæ™¯ï¼Œæ ¹æ®å…·ä½“ä¸šåŠ¡é€»è¾‘å¯èƒ½è¿˜ä¼šæœ‰ä¸åŒçš„ç†ç”±å»é€‰æ‹©å†…å­˜æ± æ¨¡å¼ã€‚&lt;/p>
&lt;p>å¯¹è±¡æ± åŒºåˆ«äºå†…å­˜æ± çš„åœ°æ–¹åœ¨äºï¼Œå¯¹è±¡æ± çš„å¯¹è±¡æ„é€ æˆæœ¬è¦æ›´é«˜ï¼Œé¢‘ç¹æ„é€ å’Œææ„æ˜¯æ— æ³•æ¥å—çš„ï¼Œè¿™ç§æ—¶å€™å°±éœ€è¦ä¸€ä¸ªå€™é€‰å¤‡ç”¨çš„å¯¹è±¡æ± ï¼Œå¯¹è±¡æ± å®ç°éœ€è¦å¯¹è±¡æœ¬èº«å…è®¸è¢«å¤ç”¨åœ¨ä¸åŒçš„åœ°æ–¹ï¼Œä¸€èˆ¬æ¥è¯´æ€§èƒ½ä¼šæ¯”è¾ƒå¥½ã€‚å†…å­˜æ± åˆ™æ²¡è¿™ä¸ªé¡¾è™‘ï¼šåæ­£ä½ éœ€è¦å°±æ„é€ ä¸€ä¸ªå‘—ã€‚&lt;/p>
&lt;p>è¿™ä¸¤ä¸ªæ± éƒ½å¯ä»¥ç”¨&lt;code>factory&lt;/code>æ¨¡å¼æ¥æä¾›æ„é€ å¯¹è±¡çš„æœåŠ¡ï¼Œè€Œå·¥å‚çš„æ¶ˆè´¹è€…ä¸éœ€è¦äº†è§£å¯¹è±¡æ˜¯æ€ä¹ˆæ„é€ å‡ºæ¥çš„ã€‚ç»“åˆ RAII çš„è¯ï¼Œå†…å­˜æ± ã€å¯¹è±¡æ± é‡Œçš„å¯¹è±¡è¿˜å¯ä»¥ç”¨ä¸€å±‚ RAII è®¾è®¡çš„â€œæ™ºèƒ½æŒ‡é’ˆâ€å°è£…ï¼Œä½¿å…¶å®Œæˆä½¿å‘½åèƒ½è‡ªåŠ¨è¿”è¿˜èµ„æºï¼Œç­‰å¾…ä¸‹ä¸€ä¸ªå·¥å‚è®¿å®¢ã€‚&lt;/p>
&lt;h2 id="5-ç©è¿‡å“ªäº›æ¸¸æˆå¯¹æ¸¸æˆåˆ¶ä½œæµç¨‹äº†è§£å¤šå°‘">5. ç©è¿‡å“ªäº›æ¸¸æˆï¼Œå¯¹æ¸¸æˆåˆ¶ä½œæµç¨‹äº†è§£å¤šå°‘ï¼Ÿ&lt;/h2>
&lt;blockquote>
&lt;p>é¢è¯•å®˜ï¼šå–œæ¬¢ç©æ¸¸æˆå—ï¼Ÿéƒ½ç©è¿‡å“ªäº›æ¸¸æˆï¼Ÿ&lt;/p>
&lt;p>æˆ‘ï¼šæˆ‘çš„è¯&amp;hellip;ä¸»è¦ç©çš„æ˜¯éŸ³æ¸¸ï¼Œå’Œè´µå…¬å¸ä¸šåŠ¡å¯èƒ½å¹¶æ²¡æœ‰å¤ªå¤šå…³è”ã€‚&lt;/p>
&lt;p>é¢è¯•å®˜ï¼šé™¤äº†éŸ³ä¹æ¸¸æˆï¼Œæœ‰ç©è¿‡ RPGã€ARPG ç±»å‹çš„æ¸¸æˆå—ï¼Ÿ&lt;/p>
&lt;p>æˆ‘ï¼šåƒæ˜¯è¾å°„å•Šï¼Œè€æ»šå•Šè¿™äº›&amp;hellip;å¼€æ”¾ä¸–ç•Œç±»å‹çš„æ¸¸æˆæ¸¸æˆæ€§æ²¡é‚£ä¹ˆå¥½ï¼Œæ¯”èµ·æ¥æˆ‘æ›´å–œæ¬¢ç”µå½±å¼çš„æ¸¸æˆï¼Œæ¯”å¦‚è¯´æœ€è¿‘æ¯”è¾ƒç«çš„ã€Šåº•ç‰¹å¾‹ï¼šå˜äººã€‹ã€‚&lt;/p>
&lt;p>é¢è¯•å®˜ï¼š&amp;hellip;&amp;hellip;ï¼ˆä½ ä¸«æ¥æ£ä¹±çš„æ˜¯å§ï¼‰&lt;/p>
&lt;p>é¢è¯•å®˜ï¼šè¯´è¯´ä½ å¯¹æ¸¸æˆè¡Œä¸šçš„çœ‹æ³•å§ã€‚&lt;/p>
&lt;p>æˆ‘ï¼šæ¸¸æˆè¡Œä¸šå‰æ™¯å¥½å•Š blablabla&amp;hellip;å¨±ä¹å´›èµ· blabla&amp;hellip;ç»æµå¢é•¿ blabla&amp;hellip;.&lt;/p>
&lt;p>é¢è¯•å®˜ï¼š&amp;hellip;&amp;hellip;ï¼ˆï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼‰&lt;/p>
&lt;p>é¢è¯•å®˜ï¼šä½ ä¸Šä¸€å®¶å…¬å¸ä¹Ÿæ˜¯åˆ¶ä½œæ¸¸æˆçš„å§ï¼Ÿå°±æ˜¯è¯´ï¼Œä½ ä»¬æ¸¸æˆåˆ¶ä½œå•Šï¼Œéƒ½æœ‰å“ªæ–¹é¢çš„äººåœ¨è´Ÿè´£åšä»€ä¹ˆä¸œè¥¿ï¼Œå¤§æ¦‚æ˜¯æ€ä¹ˆä¸ªåˆ†å·¥åˆä½œçš„æ ·å­ã€‚ï¼ˆæé†’+å¼ºè°ƒï¼‰
æˆ‘ï¼šå“¦ï¼å“¦å“¦ï¼Œå¤§æ¦‚å°±æ˜¯ä¸€ä¸ªäººè´Ÿè´£ç­–åˆ’æ•´ä¸ªæ¸¸æˆçš„ç©æ³•å’Œç³»ç»Ÿï¼Œè®¾è®¡æ¯ä¸ªç»†èŠ‚ï¼Œç„¶åç¨‹åºè´Ÿè´£å»å®ç°ï¼Œè‡ªåŠ¨æµ‹è¯• blabla&amp;hellip;å†…éƒ¨è¯•ç© blabla&amp;hellip;&lt;/p>
&lt;/blockquote>
&lt;p>è¿˜è¡Œï¼Œè¿™æ³¢æ“ä½œå…¶å®æˆ‘ä¹Ÿæ˜¯æŒºä½©æœè‡ªå·±çš„ã€‚&lt;/p>
&lt;h3 id="51-é™·é˜±ç©è¿‡å“ªäº›æ¸¸æˆ">5.1 é™·é˜±ï¼šç©è¿‡å“ªäº›æ¸¸æˆ&lt;/h3>
&lt;p>æˆ‘æ³¨æ„åˆ°ä¸€ä»¶äº‹ï¼šåœ¨å¤šæ¬¡é¢è¯•æ¸¸æˆè¡Œä¸šçš„èŒä½æ—¶ï¼Œéƒ½æåˆ°è¿™è¿™ä¸ªé—®é¢˜ï¼š&lt;/p>
&lt;blockquote>
&lt;p>ä½ ç©è¿‡å“ªäº›æ¸¸æˆï¼Ÿ&lt;/p>
&lt;/blockquote>
&lt;p>ä¹Ÿè®¸å½¢å¼ä¸Šæœ‰æ‰€åŒºåˆ«ï¼š&lt;/p>
&lt;blockquote>
&lt;p>ä½ ç©è¿‡çš„æ¸¸æˆé‡Œï¼Œæœ‰å“ªäº›ç‰¹åˆ«å–œæ¬¢çš„ï¼Ÿ&lt;/p>
&lt;/blockquote>
&lt;p>æ¢ä½æ€è€ƒï¼Œå¦‚æœæˆ‘æ˜¯é¢è¯•å®˜ï¼Œæˆ‘ä¸ºä»€ä¹ˆè¦é—®è¿™ä¸ªé—®é¢˜ï¼Ÿæˆ‘æƒ³çŸ¥é“ä»€ä¹ˆï¼Ÿ&lt;/p>
&lt;blockquote>
&lt;p>ç†Ÿæ‚‰æ¸¸æˆå—ï¼Ÿ&lt;/p>
&lt;p>çŸ¥é“æ¸¸æˆæœ‰å“ªäº›å…ƒç´ å—ï¼Ÿ&lt;/p>
&lt;p>èƒ½ç†è§£ï¼ˆæˆ‘ä»¬æ‹›ä½ è¿›æ¥è¦åšçš„æ¸¸æˆï¼‰è¦ä½ åšä»€ä¹ˆå—ï¼Ÿ&lt;/p>
&lt;/blockquote>
&lt;p>ä¸å¿…å¤ªè¿‡åˆ»æ„åœ°è¡¨è¾¾å‡ºå¯¹æ¸¸æˆè¡Œä¸šçš„å´‡æ‹œæˆ–è€…æŠ¬é«˜ä¹‹ç±»çš„ï¼Œè¿™ä¸€å…³ä¸»è¦çš„ç›®çš„è¿˜æ˜¯å¼•å‡ºä¸‹æ–‡ï¼ŒèŠèŠå¯¹æ¸¸æˆåˆ¶ä½œæµç¨‹çš„ç†è§£ã€‚å¦‚æœå¯¹é¢è¯•çš„å…¬å¸å‡ºçš„äº§å“æœ‰æ‰€äº†è§£çš„è¯å¯èƒ½ç®—æ˜¯åŠ åˆ†é¡¹ã€‚&lt;/p>
&lt;p>ä½†æ˜¯ï¼Œä»ä¸€ä¸ªæ¸¸æˆç©å®¶çš„è§’åº¦å‡ºå‘ï¼Œè¡¨ç°å‡ºä¸å¥½çš„æƒ…ç»ªå®¹æ˜“ç•™ä¸‹åæ˜ åƒâ€”â€”&lt;strong>ç‰¹åˆ«æ˜¯ï¼Œç»å¯¹ä¸è¦æ˜æ˜¾åœ°è¡¨è¾¾å‡ºå¯¹å›½äº§ç½‘æ¸¸ã€æ‰‹æ¸¸ã€é¡µæ¸¸çš„é„™è§†ï¼ï¼&lt;/strong>&lt;/p>
&lt;p>ä»ä¸€ä¸ªç©å®¶çš„è§’åº¦å‡ºå‘ï¼Œæˆ‘ä¹Ÿä¸å–œæ¬¢&lt;strong>å¤§éƒ¨åˆ†&lt;/strong>å›½äº§çš„é¡µæ¸¸æ‰‹æ¸¸ï¼Œä½†æ˜¯å½“ç€æ¸¸æˆè¡Œä¸šå…¬å¸çš„é¢è¯•å®˜çš„é¢ï¼Œè¡¨ç°å‡º&lt;strong>æˆ‘çœ‹ä¸èµ·ä½ &lt;/strong>çš„æ€åº¦ï¼ŒçŸ¥é“ä»€ä¹ˆå«ä½œæ­»å—ï¼Ÿ&lt;/p>
&lt;p>æ›´ä½•å†µå¹¶ä¸æ˜¯&lt;strong>æ‰€æœ‰å›½äº§æ¸¸æˆ&lt;/strong>éƒ½æ˜¯å±ï¼Œä¸¾ä¾‹æ¥è¯´æˆ‘ç°åœ¨è¶…å–œæ¬¢ MUSE DASH è¿™æ¬¾å›½äº§éŸ³æ¸¸çš„ï¼Œæ‰‹æ„Ÿæ¯”å…°ç©º vozeã€èŠ‚å¥å¤§å¸ˆä¹‹ç±»çš„å¥½å¾—å¤šï¼Œç•Œé¢ä¹Ÿæ²¡æœ‰åƒèŠ‚å¥å¤§å¸ˆé‚£æ ·ç³Šæˆå±ï¼Œè¦ä¸æ˜¯æˆ‘çš„ Unity3D æ°´å¹³å¤ªå·®æˆ‘çœŸæƒ³ç»™è¿™å®¶ pero pero game å·¥ä½œå®¤ï¼ˆå…¬å¸ï¼Ÿï¼‰æŠ•ä¸ªç®€å†çœ‹çœ‹ã€‚&lt;/p>
&lt;p>é™¤æ­¤ä¹‹å¤–è¿˜æœ‰å°±æ˜¯æŠ±ç€&lt;strong>æ‹¯æ•‘å›½äº§æ¸¸æˆ&lt;/strong>çš„æƒ³æ³•æˆ–è€…æ€åº¦ï¼Œåˆæˆ–è€…&lt;strong>åŠ³èµ„æ•™ä½ ä»¬ä»€ä¹ˆæ‰æ˜¯çœŸæ­£çš„æ¸¸æˆ&lt;/strong>è¿™æ ·çš„æƒ³æ³•æˆ–è€…æ€åº¦ï¼Œä½œæ­»æ— æé™å•Šã€‚&lt;/p>
&lt;p>æ¯”è¾ƒç¨³å¦¥çš„å›ç­”æ–¹æ¡ˆåº”è¯¥æ˜¯å¸¸è§çš„å‡ ä¸ªç½‘æ¸¸ï¼Œæ¯”å¦‚è¯´ LOLï¼ŒDNFï¼Œç‹è€…è£è€€ï¼Œè¯¸å¦‚æ­¤ç±»ã€‚å®é™…ä¸Šç©è¿‡æ²¡ç©è¿‡&amp;hellip;..å’³ï¼Œä¸è¢«æˆ³ç©¿å°±æ— æ‰€è°“äº†ã€‚&lt;/p>
&lt;h3 id="52-æ¸¸æˆè¡Œä¸š">5.2 æ¸¸æˆè¡Œä¸š&lt;/h3>
&lt;p>åŠ ç­æ˜¯å®¶å¸¸ä¾¿é¥­ï¼Œå¥½åƒæ‰€æœ‰æ¸¸æˆè¡Œä¸šçš„å…¬å¸éƒ½ä¼šè¿™ä¹ˆè¯´ã€‚&lt;/p>
&lt;p>å¤§æ¦‚äº†è§£ä¸‹å‡ ä¸ªæœ¯è¯­ï¼Œç®—æ˜¯åŠ ç­ç•Œçš„é»‘è¯å§ã€‚&lt;/p>
&lt;p>ä¸€ä¸ªæ˜¯ 996ã€‚ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿä¸Šåˆ 9 ç‚¹ä¸Šç­ï¼Œæ™šä¸Š 9 ç‚¹ä¸‹ç­ï¼Œä¸€å‘¨ä¸Š 6 å¤©ï¼ŒåŠ ç­è´¹ä¸ç”¨è€ƒè™‘äº†ï¼Œä¸å­˜åœ¨çš„ï¼Œæœ€å¤šç»™è°ƒä¼‘ã€‚&lt;/p>
&lt;p>å†æœ‰ä¸€ä¸ªæ˜¯å¤§å°å‘¨ã€‚ä¸€å‘¨ä¸Š 6 å¤©ï¼Œä¸€å‘¨ä¸Š 5 å¤©ï¼Œå¦‚æ­¤å¾ªç¯ã€‚åŒæ ·ï¼Œå¤§å‘¨åŠ ç­ä¸ç®—åŠ ç­è´¹ï¼Œç»™è°ƒä¼‘ã€‚&lt;/p>
&lt;p>å¦å¤–å°±æ˜¯è°ƒä¼‘ã€‚å¦‚æœåŠ ç­ä¸€å¤©ï¼Œå°†æ¥æŸå¤©å°±å¯ä»¥ä¸æ‰£å·¥èµ„ä¼‘æ¯ä¸€å¤©ï¼Œç›´ç™½å§ã€‚æ”’ä¸‹åŠå¹´çš„è°ƒä¼‘ç„¶åä¸€å£æ°”ç»™è‡ªå·±æ”¾ 6 ä¸ªæœˆå‡è¿™ç§äº‹æƒ…è¿˜æ˜¯åšæ¢¦æ¯”è¾ƒå¥½ï¼Œè°ƒä¼‘åŸºæœ¬ä¸Šå°±ç­‰äºæ— å¿åŠ ç­äº†ï¼Œå¿™èµ·æ¥çš„æ—¶å€™åŠä½ åˆ«ä¼‘ï¼Œä¸ç„¶äººæ‰‹å°±ä¸å¤Ÿäº†ï¼›é‚£é—²ä¸‹æ¥çš„æ—¶å€™è¿˜èƒ½è®©ä½ ä¸€å‘¨ä¼‘ 6 å¤©ï¼Ÿä½ æ•¢ä¼‘å…¬å¸ä¹Ÿä¸æ•¢è®©ä½ éšä¾¿ä¼‘å•Šï¼Œå…¶ä»–å‘˜å·¥æ€ä¹ˆçœ‹ã€‚&lt;/p>
&lt;p>å‘è–ªæ—¥ã€‚ç½‘ä¸Šæœ‰äººæ€»ç»“ï¼Œå‘è–ªæ—¥è¶Šæ¥è¿‘æœˆä¸­çš„ï¼Œæˆ–è€…è¶…è¿‡æœˆä¸­çš„ï¼Œå¤§å¤šéƒ½æ˜¯æ€•å‘˜å·¥æµå¤±çš„å…¬å¸ï¼Œè€Œè¿™äº›å…¬å¸å¾€å¾€éƒ½ä¸æ˜¯ä»€ä¹ˆå¥½å…¬å¸ã€‚å¬èµ·æ¥è¿˜æ˜¯æŒºæœ‰é“ç†çš„ï¼ˆ&lt;/p>
&lt;p>å½“ç„¶ï¼Œæœ€åè¿˜æ˜¯è¦é è‡ªå·±çš„çœ¼ç›å»ç¡®è®¤è¿™ä¸€ç‚¹ã€‚&lt;/p>
&lt;h3 id="53-æ¸¸æˆçš„åˆ¶ä½œæµç¨‹">5.3 æ¸¸æˆçš„åˆ¶ä½œæµç¨‹&lt;/h3>
&lt;p>ä¹‹å‰å¾…å¾—ç¡®å®æ˜¯ä¸€å®¶å°å…¬å¸ï¼Œç”šè‡³ç®—å¾—ä¸Šå·¥ä½œå®¤çº§åˆ«çš„è¶…å°åˆåˆ›å…¬å¸ï¼Œæ¸¸æˆåˆ¶ä½œæ–¹é¢çš„çŸ¥è¯†å‚¨å¤‡ä¸ç®—å……è¶³ï¼Œå†™è¿™ç¯‡åšå®¢çš„æ—¶å€™åˆå»è¡¥ä¹ äº†ä¸€ä¸‹ã€‚&lt;/p>
&lt;p>ä¸»è¦çš„å·¥ç§åˆ†ä¸ºç­–åˆ’ã€ç¾æœ¯ã€ç¨‹åºã€‚&lt;/p>
&lt;p>ç»†åˆ†çš„è¯ï¼Œç­–åˆ’å¯èƒ½æœ‰æ•°å€¼æ–¹é¢çš„ï¼Œä¸–ç•ŒèƒŒæ™¯äººç‰©èƒŒæ™¯æ–¹é¢çš„ï¼Œå¯¹è¯æ–‡æœ¬æ–¹é¢çš„ï¼Œç”šè‡³å¯èƒ½æœ‰é•¿ç¯‡å¹…çš„èµ„æ–™å•Šæ•…äº‹å•Šè¿™æ–¹é¢çš„éœ€æ±‚ã€‚&lt;/p>
&lt;p>ç¾æœ¯æœ‰ UI æ–¹é¢çš„ï¼Œäººç‰©ã€åœºæ™¯çš„åŸç”»å¸ˆï¼Œ3d æ¨¡å‹åˆ¶ä½œï¼ŒåŠ¨ç”»åˆ¶ä½œï¼Œéª¨éª¼åˆ¶ä½œï¼Œç‰¹æ•ˆåˆ¶ä½œï¼Œç­‰ç­‰æ–¹é¢çš„ã€‚ç¨‹åºç»å¸¸éœ€è¦å’Œç¾æœ¯æ–¹é¢çš„æ²Ÿé€šäº¤æµã€‚&lt;/p>
&lt;p>ç¨‹åºçš„è¯ä¸»è¦åˆ†å‰åç«¯å’Œæµ‹è¯•ï¼Œå†åŠ ä¸Šè¿ç»´å’Œ DBA ä¹‹ç±»çš„è§’è‰²ã€‚&lt;/p>
&lt;p>ç»†åˆ†çš„è¯å‰ç«¯æ ¹æ®å¼€å‘å¹³å°ä¸åŒä¹Ÿæœ‰ä¸åŒçš„æŠ€æœ¯æ ˆï¼Œå›¾åƒç‰¹æ•ˆä¸Šå¯èƒ½ä¼šæœ‰æ›´ä¸“ä¸šçš„å¤§ç‰›è´Ÿè´£ï¼Œteam leader å¸¦é˜Ÿè®¾è®¡æ¶æ„ï¼Œåˆ†é…å·¥ä½œï¼Œè¯¸å¦‚æ­¤ç±»ã€‚åç«¯ä¹Ÿä¸€æ ·ï¼Œæ ¹æ®ä¸åŒçš„æŠ€æœ¯æŠ‰æ‹©ï¼Œå¯èƒ½æ•´ä½“çš„äººå‘˜é…ç½®ä¹Ÿæœ‰æ‰€åŒºåˆ«ï¼Œä½†å¤§å®¶éƒ½æ˜¯ç¨‹åºå˜›ã€‚&lt;/p>
&lt;p>æµ‹è¯•ç®—æ˜¯æ¯”è¾ƒç‹¬ç«‹çš„ï¼Œç¼–å†™æµ‹è¯•ä»£ç æ˜¯ä¸€ä»¶å¾ˆç—›è‹¦çš„äº‹æƒ…ï¼ˆ&lt;/p>
&lt;p>æ‰€ä»¥è¿™ä»½ç–¼ç—›æœ‰ä¸“äººè´Ÿè´£æ‰¿å—äº†ï¼šï¼‰&lt;/p>
&lt;p>æŒç»­é›†æˆå•Šä»€ä¹ˆçš„ä¹Ÿè¢«æ‰¿åŒ…äº†ï¼Œæµ‹è¯•æˆ–è€…è¿ç»´ä¼šå»è´Ÿè´£çš„ã€‚&lt;/p>
&lt;p>DBA ä¸€èˆ¬å…¬å¸ä¹Ÿç”¨ä¸åˆ°ï¼Œè¿ç»´å¤šå°‘ä¼šä¸¤æ‰‹ SQLï¼Œè§„æ¨¡æ›´å¤§çš„å…¬å¸å¯èƒ½ä¼šè®¾ç½®è¿™ä¸ªä¸“é—¨èŒä½ã€‚&lt;/p>
&lt;p>æµç¨‹ä¸Šæ¥è¯´ï¼Œç­–åˆ’ç»™å‡ºæ¸¸æˆæ–¹æ¡ˆï¼Œç¾æœ¯å¯èƒ½ä¼šé…åˆåšä¸ªåˆç¨¿æ•ˆæœå›¾ä¹‹ç±»çš„ï¼ˆæ›´å¯èƒ½æ˜¯ç­–åˆ’è‡ªå·±åšä¸ªç®€å•çš„æ•ˆæœå›¾ä¹‹ç±»çš„æ–¹ä¾¿è¯´æ˜ï¼‰ï¼Œç¨‹åºç–¯ç‹‚å®ç°ï¼ˆå´©æºƒ-çˆ†å‘-è®¤å‘½ å¾ªç¯ï¼‰ï¼Œæµ‹è¯•åˆ™é…åˆç»™å‡ºåé¦ˆï¼Œè®©ç¨‹åºçš„è„±å‘çŠ¶å†µæŒç»­æ¶åŒ–ï¼Œæœ€åå‘å¸ƒï¼Œé¡¹ç›®é»„äº†ã€‚&lt;/p>
&lt;p>å“¦ä¸æ˜¯ï¼Œæˆ‘æ˜¯è¯´é¡¹ç›®ç«äº†ï¼Œç¨‹åºä»¬ä¸€è·ƒæˆä¸º CTOï¼Œè¿å¨¶ç™½å¯Œç¾ï¼Œèµ°ä¸Šäººç”Ÿå·…å³°ã€‚&lt;/p>
&lt;p>ï¼ˆå¹¶æ²¡æœ‰ï¼‰&lt;/p>
&lt;h2 id="6-å°¾å£°">6. å°¾å£°&lt;/h2>
&lt;p>å…¶å®è¿™æ¬¡é¢è¯•çš„è‡ªæˆ‘æ„Ÿè§‰è¿˜æ˜¯ä¸é”™çš„ï¼Œæ²¡æœ‰çŠ¯ä¸‹å¤ªè ¢çš„é”™è¯¯ï¼Œä½†æ˜¯å¯ä»¥æ”¹è¿›çš„åœ°æ–¹ä¾ç„¶å¾ˆå¤šï¼Œè¯­è¨€ç»„ç»‡èƒ½åŠ›éœ€è¦è¿›ä¸€æ­¥æé«˜ã€‚&lt;/p>
&lt;p>è¿™ç¯‡åšå®¢çš„ç›®çš„æ˜¯è‡ªæˆ‘åçœï¼Œä½†æ˜¯è¿™æ¬¡è‡ªæˆ‘åçœçš„æ•ˆæœå¹¶ä¸ç®—å¥½ï¼Œå› ä¸ºé¢è¯•å®˜çš„é—®é¢˜åŸºæœ¬ä¸Šéƒ½æˆ³åœ¨æˆ‘æ‡‚ï¼Œä½†åˆæ²¡çœŸæ­£å»æ·±å…¥æŒ–æ˜çš„é¢†åŸŸã€‚æ—¥å¸¸ä½¿ç”¨è‡ªç„¶æ²¡æœ‰é—®é¢˜ï¼Œä½†ç†è§£å´è°ˆä¸ä¸Šäº†ã€‚&lt;/p>
&lt;p>å¦‚æœé¢è¯•å®˜åœ¨ç»†èŠ‚ä¸Šç¨ä½œè¿½ç©¶ï¼šæ¯”å¦‚è¯´ placement new å’Œ user-defined new ä¹‹ç±»çš„è¯é¢˜ä¸Šæ·±å…¥ï¼Œå¼‚å¸¸å®‰å…¨ï¼Œæˆ–è€…é—®ä¸ª map ç”¨çº¢é»‘æ ‘å®ç°ï¼Œçº¢é»‘æ ‘ä»€ä¹ˆåŸç†ï¼Œé‚£ä¹ˆè¿™æ¬¡æˆ‘åŸºæœ¬åˆè¦æŒ‚äº†ã€‚&lt;/p>
&lt;p>å…³äºç»™å‡ºçš„å¾…é‡çš„é—®é¢˜&amp;hellip;&amp;hellip;æˆ‘å…¶å®å¾ˆå¥½å¥‡&amp;hellip;&amp;hellip;&lt;/p>
&lt;p>å› ä¸ºæˆ‘çœŸçš„æ‰å·¥ä½œä¸€å¹´ï¼Œä¸æ‡‚å•Š&amp;hellip;&lt;/p>
&lt;p>ä¸€å¹´å·¥ä½œå¹´é™ï¼ŒC++æˆ‘ä¹Ÿä¸çŸ¥é“ç®—ä»€ä¹ˆæ°´å¹³ï¼Œä¸çŸ¥é“æ€ä¹ˆå»æ¨ªå‘å¯¹æ¯”ï¼Œè¦ 8k æ˜¯è¦å¤šäº†ä¹ˆ&amp;hellip;&lt;/p>
&lt;p>åˆçº§èŒä½çš„æ„æ€æ˜¯å¾…é‡åˆçº§è¿˜æ˜¯èƒ½åŠ›åˆçº§å•Š&amp;hellip;&lt;/p>
&lt;p>è¿˜æœ‰ä¸»ç¨‹ä¸€èˆ¬æŒ‡çš„æ˜¯ team leader å¯¹å—ï¼Œæ¸¸æˆè¡Œä¸šç¨‹åºæ˜¯ä¸æ˜¯å¹²åˆ° team leader å°±ç®—åˆ°å¤´äº†&amp;hellip;åªèƒ½è½¬ç®¡ç†å²—äº†&amp;hellip;&lt;/p></description></item><item><title>å¯é‡å…¥å’Œå¼‚æ­¥å®‰å…¨</title><link>https://nnnewb.github.io/blog/p/%E5%8F%AF%E9%87%8D%E5%85%A5%E5%92%8C%E5%BC%82%E6%AD%A5%E5%AE%89%E5%85%A8/</link><pubDate>Sun, 24 Jun 2018 22:48:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/%E5%8F%AF%E9%87%8D%E5%85%A5%E5%92%8C%E5%BC%82%E6%AD%A5%E5%AE%89%E5%85%A8/</guid><description>&lt;p>è¿™ç¯‡åšå®¢ä¸»è¦è®°å½•çš„æ˜¯å…³äºå¯é‡å…¥æ€§çš„ç›¸å…³å®šä¹‰ï¼Œä»¥åŠå…³äºå¹¶å‘å®‰å…¨çš„æ€è€ƒã€‚&lt;/p>
&lt;h2 id="å¯é‡å…¥æ€§">å¯é‡å…¥æ€§&lt;/h2>
&lt;p>åœ¨ä¸åŒè¯­è¨€ä¸­ï¼Œç”±äºè¯­è¨€æ ‡å‡†ä»¥åŠè¿è¡ŒæœŸç¯å¢ƒè§„å®šçš„ä¸åŒï¼Œå¯é‡å…¥æ€§çš„å…·ä½“å®šä¹‰å¯èƒ½æœ‰æ‰€ä¸åŒã€‚è¿™é‡ŒèŠçš„æ˜¯ C++è¯­è¨€ä¸­çš„å¯é‡å…¥æ€§ã€‚&lt;/p>
&lt;p>æ‰€è°“å¯é‡å…¥æ€§ï¼ˆ&lt;code>reetrant&lt;/code>ï¼‰ï¼ŒæŒ‡çš„æ˜¯åŒæ—¶å…·å¤‡&lt;strong>å¹¶å‘å®‰å…¨&lt;/strong>å’Œ&lt;strong>ä¸­æ–­å®‰å…¨&lt;/strong>çš„ç‰¹å¾ï¼Œè¿™æ˜¯ç›®å‰ä¸ºæ­¢æˆ‘å¯¹å¯é‡å…¥æ€§çš„è®¤è¯†ï¼Œä¹Ÿæ˜¯è¿™ç¯‡åšå®¢åœ¨å†™ä¸‹æ—¶ç»™å¯é‡å…¥æ€§ä¸‹çš„å®šä¹‰ã€‚&lt;/p>
&lt;p>è¿™ä¸ªè®¤çŸ¥å¯èƒ½å¹¶ä¸å‡†ç¡®ï¼Œå› ä¸ºåœ¨&lt;a class="link" href="https://zh.wikipedia.org/wiki/%E5%8F%AF%E9%87%8D%E5%85%A5" target="_blank" rel="noopener"
>wiki&lt;/a>ä¸Šçš„å®šä¹‰æ˜¯è¿™æ ·çš„ã€‚&lt;/p>
&lt;blockquote>
&lt;p>è‹¥ä¸€ä¸ªç¨‹åºæˆ–å­ç¨‹åºå¯ä»¥ã€Œåœ¨ä»»æ„æ—¶åˆ»è¢«ä¸­æ–­ç„¶åæ“ä½œç³»ç»Ÿè°ƒåº¦æ‰§è¡Œå¦å¤–ä¸€æ®µä»£ç ï¼Œè¿™æ®µä»£ç åˆè°ƒç”¨äº†è¯¥å­ç¨‹åºä¸ä¼šå‡ºé”™ã€ï¼Œåˆ™ç§°å…¶ä¸ºå¯é‡å…¥ï¼ˆreentrant æˆ– re-entrantï¼‰çš„ã€‚å³å½“è¯¥å­ç¨‹åºæ­£åœ¨è¿è¡Œæ—¶ï¼Œæ‰§è¡Œçº¿ç¨‹å¯ä»¥å†æ¬¡è¿›å…¥å¹¶æ‰§è¡Œå®ƒï¼Œä»ç„¶è·å¾—ç¬¦åˆè¨­è¨ˆæ™‚é æœŸçš„ç»“æœã€‚ä¸å¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œçš„çº¿ç¨‹å®‰å…¨ä¸åŒï¼Œå¯é‡å…¥å¼ºè°ƒå¯¹å•ä¸ªçº¿ç¨‹æ‰§è¡Œæ—¶é‡æ–°è¿›å…¥åŒä¸€ä¸ªå­ç¨‹åºä»ç„¶æ˜¯å®‰å…¨çš„ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>ä½†æ˜¯åœ¨å¾ˆå¤šä¸­æ–‡åšå®¢é‡Œï¼ŒèŠåˆ°å¯é‡å…¥æ€§çš„æ—¶å€™å¾€å¾€ä¹Ÿä¼šæŠŠå¹¶å‘å®‰å…¨æ··ä¸ºä¸€è°ˆã€‚å®é™…ä¸Šæ¥è¯´çš„è¯&amp;hellip;&amp;hellip;ä¸€ä¸ªå¯é‡å…¥çš„å‡½æ•°ï¼Œå¸¸å¸¸ä¹Ÿæ˜¯å¹¶å‘å®‰å…¨çš„ã€‚&lt;/p>
&lt;p>é‚£ä¹ˆå…ˆä»å¹¶å‘å®‰å…¨è®²èµ·å§ã€‚&lt;/p>
&lt;h2 id="å¹¶å‘å®‰å…¨æ€§å’Œå¯é‡å…¥æ€§">å¹¶å‘å®‰å…¨æ€§å’Œå¯é‡å…¥æ€§&lt;/h2>
&lt;p>æ‰€è°“å¹¶å‘å®‰å…¨å·²ç»æ˜¯è€ç”Ÿå¸¸è°ˆäº†ã€‚&lt;/p>
&lt;p>ä»¥ä¸€æ®µéå¸¸ç®€å•çš„ä»£ç ä¸ºä¾‹ï¼Œæˆ‘ä»¬æ‰“ç®—åˆå§‹åŒ–ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡è¢«ä¸¤ä¸ªçº¿ç¨‹å…±äº«ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-C++" data-lang="C++">&lt;span class="kt">void&lt;/span> &lt;span class="nf">initialize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Something&lt;/span>&lt;span class="o">**&lt;/span> &lt;span class="n">someshit&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">!*&lt;/span>&lt;span class="n">someshit&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">*&lt;/span>&lt;span class="n">someshit&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">createSomeShit&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ˜¾è€Œæ˜“è§ï¼Œå¦‚æœçº¿ç¨‹åœ¨æ‰§è¡Œåˆ°ç‰¹å®šç¯èŠ‚æ—¶å‘ç”Ÿäº†åˆ‡æ¢&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-C++" data-lang="C++">&lt;span class="kt">void&lt;/span> &lt;span class="nf">initialize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Something&lt;/span>&lt;span class="o">**&lt;/span> &lt;span class="n">someshit&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">!*&lt;/span>&lt;span class="n">someshit&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// &amp;lt;-------- çº¿ç¨‹åˆ‡æ¢
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// çº¿ç¨‹2() {
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// initialize(something);
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// }
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// çº¿ç¨‹åˆ‡æ¢ ---------&amp;gt;
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">someshit&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">createSomeShit&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>é‚£ä¹ˆ &lt;code>createSomeShit&lt;/code>è¿™æ®µä»£ç å°±ä¼šè¢«æ‰§è¡Œä¸¤æ¬¡ã€‚&lt;/p>
&lt;p>æ˜¾ç„¶è¿™å’Œæˆ‘ä»¬é¢„æœŸçš„è¡Œä¸ºä¸ç¬¦ã€‚&lt;/p>
&lt;p>è¿™é‡Œè¦èŠçš„ä¸æ˜¯å¹¶å‘ï¼Œè€Œæ˜¯&amp;hellip;&amp;hellip;å¯é‡å…¥æ€§ã€‚æ‰€ä»¥æˆ‘ä»¬å†çœ‹çœ‹è¿™ä¸ªå‡½æ•°èƒ½å¦è¢«é‡å…¥ã€‚&lt;/p>
&lt;p>æŒ‰ç…§ wiki æä¾›çš„å®šä¹‰ï¼Œå‡½æ•°å¯é‡å…¥æŒ‡çš„æ˜¯&lt;/p>
&lt;blockquote>
&lt;p>åœ¨ä»»æ„æ—¶åˆ»è¢«ä¸­æ–­ç„¶åæ“ä½œç³»ç»Ÿè°ƒåº¦æ‰§è¡Œå¦å¤–ä¸€æ®µä»£ç ï¼Œè¿™æ®µä»£ç åˆè°ƒç”¨äº†è¯¥å­ç¨‹åºä¸ä¼šå‡ºé”™ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>ç¬¦åˆå—ï¼Ÿä¸ã€‚ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºåŒæ ·åœ¨é‚£ä¸ªçº¿ç¨‹åˆ‡æ¢çš„ä½ç½®ä¸Šä¸­æ–­ï¼Œç„¶åå†å¦ä¸€æ®µä»£ç é‡Œå†æ¬¡æ‰§è¡Œè¿™ä¸ªå‡½æ•°ï¼Œä¹Ÿä¼šè§¦å‘åŒæ ·çš„é—®é¢˜ï¼Œå¯¼è‡´&lt;code>createSomeShit&lt;/code>è¢«æ‰§è¡Œä¸¤æ¬¡ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-C++" data-lang="C++">&lt;span class="kt">void&lt;/span> &lt;span class="nf">initialize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Something&lt;/span>&lt;span class="o">**&lt;/span> &lt;span class="n">someshit&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">!*&lt;/span>&lt;span class="n">someshit&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// &amp;lt;-------- è¢«ä¸­æ–­
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// ä¸­æ–­å¤„ç†å‡½æ•°() {
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// initialize(something);
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// }
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// ä¸­æ–­ç»“æŸ --------
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">someshit&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">createSomeShit&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹å‡ºï¼Œé‚£äº›çº¿ç¨‹ä¸å®‰å…¨çš„ä»£ç ï¼Œéƒ½æ˜¯ä¸å¯é‡å…¥çš„ã€‚&lt;/p>
&lt;p>é‚£ä¹ˆï¼Œçº¿ç¨‹å®‰å…¨çš„ä»£ç ï¼Œå°±ä¸€å®šæ˜¯å¯é‡å…¥çš„å—ï¼Ÿ&lt;/p>
&lt;h2 id="ä¸­æ–­å®‰å…¨æ€§æˆ–è€…å«ä¿¡å·å®‰å…¨æ€§">ä¸­æ–­å®‰å…¨æ€§ï¼Œæˆ–è€…å«ä¿¡å·å®‰å…¨æ€§&lt;/h2>
&lt;p>ä¸­æ–­è¿™ä¸ªä¸œè¥¿å¯¹å…¶ä»–ç¼–ç¨‹è¯­è¨€çš„ç”¨æˆ·æ¥è¯´å¯èƒ½ä¼šå°‘è§ä¸€äº›ï¼Œåœ¨ C/C++è¯­è¨€é‡Œï¼Œä¸­æ–­å¹¶ä¸æ˜¯ä»€ä¹ˆæ–°é²œè¯é¢˜ã€‚&lt;/p>
&lt;p>åœ¨ C æ ‡å‡†åº“ä¸­ï¼Œè§„å®šäº†ä¸€ç³»åˆ—çš„ä¿¡å·å’Œä¿¡å·å¤„ç†æ–¹æ³•ã€‚å…³äºä¿¡å·çš„å®šä¹‰å¯ä»¥å‚è€ƒ&lt;a class="link" href="https://zh.cppreference.com/w/c/program/signal" target="_blank" rel="noopener"
>è¿™ä¸ª&lt;/a>ã€‚&lt;/p>
&lt;p>å½“è¿›ç¨‹æ¥æ”¶åˆ°ä¿¡å·çš„æ—¶å€™ï¼Œå½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»£ç å°±ä¼šè¢«ä¸­æ–­â€”â€”æ³¨æ„äº†ï¼Œè¿™å›ï¼Œé”æ•‘ä¸äº†ä½ ã€‚&lt;/p>
&lt;p>åœ¨ C/C++ä¸­ï¼Œä¸­æ–­å¤„ç†æ˜¯ç”±ä¸€ä¸ªå‡½æ•°è¿›è¡Œã€‚åœ¨å‡½æ•°é‡Œå¯èƒ½ä¼šè°ƒç”¨åˆ°ä¸­æ–­æ—¶æ­£åœ¨æ‰§è¡Œçš„å‡½æ•°ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†â€”â€”ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„å‡½æ•°ï¼Œæ˜¯ä¸­æ–­å®‰å…¨çš„å‡½æ•°å—ï¼Ÿ&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-C++" data-lang="C++">&lt;span class="kt">void&lt;/span> &lt;span class="nf">initialize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Something&lt;/span>&lt;span class="o">**&lt;/span> &lt;span class="n">someshit&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">mutex&lt;/span>&lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">realshit&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">lock_guard&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">mutex&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">realshit&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">!*&lt;/span>&lt;span class="n">someshit&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">*&lt;/span>&lt;span class="n">someshit&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">createSomeShit&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>çœ‹ä¸Šå»å²æœˆé™å¥½~ä¸€åˆ‡çº¿ç¨‹åˆ‡æ¢çš„é—®é¢˜ï¼Œéƒ½è¢«é‚£å¥&lt;code>std::lock_guard&amp;lt;std::mutex&amp;gt;(realshit)&lt;/code>ç»™æŒ¡åœ¨äº†å¢™çš„å¦ä¸€è¾¹ã€‚&lt;/p>
&lt;p>ä½†æ˜¯&amp;hellip;&amp;hellip;&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-C++" data-lang="C++">&lt;span class="kt">void&lt;/span> &lt;span class="nf">initialize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Something&lt;/span>&lt;span class="o">**&lt;/span> &lt;span class="n">someshit&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">mutex&lt;/span>&lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">realshit&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">lock_guard&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">mutex&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">realshit&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">!*&lt;/span>&lt;span class="n">someshit&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// &amp;lt;----- è°ƒçš®çš„ç”¨æˆ·æŒ‰ä¸‹äº† Ctrl-C
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// ä¸­æ–­å¤„ç†å‡½æ•°() {
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// initialize(someshit, realshit);
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// // inside initialize {
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// // std::lock_guard&amp;lt;std::mutex&amp;gt;(realshit); // DEAD LOCK
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// // }
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// }
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">someshit&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">createSomeShit&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>çœ‹è¿™é‡Œ~&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-C++" data-lang="C++">&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">lock_guard&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">mutex&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">realshit&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// è¿›å…¥ä¿¡å·å¤„ç†
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">lock_guard&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">mutex&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">realshit&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¥½äº†ï¼ŒGGã€‚æ­»é”åœ¨è¿™ä¸ªæ—¶å€™å‘ç”Ÿäº†ã€‚&lt;/p>
&lt;p>ç»éªŒä¸°å¯Œçš„å¤§ä½¬å¯èƒ½æ³¨æ„åˆ°äº†ï¼Œå’±è¿˜å¯ä»¥ç”¨&lt;code>std::recursive_mutex&lt;/code>å•Šï¼&lt;/p>
&lt;p>è¿™é‡Œå°±è¦æåˆ°ä¸€ä¸ªå¾ˆé—æ†¾çš„é—®é¢˜äº†ï¼šC/C++çš„è¯­è¨€æ ‡å‡†ç»™äº†å“ªäº›ä¿è¯ã€‚&lt;/p>
&lt;p>C å¯¹ä¿¡å·å¤„ç†å‡½æ•°çš„å®šä¹‰å¾ˆç²—æš´ï¼Œé™¤äº†&lt;code>abort&lt;/code>ã€&lt;code>_Exit&lt;/code>ã€&lt;code>quick_exit&lt;/code>ã€&lt;code>signal&lt;/code>ã€&lt;code>stdatomic.hçš„å…é”åŸå­å‡½æ•°&lt;/code>ã€&lt;code>atomic_is_lock_freeä¸ä»»ä½•ç±»å‹çš„åŸå­å‚æ•°&lt;/code>è¿™äº›å‡½æ•°ä»¥å¤–ï¼Œä»»ä½•æ ‡å‡†åº“å‡½æ•°çš„è°ƒç”¨ï¼Œè¡Œä¸ºéƒ½æ˜¯æœªå®šä¹‰çš„ã€‚&lt;/p>
&lt;p>C++å¯¹ä¿¡å·å¤„ç†å‡½æ•°çš„å®šä¹‰åˆ™æ›´åŠ å¤æ‚ï¼Œé™åˆ¶æ¯”ä¹‹ C æ›´åŠ ä¸¥æ ¼ã€‚æ¯•ç«Ÿæ ‡å‡†åº“è¦åºå¤§å¾—å¤š&amp;hellip;&amp;hellip;ä¹Ÿä¸æ˜¯ä¸èƒ½ç†è§£ã€‚&lt;/p>
&lt;p>æ ‡å‡†ä¸­æœ‰ä¸ªä¸€ä¸ªåœ°æ–¹çš„æè¿°å¾ˆå¾®å¦™ï¼š&lt;strong>&amp;hellip;&amp;hellip;å…é”çš„&lt;/strong>ã€‚&lt;/p>
&lt;p>æ¢è¨€ä¹‹ï¼Œè°åˆä¿è¯äº†ä¿¡å·å¤„ç†å‡½æ•°å¿…ç„¶å’Œä½ å¸Œæœ›çš„é‚£ä¸ªçº¿ç¨‹æ˜¯åŒä¸€ä¸ªçº¿ç¨‹å‘¢ï¼Ÿ&lt;/p>
&lt;p>&lt;code>std::recursive_mutex&lt;/code>çš„å®ç°ä¾èµ–äºå¹³å°æä¾›çš„ç³»ç»Ÿ APIï¼Œåæ­£æˆ‘æ²¡æœ‰æ‰¾åˆ°è¯­è¨€æ ‡å‡†ä¸­ç›¸å…³çš„è§„å®šè¦æ±‚ä¿¡å·å¤„ç†å‡½æ•°å¿…é¡»å’Œ&lt;code>main&lt;/code>å‡½æ•°åœ¨åŒä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥æˆ‘è®¤ä¸ºè¿™æ˜¯å¹³å°ç›¸å…³çš„é—®é¢˜ï¼šè¿™æ ·çš„ä»£ç æ˜¯&lt;strong>ä¸å¯ç§»æ¤çš„&lt;/strong>ã€‚&lt;/p>
&lt;p>æŒ‰ç…§è®¾è®¡æ¨¡å¼åŸåˆ™ï¼Œæˆ‘ä»¬æ˜¯é¢å‘æ¥å£â€”â€”ä¹Ÿå°±æ˜¯æ ‡å‡†æ–‡æ¡£ç¼–ç¨‹ï¼Œè€Œä¸æ˜¯é¢å¯¹å®ç°â€”â€”Visual C++ã€GCCã€MinGW æˆ–è€…å“ªä¸ªä¸­ä¸œåœŸè±ªåœ¨æœªæ¥æŸå¤©çªå‘å¥‡æƒ³é€æˆ‘ä¸€å° MIPS çš„è¶…ç®—çš„è¯ã€‚&lt;/p>
&lt;p>åˆ°ä¸šåŠ¡å±‚é¢çš„è¯ä¼šæ›´çµæ´»ä¸€äº›â€”â€”åæ­£æˆ‘åªåœ¨æŸç¯å¢ƒä¸‹è·‘ï¼Œç­‰å…¬å¸ä»€ä¹ˆæ—¶å€™å…¨é¢æ¢å¹³å°äº†ï¼Œå’±å†èƒ½æ”¹åˆ™æ”¹ï¼Œæ”¹ä¸äº†å°±è·‘è·¯ã€‚&lt;/p>
&lt;h2 id="é€’å½’å‡½æ•°å’Œå¯é‡å…¥">é€’å½’å‡½æ•°å’Œå¯é‡å…¥&lt;/h2>
&lt;p>é€’å½’å’Œé‡å…¥æœ‰ä¸€å®šçš„ç›¸ä¼¼æ€§ï¼Œä½†åˆæœ‰æ‰€ä¸åŒã€‚&lt;/p>
&lt;p>ä¸€ä¸ªé€’å½’å‡½æ•°ï¼Œç›´è§‰ä¸Šæ¥è®²ï¼Œå¥½åƒåº”è¯¥æ˜¯å¯é‡å…¥çš„ï¼šå› ä¸ºå®ƒè¦è°ƒç”¨è‡ªå·±ã€‚&lt;/p>
&lt;p>é‚£ä¹ˆ&amp;hellip;&amp;hellip;äº‹å®ä¸Šå‘¢ï¼Ÿ&lt;/p>
&lt;p>å†™ä¸ªæ¯”è¾ƒéªšçš„é€’å½’åˆ é™¤é“¾è¡¨èŠ‚ç‚¹çš„ä¾‹å­ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-C++" data-lang="C++">&lt;span class="kt">void&lt;/span> &lt;span class="nf">removeNode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Node&lt;/span>&lt;span class="o">*&lt;/span> &lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">length&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">Node&lt;/span>&lt;span class="o">*&lt;/span> &lt;span class="n">tmp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">node&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">prev&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">node&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">next&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">prev&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tmp&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// &amp;lt;------ å‡ºç°äº†ï¼ä¸­æ–­å…½ï¼
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// ä¸ç”¨çœ‹äº†ï¼ŒNodeä¹‹é—´çš„è”ç»“å·²ç»è¢«ç ´åäº†
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// ç¦»å¼€äº†ï¼ä¸­æ–­å…½ï¼--------&amp;gt;
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">tmp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">next&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">node&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">next&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">freeNode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">removeNode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tmp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">next&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">length&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è½»æ˜“åœ°å¦å®šäº†é€’å½’å‡½æ•°=å¯é‡å…¥å‡½æ•°çš„ç›´è§‰æƒ³æ³•ã€‚&lt;/p>
&lt;p>æ·±ç©¶ä¸‹å»ï¼Œåˆåˆ°äº†çº¿ç¨‹å®‰å…¨â€”â€”ç„¶åæ˜¯æ­»é”â€”â€”ç„¶åæå‡ºäº†&lt;code>std::recursive_mutex&lt;/code>æˆ–è€…å…¶ä»–ç±»ä¼¼çš„æ“ä½œâ€”â€”æœ€åèµ°åˆ°å¹³å°ç›¸å…³çš„ API å’Œä¿è¯â€”â€”å¤±å»å¯ç§»æ¤æ€§ã€‚&lt;/p>
&lt;p>ä¸ºä»€ä¹ˆæˆ‘ä¸€ç›´åœ¨æå¯ç§»æ¤æ€§ï¼Ÿ&lt;/p>
&lt;p>emmmmï¼Œå¤§æ¦‚æ˜¯è£…é€¼å¦‚é£ï¼Œå¸¸ä¼´å¾èº«å§ã€‚&lt;/p>
&lt;h2 id="æ ‡å‡†åº“å¥½çƒ¦äººå•Š">æ ‡å‡†åº“å¥½çƒ¦äººå•Š&lt;/h2>
&lt;p>C/C++è¯­è¨€çš„æ ‡å‡†åº“æ˜¯å‡ºäº†åçš„â€”â€”ä½†ä¸æ˜¯å¥½çš„æ–¹é¢ï¼Œè€Œæ˜¯ä»–ä»¬æ€»åœ¨ä¿®ä¿®è¡¥è¡¥åˆä¸€å¹´ã€‚&lt;/p>
&lt;p>C æ ‡å‡†åº“è¿˜å¥½è¯´â€”â€”æ¯•ç«Ÿè¯­è¨€æœ¬èº«æ²¡å•¥ç‰¹æ€§ï¼Œå…¨é å„ç§å¹³å°æä¾› API æ’‘ç€ã€‚æ ‡å‡†åº“æ”¹æ¥æ”¹å»ä¹Ÿåªæ˜¯å‰²ä¸ªåŒçœ¼çš®çš„ç¨‹åº¦ã€‚&lt;/p>
&lt;p>C++è¦æ›´éªšæ°”ä¸€äº›ï¼Œæ¯éš”å‡ å¹´å°±æ•´ä¸ªå®¹ï¼Œç®€ç›´ä¸ç»™äººæ´»è·¯ã€‚&lt;/p>
&lt;p>å°±ä¸­æ–­å®‰å…¨æ¥è¯´ï¼Œè™½ç„¶ä¸çŸ¥é“å†…éƒ¨æ€ä¹ˆå®ç°çš„ï¼Œä½†æ˜¯&amp;hellip;&amp;hellip;printf è¿™æ ·çš„å‡½æ•°åœ¨ä¿¡å·å¤„ç†å‡½æ•°é‡Œè°ƒç”¨çš„è¯ï¼Œä¹Ÿç®—æ˜¯æœªå®šä¹‰è¡Œä¸ºã€‚&lt;/p>
&lt;p>è®¤è¾“å§ï¼Œä½ æ˜¯æ–—ä¸è¿‡æ ‡å‡†çš„ã€‚è¯¥ä¾èµ–å¹³å°è¡Œä¸ºçš„æ—¶å€™ï¼Œå°±å»ä¾èµ–å¹³å°è¡Œä¸ºå§ã€‚&lt;/p>
&lt;h2 id="æ–‡æ¡£å¼•ç”¨">æ–‡æ¡£å¼•ç”¨&lt;/h2>
&lt;p>æ‡’å¾—æ‰¾åŸæ–‡ï¼Œç›´æ¥çœ‹ cppreference å¯¹ signal çš„è¯´æ³•å°±å¥½ã€‚æœ‰å…´è¶£çš„è¯å¯ä»¥æ‰¾åˆè‡­åˆé•¿çš„&lt;a class="link" href="http://www.open-std.org/JTC1/SC22/WG14/www/docs/n1570.pdf" target="_blank" rel="noopener"
>WG14 - N1570 - C11&lt;/a>ï¼Œè¿˜æœ‰&lt;a class="link" href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2017/n4659.pdf" target="_blank" rel="noopener"
>WG21 - N4659 - C++17&lt;/a>è¿™ä¸¤æœ¬æ ‡å‡†æ–‡æ¡£ã€‚&lt;/p>
&lt;h2 id="å°¾å£°">å°¾å£°&lt;/h2>
&lt;p>äºæ˜¯è¿™ä¼šå„¿å°±åˆ°äº†å…¶ä»–å„ç§è¯­è¨€çš„ç”¨æˆ·æƒ¯ä¾‹åæ§½çš„æ—¶å€™ï¼š&lt;/p>
&lt;blockquote>
&lt;p>&amp;hellip;å¤§ä½¬æ˜¯å…¬å¸é‡Œå”¯ä¸€ç”¨ C++å†™ä»£ç çš„äººã€‚ä»–å¯¹äººè¯´è¯ï¼Œæ€»æ˜¯æ»¡å£â€œç›®æ ‡å¹³å°â€ã€â€œæ ‡å‡†â€ã€â€œå¯ç§»æ¤æ€§â€ä¹‹ç±»çš„è¯ï¼Œå«äººåŠæ‡‚ä¸æ‡‚çš„ã€‚å› ä¸ºä»–æ€»æ˜¯è¯´â€œC++å¤©ä¸‹ç¬¬ä¸€ï¼â€ï¼Œåˆ«äººä¾¿ä»ä»–è¯´çš„é‚£äº›åŠæ‡‚ä¸æ‡‚çš„è¯é‡Œï¼Œæ›¿ä»–å–ä¸‹ä¸ªç»°å·ï¼Œå« C++å¤§ç¥ã€‚&lt;/p>
&lt;p>C++å¤§ç¥ä¸€åˆ°å…¬å¸é‡Œï¼Œç¨‹åºå‘˜ä»¬ä¾¿çœ‹ç€ä»–ç¬‘ï¼Œæœ‰çš„å«é“ï¼šâ€œC++å¤§ç¥ï¼Œä½ çš„ä»£ç åˆç¼–è¯‘å‡ºé”™äº†ï¼â€&lt;/p>
&lt;p>ä»–ä¸å›ç­”ï¼Œå¯¹å‰å°è¯´ï¼šâ€œå€’ä¸Šç‰¹æµ“çš„å’–å•¡ï¼Œä»Šå¤©ä¹Ÿè¦åŠ ç­åˆ°å¤œé‡Œã€‚â€ä¾¿æ‹¿å‡ºå‘˜å·¥å¡ã€‚ç¨‹åºå‘˜ä»¬åˆé«˜å£°å«åš·é“ï¼šâ€œä½ ä¸€å®šåˆç”¨ä¸Šæ–°æ ‡å‡†äº†å§ï¼Ÿâ€&lt;/p>
&lt;p>C++å¤§ç¥çå¤§çœ¼ç›è¯´ï¼Œâ€œä½ æ€ä¹ˆå‡­ç©ºæ±¡äººæ¸…ç™½ï¼â€&lt;/p>
&lt;p>â€œä»€ä¹ˆæ¸…ç™½ï¼Ÿæˆ‘å‰å¤©äº²çœ¼çœ‹è§ä½ çš„ä»£ç ç¼–è¯‘æŠ¥äº†é”™ï¼Œæ•´æ•´åå‡  MB çš„æ—¥å¿—ï¼â€&lt;/p>
&lt;p>C++å¤§ç¥ä¾¿æ¶¨çº¢äº†è„¸ï¼Œé¢ä¸Šçš„é’ç­‹æ¡æ¡ç»½å‡ºï¼Œäº‰è¾©é“ï¼Œâ€œç¼–è¯‘å™¨æŠ¥é”™æ€ä¹ˆèƒ½å«é”™&amp;hellip;&amp;hellip;C++&amp;hellip;&amp;hellip;ç¼–è¯‘å™¨ä¸æ”¯æŒï¼Œé‚£èƒ½ç®—é”™ä¹ˆï¼Ÿâ€&lt;/p>
&lt;p>æ¥è¿ä¾¿æ˜¯éš¾æ‡‚çš„è¯ï¼Œä»€ä¹ˆâ€œCONCEPT è¿˜ä¸åŠ å…¥æ ‡å‡†â€ã€â€œæœªå®šä¹‰è¡Œä¸ºå°±è¯¥æ˜¯ç¼–è¯‘é”™è¯¯â€ã€â€œSFINAE å°±æ˜¯ç»™ç¼–è¯‘å™¨å¼€æ´â€ã€â€œboost å¤§æ³•å¥½ï¼Œå¤©ç­ std::experimentalâ€ï¼Œå¼•å¾—ä¼—äººéƒ½å“„ç¬‘èµ·æ¥ï¼šåº—å†…å¤–å……æ»¡äº†å¿«æ´»çš„ç©ºæ°”ã€‚&lt;/p>
&lt;/blockquote></description></item><item><title>MySQL 24å°æ—¶å…¥é—¨ç¬”è®° - 4</title><link>https://nnnewb.github.io/blog/p/mysql-24%E5%B0%8F%E6%97%B6%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0-4/</link><pubDate>Sat, 23 Jun 2018 22:34:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/mysql-24%E5%B0%8F%E6%97%B6%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0-4/</guid><description>&lt;h2 id="åˆ›å»ºè¡¨">åˆ›å»ºè¡¨&lt;/h2>
&lt;h3 id="create-table">CREATE TABLE&lt;/h3>
&lt;p>&lt;code>CREATE TABLE&lt;/code>çš„ä½œç”¨æ˜¯åˆ›å»ºè¡¨ã€‚ä¸å¤šè¯´ï¼Œå…ˆåˆ›å»ºä¸ªç®€å•çš„å­¦ç”Ÿè¡¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">students&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">char&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">16&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">primary&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">key&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œæ²¡å†™ &lt;code>ENGINE=InnoDB&lt;/code>ï¼Œå› ä¸ºè¿™æ˜¯æ–° MariaDB çš„é»˜è®¤å€¼ã€‚&lt;/p>
&lt;p>é‚£ä¹ˆè¿›å…¥æ­£é¢˜ï¼Œ&lt;code>CREATE TABLE&lt;/code>çš„è¯­æ³•å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">è¡¨å&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">åˆ—å&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">ç±»å‹&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">çº¦æŸå’Œå…¶ä»–å±æ€§&lt;/span>&lt;span class="p">],&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">åˆ—å&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">ç±»å‹&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">çº¦æŸå’Œå…¶ä»–å±æ€§&lt;/span>&lt;span class="p">],&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">....&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">å…¶ä»–è¡¨é…ç½®&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¾ˆå®¹æ˜“çœ‹å‡ºï¼Œæ‹¬å·é‡Œé¢å†™çš„æ˜¯è¡¨çš„ç›¸å…³é…ç½®ï¼ŒåŒ…æ‹¬åˆ—å®šä¹‰ï¼Œä¸»é”®å®šä¹‰ï¼Œç´¢å¼•å®šä¹‰ç­‰ç­‰ã€‚&lt;/p>
&lt;h3 id="é»˜è®¤å€¼">é»˜è®¤å€¼&lt;/h3>
&lt;p>åœ¨åˆ›å»ºè¡¨æ—¶å¯ä»¥æŒ‡å®šé»˜è®¤å€¼ï¼Œæœ‰é»˜è®¤å€¼çš„åˆ—åœ¨æ’å…¥æ—¶å¯ä»¥ä¸å¡«ã€‚&lt;/p>
&lt;p>è¯­æ³•å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">è¡¨&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">åˆ—&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">ç±»å‹&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">å€¼&lt;/span>&lt;span class="p">],&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å³å¯ä¸ºä¸€ä¸ªåˆ—è®¾å®šé»˜è®¤å€¼ã€‚&lt;/p>
&lt;h3 id="éç©º">éç©º&lt;/h3>
&lt;p>éç©ºçº¦æŸéå¸¸å¸¸è§ã€‚æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬è¦è®°å½•å­¦ç”Ÿä¿¡æ¯ï¼ŒåŒ…æ‹¬å­¦å·ã€æˆç»©ã€å§“åï¼Œé‚£ä¹ˆå­¦ç”Ÿå§“åèƒ½ä¸èƒ½ç•™ç©ºå‘¢ï¼Ÿæ˜¾ç„¶ä¸è¡Œï¼Œå› ä¸ºæ²¡æœ‰å§“åçš„è®°å½•è®©è°çœ‹éƒ½æ˜¯ä¸€è„¸æ‡µé€¼ï¼Œè¿™ç ´åäº†ä¸€æ¡è®°å½•çš„å®Œæ•´æ€§ã€‚&lt;/p>
&lt;p>åˆ›å»ºéç©ºçº¦æŸçš„è¯­æ³•å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">è¡¨&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">åˆ—&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">ç±»å‹&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™å°±åˆ›å»ºäº†éç©ºçº¦æŸã€‚éç©ºçº¦æŸä¸‹ï¼Œæ’å…¥æ•°æ®æ—¶ä¸èƒ½ä¸å¡«å†™è¿™ä¸ªåˆ—ã€‚&lt;/p>
&lt;p>å¦‚æœéœ€è¦è¦æ±‚å¯ç©ºï¼Œé‚£ä¹ˆè¿™æ ·åšã€‚ä½†ä¸€èˆ¬ä¸ç”¨ç‰¹åœ°å†™ï¼Œå¾ˆå¤š&lt;code>DBMS&lt;/code>çš„åˆ—é»˜è®¤åˆ›å»ºå°±æ˜¯å¯ç©ºçš„ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">è¡¨&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">åˆ—&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">ç±»å‹&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="ä¿®æ”¹è¡¨">ä¿®æ”¹è¡¨&lt;/h2>
&lt;h3 id="alter-table">ALTER TABLE&lt;/h3>
&lt;p>&lt;code>ALTER TABLE&lt;/code>å¯ä»¥ä¿®æ”¹è¡¨å®šä¹‰ï¼Œæ·»åŠ åˆ é™¤åˆ—ï¼Œä¿®æ”¹çº¦æŸï¼Œç­‰ç­‰ã€‚&lt;/p>
&lt;h3 id="æ·»åŠ åˆ—">æ·»åŠ åˆ—&lt;/h3>
&lt;p>ä¸¾ä¾‹ï¼Œåœ¨ä¸€ä¸ªåªæœ‰å­¦å·å’Œå§“åä¸¤ä¸ªåˆ—çš„å­¦ç”Ÿè¡¨åŠ å…¥ä¸€ä¸ªæ–°çš„æˆç»©åˆ—ï¼Œä»£ç å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="k">ALTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">students&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">ADD&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">score&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¯­æ³•åŸºæœ¬æ˜¯è¿™æ ·ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="k">ALTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">è¡¨å&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">ADD&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">åˆ—å&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">ç±»å‹&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">å…¶ä»–å±æ€§å’Œçº¦æŸ&lt;/span>&lt;span class="p">];&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åé¢åˆ—çš„å®šä¹‰å†™æ³•åŸºæœ¬å’Œ&lt;code>CREATE TABLE&lt;/code>æ—¶å·®ä¸å¤šã€‚&lt;/p>
&lt;h3 id="åˆ é™¤åˆ—">åˆ é™¤åˆ—&lt;/h3>
&lt;p>å’Œæ·»åŠ åˆ—å·®ä¸å¤šï¼Œä½†åˆ é™¤çš„å…³é”®å­—&lt;strong>ä¸æ˜¯&lt;/strong>&lt;code>DELETE&lt;/code>ï¼Œè€Œæ˜¯&lt;code>DROP&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="k">ALTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">è¡¨å&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">DROP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">åˆ—å&lt;/span>&lt;span class="p">];&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æ·»åŠ å¤–é”®çº¦æŸ">æ·»åŠ å¤–é”®çº¦æŸ&lt;/h3>
&lt;p>å¤–é”®çº¦æŸå…¶å®ä¿è¯çš„æ˜¯&lt;strong>å¼•ç”¨å®Œæ•´æ€§&lt;/strong>ï¼Œå¤–é”®çº¦æŸçš„åˆ—çš„å€¼å¿…é¡»å¼•ç”¨äº†ä¸€ä¸ªæœ‰æ•ˆçš„è¡Œï¼Œæˆ–è€…æ˜¯&lt;code>NULL&lt;/code>ã€‚&lt;/p>
&lt;p>ä¸¾ä¾‹æ¥è¯´ï¼Œæˆ‘ä»¬å…ˆæœ‰ä¸¤ä¸ªè¡¨ã€‚&lt;/p>
&lt;p>å­¦ç”Ÿè¡¨&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>id&lt;/th>
&lt;th>name&lt;/th>
&lt;th>class&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>student 1&lt;/td>
&lt;td>1&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>2&lt;/td>
&lt;td>student 2&lt;/td>
&lt;td>2&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>3&lt;/td>
&lt;td>student 3&lt;/td>
&lt;td>3&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>ç­çº§è¡¨&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>id&lt;/th>
&lt;th>level&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>Lv5&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>2&lt;/td>
&lt;td>Lv4&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>3&lt;/td>
&lt;td>Lv3&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>ä¸ºäº†è®©å­¦ç”Ÿè¡¨çš„&lt;code>class&lt;/code>å…³è”åˆ°ç­çº§è¡¨çš„&lt;code>id&lt;/code>ï¼Œæˆ‘ä»¬è¦è¿™æ ·åšã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="k">ALTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">students&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">ADD&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CONSTRAINT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">fk_students_classes&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">FOREIGN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">class&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">REFERENCES&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">classes&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¯­æ³•åŸºæœ¬æ˜¯è¿™æ ·å­çš„&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="k">ALTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">ä¿å­˜å¤–é”®çš„è¡¨&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">ADD&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CONSTRAINT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">å¤–é”®çº¦æŸçš„åå­—ï¼Œä¸€èˆ¬&lt;/span>&lt;span class="n">fkå¼€å¤´&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">FOREIGN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="err">å¤–é”®å&lt;/span>&lt;span class="p">])&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">REFERENCES&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">å¼•ç”¨çš„è¡¨å&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="err">å¼•ç”¨çš„é”®å&lt;/span>&lt;span class="p">])&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¯”è¾ƒå¤æ‚ã€‚&lt;/p>
&lt;h3 id="åˆ é™¤è¡¨">åˆ é™¤è¡¨&lt;/h3>
&lt;p>é‚£ä¹ˆç»ˆäºåˆ°äº†æœŸå¾…å·²ä¹…çš„åˆ åº“è·‘è·¯é˜¶æ®µã€‚&lt;/p>
&lt;p>åˆ é™¤è¡¨çš„è¯­æ³•éå¸¸ç®€å•ï¼Œé‚£ä¹ˆä»ä¸€å¼€å§‹æ´»åˆ°ç°åœ¨çš„è¿™æ‰€å­¦æ ¡ç»ˆäºå¹²ä¸ä¸‹å»äº†ï¼Œæ ¡é•¿å†³å®šé£æ•£å­¦ç”Ÿã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="k">DROP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">students&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>äººèµ°å…‰äº†ã€‚&lt;/p>
&lt;h3 id="é‡å‘½åè¡¨">é‡å‘½åè¡¨&lt;/h3>
&lt;p>æ ¡é•¿å†³å®šæŠŠå­¦æ ¡æ”¹æˆå¤œæ€»ä¼šï¼Œäºæ˜¯ä»–å†™é“ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="k">RENAME&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">school&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TO&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">night_club&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¦æ˜¯æ¢è¡Œæœ‰è¿™ä¹ˆå®¹æ˜“å°±å¥½äº†&amp;hellip;&amp;hellip;ï¼ˆä½ æ•¢è¯´å›è½¦çœ‹çœ‹ï¼‰&lt;/p></description></item><item><title>MySQL 24å°æ—¶å…¥é—¨ç¬”è®° - 3</title><link>https://nnnewb.github.io/blog/p/mysql-24%E5%B0%8F%E6%97%B6%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0-3/</link><pubDate>Sat, 23 Jun 2018 21:51:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/mysql-24%E5%B0%8F%E6%97%B6%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0-3/</guid><description>&lt;h2 id="æ’å…¥">æ’å…¥&lt;/h2>
&lt;h3 id="insert">INSERT&lt;/h3>
&lt;p>&lt;code>INSERT&lt;/code>ç”¨æ³•éå¸¸ç®€å•ã€‚ç°åœ¨æˆ‘ä»¬æœ‰è¡¨&lt;code>students&lt;/code>å¦‚ä¸‹ã€‚&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>åˆ—å&lt;/th>
&lt;th>ç±»å‹&lt;/th>
&lt;th>çº¦æŸ&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>id&lt;/td>
&lt;td>int&lt;/td>
&lt;td>primary key&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>name&lt;/td>
&lt;td>char(16)&lt;/td>
&lt;td>NOT NULL&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>å‘é‡Œé¢æ’å…¥ä¸€æ¡å­¦å·ä¸º&lt;code>1&lt;/code>ï¼Œå§“åä¸º&lt;code>å­¦å§&lt;/code>çš„å­¦ç”Ÿï¼Œåªéœ€è¦å†™å¦‚ä¸‹&lt;code>SQL&lt;/code>è¯­å¥ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="k">INSERT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INTO&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">students&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">VALUES&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;å­¦å§&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¯­æ³•&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="k">INSERT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INTO&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">è¡¨&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">VALUES&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="err">åˆ—å€¼&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="err">åˆ—å€¼&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">,...);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…¶ä¸­&lt;code>INSERT&lt;/code>è¯­å¥æœ‰ä¸€ä¸ªç®€å•çš„å˜ä½“ï¼Œèƒ½æ¯”è¾ƒæ˜ç¡®åœ°æŒ‡æ˜å°†å€¼äº¤ä»˜ç»™å“ªä¸ªåˆ—ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="k">INSERT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INTO&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">students&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">VALUES&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;å­¦å¦¹&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™æ ·å†™ç›¸å½“äºæŒ‡æ˜äº†&lt;code>1&lt;/code>åº”è¯¥æ˜¯&lt;code>id&lt;/code>ï¼Œ&lt;code>'å­¦å¦¹'&lt;/code>åº”è¯¥æ˜¯&lt;code>name&lt;/code>ã€‚&lt;/p>
&lt;p>æ’å…¥å¤šæ¡ä¹Ÿå¾ˆç®€å•ï¼Œåªè¦åœ¨&lt;code>VALUES&lt;/code>åé¢è·Ÿæ›´å¤šå°æ‹¬å·åŒ…å›´çš„å€¼é›†åˆå°±è¡Œäº†ï¼Œè®°å¾—æ‹¿æ‹¬å·åˆ†éš”ï¼Œä¸‹é¢ç»™ä¸ªä¾‹å­ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="k">INSERT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INTO&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">students&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">VALUES&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;å­¦æ¸£&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;å­¦éœ¸&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;å­¦ç¥&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="insert-select">INSERT SELECT&lt;/h3>
&lt;p>è¿™ä¸ªå†™æ³•æ¯”è¾ƒæœ‰æ„æ€ï¼Œä»ä¸€ä¸ªè¡¨æŸ¥è¯¢å‡ºæ•°æ®ï¼Œå¹¶æ’å…¥å¦ä¸€ä¸ªè¡¨ã€‚&lt;/p>
&lt;p>ä¸¾ä¸ªä¾‹å­æ¥è¯´ï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªç­çº§è¡¨ï¼Œåˆ†åˆ«å«&lt;code>å­¦æ¸£ç­&lt;/code>å’Œ&lt;code>è¡¥ä¹ ç­&lt;/code>ï¼Œä¸€æ—¦å­¦æ¸£æˆç»©çƒ‚åˆ°ä¸€å®šç¨‹åº¦ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¦æŠŠä»–åˆ†é…åˆ°è¡¥ä¹ ç­é‡Œå»å¼ºåˆ¶è¡¥ä¹ ã€‚&lt;/p>
&lt;p>æ€ä¹ˆåšå‘¢ï¼Ÿçœ‹ä¸‹é¢å•¦ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="k">INSERT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INTO&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">è¡¥ä¹ ç­&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">score&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">å­¦æ¸£ç­&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">å­¦æ¸£ç­&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">score&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">å­¦æ¸£ç­&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">å­¦æ¸£ç­&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">score&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ&lt;code>INSERT&lt;/code> å¡«å……è¡¥ä¹ ç­è¡¨æ—¶ç”¨çš„å¹¶ä¸æ˜¯ä½ &lt;code>SELECT&lt;/code>çš„åˆ—åï¼Œè€Œæ˜¯&lt;code>SELECT&lt;/code>ååˆ—åçš„é¡ºåºï¼Œæ¥å¯¹åº”åˆ°è¦&lt;code>INSERT&lt;/code>çš„è¡¨çš„åˆ—ä¸Šã€‚&lt;/p>
&lt;p>å…¶ä»–çš„å†™æ³•å’Œ&lt;code>SELECT&lt;/code>ç›¸åŒã€‚&lt;/p>
&lt;h2 id="ä¿®æ”¹">ä¿®æ”¹&lt;/h2>
&lt;h3 id="update">UPDATE&lt;/h3>
&lt;p>&lt;code>UPDATE&lt;/code>è¯­å¥çš„ä½œç”¨æ˜¯ä¿®æ”¹ç°å­˜è¡Œçš„æ•°æ®ï¼Œéå¸¸å€¼å¾—æ³¨æ„çš„æ˜¯ç”¨&lt;code>UPDATE&lt;/code>è¯­å¥æ—¶ä¸€å®šè¦å°å¿ƒå†™&lt;code>WHERE&lt;/code>å­å¥ï¼Œä¸ç„¶å°±ç­‰ç€åˆ åº“è·‘è·¯å§ã€‚&lt;/p>
&lt;p>ä¾ç„¶ä¸¾ä¸ªå®é™…æ —å­ï¼Œå­¦å·ä¸º&lt;code>10&lt;/code>çš„å­¦ç”Ÿæˆç»©ç”±äºä½œå¼Šè€Œè¢«å–æ¶ˆäº†ï¼Œæˆ‘ä»¬è¦æ›´æ–°ä»–çš„æˆç»©ä¸º 0 åˆ†ï¼Œè¿™çœŸæ˜¯ä¸ªæ‚²ä¼¤çš„æ•…äº‹:P&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="k">UPDATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">students&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">score&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¯­æ³•æ˜¯è¿™æ ·çš„ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="k">UPDATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">è¡¨å&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">åˆ—å&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">æ–°å€¼&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">æ¡ä»¶&lt;/span>&lt;span class="p">];&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ›´æ–°å¤šæ¡çš„è¯æ˜¯è¿™æ ·çš„&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="k">UPDATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">è¡¨å&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">åˆ—&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">æ–°å€¼&lt;/span>&lt;span class="p">],&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">åˆ—&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">æ–°å€¼&lt;/span>&lt;span class="p">],&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">...&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">åˆ—&lt;/span>&lt;span class="n">N&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">æ–°å€¼&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">æ¡ä»¶&lt;/span>&lt;span class="p">];&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;p>åƒä¸‡å°å¿ƒï¼Œå¦‚æœæ²¡æœ‰ &lt;code>WHERE&lt;/code>å­å¥çš„è¯ï¼ŒæŒ‡å®šçš„åˆ—ä¼šå…¨éƒ¨è¢«è®¾ç½®æˆè¿™ä¸ªå€¼ã€‚è¿™æ ·ä¸€æ¥ï¼Œæ‰€æœ‰çš„å­¦ç”Ÿéƒ½å˜æˆäº† 0 åˆ†&amp;hellip;&amp;hellip;ä½ ä¼šè¢«æ‰‹æ’•äº†çš„ã€‚&lt;/p>
&lt;/blockquote>
&lt;h2 id="åˆ é™¤">åˆ é™¤&lt;/h2>
&lt;h3 id="delete">DELETE&lt;/h3>
&lt;p>&lt;code>DELETE&lt;/code>çš„ä½œç”¨æ˜¯åˆ é™¤è¡Œï¼ŒåŒæ ·çš„ï¼Œä¸‡åˆ†æ³¨æ„&lt;code>WHERE&lt;/code>å­å¥ä¸€å®šè¦æ­£ç¡®ç¼–å†™ï¼Œä¸ç„¶çœŸçš„è¦åˆ åº“è·‘è·¯äº†ã€‚&lt;/p>
&lt;p>åŒæ ·ä»¥ä¹‹å‰é‚£ä½ä½œå¼Šçš„åŒå­¦ä¸ºä¾‹ï¼Œå¾ˆé—æ†¾ï¼Œä»–åˆä¸€æ¬¡ä½œå¼Šè¢«æŠ“ä½äº†ï¼Œä¼ è¯´ä¸­çš„é«˜ç§‘æŠ€ AR æŠ€æœ¯ä½œå¼Šçœ¼é•œä¹Ÿæ²¡èƒ½è®©ä»–é€ƒè¿‡ç›‘è€ƒå‘˜çš„ç«çœ¼é‡‘ç›ï¼Œäºæ˜¯ä»–è¢«é€€å­¦äº†&amp;hellip;&amp;hellip;&lt;/p>
&lt;p>å¦ä¸€ä¸ªæ‚²ä¼¤çš„æ•…äº‹:P&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="k">DELETE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">students&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¯­æ³•æ˜¯è¿™æ ·å­çš„ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="k">DELETE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">è¡¨å&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="err">æ¡ä»¶&lt;/span>&lt;span class="p">];&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦‚æœä¸å†™&lt;code>WHERE&lt;/code>çš„è¯&amp;hellip;&amp;hellip;æ‰¾ä¸ªå¥½ç‚¹çš„æ–°å·¥ä½œå§ï¼Œä¸è¦å†å»å†™&lt;code>SQL&lt;/code>äº†ï¼ŒORM å¤šå¥½ã€‚&lt;/p>
&lt;blockquote>
&lt;p>æ³¨æ„ï¼Œä¸å†™&lt;code>WHERE&lt;/code>å­å¥ä¼šåˆ é™¤è¿™ä¸ªè¡¨é‡Œçš„æ‰€æœ‰è¡Œã€‚&lt;/p>
&lt;/blockquote></description></item><item><title>MySQL 24å°æ—¶å…¥é—¨ç¬”è®° - 2</title><link>https://nnnewb.github.io/blog/p/mysql-24%E5%B0%8F%E6%97%B6%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0-2/</link><pubDate>Sat, 23 Jun 2018 15:41:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/mysql-24%E5%B0%8F%E6%97%B6%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0-2/</guid><description>&lt;h2 id="æŸ¥è¯¢">æŸ¥è¯¢&lt;/h2>
&lt;h3 id="select">SELECT&lt;/h3>
&lt;p>&lt;code>SELECT&lt;/code>æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å…³é”®å­—ï¼Œå®ƒçš„è¯­ä¹‰æ˜¯æŸ¥è¯¢ï¼Œå–å‡ºç»“æœã€‚&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>æ³¨æ„&lt;/strong>ï¼šä»…ä¸ºä¸ªäººç†è§£ã€‚&lt;/p>
&lt;/blockquote>
&lt;h3 id="from">FROM&lt;/h3>
&lt;p>&lt;code>FROM&lt;/code>å­å¥ï¼Œæ ‡è¯†è¦æŸ¥è¯¢çš„å¯¹è±¡çš„æ¥æºï¼Œæ¥æºå¯èƒ½æ˜¯å¤šä¸ªçš„ã€‚åœ¨æŸ¥è¯¢æœ‰å¤šä¸ªæ¥æºè¡¨çš„æƒ…å†µä¸‹ï¼Œç§°ä¹‹ä¸ºè”ç»“æŸ¥è¯¢ï¼ˆ&lt;code>Join query&lt;/code>ï¼‰ã€‚&lt;/p>
&lt;p>æœ€å¸¸è§çš„å¸¸è§„å†™æ³•æ˜¯&lt;code>SELECT column FROM table&lt;/code>ï¼Œè¡¨ç¤ºä»ç‰¹å®šè¡¨å–å‡ºæ‰€æœ‰è¡Œçš„ç‰¹å®šåˆ—ã€‚&lt;/p>
&lt;h3 id="where">WHERE&lt;/h3>
&lt;p>&lt;code>WHERE&lt;/code>å­å¥ç”¨äºè¿‡æ»¤æŸ¥è¯¢çš„è¡Œï¼Œåªæœ‰æ»¡è¶³æ¡ä»¶çš„è¡Œä¼šè¢«æŸ¥è¯¢å‡ºæ¥ã€‚&lt;/p>
&lt;p>å¸¸è§çš„ç”¨æ³•æœ‰&lt;code>SELECT column FROM table WHERE column &amp;lt;&amp;gt; 0&lt;/code>ï¼Œè¡¨ç¤ºåœ¨&lt;code>table&lt;/code>è¡¨ä¸­æŸ¥è¯¢&lt;code>column&lt;/code>éç©ºçš„è¡Œï¼Œè¿”å›è¿™äº›è¡Œçš„&lt;code>column&lt;/code>ã€‚&lt;/p>
&lt;p>å…¶ä¸­çš„äºŒå…ƒå…³ç³»è¿ç®—ç¬¦&lt;code>&amp;lt;&amp;gt;&lt;/code>è¡¨ç¤ºä¸ç­‰äºï¼Œå…¶ä»–å¸¸è§çš„å…³ç³»è¿ç®—ç¬¦è¿˜æœ‰è¿™äº›ã€‚&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>è¿ç®—ç¬¦&lt;/th>
&lt;th>å«ä¹‰&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;code>=&lt;/code>&lt;/td>
&lt;td>ç›¸ç­‰&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>&amp;gt;&lt;/code>&lt;/td>
&lt;td>å¤§äº&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>&amp;lt;&lt;/code>&lt;/td>
&lt;td>å°äº&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>&amp;gt;=&lt;/code>&lt;/td>
&lt;td>å¤§äºç­‰äº&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>&amp;lt;=&lt;/code>&lt;/td>
&lt;td>å°äºç­‰äº&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>!=&lt;/code>&lt;/td>
&lt;td>ä¸ç­‰äº&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>&amp;lt;&amp;gt;&lt;/code>&lt;/td>
&lt;td>ä¸ç­‰äº&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>æ­¤å¤–è¿˜æœ‰ä¸€äº›&lt;code>SQL&lt;/code>å…³é”®å­—å¯ä»¥è¾…åŠ©ç¼–å†™åˆ¤æ–­é€»è¾‘ã€‚&lt;/p>
&lt;p>&lt;code>SQL&lt;/code>å…³é”®å­—&lt;code>IN&lt;/code>å¯ä»¥ç”¨äºåˆ¤æ–­å…ƒç´ æ˜¯å¦åœ¨é›†åˆä¸­ã€‚ä¸¾ä¾‹ï¼Œ&lt;code>SELECT 1 IN (1,2,3)&lt;/code>ï¼ŒæŸ¥è¯¢&lt;code>1&lt;/code>æ˜¯å¦åœ¨&lt;code>1,2,3&lt;/code>è¿™ä¸ªé›†åˆä¸­ã€‚è¢«åˆ¤æ–­çš„é›†åˆéœ€è¦è¢«å°æ‹¬å·åŒ…å›´ï¼Œå¹¶ä¸”ä»¥é€—å·åˆ†éš”å…ƒç´ ã€‚&lt;/p>
&lt;p>&lt;code>SQL&lt;/code>å…³é”®å­—&lt;code>BETWEEN&lt;/code>å¯ä»¥åˆ¤æ–­å…ƒç´ æ˜¯å¦åœ¨ä¸€å®šåŒºé—´ä¸­ã€‚ä¸¾ä¾‹ï¼Œ&lt;code>SELECT 1 BETWEEN 0 and 10&lt;/code>ï¼ŒæŸ¥è¯¢&lt;code>1&lt;/code>æ˜¯å¦åœ¨&lt;code>0&lt;/code>åˆ°&lt;code>10&lt;/code>çš„åŒºé—´å†…ã€‚è¯­æ³•æ˜¯&lt;code>BETWEEN [low] AND [high]&lt;/code>ï¼ŒåŒºé—´è¾ƒå°çš„ä¸€ç«¯å¿…é¡»åœ¨å·¦ä¾§ï¼Œè¾ƒå¤§çš„ä¸€ç«¯å¿…é¡»åœ¨å³ä¾§ã€‚&lt;/p>
&lt;p>&lt;code>SQL&lt;/code>å…³é”®å­—&lt;code>LIKE&lt;/code>å¯ä»¥ç”¨éå¸¸ç®€å•çš„é€šé…ç¬¦æ¥åˆ¤æ–­å…ƒç´ æ˜¯å¦åŒ¹é…ä¸€å®šçš„è§„åˆ™ã€‚ä¸¾ä¾‹ï¼Œ&lt;code>SELECT 'abcabcabc' LIKE '%CAB%'&lt;/code>ï¼Œåˆ¤æ–­å­—ç¬¦ä¸²&lt;code>abcabcabc&lt;/code>æ˜¯å¦åŒ¹é…&lt;code>%CAB%&lt;/code>ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæ¨¡å¼ä¸²ä¸­çš„&lt;code>%&lt;/code>ä»£è¡¨çš„æ˜¯åŒ¹é… 0 æˆ–ä»»æ„å¤šä¸ªå­—ç¬¦ï¼Œå°±åƒæ˜¯æ­£åˆ™è¡¨è¾¾å¼ä¸­çš„&lt;code>*&lt;/code>ä¸€æ ·ã€‚æ­¤å¤–è¿˜æœ‰&lt;code>_&lt;/code>ï¼Œä¸‹åˆ’çº¿ï¼ŒåŒ¹é… 1 ä¸ªä»»æ„å­—ç¬¦ã€‚&lt;/p>
&lt;p>&lt;code>MySQL&lt;/code>æ‰©å±•çš„&lt;code>REGEXP&lt;/code>å¯ä»¥ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥åŒ¹é…å…ƒç´ æ˜¯å¦ç¬¦åˆæ¨¡å¼ä¸²ã€‚ä¸¾ä¾‹ï¼Œ&lt;code>SELECT 'abcabcabc' REGEXP '.*cab.*'&lt;/code>ï¼Œæ­£åˆ™è¡¨è¾¾å¼ä¸åšèµ˜è¿°ï¼Œç®€å•çš„æ¨¡å¼ä¸²å¤§å®¶éƒ½ä¼šå†™ã€‚&lt;/p>
&lt;h3 id="order-by">ORDER BY&lt;/h3>
&lt;p>&lt;code>ORDER BY&lt;/code>å°±åƒå­—é¢æ„ä¹‰ä¸Šè¯´çš„é‚£æ ·ï¼ŒæŒ‰ç…§æŸä¸ªåˆ—æ¥è¿›è¡Œæ’åºã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œæˆ‘æœ‰ä¸€ä¸ªå­¦ç”Ÿè¡¨ï¼Œè®°å½•äº†å­¦å·å’Œå§“åï¼Œæˆ‘å¯ä»¥æŒ‰ç…§å­¦å·æ’åºã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">students&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ORDER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">BY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>é»˜è®¤æ’åºæ˜¯å‡åºï¼Œä¹Ÿå¯ä»¥é€šè¿‡æŒ‡å®š&lt;code>DESC&lt;/code>æˆ–è€…&lt;code>ASC&lt;/code>æ¥å†³å®šæ€ä¹ˆæ’ã€‚&lt;code>ASC&lt;/code>æ˜¯å‡åºï¼Œ&lt;code>DESC&lt;/code>æ˜¯é™åºã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">students&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ORDER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">BY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DESC&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="as">AS&lt;/h3>
&lt;p>&lt;code>AS&lt;/code>å¸¸è§çš„ç”¨æ³•æ˜¯å»ºç«‹åˆ«åã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">column&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id_alias&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">my_table&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">table_alias&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">table_alias&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">column&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;lt;&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œå‡ºç°äº†ä¸€ä¸ªæ–°çš„è¯­æ³•ç»†èŠ‚ï¼Œ&lt;code>table_alias.column&lt;/code>ã€‚ç”¨ç‚¹&lt;code>.&lt;/code>è¿æ¥è¡¨åå’Œåˆ—åçš„è¡Œä¸ºç±»ä¼¼äº C++ä¸­çš„&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-C++" data-lang="C++">&lt;span class="k">typedef&lt;/span> &lt;span class="n">table_alias&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">my_table&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">id_alias&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">SELECT&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">table_alias&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">column&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">table_alias&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">column&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>çœ‹å¾—å‡ºæ¥ï¼Œ&lt;code>table_alias.column&lt;/code>æ˜¯å®Œå…¨é™å®šäº†&lt;code>column&lt;/code>æ˜¯å“ªä¸ª&lt;code>column&lt;/code>ï¼Œä¹‹æ‰€ä»¥æœ‰è¿™ç§è¯­æ³•ï¼Œæ˜¯å› ä¸º&lt;code>FROM&lt;/code>å­å¥éœ€è¦æ”¯æŒå¤šä¸ªè¡¨ä½œä¸ºæŸ¥è¯¢æ¥æºã€‚åˆ°æ—¶å€™å¯èƒ½å°±ä¼šç”¨åˆ°&lt;code>table1.column &amp;lt;&amp;gt; 1 AND table2.column &amp;lt;&amp;gt; 2&lt;/code>è¿™æ ·çš„å†™æ³•äº†ã€‚&lt;/p>
&lt;p>è€ŒæŸ¥è¯¢å¼€å¤´çš„&lt;code>column AS id_alias&lt;/code>åˆ™æ˜¯æ ‡è¯†æŸ¥è¯¢ç»“æœåˆ—å«åš&lt;code>id_alias&lt;/code>ï¼Œä¸¾ä¾‹å¦‚å­æŸ¥è¯¢çš„æƒ…å†µä¸‹ï¼Œä¾¿äºå¼•ç”¨ã€‚&lt;/p>
&lt;h3 id="join">JOIN&lt;/h3>
&lt;p>&lt;code>JOIN&lt;/code>çš„æœ¯è¯­å«åš&lt;strong>è”ç»“&lt;/strong>ï¼Œä½¿ç”¨äº†&lt;code>JOIN&lt;/code>å…³é”®å­—çš„æŸ¥è¯¢å«åš&lt;strong>è”ç»“æŸ¥è¯¢&lt;/strong>ã€‚&lt;/p>
&lt;p>è”ç»“æŸ¥è¯¢å’Œä¸€èˆ¬çš„æŸ¥è¯¢ä¸åŒçš„åœ°æ–¹æ˜¯ï¼Œè”ç»“æŸ¥è¯¢çš„æ•°æ®æ¥æºæ˜¯å¤šä¸ªè¡¨ã€‚&lt;/p>
&lt;p>æœ€ç®€å•çš„è”ç»“æŸ¥è¯¢æ˜¯å†…è”ç»“æŸ¥è¯¢ã€‚&lt;/p>
&lt;p>ä¸¾ä¾‹æ¥è¯´ï¼Œæˆ‘ç°åœ¨æœ‰è¡¨&lt;code>students&lt;/code>å¦‚ä¸‹ï¼Œæ‰€æœ‰å­¦ç”Ÿæ ¹æ®è¶…èƒ½åŠ›å¼€å‘ç­‰çº§åˆ†é…åˆ°å¤šä¸ªç­çº§ã€‚&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>id&lt;/th>
&lt;th>name&lt;/th>
&lt;th>class&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>stu1&lt;/td>
&lt;td>1&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>2&lt;/td>
&lt;td>stu2&lt;/td>
&lt;td>2&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>3&lt;/td>
&lt;td>stu3&lt;/td>
&lt;td>3&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>4&lt;/td>
&lt;td>stu4&lt;/td>
&lt;td>4&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>åˆæœ‰è¡¨&lt;code>top_class&lt;/code>ï¼Œæ”¶å½•äº†æ‰€æœ‰æ¥æ”¶é«˜ç­‰çº§è¶…èƒ½åŠ›è€…çš„ç­çº§ï¼Œèƒ½è¿›å…¥è¿™äº›ç­çº§çš„å­¦ç”Ÿéƒ½æ˜¯å¦‚åŒèƒ½è€ƒä¸Š&lt;code>985&lt;/code>ã€&lt;code>211&lt;/code>èˆ¬ææ€–å¦‚æ–¯çš„å­˜åœ¨ã€‚&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>id&lt;/th>
&lt;th>name&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>Lv 5&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>2&lt;/td>
&lt;td>Lv 4&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>3&lt;/td>
&lt;td>Lv 3&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>ç°åœ¨æˆ‘ä»¬è¦æŸ¥è¯¢å‡ºå­¦ç”Ÿä¸­é‚£äº›ææ€–å¦‚æ–¯çš„å­˜åœ¨æœ‰å“ªäº›ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">students&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">students&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INNER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">JOIN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">top_class&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ON&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">top_class&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">students&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">class&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¯­æ³•&lt;code>JOIN [è¡¨] ON [æ¡ä»¶]&lt;/code>ä¹Ÿå¾ˆç®€å•å•¦ã€‚åœ¨ä¾‹å­ä¸­ï¼Œ&lt;code>JOIN&lt;/code>è¡¨ç¤ºè¦è”ç»“è¡¨&lt;code>top_class&lt;/code>ï¼Œ&lt;code>ON&lt;/code>è¡¨ç¤ºæŸ¥è¯¢çš„å¯¹è±¡è¦ç¬¦åˆæ¡ä»¶&lt;code>top_class.id = students.class&lt;/code>ã€‚ä¸å¥½ç†è§£ï¼Ÿçœ‹çœ‹ä¼ªä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-C++" data-lang="C++">&lt;span class="k">for&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">auto&lt;/span> &lt;span class="nl">student&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">students&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// å…ˆè¿‡æ»¤ students è¡¨æœ¬èº«ï¼Œè¿™ä¸ªè¿‡æ»¤åº”è¯¥ç”± WHERE å­å¥å®Œæˆ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">auto&lt;/span> &lt;span class="nl">cls&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">top_class&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// ç„¶åè”ç»“è¡¨ top_class
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">student&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">cls&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">cls&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// åˆ¤æ–­ ON students.class = top_class.id
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">results&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">push&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">student&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// å¾—å‡ºç»“æœ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;p>æ³¨æ„ï¼Œä¼ªä»£ç çš„æŸ¥è¯¢è¿‡ç¨‹æ˜¯é”™è¯¯çš„ï¼Œä¸ºäº†æ–¹ä¾¿ç†è§£ students.class = top_class.id æ‰è¿™ä¹ˆå†™ã€‚çœŸå®æ•°æ®åº“å®ç°è”ç»“æŸ¥è¯¢çš„æ–¹æ³•åº”å½“æŸ¥é˜…å¯¹åº”&lt;code>DBMS&lt;/code>çš„æ–‡æ¡£ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>æ³¨æ„çš„å…³é”®ç‚¹æœ‰&lt;code>ON&lt;/code>å¾ˆåƒä½†ä¸åŒäº&lt;code>WHERE&lt;/code>ï¼Œåœ¨äº†è§£&lt;code>LEFT JOIN&lt;/code>å’Œ&lt;code>RIGHT JOIN&lt;/code>æ—¶ä¼šåŒºåˆ†ã€‚&lt;/p>
&lt;h3 id="left-join">LEFT JOIN&lt;/h3>
&lt;p>&lt;code>LEFT JOIN&lt;/code>åˆå«&lt;strong>å·¦è”ç»“&lt;/strong>ï¼ŒåŸºæœ¬æ€è·¯æ˜¯å†™åœ¨&lt;code>LEFT JOIN&lt;/code>å·¦è¾¹çš„è¡¨æ»¡è¶³æ¡ä»¶å³å¯ä½œä¸ºç»“æœï¼Œå³ä½¿å³è¾¹çš„è¡¨æ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„æ¡ç›®ã€‚&lt;/p>
&lt;p>è¿˜æ˜¯ä»¥ä¸Šæ–‡çš„å­¦å›­éƒ½å¸‚æ•°æ®åº“ä¸ºä¾‹ï¼ˆæˆ‘ tm å†™äº†ä»€ä¹ˆ&amp;hellip;ï¼‰&lt;/p>
&lt;p>å­¦ç”Ÿè¡¨ &lt;code>students&lt;/code>&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>id&lt;/th>
&lt;th>name&lt;/th>
&lt;th>class&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>stu1&lt;/td>
&lt;td>1&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>2&lt;/td>
&lt;td>stu2&lt;/td>
&lt;td>2&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>3&lt;/td>
&lt;td>stu3&lt;/td>
&lt;td>3&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>4&lt;/td>
&lt;td>stu4&lt;/td>
&lt;td>4&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>ç­çº§è¡¨ &lt;code>top_class&lt;/code>&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>id&lt;/th>
&lt;th>name&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>Lv 5&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>2&lt;/td>
&lt;td>Lv 4&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>3&lt;/td>
&lt;td>Lv 3&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>ç°åœ¨æˆ‘ä»¬æŸ¥è¯¢å­¦ç”Ÿéƒ½å¤„åœ¨å“ªäº›ç­çº§ï¼Œå¾—åˆ°ç­çº§çš„åå­—ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">students&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">as&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">top_class&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">as&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cls&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">students&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">LEFT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">JOIN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">top_class&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ON&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">top_class&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">students&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">class&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æŸ¥è¯¢ç»“æœåº”è¯¥æ˜¯è¿™æ ·å­çš„ã€‚&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>name&lt;/th>
&lt;th>cls&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>stu1&lt;/td>
&lt;td>Lv 5&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>stu2&lt;/td>
&lt;td>Lv 4&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>stu3&lt;/td>
&lt;td>Lv 3&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>stu4&lt;/td>
&lt;td>&lt;code>NULL&lt;/code>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>æ³¨æ„åˆ°äº†å—ï¼Ÿ&lt;code>stu4&lt;/code>è™½ç„¶ä¸æ˜¯&lt;code>top_class&lt;/code>çš„å­¦ç”Ÿï¼Œä½†æ˜¯è¿˜æ˜¯è¢«æŸ¥è¯¢å‡ºæ¥äº†ã€‚&lt;/p>
&lt;h3 id="right-join">RIGHT JOIN&lt;/h3>
&lt;p>ç»§ç»­æ‹¿å­¦å›­éƒ½å¸‚åšä¾‹å­&amp;hellip;&amp;hellip;&lt;/p>
&lt;p>å…¶å®æ˜¯å’Œå·¦è”ç»“ä¸€ä¸ªé¸Ÿæ ·ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">students&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">as&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">top_class&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">as&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cls&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">top_class&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">RIGHT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">JOIN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">students&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ON&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">top_class&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">students&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">class&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ‘ä»¬æ³¨æ„åˆ°&amp;hellip;&amp;hellip;æˆ‘å°±æ˜¯æŠŠ &lt;code>students&lt;/code>å’Œ &lt;code>top_class&lt;/code>æ¢äº†ä¸ªä½ç½®ã€‚æŸ¥è¯¢ç»“æœå…¶å®æ˜¯ä¸€æ ·çš„ã€‚&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>name&lt;/th>
&lt;th>cls&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>stu1&lt;/td>
&lt;td>Lv 5&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>stu2&lt;/td>
&lt;td>Lv 4&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>stu3&lt;/td>
&lt;td>Lv 3&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>stu4&lt;/td>
&lt;td>&lt;code>NULL&lt;/code>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="cross-join">CROSS JOIN&lt;/h3>
&lt;p>äº¤å‰è”ç»“ï¼ŒæŸ¥è¯¢ç»“æœæ˜¯è”ç»“çš„è¡¨å’Œ&lt;code>FROM&lt;/code>çš„è¡¨çš„ç¬›å¡å°”ç§¯ï¼Œè¿™ä¹ˆè¯´å¬çš„æ˜ç™½ä¸ï¼Ÿå¬ä¸æ˜ç™½å°±ç®—äº†ï¼Œå› ä¸ºäº¤å‰è”ç»“åŸºæœ¬ç”¨ä¸åˆ°ã€‚&lt;/p>
&lt;p>å…¶å®å°±æ˜¯æŠŠä¸¤ä¸ªè¡¨çš„æ¯ä¸ªè¡Œéƒ½æ’åˆ—ç»„åˆä¸€ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>è¡¨ A è¡Œ 1-è¡¨ B è¡Œ 1&lt;/li>
&lt;li>è¡¨ A è¡Œ 1-è¡¨ B è¡Œ 2&lt;/li>
&lt;li>&amp;hellip;&amp;hellip;&lt;/li>
&lt;li>è¡¨ A è¡Œ 10-è¡¨ B è¡Œ 1&lt;/li>
&lt;li>è¡¨ A è¡Œ 10-è¡¨ B è¡Œ 2&lt;/li>
&lt;li>è¡¨ A è¡Œ 10-è¡¨ B è¡Œ 3&lt;/li>
&lt;li>&amp;hellip;&amp;hellip;&lt;/li>
&lt;/ul>
&lt;h3 id="join-è‡ªå·±">JOIN è‡ªå·±ï¼Ÿ&lt;/h3>
&lt;p>æœ¯è¯­å«è‡ªè”ç»“ï¼Œå…¶å®ä¹ŸæŒºå¥½ç†è§£çš„ï¼Œç›´æ¥ä¸¾ä¸ªä¾‹å­çœ‹çœ‹ã€‚&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>id&lt;/th>
&lt;th>name&lt;/th>
&lt;th>class&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>stu1&lt;/td>
&lt;td>1&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>2&lt;/td>
&lt;td>stu2&lt;/td>
&lt;td>1&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>3&lt;/td>
&lt;td>stu3&lt;/td>
&lt;td>2&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>4&lt;/td>
&lt;td>stu4&lt;/td>
&lt;td>2&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;blockquote>
&lt;p>æ³¨æ„æˆ‘æ•°æ®æ”¹äº†å“ˆã€‚&lt;/p>
&lt;/blockquote>
&lt;p>ç°åœ¨è¦æŸ¥è¯¢å‡ºæ‰€æœ‰å’Œ&lt;code>stu1&lt;/code>åŒä¸€ä¸ªç­çº§çš„å­¦ç”Ÿã€‚&lt;/p>
&lt;p>ä¸€èˆ¬æˆ‘ä»¬æƒ³æ€ä¹ˆæŸ¥ï¼Ÿå…ˆæŸ¥å‡º&lt;code>stu1&lt;/code>æ˜¯å“ªä¸ªç­çº§çš„ï¼š&lt;code>SELECT class FROM students WHERE name = 'stu1'&lt;/code>ï¼Œç„¶åæŸ¥å‡ºæ‰€æœ‰å±äºè¿™ä¸ªç­çº§çš„å­¦ç”Ÿï¼š&lt;code>SELECT name FROM students WHERE class = [ä¸Šæ¬¡æŸ¥å‡ºæ¥çš„ç­çº§]&lt;/code>ã€‚&lt;/p>
&lt;p>é‚£ä¹ˆ&amp;hellip;æ€ä¹ˆå†™æˆä¸€å¥è¯å‘¢ï¼Ÿ&lt;/p>
&lt;p>è¿™æ—¶å€™è‡ªè”ç»“å°±å¯ä»¥ä¸Šåœºäº†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">s1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">s1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">s1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">class&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">students&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">s1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INNER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">JOIN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">students&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">s2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">s1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">class&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">s2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">class&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AND&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">s2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;stu1&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æŸ¥è¯¢ç»“æœæ˜¯&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>id&lt;/th>
&lt;th>name&lt;/th>
&lt;th>class&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>stu1&lt;/td>
&lt;td>1&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>2&lt;/td>
&lt;td>stu2&lt;/td>
&lt;td>1&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>åŸºæœ¬æ€è·¯æ˜¯è¿™æ ·çš„ï¼š&lt;code>FROM&lt;/code>çš„è¡¨æ˜¯&lt;code>s1&lt;/code>ï¼Œå› æ­¤&lt;code>INNER JOIN&lt;/code>æŸ¥è¯¢ç»“æœæ¥è‡ª&lt;code>s1&lt;/code>è€Œä¸æ˜¯&lt;code>s2&lt;/code>ã€‚æŸ¥æ‰¾&lt;code>s1&lt;/code>è¡¨ä¸­æ¯ä¸ªè¡Œçš„&lt;code>class&lt;/code>åœ¨&lt;code>s2&lt;/code>è¡¨é‡Œæœ‰æ²¡æœ‰è¡Œå…·æœ‰åŒæ ·çš„&lt;code>class&lt;/code>å±æ€§ï¼ŒåŒæ—¶ï¼Œ&lt;code>s2&lt;/code>å…·æœ‰å’Œ&lt;code>s1&lt;/code>åŒæ ·&lt;code>class&lt;/code>å±æ€§çš„è¡Œè¿˜å¿…é¡»æœ‰ä¸ª&lt;code>stu1&lt;/code>çš„&lt;code>name&lt;/code>ã€‚&lt;/p>
&lt;p>åˆ†æå¾—çŸ¥ï¼Œ&lt;code>s2&lt;/code>ä¸­æœ‰&lt;code>stu1&lt;/code>è¿™ä¸ª&lt;code>name&lt;/code>çš„è¡Œåªæœ‰&lt;code>1&lt;/code>ï¼Œæ‰€ä»¥&lt;code>s2&lt;/code>è¡¨å…¶å®é•¿è¿™æ ·ã€‚&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>id&lt;/th>
&lt;th>name&lt;/th>
&lt;th>class&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>stu1&lt;/td>
&lt;td>1&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>è¿™æ—¶å€™å†å»çœ‹&lt;code>s1&lt;/code>è¡¨ï¼Œ&lt;code>s1&lt;/code>è¡¨çš„&lt;code>class&lt;/code>åŒæ—¶å­˜åœ¨äº&lt;code>s2&lt;/code>è¡¨çš„è¡Œåªæœ‰&lt;code>1&lt;/code>å’Œ&lt;code>2&lt;/code>äº†ã€‚&lt;/p>
&lt;h3 id="outer-join">OUTER JOIN&lt;/h3>
&lt;p>å…¶å®&lt;code>OUTER JOIN&lt;/code>ä¸Šé¢çš„&lt;code>LEFT JOIN&lt;/code>å’Œ&lt;code>RIGHT JOIN&lt;/code>å·²ç»è®²è¿‡äº†ï¼Œ&lt;code>LEFT JOIN&lt;/code>çš„å®Œæ•´å†™æ³•å°±æ˜¯&lt;code>LEFT OUTER JOIN&lt;/code>ï¼Œ&lt;code>RIGHT JOIN&lt;/code>å°±æ˜¯&lt;code>RIGHT OUTER JOIN&lt;/code>ï¼Œå’Œ&lt;code>INNER JOIN&lt;/code>çš„åŒºåˆ«åœ¨äº&lt;code>OUTER JOIN&lt;/code>åŒ…å«äº†æŒ‡å®šè¡¨é‡Œä¸æ»¡è¶³&lt;code>ON&lt;/code>æ¡ä»¶çš„è¡Œã€‚&lt;/p>
&lt;p>è¿™æœ‰ä¸ªçŸ¥è¯†ç‚¹ï¼Œå°±æ˜¯&lt;code>ON&lt;/code>æ¡ä»¶ä¸è¿‡æ»¤æŒ‡å®š&lt;code>OUTER JOIN&lt;/code>çš„è¡¨çš„ä¸æ»¡è¶³æ¡ä»¶çš„è¡Œï¼Œä½†æ˜¯&lt;code>WHERE&lt;/code>ä¼šè¿‡æ»¤ã€‚&lt;/p>
&lt;h3 id="union">UNION&lt;/h3>
&lt;p>&lt;code>UNION&lt;/code>å…³é”®å­—çš„æœ¯è¯­æ˜¯&lt;strong>è”åˆæŸ¥è¯¢&lt;/strong>ã€‚&lt;/p>
&lt;p>ä½œç”¨æ˜¯å°†å¤šä¸ª&lt;code>SELECT&lt;/code>çš„ç»“æœæ”¾åœ¨ä¸€èµ·å¹¶è¿”å›ã€‚&lt;/p>
&lt;p>ä¸¾ä¸ªä¾‹å­&amp;hellip;&amp;hellip;æˆ‘ä»¬è¦æŸ¥è¯¢å…¨ç¾æœ€å¥½çš„å¤§å­¦&lt;code>american_top_college&lt;/code>å’Œä¸­å›½æœ€å¥½çš„å¤§å­¦&lt;code>chinese_top_college&lt;/code>æ•°æ®ï¼Œæ¥å†³å®šæŠ¥è€ƒå“ªä¸ªå¤§å­¦ï¼ˆåæ­£éƒ½è€ƒä¸ä¸Šï¼‰ï¼Œå¦‚æœä¸æƒ³å†™æˆä¸¤å¥&lt;code>SELECT&lt;/code>ï¼Œç„¶åæ‰‹å·¥åˆå¹¶æˆä¸€ä¸ªè¡¨æ ¼çš„è¯ï¼Œé‚£ä¹ˆå°±ç”¨&lt;code>UNION&lt;/code>æŸ¥è¯¢å§ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;american&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">nation&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">american_top_college&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">college_name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">american_top_college&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">score_line&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">score_line&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">american_top_college&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">UNION&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;china&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">nation&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">chinese_top_college&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">college_name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">chinese_top_college&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">score_line&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">score_line&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æŸ¥è¯¢ç»“æœ&amp;hellip;ä¸å±•ç¤ºäº†ã€‚&lt;/p>
&lt;p>è¿˜æœ‰ä¸ªç»†èŠ‚å¯èƒ½è¦æ³¨æ„ï¼Œå¦‚æœæœ‰å¤§å­¦åŒæ—¶æ˜¯ç¾å›½å¤§å­¦å’Œä¸­å›½å¤§å­¦çš„è¯ï¼Œé‚£ä¹ˆä¸ºäº†åœ¨è”åˆæŸ¥è¯¢ä¸­æ’é™¤ç›¸åŒçš„é¡¹ç›®ï¼Œå¯ä»¥ä½¿ç”¨&lt;code>UNION ALL&lt;/code>è€Œä¸æ˜¯&lt;code>UNION&lt;/code>ã€‚&lt;/p>
&lt;h3 id="fulltext">FULLTEXT&lt;/h3>
&lt;p>&lt;code>MySQL&lt;/code>æ”¯æŒä¸€ç§å®ç”¨çš„æ–‡æœ¬ç´¢å¼•æ–¹å¼ï¼Œå«åš&lt;strong>å…¨æ–‡æœ¬æœç´¢&lt;/strong>ã€‚å¤§å®¶éƒ½çŸ¥é“ï¼Œæ­£åˆ™è¡¨è¾¾å¼å’Œç®€å•é€šé…ç¬¦æ¥æŸ¥æ‰¾æ–‡æœ¬æ˜¯éå¸¸æ¶ˆè€—æ€§èƒ½çš„æ“ä½œï¼Œè€Œä¸”éš¾ä»¥ä¼˜åŒ–ï¼ˆåæ­£æˆ‘æƒ³ä¸å‡ºä»»ä½•å‡å°‘æŸ¥è¯¢çš„ä¼˜åŒ–æ€è·¯ï¼‰ã€‚&lt;code>MySQL&lt;/code>æä¾›äº†å…¨æ–‡æœ¬æœç´¢çš„å±æ€§æ¥å¸®åŠ©ç´¢å¼•æ–‡æœ¬ï¼ˆä½†æ˜¯æƒ³åˆ°ä¸­æ–‡æ”¯æŒæˆ‘è§‰å¾—å·²ç»å‡‰çš„å·®ä¸å¤šäº†ï¼‰ï¼Œå¿«é€ŸæŸ¥è¯¢å‡ºåŒ…å«ç‰¹å®šè¯æ±‡ä¹‹ç±»çš„è¡Œã€‚&lt;/p>
&lt;blockquote>
&lt;p>æŠ±æ­‰æˆ‘è§‰å¾—ä¸è¡Œã€‚ä¸è¯´åˆ«çš„ï¼Œä¸­æ–‡åˆ†è¯å°±&amp;hellip;&amp;hellip;&lt;/p>
&lt;/blockquote>
&lt;p>è·³è¿‡äº†è·³è¿‡äº†ã€‚&lt;/p></description></item><item><title>MySQL 24å°æ—¶å…¥é—¨ç¬”è®° - 1</title><link>https://nnnewb.github.io/blog/p/mysql-24%E5%B0%8F%E6%97%B6%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0-1/</link><pubDate>Sat, 23 Jun 2018 02:24:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/mysql-24%E5%B0%8F%E6%97%B6%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0-1/</guid><description>&lt;h2 id="1-æ•°æ®åº“æ¦‚å¿µ">1. æ•°æ®åº“æ¦‚å¿µ&lt;/h2>
&lt;h3 id="11-æ•°æ®å’Œå‚¨å­˜">1.1 æ•°æ®å’Œå‚¨å­˜&lt;/h3>
&lt;p>æ•°æ®åº“æœ¬è´¨ä¸Šåšçš„å·¥ä½œæ˜¯å‚¨å­˜å’ŒæŸ¥è¯¢æ•°æ®ã€‚ç†è®ºä¸Šè€Œè¨€ï¼Œ&lt;code>MySQL&lt;/code>åº”è¯¥å«åš&lt;code>DBMS&lt;/code>ï¼Œä¹Ÿå°±æ˜¯&lt;strong>æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ&lt;/strong>ï¼Œè€Œä¸æ˜¯&lt;strong>æ•°æ®åº“&lt;/strong>ã€‚&lt;/p>
&lt;p>&lt;code>DBMS&lt;/code>æä¾›äº†ç»Ÿä¸€çš„å»ºç«‹ã€ä½¿ç”¨ã€ç®¡ç†æ•°æ®åº“çš„æ¥å£ï¼Œå¸¸è§çš„&lt;code>DBMS&lt;/code>æœ‰&lt;code>postgreSQL&lt;/code>ã€&lt;code>MariaDB&lt;/code>ã€&lt;code>SQL Server&lt;/code>ç­‰ã€‚&lt;/p>
&lt;h3 id="12-æ•°æ®åº“å’Œschema">1.2 æ•°æ®åº“å’Œ&lt;code>Schema&lt;/code>&lt;/h3>
&lt;p>é€šå¸¸æ¥è¯´ï¼Œä¸€ä¸ª&lt;code>DBMS&lt;/code>ä¼šæ”¯æŒå¤šä¸ªæ•°æ®åº“å…±å­˜ã€‚è¿™é‡Œæ‰€è¯´çš„&lt;em>æ•°æ®åº“&lt;/em>æŒ‡çš„æ˜¯ç‰¹å®šæ•°æ®åº“ç®¡ç†ç³»ç»Ÿç®¡ç†ä¸‹çš„&lt;em>æ•°æ®åº“&lt;/em>ï¼Œè€Œä¸æ˜¯ä¸Šä¸€èŠ‚è¯´çš„&lt;code>DBMS&lt;/code>ã€‚&lt;/p>
&lt;p>è€Œ&lt;code>Schema&lt;/code>çš„ä¸­è¯‘æœ¯è¯­ä¸€èˆ¬å«&lt;strong>æ¨¡å¼&lt;/strong>ï¼Œ&lt;code>Schema&lt;/code>æè¿°äº†æ•°æ®åº“çš„ç»“æ„ï¼Œæ¯”å¦‚è¯´æœ‰å“ªäº›è¡¨ï¼Œè¡¨æœ‰å“ªäº›å­—æ®µï¼Œå­—æ®µåˆ†åˆ«æœ‰å“ªäº›é™åˆ¶ï¼Œæœ‰å“ªäº›å£°æ˜äº†çš„å‡½æ•°ï¼Œç­‰ç­‰ã€‚&lt;/p>
&lt;p>é€šå¸¸çš„&lt;code>DBMS&lt;/code>å¾€å¾€æ˜¯è¿™æ ·çš„ç»“æ„ï¼šä½äº&lt;code>DBMS&lt;/code>ç®¡ç†æœ€é¡¶å±‚çš„æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªæ•°æ®åº“ï¼Œæ•°æ®åº“é‡Œå­˜æ”¾è¡¨ï¼Œè¡¨é‡Œä»¥è¡Œä¸ºå•ä½å­˜æ”¾æ•°æ®ã€‚&lt;/p>
&lt;h3 id="13-è¡¨åˆ—é”®è¡Œ">1.3 è¡¨ã€åˆ—ã€é”®ã€è¡Œ&lt;/h3>
&lt;h4 id="131-è¡¨">1.3.1 è¡¨&lt;/h4>
&lt;p>è¡¨çš„è‹±è¯­æœ¯è¯­æ˜¯&lt;code>Table&lt;/code>ã€‚&lt;/p>
&lt;p>ç”¨è¿‡ Excl å—ï¼Ÿ&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>id&lt;/th>
&lt;th>name&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>Mike&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>2&lt;/td>
&lt;td>John&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>ç›´è§‚çš„è¡¨å°±æ˜¯ä¸€ä¸ªäºŒç»´çš„â€œè¡¨â€ï¼Œæœ‰è¡Œï¼Œæœ‰åˆ—ã€‚&lt;/p>
&lt;h4 id="132-åˆ—">1.3.2 åˆ—&lt;/h4>
&lt;p>åˆ—çš„æœ¯è¯­æ˜¯ &lt;code>Column&lt;/code>ã€‚&lt;/p>
&lt;p>æ¯ä¸ªåˆ—éƒ½åº”è¯¥æœ‰ä¸€ä¸ªç‰¹å®šçš„ç±»å‹ï¼ˆ&lt;code>type&lt;/code>ï¼‰ï¼Œä½¿è¯¥åˆ—ä»…ä»…å‚¨å­˜æŒ‡å®šç±»å‹çš„æ•°æ®ã€‚&lt;/p>
&lt;h4 id="133-é”®æˆ–è€…å«ç ">1.3.3 é”®&amp;hellip;&amp;hellip;æˆ–è€…å«ç &lt;/h4>
&lt;p>é”®çš„æœ¯è¯­æ˜¯ &lt;code>Key&lt;/code>ã€‚&lt;/p>
&lt;p>é€šå¸¸æŒ‡çš„æ˜¯&lt;code>Primary Key&lt;/code>ï¼Œä¹Ÿå°±æ˜¯ä¸»é”®ã€‚ä¸»é”®å¯ä»¥æ˜¯ä»»æ„ä¸€ä¸ªåˆ—ã€‚ä½†æ˜¯å¦‚æœåˆ—æ˜¯ä¸»é”®ï¼Œé‚£ä¹ˆè¿™ä¸ªåˆ—å¿…é¡»æ¯ä¸ªè¡Œéƒ½ä¿è¯ä¸å’Œå…¶ä»–è¡Œé‡å¤ã€‚&lt;/p>
&lt;p>ä¸»é”®ä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªåˆ—ï¼Œå¦‚æœæ˜¯å¤šä¸ªåˆ—ï¼Œé‚£ä¹ˆå¿…é¡»ä¿è¯è¿™äº›åˆ—çš„ç»„åˆä¸é‡å¤ã€‚&lt;/p>
&lt;p>ä¸¾ä¾‹æ¥è¯´&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>db&lt;/th>
&lt;th>table&lt;/th>
&lt;th>id&lt;/th>
&lt;th>name&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>aa&lt;/td>
&lt;td>aaaaa&lt;/td>
&lt;td>11&lt;/td>
&lt;td>xxxx&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>aa&lt;/td>
&lt;td>bbbbb&lt;/td>
&lt;td>11&lt;/td>
&lt;td>xxxx&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>å…¶ä¸­&lt;code>db&lt;/code>å’Œ&lt;code>table&lt;/code>è¿˜æœ‰&lt;code>id&lt;/code>éƒ½æ˜¯ä¸»é”®ï¼Œåªè¦ä¿è¯æ²¡æœ‰ä¸¤ä¸ªè¡ŒåŒæ—¶å­˜åœ¨ç›¸åŒçš„&lt;code>db&lt;/code>/&lt;code>table&lt;/code>/&lt;code>id&lt;/code>å°±ç®—æ˜¯æ»¡è¶³äº†ä¸»é”®çº¦æŸã€‚&lt;/p>
&lt;blockquote>
&lt;p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¤šä¸»é”®çš„å¯ç§»æ¤æ€§å­˜ç–‘ï¼Œä¸ä¸€å®šå…¶ä»–çš„&lt;code>DBMS&lt;/code>ä¼šæ”¯æŒã€‚&lt;/p>
&lt;/blockquote>
&lt;h4 id="134-è¡Œ">1.3.4 è¡Œ&lt;/h4>
&lt;p>è¡Œçš„æœ¯è¯­æ˜¯ &lt;code>Row&lt;/code>ã€‚&lt;/p>
&lt;p>æ¯ä¸ªè¡Œéƒ½æ˜¯ä¸€æ¡è®°å½•ï¼ˆ&lt;code>record&lt;/code>ï¼‰ï¼Œæ¢åšå¯¹è±¡çš„æ¦‚å¿µçš„è¯ï¼Œä¹Ÿå¯ä»¥è¯´ï¼Œæ¯ä¸ªè¡¨éƒ½å‚¨å­˜äº†ä¸€ä¸ªå…¶ç‰¹æœ‰çš„çš„&lt;code>Row&lt;/code>å¯¹è±¡çš„é›†åˆï¼Œ&lt;code>Column&lt;/code>ä¸€ä¸€å¯¹åº”&lt;code>Row&lt;/code>å¯¹è±¡çš„å±æ€§ã€‚&lt;/p>
&lt;p>æ¯”å¦‚ä¸Šæ–‡çš„&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>id&lt;/th>
&lt;th>name&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>Mike&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>2&lt;/td>
&lt;td>John&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>å¯¹è±¡æ¦‚å¿µè¡¨è¾¾å°±æ˜¯&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-C++" data-lang="C++">&lt;span class="k">class&lt;/span> &lt;span class="nc">row&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">id&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">string&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">};&lt;/span>
&lt;span class="k">const&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">set&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">row&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">table&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="14-sql-æ˜¯ä»€ä¹ˆ">1.4 SQL æ˜¯ä»€ä¹ˆ&lt;/h2>
&lt;p>&lt;code>SQL&lt;/code>çš„ç›´è¯‘æ˜¯&lt;strong>ç»“æ„åŒ–æŸ¥è¯¢è¯­è¨€&lt;/strong>ï¼Œå…¶å®å°±æ˜¯æ ‡å‡†åŒ–çš„æ•°æ®åº“æŸ¥è¯¢è¯­è¨€ï¼ŒåŸºæœ¬æ¯ä¸ª&lt;code>DBMS&lt;/code>éƒ½æ”¯æŒã€‚&lt;/p>
&lt;p>ä½†æ˜¯&amp;hellip;&amp;hellip;æ•°æ®åº“ç®¡ç†ç³»ç»Ÿå¯¹&lt;code>SQL&lt;/code>æ ‡å‡†çš„æ”¯æŒå¹¶ä¸æ˜¯é‚£ä¹ˆä¸Šå¿ƒã€‚å…¶ä¸­æœ‰æ€§èƒ½ä¼˜åŒ–ã€å¹³å°ä¼˜åŒ–ä¹‹ç±»çš„åŸå› ï¼Œä¹Ÿæœ‰æ•°æ®åº“è½¯ä»¶å¼€å‘å•†è‡ªèº«çš„è€ƒè™‘ã€‚ä½†æ€»è€Œè¨€ä¹‹ï¼Œä¸è¦å¤ªæœŸå¾…åŒæ ·çš„&lt;code>SQL&lt;/code>èƒ½åœ¨ä»»æ„&lt;code>DBMS&lt;/code>é‡Œéƒ½ä¸€æ ·è·‘å¾—æ¬¢ã€‚&lt;/p></description></item><item><title>é²¸é±¼æ¸¸æˆé¢è¯•ç¬”è®°</title><link>https://nnnewb.github.io/blog/p/%E9%B2%B8%E9%B1%BC%E6%B8%B8%E6%88%8F%E9%9D%A2%E8%AF%95%E7%AC%94%E8%AE%B0/</link><pubDate>Wed, 20 Jun 2018 19:15:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/%E9%B2%B8%E9%B1%BC%E6%B8%B8%E6%88%8F%E9%9D%A2%E8%AF%95%E7%AC%94%E8%AE%B0/</guid><description>&lt;h2 id="intro">Intro&lt;/h2>
&lt;p>ç®€å•ä»‹ç»ä¸‹é¢è¯•çš„å‰ç½®æƒ…å†µã€‚&lt;/p>
&lt;p>é¢è¯•çš„å…¬å¸æ˜¯é²¸é±¼æ¸¸æˆï¼ŒèŒä½æ˜¯åç«¯å¼€å‘å·¥ç¨‹å¸ˆï¼Œå¼€å‘è¯­è¨€ C++ã€‚&lt;/p>
&lt;p>è¿™ç¯‡åšæ–‡ä¸»è¦æ˜¯ä¸ºäº†è®°å½•é¢è¯•ä¸­å‘ç°çš„è‡ªèº«ä¸è¶³ã€‚&lt;/p>
&lt;p>è¿™æ¬¡é¢è¯•é‡Œï¼Œå› ä¸ºé¢è¯•çº¦å¾—æ¯”è¾ƒåŒ†å¿™ï¼Œæ‰€ä»¥åŸºæœ¬æ²¡åšä»»ä½•å‡†å¤‡ã€‚è®²é“ç†çš„è¯´æˆ‘æ˜¯æœ‰ç‚¹ç›²ç›®è‡ªä¿¡äº†ï¼Œæ¯•ç«Ÿ C/C++æ˜¯æˆ‘çš„ç¬¬ä¸€è¯­è¨€æ¥ç€ï¼Œæœ¬æ¥ä»¥ä¸ºè€ƒå¯Ÿè¯­è¨€çš„éƒ¨åˆ†ä¸ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ²¡æƒ³åˆ°å› ä¸ºç´§å¼ è€Œé”™æ¼ç™¾å‡ºã€‚&lt;/p>
&lt;p>é‚£ä¹ˆæ¥ä¸‹æ¥å°±ç›´æ¥è¿›å…¥æ­£é¢˜ï¼Œä»¥ä¸‹æ˜¯å¯¹é¢è¯•ä¸­é‡åˆ°çš„é—®é¢˜é‡æ–°æ€è€ƒåçš„å›ç­”å’Œæƒ³æ³•ã€‚&lt;/p>
&lt;blockquote>
&lt;p>ä¸‹é¢é¢è¯•å®˜çš„æé—®å¹¶éåŸè¯ï¼Œæœ‰ç»è¿‡è„‘è¡¥æ¶¦è‰²ã€‚&lt;/p>
&lt;/blockquote>
&lt;h2 id="èµ·æ‰‹å¼é¢å‘å¯¹è±¡">èµ·æ‰‹å¼ï¼šé¢å‘å¯¹è±¡&lt;/h2>
&lt;blockquote>
&lt;p>é¢è¯•å®˜ï¼šè®²è®²é¢å‘å¯¹è±¡ï¼Œç»§æ‰¿ï¼Œè¿˜æœ‰å¤šæ€ã€‚æˆ‘ä»¬éƒ½çŸ¥é“ç¨‹åºè®¾è®¡æœ‰ä¸¤ç§å¸¸è§çš„èŒƒå¼ï¼Œé¢å‘è¿‡ç¨‹å’Œé¢å‘å¯¹è±¡ï¼Œè®²è®²é¢å‘å¯¹è±¡ç»™æˆ‘ä»¬å¸¦æ¥äº†ä»€ä¹ˆå¥½å¤„ï¼Ÿ&lt;/p>
&lt;/blockquote>
&lt;p>å®è¯è¯´ç¬¬ä¸€é—®å°±å·²ç»æœ‰ç‚¹å‡ºä¹æ„æ–™ï¼Œä½†æƒ³æƒ³å…¶å®è¿˜æ˜¯åœ¨æ„æ–™ä¹‹ä¸­ã€‚åˆçº§èŒä½æ›´æ³¨é‡äºåŸºç¡€æ¦‚å¿µå’ŒæŠ€èƒ½ï¼Œä¸­é«˜çº§èŒä½å¯èƒ½ä¼šåœ¨æ•°æ®ç»“æ„å’Œå¹¶å‘ä¸€ç±»çš„é—®é¢˜ä¸Šæ›´æ·±å…¥ã€‚&lt;/p>
&lt;blockquote>
&lt;p>ç­”ï¼šæŠ½è±¡ï¼Œå½’ç±» blabla&amp;hellip;æ˜“äºç»´æŠ¤ blabla&amp;hellip;&lt;/p>
&lt;/blockquote>
&lt;p>&lt;strong>å…¨é”™ã€‚&lt;/strong>&lt;/p>
&lt;p>ç°åœ¨å›å¿†èµ·æ¥ï¼Œé¢è¯•å®˜æƒ³é—®çš„å…¶å®åªæœ‰ä¸€ç‚¹ï¼Œå°±æ˜¯é‚£å¥&lt;strong>å°è£…&lt;/strong>ã€‚&lt;/p>
&lt;p>&lt;strong>å°è£…&lt;/strong>æ˜¯é¢å‘å¯¹è±¡çš„&lt;strong>æ ¸å¿ƒæ¦‚å¿µä¹‹ä¸€&lt;/strong>ã€‚&lt;/p>
&lt;p>å°è£…ä½¿ä»£ç æˆä¸ºä¸€ä¸ª&lt;strong>é»‘ç®±&lt;/strong>ï¼Œè®©æˆ‘ä»¬ä¸å¿…å…³æ³¨å®ƒçš„å®ç°ï¼Œè€Œæ˜¯å…³æ³¨å®ƒçš„&lt;strong>è¡Œä¸º&lt;/strong>å’Œ&lt;strong>æ¥å£&lt;/strong>ã€‚&lt;/p>
&lt;p>è¿™äº§ç”Ÿäº†&lt;strong>é¢å‘æ¥å£ç¼–ç¨‹&lt;/strong>çš„æ¦‚å¿µï¼Œæˆ‘ä»¬ä¸å†å…³æ³¨å°è£…åçš„å¯¹è±¡å†…éƒ¨çš„é€»è¾‘ï¼Œæˆ‘ä»¬ç»™å°è£…åçš„å¯¹è±¡ä»¥è¾“å…¥ï¼Œç„¶åä»å°è£…åçš„å¯¹è±¡é‡Œå–å‡ºæ•°æ®ã€‚&lt;/p>
&lt;p>&lt;strong>å°è£…&lt;/strong>å¹¶ä¸åªæ˜¯ä¸€ç³»åˆ—æ¥å£çš„é›†åˆï¼Œæ›´åŒ…å«äº†&lt;strong>æ•°æ®&lt;/strong>å’Œ&lt;strong>çŠ¶æ€&lt;/strong>ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªå¾®å‹åŒ–çš„æœåŠ¡ï¼Œè°ƒç”¨è€…å‘Šè¯‰å®ƒå»åšä»€ä¹ˆäº‹ï¼Œè€Œä¸å…³å¿ƒå®ƒæ€ä¹ˆåšã€‚&lt;/p>
&lt;h2 id="ç¬¬äºŒæ‹›ç»§æ‰¿">ç¬¬äºŒæ‹›ï¼šç»§æ‰¿&lt;/h2>
&lt;blockquote>
&lt;p>é¢è¯•å®˜ï¼šè®²è®²ç»§æ‰¿ã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>æˆ‘ï¼šä»£ç å¤ç”¨ï¼Œblabla&amp;hellip;&amp;hellip;&lt;/p>
&lt;/blockquote>
&lt;p>&lt;strong>ä»£ç å¤ç”¨ï¼Œè¿™æ˜¯æ ¸å¿ƒã€‚&lt;/strong>&lt;/p>
&lt;p>ä»£ç å¤ç”¨æ˜¯ç»§æ‰¿æœ€ä¸»è¦çš„ä½œç”¨ï¼Œå¤§å®¶éƒ½çŸ¥é“ã€‚é¢è¯•å®˜å¹¶æ²¡æœ‰åœ¨è¿™æ–¹é¢ç»§ç»­æ·±å…¥ï¼Œæ‰€ä»¥èƒ½ç­”å‡ºä»£ç å¤ç”¨å…¶å®å·²ç»å·®ä¸å¤šäº†ã€‚&lt;/p>
&lt;p>é™¤éå†æŠ ä¸Šè¯­è¨€ç›¸å…³çš„è¯­æ³•ç»†èŠ‚ï¼š&lt;strong>å¤šç»§æ‰¿&lt;/strong>å’Œ&lt;strong>å•ç»§æ‰¿&lt;/strong>ã€‚&lt;/p>
&lt;h3 id="å¤šç»§æ‰¿">å¤šç»§æ‰¿&lt;/h3>
&lt;p>C++ é‡‡ç”¨äº†å¤šç»§æ‰¿æ¨¡å‹ï¼Œå³ä¸€ä¸ªå­ç±»å¯ä»¥æœ‰å¤šä¸ªçˆ¶ç±»ã€‚&lt;/p>
&lt;pre>&lt;code>Father ------|
|====&amp;gt; child
Mother ------|
&lt;/code>&lt;/pre>&lt;p>å¤šç»§æ‰¿å¯ä»¥å…è®¸ä¸€äº›ç‰¹æ®Šçš„ç¼–ç¨‹èŒƒå¼ã€‚æ¯”å¦‚è¯´&lt;code>mixin&lt;/code>æ¨¡å¼ã€‚ä½†æ˜¯å¤šç»§æ‰¿ä¹Ÿå­˜åœ¨å…¶å›ºæœ‰çš„å¤æ‚æ€§ï¼Œä¸»è¦è¡¨ç°åœ¨è¿è¡Œæ—¶å¤šæ€ä¸Šã€‚&lt;/p>
&lt;p>ä¸¾å‡ ä¸ªå¤šç»§æ‰¿ä¸Šå¸¸è§çš„é—®é¢˜ã€‚&lt;/p>
&lt;ol>
&lt;li>çˆ¶ç±»æˆå‘˜å†²çª&lt;/li>
&lt;/ol>
&lt;p>å…¸å‹åœºæ™¯å¦‚ä¸‹&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-C++" data-lang="C++">&lt;span class="k">class&lt;/span> &lt;span class="nc">ParentA&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">public&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="n">func&lt;/span>&lt;span class="p">(){}&lt;/span>
&lt;span class="p">};&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">ParentB&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">public&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="n">func&lt;/span>&lt;span class="p">(){}&lt;/span>
&lt;span class="p">};&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">Child&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="k">public&lt;/span> &lt;span class="n">ParentA&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">ParentB&lt;/span> &lt;span class="p">{};&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">Child&lt;/span> &lt;span class="n">c&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">func&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="c1">// error
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è§£å†³åŠæ³•ä¹Ÿå¾ˆç®€å•&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-C++" data-lang="C++">&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">Child&lt;/span> &lt;span class="n">c&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">ParentA&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">func&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¹‹æ‰€ä»¥å¦‚æœä¸è°ƒç”¨ &lt;code>func&lt;/code> å°±ä¸ä¼šå‡ºé”™ï¼Œæ˜¯å› ä¸º &lt;code>func&lt;/code> åœ¨ç¼–è¯‘åçš„ ABI å¯¼å‡ºçš„åå­—å¹¶æ²¡æœ‰äº§ç”Ÿå†²çªã€‚ä½†å¦‚æœä¸»åŠ¨è°ƒç”¨äº†&lt;code>func&lt;/code>ï¼Œç¼–è¯‘å™¨åˆ™éœ€è¦æ’å…¥ä¸€ä¸ªå‡½æ•°è°ƒç”¨ï¼Œä½†è¿™é‡Œçš„&lt;code>func&lt;/code>è¯­ä¹‰å´æ˜¯ä¸æ˜ç¡®çš„ï¼Œæ‰€ä»¥ç¼–è¯‘é˜¶æ®µå°±ä¼šæŠ¥å‘Šé”™è¯¯ã€‚&lt;/p>
&lt;ol start="2">
&lt;li>&lt;code>dynamic_cast&lt;/code>ä¼šæ”¹å˜æŒ‡é’ˆ&lt;/li>
&lt;/ol>
&lt;p>&lt;code>dynamic_cast&lt;/code>æ˜¯åŸºäº RTTI çš„è¿è¡Œæ—¶ç±»å‹å®‰å…¨çš„æ ‡å‡†ç±»å‹è½¬æ¢ï¼Œ&lt;code>dynamic_cast&lt;/code>æœ¬èº«æ˜¯ä¸€ä¸ªå…³é”®å­—ï¼Œè¿™é‡Œå°±è¯´ä¸€è¯´&lt;code>dynamic_cast&lt;/code>çš„è¡Œä¸ºå’Œå¤šç»§æ‰¿ã€‚&lt;/p>
&lt;p>å¤šç»§æ‰¿ä¸‹çš„&lt;code>dynamic_cast&lt;/code>ä¼šä¿®æ”¹æŒ‡é’ˆç»éå±è¨€è€¸å¬ã€‚äº‹å®ä¸Šåªè¦ç¨ä½œæ€è€ƒå°±èƒ½å¾—å‡ºè¿™æ ·çš„ç»“è®ºï¼šå¤šç»§æ‰¿ä¸‹çš„å†…å­˜å¸ƒå±€åº”è¯¥æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿ&lt;/p>
&lt;pre>&lt;code>v Pointer to Child
v Pointer to ParentB
v Pointer to ParentA
| ParentA | ParentB | Child |
[-----------====================&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;]
&lt;/code>&lt;/pre>&lt;p>C++ é¼“å¹&lt;code>Zero cost abstraction&lt;/code>ä¹Ÿä¸æ˜¯ä¸€å¤©ä¸¤å¤©çš„äº‹æƒ…äº†ï¼Œæˆæœå¦‚ä½•ä¸äºˆç½®è¯„ï¼Œä½†æ˜¾ç„¶ï¼Œä¸“é—¨ä¸ºå¤šç»§æ‰¿ä¸‹çš„æŒ‡é’ˆé™„åŠ ç±»å‹ä¿¡æ¯ï¼Œä»¥å…è®¸&lt;code>ParentB*&lt;/code>ç±»å‹çš„æŒ‡é’ˆæŒ‡å‘çš„åœ°å€å’Œ&lt;code>Child*&lt;/code>ç›¸åŒæ˜¯ä¸å¯èƒ½çš„ã€‚&lt;/p>
&lt;p>é‘è®º C++æ ‡å‡†é‡Œæ ¹æœ¬æ²¡&lt;code>åœ°å€&lt;/code>è¿™å›äº‹å„¿äº†ï¼ŒæŒ‡é’ˆæŒ‡å‘çš„æ˜¯å•¥ç©æ„å„¿éƒ½æœ‰å¯èƒ½ã€‚&lt;/p>
&lt;h3 id="å•ç»§æ‰¿">å•ç»§æ‰¿&lt;/h3>
&lt;p>å•ç»§æ‰¿å°±ç®€å•å¾—å¤šï¼Œåªå…è®¸ä¸€ä¸ªçˆ¶ç±»å­˜åœ¨ï¼Œæ ¹æ®è¯­è¨€è®¾è®¡ä¹Ÿå¯èƒ½å…è®¸å®ç°å¤šä¸ªæ¥å£ã€‚æ¯”å¦‚è¯´&lt;code>Java&lt;/code>å’Œ&lt;code>C#&lt;/code>ã€‚ä»¥æˆ‘æ¯”è¾ƒç†Ÿæ‚‰çš„ &lt;code>Rust&lt;/code> ä¸ºä¾‹ï¼ˆæš‚ä¸æç»§æ‰¿ï¼Œå› ä¸º&lt;code>Rust&lt;/code>å°±æ²¡ç»§æ‰¿è¿™ç äº‹å„¿ï¼Œå…¨æ˜¯&lt;code>Trait&lt;/code>ï¼‰ï¼Œä¸€ä¸ª&lt;code>struct&lt;/code>å¯ä»¥å®ç°å¤šä¸ª&lt;code>Trait&lt;/code>ï¼Œç„¶åä»¥&lt;code>Trait object&lt;/code>æ¥å®ç°å¯¹è±¡å¤šæ€ã€‚&lt;/p>
&lt;p>å•ç»§æ‰¿æ›´å¤šæ˜¯åœ¨å¤šæ€ã€é‡è½½ã€æ¥å£ç­‰æ–¹é¢çš„å–èˆï¼Œå°±ä¸ç»†è°ˆäº†ã€‚&lt;/p>
&lt;h2 id="ç¬¬ä¸‰æ‹›å¤šæ€">ç¬¬ä¸‰æ‹›ï¼šå¤šæ€&lt;/h2>
&lt;h2 id="å¤šæ€å’Œé¢å‘æ¥å£ç¼–ç¨‹">å¤šæ€å’Œé¢å‘æ¥å£ç¼–ç¨‹&lt;/h2>
&lt;blockquote>
&lt;p>é¢è¯•å®˜ï¼šçŸ¥é“å¤šæ€å—ï¼Ÿå¤šæ€æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>ç­”ï¼šå¤šæ€å°±æ˜¯&amp;hellip;blabla&amp;hellip;ä¸å»å…³æ³¨å­ç±»ç»†èŠ‚ï¼Œå½’ç±»æˆ xxx&amp;hellip;&amp;hellip;blabla&lt;/p>
&lt;/blockquote>
&lt;p>&lt;strong>å¤šæ€&lt;/strong>ç®—æ˜¯é¢å‘å¯¹è±¡åŸºæœ¬æ¦‚å¿µä¹‹ä¸€äº†ã€‚&lt;/p>
&lt;p>å¤šæ€æœ€åŸºæœ¬çš„è§£é‡Šå°±æ˜¯&lt;strong>åŒä¸€ä¸ªæ¥å£çš„ä¸åŒå®ç°&lt;/strong>ï¼Œä½†æˆ‘ç†è§£ä¸­çš„&lt;strong>å¤šæ€&lt;/strong>è§£é‡Šåˆ™æ›´è¶‹å‘äº&lt;strong>ç±»å‹æ“¦é™¤&lt;/strong>ï¼Œå³&lt;strong>æˆ‘ä¸åœ¨ä¹ä½ æ˜¯ä»€ä¹ˆé»‘äººã€ç™½äººã€é»„ç§äººã€é¦™è•‰äººï¼Œæˆ‘åªè¦ä½ èƒ½åšåˆ°æŸä»¶äº‹&lt;/strong>ã€‚æœ¬è´¨ä¸Šæ¥è¯´ï¼Œå¤šæ€çš„ä¸»è¦ä½œç”¨å°±æ˜¯&lt;strong>æ“¦é™¤ç»†èŠ‚&lt;/strong>ã€‚&lt;/p>
&lt;p>ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘æ‰“ç®—å»é¢è¯•ä¸€å®¶å…¬å¸ï¼Œé¢è¯•å®˜æƒ³è¦çš„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä»–æƒ³è¦çš„æ˜¯&lt;strong>èƒ½å¹²æ´»çš„äºº&lt;/strong>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-C++" data-lang="C++">&lt;span class="k">class&lt;/span> &lt;span class="nc">Worker&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">public&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="k">const&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">declarePay&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">const&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">declareEfficiency&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">BOOL&lt;/span> &lt;span class="nf">testWorkEfficiency&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">SomeShit&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">virtual&lt;/span> &lt;span class="o">~&lt;/span>&lt;span class="n">Worker&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">};&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">Company&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">public&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">BOOL&lt;/span> &lt;span class="n">hire&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Worker&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="p">...&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>é¢è¯•è€…å¯èƒ½æ˜¯&lt;code>HardWorker&lt;/code>ï¼Œ&lt;code>FxxkWorker&lt;/code>éƒ½æ˜¯&lt;code>Worker&lt;/code>å®ä¾‹ï¼Œä½†ä»–ä»¬ä¹ŸåŒæ—¶æ˜¯&lt;code>Human&lt;/code>ï¼Œå¯èƒ½æ˜¯&lt;code>Wife&lt;/code>ï¼Œå¯èƒ½æ˜¯&lt;code>Husband&lt;/code>ï¼Œä¹Ÿå¯èƒ½æ˜¯&lt;code>Father&lt;/code>ã€&lt;code>Mother&lt;/code>ï¼Œä½†æ˜¯è¿™äº›æˆ‘ä»¬éƒ½ä¸å…³å¿ƒã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ä¸å¯èƒ½ä¸ºæ¯ä¸ª&lt;code>PeopleæŸæŸæŸ&lt;/code>å„è‡ªå®šä¹‰ä¸€ä¸ª&lt;code>BOOL hirePeopleæŸæŸæŸ() {}&lt;/code>ï¼Œæˆ‘ä»¬å…³æ³¨çš„æ˜¯å·¥ä½œèƒ½åŠ›ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦åœ¨ç±»å‹é‡Œæ“¦é™¤æ‰è¿™äº›æ— å…³çš„ç»†èŠ‚ï¼Œä¿ç•™å…³æ³¨çš„éƒ¨åˆ†ã€‚&lt;/p>
&lt;p>å¤šæ€åšçš„å°±æ˜¯è¿™æ ·çš„ä¸€ä»¶äº‹ï¼šæˆ‘ä¸åœ¨ä¹ä½ æ˜¯è°ï¼Œæˆ‘åœ¨ä¹ä½ æ˜¯ä¸æ˜¯èƒ½å¹²å¥½è¿™ä»¶äº‹çš„äººã€‚&lt;/p>
&lt;p>è¿™ä¹ˆè¯´å…¶å®æœ‰äº›è„±ç¦»ä¸»é¢˜äº†ï¼Œå› ä¸ºè¿™æ˜¯&lt;strong>é¢å‘æ¥å£ç¼–ç¨‹&lt;/strong>çš„æ€æƒ³ï¼Œè€Œä¸æ˜¯å¯¹&lt;strong>å¤šæ€&lt;/strong>çš„å­¦æœ¯è§£é‡Šï¼Œä½†è¿™ç¡®å®å°±æ˜¯æˆ‘å¯¹å¤šæ€çš„ç†è§£ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨å°±æ˜¯&lt;strong>éšè—å·®å¼‚&lt;/strong>ï¼Œè¿›è€Œå‘å±•ä¸º&lt;strong>æ“¦é™¤ç»†èŠ‚&lt;/strong>ã€‚&lt;/p>
&lt;p>æˆ‘çš„å›ç­”å…¶å®æ ¹æœ¬æ²¡åˆ°ç‚¹ä¸Šï¼Œä¹Ÿæ²¡ Get åˆ°é¢è¯•å®˜çš„ pointï¼Œæ‰€ä»¥é¢è¯•å®˜å¾ˆå¿«å°±æ¢äº†ä¸‹ä¸€ä¸ªé—®é¢˜ã€‚&lt;/p>
&lt;h2 id="è°ˆè°ˆè™šå‡½æ•°">è°ˆè°ˆè™šå‡½æ•°&lt;/h2>
&lt;blockquote>
&lt;p>é¢è¯•å®˜ï¼šè™šå‡½æ•°çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>ç­”ï¼šå•Šï¼Ÿå®ç°å¤šæ€å•Šï¼Ÿ&amp;hellip;&lt;/p>
&lt;/blockquote>
&lt;p>&lt;strong>å¯ä»¥è¯´æ˜¯æœ€å·®çš„å›ç­”ã€‚&lt;/strong>&lt;/p>
&lt;p>é¢è¯•ä¸­æ²¡æœ‰ååº”è¿‡æ¥é—®çš„å•¥ï¼ŒçŸ¥é“è¢«æ‹’ç»äº†æ‰çªç„¶æ˜ç™½ã€‚&lt;/p>
&lt;p>o(ï¿£ãƒ˜ï¿£ oï¼ƒ)&lt;/p>
&lt;p>è¿™å·²ç»é—®åˆ°è¯­è¨€ç»†èŠ‚äº†ï¼Œæ‰€ä»¥å’±ä»¬å°±ä»è¯­è¨€å‡ºå‘æ¥è®²ã€‚&lt;/p>
&lt;h3 id="å¤šæ€">å¤šæ€&lt;/h3>
&lt;p>é¦–å…ˆè™šå‡½æ•°æ˜¯ä»€ä¹ˆï¼Ÿè™šå‡½æ•°æ˜¯ C++å®ç°å¤šæ€çš„æ‰‹æ®µï¼Œè¿™ä¹ˆç­”æ²¡é”™ï¼Œå­¦è¿‡ C++éƒ½çŸ¥é“ã€‚ä¸è¿‡è™šå‡½æ•°ä¸ä»…ä»…æ˜¯è¿™ä¸€ç‚¹ã€‚&lt;/p>
&lt;p>å’±å…ˆä»è¿™ä¸€ç‚¹è®²èµ·ã€‚&lt;/p>
&lt;p>è™šå‡½æ•°é€šè¿‡ä¸€ä¸ªå«è™šå‡½æ•°è¡¨çš„ä¸œè¥¿æ¥å®ç°å¤šæ€ï¼Œè¿™ä¸ªè™šå‡½æ•°è¡¨æ˜¯å®ç°å®šä¹‰çš„ï¼Œæ ‡å‡†æ²¡æœ‰å¯¹&lt;code>vtable&lt;/code>åšä»€ä¹ˆè§„å®šï¼Œæ¯”å¦‚è¯´å¿…é¡»æ”¾åœ¨ç±»æŒ‡é’ˆçš„å‰åå‡ ä¸ªå­—èŠ‚å¤„å•Šä»€ä¹ˆçš„&amp;hellip;&amp;hellip;ä¸å­˜åœ¨çš„ã€‚æ‰€ä»¥ä¹Ÿä¸è°ˆè™šè¡¨æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œè¿™å·²ç»æ˜¯å…·ä½“åˆ°å¹³å°å’Œç¼–è¯‘å™¨ä¸Šçš„å·®åˆ«äº†ï¼Œè¦æŠ è¿™ä¸ªçš„è¯å¿…é¡»å»è¯»ç¼–è¯‘å™¨å’Œå¹³å°ç›¸å…³çš„å„ç§æ–‡æ¡£äº†ï¼ŒPE æ ¼å¼å•Š DLL å•Š SharedObject å•Šä»€ä¹ˆçš„ã€‚&lt;/p>
&lt;p>å¦‚æœé—®èµ·æ¥çš„è¯&amp;hellip;&amp;hellip;å—¯&amp;hellip;&amp;hellip;è¿™ä¸ªèŒä½åº”è¯¥å¾ˆå‰å®³ã€‚&lt;/p>
&lt;p>æ‰€ä»¥æˆ‘å°±è·³è¿‡äº†ã€‚&lt;/p>
&lt;p>ç›´æ¥ç»™ä¸ªè™šå‡½æ•°çš„å®ä¾‹ï¼ŒçœŸçš„æ²¡ä»€ä¹ˆå¥½è¯´çš„ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-C++" data-lang="C++">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;iostream&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">ParentA&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">public&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="k">virtual&lt;/span> &lt;span class="n">vFunc&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">cout&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34;ParentA&amp;#34;&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">endl&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">};&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">Child&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="k">public&lt;/span> &lt;span class="n">ParentA&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">public&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="k">virtual&lt;/span> &lt;span class="n">vFunc&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="k">override&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">cout&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34;Child&amp;#34;&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">endl&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// é¡ºä¾¿å†™è°ƒç”¨çˆ¶ç±»çš„
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">ParentA&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">vFunc&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">};&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="è™šææ„å‡½æ•°">è™šææ„å‡½æ•°&lt;/h3>
&lt;p>C++è™šå‡½æ•°çš„å¦ä¸€ä¸ªé‡è¦ç”¨é€”å°±æ˜¯è™šææ„å‡½æ•°ã€‚&lt;/p>
&lt;p>å› ä¸º&amp;hellip;&amp;hellip;C++å¯¹è±¡æ¨¡å‹ä¸­ï¼Œææ„å‡½æ•°çš„ä½ç½®ååˆ†å°´å°¬ã€‚&lt;/p>
&lt;p>æ„é€ å‡½æ•°ä¹Ÿå°±ç®—äº†ï¼Œæ— è®ºå¦‚ä½•ä¹Ÿè¦æ˜¾å¼è°ƒç”¨ä¸€æ¬¡ã€‚&lt;/p>
&lt;p>ææ„å‡½æ•°åˆ™å› ä¸ºå¤šæ€çš„å­˜åœ¨è€Œååˆ†å°´å°¬ï¼šç»™ä½ ä¸€ä¸ªçˆ¶ç±»æŒ‡é’ˆåˆ—è¡¨ï¼Œä½ æ˜¾ç„¶ä¸èƒ½ä¸€ä¸ªä¸€ä¸ªæ£€æŸ¥è¿™äº›æŒ‡é’ˆæŒ‡å‘æ˜¯ä»€ä¹ˆå¯¹è±¡ï¼Œç„¶åå†è½¬å›å»ï¼Œæœ€åæ‰ &lt;code>delete&lt;/code> å®ƒã€‚&lt;/p>
&lt;p>å…‰æ˜¯å¬èµ·æ¥å°±éº»çƒ¦å¾—è¦æ­»ï¼Œæ›´åˆ«ææœ‰æ—¶å€™æ ¹æœ¬åšä¸åˆ°ã€‚C++è„†å¼±çš„&lt;code>RTTI&lt;/code>å’ŒåŸºæœ¬ä¸å­˜åœ¨çš„&lt;code>Reflection&lt;/code>å¯æ˜¯å‡ºäº†åçš„ã€‚&lt;/p>
&lt;p>C++å¯¹è¿™ä¸ªé—®é¢˜çš„è§£å†³åŠæ³•å°±æ˜¯è™šææ„å‡½æ•°ã€‚&lt;/p>
&lt;p>å’Œä¸€èˆ¬çš„è™šå‡½æ•°ä¸åŒï¼Œä¸€èˆ¬çš„è™šå‡½æ•°ä¸€æ—¦è¢«&lt;code>override&lt;/code>ï¼Œé™¤éä½ ä¸»åŠ¨è°ƒç”¨æŒ‡å®šçˆ¶ç±»çš„è™šæ–¹æ³•ï¼Œå¦åˆ™è°ƒç”¨çš„å¿…ç„¶æ˜¯ç»§æ‰¿é“¾æœ€åä¸€ä¸ª&lt;code>override&lt;/code>äº†è¿™ä¸ªè™šæ–¹æ³•çš„ç±»çš„è™šæ–¹æ³•å®ç°ã€‚&lt;/p>
&lt;p>ææ„å‡½æ•°çš„è¯å°±ç¨³äº†ï¼Œå®ƒä¼šé“¾å¼çš„è°ƒç”¨ç»§æ‰¿é“¾ä¸Šæ¯ä¸ªç±»çš„ææ„æ–¹æ³•ï¼Œå¤šç»§æ‰¿çš„æƒ…å†µä¸‹åˆ™æ˜¯æŒ‰ç…§ç»§æ‰¿çš„é¡ºåºè°ƒç”¨ææ„æ–¹æ³•ã€‚&lt;/p>
&lt;p>&lt;strong>ä¸ç”¨ä¸»åŠ¨å†™&lt;code>ParentA::~ParentA()&lt;/code>ï¼Œæ˜¯ä¸æ˜¯ç‰¹åˆ«çˆ½ï¼Ÿ&lt;/strong>&lt;/p>
&lt;blockquote>
&lt;p>è¿˜è¡Œï¼Œè¿™å°±æ˜¯ä¸ªè¯­æ³•ç³–ã€‚&lt;/p>
&lt;/blockquote>
&lt;h3 id="çº¯è™šå‡½æ•°å’ŒæŠ½è±¡ç±»">çº¯è™šå‡½æ•°å’ŒæŠ½è±¡ç±»&lt;/h3>
&lt;p>æœ€åæ˜¯çº¯è™šå‡½æ•°ã€‚&lt;/p>
&lt;p>å…¶å®è¿™ç©æ„å„¿æˆ‘æ›´æ„¿æ„ç§°ä»–ä¸º&lt;strong>æ¥å£&lt;/strong>ã€‚&lt;/p>
&lt;p>æœ¬è´¨ä¸Šæ¥è¯´ï¼Œçº¯è™šå‡½æ•°è§„å®šäº†ä¸€ä¸ª&lt;strong>æ–¹æ³•&lt;/strong>ï¼Œè¿™ä¸ªæ–¹æ³•æ¥æ”¶å›ºå®šçš„&lt;strong>è¾“å…¥&lt;/strong>ï¼Œå¹¶ä¿è¯æä¾›ä¸€ä¸ª&lt;strong>è¾“å‡º&lt;/strong>ï¼Œç›¸åº”çš„å¯èƒ½è¿˜æœ‰&lt;strong>å¼‚å¸¸å£°æ˜&lt;/strong>ï¼Œæ¥è¯´æ˜è¿™ä¸ªæ–¹æ³•å¯èƒ½æŠ›å‡ºçš„å¼‚å¸¸ã€‚&lt;/p>
&lt;p>æ€ä¹ˆæ ·ï¼Œçœ‹èµ·æ¥çœ¼ç†Ÿä¸ï¼Ÿ&lt;/p>
&lt;p>è¿˜æ²¡å®Œï¼Œçº¯è™šæ–¹æ³•æ²¡æœ‰å®ç°ï¼ˆä½ å¼€å¿ƒçš„è¯ä¹Ÿå¯ä»¥å†™ä¸ªå®ç°ï¼‰ï¼Œå¼ºåˆ¶è¦æ±‚å­ç±»å¿…é¡»å®ç°ï¼Œè€Œå®šä¹‰äº†çº¯è™šæ–¹æ³•çš„ç±»è¢«ç§°ä¹‹ä¸º&lt;strong>æŠ½è±¡ç±»&lt;/strong>ã€‚&lt;/p>
&lt;p>æˆ‘æƒ³å°±ç®—æ˜¯å«å®ƒ&lt;strong>æ¥å£ç±»&lt;/strong>å®ƒä¹Ÿä¸ä¼šåå¯¹çš„å§ã€‚&lt;/p>
&lt;p>çº¯è™šå‡½æ•°å¯ä»¥ç±»æ¯”äº&lt;code>C#&lt;/code>çš„&lt;code>interface&lt;/code>ï¼Œæˆ–è€…&lt;code>typescript&lt;/code>çš„&lt;code>interface&lt;/code>ï¼Œæ€»ä¹‹å°±æ˜¯å„ç§è¯­è¨€çš„&lt;code>interface&lt;/code>ã€‚è¿™äº›&lt;code>interface&lt;/code>åœ¨å…·ä½“çš„è§„å®šä¸Šå¯èƒ½æœ‰æ‰€å·®å¼‚ï¼Œæ¯”å¦‚è¯´ä¸å…è®¸å†™æ•°æ®æˆå‘˜å•¦ï¼Œæ•°æ®æˆå‘˜å†™äº†ä¸ç®—åœ¨å®ç°&lt;code>interface&lt;/code>çš„ç±»ä¸Šè¿˜è¦å†å£°æ˜ä¸€æ¬¡å•¦ï¼Œ&lt;code>interface&lt;/code>çš„æ–¹æ³•å¯ä¸å¯ä»¥æœ‰ä¸ªé»˜è®¤å®ç°å•¦ï¼Œè¿™äº›éƒ½æ˜¯ç»†èŠ‚ã€‚&lt;/p>
&lt;p>è¿˜è®°å¾—ä¸Šé¢æˆ‘è¯´&lt;strong>å¤šæ€&lt;/strong>å—ï¼Ÿå¤šæ€çš„ç›®çš„æ˜¯&lt;strong>æ“¦é™¤ç±»å‹ç»†èŠ‚&lt;/strong>ï¼Œæ‰€ä»¥è¿™äº›é•¿å¾—å„ä¸ç›¸åŒç™¾èŠ±é½æ”¾çš„&lt;code>interface&lt;/code>åšçš„äº‹æƒ…å…¶å®éƒ½æ˜¯ä¸€å›äº‹ï¼šä½ èƒ½åšå•¥ï¼Œé‚£ä¹ˆä½ æ˜¯å•¥ã€‚&lt;/p>
&lt;p>è¿™é‡Œå†è¯´ä¸ªç»†èŠ‚ï¼Œçº¯è™šå‡½æ•°ä½œä¸ºææ„å‡½æ•°çš„æ—¶å€™ï¼Œææ„å‡½æ•°åº”è¯¥æœ‰ä¸ªå®ç°&amp;hellip;&amp;hellip;&lt;/p>
&lt;p>å¬èµ·æ¥æŒºå¥‡æ€ªçš„ï¼Ÿä¸å†™çº¯è™šææ„å‡½æ•°å®ç°çš„è¯ï¼Œä¼šæŠ¥ä¸ªé“¾æ¥é”™è¯¯&amp;hellip;è‡³äºä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Œå…¶ä¸­çš„å–èˆå°±ä¸å¾—è€ŒçŸ¥äº†ã€‚&lt;/p>
&lt;p>C++çš„çº¯è™šå‡½æ•°å’ŒæŠ½è±¡ç±»å¾ˆçµæ´»ï¼Œæ²¡æœ‰å…¶ä»–è¯­è¨€&lt;code>interface&lt;/code>ç§ç§é™åˆ¶ï¼Œå¦‚æœè¦è¿½é—®çº¯è™šå‡½æ•°&lt;/p>
&lt;blockquote>
&lt;p>when? where? why?&lt;/p>
&lt;/blockquote>
&lt;p>é‚£å°±è¦çœ‹åˆ°å…·ä½“åœºæ™¯äº†ï¼ŒC++è¿™äº›çµæ´»çš„ç‰¹æ€§ä¸€ä¸å°å¿ƒå°±ä¼šå˜æˆæ»¥ç”¨ï¼Œåæ­£è¿™ä¹ˆé—®æˆ‘åº”è¯¥ä¹Ÿå°±ç­”&lt;code>interface&lt;/code>ã€&lt;code>mixin&lt;/code>ä»¥åŠå…¶ä»–å…·ä½“éœ€æ±‚çš„åœºæ™¯è¿™æ ·å­äº†ã€‚&lt;/p>
&lt;h3 id="mixin-æ¨¡å¼">Mixin æ¨¡å¼&lt;/h3>
&lt;p>&lt;code>Mixin&lt;/code>æ¨¡å¼åœ¨&lt;code>Python&lt;/code>é‡Œæ¯”è¾ƒå¸¸è§ï¼Œä¸è¿‡ C++ä¹Ÿå¹¶ä¸æ˜¯æ²¡æœ‰ã€‚é€šè¿‡å®šä¹‰çº¯è™šææ„å‡½æ•°ï¼Œæ¥ç»™ä¸€ä¸ªå¯¹è±¡æ··å…¥ç‰¹å®šåŠŸèƒ½è€Œåˆä¸å…è®¸è‡ªå·±è¢«ç‹¬ç«‹æ„å»ºï¼Œç®—æ˜¯ä¸ªå¸¸è§çš„èŒƒå¼ã€‚&lt;/p>
&lt;p>ä¸¾ä¸ªä¾‹å­ï¼Œå¼•ç”¨è®¡æ•°ï¼Œå¦‚æœå‘ç°è‡ªå·±å¼•ç”¨å½’é›¶äº†å°±é‡Šæ”¾èµ„æºï¼Œçº¿ç¨‹å®‰å…¨ä¹‹ç±»çš„é—®é¢˜å…ˆä¸ç®¡ï¼Œä»…ä»…æ˜¯å±•ç¤ºè¿™ä¸ªèŒƒå¼ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-C++" data-lang="C++">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;iostream&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">RcMixin&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">private&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="k">using&lt;/span> &lt;span class="n">deleter&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">()&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">_rc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">nullptr&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">deleter&lt;/span> &lt;span class="n">resDeleter&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">public&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">RcMixin&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">deleter&lt;/span> &lt;span class="n">resDeleter&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="n">resDeleter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">resDeleter&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">*&lt;/span>&lt;span class="n">_rc&lt;/span>&lt;span class="o">+=&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// çº¿ç¨‹å®‰å…¨å°±å…ˆæ”¾ä¸€è¾¹
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="n">RcMixin&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="n">RcMixin&lt;/span>&lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">other&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">resDeleter&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">other&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">resDeleter&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="o">*&lt;/span>&lt;span class="n">_rc&lt;/span>&lt;span class="o">+=&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">virtual&lt;/span> &lt;span class="o">~&lt;/span>&lt;span class="n">RcMixin&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">*&lt;/span>&lt;span class="n">_rc&lt;/span>&lt;span class="o">-=&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">_rc&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">resDeleter&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">};&lt;/span>
&lt;span class="c1">// è™½ç„¶æ˜¯ä¸ªRcMixinä½†æ˜¯å¤–ç•Œå¹¶ä¸éœ€è¦çŸ¥é“å®ƒæ˜¯RcMixin
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">class&lt;/span> &lt;span class="nc">SomeShit&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="k">private&lt;/span> &lt;span class="n">RcMixin&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">private&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="kt">int&lt;/span>&lt;span class="o">*&lt;/span> &lt;span class="n">res&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">nullptr&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">public&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">SomeShit&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="o">:&lt;/span> &lt;span class="n">RcMixin&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">]()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">cout&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">endl&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">delete&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">res&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">})&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">res&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">virtual&lt;/span> &lt;span class="o">~&lt;/span>&lt;span class="n">SomeShit&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;span class="p">};&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="n">SomeShit&lt;/span> &lt;span class="n">a&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">b&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">a&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">auto&lt;/span> &lt;span class="n">c&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">b&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»£ç æ²¡æµ‹è¿‡ï¼Œåæ­£å¤§æ¦‚å°±æ˜¯è¿™ç§æ„Ÿè§‰ï¼Œå°†æŸäº›åŠŸèƒ½æ··å…¥ä¸€ä¸ªç°å­˜çš„ç±»ï¼Œè€Œä¸éœ€è¦åšå¤ªå¤šçš„å·¥ä½œã€‚åœ¨ C++é‡Œæ²¡é‚£ä¹ˆæ–¹ä¾¿ï¼Œå¼ºç±»å‹ä¸‹çš„ Mixin éœ€è¦å¾ˆå¤šå˜é€šæŠ€å·§æ‰èƒ½æ„‰å¿«åœ°æ··å…¥æ–°åŠŸèƒ½ï¼Œè€Œé¸­å­ç±»å‹&lt;code>Duck typing&lt;/code>çš„è¯­è¨€åˆ™èˆ’çˆ½å¾ˆå¤šï¼Œå½“ç„¶ï¼Œæœ€å¥½çš„è¿˜æ˜¯å…·æœ‰å®Œå–„ &lt;code>Reflection&lt;/code> å’Œ &lt;code>Attribute&lt;/code> æ”¯æŒçš„è¯­è¨€ï¼Œå®Œå…¨é¿å…äº†å¯¹&lt;code>Mixin&lt;/code>ç±»å‹çš„æ„é€ å’Œéœ€è¦åˆ©ç”¨çš„æ•°æ®çš„ç»‘å®šä¸€ç±»çš„ä¸å¿…è¦çš„å…³æ³¨ã€‚&lt;/p>
&lt;h3 id="æ‰©å±•è™šç»§æ‰¿">æ‰©å±•ï¼šè™šç»§æ‰¿&lt;/h3>
&lt;p>åŒæ ·æ˜¯ &lt;code>virtual&lt;/code> å…³é”®å­—ï¼Œè™šç»§æ‰¿å’Œè™šå‡½æ•°å…³ç³»å°±ä¸æ€ä¹ˆå¤§äº†ã€‚&lt;/p>
&lt;p>è™šç»§æ‰¿é¢å¯¹çš„é—®é¢˜æ˜¯&lt;strong>å¤šç»§æ‰¿æ—¶ï¼Œå¤šä¸ªçˆ¶ç±»ç»§æ‰¿è‡ªåŒä¸€ä¸ªåŸºç±»&lt;/strong>è¿™ä¸€é—®é¢˜ã€‚&lt;/p>
&lt;p>å¬èµ·æ¥æ˜¯ä¸æ˜¯æœ‰ç‚¹å¥‡æ€ªï¼Ÿè¿™äº›çˆ¶ç±»ç»§æ‰¿è‡ªåŒä¸€ä¸ªåŸºç±»ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ&lt;/p>
&lt;p>äº‹å®ä¸Šï¼Œè¿™ä¸ªé—®é¢˜å–å†³äºå†™å‡ºå¤šç»§æ‰¿ä»£ç çš„äººï¼Œä¹Ÿå–å†³äºè¿™å¤šä¸ªçˆ¶ç±»æ˜¯å¦æœ‰å¯¹å¤šç»§æ‰¿æ–¹é¢åšè¿‡è€ƒè™‘ã€‚&lt;/p>
&lt;p>ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œ&lt;code>ParentA&lt;/code>å’Œ&lt;code>ParentB&lt;/code>éƒ½ç»§æ‰¿è‡ª&lt;code>DataA&lt;/code>ï¼Œ&lt;code>ParentA&lt;/code>ä¿®æ”¹äº†&lt;code>DataA&lt;/code>çš„æ•°æ®ï¼Œä½†&lt;code>ParentB&lt;/code>ä¸çŸ¥é“ã€‚å¦‚æœ&lt;code>ParentB&lt;/code>éœ€è¦æ ¹æ®&lt;code>DataA&lt;/code>çš„æŸäº›æ•°æ®è¿›è¡Œæ“ä½œâ€”â€”å¾ˆé—æ†¾ï¼Œè¿™ä¸ªè¡Œä¸ºå¯èƒ½ä¸é¢„æœŸçš„ä¸åŒã€‚&lt;/p>
&lt;p>ä¹‹æ‰€ä»¥å¼•å…¥è™šç»§æ‰¿ï¼Œæ˜¯ä¸ºäº†è§£å†³&lt;strong>è¦ä¸è¦å…±äº«åŒä¸€ä¸ªåŸºç±»å®ä¾‹&lt;/strong>çš„é—®é¢˜ï¼Œé€‰æ‹©è™šç»§æ‰¿ï¼Œåˆ™é€‰æ‹©å…±äº«åŸºç±»å®ä¾‹ã€‚&lt;/p>
&lt;p>å…±äº«åŸºç±»å®ä¾‹çš„ä¼˜åŠ¿æ˜¯ï¼Œå¤šä¸ªçˆ¶ç±»çš„åŠŸèƒ½å¯ä»¥æ— ç¼ç»“åˆã€‚&lt;code>ParentA&lt;/code>å’Œ&lt;code>ParentB&lt;/code>å¯ä»¥å…±äº«åŸºç±»å®šä¹‰çš„&lt;code>Mutex&lt;/code>ç­‰çŠ¶æ€èµ„æºâ€”â€”å½“ç„¶ï¼Œå‰ææ˜¯è®¾è®¡çˆ¶ç±»çš„äººæœ‰è¿‡è¿™æ–¹é¢çš„è€ƒè™‘ã€‚&lt;/p>
&lt;p>ä¸ç„¶çš„è¯ï¼Œä¸å…±äº«åŸºç±»å®ä¾‹æ˜¯ä¸ªä¿å®ˆä½†æ›´å®‰å…¨ï¼Œä¸æ˜“å‡ºç°æ­§ä¹‰çš„é€‰æ‹©ã€‚&lt;/p>
&lt;h2 id="ç¬¬å››æ‹›æ•°ç»„å’Œé“¾è¡¨">ç¬¬å››æ‹›ï¼šæ•°ç»„å’Œé“¾è¡¨&lt;/h2>
&lt;blockquote>
&lt;p>é¢è¯•å®˜ï¼šæˆ‘ä»¬èŠä¸€ä¸‹æ•°æ®ç»“æ„æ–¹é¢å§&amp;hellip;..è®²ä¸€ä¸‹æ•°ç»„å’Œé“¾è¡¨ï¼Ÿå¯ä»¥ä»è®¿é—®å’Œåˆ é™¤ä¸¤æ–¹é¢æ¥è¯´ã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>ç­”ï¼šæ•°ç»„å…è®¸éšæœºè®¿é—®ï¼Œåªéœ€è¦ä¸€æ­¥å°±èƒ½æ‰¾åˆ°å¯¹åº”å…ƒç´ ï¼Œè€Œé“¾è¡¨éœ€è¦&amp;hellip;&amp;hellip;blablaï¼Œæ•°ç»„åˆ é™¤å…ƒç´ å¦‚æœéœ€è¦ç§»åŠ¨åç»­å…ƒç´ çš„è¯ï¼Œä¼šäº§ç”Ÿå¤åˆ¶æ“ä½œæ€§èƒ½æŸå¤±ï¼Œé“¾è¡¨åªéœ€è¦ä¿®æ”¹å‡ ä¸ªæŒ‡é’ˆ&amp;hellip;blablaã€‚&lt;/p>
&lt;/blockquote>
&lt;p>å®é™…ä¸Šç­”åˆ°è¿™é‡Œæˆ‘å·²ç»ä¸çŸ¥é“è‡ªå·±åœ¨è¯´å•¥äº†ã€‚&lt;/p>
&lt;p>æ•°ç»„å’Œé“¾è¡¨çš„åŒºåˆ«è¿˜æ˜¯æŒºå¤§çš„ï¼Œæˆ‘åº”è¯¥ç®—æ˜¯ Get åˆ°äº†å‡ ä¸ªç‚¹ï¼Ÿä¸‹é¢æ˜¯é‡æ–°æ•´ç†äº†è¯­è¨€åçš„å›ç­”ã€‚&lt;/p>
&lt;h3 id="æ•°ç»„å’Œé“¾è¡¨çš„å†…å­˜å¸ƒå±€">æ•°ç»„å’Œé“¾è¡¨çš„å†…å­˜å¸ƒå±€&lt;/h3>
&lt;p>æ•°ç»„å’Œé“¾è¡¨ä¸¤è€…éƒ½æ˜¯çº¿æ€§æ•°æ®ç»“æ„ï¼Œè¡¨ç°ä¸Šéƒ½æ˜¯ä¸€æ¡æœ‰å¤´æœ‰å°¾çš„æœ‰åºåºåˆ—ï¼Œä½†æ˜¯å‚¨å­˜æ–¹å¼ä¸Šæœ‰åŒºåˆ«ã€‚&lt;/p>
&lt;p>æ•°ç»„çš„å‚¨å­˜æ–¹å¼æ˜¯ä¸€ç«¯è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œç´¢å¼•åªéœ€è¦è¿›è¡Œä¸€æ¬¡æŒ‡é’ˆè¿ç®—å³å¯è·å¾—ç›®æ ‡å…ƒç´ çš„ä½ç½®ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºè®¿é—®æ—¶é—´å§‹ç»ˆæ˜¯&lt;code>O(1)&lt;/code>ã€‚&lt;/p>
&lt;blockquote>
&lt;p>PS: è¿˜èƒ½å†™å‡º 0[array] è¿™æ ·çš„éªšå†™æ³•ï¼Œä¸æ€•è¢«æ‰“æ­»çš„è¯ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>é“¾è¡¨çš„å†…å­˜å¸ƒå±€åˆ™æ˜¯åˆ†æ•£çš„ï¼Œé€šå¸¸çš„é“¾è¡¨å®ç°å¾€å¾€æ˜¯æ’å…¥å…ƒç´ æ—¶åŠ¨æ€åˆ†é…ä¸€ä¸ªå…ƒç´ çš„ç©ºé—´ï¼Œè€Œåˆ é™¤çš„æ—¶å€™å†é‡Šæ”¾ï¼Œé•¿æ­¤ä»¥å¾€å¯¹å†…å­˜æ˜¯ä¸å‹å¥½çš„ï¼Œå®¹æ˜“äº§ç”Ÿå†…å­˜ç¢ç‰‡ï¼Œå¯¼è‡´åˆ†é…è¾ƒå¤§ç©ºé—´æ—¶æ— æ³•å¯»å¾—è¶³å¤Ÿé•¿çš„è¿ç»­å†…å­˜ç‰‡æ®µè€Œé€ æˆåˆ†é…å¤±è´¥ã€‚&lt;/p>
&lt;p>&amp;hellip;&amp;hellip;å½“ç„¶ï¼Œæ˜¯é•¿æœŸæ‰ä¼šäº§ç”Ÿçš„é—®é¢˜ï¼Œè€Œä¸”æ˜¯åˆ‡å®å­˜åœ¨çš„é—®é¢˜ã€‚&lt;/p>
&lt;h3 id="ç´¢å¼•">ç´¢å¼•&lt;/h3>
&lt;p>å¯¹äºæ•°ç»„æ¥è¯´çš„è¯ï¼Œå¯ä»¥ç†è§£æˆæ ‡å‡†åº“çš„ &lt;code>std::array&lt;/code>ï¼Œä¹Ÿå¯ä»¥ç†è§£æˆåŸå§‹æ•°ç»„ï¼Œä½†ä¸å˜çš„æ˜¯ç´¢å¼•æ–¹å¼å§‹ç»ˆæ˜¯&lt;code>O(1)&lt;/code>å¤æ‚åº¦ï¼Œè€Œä¸”æ”¯æŒéšæœºè®¿é—®è¿­ä»£å™¨ã€‚&lt;/p>
&lt;p>å¯¹äºé“¾è¡¨æ¥è¯´ï¼Œä¸è€ƒè™‘ä¼˜åŒ–åçš„å˜ä½“ï¼Œç´¢å¼•æ–¹å¼åœ¨æœ¬è´¨ä¸Šéƒ½æ˜¯é¡ºåºè®¿é—®è¿­ä»£å™¨â€”â€”æŒ‡é’ˆä¹Ÿç®—æ˜¯æ¦‚å¿µä¸Šçš„è¿­ä»£å™¨ã€‚æ‰€ä»¥å¯¹äºé“¾è¡¨ï¼Œè®¿é—®æ—¶é—´çš„å¤æ‚åº¦æœ€åæƒ…å†µåº”è¯¥æ˜¯&lt;code>O(n)&lt;/code>ï¼Œ&lt;code>n&lt;/code>æ˜¯é“¾è¡¨é•¿åº¦ã€‚ä¸ç”¨è¯´ï¼Œç´¢å¼•æ€§èƒ½è‡ªç„¶æ˜¯ä¸å¦‚æ•°ç»„çš„ã€‚&lt;/p>
&lt;h3 id="åˆ é™¤">åˆ é™¤&lt;/h3>
&lt;p>æ•°ç»„åˆ é™¤å…ƒç´ å…¶å®æ˜¯æ¯”è¾ƒçƒ¦çš„ï¼Œå¤æ‚åº¦åº”è¯¥æ˜¯&lt;code>O(n)&lt;/code>ï¼Œ&lt;code>n&lt;/code>æ˜¯æ•°ç»„é•¿åº¦å‡å»åˆ é™¤å…ƒç´ åœ¨æ•°ç»„ä¸­çš„ä½ç½®ã€‚æœ€éº»çƒ¦çš„æ˜¯ä¸‡ä¸€æ•°ç»„å¾ˆé•¿ï¼Œé‚£ä¹ˆå¤åˆ¶å…ƒç´ åˆ°ä¸Šä¸€ä¸ªä½ç½®å°†ä¼šæ˜¯å™©æ¢¦ã€‚&lt;/p>
&lt;p>å½“ç„¶ä¹Ÿä¸æ˜¯ä¸èƒ½ä¼˜åŒ–&amp;hellip;&amp;hellip;æŠŠç§»åŠ¨çš„æ“ä½œæ¨è¿Ÿåˆ°æ’å…¥æ–°å…ƒç´ çš„æ—¶å€™å°±å¥½äº†ï¼Œç”¨ä¸€ä¸ªå ä½ç¬¦è¡¨ç¤ºè¿™é‡Œå·²ç»è¢«åˆ é™¤ï¼ŒåŒæ—¶è®°å½•å‰é¢æœ‰å¤šå°‘ä¸ªå…ƒç´ è¢«åˆ é™¤ã€‚è¿™æ ·ä¸€æ¥ç´¢å¼•æ€§èƒ½ä¼šä¸‹é™ï¼ˆå› ä¸ºè¦æ‰¾åˆ°ä¸Šä¸€ä¸ªè¢«åˆ é™¤çš„å…ƒç´ ï¼Œç„¶åæ›´æ–°ç´¢å¼•ä½ç½®ï¼Œç›´åˆ°æ‰¾åˆ°æ­£ç¡®çš„å…ƒç´ ï¼‰ï¼Œåˆ é™¤æ€§èƒ½æé«˜ï¼ˆåªè¦æ‰¾åˆ°ä¸Šä¸€ä¸ªè¢«åˆ é™¤çš„å…ƒç´ ç„¶åè®°å½•è‡ªå·±ä½œä¸ºè¢«åˆ é™¤å…ƒç´ çš„ä½ç½®å°±å¥½ï¼‰ï¼Œæ•´ä½“å®ç°çš„å¤æ‚åº¦æå‡ï¼Œç´¢å¼•åˆ é™¤æ’å…¥éƒ½è¦å¦å¤–ç¼–å†™å®ç°ï¼Œæ„Ÿè§‰å¾—ä¸å¿å¤±ã€‚&lt;/p>
&lt;p>é“¾è¡¨åˆ é™¤å…ƒç´ å¾ˆç®€å•ï¼Œç´¢å¼•åˆ°éœ€è¦åˆ é™¤çš„å…ƒç´ çš„æ—¶é—´å¤æ‚åº¦æ˜¯&lt;code>O(n)&lt;/code>ï¼Œåˆ é™¤æ“ä½œçš„æ—¶é—´å¤æ‚åº¦æ˜¯&lt;code>O(1)&lt;/code>ï¼Œè€Œä¸”å®ç°ç®€å•ã€‚&lt;/p>
&lt;h3 id="æ‰©å±•ç»“åˆä¸¤è€…">æ‰©å±•ï¼šç»“åˆä¸¤è€…ï¼Ÿ&lt;/h3>
&lt;p>å¥½å§ï¼Œè¿™ä¸ªé—®é¢˜é¢è¯•å®˜æ²¡é—®åˆ°ã€‚&lt;/p>
&lt;p>é“¾è¡¨å’Œæ•°ç»„ç»“åˆä¸€ä¸‹èƒ½è§£å†³ä¸€éƒ¨åˆ†å†…å­˜ç¢ç‰‡çš„é—®é¢˜ï¼ŒåŸºæœ¬æ€è·¯çš„è¯&amp;hellip;&amp;hellip;å’±é¢„å…ˆåˆ†é… 100 ä¸ªå…ƒç´ ï¼Œå¦‚æœæ’å…¥çš„å…ƒç´ è¶…è¿‡äº† 100 ä¸ªï¼Œå’±å†åˆ†é… 100 ä¸ªå…ƒç´ çš„ç©ºé—´ï¼Œç„¶åç´¢å¼•çš„æ—¶å€™å†å»æ‰¾ç¬¬äºŒä¸ªæ± ï¼Ÿ&lt;/p>
&lt;p>è¿™ä¸ªæ€è·¯æœ¯è¯­å«ä»€ä¹ˆè®°ä¸èµ·æ¥äº†ã€‚&lt;/p>
&lt;h3 id="å“¦ä¸ä»–åˆ°åº•æƒ³é—®ä»€ä¹ˆ">å“¦ä¸ï¼ä»–åˆ°åº•æƒ³é—®ä»€ä¹ˆï¼Ÿ&lt;/h3>
&lt;p>çŒœä¸€çŒœé¢è¯•å®˜åˆ°åº•æƒ³é—®äº›ä»€ä¹ˆï¼Ÿ&lt;/p>
&lt;ol>
&lt;li>åŠ¨æ€å†…å­˜åˆ†é…ï¼šæ•°ç»„å®šé•¿ï¼Œè€Œé“¾è¡¨å˜é•¿ã€‚æˆ‘æ„Ÿè§‰è¿™ä¸ªç‰¹å¾åŸºæœ¬æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œå·¥ä½œä¸­åŸºæœ¬æ²¡æœ‰æœºä¼šè‡ªå·±é‡æ–°å®ç°ä¸€ä¸ªçº¿æ€§å®¹å™¨ï¼Œé™¤éè¦å®šåˆ¶ä¸€äº›ç‰¹æ®Šçš„ç»“æ„ï¼Œç¯å½¢é“¾è¡¨ä¹‹ç±»çš„ä¸œè¥¿ã€‚å…¶ä»–åƒæ˜¯é“¾è¡¨ï¼Œæ•°ç»„ï¼Œé˜Ÿåˆ—ï¼Œæ ‡å‡†åº“éƒ½æœ‰ç›¸åº”çš„å®ç°ã€‚ä¹Ÿè®¸æ˜¯è€ƒè™‘è‡ªè¡Œç¼–å†™çº¿ç¨‹å®‰å…¨ç‰ˆæœ¬çš„ STLï¼Ÿ&lt;/li>
&lt;li>&lt;code>std::array&lt;/code>å’Œ&lt;code>std::list&lt;/code>ã€‚æ‰€ä»¥é—®çš„æ˜¯å•¥å‘¢&amp;hellip;ï¼Ÿæä¾›çš„ä¿è¯å’Œ&lt;code>implement specified&lt;/code>è¿˜æœ‰&lt;code>undefined behavior&lt;/code>å—ï¼ŸSTL ç°åœ¨è¿˜æ²¡æœ‰&lt;code>concept&lt;/code>ï¼Œä½†æ˜¯æ—©æ—©å°±æœ‰äº†&lt;code>SFINAE&lt;/code>å’Œ&lt;code>enable_if&lt;/code>ä¹‹ç±»çš„ä¸œè¥¿ï¼Œ&lt;code>constexpr if&lt;/code> æ›´æ˜¯æå¤§åœ°å¼ºåŒ–äº†ç¼–è¯‘æœŸå…ƒç¼–ç¨‹æ–¹é¢çš„èƒ½åŠ›ã€‚å¦‚æœæ˜¯é—®æ ‡å‡†æ¨¡æ¿åº“æ–¹é¢çš„ä¸œè¥¿çš„è¯ï¼Œæˆ‘è§‰å¾—é—®æ ‡å‡†åº“çº¿ç¨‹å®‰å…¨å•Šï¼Œè¿­ä»£å™¨ç®—æ³•ä¹‹ç±»çš„ä¸œè¥¿è¦åˆé€‚å¾—å¤šã€‚æ‰€ä»¥&amp;hellip;&amp;hellip;å¤§æ¦‚ä¹Ÿä¸æ˜¯æƒ³é—®è¿™ä¸ªã€‚&lt;/li>
&lt;li>è¿­ä»£å™¨ã€‚å¦‚æœæ˜¯è¿™ä¸ªçš„è¯æˆ‘çœŸçš„å¸Œæœ›é¢è¯•å®˜å¤§äººèƒ½ç›´æ¥è¯´å‡ºè¿­ä»£å™¨ä¸‰ä¸ªå­—&amp;hellip;&amp;hellip;ä¸è¿‡å¥½æ­¹å›ç­”å‡ºéšæœºè®¿é—®äº†ï¼Œåº”è¯¥ä¸è‡³äºå§ã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="ç¬¬å››æ‹›æ•°æ®åº“ç´¢å¼•">ç¬¬å››æ‹›ï¼šæ•°æ®åº“ç´¢å¼•&lt;/h2>
&lt;blockquote>
&lt;p>é¢è¯•å®˜ï¼šè®²ä¸€ä¸‹æ•°æ®åº“çš„ç´¢å¼•æœ‰ä»€ä¹ˆä½œç”¨ã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>æˆ‘ï¼šæ‡µé€¼&amp;hellip;&amp;hellip;&lt;/p>
&lt;/blockquote>
&lt;p>è¿˜è¡Œï¼Œç›´æ¥æ‡µäº†ã€‚&lt;/p>
&lt;p>å› ä¸ºå®Œå…¨æ²¡ææ˜ç™½é¢è¯•å®˜çš„æ„å›¾ï¼šç´¢å¼•æŒ‡çš„æ˜¯å•¥ï¼Ÿé¢è¯•å®˜æ˜¯æƒ³é—®æ•°æ®åº“ç´¢å¼•çš„æ–¹å¼å—ï¼ŸB+æ ‘è¯¥æ€ä¹ˆå®ç°ï¼Ÿ&lt;/p>
&lt;p>å›æ¥è·¯ä¸Šæˆ‘è€ƒè™‘äº†ä¸€ä¸‹ï¼Œè¿™å‡ æ–¹é¢å¯èƒ½å¯ä»¥ä½œä¸ºå›ç­”çš„æ–¹å‘ã€‚&lt;/p>
&lt;h3 id="ç´¢å¼•çš„å®ç°">ç´¢å¼•çš„å®ç°&lt;/h3>
&lt;p>æ•°æ®åº“ç´¢å¼•çš„å¸¸è§å®ç°æ–¹å¼æ˜¯ B+ æ ‘ï¼Œæˆ‘æ•°æ®ç»“æ„å­¦çš„ä¸å¥½ï¼ŒåªçŸ¥é“ B+ æ ‘æ˜¯ä¸ªå¾ˆå‰å®³çš„æ•°æ®ç»“æ„&amp;hellip;..æ‰€ä»¥åšæ–‡å†™åˆ°è¿™é‡Œï¼Œä¸å¾—ä¸å¼€å§‹æŸ¥èµ„æ–™äº†ã€‚&lt;/p>
&lt;blockquote>
&lt;p>B+ æ ‘æ˜¯ä¸€ç§æ ‘æ•°æ®ç»“æ„ï¼Œé€šå¸¸ç”¨äºæ•°æ®åº“å’Œæ“ä½œç³»ç»Ÿçš„æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚B+ æ ‘çš„ç‰¹ç‚¹æ˜¯èƒ½å¤Ÿä¿æŒæ•°æ®ç¨³å®šæœ‰åºï¼Œå…¶æ’å…¥ä¸ä¿®æ”¹æ‹¥æœ‰è¾ƒç¨³å®šçš„å¯¹æ•°æ—¶é—´å¤æ‚åº¦ã€‚B+ æ ‘å…ƒç´ è‡ªåº•å‘ä¸Šæ’å…¥ï¼Œè¿™ä¸äºŒå‰æ ‘æ°å¥½ç›¸åã€‚&lt;/p>
&lt;/blockquote>
&lt;p>å¦‚æœé—®èµ· B+æ ‘å®ç°ï¼Œæˆ–è€…è®©æ‰‹å†™ä¸ª B+æ ‘çš„è¯ï¼Œæˆ‘ä¹Ÿåªèƒ½æœ›è€Œå…´å¹äº†ã€‚&lt;/p>
&lt;h3 id="postgres-æ•°æ®åº“çš„ç´¢å¼•å±æ€§">postgres æ•°æ®åº“çš„ç´¢å¼•å±æ€§&lt;/h3>
&lt;p>å¯¹äºæ•°æ®åº“çš„å®ç°æˆ‘äº†è§£ä¸å¤šã€‚&lt;/p>
&lt;p>å¤§æ¦‚å°±æ˜¯å»ºç«‹ä¸ªç‹¬ç«‹çš„ B+ æ ‘ç´¢å¼•&amp;hellip;&amp;hellip;å§ï¼Ÿ&lt;/p>
&lt;h3 id="emmmmmm">emmmmmm&lt;/h3>
&lt;p>çœŸæƒ³ä¸å‡ºäº†&amp;hellip;&lt;/p>
&lt;h2 id="ç¬¬äº”æ‹›primary-key">ç¬¬äº”æ‹›ï¼šPrimary key&lt;/h2>
&lt;blockquote>
&lt;p>é¢è¯•å®˜ï¼šè¯´ä¸‹ä¸»é”®çš„ä½œç”¨ã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>æˆ‘ï¼šemmmmmm&amp;hellip;..&lt;/p>
&lt;/blockquote>
&lt;p>åˆ°è¿™é‡Œæˆ‘åŸºæœ¬å·²ç»èŒçš„ä¸è¡Œäº†ã€‚ï¼ˆæ— é”™å­—ï¼‰&lt;/p>
&lt;blockquote>
&lt;p>å†…å¿ƒ OSï¼šæˆ‘æ˜¯è°ï¼Ÿæˆ‘åœ¨å“ªï¼Ÿæˆ‘è¦å¹²ä»€ä¹ˆï¼Ÿ&lt;/p>
&lt;/blockquote>
&lt;p>ç”šè‡³è¿&lt;strong>zhujian&lt;/strong>éƒ½å¬æˆäº†&lt;strong>zujian&lt;/strong>&lt;/p>
&lt;p>è¢«é¢è¯•å®˜æé†’äº†ä¸€ä¸‹&lt;/p>
&lt;blockquote>
&lt;p>é¢è¯•å®˜ Bï¼šå°±æ˜¯é‚£ä¸ª &lt;strong>key&lt;/strong>&lt;/p>
&lt;/blockquote>
&lt;p>æˆ‘ä¹Ÿæ²¡ååº”è¿‡æ¥&amp;hellip;&amp;hellip;&lt;/p>
&lt;h3 id="æœ‰å•¥ç”¨å•Šå¤©çœŸè„¸">æœ‰å•¥ç”¨å•Šï¼ˆå¤©çœŸè„¸ï¼‰&lt;/h3>
&lt;p>ä¸»é”®çš„è¯ï¼Œå…·æœ‰å”¯ä¸€æ€§çš„ç´¢å¼•ï¼Ÿ&lt;/p>
&lt;p>emmmmmï¼Œä¸ç„¶è¿˜æœ‰ä»€ä¹ˆä½œç”¨å‘¢&amp;hellip;&amp;hellip;&lt;/p>
&lt;p>çœ‹æ¥æ•°æ®åº“å¿…é¡»ä¸‹åŠŸå¤«å­¦ä¸€å­¦æ‰è¡Œå•Š&amp;hellip;&amp;hellip;&lt;/p>
&lt;h2 id="å®å®å®you-fxxk-up">å®å®å®â€”â€”You fxxk up&lt;/h2>
&lt;blockquote>
&lt;p>é¢è¯•å®˜ï¼šååŠ¨ç„¶æ‹’ã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>æˆ‘ï¼šç†è§£ç†è§£ï¼Œè°¢è°¢è°¢è°¢ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>è¿˜è¡Œï¼Œå›é¡¾å®Œæ•´ä¸ªé¢è¯•æµç¨‹ï¼Œé™¤äº† C++éƒ¨åˆ†å¯èƒ½æ˜¯å› ä¸ºå‘æŒ¥å¤±å¸¸ä¹‹å¤–ï¼Œæ•°æ®åº“æ–¹é¢çš„ç¡®æ˜¯æ²¡æœ‰ä¸‹å¤ŸåŠŸå¤«ï¼Œä»¥è‡³äºè¿ç´¢å¼•å’Œ PrimaryKey è¿™ä¸¤é—®éƒ½åœ¨æŒç»­æ‡µé€¼ã€‚&lt;/p>
&lt;p>è€Œä¸”å®è¯è¯´é¢è¯•ï¼Œç¡®å®æœ‰æŠ€å·§è¿™å›äº‹&amp;hellip;&amp;hellip;&lt;/p>
&lt;p>é¢è¯•å®˜æçš„é—®é¢˜ä¹Ÿå­˜åœ¨ç€èŒƒå¼â€”â€”ç½‘ç»œä¸Šé¢è¯•çœŸé¢˜ä»€ä¹ˆçš„ï¼Œçœ‹èµ·æ¥åƒæ˜¯ç©ç¬‘ï¼Œä½†é¢è¯•å®˜æå‡ºè¿™äº›é—®é¢˜çš„æ—¶å€™å´æ˜¯è®¤çœŸçš„ã€‚&lt;/p>
&lt;p>å°½ç®¡&amp;hellip;&amp;hellip;è¿™ç§&lt;/p>
&lt;blockquote>
&lt;p>èŠèŠ xxxxï¼ˆæŸæŠ€æœ¯/æ¦‚å¿µ/å·¥å…·ï¼‰ï¼Œxxx çš„ä½œç”¨æ˜¯ä»€ä¹ˆ&lt;/p>
&lt;/blockquote>
&lt;p>çš„æé—®ç¡®å®è®©äººä¸å®¹æ˜“æŠ“ä½é‡ç‚¹&amp;hellip;&amp;hellip;&lt;/p>
&lt;p>è€ƒå¯ŸåŸºç¡€çš„è§’åº¦æ¥è¯´ï¼Œç°åœºç™½æ¿å†™ä¸€ä¸ªç¨‹åºï¼Œç„¶åå†æ·±å…¥èŠèŠè¿™ä¹ˆå†™çš„ç”¨æ„ï¼Œæœ‰æ²¡æœ‰ä¼˜åŒ–æ–¹æ¡ˆï¼Œè€ƒå¯Ÿå¯¹è¯­è¨€çš„ç†è§£å’Œ api è®¾è®¡ã€ä»£ç æ¶æ„èƒ½åŠ›ï¼Œæ¯”å•çº¯çš„è¯´è¯´ xxxï¼Œé—® xxx ä½œç”¨è¦å®é™…çš„å¤šã€‚å½“ç„¶å¹¶ä¸æ˜¯è¯´è¿™ä¹ˆé—®ä¸å¥½ï¼Œè¿™äº›æ¦‚å¿µçš„æŒæ¡ä¹Ÿæ˜¯éå¸¸é‡è¦çš„åŸºç¡€ï¼Œè€Œä¸”èƒ½æœ‰æ•ˆè€ƒå¯Ÿé¢è¯•è€…è¯­è¨€ç»„ç»‡èƒ½åŠ›å’Œå¯¹è¿™æ–¹é¢çŸ¥è¯†çš„æŒæ¡ç¨‹åº¦ã€‚&lt;/p>
&lt;p>å”¯ä¸€ä¸å¥½çš„å°±æ˜¯ï¼Œé¢è¯•è€…å’Œé¢è¯•å®˜èŠçš„è¿‡ç¨‹å°±åƒæ˜¯ç”¨&lt;strong>é»‘è¯&lt;/strong>äº¤æµä¸€æ ·&amp;hellip;&amp;hellip;&lt;/p>
&lt;p>ä¸è¯´äº†ï¼Œå­¦è¿™é»‘è¯å»&amp;hellip;&amp;hellip;&lt;/p></description></item></channel></rss>