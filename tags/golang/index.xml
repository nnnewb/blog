<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>golang on weakptr's ç¬”è®°</title><link>https://nnnewb.github.io/blog/tags/golang/</link><description>Recent content in golang on weakptr's ç¬”è®°</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Wed, 02 Mar 2022 12:30:00 +0800</lastBuildDate><atom:link href="https://nnnewb.github.io/blog/tags/golang/index.xml" rel="self" type="application/rss+xml"/><item><title>gokit æ¶æ„ä¹‹æˆ‘è§</title><link>https://nnnewb.github.io/blog/p/my-opinion-of-gokit-architecture/</link><pubDate>Wed, 02 Mar 2022 12:30:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/my-opinion-of-gokit-architecture/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>è¿™æ˜¯çœ‹äº† &lt;a class="link" href="https://github.com/go-kit/kit/issues/843" target="_blank" rel="noopener"
>Go kit: the road ahead&lt;/a> ä¹‹åï¼Œå¯¹ go kit è¿™å¥—æŠ½è±¡çš„ä¸€äº›æƒ³æ³•ã€‚ä¸»è¦æ˜¯å…³äº endpoint æ˜¯å¦æœ‰å¿…è¦ã€generic ä¼šå¦‚ä½•å½±å“ go kit çš„æ¶æ„ã€go kit çš„ä»£ç ç”Ÿæˆè¿™äº›é—®é¢˜ã€‚&lt;/p>
&lt;h2 id="endpoint-æŠ½è±¡å±‚æ˜¯å¦å¿…è¦å­˜åœ¨">endpoint æŠ½è±¡å±‚æ˜¯å¦å¿…è¦å­˜åœ¨&lt;/h2>
&lt;p>æˆ‘çš„çœ‹æ³•æ˜¯éœ€è¦ã€‚åŸå› ä¸‹é¢åˆ†æã€‚&lt;/p>
&lt;p>ä¸€ä¸ªæ²¡æœ‰é¢å¤–åŠŸèƒ½çš„ Endpoint å…¶å®æ˜¯èµ·åˆ°äº†æŠŠè¯·æ±‚ç±»å‹é€‚é…åˆ° Go å‡½æ•°ç­¾åçš„ä½œç”¨ã€‚&lt;a class="link" href="http://gokit.io/examples/stringsvc.html#endpoints" target="_blank" rel="noopener"
>stringsvc&lt;/a> å®ç°å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;context&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/go-kit/kit/endpoint&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">makeUppercaseEndpoint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">svc&lt;/span> &lt;span class="nx">StringService&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">endpoint&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Endpoint&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">_&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">request&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">req&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">request&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="nx">uppercaseRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">svc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Uppercase&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">S&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">uppercaseResponse&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">()},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">uppercaseResponse&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">makeCountEndpoint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">svc&lt;/span> &lt;span class="nx">StringService&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">endpoint&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Endpoint&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">_&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">request&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">req&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">request&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="nx">countRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">svc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Count&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">S&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">countResponse&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯¹äºå†™è¿‡ rpcx æˆ–è€… gRPC çš„æœ‹å‹æ¥è¯´ï¼ŒEndpoint æ›´åƒæ˜¯ä¸ªè„±è£¤å­æ”¾å±çš„å°è£…ã€‚åªè¦æŠŠæ¥å£å‚æ•°çº¦å®šæˆ &lt;code>func (ctx context.Context, req interface{}) (interface{}, error)&lt;/code> ä¸å°±å®Œäº†ï¼Ÿä¼ è¾“å±‚æ”¶åˆ°çš„è¯·æ±‚è§£ç æˆæœ¬åœ°æ•°æ®ç±»å‹ï¼Œç„¶åæŒ‰çº¦å®šä¼ å…¥ï¼Œå°±ä¸‡äº‹å¤§å‰äº†ã€‚&lt;/p>
&lt;p>ç©ºå£æ— å‡­ï¼Œä¸å¦‚çœ‹çœ‹å¦‚æœä¸è¦ endpointï¼Œå®é™…ç¼–å†™çš„ä»£ç ä¼šå˜æˆä»€ä¹ˆæ ·ã€‚&lt;/p>
&lt;p>åƒæ˜¯ go kit æä¾›çš„è¿™ç§å¸®åŠ©å‡½æ•°ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">uppercaseHandler&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">httptransport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewServer&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nf">makeUppercaseEndpoint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">svc&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">decodeUppercaseRequest&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">encodeResponse&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="nx">countHandler&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">httptransport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewServer&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nf">makeCountEndpoint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">svc&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">decodeCountRequest&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">encodeResponse&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯èƒ½å°±ä¼šå˜æˆè¿™æ ·ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">uppercaseHandler&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">httptransport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewServer&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">svc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Uppercase&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">decodeUppercaseRequest&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">encodeResponse&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="nx">countHandler&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">httptransport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewServer&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">svc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Count&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">decodeCountRequest&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">encodeResponse&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å½“ç„¶ï¼Œä¸ºäº†è®© Go è¯­è¨€çš„ç±»å‹ç³»ç»Ÿå¼€å¿ƒï¼Œè¿™é‡Œçš„ &lt;code>svc.Uppercase&lt;/code> å’Œ &lt;code>svc.Count&lt;/code> å¾—æ˜¯ä¸€æ ·çš„ç­¾åï¼Œæˆ–è€…ç”¨ &lt;code>interface{}&lt;/code> åšå½¢å‚ï¼Œåˆæˆ–è€…è€ƒè™‘è¿˜æ²¡æœ‰å‘å¸ƒçš„æ³›å‹èƒ½ä¸èƒ½æ”¯æŒã€‚&lt;/p>
&lt;p>çœ‹èµ·æ¥æ˜¯èˆ’æœäº†å¾ˆå¤šå¯¹å§ï¼ŸEndpoint æ²¡äº†ã€‚ä½†è¿˜æœ‰ä¸ªé—®é¢˜ï¼šä¸­é—´ä»¶ã€‚è¦æ€ä¹ˆå®ç°é€šç”¨çš„ä¸­é—´ä»¶ï¼Œåº”ç”¨åœ¨æ¯ä¸ªåŸæœ¬åº”è¯¥æ˜¯ Endpoint çš„åœ°æ–¹ï¼Ÿ&lt;/p>
&lt;p>ä¾‹å¦‚åœ¨å¾®æœåŠ¡ç³»ç»Ÿé‡Œå¾ˆå¸¸è§çš„åˆ†å¸ƒå¼è·Ÿè¸ªã€metricsæ”¶é›†ï¼Œæ— è®ºæœ€ç»ˆé‡‡ç”¨çš„æ˜¯ opentracingã€opencecusã€opentelemetry è¿˜æ˜¯ zipkinã€prometheusï¼Œè·Ÿè¸ªè°ƒç”¨é“¾è·¯æ˜¯ä¸€ä¸ªå¾ˆåŸºæœ¬çš„å¯è§‚æµ‹æ€§è¦æ±‚ã€‚å½“ç„¶ï¼Œä½ å¯ä»¥è¯´ç”¨ linkerd ä¸€ç±»çš„ service mesh è§£å†³æ–¹æ¡ˆï¼ˆè™½ç„¶æˆ‘è§‰å¾—ä¸èƒ½æ›¿ä»£ä¸Šé¢æåˆ°çš„è¿™äº›ä¸œè¥¿ï¼‰ï¼Œä½†ä¹Ÿåº”è¯¥æœ‰æ‰€è­¦æƒ•ï¼šæˆ‘ä»¬æ˜¯ä¸æ˜¯è¿˜æœ‰éœ€è¦åœ¨æ¯ä¸ªæ¥å£ä¸Šéƒ½æ‰§è¡Œã€å’Œä¼ è¾“å±‚æ— å…³çš„ä»£ç ï¼Ÿå¯¹ï¼Œè¿˜æœ‰èº«ä»½éªŒè¯å’Œé‰´æƒå·¥ä½œã€‚è¿˜æœ‰å—ï¼Ÿ&lt;/p>
&lt;p>å½“ç„¶ï¼Œä¹Ÿä¸æ˜¯è„±ç¦»äº† Endpoint å°±åˆ«æ— ä»–æ³•ï¼Œåªæ˜¯åœ¨éœ€è¦çš„æ—¶å€™ï¼Œæˆ‘æƒ³æ€»è¿˜æ˜¯ä¼šæœ‰æ„æ— æ„æŠ½è±¡å‡ºä¸€ä¸ªç±»ä¼¼ endpoint çš„å±‚çº§â€”â€”å¯èƒ½éšè—åœ¨ service ä¸­é—´ä»¶é‡Œï¼Œä¹Ÿå¯èƒ½äº¤ç»™äº†ä¼ è¾“å±‚ã€‚å¯èƒ½å†™å¾—æ›´å¥½ï¼Œä¹Ÿå¯èƒ½åˆæ˜¯åœ¨å †å±å±±ã€‚ç»éªŒå‘Šè¯‰æˆ‘åœ¨ä¸€ä¸ªéœ€è¦é•¿æœŸæ”¯æŒçš„ç³»ç»Ÿé‡Œï¼Œäººæ˜¯é ä¸ä½çš„ï¼Œä½†è§„èŒƒå¯ä»¥ã€‚endpoint å¹¶æ²¡æœ‰ç‰ºç‰²å¤šå°‘ç¼–ç ä¸Šçš„è‡ªç”±åº¦ï¼Œä½†ä¸€å®šç¨‹åº¦ä¸Šé¿å…äº†æ½œåœ¨çš„å †å±å¯èƒ½ï¼Œæˆ‘è§‰å¾—å®Œå…¨å¯ä»¥æ¥å—ã€‚&lt;/p>
&lt;h2 id="generic-ä¼šå¦‚ä½•å½±å“-go-kit-æ¶æ„">generic ä¼šå¦‚ä½•å½±å“ go kit æ¶æ„&lt;/h2>
&lt;p>æˆ‘ç›´è¯´ï¼ŒGo çš„æ³›å‹ï¼ˆbeta1ï¼‰å°±æ˜¯ä¸€æ³¡ç‹—å±ï¼Œæˆ‘å‘æ¥ä¸å–œæ¬¢ Go å›¢é˜Ÿçš„å“å‘³ï¼Œä» slice å’Œ interface{} æ³„éœ²è¯­è¨€çš„å®ç°ç»†èŠ‚åˆ°å…¶ä»–æ›´ç¦»è°±çš„ä¸œè¥¿ã€‚ä½†ç°åœ¨ Go æ³›å‹è¿˜æ²¡æœ‰æ­£å¼å…¬å¸ƒï¼ˆé¢„æœŸå°±åœ¨æœ¬æœˆï¼‰ï¼Œç°åœ¨æˆ‘ä¹Ÿæ²¡ä»€ä¹ˆå¥½è¯„è®ºçš„ã€‚&lt;/p>
&lt;p>generic ä¼šå½±å“ go kit çš„æ¶æ„å—ï¼Ÿæˆ‘çš„çœ‹æ³•æ˜¯ä¸ä¼šã€‚æ³›å‹ä¹Ÿè®¸èƒ½æå¤§å¸®åŠ©å„ç§å®¹å™¨ç±»å‹ã€è¿­ä»£å™¨ä¹‹ç±»é¥±å— &lt;code>interface{}&lt;/code> æŠ˜ç£¨çš„ç»„ä»¶ï¼Œä½†æ˜¯ go kit ç”¨å¾—ä¸Šæ³›å‹çš„åœ°æ–¹å…¶å®ä¸å¤šã€‚å°‘æ•°å¸¸è§çš„ &lt;code>interface{}&lt;/code> åœºåˆï¼Œéƒ½æ˜¯åœ¨ä»ä¸€ä¸ªç±»å‹é€‚é…åˆ°å¦ä¸€ä¸ªç±»å‹ï¼Œä»£ç ç¼–å†™è€…æ¸…æ¥šè‡ªå·±è¦å¤„ç†çš„ä¸¤ä¸ªç±»å‹ï¼Œä½† go kit ä¸çŸ¥é“ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">makeUppercaseEndpoint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">svc&lt;/span> &lt;span class="nx">StringService&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">endpoint&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Endpoint&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">_&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">request&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">req&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">request&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="nx">uppercaseRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">svc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Uppercase&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">S&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">uppercaseResponse&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">()},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">uppercaseResponse&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™éƒ¨åˆ†é€‚é…ä»£ç å¦‚æœæŠŠ &lt;code>interface{}&lt;/code> æ›¿æ¢æˆå…·ä½“çš„ &lt;code>uppercaseRequest&lt;/code> å’Œ &lt;code>uppercaseResponse&lt;/code> çš„è¯ï¼Œå°±éœ€è¦ go kit æä¾›æ³›å‹å½¢å¼çš„ Endpoint æ¥å£äº†ï¼Œåƒæ˜¯è¿™æ ·ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Endpoint&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">RequestType&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nx">ResponseType&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">RequestType&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ResponseType&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸Šé¢çš„ä»£ç æœ‰æ•ˆæ— æ•ˆå…ˆä¸è¯´ï¼Œæˆ‘è®°å¾—åœ¨ beta1 å°è¯•æ³›å‹çš„æ—¶å€™å‘ç° Go åœ¨æ¨æ–­ç±»å‹çš„æ—¶å€™å­˜åœ¨é—®é¢˜ï¼Œè¿™ä¸ª &lt;code>RequestType&lt;/code> å’Œ &lt;code>ResponseType&lt;/code> åœ¨å®é™…ç”¨çš„æ—¶å€™æ€•æ˜¯è¦å†™ä¸æ­¢ä¸€æ¬¡ã€‚åˆæ˜¯ Go ç‰¹è‰²çš„å•°å—¦ã€‚&lt;/p>
&lt;p>å¯å³ä¾¿æ˜¯è¿™æ ·ææ€•è¿˜æœ‰é—®é¢˜ï¼Œå¦‚æœä¿®æ”¹äº† &lt;code>Endpoint&lt;/code> çš„ç­¾åï¼Œé‚£ä¹ˆ &lt;code>endpoint.Middleware&lt;/code> ææ€•ä¹Ÿè¦æ³›å‹åŒ–ï¼ŒåŸæ¥çš„æ‰€æœ‰ä¸­é—´ä»¶åº“ï¼Œ&lt;code>trace&lt;/code>ã€&lt;code>auth&lt;/code>ã€&lt;code>metrics&lt;/code> å¯èƒ½ä¹Ÿå¾—åšæ³›å‹åŒ–æ”¹é€ ã€‚å¯¹ä¸€ä¸ªå·²ç»æ·±åº¦å¼€å‘è¿‡çš„ç³»ç»Ÿæ¥è¯´ï¼Œä¸ºäº†è¿™ä¸€ç‚¹ç±»å‹æ£€æŸ¥çš„å¥½å¤„ä»˜å‡ºå¦‚æ­¤ä»£ä»·ææ€•æ˜¯ä¸èƒ½æ¥å—çš„ã€‚&lt;/p>
&lt;p>æ€»è€Œè¨€ä¹‹ï¼Œæˆ‘çš„è§‚ç‚¹æ˜¯ Generic å¯èƒ½å¸¦æ¥å˜åŒ–ï¼Œä½†æ ¹æœ¬ä¸Šçš„å‡ ä¸ªæŠ½è±¡ä¸å¤§å¯èƒ½è·Ÿç€é‡æ„ï¼Œè¿™æ˜¯ç”± go kit æ€§è´¨å†³å®šçš„ã€‚&lt;/p>
&lt;h2 id="go-kit-ä»£ç ç”Ÿæˆ">go kit ä»£ç ç”Ÿæˆ&lt;/h2>
&lt;p>ä½†å‡¡è·Ÿç€ go kit å†™è¿‡ä¸€ä¸ª stringsvc çš„äººéƒ½ä¼šæ„Ÿè§‰åˆ° go kit æœ‰å¤šå°‘æ ·æ¿ä»£ç ï¼Œé€‚é…ä¼ è¾“å±‚éœ€è¦ç¼–å†™ encode/decodeï¼Œæœ¬åœ°ç»“æ„è½¬å‡½æ•°ç­¾åæ‰€éœ€çš„å‚æ•°åˆè¦ä¸€æ¬¡è½¬æ¢ï¼Œä¼ è¾“å±‚åè®®ç›‘å¬ã€æ³¨å†Œ&lt;code>Handler&lt;/code>ã€å®¢æˆ·ç«¯è¿æ¥éƒ½è¦è‡ªå·±ç¼–å†™ä»£ç ï¼Œæ„é€ å’Œæ³¨å†Œ &lt;code>Endpoint&lt;/code> å¤æ‚æ€§æ— éæ˜¯ä» &lt;code>func main&lt;/code> ç§»åŠ¨åˆ° &lt;code>transport&lt;/code> æˆ–è€…åè¿‡æ¥ï¼Œå°½ç®¡å¾ˆçƒ¦ï¼Œä½†åˆæ— æ³•æ ¹æœ¬ä¸Šæ¶ˆé™¤ã€‚&lt;/p>
&lt;p>å¦‚æœæ˜¯ C++ ææ€•ä¼šæœ‰æ¨¡æ¿å…ƒç¼–ç¨‹å¤§ä½¬æ™’è‡ªå·±çš„ &lt;code>template&lt;/code>ï¼Œä½† Go åŸºæœ¬æ²¡æœ‰ç¼–è¯‘æ—¶å’Œè¿è¡Œæ—¶çš„å…ƒç¼–ç¨‹èƒ½åŠ›ã€‚å”¯ä¸€æ¯”è¾ƒæ“…é•¿çš„å°±åªæœ‰ä¸ªä»£ç ç”Ÿæˆäº†ã€‚Go æä¾›çš„ &lt;code>ast/parser&lt;/code> åŒ…å¾ˆèµï¼Œåˆ«çš„è¯­è¨€å°‘æœ‰æä¾›è¿™ä¹ˆæ–¹ä¾¿çš„æ¥å£çš„ã€‚&lt;/p>
&lt;p>go kit çš„ä»£ç ç”Ÿæˆï¼Œä»ç›®å‰ä½“éªŒä¸­æ„Ÿå—æ¥çœ‹ï¼Œä¸»è¦æ˜¯éœ€è¦ä¸‹é¢çš„åŠŸèƒ½ï¼š&lt;/p>
&lt;ol>
&lt;li>ä» &lt;code>interface&lt;/code> å®šä¹‰ç”Ÿæˆå¯¹åº”çš„ &lt;code>makeEndpoint&lt;/code> å‡½æ•°å’Œè¯·æ±‚/å“åº”ç»“æ„ä½“ã€‚è¿™éƒ¨åˆ†ä»£ç åŸºæœ¬æ²¡ä»€ä¹ˆç‰¹åˆ«çš„ã€‚&lt;/li>
&lt;li>ä» &lt;code>interface&lt;/code> å®šä¹‰ç”Ÿæˆå¯¹åº”çš„ &lt;code>transport&lt;/code> åŒ…ï¼Œå¯ä»¥è‡ªå·±é€‰æ‹©åè®®ã€‚ä¸»è¦è§£å†³ encode/decode æ‰‹å†™éº»çƒ¦çš„é—®é¢˜ã€‚&lt;/li>
&lt;li>ä» &lt;code>interface&lt;/code> å®šä¹‰ç”ŸæˆæœåŠ¡æ„é€ å’Œå¯åŠ¨ä»£ç ï¼Œåº”ç”¨å¯ä»¥è‡ªå·±æ„é€ ï¼Œä½† &lt;code>endpoint&lt;/code> çš„æ„é€ å’Œ &lt;code>middleware&lt;/code> çš„åº”ç”¨å°±å¯ä»¥ä¸ç”¨è‡ªå·±å†™äº†ã€‚&lt;/li>
&lt;/ol>
&lt;p>è¿™ä¸‰å¤„çš„æ ·æ¿ä»£ç æœ€å¤šï¼Œè€Œä¸”ä»£ç æœ¬èº«å¹¶ä¸ç‰¹åˆ«ï¼Œéƒ½æ˜¯ç®€å•åœ°å¯¹ç±»å‹è¿›è¡Œé€‚é…ï¼Œæ‰‹å†™å®Œå…¨æ˜¯æµªè´¹æ—¶é—´ï¼Œè¿˜ä¼šå¼•å…¥äººä¸ºçš„ä¸ç¡®å®šæ€§ï¼Œä¸å¦‚è®©æœºå™¨æå®šã€‚ç›®å‰è€ƒå¯Ÿè¿‡çš„ &lt;a class="link" href="https://github.com/GrantZheng/kit" target="_blank" rel="noopener"
>kit&lt;/a> å®ç°äº†å…¶ä¸­ä¸€å¤§éƒ¨åˆ†ï¼Œä½† transport æ”¯æŒå¤ªå°‘ï¼Œä¹Ÿæ²¡æœ‰ç”Ÿæˆæ³¨å†Œ endpoint çš„ä»£ç ï¼Œä¾ç„¶å­˜åœ¨å¾ˆå¤šæ‰‹å†™çš„æ ·æ¿ä»£ç ã€‚æˆ‘ç®€å•çœ‹äº†ä¸‹å®ç°ï¼Œç”¨ &lt;a class="link" href="https://github.com/dave/jennifer" target="_blank" rel="noopener"
>jennifer&lt;/a> ç”Ÿæˆä»£ç å¥½æ˜¯æŒºå¥½ï¼Œå°±æ˜¯ go ä»£ç æ˜¾å¾—æœ‰ç‚¹ä¹± &amp;hellip;&lt;/p>
&lt;p>æˆ‘å¯»æ€å¯¹ generator ç®€å•é‡æ„ä¸‹å®ç°å…³æ³¨ç‚¹åˆ†ç¦»çš„è¯ï¼Œè¿˜æ˜¯èƒ½æ»¡è¶³ä¸Šé¢æåˆ°çš„è¿™äº›ä¸œè¥¿çš„ã€‚æœ€å¥½çš„æƒ…å†µæ˜¯å®šä¹‰å¥½ interface ä¹‹åï¼Œç”Ÿæˆä»£ç ï¼Œç¼–å†™ä¸»å‡½æ•°ï¼Œå°±èƒ½ç›´æ¥è¿è¡Œäº†ã€‚åŒæ—¶åˆä¸ä¼¤å®³ go kit æ¶æ„æœ¬èº«çš„æ‰©å±•æ€§å’Œå¯å®šåˆ¶æ€§ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>&lt;img src="https://nnnewb.github.io/blog/blog/p/my-opinion-of-gokit-architecture/image-20220302154943857.png"
width="420"
height="533"
srcset="https://nnnewb.github.io/blog/blog/p/my-opinion-of-gokit-architecture/image-20220302154943857_hu9cb516ff1b199527543c48b61b9d85b3_16922_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/my-opinion-of-gokit-architecture/image-20220302154943857_hu9cb516ff1b199527543c48b61b9d85b3_16922_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="go kitæ¶æ„çš„æœåŠ¡"
class="gallery-image"
data-flex-grow="78"
data-flex-basis="189px"
>&lt;/p>
&lt;p>è›®å–œæ¬¢ go kit é¡¹ç›®ä½œè€…çš„ä¸€å¥è¯ï¼š&lt;/p>
&lt;p>&lt;img src="https://nnnewb.github.io/blog/blog/p/my-opinion-of-gokit-architecture/image-20220302155216922.png"
width="917"
height="220"
srcset="https://nnnewb.github.io/blog/blog/p/my-opinion-of-gokit-architecture/image-20220302155216922_hu9feb75af39e108f8eeb86c8e5ed70db9_25876_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/my-opinion-of-gokit-architecture/image-20220302155216922_hu9feb75af39e108f8eeb86c8e5ed70db9_25876_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="issueæˆªå›¾"
class="gallery-image"
data-flex-grow="416"
data-flex-basis="1000px"
>&lt;/p>
&lt;blockquote>
&lt;p>Honestly the best way to &amp;ldquo;use&amp;rdquo; Go kit is to cop it&amp;rsquo;s architectural model and not actually import any of its packages at all ğŸ˜‰&lt;/p>
&lt;/blockquote>
&lt;p>å…¶å®æˆ‘ä¹Ÿæƒ³æŠŠè¿™å¥—æ¶æ„æ¬è¿›é¡¹ç›®é‡Œï¼Œå¯æƒœæ¡ä»¶ä¸å…è®¸ï¼Œè¿˜æœ‰æ›´ä¸¥é‡çš„é—®é¢˜è¦å¤„ç†ï¼Œåªèƒ½å…ˆçœ¼é¦‹ä¸€ä¸‹ï¼Œå¸æ”¶ä¸‹ç²¾ç¥ã€‚&lt;/p></description></item><item><title>go-kit ç¬”è®°</title><link>https://nnnewb.github.io/blog/p/go-kit-note/</link><pubDate>Tue, 01 Mar 2022 12:30:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/go-kit-note/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>åˆæ­¥çœ‹äº†ä¸‹ gokit çš„æ¡ˆä¾‹ &lt;code>stringsvc&lt;/code>å’Œ&lt;code>apigateway&lt;/code>ï¼Œè®°å½•ä¸€ä¸‹å¯¹ gokit çš„æ˜ åƒã€‚&lt;/p>
&lt;h2 id="gokitå®šä½">gokitå®šä½&lt;/h2>
&lt;blockquote>
&lt;p>&lt;strong>Go kit&lt;/strong> is a &lt;strong>programming toolkit&lt;/strong> for building microservices (or elegant monoliths) in Go. We solve common problems in distributed systems and application architecture so you can focus on delivering business value.&lt;/p>
&lt;p>Go has emerged as the language of the server, but it remains underrepresented in so-called &amp;ldquo;modern enterprise&amp;rdquo; companies like Facebook, Twitter, Netflix, and SoundCloud. Many of these organizations have turned to JVM-based stacks for their business logic, owing in large part to libraries and ecosystems that directly support their microservice architectures.&lt;/p>
&lt;p>To reach its next level of success, Go needs more than simple primitives and idioms. It needs a comprehensive toolkit, for coherent distributed programming in the large. Go kit is a set of packages and best practices, which provide a comprehensive, robust, and trustable way of building microservices for organizations of any size.&lt;/p>
&lt;/blockquote>
&lt;p>gokit å¤§æ¦‚ç®—æ˜¯æ¡†æ¶ï¼Œå› ä¸ºå’Œ gokit æ‰“äº¤é“åŸºæœ¬ç¦»ä¸å¼€ gokit å®šä¹‰çš„å‡ ä¸ªæ¥å£ç±»å‹ã€‚ç”¨ gokit å¼€å‘æœåŠ¡çš„å¯å®šåˆ¶æ€§å¾ˆå¼ºï¼Œå‡ ä¹æ¯ä¸ªç»†èŠ‚éƒ½å¯ä»¥æ§åˆ¶ã€‚&lt;/p>
&lt;p>è€Œå®é™…ä¸Šæ‰‹ä½“éªŒä¸‹æ¥ï¼Œç¼ºç‚¹å¤§æ¦‚å°±æ˜¯æµ·é‡çš„æ ·æ¿ä»£ç ï¼Œå®ç°ä¸€ä¸ªæœåŠ¡éœ€è¦å¤§é‡çš„é€‚é…ä»£ç æ¥æ§åˆ¶ Endpoint ã€‚åˆå› ä¸º Go è¯­è¨€è¡¨ç°åŠ›ä¸è¶³ï¼Œä¹Ÿæ²¡æœ‰è¿è¡Œæ—¶å…ƒç¼–ç¨‹çš„èƒ½åŠ›ï¼Œè¿™äº›æ ·æ¿ä»£ç åªèƒ½é ä»£ç ç”Ÿæˆæ¥è§£å†³ã€‚&lt;/p>
&lt;p>è¿˜å¥½ gokit è‡ªå·±ä¹ŸçŸ¥é“ï¼Œåœ¨ä»“åº“é¦–é¡µå°±æä¾›äº†å¾ˆå¤šä»£ç ç”Ÿæˆå™¨çš„é“¾æ¥ã€‚&lt;/p>
&lt;p>ç”¨ gokit è¿˜æœ‰ä¸€ä¸ªå¥½å¤„æ˜¯ä¸€å®šç¨‹åº¦ä¸Šé¿å…æŠ€æœ¯æ ˆç»‘å®šåœ¨æŸä¸ªç‰¹å®šå¹³å°æˆ–è€…æ¡†æ¶ä¸Šï¼Œæ¯•ç«Ÿ gokit æ¯”èµ·æ¡†æ¶ï¼Œæ›´åƒæ˜¯ä¸€ä¸ªå·¥å…·ç®±ï¼Œç»„ä»¶ä¹‹é—´æ²¡æœ‰ç‰¹åˆ«çš„ä¾èµ–å…³ç³»ï¼Œé¡ºæ‰‹å°±ç”¨ï¼Œä¸é¡ºæ‰‹å¯ä»¥æ¢ä¸ªé”¤å­ã€‚&lt;/p>
&lt;h2 id="æ¡†æ¶æ­å»º">æ¡†æ¶æ­å»º&lt;/h2>
&lt;h3 id="é¸Ÿç°">é¸Ÿç°&lt;/h3>
&lt;p>gokit ç¼–å†™çš„æœåŠ¡æœ‰å‡ ä¸ªåŸºæœ¬å…ƒç´ ï¼Œè¿™äº›åŸºæœ¬å…ƒç´ éƒ½æ˜¯å›´ç»• &lt;strong>Endpoint&lt;/strong> æ¥å£è½¬çš„ï¼Œgokit è‡ªå·±æŠŠ Endpoint ç§°ä¸º &lt;em>æ„å»ºæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çš„åŸºæœ¬å—&lt;/em> ã€‚&lt;/p>
&lt;p>å‡ ä¸ªåŸºæœ¬å…ƒç´ æ˜¯ï¼š&lt;/p>
&lt;ul>
&lt;li>æœåŠ¡æ¥å£å®šä¹‰ &lt;code>type StringService interface { /*...*/ }&lt;/code>&lt;/li>
&lt;li>åº”ç”¨çº§ä¸­é—´ä»¶å®šä¹‰ &lt;code>type AppMiddleware struct {} // implement StringService&lt;/code>&lt;/li>
&lt;li>ä¼ è¾“å±‚æ¥å£å®šä¹‰ï¼ŒåŒ…æ‹¬ &lt;code>Endpoint&lt;/code> å®šä¹‰ã€åºåˆ—åŒ–ã€æœåŠ¡å‘ç°ç­‰&lt;/li>
&lt;li>ä¼ è¾“å±‚ä¸­é—´ä»¶å®šä¹‰ï¼Œ&lt;code>type Middleware func(Endpoint) Endpoint&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>æ­¤å¤–è¿˜æœ‰ä¸€äº›å¯é€‰çš„ç»„ä»¶ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>tracing&lt;/code>ï¼Œåˆ†å¸ƒå¼è·Ÿè¸ª&lt;/li>
&lt;li>&lt;code>ratelimit&lt;/code>ï¼Œé™æµ&lt;/li>
&lt;li>&lt;code>metrics&lt;/code>ï¼ŒæŒ‡æ ‡æ”¶é›†&lt;/li>
&lt;li>&lt;code>log&lt;/code>ï¼Œæ—¥å¿—æ”¶é›†&lt;/li>
&lt;li>&lt;code>circuitbreaker&lt;/code>ï¼Œç†”æ–­&lt;/li>
&lt;li>&lt;code>auth&lt;/code>ï¼Œèº«ä»½è®¤è¯&lt;/li>
&lt;/ul>
&lt;p>æˆ‘è‡ªå·±æ•´çš„ç›®å½•ç»“æ„å¦‚ä¸‹ã€‚&lt;/p>
&lt;p>&lt;img src="https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220228155029310.png"
width="234"
height="255"
srcset="https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220228155029310_hu1b61ce4442b934d4130680e952a0c52e_9034_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220228155029310_hu1b61ce4442b934d4130680e952a0c52e_9034_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="ç›®å½•ç»“æ„"
class="gallery-image"
data-flex-grow="91"
data-flex-basis="220px"
>&lt;/p>
&lt;p>æœåŠ¡æœ¬è´¨æ˜¯ä¸€ç³»åˆ—æ¥å£çš„é›†åˆï¼Œgokit çš„ tutorial ä¸­å°†æœåŠ¡æŠ½è±¡æˆäº†ä¸€ä¸ª &lt;code>interface&lt;/code> ï¼Œåœ¨è¿™ä¸ªæ¥å£ä¸Šç”¨æˆ·å¯ä»¥æä¾›ä¸åŒå®ç°ã€‚åƒæ˜¯æœåŠ¡ç«¯ã€å®¢æˆ·ç«¯ã€ä¸­é—´ä»¶ï¼Œä¸ç®¡ä¼ è¾“å±‚æ€ä¹ˆå®šä¹‰ï¼Œæœ€ç»ˆå®ç°çš„éƒ½æ˜¯è¿™ä¸ªæ¥å£ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">StringService&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">Uppercase&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">Count&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¾®æœåŠ¡çš„å¼€å‘è€…æä¾›è¿™ä¸ªæ¥å£çš„å®ç°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">StringServiceImpl&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">StringServiceImpl&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Uppercase&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">arg&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">arg&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">strings&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ToUpper&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">arg&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">StringServiceImpl&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Count&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">arg&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">arg&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶åé€šè¿‡æŸç§ä¼ è¾“å±‚åè®®æš´éœ²ç»™è°ƒç”¨æ–¹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">MakeUppercaseEndpoint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">svc&lt;/span> &lt;span class="nx">stringsvc1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">StringService&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">endpoint&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Endpoint&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">request&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">req&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">request&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="nx">UppercaseRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">svc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Uppercase&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">S&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">UppercaseResponse&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">V&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// ... ç•¥
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">logger&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewLogfmtLogger&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stderr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">svc&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">stringsvc1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">StringServiceImpl&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">uppercase&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">transport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">MakeUppercaseEndpoint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">svc&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">uppercaseHandler&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">httptransport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewServer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">uppercase&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">transport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DecodeUppercaseRequest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">transport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">EncodeResponse&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Handle&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/uppercase&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">uppercaseHandler&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">count&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">transport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">MakeCountEndpoint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">svc&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">countHandler&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">httptransport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewServer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">count&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">transport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DecodeCountRequest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">transport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">EncodeResponse&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Handle&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/count&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">countHandler&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">logger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;msg&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;HTTP&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;addr&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;:8080&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">logger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;err&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ListenAndServe&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;:8080&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸€ä¸ªç®€å•çš„æœåŠ¡æä¾›æ–¹éœ€è¦åšçš„å°±æ˜¯è¿™äº›ã€‚ä¸‹é¢å…·ä½“çœ‹çœ‹å…¶ä¸­æ¶‰åŠçš„æ¦‚å¿µã€‚&lt;/p>
&lt;h3 id="endpoint-è§£æ">endpoint è§£æ&lt;/h3>
&lt;p>ä¸€ä¸ªæœ€ç®€å•çš„æœåŠ¡ &lt;code>Endpoint&lt;/code> å®šä¹‰å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;context&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;encoding/json&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;net/http&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;os&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;strings&amp;#34;&lt;/span>
&lt;span class="nx">httptransport&lt;/span> &lt;span class="s">&amp;#34;github.com/go-kit/kit/transport/http&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/go-kit/log&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">uppercaseRequest&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">S&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;s,omitempty&amp;#34;`&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">uppercaseResponse&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">S&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;s,omitempty&amp;#34;`&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">logger&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewLogfmtLogger&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stderr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Handle&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/uppercase&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">httptransport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewServer&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="c1">// endpoint å®šä¹‰
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">request&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">response&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">req&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">request&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="nx">uppercaseRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">S&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">uppercaseResponse&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">uppercaseResponse&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">strings&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ToUpper&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">S&lt;/span>&lt;span class="p">)},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="c1">// è¯·æ±‚ decoder
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">r&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">request&lt;/span> &lt;span class="nx">uppercaseRequest&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">json&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewDecoder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Body&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">request&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">request&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="c1">// å“åº” encoder
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">w&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ResponseWriter&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">response&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">json&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewEncoder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">w&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Encode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">response&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="p">))&lt;/span>
&lt;span class="nx">logger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;msg&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;HTTP&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;addr&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;:8080&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">logger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;err&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ListenAndServe&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;:8080&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>Endpoint&lt;/code> æœ¬è´¨æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œç±»å‹ç­¾åå¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// Endpoint is the fundamental building block of servers and clients.
&lt;/span>&lt;span class="c1">// It represents a single RPC method.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Endpoint&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">request&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">response&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>Endpoint&lt;/code> æŠ½è±¡äº† RPC è°ƒç”¨ï¼Œéšè—äº†è°ƒç”¨å¯¹è±¡æ˜¯â€œæœ¬åœ°â€è¿˜æ˜¯â€œè¿œç¨‹â€çš„ã€‚åƒæ˜¯ä¸Šé¢çš„æ¡ˆä¾‹é‡Œï¼Œ&lt;code>Endpoint&lt;/code> èƒŒåæ˜¯æœ¬åœ°çš„ä»£ç ã€‚è€Œåœ¨å®¢æˆ·ç«¯ä½¿ç”¨&lt;code>Endpoint&lt;/code>æ—¶ï¼Œ&lt;code>Endpoint&lt;/code>çš„èƒŒåå¾€å¾€æ˜¯ä¼ è¾“å±‚ä»£ç ï¼Œå‘èµ·äº†ä¸€æ¬¡è¿œç¨‹è°ƒç”¨ã€‚&lt;/p>
&lt;p>&lt;code>Endpoint&lt;/code> æœ¬èº«ä¸åšè¯·æ±‚/å“åº”çš„ç¼–è§£ç å·¥ä½œï¼Œè¿›å…¥ &lt;code>Endpoint&lt;/code> çš„éƒ½æ˜¯å·²ç»å‡†å¤‡å¥½çš„ç»“æ„åŒ–æ•°æ®ã€‚&lt;/p>
&lt;h3 id="endpointmiddleware-è§£æ">endpoint.Middleware è§£æ&lt;/h3>
&lt;p>&lt;code>endpoint.Middleware&lt;/code> æ˜¯åœ¨ &lt;code>Endpoint&lt;/code> ä¸ŠåŒ…è£…çš„ä¸­é—´ä»¶ï¼Œç­¾åå¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// Middleware is a chainable behavior modifier for endpoints.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Middleware&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Endpoint&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">Endpoint&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å’Œ &lt;code>gin&lt;/code> ä¹‹ç±»çš„æ¡†æ¶ä¸­é—´ä»¶ä½“ç³»å¾ˆç›¸ä¼¼ï¼Œéƒ½æ˜¯åŸºäºé«˜é˜¶å‡½æ•°çš„æ–¹å¼ã€‚ä¸€ä¸ªç®€å•çš„æ—¥å¿—ä¸­é—´ä»¶å®ç°å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;context&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/go-kit/kit/endpoint&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/go-kit/log&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">LoggingMiddleware&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">logger&lt;/span> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Logger&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">endpoint&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Middleware&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">next&lt;/span> &lt;span class="nx">endpoint&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Endpoint&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">endpoint&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Endpoint&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">request&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">logger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;msg&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;calling endpoint&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">logger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;msg&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;called endpoint&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nf">next&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">request&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åƒè¿™æ ·å®šä¹‰çš„ä¸­é—´ä»¶ç”¨æ³•ä¹Ÿå¾ˆç®€å•ï¼Œä»¥ &lt;code>Endpoint&lt;/code> ä¸ºå‚æ•°è°ƒç”¨å³å¯ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nf">LoggingMiddleware&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">With&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">logger&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;method&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;method-name&amp;#34;&lt;/span>&lt;span class="p">))(&lt;/span>&lt;span class="nx">endpoint&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¯´èµ·è¿™ä¸ªæˆ‘å°±æ€€å¿µ python çš„è£…é¥°å™¨ã€‚&lt;/p>
&lt;h3 id="åº”ç”¨ä¸­é—´ä»¶">åº”ç”¨ä¸­é—´ä»¶&lt;/h3>
&lt;p>åº”ç”¨ä¸­é—´ä»¶ä¸ç®—æ˜¯ gokit çš„ä¸€éƒ¨åˆ†ï¼Œgokit çš„ç¤ºä¾‹ä¸­ç»™å‡ºäº†&lt;a class="link" href="http://gokit.io/examples/stringsvc.html#application-logging" target="_blank" rel="noopener"
>åº”ç”¨çº§ä¸­é—´ä»¶çš„åšæ³•&lt;/a>ã€‚å®è¯è¯´æˆ‘ä¸å–œæ¬¢ã€‚&lt;/p>
&lt;p>æ‰€è°“çš„åº”ç”¨ä¸­é—´ä»¶åšæ³•å…¶å®å°±æ˜¯å†å®šä¹‰ä¸€ä¸ªç»“æ„ï¼Œå®ç°ä½ çš„æœåŠ¡æ¥å£ï¼Œç„¶ååœ¨å®ç°çš„æœåŠ¡æ¥å£é‡ŒåŠ ä¸Šéœ€è¦çš„ä¸­é—´ä»¶ä»£ç ã€‚&lt;/p>
&lt;p>å¦‚æœè¦è¯´æœ‰ä»€ä¹ˆå¥½å¤„çš„è¯ï¼Œå°±æ˜¯æ»¡è¶³äº†ç±»å‹çº¦æŸï¼Œå…å»äº†ç”¨ &lt;code>reflect&lt;/code>ã€‚&lt;code>Endpoint&lt;/code>ä¸€çº§çš„ä¸­é—´ä»¶åªèƒ½æ‹¿åˆ°ä¸€ä¸ª &lt;code>request interface{}&lt;/code> ï¼Œä½†ä¸‹é¢è¿™æ ·å†™çš„è¯ï¼Œå‚æ•°å°±æ˜¯å·²ç»å¡«å¥½çš„äº†ï¼ŒæœåŠ¡å®ç°é‡Œæ‹¿åˆ°ä»€ä¹ˆå‚æ•°è¿™ä¸ªä¸­é—´ä»¶å°±æ‹¿åˆ°ä»€ä¹ˆå‚æ•°ã€‚ä½†é—®é¢˜ä¹Ÿå¾ˆæ˜æ˜¾â€”â€”ä¸ºäº†æ»¡è¶³ &lt;code>type Service interface&lt;/code> çš„çº¦æŸï¼Œè¿™æ ·çš„ä¸­é—´ä»¶å¿…é¡»æŠŠæœåŠ¡çš„æ‰€æœ‰æ¥å£éƒ½å†™ä¸ª stub ã€‚å°±ç®—æ˜¯ç”¨ç¼–è¾‘å™¨çš„ &lt;code>generate interface stubs&lt;/code> åŠŸèƒ½ä¹Ÿæ²¡æ³•ç›´æ¥å¸®ä½ å¡«å¥½è½¬å‘å‚æ•°çš„ä»£ç å•Š&amp;hellip;&lt;/p>
&lt;p>æˆ‘è‡ªå·±å€’æ˜¯æŠ˜è…¾å‡ºä¸€ä¸ªæœ‰ç‚¹æ€ªçš„è§£æ³•ï¼Œåˆ©ç”¨ go çš„ embed å­—æ®µå’ŒåŠ¨æ€åˆ†å‘æœºåˆ¶ï¼Œéƒ¨åˆ†å®ç°äº†æœ‰ç»§æ‰¿çš„è¯­è¨€é‡Œçš„ override ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;play/stringsvc1&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/go-kit/log&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">LoggingMiddleware&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">stringsvc1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">StringService&lt;/span> &lt;span class="c1">// LoggingMiddleware è‡ªå·±æ²¡æœ‰å®ç°å…¨éƒ¨çš„ stringsvc1.StringService æ¥å£ï¼Œä½†è¿™ä¸ª embed å­—æ®µå®ç°äº†
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Logger&lt;/span> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Logger&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// è¿™ä¸ªå®ç°è¦†ç›–æ‰äº†ç»“æ„é‡Œçš„ stringsvc1.StringService.Uppercase æš´éœ²çš„å®ç°
&lt;/span>&lt;span class="c1">// ç„¶åå†…éƒ¨åˆä½¿ç”¨äº† `.StringService.Uppercase` è¿™ç§è¯­æ³•æ¥è°ƒç”¨ç»“æ„é‡Œçš„
&lt;/span>&lt;span class="c1">// stringsvc1.StringService.Uppercase å®ç°
&lt;/span>&lt;span class="c1">// å°±åƒæ˜¯æœ‰ç»§æ‰¿çš„è¯­è¨€é‡Œå­ç±»é€šè¿‡ super() æˆ–è€… ParentClass::Uppercase è¿™æ ·çš„æ–¹å¼è°ƒç”¨çˆ¶ç±»å®ç°ä¸€æ ·ã€‚
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">LoggingMiddleware&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Uppercase&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Logger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;msg&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;call endpoint&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;arg&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Logger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;msg&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;called endpoint&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;arg&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">StringService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Uppercase&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>é€šè¿‡è¿™ç§åŠæ³•å€’æ˜¯å®ç°äº†åº”ç”¨çº§çš„ç‰¹å®šæ¥å£ä¸­é—´ä»¶ã€‚ä½†è¿˜è¦å¦å¤–å®šä¹‰ä¸€ä¸ª &lt;code>struct&lt;/code> ä¹Ÿæ¯”è¾ƒéº»çƒ¦ã€‚&lt;/p>
&lt;p>è´´ä¸€ä¸‹ç¤ºä¾‹é‡Œçš„ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// middleware.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">loggingMiddleware&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">logger&lt;/span> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Logger&lt;/span>
&lt;span class="nx">next&lt;/span> &lt;span class="nx">StringService&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">mw&lt;/span> &lt;span class="nx">loggingMiddleware&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Uppercase&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">output&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">begin&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Time&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">mw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">logger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Log&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;method&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;uppercase&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s">&amp;#34;input&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s">&amp;#34;output&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">output&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s">&amp;#34;err&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s">&amp;#34;took&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Since&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">begin&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="p">}(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Now&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="nx">output&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">mw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">next&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Uppercase&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// main.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;os&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/go-kit/kit/log&amp;#34;&lt;/span>
&lt;span class="nx">httptransport&lt;/span> &lt;span class="s">&amp;#34;github.com/go-kit/kit/transport/http&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">logger&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewLogfmtLogger&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stderr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">svc&lt;/span> &lt;span class="nx">StringService&lt;/span>
&lt;span class="nx">svc&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">stringService&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">svc&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">loggingMiddleware&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">logger&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">svc&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="nx">uppercaseHandler&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">httptransport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewServer&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nf">makeUppercaseEndpoint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">svc&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å®¢æˆ·ç«¯å®ç°">å®¢æˆ·ç«¯å®ç°&lt;/h3>
&lt;p>å®¢æˆ·ç«¯å®ç°å¯ä»¥å¾ˆç®€å•ï¼ŒåŒæ ·æœ‰å¾ˆå¼ºçš„æ‰©å±•æ€§ã€‚æ¯”å¦‚è¯´å¯ä»¥ç»“åˆæœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€é¢‘ç‡é™åˆ¶ã€ç†”æ–­å™¨å®ç°ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„å®¢æˆ·ç«¯ã€‚&lt;/p>
&lt;p>å…ˆä»ç®€å•çš„å¼€å§‹ã€‚ä¸€èˆ¬è€ƒè™‘å®¢æˆ·ç«¯å®ç°çš„è¯ï¼Œä¼šå‡†å¤‡ä¸€ä¸ªç‰¹æ®Šçš„ç»“æ„æ¥ä¿å­˜æœåŠ¡çš„ &lt;code>Endpoint&lt;/code>ï¼Œå†å¯¹è¿™ä¸ªç»“æ„å®ç°æœåŠ¡å®šä¹‰çš„æ¥å£ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// https://github.com/go-kit/examples/blob/master/addsvc/pkg/addendpoint/set.go
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// Set collects all of the endpoints that compose an add service. It&amp;#39;s meant to
&lt;/span>&lt;span class="c1">// be used as a helper struct, to collect all of the endpoints into a single
&lt;/span>&lt;span class="c1">// parameter.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Set&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">SumEndpoint&lt;/span> &lt;span class="nx">endpoint&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Endpoint&lt;/span>
&lt;span class="nx">ConcatEndpoint&lt;/span> &lt;span class="nx">endpoint&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Endpoint&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Sum implements the service interface, so Set may be used as a service.
&lt;/span>&lt;span class="c1">// This is primarily useful in the context of a client library.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="nx">Set&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Sum&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">b&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">resp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SumEndpoint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">SumRequest&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">A&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">B&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">})&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">response&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">resp&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="nx">SumResponse&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">response&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">V&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">response&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// ... ç•¥
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ä¹ˆåšçš„å¥½å¤„æ˜¯å¯ä»¥åƒæ˜¯è°ƒç”¨ Go æ–¹æ³•ä¸€æ ·å»è°ƒç”¨ RPC å‡½æ•°ï¼Œæ¯”èµ· &lt;code>grpc&lt;/code> ä¸€ç±»çš„è°ƒç”¨æ–¹å¼æ¥è¯´æ›´ç›´è§‚äº†ã€‚&lt;/p>
&lt;p>å®¢æˆ·ç«¯çš„ &lt;code>Endpoint&lt;/code> çš„æ„é€ æ–¹å¼å’ŒæœåŠ¡å™¨ä¸ä¸€æ ·ï¼Œéšè—åœ¨ &lt;code>Endpoint&lt;/code> èƒŒåçš„ä¸æ˜¯æœ¬åœ°ä»£ç ï¼Œè€Œæ˜¯ä¸€ä¸ªç½‘ç»œè¯·æ±‚ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// Each individual endpoint is an http/transport.Client (which implements
&lt;/span>&lt;span class="c1">// endpoint.Endpoint) that gets wrapped with various middlewares. If you
&lt;/span>&lt;span class="c1">// made your own client library, you&amp;#39;d do this work there, so your server
&lt;/span>&lt;span class="c1">// could rely on a consistent set of client behavior.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">var&lt;/span> &lt;span class="nx">sumEndpoint&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">httptransport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewClient&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;POST&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nf">copyURL&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">u&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;/sum&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">encodeHTTPGenericRequest&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">decodeHTTPSumResponse&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">).&lt;/span>&lt;span class="nf">Endpoint&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>github.com/go-kit/kit/transport&lt;/code> è¿™ä¸ªåŒ…æä¾›äº†å¾ˆå¤šæœ‰ç”¨çš„åŠ©æ‰‹å‡½æ•°æ¥å¸®åŠ©æ„é€  &lt;code>Endpoint&lt;/code> ï¼Œä»¥åŠé»åˆæœåŠ¡ç«¯çš„ &lt;code>Endpoint&lt;/code> åˆ°ä¼ è¾“å±‚ä»£ç ã€‚ï¼ˆPSï¼šè¯·å›é¡¾å‰æ–‡ä¸­ä½¿ç”¨çš„ &lt;code>httptransport.NewServer&lt;/code>ï¼‰&lt;/p>
&lt;h3 id="æœåŠ¡å‘ç°">æœåŠ¡å‘ç°&lt;/h3>
&lt;p>å‚è€ƒ &lt;a class="link" href="https://github.com/go-kit/examples/blob/master/apigateway/main.go" target="_blank" rel="noopener"
>apigateway&lt;/a> çš„ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// Each method gets constructed with a factory. Factories take an
&lt;/span>&lt;span class="c1">// instance string, and return a specific endpoint. In the factory we
&lt;/span>&lt;span class="c1">// dial the instance string we get from Consul, and then leverage an
&lt;/span>&lt;span class="c1">// addsvc client package to construct a complete service. We can then
&lt;/span>&lt;span class="c1">// leverage the addsvc.Make{Sum,Concat}Endpoint constructors to convert
&lt;/span>&lt;span class="c1">// the complete service to specific endpoint.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">var&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">tags&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">passingOnly&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;span class="nx">endpoints&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">addendpoint&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Set&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">instancer&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">consulsd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewInstancer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">client&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">logger&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;addsvc&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">tags&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">passingOnly&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="nx">factory&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">addsvcFactory&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">addendpoint&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MakeSumEndpoint&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">tracer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">zipkinTracer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">logger&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">endpointer&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">sd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewEndpointer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">instancer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">factory&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">logger&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">balancer&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">lb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewRoundRobin&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">endpointer&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">retry&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">lb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Retry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">retryMax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">retryTimeout&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">balancer&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">endpoints&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SumEndpoint&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">retry&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220228171821569.png"
width="925"
height="573"
srcset="https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220228171821569_hude2acf9d66679c44454b1c6e5dc1473c_66465_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220228171821569_hude2acf9d66679c44454b1c6e5dc1473c_66465_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="ç¤ºæ„å›¾"
class="gallery-image"
data-flex-grow="161"
data-flex-basis="387px"
>&lt;/p>
&lt;p>æ€»å¾—æ¥è¯´ï¼Œgo kit çš„æœåŠ¡å‘ç°æœºåˆ¶é å®¢æˆ·ç«¯ä»¥ç‰¹å®šçš„æ–¹å¼æ„é€  &lt;code>Endpoint&lt;/code> ï¼Œè¿™å’Œåå‘ä»£ç†æˆ–è€… side-car ä»£ç†å®ç°çš„æœåŠ¡å‘ç°ä¸ä¸€æ ·ã€‚&lt;/p>
&lt;p>æ¯”å¦‚è¯´ kubernetes çš„ ClusterIP åŸºäº kube-proxyï¼Œåç«¯æœ‰å¤šä¸ª POD çš„æ—¶å€™ kube-proxy ä¼šè‡ªåŠ¨è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œä½†ç®—æ³•æ˜¯ kube-proxy å®ç°å†³å®šçš„ï¼Œä¸å¯ä¾èµ–ã€‚&lt;/p>
&lt;p>å†æ¯”å¦‚ nginx ä¹Ÿèƒ½ä¸€å®šç¨‹åº¦å®ç°æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ã€‚&lt;/p>
&lt;p>å†æ¯”å¦‚ï¼Œlinkerd è¿™æ ·çš„ service meshï¼Œéä¾µå…¥ï¼Œæä¾›è´Ÿè½½å‡è¡¡ã€æœåŠ¡å‘ç°ã€é‡è¯•è¿™äº›åŠŸèƒ½ã€‚&lt;/p>
&lt;p>go kit çš„å·¥å…·ç®±é‡Œæä¾›çš„æ˜¯å®¢æˆ·ç«¯çš„è´Ÿè½½å‡è¡¡æœºåˆ¶ã€‚ä¸Šå›¾é‡Œçš„ä»£ç å¯ä»¥ç”¨ä¸‹å›¾è¡¨ç¤ºã€‚&lt;/p>
&lt;p>&lt;img src="https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220228172730622.png"
width="574"
height="626"
srcset="https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220228172730622_hu7c2f12e783b3c572c3387446a921feeb_14775_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220228172730622_hu7c2f12e783b3c572c3387446a921feeb_14775_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="è´Ÿè½½å‡è¡¡"
class="gallery-image"
data-flex-grow="91"
data-flex-basis="220px"
>&lt;/p>
&lt;h3 id="å¤šä¼ è¾“å±‚å®ç°">å¤šä¼ è¾“å±‚å®ç°&lt;/h3>
&lt;p>è¿™é‡Œå°è¯•å®ç° &lt;code>http&lt;/code> å’Œ &lt;code>grpc&lt;/code> ä¸¤ç§ rpc ä¼ è¾“å±‚åè®®ã€‚é¦–å…ˆä¸ºäº†ä¿è¯æœ€å¤§åŒ–å¤ç”¨ä»£ç ï¼Œåœ¨ &lt;code>http&lt;/code> å®ç°ä¸­å®šä¹‰çš„ç»“æ„å’Œ endpoint è‚¯å®šæ˜¯è¦å¤ç”¨èµ·æ¥çš„ï¼Œä¸ç„¶æ¯ä¸ªä¼ è¾“å±‚éƒ½æ¥ä¸€æ¬¡çš„è¯æ²¡codegenéå¾—æ‰‹æŒ‡æ•²æ–­ä¸å¯ã€‚&lt;/p>
&lt;p>å…ˆæå– &lt;code>makeXXXEndpoint&lt;/code> ä»£ç å’Œ &lt;code>XXXRequest&lt;/code> è¿™æ ·çš„ç»“æ„åˆ°å•ç‹¬çš„æ–‡ä»¶é‡Œã€‚&lt;/p>
&lt;p>&lt;img src="https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220301115635464.png"
width="1920"
height="1040"
srcset="https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220301115635464_hu2db5290091178b734e80b60459e1fef9_216608_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220301115635464_hu2db5290091178b734e80b60459e1fef9_216608_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="æå–å®šä¹‰"
class="gallery-image"
data-flex-grow="184"
data-flex-basis="443px"
>&lt;/p>
&lt;p>æ€è·¯ä¸Šéƒ¨åˆ†å‚è€ƒçš„ gokit æ¡ˆä¾‹ä¸­ &lt;code>addsvc&lt;/code>ï¼Œ&lt;a class="link" href="https://github.com/go-kit/examples/blob/master/addsvc/README.md" target="_blank" rel="noopener"
>é“¾æ¥&lt;/a>ã€‚&lt;/p>
&lt;p>proto æ–‡ä»¶å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-protobuf" data-lang="protobuf">&lt;span class="c1">// play/stringsvc/transport/pb/stringsvc.proto
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">syntax&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;proto3&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">option&lt;/span> &lt;span class="n">go_package&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;play/stringsvc/transport/pb&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="kd">message&lt;/span> &lt;span class="nc">UppercaseRequest&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="n">s&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="kd">message&lt;/span> &lt;span class="nc">UppercaseResponse&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="n">v&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="kd">message&lt;/span> &lt;span class="nc">CountRequest&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="n">s&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="kd">message&lt;/span> &lt;span class="nc">CountResponse&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="kt">int32&lt;/span> &lt;span class="n">n&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="kd">service&lt;/span> &lt;span class="n">StringService&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="k">rpc&lt;/span> &lt;span class="n">Uppercase&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">UppercaseRequest&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">UppercaseResponse&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="k">rpc&lt;/span> &lt;span class="n">Count&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">CountRequest&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">CountResponse&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶åä½¿ç”¨ protoc ç”Ÿæˆ go æºç ï¼Œå…·ä½“å‚è€ƒ &lt;a class="link" href="https://www.grpc.io/docs/languages/go/quickstart/" target="_blank" rel="noopener"
>gRPC çš„å®˜æ–¹æ–‡æ¡£&lt;/a>ã€‚ç»§ç»­ä¸‹ä¸€æ­¥ä¹‹å‰è¦å…ˆäº†è§£ go è¯­è¨€çš„ gRPC æœåŠ¡æ¡†æ¶åœ¨ä¸€èˆ¬æƒ…å†µä¸‹æ€ä¹ˆå®ç°ã€‚åŒæ ·å»ºè®®ç›´æ¥çœ‹æ–‡æ¡£ã€‚ç®€å•è¯´å°±æ˜¯å†™ä¸€ä¸ªç»“æ„ï¼Œå®ç° protoc æ ¹æ®ä½ çš„ proto æ–‡ä»¶ç”Ÿæˆçš„æ¥å£ï¼Œæœ€åè°ƒç”¨æ³¨å†Œæ–¹æ³•æŠŠä½ çš„å®ç°æ³¨å†Œåˆ° gRPC æœåŠ¡å™¨ä¸Šå°±å¯ä»¥äº†ã€‚&lt;/p>
&lt;p>å†è€ƒè™‘è¯·æ±‚è¿›å…¥æˆ‘ä»¬çš„æœåŠ¡ä»£ç è¦ç»è¿‡çš„æµç¨‹ï¼ŒgRPC æ¥å£çš„å®ç°è¦åšäº‹æƒ…å…¶å®å°±æ˜¯æŠŠ proto å®šä¹‰çš„ç»“æ„è½¬æ¢æˆæˆ‘ä»¬ä¹‹å‰å®šä¹‰çš„ç»“æ„ï¼Œå†è°ƒç”¨ä¹‹å‰å®šä¹‰çš„ &lt;code>Endpoint&lt;/code> ã€‚&lt;/p>
&lt;p>&lt;img src="https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220301134821969.png"
width="437"
height="488"
srcset="https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220301134821969_huf9fd1139fbbfdafdb0f01166b9d50a9e_18354_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/go-kit-note/image-20220301134821969_huf9fd1139fbbfdafdb0f01166b9d50a9e_18354_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="gRPCä½œä¸ºä¼ è¾“å±‚åè®®çš„äº¤äº’æµç¨‹"
class="gallery-image"
data-flex-grow="89"
data-flex-basis="214px"
>&lt;/p>
&lt;p>å…¶ä¸­å¯¹è¯·æ±‚ç¼–è§£ç æ˜¯ä¸ªå¾ˆæ— èŠçš„è¿‡ç¨‹ï¼Œå­—æ®µä¸€ä¸€èµ‹å€¼å³å¯ã€‚endpoint ç»§ç»­å¤ç”¨å…ˆå‰ http çš„ç‰ˆæœ¬ã€‚gRPC å®ç°æ¯”è¾ƒå–å·§ï¼Œæˆ‘ä»¬æŠŠæ‰€æœ‰ &lt;code>Endpoint&lt;/code> æ”¾åˆ°ä¸€ä¸ªç»“æ„é‡Œä¿å­˜ï¼Œç„¶åå®ç° gRPC çš„æ¥å£ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;context&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;play/stringsvc&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;play/stringsvc/transport/pb&amp;#34;&lt;/span>
&lt;span class="nx">grpctransport&lt;/span> &lt;span class="s">&amp;#34;github.com/go-kit/kit/transport/grpc&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">set&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">*&lt;/span>&lt;span class="nx">pb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">UnimplementedStringServiceServer&lt;/span>
&lt;span class="nx">uppercase&lt;/span> &lt;span class="nx">grpctransport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Handler&lt;/span>
&lt;span class="nx">count&lt;/span> &lt;span class="nx">grpctransport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Handler&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewGRPCServer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">svc&lt;/span> &lt;span class="nx">stringsvc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">StringService&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">set&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">set&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">uppercase&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">grpctransport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewServer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nf">MakeUppercaseEndpoint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">svc&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">decodeUppercaseRequestGRPC&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">encodeUppercaseResponseGRPC&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">count&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">grpctransport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewServer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nf">MakeCountEndpoint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">svc&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">decodeCountRequestGRPC&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">encodeCountResponseGRPC&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">set&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Uppercase&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">pb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">UppercaseRequest&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">pb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">UppercaseResponse&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">resp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">uppercase&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ServeGRPC&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">resp&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">pb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">UppercaseResponse&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">set&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Count&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">pb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CountRequest&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">pb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CountResponse&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">resp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">count&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ServeGRPC&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">resp&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">pb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CountResponse&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œåˆ©ç”¨äº†ä¸€ä¸ª &lt;code>github.com/go-kit/kit/transport/grpc&lt;/code> çš„å¸®åŠ©ç»“æ„ï¼Œ&lt;code>grpctransport.NewServer&lt;/code> åˆ›å»ºçš„ &lt;code>grpctransport.Server&lt;/code>ã€‚è¿™ä¸ªç»“æ„çš„ç”¨é€”å’Œ &lt;code>httptransport.NewServer&lt;/code>ä¸€æ ·ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªé€‚é…å™¨ï¼ŒæŠŠ gRPC çš„è¾“å…¥é€‚é…åˆ°æˆ‘ä»¬å®šä¹‰çš„æœåŠ¡æ¥å£ã€‚ç†è®ºä¸Šæ¥è¯´ä¸ç”¨è¿™ç©æ„å„¿ä¹Ÿæ²¡äº‹ï¼Œä½†å®ç°ä»£ç é‡Œå°±è¦æ˜¾å¼è°ƒç”¨ &lt;code>Decode&lt;/code>å’Œ&lt;code>Encode&lt;/code>ã€‚ä»è§£è€¦çš„è§’åº¦æ¥è¯´è¿™ç§è®¾è®¡ä¼šæ›´å¥½ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>ä¹‹æ‰€ä»¥è¯´ gokit å¤§æ¦‚ç®—æ˜¯æ¡†æ¶ï¼Œæ˜¯å› ä¸º gokit æä¾›çš„è¿™äº›å·¥å…·å…¶å®æœ‰ä¸€å¥—è‡ªå·±çš„æœ€ä½³å®è·µï¼Œä½†å¹¶ä¸å¼ºè¿«éµå¾ªã€‚æ¯”å¦‚ transport å¹¶ä¸æ˜¯ä¸€å®šè¦ç”¨ gokit çš„ transport ï¼Œå®Œå…¨å¯ä»¥è‡ªå·±å†™ &lt;code>http.Handler&lt;/code> ï¼ŒæŠŠ encode/decode å†™åˆ°ä¸€èµ·ã€‚ä¹Ÿå¯ä»¥æŠŠå…¶ä»–æ–¹å¼ç¼–å†™çš„ RPC å°è£…æˆ &lt;code>Endpoint&lt;/code>ï¼Œè·å¾— gokit æä¾›çš„ä¸€ç³»åˆ—æ”¯æŒã€‚&lt;/p>
&lt;p>gokit æä¾›äº†å¾ˆå¤šæœ‰ç”¨çš„å·¥å…·ï¼Œè§£å†³ä¸€äº›è¯¸å¦‚æœåŠ¡å‘ç°ã€ç†”æ–­å™¨ã€åˆ†å¸ƒå¼è·Ÿè¸ªå’Œå¯è§‚æµ‹æ€§è¿™æ ·çš„é—®é¢˜ã€‚gokit çš„æ¡ˆä¾‹ä»£ç ç¤ºèŒƒçš„å®è·µæ–¹å¼ä¹Ÿå¾ˆæœ‰å¯å‘æ€§ã€‚&lt;/p></description></item><item><title>gRPC-Gateway ç”¨ä½œå¤šä¸ª gRPC æœåŠ¡çš„ç½‘å…³</title><link>https://nnnewb.github.io/blog/p/grpc-gateway-used-as-multiple-grpc-server-gateway/</link><pubDate>Wed, 23 Feb 2022 17:30:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/grpc-gateway-used-as-multiple-grpc-server-gateway/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒAPIç½‘å…³æ˜¯å¾®æœåŠ¡æ¶æ„çš„é‡è¦ç»„ä»¶ï¼Œèµ·åˆ°ä¸€ä¸ªæ•´æµè¿‡æ»¤çš„ä½œç”¨ã€‚è™½ç„¶ gRPC-Gateway è¦å•¥æ²¡å•¥ï¼Œå’Œ API ç½‘å…³çš„æ¨¡å¼ä¹Ÿæ‰¯ä¸ä¸Šå¤ªå¤šå…³ç³»ï¼Œä½†æ€»ä¹‹å…ˆèµ·ä¸ªé«˜è°ƒã€‚&lt;/p>
&lt;p>ç„¶åå°±æ˜¯çœŸæ­£é‡åˆ°çš„é—®é¢˜äº†ã€‚åœ¨æ—§çš„æ¶æ„é‡Œï¼ŒgRPC-Gateway çš„ç”¨æ³•ï¼Œæ˜¯å¯¹æ¯ä¸ªéœ€è¦æš´éœ² HTTP æœåŠ¡çš„ gRPC æœåŠ¡éƒ½èµ·ä¸€ä¸ªå¯¹åº”çš„ gRPC-Gateway ã€‚æœ€æ—©çš„åšæ³•æ˜¯ gRPC-Gateway æœåŠ¡å•ç‹¬ä½œä¸ºä¸€ä¸ª POD ï¼ŒgRPC æœåŠ¡å®ç°ä¹Ÿå•ç‹¬ä¸€ä¸ª POD ã€‚åæ¥æˆ‘æ”¹æˆäº† Gateway å’Œ æœåŠ¡åœ¨åŒä¸€ä¸ª POD å†…ï¼Œèµ·ä¸¤ä¸ª container ã€‚&lt;/p>
&lt;p>ä¹‹å‰çš„åšæ³•éƒ½å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ gRPC-Gateway è¦åˆ†é…å°‘é‡çš„ CPU å’Œå†…å­˜é…é¢ï¼Œè™½ç„¶æ¯ä¸ª gRPC-Gateway æœåŠ¡åˆ†åˆ°çš„å†…å­˜å’ŒCPUéƒ½å¾ˆå°‘ï¼Œä½†æ¶ä¸ä½æœåŠ¡å¤šï¼Œå†…å­˜å’Œ CPU çš„é…é¢éƒ½å ç”¨äº†ä¸å°‘ï¼Œå®é™…ç”¨åˆ°çš„å°‘å¾—å¯æ€œï¼Œå¤§éƒ¨åˆ†é…é¢éƒ½æ˜¯æµªè´¹ã€‚&lt;/p>
&lt;p>ä¸‹é¢å…·ä½“åˆ†æä¸‹æ€ä¹ˆæŠŠ gateway å•ç‹¬æå–æˆä¸€ä¸ª PODï¼Œç»™æ‰€æœ‰ gRPC æœåŠ¡å½“ç½‘å…³ï¼ŒåŒæ—¶ä¿æŒè´Ÿè½½å‡è¡¡å‘æŒ¥ä½œç”¨ï¼Œæä¾›æ— ç¼æ‰©å®¹ã€‚&lt;/p>
&lt;h2 id="å®ç°ç½‘å…³">å®ç°ç½‘å…³&lt;/h2>
&lt;h3 id="å®˜æ–¹demo">å®˜æ–¹demo&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// Create a client connection to the gRPC server we just started
&lt;/span>&lt;span class="c1">// This is where the gRPC-Gateway proxies the requests
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">conn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">grpc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">DialContext&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Background&lt;/span>&lt;span class="p">(),&lt;/span>
&lt;span class="s">&amp;#34;0.0.0.0:8080&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">grpc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithBlock&lt;/span>&lt;span class="p">(),&lt;/span>
&lt;span class="nx">grpc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithTransportCredentials&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">insecure&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewCredentials&lt;/span>&lt;span class="p">()),&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatalln&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Failed to dial server:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">gwmux&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">runtime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewServeMux&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="c1">// Register Greeter
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">helloworldpb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RegisterGreeterHandler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Background&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">gwmux&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatalln&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Failed to register gateway:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">gwServer&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Server&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Addr&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;:8090&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Handler&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">gwmux&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Serving gRPC-Gateway on http://0.0.0.0:8090&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatalln&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">gwServer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ListenAndServe&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ ¸å¿ƒé€»è¾‘åœ¨è¿™ä¸¤è¡Œï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">gwmux&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">runtime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewServeMux&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="c1">// Register Greeter
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">helloworldpb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RegisterGreeterHandler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Background&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">gwmux&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatalln&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Failed to register gateway:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>gwmux&lt;/code>æ˜¯ gRPC-Gateway çš„è¿è¡Œæ—¶ &lt;code>mux&lt;/code> å®ä¾‹ï¼Œå¯ä»¥ç†è§£æˆè·¯ç”±ã€‚ æ ‡å‡†åº“çš„ &lt;code>http&lt;/code> åŒ…ä¹Ÿæœ‰è‡ªå·±çš„ &lt;code>mux&lt;/code> ï¼Œä½† gRPC-Gateway é¡¹ç›®è‡ªå·±å®ç°äº†ä¸€ä¸ªã€‚çœ‹åˆ° &lt;code>gwmux&lt;/code>åº”è¯¥å°±èƒ½æƒ³åˆ°è¿™è‚¯å®šæ˜¯æ³¨å†Œè·¯ç”±ï¼Œç†è®ºä¸Šæ¥è¯´â€”â€”å¦‚æœä½ æœ‰å¤šä¸ª gRPC æœåŠ¡ï¼Œè€Œä¸” url æ²¡æœ‰å†²çªçš„è¯ï¼Œæ³¨å†Œå¤šä¸ªæœåŠ¡åˆ°è·¯ç”±ä¸Šåº”è¯¥æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚&lt;/p>
&lt;p>æ‰€ä»¥å‰©ä¸‹çš„é—®é¢˜å°±æ˜¯è¿™ä¸ª &lt;code>RegisterGreeterHandler&lt;/code> å†…æ˜¯ä¸æ˜¯æˆ‘ä»¬é¢„æœŸçš„é‚£æ ·ï¼Œç±»ä¼¼ &lt;code>mux&lt;/code> æ³¨å†Œè·¯ç”±çš„ç”¨æ³•ï¼Ÿ&lt;/p>
&lt;h3 id="registerxxxhandlerclient-å®ç°">RegisterXXXHandlerClient å®ç°&lt;/h3>
&lt;p>&lt;img src="https://nnnewb.github.io/blog/blog/p/grpc-gateway-used-as-multiple-grpc-server-gateway/image-20220222154718918.png"
width="1207"
height="132"
srcset="https://nnnewb.github.io/blog/blog/p/grpc-gateway-used-as-multiple-grpc-server-gateway/image-20220222154718918_huae7e9726eb83dcb6808b9604bde89ea7_31321_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/grpc-gateway-used-as-multiple-grpc-server-gateway/image-20220222154718918_huae7e9726eb83dcb6808b9604bde89ea7_31321_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="RegisterXXXHandlerClientå®ç°"
class="gallery-image"
data-flex-grow="914"
data-flex-basis="2194px"
>&lt;/p>
&lt;p>é¡ºç€ &lt;code>RegisterXXXHandler&lt;/code>å¾ˆå¿«å°±èƒ½æ‰¾åˆ°å®ç°ï¼Œ&lt;code>RegisterXXXHandlerClient&lt;/code>ã€‚&lt;code>Handle&lt;/code>çš„ç”¨æ³•æ­£å¦‚é¢„æœŸçš„é‚£æ ·ï¼Œæ˜¯ä¸€ä¸ªç±»ä¼¼ &lt;code>http.ServeMux&lt;/code> çš„å¯¹è±¡ã€‚å¤„ç†å‡½æ•°é‡Œçš„é€»è¾‘å¾ˆæ¸…æ™°ã€‚&lt;/p>
&lt;p>&lt;img src="https://nnnewb.github.io/blog/blog/p/grpc-gateway-used-as-multiple-grpc-server-gateway/image-20220222155630463.png"
width="1167"
height="420"
srcset="https://nnnewb.github.io/blog/blog/p/grpc-gateway-used-as-multiple-grpc-server-gateway/image-20220222155630463_hu5863f8bc3c05d0c34f00482d4fdc41e8_65629_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/grpc-gateway-used-as-multiple-grpc-server-gateway/image-20220222155630463_hu5863f8bc3c05d0c34f00482d4fdc41e8_65629_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="HandleFunc"
class="gallery-image"
data-flex-grow="277"
data-flex-basis="666px"
>&lt;/p>
&lt;p>å‡½æ•°ä½“å¯ä»¥ç®€å•åˆ’åˆ†æˆä¸¤éƒ¨åˆ†ï¼š&lt;/p>
&lt;ul>
&lt;li>æ„é€ å’Œå‘é€è¯·æ±‚
&lt;ul>
&lt;li>æ ¹æ®è¯·æ±‚çš„ &lt;code>Content-Type&lt;/code> é€‰æ‹© &lt;code>Marshaler&lt;/code> ã€‚&lt;/li>
&lt;li>æ„é€ è¯·æ±‚ä¸Šä¸‹æ–‡ï¼Œä»HTTPè¯·æ±‚é‡Œæå–&lt;code>grpc-metadata&lt;/code>å¼€å¤´çš„å…ƒæ•°æ®åˆ° &lt;code>context&lt;/code> é‡Œã€‚&lt;/li>
&lt;li>&lt;code>request_XXX_0&lt;/code> ååºåˆ—åŒ– HTTP è¯·æ±‚ä½“åˆ° protobuf ç”Ÿæˆçš„ç»“æ„ï¼Œå¹¶å‘é€è¯·æ±‚ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>æ„é€ å’Œè¿”å›å“åº”
&lt;ul>
&lt;li>ä»å“åº”å…ƒæ•°æ®é‡Œæ„é€ ä¸Šä¸‹æ–‡&lt;/li>
&lt;li>æ„é€ å’Œè¿”å› HTTP å“åº”&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>æ•´ä¸ªæµç¨‹æ˜¯æ— çŠ¶æ€ä¹Ÿå’Œ &lt;code>gwmux&lt;/code> æœ¬èº«æ— ç»‘å®šçš„ã€‚æ¢è¨€ä¹‹ï¼Œç†è®ºä¸Šæ¥è¯´å®Œå…¨å¯ä»¥æŠŠæ‰€æœ‰ gRPC-Gateway ç”Ÿæˆçš„ &lt;code>Register&lt;/code> å‡½æ•°æ³¨å†Œåˆ°åŒä¸€ä¸ª &lt;code>gwmux&lt;/code> ä¸Šã€‚&lt;/p>
&lt;h3 id="backendå’Œæ³¨å†Œ">Backendå’Œæ³¨å†Œ&lt;/h3>
&lt;p>å‡ºäºæ¸…æ™°åŒ–çš„è€ƒè™‘ï¼ŒGateway æœåŠ¡çš„æ„é€ è¿‡ç¨‹æˆ‘å†™æˆäº† Builder æ¨¡å¼ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">registerHandlerFn&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">mux&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">runtime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ServeMux&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">conn&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">grpc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ClientConn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">GRPCBackend&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">RegisterHandlerFunc&lt;/span> &lt;span class="nx">registerHandlerFn&lt;/span>
&lt;span class="nx">BackendAddr&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">DonviewGRPCGatewayServer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Serve&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">mux&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">runtime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewServeMux&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">muxOptions&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">backend&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">backends&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">conn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">grpc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">DialContext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">TODO&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">backend&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">BackendAddr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">dialOptions&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">backend&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RegisterHandlerFunc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">TODO&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">mux&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">handler&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Handler&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">mux&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">wrapperFn&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">httpHandlerWrappers&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">handler&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">wrapperFn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">handler&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ListenAndServe&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;0.0.0.0:%d&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">port&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">handler&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰€æœ‰ gRPC åç«¯è¢«æ³¨å†Œåˆ° &lt;code>s.backends&lt;/code> ï¼Œåœ¨å¼€å§‹æœåŠ¡çš„æ—¶å€™è°ƒç”¨ &lt;code>Serve&lt;/code> å‡½æ•°ï¼ŒæŠŠ gRPC æœåŠ¡æ³¨å†Œåˆ° &lt;code>mux&lt;/code> é‡Œã€‚å› ä¸ºäº‹å‰ç¡®ä¿äº†æœåŠ¡è·¯ç”±ä¸ä¼šé‡å ï¼Œç†è®ºä¸Šæ¥è¯´æ³¨å†Œå®Œå°±èƒ½ç”¨ã€‚&lt;/p>
&lt;h2 id="è´Ÿè½½å‡è¡¡">è´Ÿè½½å‡è¡¡&lt;/h2>
&lt;p>æœ€åˆçš„æ¶æ„é‡Œï¼Œä¸€ä¸ª gRPC-Gateway æœåŠ¡å¯¹åº”ä¸€ä¸ª gRPC æœåŠ¡ï¼Œè¯·æ±‚è¿›å…¥æœåŠ¡çš„è¿‡ç¨‹æ˜¯ä»äº‘æœåŠ¡æä¾›å•†çš„ LB =&amp;gt; kubernetes service (load balancer) =&amp;gt; gateway =&amp;gt; ClusterIP =&amp;gt; gRPC Server ã€‚&lt;/p>
&lt;p>åæ¥æ”¹æˆä¸€ä¸ª POD åŒ…å« gateway å’Œ gRPC ä¸¤ä¸ª container åï¼Œgateway è®¿é—® gRPC æœåŠ¡å°±ä¸åœ¨ç»è¿‡ ClusterIP è¿™ä¸€å±‚ä»£ç†äº†ï¼Œè·¯å¾„å˜æˆäº‘æœåŠ¡å•†çš„ LB =&amp;gt; kubernetes service (load balancer) =&amp;gt; gateway =&amp;gt; gRPC Server ã€‚&lt;/p>
&lt;p>æœ€åæ˜¯ç°åœ¨çš„ç‰ˆæœ¬ï¼Œç½‘å…³ç»Ÿä¸€æˆä¸€ä¸ªå®¹å™¨ï¼Œè·¯å¾„å’Œä¸Šè¿°ä¸€æ ·ã€‚&lt;/p>
&lt;p>ä¸‰è€…çš„åŒºåˆ«åœ¨äºè´Ÿè½½å‡è¡¡çš„æ—¶æœºã€‚Kubernetes çš„ ClusterIP æ˜¯åŒæ ·å…·å¤‡è´Ÿè½½å‡è¡¡èƒ½åŠ›çš„ï¼Œæœ€åˆæ¶æ„ä¸­è´Ÿè½½å‡è¡¡ä¸€å…±è¿›è¡Œäº†ä¸‰æ¬¡ï¼Œä»äº‘æœåŠ¡å•†çš„LBåˆ°ä¸»æœºç«¯å£ï¼ˆkubernetesï¼‰ï¼Œkuberneteså†æ¬¡è´Ÿè½½å‡è¡¡ï¼Œè½¬å‘åˆ° gatewayã€‚gatewayå†ç»ç”± ClusterIP è½¬å‘è‡³ gRPC æœåŠ¡ï¼Œæ¯ä¸€æ¬¡è½¬å‘éƒ½ç»å†ä¸€æ¬¡è´Ÿè½½å‡è¡¡ï¼Œåˆ†åˆ«æä¾›äº†è™šæ‹Ÿä¸»æœºçš„æ‰©å®¹èƒ½åŠ›ã€gatewayæœåŠ¡çš„æ‰©å®¹èƒ½åŠ›ã€gRPCæœåŠ¡çš„æ‰©å®¹èƒ½åŠ›ã€‚&lt;/p>
&lt;p>ç¬¬äºŒç‰ˆä¿®æ”¹å»æ‰äº† gateway åˆ° gRPC æœåŠ¡çš„è´Ÿè½½å‡è¡¡ï¼Œå˜æˆäº†ç›´è¿ï¼Œå»¶è¿Ÿè¡¨ç°ä¸Šç†è®ºä¸Šæ¥è¯´ä¼šæœ‰æ”¹å–„ï¼Œä½†æˆ‘æ²¡åšè¿‡åŸºå‡†æµ‹è¯•ï¼Œæ‰€ä»¥è¿™ä¸ªâ€œç†è®ºä¸Šâ€ä¹Ÿåªæ˜¯å‡­æ„Ÿè§‰è¯´ã€‚ä½†å¯ä»¥æ˜ç¡®çš„æ˜¯ gateway ä¼šé¢å¤–å æ®èµ„æºé…é¢ï¼Œé€ æˆæµªè´¹ï¼Œä¸å¥½è¯´å€¼ä¸å€¼ï¼Œä¸ªäººæ„Ÿè§‰æ²¡å¤ªå¤§æ„ä¹‰ã€‚&lt;/p>
&lt;p>ç¬¬ä¸‰ç‰ˆï¼Œç»Ÿä¸€äº† gatewayï¼Œè¿˜æ˜¯ä¸‰æ¬¡è´Ÿè½½å‡è¡¡ã€‚ä¸è¿‡Gatewayå¯¹èµ„æºé…é¢çš„ä½¿ç”¨æ•ˆç‡ä¼šæ›´å¥½ä¸€ç‚¹ï¼Œä¾ç„¶ä¿æŒäº†ä¸»æœºã€gatewayã€gRPC æœåŠ¡çš„å¯ä¼¸ç¼©æ€§ã€‚&lt;/p>
&lt;p>&lt;img src="https://nnnewb.github.io/blog/blog/p/grpc-gateway-used-as-multiple-grpc-server-gateway/image-20220222165344894.png"
width="176"
height="714"
srcset="https://nnnewb.github.io/blog/blog/p/grpc-gateway-used-as-multiple-grpc-server-gateway/image-20220222165344894_huca7a171cf394f94ea2cc15092e42ada3_10452_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/grpc-gateway-used-as-multiple-grpc-server-gateway/image-20220222165344894_huca7a171cf394f94ea2cc15092e42ada3_10452_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="ä¸‰æ¬¡LB"
class="gallery-image"
data-flex-grow="24"
data-flex-basis="59px"
>&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>å•ä»ç†è®ºä¸Šæ¥è¯´è¿™æ ·è®¾è®¡åº”è¯¥æ˜¯ OK çš„ï¼Œä½†æ˜¯ gRPC-Gateway å®˜æ–¹å¯¹è´Ÿè½½å‡è¡¡æ²¡æœ‰è¯´æ³•ï¼Œå¯¹èƒ½ä¸èƒ½æ³¨å†Œå¤šä¸ª gRPC æœåŠ¡åˆ°ä¸€ä¸ª &lt;code>mux&lt;/code> ä¸Šä¹Ÿæ²¡æœ‰å®˜æ–¹çš„æ–‡æ¡£è¯´æ˜ï¼Œå¾ˆéš¾è¯´è¿™å¸®äººèƒ½ä¸èƒ½ä¿è¯å‘åå…¼å®¹ï¼Œä¸‡ä¸€ä¹‹åçš„ç‰ˆæœ¬ä¸æ”¯æŒæ³¨å†Œåˆ°ä¸€ä¸ª &lt;code>mux&lt;/code> ä¸Šäº†ï¼Œåˆ°æ—¶å€™æ”¹èµ·æ¥å°±éº»çƒ¦äº†ï¼Œæ¯”è¾ƒåçš„æƒ…å†µå°±æ˜¯ä½ å¾—è‡ªå·±å†™ä¸€ä¸ª &lt;code>protoc-gen-gateway&lt;/code> è¿™æ ·çš„ç©æ„å„¿æ¥ç”Ÿæˆä¸€ä¸ªè‡ªå·±çš„ç½‘å…³ã€‚&lt;/p>
&lt;p>æ­¤å¤–è¿˜æœ‰ä¸€ä¸ªç¼ºé™·ï¼ŒgRPC-Gateway åˆ° gRPC Server çš„è´Ÿè½½å‡è¡¡ç”± Kubernetes ClusterIP æä¾›ï¼Œä½†æ˜¯ &lt;a class="link" href="https://stackoverflow.com/questions/49888133/kubernetes-service-cluster-ip-how-is-this-internally-load-balanced-across-diffe" target="_blank" rel="noopener"
>ClusterIP çš„è´Ÿè½½å‡è¡¡ç®—æ³•æ˜¯ Round Robin/Random&lt;/a> ï¼Œå¹¶ä¸æ”¯æŒæ ¹æ®è´Ÿè½½æˆ–å…¶ä»–ç»´åº¦çš„æµ‹é‡æ•°æ®æ¥å†³å®šå¦‚ä½•å‡è¡¡è´Ÿè½½ï¼Œæœªæ¥å¦‚æœéœ€è¦æ ¹æ®è´Ÿè½½æƒ…å†µåˆ†å‘è¯·æ±‚ï¼Œå¯èƒ½è¿˜å¾—åœ¨ç½‘å…³åˆ° gRPC æœåŠ¡ä¹‹é—´åŠ ä¸ªè´Ÿè½½å‡è¡¡ç»„ä»¶ï¼Œå†æä¾›ä¸€ä¸ªæœåŠ¡å‘ç°/æ³¨å†Œä¸­å¿ƒæ¥å¸®åŠ©è°ƒåº¦ã€‚&lt;/p></description></item><item><title>protogenä»£ç ç”Ÿæˆ</title><link>https://nnnewb.github.io/blog/p/protogen-code-generation/</link><pubDate>Mon, 21 Feb 2022 16:32:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/protogen-code-generation/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>æœ€å¤§çš„é—®é¢˜å…¶å®æ˜¯ proto ç›´æ¥ç”Ÿæˆçš„ swagger ä¸å¥½ç”¨ï¼Œè¿‡å»çš„ gRPC å†™æ³•åªåœ¨æœåŠ¡ç«¯ï¼Œå®¢æˆ·ç«¯æ²¡äº«å—åˆ°é™æ€ç±»å‹å®šä¹‰çš„æ¥å£çš„å¿«ä¹ï¼Œè€Œä¸”æ‰‹å·¥å†™çš„æ–‡æ¡£è¿˜æœ‰ä¸€å †å¾ˆæ— è¯­çš„é—®é¢˜ï¼Œæ•´ä¸ªç³»ç»Ÿç»´æŠ¤èµ·æ¥è›‹ç–¼æ— æ¯”ã€‚&lt;/p>
&lt;p>åæ¥è§£å†³åŠæ³•ä¹Ÿç®€å•ï¼Œä»£ç ç”Ÿæˆï¼Œç¼ºä»€ä¹ˆç”Ÿæˆä»€ä¹ˆï¼Œå…ˆåç»å†äº†ç”¨ &lt;code>go&lt;/code> + protoè§£æå†™æ”¹æˆç”¨ &lt;code>typescript&lt;/code> å†™ï¼Œå†æ”¹å› &lt;code>go&lt;/code> + &lt;code>protogen&lt;/code>ï¼Œä¸€ç•ªæŠ˜è…¾ä¸‹æ¥æœ€åè¿˜æ˜¯ç”¨ &lt;code>protogen&lt;/code> æœ€ç®€å•èˆ’æœã€‚&lt;/p>
&lt;p>è¿™ç¯‡åšå®¢ä¸»è¦å°±æ˜¯ä»‹ç»ä¸‹ &lt;code>protogen&lt;/code> é…ä¸Š go æ¨¡æ¿èƒ½åšåˆ°çš„äº‹æƒ…ã€‚&lt;/p>
&lt;h2 id="protogenä»‹ç»">&lt;code>protogen&lt;/code>ä»‹ç»&lt;/h2>
&lt;p>&lt;code>protogen&lt;/code>çš„å®˜æ–¹æ–‡æ¡£åœ¨&lt;a class="link" href="https://pkg.go.dev/google.golang.org/protobuf/compiler/protogen" target="_blank" rel="noopener"
>è¿™é‡Œ&lt;/a>ï¼Œ&lt;code>protogen&lt;/code>æ˜¯googleå®˜æ–¹&lt;code>protoc-gen-go&lt;/code>æ’ä»¶ä½¿ç”¨çš„æ”¯æŒåº“ï¼Œä»£ç æ‰˜ç®¡åœ¨&lt;a class="link" href="https://github.com/protocolbuffers/protobuf-go" target="_blank" rel="noopener"
>github.com/protocolbuffers/protobuf-go&lt;/a> ã€‚å¯ä»¥é€šè¿‡ &lt;a class="link" href="https://github.com/protocolbuffers/protobuf-go/blob/master/cmd/protoc-gen-go/main.go" target="_blank" rel="noopener"
>&lt;code>protoc-gen-go&lt;/code> çš„ &lt;code>main&lt;/code> åŒ…ä»£ç &lt;/a> åˆçª¥é—¨å¾„ã€‚&lt;/p>
&lt;p>ä¸è¿‡åœ¨å¼€å§‹å‰ï¼Œè¿˜å¾—å…ˆäº†è§£ä¸‹ &lt;code>protoc&lt;/code> æ’ä»¶æ˜¯æ€ä¹ˆå·¥ä½œçš„ã€‚ä»å®˜æ–¹æ–‡æ¡£&lt;a class="link" href="https://developers.google.com/protocol-buffers/docs/reference/other" target="_blank" rel="noopener"
>other languages and plugins&lt;/a>æ‘˜å½•å¦‚ä¸‹ã€‚&lt;/p>
&lt;blockquote>
&lt;p>&lt;code>protoc&lt;/code>, the Protocol Buffers Compiler, can be extended to support new languages via plugins. &lt;strong>A plugin is just a program which reads a&lt;/strong> &lt;code>CodeGeneratorRequest&lt;/code> &lt;strong>protocol buffer from standard input and then writes a&lt;/strong> &lt;code>CodeGeneratorResponse&lt;/code> &lt;strong>protocol buffer to standard output.&lt;/strong> These message types are defined in &lt;code>plugin.proto&lt;/code>. We recommend that all third-party code generators be written as plugins, as this allows all generators to provide a consistent interface and share a single parser implementation.&lt;/p>
&lt;/blockquote>
&lt;p>ç®€å•åœ°è¯´ï¼Œ&lt;code>protoc&lt;/code>æ’ä»¶ä»&lt;code>stdin&lt;/code>è¯»å–ä¸€ä¸ª&lt;code>protobuf&lt;/code>æ¶ˆæ¯ï¼Œå¾€&lt;code>stdout&lt;/code>å†™ä¸€ä¸ª&lt;code>protobuf&lt;/code>æ¶ˆæ¯ã€‚æŠŠ&lt;code>protoc&lt;/code>æ’ä»¶ç†è§£æˆæœåŠ¡å™¨ï¼Œ&lt;code>protoc&lt;/code>å‘é€è¯·æ±‚ï¼Œæ’ä»¶è¿”å›å“åº”ï¼Œäº¤äº’è¿‡ç¨‹ä¸ç»è¿‡ç½‘ç»œï¼Œè€Œæ˜¯æ ‡å‡†è¾“å…¥/è¾“å‡ºï¼Œå°±è¿™æ ·ã€‚&lt;/p>
&lt;p>æˆ‘ä¹Ÿä¸æƒ³è§£é‡Šä¸ºä»€ä¹ˆä¸ä»é›¶å¼€å§‹å†™äº†ã€‚&lt;code>protogen&lt;/code>æä¾›äº†ç›¸å½“å®Œå–„çš„å°è£…ï¼Œå¾ˆè½»æ¾å°±å¯ä»¥å†™å‡ºä¸€ä¸ªå®Œæ•´çš„ &lt;code>protoc&lt;/code> æ’ä»¶ã€‚&lt;/p>
&lt;h3 id="helloworld">HelloWorld&lt;/h3>
&lt;p>å…ˆæ¥ä¸ªæƒ¯ä¾‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;log&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;flags&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;google.golang.org/protobuf/compiler/protogen&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetFlags&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetPrefix&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;protoc-gen-hello: &amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">flags&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FlagSet&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Options&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">ParamFunc&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">flags&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Set&lt;/span>&lt;span class="p">}.&lt;/span>&lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Gen&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">Gen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">plugin&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Plugin&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Hello world&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»€ä¹ˆä¹Ÿä¸ç”Ÿæˆï¼Œå°±åªæ˜¯è¾“å‡ºä¸€å¥ Hello worldã€‚&lt;/p>
&lt;h3 id="ç®€å•ç”Ÿæˆ">ç®€å•ç”Ÿæˆ&lt;/h3>
&lt;p>ä¸€ä¸ªç®€å•çš„&lt;code>proto&lt;/code>æ–‡ä»¶ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-protobuf" data-lang="protobuf">&lt;span class="n">syntax&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;proto3&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">option&lt;/span> &lt;span class="n">go_package&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;play/proto&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="kd">message&lt;/span> &lt;span class="nc">Hello&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="kd">message&lt;/span> &lt;span class="nc">World&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="n">greeting&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="kd">service&lt;/span> &lt;span class="n">greeter&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="k">rpc&lt;/span> &lt;span class="n">SayHello&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Hello&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">World&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¾“å‡ºæ–‡ä»¶é‡Œæ‰€æœ‰çš„ç»“æ„ã€æœåŠ¡ã€RPCæ–¹æ³•åç§°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;flag&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;log&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;google.golang.org/protobuf/compiler/protogen&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetFlags&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetPrefix&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;protoc-gen-hello: &amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">flags&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FlagSet&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Options&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">ParamFunc&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">flags&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Set&lt;/span>&lt;span class="p">}.&lt;/span>&lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Gen&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">Gen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">plugin&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Plugin&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">filename&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">plugin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FileToGenerate&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">file&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">plugin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FilesByPath&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">filename&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">msg&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Messages&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;message: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">msg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Desc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">FullName&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">svc&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Services&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;service: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">svc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Desc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">FullName&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">method&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">svc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Methods&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;method: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">method&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Desc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">FullName&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹å‡ºæ¥ä½¿ç”¨éå¸¸ç®€å•ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯ &lt;code>message&lt;/code> æ˜¯å¯ä»¥åµŒå¥—çš„ï¼Œ&lt;code>message&lt;/code>å†…è¿˜èƒ½å®šä¹‰&lt;code>message&lt;/code>å’Œ&lt;code>enum&lt;/code>ï¼Œä¸Šé¢çš„ä¾‹å­æ²¡æœ‰å¤„ç†ã€‚&lt;/p>
&lt;p>æ¥ä¸‹æ¥æˆ‘ä»¬æŠŠå‘½ä»¤è¡Œè¾“å‡ºæ”¹æˆè¾“å‡ºåˆ°æ–‡ä»¶ï¼Œè®©ç¨‹åºæœ‰ç‚¹å®é™…ç”¨é€”ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;flag&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;log&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;path&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;strings&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;google.golang.org/protobuf/compiler/protogen&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetFlags&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetPrefix&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;protoc-gen-hello: &amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">flags&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FlagSet&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Options&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">ParamFunc&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">flags&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Set&lt;/span>&lt;span class="p">}.&lt;/span>&lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Gen&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">Gen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">plugin&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Plugin&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">filename&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">plugin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FileToGenerate&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">g&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">plugin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewGeneratedFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">strings&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ReplaceAll&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">path&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Base&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">filename&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="s">&amp;#34;.proto&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;.md&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;# API æ–‡æ¡£&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;## ç»“æ„å®šä¹‰&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">file&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">plugin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FilesByPath&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">filename&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">msg&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Messages&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;message: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">msg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Desc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">FullName&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;### &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">msg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Desc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Name&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">svc&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Services&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;## æœåŠ¡ &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">svc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Desc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">FullName&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;service: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">svc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Desc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">FullName&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">method&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">svc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Methods&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;method: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">method&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Desc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">FullName&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;### æ¥å£ &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">method&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Desc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Name&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ³¨æ„ä½¿ç”¨äº† &lt;code>plugin.NewGeneratedFile&lt;/code>è€Œä¸æ˜¯ç›´æ¥&lt;code>os.Open&lt;/code>ï¼Œå› ä¸ºè¿™æ˜¯&lt;code>protoc&lt;/code>æ’ä»¶çš„çº¦å®šä¹‹ä¸€ã€‚&lt;code>protoc&lt;/code>æ’ä»¶ç³»ç»Ÿå…è®¸æ’ä»¶æä¾›&lt;code>insert point&lt;/code>ï¼Œè®©åˆ«çš„æ’ä»¶ä¿®æ”¹æ’ä»¶ç”Ÿæˆçš„ä»£ç ã€‚ä¸è¿‡ç›®å‰æˆ‘ä»¬æ²¡æœ‰è¿™ç§åŠŸèƒ½ï¼Œä½†éµå¾ªçº¦å®šçš„æ–¹å¼æ¥ç¼–å†™ä»£ç æ€»æ˜¯æ²¡åå¤„çš„ã€‚&lt;/p>
&lt;p>ä»£ç é‡Œä¼šæœ‰å¾ˆå¤šæ²¡çœ‹æ‡‚çš„ä¸œè¥¿ï¼Œæ¯”å¦‚ &lt;code>Desc&lt;/code> ï¼Œå…¶å®æ˜¯&lt;code>Descriptor&lt;/code>çš„ç¼©å†™ã€‚&lt;code>Descriptor&lt;/code>æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œæˆ‘è‡ªå·±çš„ç²—æš´ç†è§£å°±æ˜¯&lt;code>Descriptor&lt;/code>â€œæè¿°â€å¯¹è±¡çš„ç»“æ„å’Œå±æ€§ï¼Œå€ŸåŠ©&lt;code>Descriptor&lt;/code>æ¥è®¿é—®å’Œä¿®æ”¹å¯¹è±¡ã€‚å¬èµ·æ¥åƒæ˜¯åå°„ï¼Œç”¨èµ·æ¥ä¹Ÿæ˜¯åå°„çš„æ„Ÿè§‰ã€‚åœ¨ Python é‡Œä¹Ÿæœ‰ä¸ª &lt;code>descriptor&lt;/code>ï¼Œ&lt;a class="link" href="https://docs.python.org/3/howto/descriptor.html" target="_blank" rel="noopener"
>Descriptor HowTo Guide&lt;/a>ï¼Œå’Œè¿™é‡Œçš„&lt;code>Descriptor&lt;/code>æœ‰ç›¸ä¼¼çš„åœ°æ–¹ï¼Œä»…ä¾›å‚è€ƒã€‚&lt;/p>
&lt;h3 id="æ¨¡æ¿åŒ–">æ¨¡æ¿åŒ–&lt;/h3>
&lt;p>è™½ç„¶ä¹Ÿèƒ½ç›´æ¥åœ¨ä»£ç é‡Œç”¨ &lt;code>g.P&lt;/code> å®Œæˆç”Ÿæˆå·¥ä½œï¼Œä½†æ˜¯æœªå…éº»çƒ¦ã€‚&lt;code>g.P&lt;/code>è¿™ä¸ªæ¥å£å®è¯è¯´æˆ‘è§‰å¾—ä¸è¡Œï¼Œæ€ä¹ˆä¸å®ç°ä¸€ä¸ª&lt;code>StringWriter&lt;/code>ã€‚&lt;/p>
&lt;p>è¿™é‡Œç”¨æ¨¡æ¿æœ€å¤§çš„å¥½å¤„æ˜¯èƒ½è½»æ¾åœ°å®Œæˆä¸€å¤§å †å­—ç¬¦ä¸²æ‹¼æ¥æ··åˆä¸€äº›ç®€å•çš„é€»è¾‘çš„æƒ…å†µï¼Œå¦‚æœç”¨ go ä»£ç å®ç°ä¼šéå¸¸å•°å—¦ã€‚&lt;/p>
&lt;p>å…ˆå±•ç¤ºä¸‹æˆ‘ä½¿ç”¨çš„æ¨¡æ¿ï¼Œä»£ç å¤ªç½—å—¦å°±ä¸è´´äº†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-markdown" data-lang="markdown">{{ define &amp;#34;message-link&amp;#34; -}}
{{ if .Message -}}
../../../{{ .Message.ParentFile.Path | base | replace &amp;#34;.proto&amp;#34; &amp;#34;&amp;#34; }}/types/{{ .Message.FullName | toString | replace &amp;#34;.&amp;#34; &amp;#34;_&amp;#34;}}/
{{- else if .Enum -}}
../../../{{ .Enum.ParentFile.Path | base | replace &amp;#34;.proto&amp;#34; &amp;#34;&amp;#34; }}/types/{{ .Enum.FullName | toString | replace &amp;#34;.&amp;#34; &amp;#34;_&amp;#34; }}/
{{- end }}
{{- end -}}
{{ define &amp;#34;message&amp;#34; -}}
&lt;span class="gs">**JSON:**&lt;/span>
&lt;span class="s">```json
&lt;/span>&lt;span class="s">&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="err">{&lt;/span> &lt;span class="err">.Desc&lt;/span> &lt;span class="err">|&lt;/span> &lt;span class="err">GenerateExample&lt;/span> &lt;span class="p">}&lt;/span>&lt;span class="err">}&lt;/span>
&lt;span class="s">```&lt;/span>
&lt;span class="gs">**å­—æ®µè¯´æ˜:**&lt;/span>
|å­—æ®µ|ç±»å‹|è¯´æ˜|
|----|----|----|
{{ range .Fields -}}
|`{{- .Desc.Name }}`|[`{{ template &amp;#34;field-type&amp;#34; .Desc }}`]({{template &amp;#34;message-link&amp;#34; .Desc }})|{{ .Comments | InlineMarkdownDocString | default &amp;#34;*æ­¤å­—æ®µæ²¡æœ‰æ–‡æ¡£æ³¨é‡Š*&amp;#34;}}|
{{ end }}
{{- end -}}
&lt;span class="gh"># {{ .Desc.FullName | toString | replace &amp;#34;.&amp;#34; &amp;#34;_&amp;#34; }}
&lt;/span>&lt;span class="gh">&lt;/span>
{{ template &amp;#34;message&amp;#34; . }}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ€ç»ˆç”Ÿæˆç»“æœå°±åƒæ˜¯è¿™æ ·ã€‚&lt;/p>
&lt;p>&lt;img src="https://nnnewb.github.io/blog/blog/p/protogen-code-generation/image-20220221161802205.png"
width="778"
height="404"
srcset="https://nnnewb.github.io/blog/blog/p/protogen-code-generation/image-20220221161802205_hu2efbed3d0c9645c8b3aebafcdc662339_25912_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/protogen-code-generation/image-20220221161802205_hu2efbed3d0c9645c8b3aebafcdc662339_25912_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="ç”Ÿæˆç»“æœ"
class="gallery-image"
data-flex-grow="192"
data-flex-basis="462px"
>&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>æœ¬èº«æ˜¯ä¸ªå¾ˆç®€å•çš„ä¸œè¥¿ã€‚åŸå…ˆç”¨è§£æprotoæ–‡ä»¶è¯­æ³•æ ‘å†ç”Ÿæˆæ–‡æ¡£çš„æ–¹æ³•ä¸æ˜¯ä¸è¡Œï¼Œä½†ä¸€æ¥ç¬¬ä¸‰æ–¹çš„è§£æåº“ç»å¸¸æœ‰ä¸æ”¯æŒçš„è¯­æ³•å’Œå¥‡æ€ªçš„bugï¼Œ&lt;code>protoc&lt;/code>æœ¬èº«åˆæ˜¯äº‹å®æ ‡å‡†ï¼Œå®˜æ–¹çš„ DSL Specification æ–‡æ¡£å°±æ˜¯ä¸ªåºŸç‰©æ–‡æ¡£ï¼Œè¿ &lt;code>option(http) {}&lt;/code> è¿™æ ·çš„éƒ½ç®—æ˜¯ specification ä¹‹å¤–ï¼Œè¿˜æœ‰ &lt;code>optional&lt;/code> åœ¨ proto3 è¿˜èƒ½ç”¨ä¹‹ç±»çš„è®©äººæƒ³éª‚å‚»é€¼çš„é—®é¢˜ã€‚&lt;/p>
&lt;p>åæ¥æ”¹æˆäº† &lt;code>typescript&lt;/code> + &lt;code>protobuf.js&lt;/code> ï¼Œå®˜æ–¹æ”¯æŒçš„ç¨³å®šæ€§ä¸€ä¸‹å­å°±å¥½å¤šäº†ï¼Œä½†è¿™ä¸ªè·‘èµ·æ¥æ€§èƒ½å®åœ¨æœ‰ç‚¹æ‹‰ï¼Œè€Œä¸” ts ç‰ˆæœ¬ç”¨äº† &lt;code>ejs&lt;/code> ä½œä¸ºæ¨¡æ¿å¼•æ“ï¼Œ&lt;code>ejs&lt;/code>çš„æ ‡ç­¾å†™èµ·æ¥ç½—å—¦åˆ°ä¸è¡Œï¼Œå†…åµŒ js çš„å†™æ³•ä¸€æ—¶çˆ½ï¼Œçˆ½å®Œè‡ªå·±éƒ½å¿«çœ‹ä¸æ‡‚å†™äº†ä»€ä¹ˆç©æ„å„¿äº†ã€‚&lt;/p>
&lt;p>æœ€åæ¢å› &lt;code>go&lt;/code>+&lt;code>protogen&lt;/code>ï¼Œä¸€ä¸‹å­å°±èˆ’æœå¤šäº†ã€‚&lt;/p></description></item><item><title>è®°ä¸€æ¬¡APIå“åº”æ—¶é—´ä¼˜åŒ–</title><link>https://nnnewb.github.io/blog/p/an-api-response-time-optimize/</link><pubDate>Fri, 31 Dec 2021 18:30:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/an-api-response-time-optimize/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>åˆšæ¥æ‰‹ç®¡ç†åå°çš„åç«¯æœåŠ¡ï¼Œå…ˆéšä¾¿æŒ‘ä¸ªä»€ä¹ˆä¸œè¥¿ä¸‹æ‰‹çœ‹çœ‹ã€‚æ­£å¥½æ³¨æ„åˆ°ä¸€ä¸ªç®€å•çš„æ¥å£è¿”å›æ—¶é—´éƒ½è›®é•¿çš„ï¼Œäºæ˜¯æ‹¿åˆšä» opentelemetry çš„ issue/pr é‡ŒæŠ„æ¥çš„ sqlmw åŒ…è£…é©±åŠ¨æ¥åˆ†æä¼˜åŒ–ä¸‹æ€§èƒ½ã€‚&lt;/p>
&lt;h2 id="0x01-æ€§èƒ½åˆ†æ">0x01 æ€§èƒ½åˆ†æ&lt;/h2>
&lt;h3 id="é¢„åˆ¤">é¢„åˆ¤&lt;/h3>
&lt;p>ä¸‹æ‰‹å‰é¢„ä¼°ä¸‹å¯èƒ½å­˜åœ¨ç“¶é¢ˆçš„åœ°æ–¹ã€‚å¯¹äºè¿™æ¬¡ä¸‹æ‰‹çš„æ¥å£ï¼ˆ&lt;code>get_users&lt;/code>ï¼‰ï¼Œæ•´ä¸ªå®ç°ä¹Ÿæ²¡å‡ è¡Œä»£ç ï¼Œåªæœ‰ä¸¤ä¸‰ä¸ªæŸ¥è¯¢ï¼Œæ•°æ®é‡ä¹Ÿä¸å¤§ï¼Œä½†æ˜¯è€—æ—¶æœ‰80ms+ã€‚&lt;/p>
&lt;p>å…¶ä»–æ¥å£æœ‰å¿«æœ‰æ…¢ï¼Œå¹¶æ²¡æœ‰è¡¨ç°å‡ºåŒæ—¶å¢åŠ è€—æ—¶ï¼Œè€Œä¸”å¼€å‘æœåŠ¡å™¨æ¶åœ¨å†…ç½‘ï¼Œæ’é™¤ç½‘ç»œåŸå› ï¼Œå¤§æ¦‚è¿˜æ˜¯æœåŠ¡æœ¬èº«çš„å­˜åœ¨çš„é—®é¢˜ã€‚äºæ˜¯è€ƒè™‘ç“¶é¢ˆåœ¨æ•°æ®åº“æˆ–ä»£ç ä¸­ï¼Œä½†å…·ä½“è‚¯å®šæ˜¯è¦çœ‹ä»£ç å»åˆ†æçš„ã€‚æ—¢ç„¶åˆ¤æ–­æ˜¯ä»£ç é‡Œçš„é—®é¢˜ï¼Œé‚£ä¸‹ä¸€æ­¥å°±æ˜¯æµ‹é‡ä¸‹è€—æ—¶æƒ…å†µäº†ã€‚&lt;/p>
&lt;p>å¯¹äºgoï¼Œ&lt;code>pprof&lt;/code>è™½ç„¶æ˜¯ä¸ªä¸é”™çš„ä¸»æ„ï¼Œä½†å®è¯è¯´éƒ¨ç½²åœ¨ kubernetes é‡Œï¼Œé… &lt;code>pprof&lt;/code> å»æ‹‰ç»“æœæœ‰ç‚¹éº»çƒ¦ï¼Œè€Œä¸”è¿˜æœ‰ç‚¹ç‚¹ç”¨ä¸æƒ¯ã€‚æ­£å¥½è¿™ä¸ªé¡¹ç›®é‡Œæ—©å°±é…ç½®äº† &lt;code>opentracing&lt;/code>+&lt;code>jaeger&lt;/code>åšåˆ†å¸ƒå¼è·Ÿè¸ªï¼Œæ‰€ä»¥å°±ç›´æ¥æŠ„ä¸€ä¸‹ opentelemetry çš„ &lt;a class="link" href="https://github.com/seslattery/otelsql/blob/master/otelsql.go" target="_blank" rel="noopener"
>otelsql&lt;/a> ï¼ŒæŠŠSQLæŸ¥è¯¢çš„è¯¦ç»†è€—æ—¶æƒ…å†µè®°å½•ä¸‹æ¥ï¼Œå°±å¯ä»¥å¼€å§‹åˆ†æäº†ã€‚&lt;/p>
&lt;h3 id="opentracingæ”¶é›†æ•°æ®">opentracingæ”¶é›†æ•°æ®&lt;/h3>
&lt;p>&lt;code>otelsql&lt;/code> åŸç†æ˜¯ç”¨ &lt;a class="link" href="https://github.com/ngrok/sqlmw" target="_blank" rel="noopener"
>sqlmw&lt;/a> åœ¨ sql é©±åŠ¨å±‚çº§ä¸Šè¿›è¡ŒåŒ…è£…&lt;code>sql ==&amp;gt; sqlmw.Driver{mysql.Driver}&lt;/code> ã€‚goçš„&lt;code>sql&lt;/code>è°ƒç”¨&lt;code>sqlmw.Driver&lt;/code>ï¼Œ&lt;code>sqlmw.Driver&lt;/code>è°ƒç”¨&lt;code>mysql.Driver&lt;/code>ï¼Œå¦‚æ­¤è€Œå·²ï¼Œå…·ä½“ä¸è§£é‡Šã€‚&lt;/p>
&lt;p>ä»&lt;code>otelsql&lt;/code>å€Ÿé‰´ä¸‹æ€è·¯å³å¯ï¼Œç°åœ¨ &lt;code>opentracing&lt;/code> å·²ç»å’Œ &lt;code>opencensus&lt;/code> åˆå¹¶æˆäº† &lt;code>opentelemetry&lt;/code>ï¼Œä½†é¡¹ç›®ä¹Ÿæ²¡æ³•è¯´å‡çº§å°±å‡çº§ï¼Œæ¯•ç«Ÿé¡¹ç›®æ¶æ„è®¾è®¡ç¨€çƒ‚ï¼Œå¤ªå¤šåœ°æ–¹å’Œ &lt;code>opentracing&lt;/code>ã€&lt;code>jaeger-client&lt;/code> å¼ºè€¦åˆäº†ã€‚æŠŠ&lt;code>otelsql&lt;/code>é‡Œç”¨&lt;code>sqlmw&lt;/code>çš„éƒ¨åˆ†æŠ„å‡ºæ¥ï¼Œæ”¹æˆ&lt;code>opentracing&lt;/code>çš„æ–¹å¼åˆ›å»º&lt;code>span&lt;/code>å®Œäº‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">in&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">sqlInterceptor&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">ConnExecContext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">conn&lt;/span> &lt;span class="nx">driver&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ExecerContext&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">query&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">args&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">driver&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NamedValue&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">driver&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">span&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ctx&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">opentracing&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">StartSpanFromContext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;ConnExecContext&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">span&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Finish&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">span&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">LogKV&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;sql.query&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">query&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ExecContext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">query&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">args&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦‚æ­¤ä¸€æ¥ï¼Œ å½“goçš„&lt;code>sql&lt;/code>åº“è®¿é—®æ•°æ®åº“çš„æ—¶å€™ï¼Œå°±ä¼šåœ¨&lt;code>jaeger&lt;/code>é‡Œè®°å½•ä¸€ä¸ª&lt;code>span&lt;/code>ï¼Œå¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°è€—æ—¶æƒ…å†µã€‚&lt;/p>
&lt;h3 id="åˆ†æ">åˆ†æ&lt;/h3>
&lt;p>&lt;img src="https://nnnewb.github.io/blog/blog/p/an-api-response-time-optimize/image-20211231103911728.png"
width="1166"
height="563"
srcset="https://nnnewb.github.io/blog/blog/p/an-api-response-time-optimize/image-20211231103911728_hu4ca051d63fb418ff00457f384002403d_37132_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/an-api-response-time-optimize/image-20211231103911728_hu4ca051d63fb418ff00457f384002403d_37132_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211231103911728"
class="gallery-image"
data-flex-grow="207"
data-flex-basis="497px"
>&lt;/p>
&lt;p>æ”¶é›†åˆ°è€—æ—¶æƒ…å†µåå¼€å§‹è§‚å¯Ÿï¼Œæ³¨æ„åˆ°ä¸¤ä¸ªé—®é¢˜ï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;code>ConnectorConnect&lt;/code> åœ¨æ¯ä¸ªè¯·æ±‚å‰å‡ºç°ï¼Œæ¯æ¬¡è€—æ—¶ 2ms å·¦å³ã€‚ä½† &lt;code>sql&lt;/code> æ˜¯æœ‰è¿æ¥æ± çš„ï¼Œè¿™é‡Œæ¯æ¬¡æ‰§è¡ŒæŸ¥è¯¢éƒ½äº§ç”Ÿä¸€æ¬¡è¿æ¥æ˜¾ç„¶ä¸å¯¹åŠ²ã€‚&lt;/li>
&lt;li>&lt;code>StmtQueryContext&lt;/code> å‡ºç°ä¸€ä¸ªè€—æ—¶æé•¿çš„æŸ¥è¯¢ï¼Œå æ®æ¥è¿‘1/2çš„è¯·æ±‚è€—æ—¶ï¼Œè¿™æ¡æŸ¥è¯¢å°±æ˜¯ä¸»è¦ç“¶é¢ˆã€‚&lt;/li>
&lt;/ol>
&lt;p>æ…¢æŸ¥è¯¢çš„SQLå¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">count&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">user&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">where&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">role&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">and&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">create_timestamp&lt;/span>&lt;span class="o">&amp;gt;?&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">and&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">create_timestamp&lt;/span>&lt;span class="o">&amp;lt;?&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ˜¯ä¸€ä¸ªç®€å•çš„ &lt;code>select count(1)&lt;/code> æŸ¥è¯¢ï¼Œåˆæ­¥è€ƒè™‘æ˜¯ &lt;code>where&lt;/code> é‡Œå°‘äº†ç´¢å¼•ã€‚&lt;/p>
&lt;h2 id="0x02-ä¼˜åŒ–">0x02 ä¼˜åŒ–&lt;/h2>
&lt;h3 id="ç´¢å¼•ä¼˜åŒ–">ç´¢å¼•ä¼˜åŒ–&lt;/h3>
&lt;p>æ—¢ç„¶å°‘ç´¢å¼•ï¼Œé‚£å°±è€ƒè™‘ä¸‹åŠ ç´¢å¼•ã€‚çœ‹äº†ä¸‹æ•°æ®åº“ï¼Œ&lt;code>role&lt;/code>å’Œ&lt;code>create_timestamp&lt;/code>å­—æ®µéƒ½æ²¡æœ‰ç´¢å¼•ï¼Œäºæ˜¯å…ˆåˆ†åˆ«åŠ ä¸Šäº†ç´¢å¼•ï¼Œå† &lt;code>explain&lt;/code> ï¼Œå‘ç°æŸ¥è¯¢ç±»å‹å·²ç»å˜æˆäº† &lt;code>ref&lt;/code> ã€‚å†è¿è¡ŒæŸ¥è¯¢ï¼Œå‘ç°è€—æ—¶ä¾ç„¶æœ‰ 20ms+ã€‚&lt;/p>
&lt;p>å‚è€ƒ &lt;a class="link" href="https://dev.mysql.com/doc/refman/5.7/en/multiple-column-indexes.html" target="_blank" rel="noopener"
>multiple-column index&lt;/a> ä¸­çš„è¯ï¼š&lt;/p>
&lt;blockquote>
&lt;p>MySQL can use multiple-column indexes for queries that test all the columns in the index, or queries that test just the first column, the first two columns, the first three columns, and so on. If you specify the columns in the right order in the index definition, a single composite index can speed up several kinds of queries on the same table.&lt;/p>
&lt;/blockquote>
&lt;p>æ–‡æ¡£ä¸­è¿˜è¯´ï¼š&lt;/p>
&lt;blockquote>
&lt;p>If a multiple-column index exists on &lt;code>col1&lt;/code> and &lt;code>col2&lt;/code>, the appropriate rows can be fetched directly. If separate single-column indexes exist on &lt;code>col1&lt;/code> and &lt;code>col2&lt;/code>, the optimizer attempts to use the Index Merge optimization (see &lt;a class="link" href="https://dev.mysql.com/doc/refman/5.7/en/index-merge-optimization.html" target="_blank" rel="noopener"
>Section 8.2.1.3, â€œIndex Merge Optimizationâ€&lt;/a>), or attempts to find the most restrictive index by deciding which index excludes more rows and using that index to fetch the rows.&lt;/p>
&lt;/blockquote>
&lt;p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœ&lt;code>role&lt;/code>å’Œ&lt;code>create_timestamp&lt;/code>åˆ†åˆ«æœ‰ç´¢å¼•ï¼Œ&lt;code>mysql&lt;/code>ä¼šå°è¯•ç”¨ &lt;em>Index Merge Optimization&lt;/em> ç®—æ³•æ¥ä¼˜åŒ–æŸ¥è¯¢ã€‚ä½†å¦‚æœæœ‰å¤šåˆ—ç´¢å¼•çš„è¯ï¼Œå°±èƒ½ç›´æ¥è·å–ï¼ˆæ–‡æ¡£é‡Œçš„åœºæ™¯èƒ½ç›´æ¥è·å–ï¼Œä½†ä¸Šæ–‡çš„ &lt;code>count(1)&lt;/code> æŸ¥è¯¢åº”è¯¥ä¸è¡Œï¼‰ã€‚&lt;/p>
&lt;p>äºæ˜¯åŠ ä¸Šå¤šåˆ—ç´¢å¼•ï¼Œå†&lt;code>explain&lt;/code>ï¼Œå‘ç°æŸ¥è¯¢ç±»å‹å˜æˆäº†&lt;code>range&lt;/code>ï¼Œå®é™…æ‰§è¡Œå‘ç°æŸ¥è¯¢è€—æ—¶é™ä½è‡³ 5ms å·¦å³ã€‚&lt;/p>
&lt;h3 id="è¿æ¥æ± ä¼˜åŒ–">è¿æ¥æ± ä¼˜åŒ–&lt;/h3>
&lt;p>goçš„&lt;code>sql&lt;/code>åŒ…è‡ªå¸¦è¿æ¥æ± åº”è¯¥æ˜¯æ¯”è¾ƒæ¸…æ¥šçš„ã€‚åŸæœ¬æ€€ç–‘æ˜¯ä¸æ˜¯å¯¹&lt;code>sql.DB&lt;/code>è¿™ä¸ªç»“æ„çš„ç”¨æ³•æœ‰é—®é¢˜ï¼Œä½†ç¿»äº†ä¸‹æºç ï¼Œå‘ç°&lt;code>sql.DB.ExecContext&lt;/code>ä¹‹ç±»çš„æ¥å£éƒ½ä¼šé€šè¿‡è¿æ¥æ± å–è¿æ¥ï¼Œå®Œæˆåè¿”å›è¿æ¥æ± ã€‚æ‰€ä»¥ç†è®ºä¸Šæ¥è¯´éƒ½åº”è¯¥èµ°è¿æ¥æ± çš„è¿æ¥ï¼Œè€Œä¸æ˜¯æ¯æ¬¡æŸ¥è¯¢éƒ½åˆ›å»ºâ€”â€”é™¤éè¿æ¥æ± é‡Œæ²¡æœ‰å¯ç”¨çš„è¿æ¥äº†ã€‚å¦å¤–ä¹Ÿè°·æ­Œäº†ä¸€åœˆï¼Œ&lt;code>sql.DB&lt;/code> ä¼¼ä¹ä¹Ÿæ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„æœ€ä½³å®è·µï¼Œå¹¶æ²¡æœ‰äººæåˆ°è¦æ‰‹åŠ¨&lt;code>DB.Conn&lt;/code>å–è¿æ¥åè‡ªå·±å¤„ç†ã€‚&lt;/p>
&lt;p>äºæ˜¯åˆæ­¥æ€€ç–‘ä¸‹æ˜¯ä¸æ˜¯å“ªé‡Œè®¾ç½®äº†è¿æ¥æ± å±æ€§å‡ºäº†é—®é¢˜ã€‚é€šè¿‡æ’æŸ¥æºç ä¸­è®¾ç½®è¿æ¥æ± å±æ€§çš„åœ°æ–¹ï¼Œå‘ç°ä¸€ä¸ªè‡ªå·±åŸ‹ä¸‹çš„å‘ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">if&lt;/span> &lt;span class="nx">env&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DEBUG&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">mysqldb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetMaxIdleConns&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">cfg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">mysql&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ParseDSN&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">host&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">cfg&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">mysql&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Config&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nf">StartObverseSQLConnPool&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">cfg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DBName&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">mysqlDB&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Duration&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å› ä¸ºæˆ‘å¸è¿™ä¸ªé¡¹ç›®æ²¡æœ‰é…ç½® metrics æ”¶é›†å’Œåˆ†æï¼Œè‡ªç„¶ä¹Ÿæ²¡æ”¶é›†æœåŠ¡çš„è¿æ¥æ± æƒ…å†µã€‚æ‰€ä»¥å½“åˆå…¥èŒåé‡åˆ°ä¸€ä¸ªå¥‡æ€ªçš„è¿æ¥æ± è€—å°½ï¼ŒæœåŠ¡å‡æ­»ï¼Œè°ƒç”¨æ ˆå…¨éƒ¨å¡åœ¨è¿æ¥æ± ä¸Šçš„é—®é¢˜æ—¶ï¼Œä¸ºäº†åˆ¤æ–­æ˜¯ä¸æ˜¯å‡ºç°è¿æ¥æ³„éœ²ï¼Œå†™äº†ä¸ªgoroutineå»ç›‘æµ‹è¿æ¥æ± é‡Œè¿æ¥è·å–å’Œé‡Šæ”¾çš„æƒ…å†µ&amp;hellip;&lt;/p>
&lt;p>ä¸ºäº†è°ƒè¯•æ–¹ä¾¿ï¼Œè¿˜æŠŠ&lt;code>SetMaxIdleConns&lt;/code>è®¾ç½®ä¸ºäº†0ã€‚&lt;/p>
&lt;p>äºæ˜¯åˆæ­¥æ€€ç–‘å°±æ˜¯è¿™ä¸ªåŸå› å¯¼è‡´è¿æ¥æ± ç½¢å·¥ï¼Œå°†æ•´æ®µè°ƒè¯•ä»£ç æ³¨é‡Šæ‰ä¹‹åï¼Œå†æ¬¡è®¿é—®æ¥å£ï¼Œå“åº”æ—¶é—´é™ä½è‡³9.8msã€‚&lt;/p>
&lt;p>&lt;img src="https://nnnewb.github.io/blog/blog/p/an-api-response-time-optimize/image-20211231110219407.png"
width="212"
height="111"
srcset="https://nnnewb.github.io/blog/blog/p/an-api-response-time-optimize/image-20211231110219407_hu55ac2a3a3dacd3b69ab961805df24cc9_3194_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/an-api-response-time-optimize/image-20211231110219407_hu55ac2a3a3dacd3b69ab961805df24cc9_3194_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211231110219407"
class="gallery-image"
data-flex-grow="190"
data-flex-basis="458px"
>&lt;/p>
&lt;p>æœ€å¤§å¤´çš„è€—æ—¶ä¾ç„¶æ˜¯&lt;code>count(1)&lt;/code>æŸ¥è¯¢ã€‚&lt;/p>
&lt;p>&lt;img src="https://nnnewb.github.io/blog/blog/p/an-api-response-time-optimize/image-20211231110316414.png"
width="1559"
height="438"
srcset="https://nnnewb.github.io/blog/blog/p/an-api-response-time-optimize/image-20211231110316414_hu2a272a2603430f6072c0c8e118d561d2_28788_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/an-api-response-time-optimize/image-20211231110316414_hu2a272a2603430f6072c0c8e118d561d2_28788_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211231110316414"
class="gallery-image"
data-flex-grow="355"
data-flex-basis="854px"
>&lt;/p>
&lt;p>é»˜è®¤æƒ…å†µä¸‹ IdleConn åªæœ‰ 2ï¼Œè¶…æ—¶ä¹Ÿæ¯”è¾ƒçŸ­ã€‚å®é™…å‚æ•°åº”è¯¥æ ¹æ®ä¸šåŠ¡è®¿é—®æƒ…å†µæ¥å®‰æ’ã€‚æˆ‘è¿™ä¹Ÿæ²¡ä»€ä¹ˆå¥½çš„è®¡ç®—å…¬å¼ã€‚è¿æ¥æ± å‚æ•°æœ‰é—®é¢˜ä¼šå½±å“å•æ¡SQLçš„åŸºæœ¬è€—æ—¶ï¼Œè¯·æ±‚é‡Œä¸‰å››æ¡æŸ¥è¯¢ï¼Œæ¯æ¡åŠ ä¸Šå‡ ä¸ªmsï¼Œæ•´ä¸ªè¯·æ±‚æ—¶é—´å°±æ‹–é•¿äº†åå‡ msã€‚åœ¨å¾®æœåŠ¡ç³»ç»Ÿé‡Œå½±å“è¿˜å¯èƒ½æ”¾å¤§ï¼Œåˆ«çš„æœåŠ¡è¦æ˜¯å¤šæ¬¡è°ƒç”¨ï¼Œç§¯ç´¯çš„æ—¶å»¶å¯èƒ½å°±è¦ä¸Šç™¾msäº†ã€‚&lt;/p>
&lt;h3 id="ç¼“å­˜ä¼˜åŒ–">ç¼“å­˜ä¼˜åŒ–&lt;/h3>
&lt;p>è¿›ä¸€æ­¥çš„ä¼˜åŒ–æ€è·¯å°±æ˜¯åšç¼“å­˜ã€‚æ˜¯ä¸ºäº†æé«˜æœåŠ¡å“åº”é€Ÿåº¦ï¼Œä¹Ÿæ˜¯ä¸ºäº†æé«˜è´Ÿè½½èƒ½åŠ›ã€å‡è½»æŸ¥è¯¢å‹åŠ›ï¼Œä¿æŠ¤ MySQL æœåŠ¡ã€‚è¿‡å»å¹´è½»æ— çŸ¥çŠ¯è¿‡é”™ï¼Œå°±æ˜¯è€ƒè™‘æ€§èƒ½çš„æ—¶å€™åªå…³æ³¨åˆ°äº†è‡ªå·±å†™çš„ä»£ç ï¼Œè®¤ä¸ºä»£ç è·‘å¾—å¿«é‡è¦â€”â€”æ¯”å¦‚æŠŠ C çš„æ‰§è¡Œæ€§èƒ½å¹ä¸Šå¤©ã€‚ä½†äº‹æƒ…ä»æ¥ä¸æ˜¯è¿™ä¹ˆç®€å•â€”â€”è¾©è¯æ³•è¯´å®äº‹æ±‚æ˜¯ï¼Œè¦å…·ä½“é—®é¢˜å…·ä½“åˆ†æã€‚åç«¯ä»æ¥ä¸æ˜¯â€œæˆ‘çš„ä»£ç â€è¿™ä¹ˆç®€å•ï¼Œå¦‚æœä¸èƒ½ä»æ•´ä¸ªç³»ç»Ÿçš„è§’åº¦å‡ºå‘å‘ç°é—®é¢˜ï¼Œé‚£å°±ç®—æ˜¯ CPU æˆç²¾äº†ä¹Ÿæ²¡è¾™ã€‚&lt;/p>
&lt;p>å¯¹äºå®æ—¶æ€§è¦æ±‚ä¸é«˜çš„æ¥å£ï¼Œå°†æ•°æ®ç¼“å­˜ä¸€æ®µæ—¶é—´æ˜¯ç»å¯¹æ²¡é—®é¢˜çš„ã€‚ä¸è¿‡å› ä¸ºåšç¼“å­˜æ˜¯ä¸ªç³»ç»Ÿæ€§çš„äº‹æƒ…â€”â€”è¦è€ƒè™‘ç¼“å­˜æ›´æ–°çš„å˜›ï¼Œä¹Ÿä¸æ˜¯æ¯ä¸ªæ¥å£éƒ½é€‚åˆç¼“å­˜ï¼Œå®æ—¶æ€§æœ‰è¦æ±‚æˆ–è€…æŸ¥è¯¢å¤ªå¤æ‚çš„è¯å®å¯è€ƒè™‘æ¢æˆ ES ä¸€ç±»çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼ŒæŠŠå‹åŠ›åˆ†æ‘Šåˆ°æ›´å¤šæœºå™¨ä¸Šã€‚å½“ç„¶ä¹Ÿæ„å‘³ç€è¦èŠ±æ›´å¤šçš„é’±ï¼Œæ›´éš¾ç»´æŠ¤ã€‚&lt;/p>
&lt;p>æˆ‘å¸é¡¹ç›®å°±æ˜¯ä¸ªå¾ˆæ²™é›•çš„ä¾‹å­ï¼Œå› ä¸ºæœ€åˆå°±æ²¡è®¾è®¡ç¼“å­˜ï¼Œè¿SQLéƒ½åœ¨ç”¨æ‰‹å·¥æ‹¼æ¥ï¼Œç°åœ¨å¹²è„†å˜æˆäº†æ··ç”¨ &lt;code>xorm&lt;/code> å’Œ &lt;code>sql&lt;/code>ã€‚è™½ç„¶ä¹Ÿå¯ä»¥è€ƒè™‘ä¸‹ç”¨ &lt;code>sqlmw&lt;/code> æ’ä¸ªç¼“å­˜ï¼Œä½†æ¯•ç«Ÿæ²¡éªŒè¯è¿‡ï¼Œåšç¬¬ä¸€ä¸ªåƒèƒèŸ¹çš„ä¹Ÿæ„å‘³ç€è¦ç¬¬ä¸€ä¸ªèƒŒé”…ã€‚&lt;/p>
&lt;p>æ€»ä¹‹ï¼Œè¦åšé‚£å¯ç®€å•äº†ï¼Œç›´æ¥è°ƒ &lt;code>redis&lt;/code> å®¢æˆ·ç«¯ï¼ˆå·²ç»åŒ…è£…è¿‡ä¸€ä¸ª &lt;code>cachetools&lt;/code>ï¼‰è®¾ç½®ä¸‹ç¼“å­˜ï¼Œç»™ä¸ªæ—¶é™å°±å®Œäº†ã€‚ç¼“å­˜è¿‡æœŸçš„æ—¶å€™åŠ ä¸ª &lt;code>redlock&lt;/code>ï¼Œè®©å…¶ä»–å®¢æˆ·ç«¯å…ˆè¿”å›æ—§æ•°æ®ï¼Œæ›´æ–°å®Œè§£é”ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯éƒ½è¿”å›æ–°æ•°æ®ã€‚&lt;/p>
&lt;p>æ›´ç³»ç»ŸåŒ–çš„å¤„ç†ï¼Œå°±è¦è€ƒè™‘ä¸‹æ€ä¹ˆåšä¸€ä¸ªæˆ–å¤šä¸ªæ›´é€šç”¨ï¼ˆå¯¹ä¸šåŠ¡åœºæ™¯è€Œè¨€æ›´é€šç”¨ï¼Œè€Œä¸æ˜¯çœŸçš„å¯¹ &lt;em>æ‰€æœ‰&lt;/em> åœºæ™¯éƒ½é€šç”¨ï¼‰çš„ç¼“å­˜å±‚â€”â€”åœ¨SQLé©±åŠ¨å±‚åšç¼“å­˜ï¼ŸORMå±‚ç¼“å­˜ï¼Ÿåœ¨è¯·æ±‚/å“åº”ä¸­åšç¼“å­˜ï¼Ÿä¸šåŠ¡/æ•°æ®è®¿é—®å±‚ï¼ˆå¦‚&lt;code>DAO&lt;/code>ï¼‰åšç¼“å­˜ï¼Ÿç¼“å­˜ç”¨ä»€ä¹ˆé”®ï¼Ÿæ€ä¹ˆè¦†ç›–å°½å¯èƒ½å¤šçš„æŸ¥è¯¢åœºæ™¯ï¼Ÿæ•´ä¸ªé‡æ„çš„å·¥ç¨‹é‡å¦‚ä½•æŠŠæ¡ï¼Ÿå€¼ä¸å€¼å¾—ï¼Ÿ&lt;/p>
&lt;h2 id="ç»“è®º">ç»“è®º&lt;/h2>
&lt;p>æ”¶é›†æ€§èƒ½æ•°æ®çš„ä¸»è¦æ–¹å¼ï¼š&lt;/p>
&lt;ul>
&lt;li>metrics&lt;/li>
&lt;li>pprof&lt;/li>
&lt;li>opentracing/opentelemetry&lt;/li>
&lt;/ul>
&lt;p>ä¼˜åŒ–æ‰‹æ®µï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>explain&lt;/code> åˆ†ææŸ¥è¯¢ã€ä¼˜åŒ–å’Œå»ºç«‹ç´¢å¼•&lt;/li>
&lt;li>ä¼˜åŒ–è¿æ¥æ± å‚æ•°&lt;/li>
&lt;li>åŠ ç¼“å­˜&lt;/li>
&lt;/ul>
&lt;p>è¿˜æœ‰æœ€é‡è¦çš„ï¼Œ&lt;strong>å…·ä½“é—®é¢˜å…·ä½“åˆ†æ&lt;/strong>ã€‚&lt;/p></description></item><item><title>åŸºäºæ ˆçš„è™šæ‹Ÿæœº</title><link>https://nnnewb.github.io/blog/p/stack-based-virtual-machine-for-minilang/</link><pubDate>Mon, 13 Dec 2021 16:20:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/stack-based-virtual-machine-for-minilang/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>ä¹‹å‰å†™äº†ä¸ªsè¡¨è¾¾å¼æ±‚å€¼å™¨ï¼Œå¾ˆç®€é™‹ï¼Œç›´æ¥åœ¨æŠ½è±¡è¯­æ³•æ ‘ä¸Šæ‰§è¡Œã€‚åªæ˜¯è¿™æ ·çš„è¯å…¶å®è¿˜æ²¡å•¥æ„æ€ï¼Œæ‰€ä»¥å†è¯•è¯•æ”¹è¿›æˆåœ¨åŸºäºæ ˆçš„è™šæ‹Ÿæœºä¸Šæ‰§è¡Œã€‚&lt;/p>
&lt;h2 id="0x01-è™šæ‹Ÿæœºæ¨¡å‹">0x01 è™šæ‹Ÿæœºæ¨¡å‹&lt;/h2>
&lt;p>é¦–å…ˆå¾—æ‰¿è®¤å¯¹è¿™äº›è¯­è¨€å±‚çº§çš„è™šæ‹Ÿæœºä¸ç†Ÿï¼ŒåŸºæœ¬æ˜¯éšä¾¿è®¾è®¡çš„ã€‚&lt;/p>
&lt;h3 id="å¯¹è±¡æ¨¡å‹">å¯¹è±¡æ¨¡å‹&lt;/h3>
&lt;p>è™šæ‹ŸæœºæŒ‡ä»¤æ“ä½œçš„ç›®æ ‡æ˜¯ &lt;strong>å¯¹è±¡&lt;/strong> ï¼ŒåŒ…æ‹¬å†…å»ºçš„å¯¹è±¡å’Œç”¨æˆ·å®šä¹‰çš„å¯¹è±¡ï¼Œè™šæ‹ŸæœºæŒ‡ä»¤æ“ä½œçš„åŸºæœ¬å•ä½ä¹Ÿæ˜¯å¯¹è±¡ã€‚&lt;/p>
&lt;p>ç›®å‰å…³æ³¨çš„æ˜¯å†…å»ºçš„å¯¹è±¡ï¼Œç®€å•æŠ½è±¡å‡ºäº†å‡ ä¸ªåŸºæœ¬ç±»å‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Object&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">TypeName&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">UInt&lt;/span> &lt;span class="kt">uint64&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">u&lt;/span> &lt;span class="nx">UInt&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">TypeName&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;UInt&amp;#34;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">Float&lt;/span> &lt;span class="kt">float64&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">f&lt;/span> &lt;span class="nx">Float&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">TypeName&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;Float&amp;#34;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">Boolean&lt;/span> &lt;span class="kt">bool&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">b&lt;/span> &lt;span class="nx">Boolean&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">TypeName&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;boolean&amp;#34;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">String&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="nx">String&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">TypeName&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;string&amp;#34;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">Symbol&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="nx">Symbol&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">TypeName&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;symbol&amp;#34;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">Nil&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span> &lt;span class="nx">Nil&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">TypeName&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;nil&amp;#34;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>çœç•¥äº†ä¸€éƒ¨åˆ†ï¼Œé¢†ä¼šç²¾ç¥å³å¯ã€‚ä¸Šé¢å®šä¹‰çš„ &lt;code>Symbol&lt;/code> ç±»å‹å…¶å®å°±æ˜¯ &lt;code>#ident&lt;/code> è¿™ç§è¯­æ³•å…ƒç´ ï¼Œç›®çš„æ˜¯ä¿æŒè¯­ä¹‰ä¸Šçš„ç®€æ´ã€‚&lt;/p>
&lt;p>æ¯”å¦‚è¯´ &lt;code>(let a b)&lt;/code>ï¼Œåœ¨ minilang é‡Œè§£é‡Šæˆä»¥&lt;code>a&lt;/code>å’Œ&lt;code>b&lt;/code>ä½œä¸ºå‚æ•°ï¼Œè°ƒç”¨&lt;code>let&lt;/code>å‡½æ•°ï¼Œ&lt;code>a&lt;/code>å’Œ&lt;code>b&lt;/code>éƒ½ä¼šè¢«æ±‚å€¼ã€‚&lt;code>let&lt;/code>æ˜¯ä¸€ä¸ªå†…ç½®å‡½æ•°ï¼Œåœ¨å½“å‰ç¯å¢ƒé‡Œå®šä¹‰ä¸€ä¸ªæ–°çš„å˜é‡å¹¶è®¾åˆå€¼ã€‚&lt;/p>
&lt;p>å¯å®é™…å†™ä»£ç çš„äººæƒ³è¦çš„å¯èƒ½æ˜¯ &lt;em>å®šä¹‰aï¼Œåˆå§‹åŒ–ä¸ºb&lt;/em>ã€‚è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬ä¸å¸Œæœ›&lt;code>a&lt;/code>è¢«æ±‚å€¼ï¼Œè€Œæ˜¯å­—é¢æ„æ€ï¼šæ ‡è¯†ç¬¦&lt;code>a&lt;/code>ï¼Œä¼ ç»™&lt;code>let&lt;/code>å‡½æ•°ã€‚è¿™ç§æƒ…å†µä¸‹å°±å¯ä»¥ç”¨ &lt;code>(let #a b)&lt;/code> ï¼Œ&lt;code>#a&lt;/code> è¡¨ç¤ºä¸€ä¸ª &lt;code>Symbol&lt;/code> ç±»å‹çš„å­—é¢é‡ã€‚&lt;/p>
&lt;p>æˆ–è®¸æœ‰äººä¼šæ³¨æ„åˆ°æœ¬è´¨ä¸Šæ¥è¯´&lt;code>#a&lt;/code>æ˜¯ä¸ªè¯­æ³•ç³–ï¼Œä¹Ÿå¯ä»¥è¢«å†™æˆ &lt;code>(quote &amp;quot;a&amp;quot;)&lt;/code> è¿™æ ·çš„å½¢å¼ã€‚&lt;code>quota&lt;/code> å®šä¹‰ä¸ºå°†å­—ç¬¦ä¸²æ„é€ æˆ &lt;code>Symbol&lt;/code> å¯¹è±¡çš„å‡½æ•°ã€‚&lt;/p>
&lt;h3 id="æŒ‡ä»¤é›†">æŒ‡ä»¤é›†&lt;/h3>
&lt;p>æœ‰äº†åŸºæœ¬çš„å¯¹è±¡æ¨¡å‹ï¼Œå†å®šä¹‰æœ€åŸºæœ¬çš„æŒ‡ä»¤ã€‚å› ä¸ºè€ƒè™‘å°†ä»£ç ä¹Ÿè§†ä½œæ•°æ®ï¼Œæ‰€ä»¥ç›®å‰çš„æƒ³æ³•è¿˜æ˜¯æŠŠæ§åˆ¶ç»“æ„ä¹Ÿåšæˆå†…ç½®å‡½æ•°ï¼Œå› æ­¤æŒ‡ä»¤é›†é‡Œä¸éœ€è¦å¤ªå¤šè½¬ç§»æŒ‡ä»¤ã€‚&lt;/p>
&lt;p>æš‚å®šçš„æŒ‡ä»¤é›†å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">OpCode&lt;/span> &lt;span class="kt">int32&lt;/span>
&lt;span class="kd">const&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">RESERVED&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">iota&lt;/span>
&lt;span class="c1">// CALL &amp;lt;STR&amp;gt;
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// å‹æ ˆä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œè·³è½¬åˆ°æŒ‡å®šä½ç½®
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">CALL&lt;/span>
&lt;span class="c1">// RET &amp;lt;OBJ&amp;gt;
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// å–æ ˆé¡¶çš„å¯¹è±¡ä½œä¸ºè·³è½¬åœ°å€ï¼Œå‹æ ˆè¿”å›å€¼
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">RET&lt;/span>
&lt;span class="c1">// LOAD &amp;lt;STR&amp;gt;
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// è¯»å–å±€éƒ¨ç¯å¢ƒé‡Œçš„å˜é‡å‹æ ˆ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">LOAD&lt;/span>
&lt;span class="c1">// PUSH &amp;lt;NUM&amp;gt;
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// å‹æ ˆå¯¹è±¡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">PUSH&lt;/span>
&lt;span class="c1">// POP &amp;lt;NUM&amp;gt;
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// å‡ºæ ˆä¸€å®šæ•°é‡çš„å¯¹è±¡ï¼Œå‡ºæ ˆçš„å¯¹è±¡ç›´æ¥ä¸¢å¼ƒ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">POP&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">o&lt;/span> &lt;span class="nx">OpCode&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">String&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="s">&amp;#34;RESERVED&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s">&amp;#34;CALL&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s">&amp;#34;RET&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s">&amp;#34;LOAD&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s">&amp;#34;PUSH&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s">&amp;#34;POP&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}[&lt;/span>&lt;span class="nx">o&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>é™¤äº†æœ€åˆçš„ &lt;code>RESERVED&lt;/code> æ˜¯æ•…æ„å ç”¨äº†é›¶å€¼ï¼Œå‰©ä¸‹çš„å°±æ˜¯æœ‰æ•ˆçš„æŒ‡ä»¤äº†ã€‚&lt;/p>
&lt;p>å†™è¿‡ x86 æ±‡ç¼–çš„è¯ä¼šçœ‹çš„å¾ˆä¸ä¹ æƒ¯ï¼Œå› ä¸ºå®Œå…¨æ²¡è€ƒè™‘å¯»å€ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;code>CALL&lt;/code> æŒ‡ä»¤çš„æ“ä½œæ•°å¯¹è±¡æ˜¯å­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œåœ¨æœ¬åœ°ç¯å¢ƒå¯»æ‰¾å¯¹åº”åç§°çš„å†…å»ºå‡½æ•°ï¼›
&lt;ul>
&lt;li>æˆ–è€…ï¼Œæ“ä½œæ•°æ˜¯ UINT çš„è¯ï¼Œå‹æ ˆä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€åè·³è½¬åˆ°æŒ‡å®šä½ç½®ï¼Œå’Œ x86 æ±‡ç¼–ç±»ä¼¼ï¼›&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;code>RET&lt;/code> æŠŠå½“å‰æ ˆé¡¶çš„å˜é‡(UINT)å½“æˆä¸‹ä¸€ä¸ªæŒ‡ä»¤çš„åœ°å€&lt;/li>
&lt;li>&lt;code>LOAD&lt;/code> åœ¨æœ¬åœ°ç¯å¢ƒå¯»æ‰¾å¯¹åº”åç§°çš„å˜é‡å‹æ ˆ&lt;/li>
&lt;/ul>
&lt;p>å‰©ä½™ç•¥ã€‚å…¶å®å¯ä»¥çœ‹å‡ºç›´æ¥å¯¹æœºå™¨ç¼–ç¨‹ä¸­çš„å¯»å€è¢«æ›¿æ¢æˆäº†æ ¹æ®å˜é‡åï¼ˆå­—ç¬¦ä¸²ï¼‰æŸ¥æ‰¾æœ¬åœ°ç¯å¢ƒï¼Œå¾ˆå¤šé«˜å±‚çº§çš„æ¦‚å¿µï¼ˆå¯¹è±¡ã€å­—ç¬¦ä¸²ï¼‰è¢«ç³…æ‚åœ¨é‡Œé¢ã€‚&lt;/p>
&lt;h2 id="0x02-ç¼–è¯‘">0x02 ç¼–è¯‘&lt;/h2>
&lt;p>æ¥ä¸‹æ¥æ˜¯æŠŠæŠ½è±¡è¯­æ³•æ ‘ç¿»è¯‘æˆæŒ‡ä»¤åºåˆ—ã€‚&lt;/p>
&lt;h3 id="å­—é¢é‡ç¿»è¯‘">å­—é¢é‡ç¿»è¯‘&lt;/h3>
&lt;p>å› ä¸º minilang çš„æŒ‡ä»¤ç›´æ¥æ“ä½œå¯¹è±¡ï¼Œæ‰€ä»¥èƒ½å¾ˆçœäº‹åœ°æŠŠå­—é¢é‡éƒ½æ„é€ æˆç›¸åº”åœ°å¯¹è±¡ã€‚å¯¹äºæ›´å¤æ‚çš„å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥ç¼–è¯‘æˆæ„é€ æŒ‡ä»¤ï¼Œå½“ç„¶ç›®å‰ä¸æ¶‰åŠã€‚&lt;/p>
&lt;p>ä¸¾ä¸ªä¾‹å­ï¼Œåˆ—è¡¨å­—é¢é‡ &lt;code>#(display hello)&lt;/code>ã€‚å¯ä»¥åœ¨ç¼–è¯‘è¿‡ç¨‹é‡Œç›´æ¥æ„é€ å‡º &lt;code>List&lt;/code> å¯¹è±¡ï¼Œç„¶åç”Ÿæˆä¸€ä¸ª &lt;code>PUSH List{}&lt;/code> æŒ‡ä»¤ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯æ›´ç®€å•ï¼Œæ•ˆç‡ä¼šæ›´å¥½ä¸€ç‚¹ï¼Œæ¯•ç«Ÿå°‘å‡ ä¸ªè§£é‡Šæ‰§è¡Œçš„æŒ‡ä»¤ã€‚ç›¸åº”çš„é™åˆ¶æ˜¯ä¸èƒ½å¼•ç”¨ç¯å¢ƒé‡Œçš„å˜é‡ï¼Œå› ä¸ºåœ¨æ„é€ å­—é¢é‡å¯¹è±¡çš„è¿‡ç¨‹é‡Œè¿˜æ²¡æœ‰è¿›å…¥è¿è¡Œæ—¶ç¯å¢ƒã€‚&lt;/p>
&lt;p>æ¯”å¦‚è¯´ &lt;code>#(display name)&lt;/code>ï¼Œå¦‚æœç¼–è¯‘æˆ &lt;code>PUSH List{display, name}&lt;/code>ï¼Œé‚£ä¹ˆ&lt;code>name&lt;/code>åœ¨æ­¤åˆ»å°±ä¸èƒ½è¢«æ±‚å€¼ï¼Œå¿…é¡»å»¶è¿Ÿåˆ°æ‰§è¡Œçš„æ—¶å€™æ‰èƒ½æ±‚å€¼&lt;code>name&lt;/code>ã€‚è¿™é‡Œåˆæ¶‰åŠç¼–è¯‘æœŸçš„è®¡ç®—ï¼Œæ¯”å¦‚æˆ‘å¯ä»¥å®šä¹‰ä¸€ä¸ªç¼–è¯‘é˜¶æ®µæ‰§è¡Œçš„æŒ‡ä»¤æ ¼å¼ &lt;code>[elem...]&lt;/code>ï¼Œç¼–è¯‘çš„æ—¶å€™å¯¹ &lt;code>[elem...]&lt;/code>æ±‚å€¼ï¼Œæ±‚å€¼ç»“æœå†™è¿›ç¼–è¯‘å‡ºçš„æŒ‡ä»¤é‡Œã€‚ä¹Ÿæ˜¯åè¯ã€‚&lt;/p>
&lt;p>ç¼–è¯‘æˆæŒ‡ä»¤çš„å¥½å¤„æ˜¯ä¹‹åè¦åš JIT æˆ–è€…å…¨é‡ç¼–è¯‘æˆæœ¬åœ°ä»£ç çš„è¯ï¼Œä¸éœ€è¦é‡æ–°å¤„ç†è¿™ä¸ªå­—é¢é‡ï¼Œå†™ä¸€å † case æŠŠå­—é¢é‡ç¼–è¯‘æˆå‡ ä¸ªå‡½æ•°è°ƒç”¨ã€‚&lt;/p>
&lt;p>æ‰¯è¿œäº†ï¼Œå…ˆå‰æˆ‘ä»¬æ‹¿ &lt;code>gocc&lt;/code> ç”Ÿæˆå¥½äº†è¯­æ³•æ ‘ï¼Œæ¥ä¸‹æ¥å°±æ˜¯ç®€å•åœ°åšä¸€ä¸‹ç¿»è¯‘ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">case&lt;/span> &lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Boolean&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">UInt&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Float&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Symbol&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Quoted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">String&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">instructions&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">instructions&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nf">push&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">vm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ObjectFromLiteral&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">node&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…¶ä¸­ &lt;code>vm.ObjectFromLiteral(node)&lt;/code> å°±æ˜¯è´Ÿè´£æŠŠä»æŠ½è±¡è¯­æ³•æ ‘èŠ‚ç‚¹æ„é€ å‡ºå¯¹è±¡å®ä¾‹çš„å‡½æ•°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">ObjectFromLiteral&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">node&lt;/span> &lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Node&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">Object&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="nx">node&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">node&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="kd">type&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Float&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nf">Float&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">node&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">UInt&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nf">UInt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">node&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">String&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nf">String&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">node&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Boolean&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nf">Boolean&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">node&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Quoted&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">lst&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">List&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">node&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetValue&lt;/span>&lt;span class="p">().([]&lt;/span>&lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Node&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">lst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">underlying&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">lst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">underlying&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nf">ObjectFromLiteral&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">lst&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Symbol&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nf">Symbol&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">node&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatalf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;unexpected ast node in ToValue %v(%T)&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">node&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">node&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>Quoted&lt;/code> è¡¨ç¤ºåˆ—è¡¨å­—é¢é‡ã€‚è¿™ä¸ªå‡½æ•°æœ¬èº«å¾ˆç®€å•å¾ˆç›´ç™½ï¼Œé™åˆ¶æ˜¯å¯¹äºéå­—é¢é‡çš„èŠ‚ç‚¹ä¸èƒ½æ±‚å€¼ï¼ˆæ¯”å¦‚ Identifierã€å‡½æ•°è°ƒç”¨éƒ½åªèƒ½åœ¨è¿è¡Œæ—¶æ±‚å€¼ï¼‰ã€‚&lt;/p>
&lt;h3 id="å‡½æ•°è°ƒç”¨ç¿»è¯‘">å‡½æ•°è°ƒç”¨ç¿»è¯‘&lt;/h3>
&lt;p>æ¥ç€å°±æ˜¯é‡å¤´æˆï¼Œå‡½æ•°è°ƒç”¨çš„ç¿»è¯‘ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">case&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">List&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">elements&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">node&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetValue&lt;/span>&lt;span class="p">().([]&lt;/span>&lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Node&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">elements&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="nx">vm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Instruction&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// å‚æ•°ä»å³åˆ°å·¦å‹æ ˆ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">elements&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">--&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">inst&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Compile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">elements&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">]);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">instructions&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">instructions&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">inst&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// å‹å…¥å‚æ•°æ•°é‡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">instructions&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">instructions&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nf">push&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">vm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">UInt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">elements&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;span class="c1">// æ’å…¥è°ƒç”¨è¯­å¥
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">callee&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">elements&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">ident&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">callee&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Identifier&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">instructions&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">instructions&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">vm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Instruction&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">OpCode&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">vm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CALL&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Operand&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">vm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">vm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Symbol&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ident&lt;/span>&lt;span class="p">)},&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è°ˆå‡½æ•°è°ƒç”¨çš„ç¼–è¯‘å‰å¿…é¡»å…ˆç¡®å®šå¥½è°ƒç”¨çº¦å®šã€‚è¿™é‡Œé‡‡ç”¨äº†å’Œ cdecl ç±»ä¼¼çš„è°ƒç”¨çº¦å®šï¼Œå‚æ•°ä»å³å¾€å·¦å‹æ ˆï¼ŒåŒæ—¶åœ¨æœ€å·¦æ·»åŠ ä¸€ä¸ªå‚æ•°æ•°é‡çš„å‚æ•°ï¼Œå°±åƒæ˜¯ &lt;code>object f(object argc, object ...argv)&lt;/code> ä¸€æ ·ï¼Œé¢†ä¼šç²¾ç¥ã€‚&lt;/p>
&lt;p>å‡½æ•°çš„è¿”å›å€¼ä¸€å¾‹åŒ…è£…æˆ object è¿”å›ï¼Œä¸å…è®¸å¤šè¿”å›å€¼ï¼ˆä½†å¯ä»¥è€ƒè™‘åŠ ä¸ªè§£æ„è¯­æ³•ä¹‹ç±»çš„ç³–ï¼‰ï¼Œè¿”å›å€¼ä¹Ÿé€šè¿‡æ ˆä¼ é€’ã€‚&lt;/p>
&lt;p>æ•´ä¸ªå‡½æ•°è°ƒç”¨çš„è¿‡ç¨‹å¯ä»¥æè¿°ä¸ºï¼š&lt;/p>
&lt;ol>
&lt;li>è°ƒç”¨æ–¹å‚æ•°å‹æ ˆ&lt;/li>
&lt;li>è°ƒç”¨æ–¹å‚æ•°æ•°é‡å‹æ ˆ&lt;/li>
&lt;li>è°ƒç”¨æ–¹è¿”å›åœ°å€å‹æ ˆ&lt;/li>
&lt;li>è°ƒç”¨æ–¹è·³è½¬åˆ°å‡½æ•°å…¥å£ï¼ˆæˆ–è€…è¿›å…¥å†…ç½®å‡½æ•°ï¼‰&lt;/li>
&lt;li>è¢«è°ƒæ–¹å¼¹å‡ºè¿”å›åœ°å€&lt;/li>
&lt;li>è¢«è°ƒæ–¹å¼¹å‡ºæ‰€æœ‰å‚æ•°&lt;/li>
&lt;li>è¢«è°ƒæ–¹å‹æ ˆè¿”å›å€¼&lt;/li>
&lt;li>è¢«è°ƒæ–¹è·³è½¬è‡³è¿”å›åœ°å€&lt;/li>
&lt;/ol>
&lt;p>ä¸€å¥è¯æ¦‚æ‹¬å°±æ˜¯è¢«è°ƒæ–¹æ¸…æ ˆï¼Œè¿”å›å€¼æ”¾åœ¨æ ˆé¡¶ã€‚å¯¹äºå†…ç½®å‡½æ•°ï¼Œæ­¥éª¤5-8éƒ½è¦åœ¨å†…ç½®å‡½æ•°é‡Œå®Œæˆã€‚ä¹‹ååšç”¨æˆ·å®šä¹‰ &lt;code>procedure&lt;/code> çš„è¯å°±è¦åœ¨ &lt;code>procedure&lt;/code> ç¼–è¯‘ç»“æœé‡ŒåŠ ä¸Šå¹³æ ˆçš„ä»£ç äº†ã€‚ç°åœ¨è¿˜åœ¨çº ç»“ &lt;code>POP&lt;/code> æŒ‡ä»¤ç›´æ¥æŠŠå¼¹å‡ºçš„å¯¹è±¡ç»™ä¸¢å¼ƒäº†ï¼Œè¯¥æ€ä¹ˆæš‚å­˜è¿”å›åœ°å€ã€‚å®åœ¨ä¸è¡Œå°±æ”¹æˆè°ƒç”¨æ–¹æ¸…æ ˆå¾—äº†ã€‚&lt;/p>
&lt;h2 id="0x03-è™šæ‹ŸæœºæŠ½è±¡">0x03 è™šæ‹ŸæœºæŠ½è±¡&lt;/h2>
&lt;p>è™šæ‹Ÿæœºç†è§£ä¸ºä¸€ä¸ªçŠ¶æ€å®¹å™¨ï¼ŒåŒ…æ‹¬æŒ‡ä»¤ç©ºé—´ï¼ˆæŒ‡ä»¤é›†åˆå’ŒæŒ‡ä»¤æŒ‡é’ˆï¼‰ã€æ•°æ®ç©ºé—´ï¼ˆæ ˆã€æœ¬åœ°å˜é‡ï¼‰ï¼Œç»™ä¸€ä¸ªç®€å•çš„æ„é€ å™¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">MiniVM&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Stack&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">Object&lt;/span> &lt;span class="c1">// æ ˆç©ºé—´ï¼ŒåŒ…æ‹¬ä¼ å‚å’Œæœ¬åœ°å˜é‡éƒ½å­˜æ”¾åœ¨è¿™é‡Œ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Top&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="c1">// æ ˆé¡¶åœ°å€
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Locals&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nx">Object&lt;/span> &lt;span class="c1">// æœ¬åœ°å˜é‡ï¼Œä»è¿™é‡ŒæŸ¥æ‰¾å˜é‡å’Œå¯è°ƒç”¨çš„å¯¹è±¡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">IP&lt;/span> &lt;span class="nx">UInt&lt;/span> &lt;span class="c1">// Instruction Pointer æŒ‡ä»¤æŒ‡é’ˆ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Instructions&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">Instruction&lt;/span> &lt;span class="c1">// ç¨‹åºæŒ‡ä»¤é›†åˆ
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewMiniVM&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">instructions&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">Instruction&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">MiniVM&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">MiniVM&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Stack&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">Top&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">IP&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Instructions&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">instructions&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Locals&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶åå®šä¹‰æ¯ä¸ªæŒ‡ä»¤çš„æ‰§è¡Œé€»è¾‘ã€‚è¿™é‡Œå…¶å®æœ‰ç‚¹åƒæ˜¯è®¾è®¡æ¨¡å¼é‡Œçš„å‘½ä»¤æ¨¡å¼ï¼ˆCommnad Patternï¼‰ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">MiniVM&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">instCall&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span> &lt;span class="nx">Instruction&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Operand&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;invalid CALL instruction: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">inst&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">sym&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Operand&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">].(&lt;/span>&lt;span class="nx">Symbol&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">proc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">LookupProc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">string&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">sym&lt;/span>&lt;span class="p">));&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">proc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">isBuiltin&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Push&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nf">UInt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">IP&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">proc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Builtin&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">proc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Location&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Push&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nf">UInt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">IP&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">IP&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">UInt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">proc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Location&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatalf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;invalid Procedure object&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatalf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;invalid CALL instruction operand %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Operand&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">MiniVM&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">instRet&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span> &lt;span class="nx">Instruction&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Operand&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;invalid RET instruction: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">inst&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">returnAddress&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Pop&lt;/span>&lt;span class="p">().(&lt;/span>&lt;span class="nx">UInt&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">IP&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">returnAddress&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Push&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Operand&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">MiniVM&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">instPush&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span> &lt;span class="nx">Instruction&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Operand&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Operand&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;invalid PUSH instruction: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">inst&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Push&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Operand&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">MiniVM&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">instPop&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span> &lt;span class="nx">Instruction&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Operand&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Operand&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;invalid POP instruction: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">inst&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Pop&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">MiniVM&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">instLoad&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span> &lt;span class="nx">Instruction&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Operand&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Operand&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;invalid LOAD instruction: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">inst&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Operand&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">].(&lt;/span>&lt;span class="nx">Symbol&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Locals&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nb">string&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">)];&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Push&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;undefined name %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;unexpected operand for instruction LOAD %v(%T)&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Operand&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Operand&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">MiniVM&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">ExecNextInstruction&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">IP&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Instructions&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">ErrNoMoreInstructions&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">inst&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Instructions&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">IP&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">OpCode&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">CALL&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">instCall&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">RET&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">instRet&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">PUSH&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">instPush&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">POP&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">instPop&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">LOAD&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">instLoad&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inst&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;unexpected opcode %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">inst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">OpCode&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">IP&lt;/span>&lt;span class="o">++&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="0x04-ç»“æœå±•ç¤º">0x04 ç»“æœå±•ç¤º&lt;/h2>
&lt;p>&lt;img src="https://nnnewb.github.io/blog/blog/p/stack-based-virtual-machine-for-minilang/image-20211213160751960.png"
width="154"
height="56"
srcset="https://nnnewb.github.io/blog/blog/p/stack-based-virtual-machine-for-minilang/image-20211213160751960_hub5ba10952ea39a099fde4f51e1c00d4b_2964_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/stack-based-virtual-machine-for-minilang/image-20211213160751960_hub5ba10952ea39a099fde4f51e1c00d4b_2964_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="image-20211213160751960"
class="gallery-image"
data-flex-grow="275"
data-flex-basis="660px"
>&lt;/p>
&lt;p>PSï¼šè¿™ä¸ª &lt;code>+&lt;/code> ä¹Ÿæ˜¯å‡½æ•°ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>è¿™ä¸ªç®€å•çš„ VM å†™çš„æ—¶å€™è„‘å­é‡Œæƒ³çš„éƒ½æ˜¯ x86 æ±‡ç¼–å’Œ Python çš„ç±»å‹ï¼Œæ‰€ä»¥å†…ç½®ç±»å‹å®šä¹‰å°±å¾ˆç²—æš´ï¼ŒæŒ‡ä»¤ OpCode å®šä¹‰ä¹Ÿæ˜¯æƒ³å½“ç„¶ã€‚å†™æˆè¿™æ ·å½“ç„¶è¿˜æ˜¯ä¸æ»¡æ„çš„ï¼Œéƒ½è´¹äº†è¿™ä¹ˆå¤§åŠ²äº†ï¼Œç®€ç®€å•å•åšä¸ª JIT ä¸è¿‡åˆ†å§ï¼Ÿ&lt;/p>
&lt;p>ä½†è®²è€å®çš„ï¼Œæˆ‘è¿˜çœŸä¸çŸ¥é“ä¸ç”¨ CGO çš„æƒ…å†µä¸‹ï¼Œæˆ‘å°±ç®—æ˜¯æ‹¿ &lt;code>syscall&lt;/code> è¿™ä¸ªåŒ…åˆ†é…å¥½äº†è¯»å†™æ‰§è¡Œçš„ç©ºé—´ä¹ŸæˆåŠŸæ±‡ç¼–å‡ºäº†æœºå™¨ç ï¼Œä¹Ÿä¸çŸ¥é“æ€ä¹ˆå»è°ƒ Go é‡Œå®šä¹‰çš„å‡½æ•°å’Œæ•°æ®ç»“æ„ã€‚è¿™ä¸€ç‚¹çœ‹ï¼Œè¦æ˜¯ä¸€å¼€å§‹æ‹¿ C å†™çš„è¯ï¼Œé—®é¢˜å°±ä¼šå¥½è§£å†³å¾ˆå¤šï¼šå¤Ÿåº•å±‚å˜›ï¼Œä¸ç”¨æ‹…å¿ƒç§»æ¤æ€§å’Œè¿è¡Œæ—¶çš„å°è£…ã€‚&lt;/p>
&lt;p>ä¸è¿‡ä¹Ÿä¸æ˜¯çœŸçš„ä¸€ç‚¹åŠæ³•ä¹Ÿæ²¡æœ‰ï¼Œå¹²è„†æŠŠå†…å»ºç±»å‹å’Œå‡½æ•°å…¨éƒ¨æ‹¿ C æˆ–è€… minilang è‡ªå·±å®ç°å°±å¥½äº†ï¼Œå®šä¹‰å¥½æ•°æ®ç»“æ„ï¼Œminilang ç¼–è¯‘å‡ºæ¥çš„æŒ‡ä»¤å…¨æ˜¯è°ƒç”¨è‡ªå·±æˆ–è€…è°ƒç”¨Cå‡½æ•°ï¼Œå†æƒ³ç¿»è¯‘åˆ°æ±‡ç¼–æŒ‡ä»¤å°±ç®€å•å¾ˆå¤šäº†ã€‚åˆ°äº†è¿™ä¸€æ­¥ï¼Œç›´æ¥æ‹¿ minilang å†™ä¸€ä¸ªç¼–è¯‘è‡ªå·±çš„ç¼–è¯‘å™¨ä¹Ÿä¸æ˜¯ä¸è¡Œã€‚&lt;/p></description></item><item><title>ä¸€ä¸ªsè¡¨è¾¾å¼æ±‚å€¼å™¨</title><link>https://nnnewb.github.io/blog/p/a-s-exp-evaluator/</link><pubDate>Thu, 09 Dec 2021 17:11:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/a-s-exp-evaluator/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>ç¿»æ²¡çœ‹è¿‡çš„è—ä¹¦çš„æ—¶å€™æ‰¾å‡ºä¸€æœ¬ã€ŠSICPã€‹çš„ PDFï¼ˆPSï¼šå·²ç»ä¹°äº†æ­£ç‰ˆä¹¦ï¼‰ï¼Œæƒ³èµ·æ›¾ç»æ‹¿ Rust å†™ç©å…·è§£é‡Šå™¨ï¼Œç»“æœç°åœ¨è¿ Rust æœ¬èº«éƒ½å·²ç»å¿«å¿˜å…‰äº†ã€‚&lt;/p>
&lt;p>æ‰€ä»¥å°±å½“æ€€æ—§ï¼Œå†™ä¸ªå¾ˆç®€å•çš„ç©å…·ï¼Œsè¡¨è¾¾å¼æ±‚å€¼å™¨ã€‚&lt;/p>
&lt;h2 id="æŠ€æœ¯æ ˆ">æŠ€æœ¯æ ˆ&lt;/h2>
&lt;p>è¯­è¨€é€‰æ‹©äº† Goï¼Œç”¨ gocc ç”Ÿæˆ Parser/Lexer ã€‚è™½ç„¶è¯´æ‰‹å†™+è°ƒè¯• Lexer/Parser ä¹Ÿæ˜¯æŒºå¿«ä¹çš„ï¼Œä½†æ¯•ç«Ÿåªæ˜¯æ€€æ—§é‡æ¸©ä¸‹å½“å¹´æ„£å¤´é’çš„è‡ªå·±ï¼Œä¸æƒ³èŠ±å¤ªå¤šæ—¶é—´ã€‚&lt;/p>
&lt;h2 id="è¯æ³•å®šä¹‰">è¯æ³•å®šä¹‰&lt;/h2>
&lt;p>ç®€å•è§£é‡Šä¸‹ gocc å®šä¹‰è¯æ³•å…ƒç´ çš„ DSL æ˜¯æ€ä¹ˆå›äº‹ã€‚gocc çš„è¿™ä¸ª DSL æ˜¯ç±»ä¼¼äº EBNF çš„è¯­æ³•ï¼ˆè‡ªç§°ï¼‰ï¼Œ &lt;code>_letter: 'a'-'z'&lt;/code> å°±æ˜¯ä¸€æ¡äº§ç”Ÿå¼ï¼Œ&lt;code>:&lt;/code>å‰é¢æ˜¯äº§ç”Ÿå¼çš„åç§°ï¼Œåé¢æ˜¯æ¨¡å¼ã€‚&lt;/p>
&lt;p>äº§ç”Ÿå¼åç§°ä¹Ÿæœ‰ç‰¹æ®Šå«ä¹‰ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;code>!&lt;/code> å¼€å¤´çš„äº§ç”Ÿå¼ä¼šè¢« Lexer å¿½ç•¥ã€‚&lt;/li>
&lt;li>&lt;code>_&lt;/code> å¼€å¤´çš„äº§ç”Ÿå¼å«åš &lt;code>regDefId&lt;/code>ï¼Œå¯ä»¥ç†è§£æˆç»™åé¢çš„æ¨¡å¼å®šä¹‰çš„åˆ«åã€‚&lt;/li>
&lt;li>&lt;code>a-z&lt;/code>å°å†™å­—æ¯å¼€å¤´çš„æ˜¯ &lt;code>token&lt;/code>ï¼Œä¹Ÿå°±æ˜¯ä¸€èˆ¬è¯´çš„è¯æ³•å…ƒç´ å®šä¹‰äº†ã€‚&lt;/li>
&lt;/ul>
&lt;p>å€¼å¾—æ³¨æ„çš„æ˜¯ &lt;code>token&lt;/code> ä¸èƒ½è¢«ç”¨ä½œå…¶ä»–è¯æ³•å…ƒç´ äº§ç”Ÿå¼çš„æ¨¡å¼éƒ¨åˆ†ï¼Œä½† &lt;code>regDefId&lt;/code> å¯ä»¥ï¼Œæ‰€ä»¥è¦æ³¨æ„è¦å¤ç”¨çš„è§„åˆ™åº”è¯¥å®šä¹‰æˆä¸‹åˆ’çº¿å¼€å¤´ã€‚&lt;/p>
&lt;p>æ¯”å¦‚è¯´ä¸‹é¢çš„ä¾‹å­ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">// example 1
letter: &amp;#39;a&amp;#39;-&amp;#39;z&amp;#39;;
identifier: letter; // Error!
// example 2
_letter: &amp;#39;a&amp;#39;-&amp;#39;z&amp;#39;;
identifier: _letter; // OK
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸‹é¢æ˜¯æ±‚å€¼å™¨çš„è¯æ³•å…ƒç´ å®šä¹‰ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">!whitespace: &amp;#39; &amp;#39; | &amp;#39;\t&amp;#39; | &amp;#39;\r&amp;#39; | &amp;#39;\n&amp;#39;;
!comment: &amp;#39;;&amp;#39; {.} &amp;#39;\n&amp;#39;;
//
// identifier
//
_letter : &amp;#39;a&amp;#39;-&amp;#39;z&amp;#39; | &amp;#39;A&amp;#39;-&amp;#39;Z&amp;#39;;
_initial: _letter;
_digit : &amp;#39;0&amp;#39;-&amp;#39;9&amp;#39; ;
_special_subsequent : &amp;#39;.&amp;#39; | &amp;#39;+&amp;#39; | &amp;#39;-&amp;#39; | &amp;#39;!&amp;#39; | &amp;#39;?&amp;#39;;
_subsequent: _initial | _digit | _special_subsequent;
_peculiar_identifier: &amp;#39;+&amp;#39; | &amp;#39;-&amp;#39; | &amp;#39;.&amp;#39; &amp;#39;.&amp;#39; &amp;#39;.&amp;#39;;
_identifier : _initial { _subsequent } | _peculiar_identifier;
identifier: _identifier;
quoted_identifier: &amp;#39;#&amp;#39; _identifier;
//
// boolean
//
_boolean_t: &amp;#39;#&amp;#39; &amp;#39;t&amp;#39;;
_boolean_f: &amp;#39;#&amp;#39; &amp;#39;f&amp;#39;;
boolean_t: _boolean_t;
boolean_f: _boolean_f;
//
// string
//
_string_element: &amp;#39;\\&amp;#39; &amp;#39;&amp;#34;&amp;#39; | . | &amp;#39;\\&amp;#39; &amp;#39;\\&amp;#39;;
_string : &amp;#39;&amp;#34;&amp;#39; { _string_element } &amp;#39;&amp;#34;&amp;#39;;
string: _string;
//
// number
//
_sign: &amp;#39;+&amp;#39; | &amp;#39;-&amp;#39;;
_uint10: _digit { _digit };
_ureal10 : [&amp;#39;.&amp;#39;] _uint10 | _uint10 &amp;#39;.&amp;#39; _digit {_digit};
_number : [_sign] _ureal10;
number: _number;
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¯æ³•å…ƒç´ å¾ˆç®€å•ï¼Œè¿ç®—ç¬¦ä¹Ÿå½“æˆ identifier å¤„ç†äº†ï¼Œä¸‡ä¸€è¦æ‰©å±•ä¹Ÿå®¹æ˜“ã€‚&lt;/p>
&lt;h2 id="è¯­æ³•å®šä¹‰">è¯­æ³•å®šä¹‰&lt;/h2>
&lt;p>gocc çš„è¯­æ³•å…ƒç´ å®šä¹‰å’Œè¯æ³•å…ƒç´ å®šä¹‰å·®ä¸å¤šã€‚äº§ç”Ÿå¼åç§°è¦ç”¨å¤§å†™å­—æ¯å¼€å¤´ï¼Œåé¢è·Ÿçš„å…ƒç´ åªèƒ½æ˜¯ &lt;code>token&lt;/code>ã€è¯­æ³•å…ƒç´ è¿˜æœ‰å­—ç¬¦ä¸²å­—é¢é‡ã€‚å¦å¤–å°±æ˜¯åœ¨æ¯ä¸ªè§„åˆ™åé¢å¯ä»¥åŠ ä¸Šä¸€ä¸ª â€œåŠ¨ä½œâ€ï¼Œç”¨è¿‡ flex/bison çš„åº”è¯¥çŸ¥é“æˆ‘è¯´çš„å•¥ã€‚è¿™ä¸ªåŠ¨ä½œæ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œæ±‚å€¼åå¿…é¡»æ˜¯ &lt;code>interface{}, error&lt;/code> è¿™æ ·çš„å…ƒç»„ã€‚è¿™ä¸ªæ±‚å€¼ç»“æœä¼šè¢« Parser è¿”å›ï¼Œæ‰€ä»¥éœ€è¦åœ¨ Action é‡Œå°±æŠŠ AST ç»„è£…å¥½ã€‚&lt;/p>
&lt;p>å¦å¤–å€¼å¾—ä¸€æçš„å°±æ˜¯è¯­æ³•å…ƒç´ çš„å®šä¹‰æ˜¯ä¸æ”¯æŒ &lt;code>[]&lt;/code>ã€&lt;code>{}&lt;/code> è¿™æ ·çš„ç³–çš„ï¼Œæ‰€ä»¥å¯é€‰å°±å¾—è‡ªå·±å†™æˆ &lt;code>Opt: Value | empty&lt;/code> ï¼Œé‡å¤ä¸€æˆ–å¤šæ¬¡å°±å¾—è‡ªå·±å†™æˆ &lt;code>Elements: Element | Elements Element&lt;/code> è¯¸å¦‚æ­¤ç±»ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">//
// Syntax start here
//
&amp;lt;&amp;lt;
import (
&amp;#34;github.com/nnnewb/minilang/pkg/ast&amp;#34;
&amp;#34;github.com/nnnewb/minilang/pkg/bnf/token&amp;#34;
)
&amp;gt;&amp;gt;
//
// value
//
Value
: identifier &amp;lt;&amp;lt; ast.Identifier(string($0.(*token.Token).Lit)), nil &amp;gt;&amp;gt;
| quoted_identifier &amp;lt;&amp;lt; ast.NewQuoted(ast.Identifier(string($0.(*token.Token).Lit[1:]))), nil &amp;gt;&amp;gt;
| boolean_t &amp;lt;&amp;lt; ast.Boolean(true), nil &amp;gt;&amp;gt;
| boolean_f &amp;lt;&amp;lt; ast.Boolean(false), nil &amp;gt;&amp;gt;
| number &amp;lt;&amp;lt; ast.NewNumber(string($0.(*token.Token).Lit)) &amp;gt;&amp;gt;
| string &amp;lt;&amp;lt; ast.String(string($0.(*token.Token).Lit)), nil &amp;gt;&amp;gt;
| List &amp;lt;&amp;lt; $0, nil &amp;gt;&amp;gt;
;
//
// list
//
ListElements
: Value &amp;lt;&amp;lt; ast.NewListWithInitial($0.(ast.Node)), nil &amp;gt;&amp;gt;
| ListElements Value &amp;lt;&amp;lt; $0.(*ast.List).Append($1.(ast.Node)), nil &amp;gt;&amp;gt;
;
List
: &amp;#34;(&amp;#34; ListElements &amp;#34;)&amp;#34; &amp;lt;&amp;lt; $1, nil &amp;gt;&amp;gt;
| &amp;#34;(&amp;#34; &amp;#34;)&amp;#34; &amp;lt;&amp;lt; ast.NewList(), nil &amp;gt;&amp;gt;
| &amp;#34;#(&amp;#34; ListElements &amp;#34;)&amp;#34; &amp;lt;&amp;lt; ast.NewQuoted($1.(ast.Node)), nil &amp;gt;&amp;gt;
| &amp;#34;#(&amp;#34; &amp;#34;)&amp;#34; &amp;lt;&amp;lt; ast.NewQuoted(ast.NewList()), nil &amp;gt;&amp;gt;
;
&lt;/code>&lt;/pre>&lt;/div>&lt;p>sè¡¨è¾¾å¼æœ¬èº«å°±æ˜¯ä¸€ä¸ªæ‹¬å·æ‹¬èµ·æ¥çš„åˆ—è¡¨ï¼Œæ‰€ä»¥è¯­æ³•å…ƒç´ æ›´ç®€å•äº†ï¼Œç›´æ¥æŠŠè¯æ³•å…ƒç´ æ”¾è¿›å»å°±è¡Œã€‚&lt;/p>
&lt;h2 id="è§£æå’Œæ‰§è¡Œ">è§£æå’Œæ‰§è¡Œ&lt;/h2>
&lt;h3 id="æ‰§è¡Œç¯å¢ƒ">æ‰§è¡Œç¯å¢ƒ&lt;/h3>
&lt;p>æ‰§è¡Œç¯å¢ƒå°±æ˜¯ä¿å­˜å˜é‡ï¼ˆè€ƒè™‘ä½œç”¨åŸŸçš„è¯è¿˜è¦åµŒå¥—ï¼‰ã€å‡½æ•°ï¼ˆæˆ–è€…å« procedureï¼‰ã€è§£é‡Šå™¨å†…å»ºçš„å‡½æ•°ä¹‹ç±»çš„ä¸œè¥¿çš„åœ°æ–¹ï¼Œç®€å•å®ç°æˆä¸€ä¸ª map å°±å®Œäº‹äº†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">ExecutionEnv&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">symbols&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nx">Value&lt;/span>
&lt;span class="nx">parent&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ExecutionEnv&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewExecutionEnv&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">parent&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ExecutionEnv&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ExecutionEnv&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">ExecutionEnv&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">symbols&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nx">Value&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">parent&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">parent&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ee&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ExecutionEnv&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">SetValue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">name&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">val&lt;/span> &lt;span class="nx">Value&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">Value&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">old&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">ee&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">symbols&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nx">ee&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">symbols&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">val&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">old&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ee&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ExecutionEnv&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">LookupName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">name&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">Value&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">val&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">ee&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">LookupLocalName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">val&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">val&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">ee&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">parent&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">LookupName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ee&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ExecutionEnv&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">LookupLocalName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">name&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">Value&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">val&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">ee&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">symbols&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">];&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">val&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æ±‚å€¼">æ±‚å€¼&lt;/h3>
&lt;p>è¯­è¨€å®šä¹‰é‡Œï¼ˆä¸æ˜¯ scheme çš„è¯­è¨€å®šä¹‰ï¼Œé‚£ä¸ªå»å‚è€ƒ r4rs/r5rs/r6rs/r7rsï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯æˆ‘ç»™è¿™ä¸ªç©å…·æ±‚å€¼å™¨çš„è¯­è¨€å®šä¹‰ï¼‰ï¼Œ&lt;code>(a b c)&lt;/code> è¿™æ ·çš„åˆ—è¡¨ç­‰äºæ˜¯ &lt;code>a(b, c)&lt;/code> è¿™æ ·çš„å‡½æ•°è°ƒç”¨ï¼Œè€ŒåŸå§‹åˆ—è¡¨å¾—å†™æˆ &lt;code>#(a b c)&lt;/code>ï¼Œå¯ä»¥ç†è§£æˆå‘Šè¯‰æ±‚å€¼å™¨è¦æŠŠç»™å‡ºçš„è¡¨è¾¾å¼å½“æˆæ•°æ®è¿˜æ˜¯ä»£ç ã€‚&lt;/p>
&lt;p>ç±»ä¼¼çš„è¿˜æœ‰&lt;code>ident&lt;/code>ä¼šè¢«æ±‚å€¼ï¼Œåœ¨æ‰§è¡Œç¯å¢ƒé‡Œå¯»æ‰¾å¯¹åº”çš„å˜é‡ï¼›&lt;code>#ident&lt;/code> æ±‚å€¼ç»“æœå°±æ˜¯æ ‡è¯†ç¬¦&lt;code>ident&lt;/code>ã€‚&lt;/p>
&lt;p>æ±‚å€¼è¿‡ç¨‹å°±æ˜¯ç®€å•çš„åšä¸ª type switchï¼Œå­—é¢é‡ä¸ç®¡ï¼ŒåŸå§‹åˆ—è¡¨å’Œæ ‡è¯†ç¬¦è¿”å›å†…å®¹ï¼Œå†ç„¶åå°±æ˜¯åˆ—è¡¨å½“æˆå‡½æ•°æ±‚å€¼ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ee&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ExecutionEnv&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">EvaluateList&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">list&lt;/span> &lt;span class="nx">List&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">Value&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">list&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">first&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">ee&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Evaluate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">list&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">fn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">first&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="nx">BuiltinFunc&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;TypeError: %v(%T) is not callable&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">first&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">first&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">args&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="nx">Value&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">list&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">:]))&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">list&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">:]&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">arg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">ee&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Evaluate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">args&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">args&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">arg&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nf">fn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ee&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">args&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ee&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ExecutionEnv&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Evaluate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">val&lt;/span> &lt;span class="nx">Value&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">Value&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">val&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="kd">type&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">List&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">ee&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">EvaluateList&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">Identifier&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">ee&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">LookupName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">string&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">)),&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Quoted&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetValue&lt;/span>&lt;span class="p">().(&lt;/span>&lt;span class="nx">Value&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å› ä¸ºè¿˜æ²¡å†™ procdure çš„å®šä¹‰ï¼Œæ‰€ä»¥ç›´æ¥æ‹¿ Builtin åšäº†ç±»å‹æ–­è¨€åˆ¤æ–­æ˜¯ä¸æ˜¯å¯ä»¥è°ƒç”¨ã€‚æˆ‘å¯»æ€ä¼ å‚å¤§æ¦‚ä¼šæ˜¯ä¸ªæŒºéº»çƒ¦çš„äº‹æƒ…ã€‚&lt;/p>
&lt;h3 id="repl">REPL&lt;/h3>
&lt;p>æœ€åå°±æ˜¯è§£é‡Šå™¨æœ¬ä½“äº†ï¼Œç”¨ &lt;code>go-prompt&lt;/code> åšäº†ä¸ªç®€å•çš„å¾ªç¯ï¼Œå†åŠ ä¸Šä¸€ç‚¹ç®—æ•°å‡½æ•°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/c-bata/go-prompt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/nnnewb/minilang/internal/builtin&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/nnnewb/minilang/internal/environment&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/nnnewb/minilang/pkg/ast&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/nnnewb/minilang/pkg/bnf/lexer&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/nnnewb/minilang/pkg/bnf/parser&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">input&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">prompt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Input&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">d&lt;/span> &lt;span class="nx">prompt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Document&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">prompt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Suggest&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">prompt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Suggest&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">input&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;.quit&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">break&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">ee&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">environment&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewExecutionEnv&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">nil&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">builtin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RegisterArithmeticBuiltin&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ee&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">ee&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetValue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;display&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">environment&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">BuiltinFunc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ee&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">environment&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ExecutionEnv&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">args&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">environment&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Value&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">environment&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Value&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">args&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nb">println&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}))&lt;/span>
&lt;span class="nx">lexer&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">lexer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewLexer&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="nb">byte&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">input&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="nx">parser&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">parser&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewParser&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">parseResult&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">parser&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Parse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">lexer&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;parse error %v\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">continue&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">val&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">environment&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewValueFromASTNode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">parseResult&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="nx">ast&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Node&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="nx">evaluated&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">ee&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Evaluate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">val&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;evaluation failed, error %v\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">continue&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;# (%T) %v\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">evaluated&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">evaluated&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ€åæ‰§è¡Œçš„æ•ˆæœå°±æ˜¯è¿™æ ·ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">&amp;gt;(display &amp;#34;Hello world!&amp;#34;)
&amp;#34;Hello world!&amp;#34;
# (&amp;lt;nil&amp;gt;) &amp;lt;nil&amp;gt;
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>sè¡¨è¾¾å¼æ±‚å€¼ä¸æ˜¯ä»€ä¹ˆå¤§ä¸äº†çš„ä¸œè¥¿ï¼Œä½† Lisp/Scheme ä¸­ä½“ç°å‡ºçš„é‚£ç§ â€œä»£ç å³æ•°æ®â€ çš„æ€æƒ³è¿˜æ˜¯å¾ˆæœ‰æ„æ€çš„ï¼Œç”šè‡³æ˜¯å¾ˆæœ‰æƒ³è±¡åŠ›çš„ã€‚&lt;/p>
&lt;p>ä¸ç®¡æ˜¯å‘½ä»¤å¼è¯­è¨€è¿˜æ˜¯å‡½æ•°å¼è¯­è¨€ï¼Œä»£ç å’Œæ•°æ®éƒ½æ˜¯è¢«åˆ†å¼€è®¨è®ºçš„ã€‚â€œä»£ç â€å¤„ç†â€œæ•°æ®â€ï¼Œæ”¾åœ¨ Lisp å®¶æ—é‡Œå°±æ˜¯ â€œä»£ç â€å¤„ç†â€œä»£ç â€ï¼Œæœ‰æ²¡æœ‰è”æƒ³åˆ° AI ï¼Ÿ&lt;/p>
&lt;p>å¥½å§ï¼Œæ¯•ç«Ÿæ˜¯ä¸Šä¸–çºªçš„å¤è‘£äº†ï¼Œç°åœ¨è¯´èµ· AI éƒ½æ˜¯ Python å’Œç¥ç»ç½‘ç»œã€‚ä½†ä¸ç®¡æ€ä¹ˆè¯´å§ï¼ŒLisp/Scheme è¿˜æ˜¯æŒºå¥½ç©çš„å¯¹å§ï¼Ÿæ²¡äº‹å¯ä»¥ä¸Š &lt;a class="link" href="https://racket-lang.org/" target="_blank" rel="noopener"
>Racket&lt;/a> å®˜ç½‘çœ‹çœ‹ï¼Œè¯´ä¸å®šä¼šå–œæ¬¢ä¸Š Lisp çš„å¥‡å¦™ä¹‹å¤„å‘¢ã€‚&lt;/p></description></item><item><title>ä¿¡å·é‡ vs äº’æ–¥é”</title><link>https://nnnewb.github.io/blog/p/%E4%BF%A1%E5%8F%B7%E9%87%8F-vs-%E4%BA%92%E6%96%A5%E9%94%81/</link><pubDate>Thu, 26 Aug 2021 00:00:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/%E4%BF%A1%E5%8F%B7%E9%87%8F-vs-%E4%BA%92%E6%96%A5%E9%94%81/</guid><description>&lt;p>çœ‹ &lt;a class="link" href="https://github.com/tmrts/go-patterns/blob/master/synchronization/semaphore.md" target="_blank" rel="noopener"
>go-patterns/semaphore.md at master Â· tmrts/go-patterns (github.com)&lt;/a> æ—¶äº§ç”Ÿäº†ç–‘é—®ï¼Œä¿¡å·é‡ä¸ºå•¥é•¿å¾—å’Œäº’æ–¥é”æ²¡å•¥åŒºåˆ«å‘¢ã€‚äºæ˜¯å°±è°·æ­Œäº†ä¸€åœˆï¼Œé‡æ¸©ä¸‹ä¸€äº›å…³äºå¹¶å‘çš„çŸ¥è¯†ï¼Œå¯¹æ¯”ä¿¡å·é‡ &lt;em>semaphore&lt;/em> å’Œäº’æ–¥é” &lt;em>mutex&lt;/em> ã€‚&lt;/p>
&lt;h2 id="äº’æ–¥é”-mutex">äº’æ–¥é” mutex&lt;/h2>
&lt;p>ä»¥ &lt;em>pthread&lt;/em> è‡ªå¸¦çš„äº’æ–¥é”ä¸ºä¾‹ï¼Œæä¾›äº†ä¸‰ç§ä¸åŒç±»å‹çš„äº’æ–¥é”ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;em>PTHREAD_MUTEX_NORMAL&lt;/em> ï¼Œæ™®é€šçš„äº’æ–¥é”ï¼Œä¸æ”¯æŒæ­»é”æ£€æµ‹ï¼ˆ&lt;em>does not detect deadlock&lt;/em>ï¼‰ï¼Œä¸æ”¯æŒé€’å½’åŠ é”ï¼ˆ&lt;em>relock without first unlocking it&lt;/em> ä¼šå¯¼è‡´æ­»é”ï¼‰ï¼Œä¸æ£€æµ‹è§£é”çº¿ç¨‹ï¼Œè§£é”ä¸€ä¸ªæœªåŠ é”çš„äº’æ–¥é”æ˜¯æœªå®šä¹‰è¡Œä¸ºï¼ˆ&lt;em>undefined behavior&lt;/em>ï¼‰ã€‚&lt;/li>
&lt;li>&lt;em>PTHREAD_MUTEX_ERRORCHECK&lt;/em>ï¼Œå¸¦é”™è¯¯æ£€æŸ¥çš„äº’æ–¥é”ï¼Œä¸æ”¯æŒé€’å½’åŠ é”ï¼ˆä¼šè¿”å›é”™è¯¯ï¼‰ï¼Œè§£é”å…¶ä»–çº¿ç¨‹çš„äº’æ–¥é”ä¼šè¿”å›é”™è¯¯ï¼Œè§£é”æœªåŠ é”çš„äº’æ–¥é”ä¼šè¿”å›é”™è¯¯ã€‚&lt;/li>
&lt;li>&lt;em>PTHREAD_MUTEX_RECURSIVE&lt;/em>ï¼Œé€’å½’åŠ é”ï¼ˆ&lt;em>relock with out unlocking it&lt;/em>ï¼‰ä¼šæˆåŠŸï¼Œè§£é”æ—¶éœ€è¦è°ƒç”¨è§£é”çš„æ¬¡æ•°å’ŒåŠ é”æ—¶è°ƒç”¨åŠ é”çš„æ¬¡æ•°ç›¸åŒã€‚è§£é”å…¶ä»–çº¿ç¨‹çš„äº’æ–¥é”ä¼šè¿”å›é”™è¯¯ã€‚è§£é”æœªåŠ é”çš„äº’æ–¥é”ä¼šè¿”å›é”™è¯¯ã€‚&lt;/li>
&lt;li>&lt;em>PTHREAD_MUTEX_DEFAULT&lt;/em>ï¼Œé»˜è®¤äº’æ–¥é”ç±»å‹ï¼Œå¯¹è¿™ä¸€ç±»å‹çš„äº’æ–¥é”é€’å½’åŠ é”æ—¶è¡Œä¸ºæ˜¯æœªå®šä¹‰çš„ï¼Œè§£é”æœªåŠ é”çš„äº’æ–¥é”è¡Œä¸ºæ˜¯æœªå®šä¹‰çš„ï¼Œè§£é”å…¶ä»–çº¿ç¨‹çš„äº’æ–¥é”è¡Œä¸ºæ˜¯æœªå®šä¹‰çš„ã€‚è¿™ä¸€ç±»å‹çš„äº’æ–¥é”é€šå¸¸æ˜ å°„ä¸ºå¦å¤–å‡ ç§äº’æ–¥é”ä¹‹ä¸€ã€‚&lt;/li>
&lt;/ul>
&lt;p>å¯ä»¥æ¯”è¾ƒæ¸…æ¥šåœ°çœ‹å‡ºï¼Œäº’æ–¥é”æœ‰ä¸‰ä¸ªåŸºæœ¬ç‰¹å¾ï¼š&lt;/p>
&lt;ul>
&lt;li>æ˜¯å¦å¯é‡å¤åŠ é”&lt;/li>
&lt;li>æ˜¯å¦å¯è§£é”æœªåŠ é”çš„äº’æ–¥é”&lt;/li>
&lt;li>æ˜¯å¦å¯è§£é”è¢«å…¶ä»–äººåŠ é”çš„äº’æ–¥é”&lt;/li>
&lt;/ul>
&lt;p>æœ€ä¸¥æ ¼çš„ &lt;em>PTHREAD_MUTEX_ERRORCHECK&lt;/em> ç±»å‹äº’æ–¥é”ï¼Œå¯¹æ­¤å®šä¹‰æ˜¯ NOã€NOã€NO ã€‚&lt;/p>
&lt;p>äº’æ–¥é”çš„åŸºæœ¬ä½¿ç”¨æ–¹å¼å’Œä½¿ç”¨åœºæ™¯æœ‰ç‚¹åƒå•æ‰€çš„å‘ä½ï¼š&lt;/p>
&lt;ol>
&lt;li>æŠ¢å‘ä½ï¼Œé”é—¨&lt;/li>
&lt;li>ä½ æ‡‚çš„&lt;/li>
&lt;li>è§£é”ï¼Œå‡ºé—¨&lt;/li>
&lt;/ol>
&lt;p>å…¶ä¸­æœ‰éšå«çš„ä¿¡æ¯åŒ…æ‹¬ï¼š&lt;/p>
&lt;ol>
&lt;li>å‘ä½æ˜¯æå‰é€‰æ‹©å¥½çš„ï¼Œä½ åªèƒ½æŠ¢ä¸€ä¸ªå‘ä½ï¼Œä¸èƒ½æŠ¢å¤šä¸ªå‘ä½ã€‚&lt;/li>
&lt;li>å‘ä½åœ¨ä½¿ç”¨æœŸé—´æ˜¯ç‹¬å çš„ï¼Œä½ ä¸èƒ½å’Œåˆ«äººåˆ†äº«ä¸€ä¸ªå‘ä½ã€‚&lt;/li>
&lt;li>åªæœ‰ä½ è‡ªå·±èƒ½è§£é”å‘ä½ï¼Œè°ä¹Ÿä¸æƒ³åŠäº‹å„¿çš„æ—¶å€™æœ‰äººé—¯è¿›æ¥å§ï¼Ÿ&lt;/li>
&lt;/ol>
&lt;p>è€Œé€’å½’åŠ é”è¿™ä¸€ç‰¹æ®Šåœºæ™¯ï¼Œæˆ‘å¯»æ€å§ï¼Œæœ‰ç‚¹éš¾æ‹¿å‘ä½æ¯”å–»ã€‚åæ­£ä¹Ÿä¸é‡è¦ï¼Œå°±åˆ«ç®¡äº†ã€‚&lt;/p>
&lt;h2 id="ä¿¡å·é‡-semaphore">ä¿¡å·é‡ semaphore&lt;/h2>
&lt;p>ä¿¡å·é‡æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ•´å‹å€¼ï¼Œä¸ç»†åˆ†ä»€ä¹ˆç±»å‹äº†ã€‚è¿˜æ˜¯ç”¨ &lt;em>pthread&lt;/em> ä¸¾ä¾‹å§ï¼Œä¾æ® &lt;em>POSIX&lt;/em> æ ‡å‡†ã€‚&lt;/p>
&lt;p>å¯¹ä¿¡å·é‡çš„æ“ä½œå¯ä»¥å…ˆç®€å•åˆ†5ç§ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;code>sem_init(sem,pshared,value)&lt;/code>ï¼Œåˆå§‹åŒ–ä¸€ä¸ªä¿¡å·é‡ï¼Œå¯ä»¥æŒ‡å®šè¦ä¸è¦åœ¨ &lt;code>fork()&lt;/code> åˆ›å»ºçš„è¿›ç¨‹é—´å…±äº«ï¼Œè¿˜å¯ä»¥æŒ‡å®šä¿¡å·é‡åˆå§‹å€¼ã€‚&lt;/li>
&lt;li>&lt;code>sem_wait(sem)&lt;/code>ï¼Œç­‰å¾…ä¿¡å·é‡ï¼Œä¿¡å·é‡ç­‰äº0æ—¶é˜»å¡ï¼Œå…¶ä»–çº¿ç¨‹é€šè¿‡&lt;code>sem_post&lt;/code>å”¤é†’ã€‚&lt;/li>
&lt;li>&lt;code>sem_post(sem)&lt;/code>ï¼Œå‘é€ä¿¡å·é‡ï¼Œå”¤é†’é˜»å¡åœ¨&lt;code>sem_wait&lt;/code>çš„çº¿ç¨‹ã€‚&lt;/li>
&lt;li>&lt;code>sem_getvalue(sem,valp)&lt;/code>ï¼Œè·å–ä¿¡å·é‡å½“å‰å€¼ã€‚&lt;/li>
&lt;li>&lt;code>sem_destroy(sem)&lt;/code>ï¼Œé”€æ¯ä¿¡å·é‡ã€‚&lt;/li>
&lt;/ul>
&lt;p>ä¿¡å·é‡çš„ä¸»è¦ç‰¹å¾å°±æ˜¯å®ƒçš„å€¼ï¼š&lt;/p>
&lt;ul>
&lt;li>å½“å€¼ç­‰äº0æ—¶ï¼Œ&lt;code>sem_wait&lt;/code> ä¼šé˜»å¡ã€‚&lt;/li>
&lt;li>å½“å€¼å¤§äº0æ—¶ï¼Œ&lt;code>sem_wait&lt;/code> è¿”å›å¹¶ä½¿å€¼-1ã€‚&lt;/li>
&lt;/ul>
&lt;p>å¯ä»¥æ³¨æ„åˆ°ï¼Œä¿¡å·é‡çš„ç¡®å¯ä»¥åšåˆ°äº’æ–¥é”èƒ½åšåˆ°çš„äº‹æƒ…ï¼šè®¾å®šå¥½åˆå§‹å€¼1ï¼Œç„¶å&lt;code>sem_wait&lt;/code>ç­‰åŒäºåŠ é”ï¼Œ&lt;code>sem_post&lt;/code>ç­‰åŒäºè§£é”ï¼Œçš„ç¡®æ¨¡æ‹Ÿå‡ºäº†äº’æ–¥é”çš„åŠŸèƒ½ã€‚&lt;/p>
&lt;p>ä¸è¿‡ä¿¡å·é‡å»æ¨¡æ‹Ÿäº’æ–¥é”ä¼šæœ‰ä¸€äº›é—®é¢˜ã€‚æ¯”å¦‚è¯´æ— æ³•å®ç°é€’å½’åŠ é”ï¼ˆä¿¡å·é‡å€¼ç­‰äº0æ—¶ï¼Œ&lt;code>sem_wait&lt;/code>ä¼šé˜»å¡ï¼‰ï¼Œæ— æ³•æ£€æµ‹è§£é”çº¿ç¨‹æ˜¯ä¸æ˜¯åŠ é”çº¿ç¨‹ï¼ˆé™¤éä½ è‡ªå·±å†å°è£…ä¸€æ¬¡ï¼ŒæŠŠä¿¡å·é‡å’Œçº¿ç¨‹IDç»‘å®šï¼‰ï¼Œè§£é”æœªåŠ é”ä¼šå¯¼è‡´ä¿¡å·é‡å€¼å¤§äº1ï¼Œè¿›è€Œé€ æˆ&lt;code>sem_wait&lt;/code>ä¼šå…è®¸å¤šä¸ªçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œï¼ˆè¿˜æ˜¯ä¸€æ ·ï¼Œä½ å¾—è‡ªå·±å°è£…ï¼Œåœ¨&lt;code>sem_post&lt;/code>å‰æ£€æŸ¥å½“å‰ä¿¡å·é‡çš„å€¼ï¼‰ã€‚&lt;/p>
&lt;p>å¥½ï¼Œæ¨¡æ‹Ÿäº’æ–¥é”çš„è¯é¢˜åˆ°æ­¤ä¸ºæ­¢ã€‚å›åˆ°å±å°¿å±çš„æ¯”å–»ä¸Šã€‚äº’æ–¥é”å¯ä»¥æ¯”ä½œå…¬å•æ”¶è´¹çš„è€å¤§çˆ·ã€‚&lt;/p>
&lt;ul>
&lt;li>è€è§„çŸ©ï¼Œä¸æ’é˜Ÿï¼Œå¤§å®¶ä»è€å¤§çˆ·æ‰‹é‡ŒæŠ¢å‘ä½ã€‚&lt;/li>
&lt;li>å‘ä½æ»¡å‘˜çš„æ—¶å€™è€å¤§çˆ·è°ä¹Ÿä¸è®©è¿›ã€‚&lt;/li>
&lt;li>æ¯å‡ºæ¥ä¸€ä¸ªäººï¼Œè€å¤§çˆ·å°±æ”¾è¿›å»ä¸€ä¸ªäººã€‚&lt;/li>
&lt;/ul>
&lt;p>å…¶ä¸­éšå«çš„ä¿¡æ¯åŒ…æ‹¬ï¼š&lt;/p>
&lt;ul>
&lt;li>å½“ç„¶ï¼Œå¯ç”¨çš„å‘ä½æˆ–è€…è¯´èµ„æºä¾ç„¶æ˜¯æœ‰é™çš„ï¼Œæ•°é‡ä¸ç¡®å®šã€‚&lt;/li>
&lt;li>ä½ åªèƒ½ç‹¬å ä¸€éƒ¨åˆ†èµ„æºï¼Œè€Œä¸”æ¯ä¸ªäººç‹¬å çš„èµ„æºéƒ½ä¸€æ ·å¤šã€‚ä¸ç„¶è€å¤§çˆ·çœ‹åˆ°æœ‰ä¸€ä¸ªå‘ä½æ”¾ä½ è¿›å»äº†ï¼Œä½†ä½ æƒ³è¦ç”¨ä¸¤ä¸ªå‘ä½ï¼Œé‚£ä½ å°±åªèƒ½ç»§ç»­ç­‰ç€ï¼Œæˆ–è€…å’Œåˆ«äººåˆ†äº«å‘ä½äº†ã€‚&lt;/li>
&lt;/ul>
&lt;p>ä¿¡å·é‡æœ€å¥½ç”¨çš„åœºæ™¯è¿˜æ˜¯ &lt;strong>ç”Ÿäº§è€…-æ¶ˆè´¹è€…&lt;/strong> æ¨¡å‹çš„é˜Ÿåˆ—ï¼Œæ¥ç»Ÿè®¡é˜Ÿåˆ—ä¸­å…ƒç´ æ•°é‡ã€‚æ¶ˆè´¹è€…å¯ä»¥ç”¨ä¸€ä¸ªç®€å•çš„ &lt;code>sem_timedwait&lt;/code> è°ƒç”¨å®ç°ç­‰å¾…æ–°å…ƒç´ åŠ å…¥é˜Ÿåˆ—ï¼Œç”¨äº’æ–¥é”æ¥ç¡®ä¿é˜Ÿåˆ—æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚&lt;/p>
&lt;p>å¯è§ç®¡å…¬å•çš„è€å¤§çˆ·ä¹Ÿæ˜¯éå¸¸æœ‰ç”Ÿæ´»æ™ºæ…§å“ˆï¼Œå……åˆ†åˆ©ç”¨äº†å¹´è½»æ—¶çš„ç¼–ç¨‹ç»éªŒæ¥æé«˜æ™šå¹´ç”Ÿæ´»è´¨é‡ã€‚&lt;/p>
&lt;h2 id="ç»“è®º">ç»“è®º&lt;/h2>
&lt;p>äº’æ–¥é”å’Œä¿¡å·é‡éƒ½èƒ½å¤„ç†æ•°æ®ç«äº‰ï¼Œä½†å„æœ‰ä¾§é‡ã€‚&lt;/p>
&lt;p>å…¸å‹çš„æ•°æ®ç«äº‰åœºæ™¯å½“ç„¶æ˜¯äº’æ–¥é”å¥½ç”¨ï¼Œä½†ä¿¡å·é‡ä¹Ÿä¸æ˜¯å®Œå…¨ä¸è¡Œã€‚&lt;/p>
&lt;p>ä¿¡å·é‡çš„å…¸å‹åœºæ™¯ä¹Ÿä¸€æ ·ï¼Œäº’æ–¥é”å³ä¾¿èƒ½è¡Œä¹Ÿä¼šæ˜¾å¾—åˆ«æ‰­ã€‚&lt;/p></description></item><item><title>é¢è¯•é¢˜ä¹‹ goroutine è¿è¡Œé¡ºåº</title><link>https://nnnewb.github.io/blog/p/%E9%9D%A2%E8%AF%95%E9%A2%98%E4%B9%8B-goroutine-%E8%BF%90%E8%A1%8C%E9%A1%BA%E5%BA%8F/</link><pubDate>Wed, 04 Aug 2021 10:37:24 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/%E9%9D%A2%E8%AF%95%E9%A2%98%E4%B9%8B-goroutine-%E8%BF%90%E8%A1%8C%E9%A1%BA%E5%BA%8F/</guid><description>&lt;p>ä¸æ˜¯æˆ‘åšçš„æ²™é›•é¢è¯•é¢˜ï¼Œåœ¨ segmentfault ä¸Šçœ‹åˆ°çš„ã€‚&lt;/p>
&lt;!-- more -->
&lt;h2 id="åŸé¢˜">åŸé¢˜&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;runtime&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;sync&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">runtime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GOMAXPROCS&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">wg&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">WaitGroup&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;A:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Done&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">num&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;B:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">num&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Done&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}(&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Wait&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>é—®ï¼šä»£ç è¾“å‡ºç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ&lt;/p>
&lt;h2 id="èƒ¡ä¹±åˆ†æ">èƒ¡ä¹±åˆ†æ&lt;/h2>
&lt;p>ç¬¬ä¸€çœ¼è¿›å»çœ‹åˆ° &lt;code>runtime.GOMAXPROCS(1)&lt;/code> ï¼Œåˆæ­¥æ€€ç–‘æ˜¯åˆåœ¨è€ƒä»€ä¹ˆ GMP é¢è¯•é¢˜äº†ã€‚&lt;/p>
&lt;p>ä½†å‡¡è¯´åˆ° Go é¢è¯•å¥½åƒå°±ä¸€å®šè¦è€ƒä¸€ä¸‹ goroutine è°ƒåº¦å’Œ GMP æ¨¡å‹ï¼Œæ‹›è¿›æ¥åˆåªè®©ä½ å†™ curd ã€‚æå¾—é¢è¯•è·Ÿè€ƒè¯•èƒŒä¹¦ä¸€æ ·ã€‚&lt;/p>
&lt;p>å…ˆä¸åæ§½ï¼Œç»§ç»­çœ‹ã€‚è·³è¿‡ä¸¤è¡Œ &lt;code>sync.WaitGroup&lt;/code> ä¹‹åå°±æ˜¯ä¸€ä¸ªç»å…¸ for å¾ªç¯é™·é˜±ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;A:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Done&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å°±æ˜¯ä¸ªå…¸å‹çš„é—­åŒ…æ•è·é—®é¢˜ï¼Œ&lt;code>i&lt;/code> è¢«ä»¥å¼•ç”¨å½¢å¼æ•è·è¿›åŒ¿åå‡½æ•°ï¼Œå¾ªç¯ä¸­çš„ &lt;code>i++&lt;/code> ä¼šå¯¼è‡´æ‰€æœ‰åŒ¿åå‡½æ•°æ•è·çš„ &lt;code>i&lt;/code> çš„å€¼éƒ½è·Ÿç€å˜ã€‚&lt;/p>
&lt;p>ä½†æœ‰æ‰€åŒºåˆ«çš„æ˜¯ï¼Œè¿™ä¸ªåŒ¿åå‡½æ•°è¢«å½“ goroutine æ‰§è¡Œäº†ã€‚ä¹‹åå†ç»†è¯´ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">num&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;B:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">num&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Done&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}(&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™å°±æ˜¯ä¸Šé¢é”™è¯¯ä¾‹å­çš„æ­£ç¡®å†™æ³•ï¼ŒæŠŠé—­åŒ…æ•è·å˜æˆäº†å‚æ•°ä¼ é€’ï¼Œå°† &lt;code>i&lt;/code> å¤åˆ¶äº†ä¸€ä»½è¿›åŒ¿åå‡½æ•°ã€‚&lt;/p>
&lt;p>å¥½äº†ï¼Œé‚£ä¹ˆæ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œæœ€ç»ˆç»“æœæ˜¯&amp;hellip;ï¼Ÿ&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">A: 5
A: 5
A: 5
A: 5
A: 5
B: 0
B: 1
B: 2
B: 3
B: 4
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ˜¯è¿™æ ·å—ï¼Ÿ&lt;/p>
&lt;h2 id="å†æ¬¡èƒ¡ä¹±åˆ†æ">å†æ¬¡èƒ¡ä¹±åˆ†æ&lt;/h2>
&lt;p>é—æ†¾çš„æ˜¯å®é™…è·‘èµ·æ¥ç»“æœæ˜¯&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">B: 4
A: 5
A: 5
A: 5
A: 5
A: 5
B: 0
B: 1
B: 2
B: 3
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°æœ€åä¸€ä¸ªå¯åŠ¨çš„ goroutine çš„è¾“å‡ºè·‘åˆ°äº†æœ€å¼€å¤´ã€‚å…¶ä»–é¡ºåºå€’æ˜¯æ²¡å•¥å˜åŒ–ã€‚ä¸ºå•¥å‘¢ï¼Ÿ&lt;/p>
&lt;p>å…ˆçœ‹ &lt;code>runtime.GOMAXPROCS(1)&lt;/code> ã€‚&lt;/p>
&lt;p>&lt;img src="https://nnnewb.github.io/blog/blog/image/goroutines-schedule-order/G-M-P.png"
loading="lazy"
alt="GMP"
>&lt;/p>
&lt;p>ä» GMP æ¨¡å‹å¯ä»¥å¾—çŸ¥è¿™ä¸€å¥ä»£ç å®é™…é™åˆ¶äº†æ‰€æœ‰ goroutine åªèƒ½è¢«é¡ºåºä¸²è¡Œæ‰§è¡Œï¼ˆæ‰€æœ‰ g éƒ½åªèƒ½åœ¨è¿™å”¯ä¸€ä¸€ä¸ª p çš„æœ¬åœ°é˜Ÿåˆ—é‡Œç­‰å¾… mï¼‰ã€‚&lt;/p>
&lt;p>è€Œ &lt;code>main()&lt;/code> å‡½æ•°é‡Œåˆ›å»º goroutine çš„é¡ºåºæ˜¯æ˜ç¡®çš„ï¼Œ5 ä¸ª Aï¼Œ5 ä¸ª Bã€‚&lt;/p>
&lt;p>æŒ‰ç…§ä¸€èˆ¬ç†è§£çš„è¯ï¼Œé˜Ÿåˆ—æ˜¯å…ˆè¿›å…ˆå‡º FIFO çš„ç»“æ„ï¼Œä¸€ä¸ª p åˆé™åˆ¶äº†å…¶ä»– m å³ä½¿å”¤é†’äº†ï¼ŒæŠ¢å äº† pï¼Œä¹Ÿä¸èƒ½åš work stealingï¼ˆä¹Ÿç”¨ä¸ç€åšï¼‰ï¼Œé‚£ä¹ˆ goroutine çš„æ‰§è¡Œé¡ºåºè‡ªç„¶åªèƒ½æ˜¯å…ˆè¿›å…ˆå‡ºäº†ã€‚&lt;/p>
&lt;p>é‚£ä¹ˆè¿™ä¸ªç¨‹åºçš„è¡Œä¸ºå°±å¾ˆå¥‡æ€ªäº†ï¼Œå…ˆåˆ›å»ºçš„ goroutine å…ˆæ‰§è¡Œçš„è¯ï¼Œé‚£ä¹ˆè¾“å‡ºé¡ºåºåº”è¯¥å’Œæˆ‘ä»¬é¢„æ–™çš„ä¸€æ ·ã€‚å®é™…è¿è¡Œç»“æœä¸ºä»€ä¹ˆä¼šå˜æˆè¿™æ ·å‘¢ï¼Ÿ&lt;/p>
&lt;h2 id="ä¸å–å…³å­äº†">ä¸å–å…³å­äº†&lt;/h2>
&lt;p>ç›´æ¥è¯´ç»“è®ºå—·ã€‚&lt;/p>
&lt;p>&lt;strong>ä¸çŸ¥é“ã€‚&lt;/strong>&lt;/p>
&lt;p>åˆ«ç¬‘ï¼ŒçœŸçš„ä¸çŸ¥é“ã€‚ç‰¹åœ°ä¸Š&lt;a class="link" href="https://stackoverflow.com/questions/35153010/goroutines-always-execute-last-in-first-out" target="_blank" rel="noopener"
>çˆ†æ ˆæœäº†ä¸‹&lt;/a>ï¼Œå¾—åˆ°çš„ç»“è®ºå°±æ˜¯ï¼Œä¸çŸ¥é“ã€‚&lt;/p>
&lt;blockquote>
&lt;p>In Go 1.5, the order in which goroutines are scheduled has been changed. &lt;strong>The properties of the scheduler were never defined by the language&lt;/strong>, but programs that depend on the scheduling order may be broken by this change. We have seen a few (erroneous) programs affected by this change. If you have programs that implicitly depend on the scheduling order, you will need to update them.&lt;/p>
&lt;/blockquote>
&lt;p>ä»ä¸€ä¸ª Go è¯­è¨€ä½¿ç”¨è€…çš„è§’åº¦æ¥è¯´ï¼Œgoroutine è°ƒåº¦å™¨çš„å®ç°ç»†èŠ‚ï¼ˆåƒæ˜¯å¤šä¸ª goroutine ä¹‹é—´çš„è¿è¡Œé¡ºåºï¼‰å¹¶ä¸æ˜¯èƒ½ä¾èµ–çš„ä¸œè¥¿ã€‚&lt;/p>
&lt;p>å¦‚æœå†™è¿‡ä¸€æ®µæ—¶é—´çš„ C/C++ ï¼Œé‚£ä¹ˆé¢è¯•å®˜åº”è¯¥å¾ˆæ¸…æ¥šï¼ŒC/C++ æœ‰å‡ æ ·è‡­åæ˜­è‘—çš„ä¸œè¥¿ï¼š &lt;em>Undefined Behavior&lt;/em>, &lt;em>Unspecified Behavior&lt;/em>ã€‚è€Œ goroutine æ‰§è¡Œé¡ºåºå°±æ˜¯ä¸€ä¸ª Go ä¸­çš„ &lt;em>Undefined Behavior&lt;/em>ã€‚&lt;/p>
&lt;h2 id="ç»“è®º">ç»“è®º&lt;/h2>
&lt;p>æˆ‘ç†è§£ä¸­çš„æ‹¿æ¥ä¸»ä¹‰ï¼Œæ—¢ä¸èƒ½è¢«åŠ¨åœ°ç­‰å¾…ï¼Œä¹Ÿä¸èƒ½ä¸åŠ åˆ†è¾¨åœ°æ‹¿æ¥ï¼Œè€Œæ—¢ç„¶åŠ ä»¥åˆ†è¾¨äº†ï¼Œè‡ªç„¶æ›´ä¸åº”è¯¥å°†æ‹¿æ¥çš„äº‹ç‰©å½“æˆè§£å†³ä¸€åˆ‡é—®é¢˜çš„ä¸‡èƒ½è¯ã€‚&lt;/p>
&lt;p>Go è™½ç„¶æ˜¯ä¸€é—¨ä¸é”™çš„è¯­è¨€ï¼Œè¯•å›¾å°†è¯­è¨€ç»†èŠ‚å°½å¯èƒ½æ˜ç¡®å®šä¹‰æ¥é¿å…å†æ¬¡é™·å…¥ C/C++çš„é™·é˜±ï¼Œä½†æ˜¾ç„¶ Go ç”¨æˆ·ä¸è¿™ä¹ˆæƒ³ã€‚è‡³å°‘ï¼Œæœ‰éƒ¨åˆ† Go ç”¨æˆ·ä¸è¿™ä¹ˆæƒ³ï¼Œä»–ä»¬æƒ³ææ¸…æ¥š Go çš„ä¸€åˆ‡ï¼Œç„¶åæŠŠè¿™ä¸€åˆ‡éƒ½å½“ä½œè‡³é«˜æ— ä¸Šçš„å‡†åˆ™ï¼Œæ¥é­æŒå…¶ä½™äººã€‚&lt;/p>
&lt;p>ç›®å‰ä¸ºæ­¢ï¼ŒGMP å¾ˆå¥½ï¼Œä½œä¸ºé¢è¯•é¢˜ä¹Ÿè¯´å¾—è¿‡å»ã€‚&lt;/p>
&lt;p>åˆ°åº•æˆ‘åªæ˜¯åŒæ¶è¿™ä¸–ä¸Šçš„ä¸€éƒ¨åˆ†äººç½¢äº†ã€‚&lt;/p></description></item><item><title>ä»é›¶å®ç°ä¸€ä¸ªå®¹å™¨</title><link>https://nnnewb.github.io/blog/p/%E4%BB%8E%E9%9B%B6%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E5%AE%B9%E5%99%A8/</link><pubDate>Mon, 31 May 2021 16:16:52 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/%E4%BB%8E%E9%9B%B6%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E5%AE%B9%E5%99%A8/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>è‡ªä»çœ‹äº†&lt;code>cocker&lt;/code>é¡¹ç›®çš„ ppt ä¹‹åå°±æœ‰ç‚¹å¿µå¿µä¸å¿˜çš„æ„æ€äº†ï¼Œå®ç°ä¸€ä¸ª docker æˆ– docker çš„ç±»ä¼¼ç‰©çœ‹èµ·æ¥å¹¶ä¸æ˜¯åšä¸åˆ°çš„äº‹æƒ…ã€‚&lt;/p>
&lt;p>äºæ˜¯å°±åŠ¨æ‰‹è¯•ä¸€è¯•ã€‚&lt;/p>
&lt;h2 id="æ ¸å¿ƒæŠ€æœ¯">æ ¸å¿ƒæŠ€æœ¯&lt;/h2>
&lt;h3 id="namespace">namespace&lt;/h3>
&lt;p>å‘½åç©ºé—´åŒ…è£…å…¨å±€ç³»ç»Ÿèµ„æºï¼Œè®©åœ¨å‘½åç©ºé—´ä¸­çš„è¿›ç¨‹çœ‹èµ·æ¥å°±åƒæ˜¯æœ‰è‡ªå·±ç‹¬ç«‹éš”ç¦»çš„å…¨å±€èµ„æºä¸€æ ·ã€‚å‘½åç©ºé—´ä¸­çš„å…¨å±€èµ„æºå¯¹å‘½åç©ºé—´ä¸­çš„å…¶ä»–è¿›ç¨‹éƒ½æ˜¯å¯è§çš„ï¼Œä½†å¯¹å‘½åç©ºé—´å¤–çš„è¿›ç¨‹ä¸å¯è§ã€‚å‘½åç©ºé—´ç”¨é€”ä¹‹ä¸€å°±æ˜¯å®ç°å®¹å™¨ã€‚&lt;/p>
&lt;blockquote>
&lt;pre>&lt;code>Linux provides the following namespaces:
Namespace Constant Isolates
Cgroup CLONE_NEWCGROUP Cgroup root directory
IPC CLONE_NEWIPC System V IPC, POSIX message queues
Network CLONE_NEWNET Network devices, stacks, ports, etc.
Mount CLONE_NEWNS Mount points
PID CLONE_NEWPID Process IDs
User CLONE_NEWUSER User and group IDs
UTS CLONE_NEWUTS Hostname and NIS domain name
&lt;/code>&lt;/pre>
&lt;/blockquote>
&lt;p>å‡ ä¸ªå‘½åç©ºé—´çš„ API&lt;/p>
&lt;ul>
&lt;li>&lt;code>clone&lt;/code>&lt;/li>
&lt;li>&lt;code>setns&lt;/code>&lt;/li>
&lt;li>&lt;code>unshare&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>ä¸å¾—ä¸è¯´ &lt;code>man 7 namespaces&lt;/code> å¯¹ &lt;code>namespace&lt;/code> çš„è§£é‡Šå·²ç»éå¸¸åˆ°ä½äº†ã€‚&lt;/p>
&lt;h3 id="chroot">chroot&lt;/h3>
&lt;p>è¿™ä¸ª Linux ç”¨æˆ·åº”è¯¥è¿˜æ˜¯æ¯”è¾ƒç†Ÿæ‚‰çš„ï¼Œå¦‚ Arch Linux è¿™æ ·çš„å‘è¡Œç‰ˆåœ¨å®‰è£…æ—¶å°±æœ‰ç”¨åˆ°ã€‚&lt;/p>
&lt;p>ä½¿ç”¨ &lt;code>man 2 chroot&lt;/code> æŸ¥çœ‹è¿™ä¸ª api çš„æ–‡æ¡£ã€‚&lt;/p>
&lt;blockquote>
&lt;p>chroot() changes the root directory of the calling process to that specified in path. This directory will be used for pathnames beginning with /. The root directory is inherited by all children of the calling process.&lt;/p>
&lt;p>Only a privileged process (Linux: one with the CAP_SYS_CHROOT capability in its user namespace) may call chroot().&lt;/p>
&lt;/blockquote>
&lt;p>åŸºæœ¬ä½œç”¨æ˜¯æŠŠè°ƒç”¨è¿›ç¨‹çš„æ ¹ç›®å½• &lt;code>/&lt;/code> åˆ‡æ¢åˆ°æŒ‡å®šç›®å½•ï¼Œå­è¿›ç¨‹ä¼šç»§æ‰¿è¿™ä¸ª &lt;code>/&lt;/code> ä½ç½®ï¼›è°ƒç”¨ API éœ€è¦ç‰¹æƒã€‚&lt;/p>
&lt;p>ä¸¾ä¾‹è¯´è°ƒå®Œ &lt;code>chroot(&amp;quot;/home/xxx&amp;quot;)&lt;/code>ï¼Œä½ å†ç”¨ &lt;code>ls&lt;/code> ä¹‹ç±»çš„å‘½ä»¤çœ‹ &lt;code>/&lt;/code> ä¸‹æœ‰ä»€ä¹ˆæ–‡ä»¶ï¼Œçœ‹åˆ°çš„å°±æ˜¯ &lt;code>/home/xxx&lt;/code> ä¸‹çš„å†…å®¹äº†ã€‚&lt;/p>
&lt;p>&lt;code>man 2 chroot&lt;/code> è¿˜æœ‰ä¸€äº›æœ‰æ„æ€çš„å†…å®¹ï¼Œä¸åšèµ˜è¿°ã€‚&lt;/p>
&lt;h3 id="mount">mount&lt;/h3>
&lt;p>ä¹Ÿæ˜¯ Linux ç”¨æˆ·å¾ˆç†Ÿæ‚‰çš„ä¸œè¥¿ã€‚è€è§„çŸ©ï¼Œ&lt;code>man 2 mount&lt;/code> çœ‹çœ‹æ–‡æ¡£ã€‚&lt;/p>
&lt;blockquote>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;sys/mount.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">mount&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">source&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">target&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">filesystemtype&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">unsigned&lt;/span> &lt;span class="kt">long&lt;/span> &lt;span class="n">mountflags&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="k">const&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>mount() attaches the filesystem specified by source (which is often a pathname referring to a device, but can also be the pathname of a directory or file, or a dummy string) to the location (a directory or file) specified by the pathname in target.&lt;/p>
&lt;/blockquote>
&lt;p>&lt;code>mount&lt;/code> ä¼šæŒ‚è½½(attaches) &lt;code>source&lt;/code> å‚æ•°æŒ‡å®šçš„æ–‡ä»¶ç³»ç»Ÿï¼ˆé€šå¸¸æ˜¯è®¾å¤‡è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯æ–‡ä»¶å¤¹ã€æ–‡ä»¶çš„è·¯å¾„æˆ–è™šæ‹Ÿå­—ç¬¦ä¸²ï¼ˆå¦‚&lt;code>proc&lt;/code>ï¼‰ï¼‰åˆ° &lt;code>target&lt;/code> æŒ‡å®šçš„ä½ç½®ï¼ˆç›®å½•æˆ–æ–‡ä»¶ï¼‰ã€‚åŒæ ·éœ€è¦ç‰¹æƒæ¥æ‰§è¡Œã€‚&lt;/p>
&lt;p>&lt;code>source&lt;/code>/&lt;code>target&lt;/code> éƒ½ä¸éš¾ç†è§£ï¼Œ&lt;code>filesystemtype&lt;/code>å¯ä»¥ä»&lt;code>/proc/filesystems&lt;/code>é‡Œè¯»åˆ°å¯ç”¨å€¼ï¼Œæˆ–è€…è‡ªå·±æœä¸€æœï¼›æ¯”è¾ƒé‡è¦çš„å°±æ˜¯ &lt;code>mountflags&lt;/code> äº†ï¼Œå¯ä»¥æŒ‡å®šè¯¸å¦‚&lt;code>MS_RDONLY&lt;/code>ä¹‹ç±»çš„é€‰é¡¹æ¥æŒ‚è½½åªè¯»æ–‡ä»¶ç³»ç»Ÿç­‰ç­‰ã€‚å…·ä½“è¿˜æ˜¯è‡ªå·±æŸ¥æ‰‹å†Œã€‚&lt;/p>
&lt;h3 id="clone">clone&lt;/h3>
&lt;p>æœ€åå°±æ˜¯ç³»ç»Ÿè°ƒç”¨ &lt;code>clone&lt;/code> äº†ã€‚è¿˜æ˜¯å…ˆ &lt;code>man 2 clone&lt;/code>ã€‚&lt;/p>
&lt;blockquote>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cm">/* Prototype for the glibc wrapper function */&lt;/span>
&lt;span class="cp">#define _GNU_SOURCE
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;sched.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">clone&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">fn&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">child_stack&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">flags&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">arg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">...&lt;/span>
&lt;span class="cm">/* pid_t *ptid, void *newtls, pid_t *ctid */&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="cm">/* For the prototype of the raw system call, see NOTES */&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>clone() creates a new process, in a manner similar to fork(2).&lt;/p>
&lt;/blockquote>
&lt;p>æ€»ä½“ç±»ä¼¼äº&lt;code>fork()&lt;/code>ï¼Œä½†å¯ä»¥æŒ‡å®šä¸€ä¸ªå…¥å£å‡½æ•°ï¼Œå‡½æ•°ç»“æŸåˆ™å­è¿›ç¨‹é€€å‡ºï¼Œä¹Ÿå¯ä»¥å…±äº«å†…å­˜ç©ºé—´ï¼Œæ‰€ä»¥è¡Œä¸ºä¹Ÿå¯ä»¥ç±»ä¼¼çº¿ç¨‹ã€‚çœ‹æ€ä¹ˆç”¨ã€‚&lt;/p>
&lt;p>&lt;code>flags&lt;/code>ä¾ç„¶æ˜¯å…³æ³¨çš„é‡ç‚¹ï¼Œ&lt;code>CLONE_NEWUTS&lt;/code>ã€&lt;code>CLONE_NEWNS&lt;/code>ã€&lt;code>CLONE_NEWPID&lt;/code>è¿™äº›å‚æ•°å…è®¸å°†å­è¿›ç¨‹è¿è¡Œåœ¨ç‹¬ç«‹çš„å‘½åç©ºé—´é‡Œã€‚&lt;/p>
&lt;p>&lt;code>man 2 clone&lt;/code> è¿˜æä¾›äº†ä¸€ä¸ª C è¯­è¨€ç¼–å†™çš„ä¾‹å­å¯ä»¥å‚è€ƒã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#define _GNU_SOURCE
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;sys/wait.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;sys/utsname.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;sched.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;string.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdio.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdlib.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;unistd.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="cp">#define errExit(msg) \
&lt;/span>&lt;span class="cp"> do \
&lt;/span>&lt;span class="cp"> { \
&lt;/span>&lt;span class="cp"> perror(msg); \
&lt;/span>&lt;span class="cp"> exit(EXIT_FAILURE); \
&lt;/span>&lt;span class="cp"> } while (0)
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="k">static&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="cm">/* Start function for cloned child */&lt;/span>
&lt;span class="n">childFunc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">arg&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="k">struct&lt;/span> &lt;span class="n">utsname&lt;/span> &lt;span class="n">uts&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="cm">/* Change hostname in UTS namespace of child */&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">sethostname&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">arg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">strlen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">arg&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">errExit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;sethostname&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="cm">/* Retrieve and display hostname */&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">uname&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">uts&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">errExit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;uname&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;uts.nodename in child: %s&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">uts&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">nodename&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="cm">/* Keep the namespace open for a while, by sleeping.
&lt;/span>&lt;span class="cm"> This allows some experimentation--for example, another
&lt;/span>&lt;span class="cm"> process might join the namespace. */&lt;/span>
&lt;span class="n">sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="cm">/* Child terminates now */&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="cp">#define STACK_SIZE (1024 * 1024) &lt;/span>&lt;span class="cm">/* Stack size for cloned child */&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">argc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[])&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">stack&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="cm">/* Start of stack buffer */&lt;/span>
&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">stackTop&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="cm">/* End of stack buffer */&lt;/span>
&lt;span class="n">pid_t&lt;/span> &lt;span class="n">pid&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">struct&lt;/span> &lt;span class="n">utsname&lt;/span> &lt;span class="n">uts&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">argc&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="n">fprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stderr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;Usage: %s &amp;lt;child-hostname&amp;gt;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="n">exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">EXIT_SUCCESS&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="cm">/* Allocate stack for child */&lt;/span>
&lt;span class="n">stack&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">malloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">STACK_SIZE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">stack&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">errExit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;malloc&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">stackTop&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">stack&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">STACK_SIZE&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="cm">/* Assume stack grows downward */&lt;/span>
&lt;span class="cm">/* Create child that has its own UTS namespace;
&lt;/span>&lt;span class="cm"> child commences execution in childFunc() */&lt;/span>
&lt;span class="n">pid&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">clone&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">childFunc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">stackTop&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">CLONE_NEWUTS&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">SIGCHLD&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">pid&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">errExit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;clone&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;clone() returned %ld&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">long&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">pid&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="cm">/* Parent falls through to here */&lt;/span>
&lt;span class="n">sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="cm">/* Give child time to change its hostname */&lt;/span>
&lt;span class="cm">/* Display hostname in parent&amp;#39;s UTS namespace. This will be
&lt;/span>&lt;span class="cm"> different from hostname in child&amp;#39;s UTS namespace. */&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">uname&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">uts&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">errExit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;uname&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;uts.nodename in parent: %s&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">uts&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">nodename&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">waitpid&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pid&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="cm">/* Wait for child */&lt;/span>
&lt;span class="n">errExit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;waitpid&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;child has terminated&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">EXIT_SUCCESS&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æŠŠä¸Šé¢çš„ä»£ç ä¿å­˜åˆ° &lt;code>main.c&lt;/code> ä¹‹åï¼Œä½¿ç”¨å‘½ä»¤ &lt;code>gcc main.c -o clone-demo&lt;/code> ç¼–è¯‘ã€‚&lt;/p>
&lt;p>ç¼–è¯‘å®Œæˆåï¼Œ&lt;code>sudo ./clone-demo new-hostname&lt;/code> æ‰§è¡Œã€‚&lt;/p>
&lt;p>æœ€ç»ˆç»“æœç±»ä¼¼è¿™æ ·&lt;/p>
&lt;pre>&lt;code>DESKTOP-HEKKTQ9 :: ~/repos/container Â» sudo ./clone-demo new-hostname
clone() returned 1515
uts.nodename in child: new-hostname
uts.nodename in parent: DESKTOP-HEKKTQ9
child has terminated
DESKTOP-HEKKTQ9 :: ~/repos/container Â»
&lt;/code>&lt;/pre>&lt;h3 id="setns">setns&lt;/h3>
&lt;p>&lt;code>setns&lt;/code> æŠŠè°ƒç”¨è¿™ä¸ªå‡½æ•°çš„çº¿ç¨‹åŠ å…¥æŒ‡å®š fd çš„å‘½åç©ºé—´é‡Œã€‚è¿™ä¸ª &lt;code>fd&lt;/code> æŒ‡çš„æ˜¯ &lt;code>/proc/1234/ns/uts&lt;/code> è¿™äº›ç‰¹æ®Šæ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ã€‚&lt;/p>
&lt;p>ä¸¾ä¾‹æ¥è¯´ï¼Œæˆ‘ä»¬æŠŠ &lt;code>clone-demo&lt;/code> çš„æºç é‡Œï¼Œ&lt;code>sleep(3)&lt;/code> æ”¹ä¸º &lt;code>sleep(200)&lt;/code>ï¼Œå†æ‰§è¡Œ&lt;code>sudo clone-demo new-hostname &amp;amp;&lt;/code> æŠŠè¿›ç¨‹æ”¾åˆ°åå°ã€‚&lt;/p>
&lt;p>ç„¶åç¼–è¯‘ä¸‹é¢çš„ä»£ç å¹¶æµ‹è¯•åŠ å…¥ clone-demo çš„ uts åç§°ç©ºé—´ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#define _GNU_SOURCE
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;fcntl.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;sched.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;unistd.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdlib.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdio.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="cp">#define errExit(msg) \
&lt;/span>&lt;span class="cp"> do \
&lt;/span>&lt;span class="cp"> { \
&lt;/span>&lt;span class="cp"> perror(msg); \
&lt;/span>&lt;span class="cp"> exit(EXIT_FAILURE); \
&lt;/span>&lt;span class="cp"> } while (0)
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">argc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[])&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">fd&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">argc&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="n">fprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stderr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;%s /proc/PID/ns/FILE cmd args...&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="n">exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">EXIT_FAILURE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">fd&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">O_RDONLY&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="cm">/* Get file descriptor for namespace */&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">fd&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">errExit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;open&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">setns&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="cm">/* Join that namespace */&lt;/span>
&lt;span class="n">errExit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;setns&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">execvp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">]);&lt;/span> &lt;span class="cm">/* Execute a command in namespace */&lt;/span>
&lt;span class="n">errExit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;execvp&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ€ç»ˆç»“æœå¦‚ä¸‹&lt;/p>
&lt;pre>&lt;code>root@DESKTOP-HEKKTQ9:/home/weakptr/repos/container# ./clone-demo new-hostname &amp;amp;
[1] 1826
clone() returned 1827
uts.nodename in child: new-hostname
uts.nodename in parent: DESKTOP-HEKKTQ9
root@DESKTOP-HEKKTQ9:/home/weakptr/repos/container# ./setns-demo /proc/1827/ns/uts /bin/bash
root@new-hostname:/home/weakptr/repos/container# uname -n
new-hostname
root@new-hostname:/home/weakptr/repos/container# exit
root@DESKTOP-HEKKTQ9:/home/weakptr/repos/container# exit
DESKTOP-HEKKTQ9 :: ~/repos/container Â» uname -n
DESKTOP-HEKKTQ9
&lt;/code>&lt;/pre>&lt;h3 id="unshare">unshare&lt;/h3>
&lt;blockquote>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#define _GNU_SOURCE
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;sched.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">unshare&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">flags&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/blockquote>
&lt;p>&lt;code>unshare&lt;/code> ç”¨äºä¸»åŠ¨è§£é™¤å½“å‰è¿›ç¨‹æˆ–çº¿ç¨‹ä»çˆ¶è¿›ç¨‹ç»§æ‰¿çš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆä¾‹å¦‚å‘½åç©ºé—´ï¼‰ã€‚&lt;/p>
&lt;p>&lt;code>unshare&lt;/code>çš„ä¸»è¦ç”¨é€”å°±æ˜¯åœ¨ä¸åˆ›å»ºæ–°çš„è¿›ç¨‹çš„å‰æä¸‹ï¼Œæ§åˆ¶è‡ªå·±çš„å…±äº«æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆè¿˜æ˜¯æŒ‡å‘½åç©ºé—´ï¼‰ã€‚&lt;/p>
&lt;p>å‚æ•° &lt;code>flags&lt;/code> ä¾ç„¶æ˜¯ &lt;code>CLONE_NEWNS&lt;/code> è¿™äº›å¸¸é‡ã€‚æƒ¯ä¾‹è¿˜æ˜¯æœ‰ä¸ª demo ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cm">/* unshare.c
&lt;/span>&lt;span class="cm">
&lt;/span>&lt;span class="cm"> A simple implementation of the unshare(1) command: unshare
&lt;/span>&lt;span class="cm"> namespaces and execute a command.
&lt;/span>&lt;span class="cm">*/&lt;/span>
&lt;span class="cp">#define _GNU_SOURCE
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;sched.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;unistd.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdlib.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdio.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;wait.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="cm">/* A simple error-handling function: print an error message based
&lt;/span>&lt;span class="cm"> on the value in &amp;#39;errno&amp;#39; and terminate the calling process */&lt;/span>
&lt;span class="cp">#define errExit(msg) \
&lt;/span>&lt;span class="cp"> do \
&lt;/span>&lt;span class="cp"> { \
&lt;/span>&lt;span class="cp"> perror(msg); \
&lt;/span>&lt;span class="cp"> exit(EXIT_FAILURE); \
&lt;/span>&lt;span class="cp"> } while (0)
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="k">static&lt;/span> &lt;span class="kt">void&lt;/span>
&lt;span class="nf">usage&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">pname&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="n">fprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stderr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;Usage: %s [options] program [arg...]&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">pname&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">fprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stderr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;Options can be:&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">fprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stderr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34; -i unshare IPC namespace&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">fprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stderr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34; -m unshare mount namespace&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">fprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stderr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34; -n unshare network namespace&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">fprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stderr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34; -p unshare PID namespace&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">fprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stderr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34; -u unshare UTS namespace&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">fprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stderr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34; -U unshare user namespace&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">EXIT_FAILURE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">argc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[])&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">flags&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">opt&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">flags&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">while&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">opt&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">getopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">argc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">argv&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;imnpuU&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">opt&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="sc">&amp;#39;i&amp;#39;&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">flags&lt;/span> &lt;span class="o">|=&lt;/span> &lt;span class="n">CLONE_NEWIPC&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="sc">&amp;#39;m&amp;#39;&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">flags&lt;/span> &lt;span class="o">|=&lt;/span> &lt;span class="n">CLONE_NEWNS&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="sc">&amp;#39;n&amp;#39;&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">flags&lt;/span> &lt;span class="o">|=&lt;/span> &lt;span class="n">CLONE_NEWNET&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="sc">&amp;#39;p&amp;#39;&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">flags&lt;/span> &lt;span class="o">|=&lt;/span> &lt;span class="n">CLONE_NEWPID&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="sc">&amp;#39;u&amp;#39;&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">flags&lt;/span> &lt;span class="o">|=&lt;/span> &lt;span class="n">CLONE_NEWUTS&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="sc">&amp;#39;U&amp;#39;&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">flags&lt;/span> &lt;span class="o">|=&lt;/span> &lt;span class="n">CLONE_NEWUSER&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">usage&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">optind&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="n">argc&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">usage&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">unshare&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">flags&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">errExit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;unshare&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">pid_t&lt;/span> &lt;span class="n">pid&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fork&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">pid&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;child process&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">execvp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">optind&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">optind&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="n">errExit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;execvp&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">else&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;waitpid %ld&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">pid&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">waitpid&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pid&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¿å­˜æˆ &lt;code>unshare.c&lt;/code>ï¼Œä½¿ç”¨&lt;code>gcc unshare.c -o unshare&lt;/code> ç¼–è¯‘ã€‚&lt;/p>
&lt;p>ä¹‹åå¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤æ¥æ£€æŸ¥æ•ˆæœã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">sudo ./unshare -pm /bin/bash &lt;span class="c1"># éš”ç¦» mount å’Œ pid ä¸¤ä¸ª namespace&lt;/span>
waitpid &lt;span class="m">2178&lt;/span>
root@DESKTOP-HEKKTQ9:/home/weakptr/repos/container# mount -t proc proc /proc
root@DESKTOP-HEKKTQ9:/home/weakptr/repos/container# ps -ef
UID PID PPID C STIME TTY TIME CMD
root &lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> 15:22 pts/0 00:00:00 /bin/bash
root &lt;span class="m">3&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> 15:22 pts/0 00:00:00 ps -ef
root@DESKTOP-HEKKTQ9:/home/weakptr/repos/container#
&lt;/code>&lt;/pre>&lt;/div>&lt;p>éœ€è¦æ³¨æ„å‡ ä¸ªç‚¹ï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;code>unshare&lt;/code> æœ€åå¿…é¡»æ˜¯ &lt;code>fork&lt;/code> æ–°è¿›ç¨‹å† &lt;code>execvp&lt;/code>ï¼Œå¦åˆ™ä¼šå‡ºç° &lt;code>cannot allocate memory&lt;/code> é”™è¯¯&lt;/li>
&lt;li>&lt;code>unshare&lt;/code> å¯åŠ¨æ–°çš„ &lt;code>/bin/bash&lt;/code> è¿›ç¨‹åï¼Œ&lt;code>/proc&lt;/code> æŒ‚è½½ç‚¹è¿˜æ²¡æœ‰çœŸæ­£éš”ç¦»ï¼Œæ­¤æ—¶å¯ä»¥æ‰‹åŠ¨ä½¿ç”¨ &lt;code>mount -t proc proc /proc&lt;/code> å‘½ä»¤æŒ‚è½½å½“å‰å‘½åç©ºé—´çš„ &lt;code>procfs&lt;/code>ã€‚&lt;/li>
&lt;li>mount namespace ä¸­æŒ‚è½½äº‹ä»¶ä¼ æ’­ï¼Œå¯ä»¥æŸ¥çœ‹æ–‡æ¡£ &lt;code>man 7 mount_namespaces&lt;/code>ã€‚&lt;/li>
&lt;/ol>
&lt;p>debian ç³»çš„ Linux å‘è¡Œç‰ˆåœ¨ util-linux åŒ…é‡Œæä¾›äº†ä¸€ä¸ª &lt;code>unshare&lt;/code> ç¨‹åºï¼Œæ¯”ä¸Šé¢çš„ demo æ›´å¼ºå¤§ï¼Œç”šè‡³å¯ä»¥ç”¨ä¸€è¡Œå‘½ä»¤å®ç°ä¸€ä¸ªåŸºæœ¬çš„&lt;em>å®¹å™¨&lt;/em>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="c1"># æˆ‘åœ¨ workspace ç›®å½•é‡Œè£…äº† busyboxï¼Œæ‰€ä»¥èƒ½ç›´æ¥è·‘èµ·æ¥ chroot å’Œ /bin/ash&lt;/span>
&lt;span class="c1"># busybox çš„å®‰è£…æ–¹æ³•å‚è€ƒ busybox æºç ç›®å½•ä¸‹çš„ INSTALL æ–‡ä»¶&lt;/span>
&lt;span class="c1"># vim Config.in ä¿®æ”¹ config STATIC ä¸‹çš„ default ä¸º y&lt;/span>
&lt;span class="c1"># make defconfig &amp;amp;&amp;amp; make &amp;amp;&amp;amp; make install CONFIG_PREFIX=ä½ çš„workspaceç›®å½•&lt;/span>
sudo unshare -pumf --mount-proc&lt;span class="o">=&lt;/span>workspace/proc chroot workspace /bin/ash
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç»“æœï¼š&lt;/p>
&lt;pre>&lt;code>/ # ps -ef
PID USER TIME COMMAND
1 0 0:00 /bin/ash
2 0 0:00 ps -ef
/ # ls
bin linuxrc proc sbin usr
/ # mount
proc on /proc type proc (rw,nosuid,nodev,noexec,relatime)
/ #
&lt;/code>&lt;/pre>&lt;h2 id="ç”¨-go-å®ç°">ç”¨ go å®ç°&lt;/h2>
&lt;h3 id="syscall">syscall&lt;/h3>
&lt;p>go å¯¹ç³»ç»Ÿè°ƒç”¨å…¶å®åšäº†ä¸å°‘å°è£…ï¼ŒåŸºæœ¬åœ¨ &lt;code>os&lt;/code> å’Œ &lt;code>syscall&lt;/code> ä¸‹ï¼Œä½†æœ‰å¾ˆå¤šåŒºåˆ«ã€‚æ¯”å¦‚åœ¨ go é‡Œæ‰¾ä¸åˆ° &lt;code>clone&lt;/code>ã€&lt;code>setns&lt;/code> è¿™äº›æ¥å£ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ &lt;code>os/exec&lt;/code> ä¸‹çš„ &lt;code>Cmd&lt;/code> ç»“æ„ã€‚ä¸è¿‡ &lt;code>syscall.Unshare&lt;/code> å€’æ˜¯å¾ˆå¿ å®çš„è¿˜åŸäº†ã€‚è¯¸å¦‚ &lt;code>CLONE_NEWNS&lt;/code> è¿™äº›å¸¸é‡ä¹Ÿå¯ä»¥æ‰¾åˆ°å¯¹åº”çš„ &lt;code>syscall.CLONE_NEWNS&lt;/code>ã€‚&lt;/p>
&lt;p>ä¸é‡å¤ä¸Šé¢çš„ä»£ç äº†ï¼Œå†™ä¸€ä¸ªç®€çŸ­çš„å¯åŠ¨ busybox å®¹å™¨çš„ go ç¨‹åºã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;flag&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;os&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;os/exec&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;syscall&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">flagBootstrap&lt;/span> &lt;span class="kt">bool&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">init&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">BoolVar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">flagBootstrap&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;bootstrap&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;bootstrap busybox container&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">must&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">runBusybox&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Start `busybox ash` in process %d\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Getpid&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="nx">cmd&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">exec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Command&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/bin/busybox&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;ash&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stdin&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stdin&lt;/span>
&lt;span class="nx">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stdout&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stdout&lt;/span>
&lt;span class="nx">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stderr&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stderr&lt;/span>
&lt;span class="nx">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Env&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Env&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;PATH=/bin:/sbin:/usr/bin:/usr/sbin&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">must&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Chroot&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;workspace&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="nf">must&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Chdir&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="nf">must&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Mount&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;proc&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;/proc&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;proc&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="nf">must&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Run&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="nb">println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;unmount proc&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">must&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unmount&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;proc&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">runContainerizedCommand&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">cmd&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">exec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Command&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/proc/self/exe&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Path&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;/proc/self/exe&amp;#34;&lt;/span>
&lt;span class="nx">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Args&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Args&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;-bootstrap&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stdin&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stdin&lt;/span>
&lt;span class="nx">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stdout&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stdout&lt;/span>
&lt;span class="nx">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stderr&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stderr&lt;/span>
&lt;span class="nx">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SysProcAttr&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SysProcAttr&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Cloneflags&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CLONE_NEWUTS&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CLONE_NEWNS&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CLONE_NEWPID&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Unshareflags&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CLONE_NEWNS&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;starting current process %d\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Getpid&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="nf">must&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Run&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Parse&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">flagBootstrap&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">runBusybox&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nf">runContainerizedCommand&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¿å­˜ä¸º &lt;code>demo.go&lt;/code> åç”¨ &lt;code>go build -o demo demo.go&lt;/code> ç¼–è¯‘ï¼Œç„¶åæ‰§è¡Œ &lt;code>sudo ./demo&lt;/code> ã€‚&lt;/p>
&lt;p>ç»“æœåƒæ˜¯è¿™æ ·ï¼š&lt;/p>
&lt;pre>&lt;code>DESKTOP-HEKKTQ9 :: ~/repos/container Â» sudo ./demo
starting current process 2954
Start `busybox ash` in process 1
/ # ps -ef
PID USER TIME COMMAND
1 0 0:00 /proc/self/exe -bootstrap
6 0 0:00 /bin/busybox ash
7 0 0:00 ps -ef
/ # mount
proc on /proc type proc (rw,relatime)
/ #
unmount proc
DESKTOP-HEKKTQ9 :: ~/repos/container Â»
&lt;/code>&lt;/pre>&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>ä¸Šé¢çš„ demo ä»…ä»…æ˜¯åˆ›å»ºäº†ä¸€ä¸ªçœ‹èµ·æ¥åƒå®¹å™¨çš„ç©å…·ï¼Œè¿ cgroup éƒ½æ²¡æœ‰ï¼Œè·ç¦»çœŸæ­£çš„ OCI è¿è¡Œæ—¶è¿˜æœ‰ä¸å°å·®è·ã€‚ä¸è¿‡å·²ç»è¶³å¤Ÿå±•ç¤ºåˆ›å»ºä¸€ä¸ªéš”ç¦»çš„ç¯å¢ƒå¹¶ä¸æ˜¯ç‰¹åˆ«å›°éš¾çš„äº‹æƒ…ï¼Œè¿™å¿…é¡»æ„Ÿè°¢ Linux å†…æ ¸çš„å¼€å‘è€…ä»¬è®©å®¹å™¨æŠ€æœ¯æœ‰äº†å­˜åœ¨çš„å¯èƒ½ï¼Œè€Œä¸”è¿˜èƒ½è¿™ä¹ˆç®€å•åœ°ä½¿ç”¨ã€‚&lt;/p>
&lt;p>å¯ä»¥ç‚¹å‡»[è¿™ä¸ªé“¾æ¥](&lt;a class="link" href="https://github.com/opencontainers/runtime-spec/blob/master/spec.md" target="_blank" rel="noopener"
>runtime-spec/spec.md at master Â· opencontainers/runtime-spec (github.com)&lt;/a>)æŸ¥çœ‹ OCI è¿è¡Œæ—¶çš„è§„æ ¼è¯´æ˜ã€‚&lt;/p>
&lt;p>æ¶‰åŠæ¦‚å¿µï¼š&lt;/p>
&lt;ul>
&lt;li>namespace&lt;/li>
&lt;/ul>
&lt;p>é‡è¦ç³»ç»Ÿè°ƒç”¨&lt;/p>
&lt;ul>
&lt;li>&lt;code>clone&lt;/code>&lt;/li>
&lt;li>&lt;code>setns&lt;/code>&lt;/li>
&lt;li>&lt;code>unshare&lt;/code>&lt;/li>
&lt;li>&lt;code>mount&lt;/code>&lt;/li>
&lt;li>&amp;hellip;&lt;/li>
&lt;/ul>
&lt;p>æœ¬ç¯‡è¿˜ä¸æ¶‰åŠç½‘ç»œï¼Œä»…åœ¨æ–‡ä»¶ç³»ç»Ÿå’Œ PIDã€ç”¨æˆ·ç­‰å±‚çº§åšäº†éš”ç¦»ã€‚ç½‘ç»œéš”ç¦»å¯ä»¥å‚è€ƒ &lt;code>man 7 network_namespaces&lt;/code> ï¼Œä¸è¿‡è°·æ­Œæœäº†ä¸€å¤§åœˆä¹Ÿè¿˜æ²¡æ‰¾åˆ°æ€ä¹ˆåˆ›å»ºè™šæ‹Ÿç½‘å¡ï¼Œæš‚ä¸”å…ˆæ”¾ç€äº†ã€‚&lt;/p></description></item><item><title>go çš„ defer è¯­å¥</title><link>https://nnnewb.github.io/blog/p/go-%E7%9A%84-defer-%E8%AF%AD%E5%8F%A5/</link><pubDate>Tue, 05 Jan 2021 10:01:48 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/go-%E7%9A%84-defer-%E8%AF%AD%E5%8F%A5/</guid><description>&lt;p>æ˜¨å¤©å¯¹é¡¹ç›®åšäº†ä¸ªå°é‡æ„ï¼Œä¸»è¦æ˜¯å¯¹ä»¥å‰æ‰‹å†™çš„ stmt.Close æ²¡å¤„ç†è¿”å›å€¼çš„é—®é¢˜ã€è¿˜æœ‰å„ç§è¯¥è®°å½•æ—¥å¿—çš„åœ°æ–¹æ²¡è®°æ—¥å¿—ç­‰ç­‰ï¼Œåšäº†ä¸‹å¤„ç†ã€‚&lt;/p>
&lt;p>è€å®è¯´è¿™äº‹å„¿åšç€åšç€è¿˜æœ‰ç§å¥‡å¦™çš„å¿«æ„Ÿï¼Œç±»ä¼¼äºçœ‹é«˜å‹æ°´æªæ¸…æ±¡è§†é¢‘çš„æ„Ÿè§‰ã€‚å“ˆå“ˆï¼Œä¹Ÿäºé¢†å¯¼ä¸ç®¡äº‹ï¼Œä»£ç ä¹Ÿä¸ Review ï¼Œæµ‹è¯•=æ‘†è®¾ã€‚&lt;/p>
&lt;p>è¿™ä¸ä¸€ä¸Šç­å°±å‘ç°å¥½å¤šé—®é¢˜ï¼Œå¹¸å¥½åªæ¨é€åˆ°å†…ç½‘ã€‚&lt;/p>
&lt;p>ç¬‘ä¸­å¸¦æ³ª.gif&lt;/p>
&lt;!-- more -->
&lt;h2 id="0x01-é—®é¢˜æè¿°">0x01 é—®é¢˜æè¿°&lt;/h2>
&lt;p>é—®é¢˜å€’æ˜¯æŒºç®€å•çš„ï¼Œçœ‹ä¸‹é¢çš„ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">stmt&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Prepare&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">query&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nf">SilentLogError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">stmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="s">&amp;#34;stmt close failed&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">row&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">stmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">QueryRow&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">params&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">row&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">row&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Scan&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">vars&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">vars&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>é‚£ä¹ˆï¼Œè¯·é—®ä¸Šé¢çš„ä»£ç æœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ&lt;/p>
&lt;p>æ ‡é¢˜éƒ½è¯´äº† defer äº†ï¼Œé‚£é—®é¢˜è‚¯å®šæ˜¯å‡ºåœ¨ defer è¿™ä¸€è¡Œä¸Šã€‚&lt;/p>
&lt;h2 id="0x02-defer-çš„æ±‚å€¼">0x02 defer çš„æ±‚å€¼&lt;/h2>
&lt;p>ç®€å•çš„ç»“è®ºå°±æ˜¯: &lt;em>defer f() çš„å‚æ•°åœ¨ defer è¿™ä¸€è¡Œæ±‚å€¼&lt;/em>&lt;/p>
&lt;p>å…·ä½“åˆ°ä¸Šé¢çš„ä¾‹å­ï¼Œ&lt;code>defer f(i())&lt;/code> è¿™æ ·çš„å½¢å¼ï¼Œå¯ä»¥å…ˆåˆ†æˆä¸‰ä¸ªéƒ¨åˆ†ã€‚&lt;/p>
&lt;ol>
&lt;li>&lt;code>defer&lt;/code> æœ¬èº«çš„æ‰§è¡Œæ—¶æœº&lt;/li>
&lt;li>&lt;code>i()&lt;/code> çš„æ±‚å€¼æ—¶æœº&lt;/li>
&lt;li>&lt;code>f()&lt;/code> çš„æ±‚å€¼æ—¶æœº&lt;/li>
&lt;/ol>
&lt;p>æŠŠè¿™ä¸‰éƒ¨åˆ†æ’ä¸€ä¸‹åº:&lt;/p>
&lt;ol>
&lt;li>&lt;code>i()&lt;/code>&lt;/li>
&lt;li>&lt;code>defer&lt;/code>
&lt;blockquote>
&lt;p>defer æŠŠå‚æ•°æ±‚å€¼ååŒ…è£…æˆä¸€ä¸ªæ–°å‡½æ•°å»¶è¿Ÿæ‰§è¡Œ&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;li>&lt;code>f()&lt;/code>&lt;/li>
&lt;/ol>
&lt;h2 id="0x03-å¾ªç¯å†…-defer">0x03 å¾ªç¯å†… defer&lt;/h2>
&lt;p>å¾ªç¯å†… defer ä¸»è¦æœ‰ä¸¤ä¸ªé—®é¢˜&lt;/p>
&lt;ol>
&lt;li>å¯èƒ½äº§ç”Ÿé€ æˆå·¨é‡çš„ defer å‡½æ•°ï¼Œè€—å°½å†…å­˜æˆ–æ‹–å®æ‰§è¡Œé€Ÿåº¦&lt;/li>
&lt;li>åœ¨ä¸€äº›æƒ…å†µä¸‹ä¼šé€ æˆæ„æ–™å¤–çš„ç»“æœ&lt;/li>
&lt;/ol>
&lt;p>çœ‹ä¾‹å­&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">Conn&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">ID&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewConn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">id&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Conn&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">Conn&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">ID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">id&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Conn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;close %d!\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ID&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">arr&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="nx">Conn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">arr&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">arr&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="nx">ID&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">i&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">conn&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">arr&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ€ç»ˆè¾“å‡ºæ˜¯&lt;/p>
&lt;pre>&lt;code>close 4!
close 4!
close 4!
close 4!
close 4!
&lt;/code>&lt;/pre>&lt;p>é€ æˆè¿™ä¸€ç»“æœçš„åŸå› æ˜¯æ¥æ”¶å™¨(receiver)ä¹Ÿä½œä¸ºå‡½æ•°å‚æ•°çš„ä¸€éƒ¨åˆ†åœ¨ defer æ—¶è¢«æ±‚å€¼ã€‚&lt;/p>
&lt;p>&lt;code>for _, conn := range arr&lt;/code> è¿™ä¸€è¡Œä»£ç ä¸­ï¼Œ&lt;code>conn&lt;/code> æœ¬è´¨æ˜¯ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œå…¶å†…å­˜åœ¨å¾ªç¯æœŸé—´å¯ä»¥è§†ä½œå›ºå®šçš„ï¼Œè€Œ&lt;code>func (c *Conn) Close() error&lt;/code> æ¥æ”¶å™¨å–äº†è¿™ä¸ªå±€éƒ¨å˜é‡çš„åœ°å€ï¼šæ¯ä¸€æ¬¡å¾ªç¯ï¼Œè°ƒç”¨ Close æ—¶ï¼Œå–å¾—çš„éƒ½æ˜¯åŒä¸€ä¸ªåœ°å€ã€‚æœ€ç»ˆå¯¼è‡´ Close çš„å…¨éƒ¨éƒ½æ˜¯ conn åœ¨å‡½æ•°ç»“æŸæ—¶æœ€åå¾—åˆ°çš„å€¼ã€‚&lt;/p>
&lt;p>ç±»ä¼¼çš„ï¼Œå¦‚æœæŠŠæ¥æ”¶å™¨ä»æŒ‡é’ˆæ”¹æˆå€¼å‘¢ï¼Ÿæ¥æ”¶å™¨å˜æˆäº†å€¼ä¼ é€’ï¼Œå°†&lt;code>conn&lt;/code>å¤åˆ¶ä¸€æ¬¡åä¿ç•™ä½œä¸º defer å‡½æ•°æ‰§è¡Œæ—¶çš„å‚æ•°ï¼Œå°±ä¼šæœ‰æ­£å¸¸çš„ç»“æœã€‚&lt;/p>
&lt;p>ä½†å¹¶ä¸æ˜¯è¯´å¾ªç¯å†… defer &lt;strong>ä¸€å®šæ˜¯&lt;/strong> ä¸å¥½çš„ã€‚&lt;/p>
&lt;p>æ¯”å¦‚ä¸€ä¸ªå¸¸è§çš„åœºæ™¯ï¼Œåœ¨å¾ªç¯é‡Œä½¿ç”¨ SQL æŸ¥è¯¢ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">for&lt;/span> &lt;span class="nx">query&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">queries&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">rows&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Query&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">query&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">rows&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥æ˜ç¡®çŸ¥é“ &lt;code>rows&lt;/code> æ˜¯æŒ‡é’ˆï¼Œè€Œä¸” &lt;code>rows.Close&lt;/code> æœ‰æŒ‡é’ˆæ¥æ”¶å™¨ï¼Œå°±å¯ä»¥ç¡®å®šä¸ä¼šæœ‰é—®é¢˜ã€‚&lt;/p>
&lt;h2 id="0x04-defer-å’Œé—­åŒ…">0x04 defer å’Œé—­åŒ…&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">Conn&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">ID&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewConn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">id&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Conn&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">Conn&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">ID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">id&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Conn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;close %d!\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ID&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">conn&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">Conn&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">}()&lt;/span>
&lt;span class="nx">conn&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">Conn&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">}()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å’Œä¸Šé¢ç±»ä¼¼ï¼Œè¿™æ¬¡è¾“å‡ºæ˜¯:&lt;/p>
&lt;pre>&lt;code>close 2!
close 2!
&lt;/code>&lt;/pre>&lt;p>é—®é¢˜å‡ºç°åœ¨ defer åé¢è¿™ä¸ªç”»è›‡æ·»è¶³çš„ &lt;code>func(){}()&lt;/code> ä¸Šã€‚ä¼—æ‰€å‘¨çŸ¥ defer ä¼šå¯¹å‚æ•°æ±‚å€¼ï¼Œä½†é—­åŒ…æ•è·çš„å˜é‡å¹¶ä¸ä¼šã€‚&lt;/p>
&lt;p>å› æ­¤ï¼Œå³ä½¿ &lt;code>defer conn.Close()&lt;/code> å·¥ä½œæ­£å¸¸ï¼Œä½† defer &lt;code>defer func() {conn.Close()}()&lt;/code> å°±ä¸ä¸€å®šäº†ã€‚ä¸¤è€…åœ¨éƒ¨åˆ†æƒ…å†µä¸‹å¹¶ä¸èƒ½ç­‰ä»·ä»£æ¢ï¼Œé™¤éä½ ç¡®ä¿¡äº†è§£è‡ªå·±åšäº†ä»€ä¹ˆã€‚&lt;/p>
&lt;p>å¦‚æœä¸€å®šè¦ç”¨ &lt;code>func(){}()&lt;/code> çš„å½¢å¼ï¼Œé‚£ä¹ˆ conn åªèƒ½é€šè¿‡å‚æ•°å½¢å¼ä¼ é€’ç»™è¿™ä¸ªåŒ¿åå‡½æ•°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">conn&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Conn&lt;/span>&lt;span class="p">){&lt;/span>
&lt;span class="nx">_&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}(&lt;/span>&lt;span class="nx">conn&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯¹ï¼Œè¯´çš„å°±æ˜¯çƒ¦äººçš„&lt;em>æœªå¤„ç†çš„é”™è¯¯&lt;/em>è­¦å‘Šã€‚&lt;/p>
&lt;h2 id="0x05-happy-hacking">0x05 Happy Hacking!&lt;/h2>
&lt;p>æƒ¯ä¾‹ï¼Œå®Œã€‚&lt;/p></description></item><item><title>goè¯­è¨€å®æˆ˜ä¹‹è§£å¯†onsè„šæœ¬</title><link>https://nnnewb.github.io/blog/p/go%E8%AF%AD%E8%A8%80%E5%AE%9E%E6%88%98%E4%B9%8B%E8%A7%A3%E5%AF%86ons%E8%84%9A%E6%9C%AC/</link><pubDate>Sun, 16 Dec 2018 23:44:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/go%E8%AF%AD%E8%A8%80%E5%AE%9E%E6%88%98%E4%B9%8B%E8%A7%A3%E5%AF%86ons%E8%84%9A%E6%9C%AC/</guid><description>&lt;h2 id="intro">Intro&lt;/h2>
&lt;p>ons æ˜¯ä¸€ä¸ªå¼€æ”¾æºä»£ç çš„è§†è§‰å°è¯´å¼•æ“ï¼Œä»¥ç®€å•å®ç”¨å‡ºåã€‚æœ¬åšç”¨ golang æ¥è§£å¯† ons å¼•æ“çš„&lt;code>.dat&lt;/code>å’Œ&lt;code>.nt2&lt;/code>è„šæœ¬ï¼Œä¸»è¦å®è·µç›®æ ‡æ˜¯å¼‚æ­¥è§£å¯†è¾“å‡ºã€‚&lt;/p>
&lt;h2 id="ç®—æ³•">ç®—æ³•&lt;/h2>
&lt;p>&lt;code>.dat&lt;/code>çš„åŠ å¯†éå¸¸ç®€å•ï¼Œä¸€æ¬¡å¼‚æˆ–ã€‚å¯†ç æ˜¯&lt;code>0x84&lt;/code>ã€‚&lt;/p>
&lt;p>å¯ä»¥ç”¨ go éå¸¸ç®€å•ç²—æš´åœ°å†™å‡ºä»¥ä¸‹ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">buf&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">^=&lt;/span> &lt;span class="mh">0x84&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>.nt2&lt;/code>çš„åŠ å¯†åŒæ ·ç®€å•ï¼Œä¸€æ¬¡å¼‚æˆ–ï¼Œå¯†ç æ˜¯&lt;code>0x85 &amp;amp; 0x97&lt;/code>ã€‚&lt;/p>
&lt;p>å¯ä»¥ç”¨ go éå¸¸ç²—æš´åœ°å†™å‡ºä»¥ä¸‹ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">buf&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">^&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mh">0x85&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mh">0x97&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å¼‚æ­¥è¯»æ–‡ä»¶">å¼‚æ­¥è¯»æ–‡ä»¶&lt;/h2>
&lt;p>go æ–¹å¼æ¯”è¾ƒå¤šï¼Œ&lt;code>ioutil&lt;/code>æˆ–è€…&lt;code>bufio&lt;/code>æˆ–è€…&lt;code>os&lt;/code>éƒ½æœ‰æ–‡ä»¶æ¨¡å—ã€‚è¿™é‡Œé‡‡ç”¨&lt;code>bufio&lt;/code>å¥—&lt;code>os.Open&lt;/code>çš„æ–¹å¼è¯»æ–‡ä»¶ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">readFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">outChannel&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// åªè¯»æ–¹å¼æ‰“å¼€æ–‡ä»¶
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">OpenFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">O_RDONLY&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mo">0644&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// åŒ…è£…ä¸€å±‚ bufio
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">reader&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">bufio&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewReader&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">file&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// å‡†å¤‡ä¸€ä¸ªä¿å­˜è¯»å–ç»“æœçš„buf
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">var&lt;/span> &lt;span class="nx">buf&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">new&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="mi">1024000&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// å¾ªç¯è¯»
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">reader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">[:])&lt;/span>
&lt;span class="c1">// æ²¡æœ‰å†…å®¹äº†å°±é€€å‡ºå¾ªç¯
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">break&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// æŠŠè¯»åˆ°çš„ç»“æœç”¨ channel ä¼ é€’ç»™ä¸‹ä¸€é“å¤„ç†å·¥åº
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">outChannel&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">buf&lt;/span>&lt;span class="p">[:&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">outChannel&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å¼‚æ­¥å†™æ–‡ä»¶">å¼‚æ­¥å†™æ–‡ä»¶&lt;/h2>
&lt;p>å†™æ–‡ä»¶çš„æ–¹å¼å’Œè¯»æ–‡ä»¶çš„æ–¹å¼å·®ä¸å¤šï¼Œç”±é‚£å‡ ä¸ªåŒ…æä¾›ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">writeFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">outChannel&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">done&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// åªè¯»æ–¹å¼æ‰“å¼€æ–‡ä»¶ï¼Œå·²å­˜åœ¨æ–‡ä»¶åˆ™æ¸…ç©ºå†…å®¹ï¼Œæœªå­˜åœ¨æ–‡ä»¶åˆ™åˆ›å»ºï¼Œæ–‡ä»¶æƒé™ rw-r--r--
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">OpenFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">O_WRONLY&lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">O_TRUNC&lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">O_CREATE&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mo">0644&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">writer&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">bufio&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewWriter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">file&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ä»ä¸Šä¸€é“å·¥åºå–å¾—è§£å¯†åçš„æ•°æ®
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">buf&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">more&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">outChannel&lt;/span>
&lt;span class="c1">// å¦‚æœæ‰€æœ‰æ•°æ®å…¨éƒ¨å–å¾—ï¼Œåˆ™ç»“æŸå†™å…¥
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">more&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">break&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// å†™å…¥
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">writer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">writer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Flush&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">done&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å¼‚æ­¥è§£å¯†">å¼‚æ­¥è§£å¯†&lt;/h2>
&lt;p>è§£å¯†è¿‡ç¨‹å°±åƒæ˜¯æ°´ç®¡ä¸Šçš„è¿‡æ»¤å™¨ï¼Œæ°´æµè¿›æ¥å¤„ç†å¥½ï¼Œæµå‡ºå»ã€‚å†…å®¹ä¹å–„å¯é™ˆï¼Œå°±ç›´æ¥ä¸¢ä»£ç å¥½äº†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">decodeDat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inChannel&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">outChannel&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">buf&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">more&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">inChannel&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">more&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">break&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">buf&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">^=&lt;/span> &lt;span class="mh">0x84&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">outChannel&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">buf&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">outChannel&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">decodeNt2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inChannel&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">outChannel&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">buf&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">more&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">inChannel&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">more&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">break&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">buf&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">^&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mh">0x85&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mh">0x97&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">outChannel&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">buf&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">outChannel&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="è°ƒåº¦">è°ƒåº¦&lt;/h2>
&lt;p>ä¸¥è‚ƒåœ°è¯´ï¼Œæˆ‘è®¤ä¸ºè¿™ç§è°ƒåº¦æ¨¡å¼æ˜¯æ˜¾ç„¶ä¸å¯¹çš„ã€‚æ­£ç¡®çš„è°ƒåº¦æ–¹å¼åº”è¯¥æ˜¯è¿™æ ·ã€‚&lt;/p>
&lt;pre>&lt;code class="language-mermaid" data-lang="mermaid">graph TB;
A[cli] --&amp;gt; |å¯åŠ¨|B[read worker];
A --&amp;gt; |å¯åŠ¨| C[write worker];
A --&amp;gt; |å¯åŠ¨| D[decode worker];
A --&amp;gt; |å¯åŠ¨| E[scheduler];
E --&amp;gt; |å‘å‡ºè¯»æŒ‡ä»¤| B;
B --&amp;gt; |å‘é€æ¥æºæ ‡è¯†ç¬¦+å†…å®¹| D;
D --&amp;gt; |å‘é€æ¥æºæ ‡è¯†ç¬¦+å¤„ç†åçš„å†…å®¹| C;
&lt;/code>&lt;/pre>&lt;p>å¯¹äºæœ‰å¤šä¸ª worker çš„æƒ…å†µï¼Œä¹Ÿéœ€è¦è°ƒåº¦å™¨åè°ƒæ‰è¡Œï¼Œä¸è¿‡ç›´è§‰ä¸Šæ¥è¯´ç¡¬ç›˜è¯»å†™æ€§èƒ½ä¼šæ˜¯å…ˆä¸€æ­¥çš„ç“¶é¢ˆã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Args&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">decodeChannel&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">outChannel&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">done&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">p&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Args&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="nf">readFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">decodeChannel&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="nx">path&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Ext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="s">&amp;#34;.dat&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="nf">decodeDat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">decodeChannel&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">outChannel&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="s">&amp;#34;.nt2&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="nf">decodeNt2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">decodeChannel&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">outChannel&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">path&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Ext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Input file should be .dat or .nt2 encrypted script!&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="nf">writeFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">path&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Base&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="s">&amp;#34;.txt&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">outChannel&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">done&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">done&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å®Œæ•´ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;bufio&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;log&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;os&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;path&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Args&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">decodeChannel&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">outChannel&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">done&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">p&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Args&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="nf">readFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">decodeChannel&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="nx">path&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Ext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="s">&amp;#34;.dat&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="nf">decodeDat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">decodeChannel&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">outChannel&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="s">&amp;#34;.nt2&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="nf">decodeNt2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">decodeChannel&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">outChannel&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">path&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Ext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Input file should be .dat or .nt2 encrypted script!&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="nf">writeFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">path&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Base&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="s">&amp;#34;.txt&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">outChannel&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">done&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">done&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">readFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">outChannel&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">OpenFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">O_RDONLY&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mo">0644&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">reader&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">bufio&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewReader&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">file&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">buf&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">new&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="mi">1024000&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">reader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">[:])&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">break&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">outChannel&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">buf&lt;/span>&lt;span class="p">[:&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">outChannel&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">writeFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">outChannel&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">done&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">OpenFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">O_WRONLY&lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">O_TRUNC&lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">O_CREATE&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mo">0644&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">writer&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">bufio&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewWriter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">file&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">buf&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">more&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">outChannel&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">more&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">break&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">writer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">writer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Flush&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">done&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">decodeDat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inChannel&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">outChannel&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">buf&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">more&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">inChannel&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">more&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">break&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">buf&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">^=&lt;/span> &lt;span class="mh">0x84&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">outChannel&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">buf&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">outChannel&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">decodeNt2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">inChannel&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">outChannel&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">buf&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">more&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">inChannel&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">more&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">break&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">buf&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">^&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mh">0x85&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mh">0x97&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">outChannel&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">buf&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">outChannel&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item></channel></rss>