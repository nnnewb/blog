<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>jaeger on weakptr's 笔记</title><link>https://nnnewb.github.io/blog/tags/jaeger/</link><description>Recent content in jaeger on weakptr's 笔记</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Tue, 12 Apr 2022 13:00:00 +0800</lastBuildDate><atom:link href="https://nnnewb.github.io/blog/tags/jaeger/index.xml" rel="self" type="application/rss+xml"/><item><title>记一次 jaeger es 后端出现 maximum shards open 错误排查</title><link>https://nnnewb.github.io/blog/p/jaeger-with-es-backend-exceeded-maximum-shards-open/</link><pubDate>Tue, 12 Apr 2022 13:00:00 +0800</pubDate><guid>https://nnnewb.github.io/blog/p/jaeger-with-es-backend-exceeded-maximum-shards-open/</guid><description>&lt;h2 id="前言">前言&lt;/h2>
&lt;p>jaeger 是一个比较常用的分布式追踪服务，后端可以选 es、cassandra 等存储，我司线上就是用了 es 作为 jaeger 存储。&lt;/p>
&lt;p>jaeger 用 es 做查询后端的时候有个坏毛病：它会自动按日期分割日志 span，一天一个 index。直接结果就是一段时间没管线上的 jaeger，过一段时间就会发现 jaege 里啥也查不出来了。翻 jaeger 的日志就会看到下面的内容：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;level&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;error&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;ts&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mf">1649751249.9240348&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;caller&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;config/config.go:141&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;msg&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Elasticsearch part of bulk request failed&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;map-key&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;index&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;response&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;_index&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;jaeger-span-2022-04-12&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;_type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;_doc&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;status&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">400&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;error&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;illegal_argument_exception&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;reason&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Validation Failed: 1: this action would add [10] total shards, but this cluster currently has [2998]/[3000] maximum shards open;&amp;#34;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="nt">&amp;#34;stacktrace&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;github.com/jaegertracing/jaeger/pkg/es/config.(*Configuration).NewClient.func2\n\tgithub.com/jaegertracing/jaeger/pkg/es/config/config.go:141\ngithub.com/olivere/elastic.(*bulkWorker).commit\n\tgithub.com/olivere/elastic@v6.2.35+incompatible/bulk_processor.go:588\ngithub.com/olivere/elastic.(*bulkWorker).work\n\tgithub.com/olivere/elastic@v6.2.35+incompatible/bulk_processor.go:501&amp;#34;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>此时检查 &lt;code>GET /_cat/shards&lt;/code> 或 &lt;code>GET /_cat/allocation&lt;/code> 都能看到分片数量达到了日志里记录的 &lt;code>2998&lt;/code> 个。&lt;/p>
&lt;h2 id="原因">原因&lt;/h2>
&lt;h3 id="jaeger产生大量分片">jaeger产生大量分片&lt;/h3>
&lt;p>&lt;a class="link" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/size-your-shards.html" target="_blank" rel="noopener"
>elasticsearch 官方文档指出&lt;/a>，每个 index 会被切分成1或多个分片(shards)，每个分片都可能在节点间复制，以防硬件故障。&lt;/p>
&lt;blockquote>
&lt;p>Each index in Elasticsearch is divided into one or more shards, each of which may be replicated across multiple nodes to protect against hardware failures.&lt;/p>
&lt;/blockquote>
&lt;p>而据我观察（sorry，没有文档），jaeger 每天创建的 index 都包含至少 5 个 primary 分片，一个 replica 分片。可以通过请求&lt;code>index/_settings&lt;/code>这个api端点来检查索引会分配的分片和冗余数量。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-http" data-lang="http">&lt;span class="kr">HTTP&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="m">1.1&lt;/span> &lt;span class="m">200&lt;/span> &lt;span class="ne">OK&lt;/span>
&lt;span class="n">content-encoding&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">gzip&lt;/span>
&lt;span class="n">content-length&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">239&lt;/span>
&lt;span class="n">content-type&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">application/json; charset=UTF-8&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;jaeger-span-2022-04-12&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;settings&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;index&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;creation_date&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;1649749148182&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;mapping&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;nested_fields&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;limit&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;50&amp;#34;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="nt">&amp;#34;number_of_replicas&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;number_of_shards&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;5&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;provided_name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;jaeger-span-2022-04-12&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;requests&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;cache&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;enable&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;true&amp;#34;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="nt">&amp;#34;uuid&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;s2i5GZtpTzm3Kp4fIldwrQ&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;version&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;created&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;7090199&amp;#34;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>而检查 &lt;code>GET /_cat/indices&lt;/code> 可以发现，&lt;code>jaeger&lt;/code> 创建的 index 包括 &lt;code>jaeger-service-yyyy-mm-dd&lt;/code> 和 &lt;code>jaeger-span-yyyy-mm-dd&lt;/code> 两种，很容易算出预期每月可能产生 336~372 个新的分片。&lt;/p>
&lt;h3 id="es每个节点分片数量受限">es每个节点分片数量受限&lt;/h3>
&lt;p>关于节点分片数量限制，&lt;a class="link" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/allocation-total-shards.html" target="_blank" rel="noopener"
>官方文档的说法&lt;/a>是这样的：&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>&lt;code>index.routing.allocation.total_shards_per_node&lt;/code>&lt;/strong>&lt;/p>
&lt;p>The maximum number of shards (replicas and primaries) that will be allocated to a single node. Defaults to unbounded.&lt;/p>
&lt;p>&amp;hellip;&lt;/p>
&lt;p>&lt;strong>&lt;code>cluster.routing.allocation.total_shards_per_node&lt;/code>&lt;/strong>&lt;/p>
&lt;p>(&lt;a class="link" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/settings.html#dynamic-cluster-setting" target="_blank" rel="noopener"
>Dynamic&lt;/a>) Maximum number of primary and replica shards allocated to each node. Defaults to &lt;code>-1&lt;/code> (unlimited).&lt;/p>
&lt;p>&amp;hellip;&lt;/p>
&lt;/blockquote>
&lt;p>也就是默认不限制，但显然我们遇到的情况不是这样，要是 shards 数量不限制的话就根本没现在的问题了。&lt;/p>
&lt;p>所以在东翻西找了一轮之后，我发现还有另一个设置项。这个设置项用 &lt;code>shards per node limits&lt;/code> 当关键词搜索的时候没找到，在 &lt;code>GET /_cluster/settings?include_defaults&lt;/code> 里翻出来了：&lt;code>max_shards_per_node&lt;/code>。&lt;/p>
&lt;p>然后我在文档里搜了下，发现官方文档其实已经做了SEO，我要是直接把错误信息贴进谷歌搜的话说不定早发现这个配置项了&amp;hellip;&lt;/p>
&lt;blockquote>
&lt;p>this action would add [x] total shards, but this cluster currently has [y]/[z] maximum shards open;&lt;/p>
&lt;p>The &lt;a class="link" href="https://www.elastic.co/guide/en/elasticsearch/reference/8.1/modules-cluster.html#cluster-max-shards-per-node" target="_blank" rel="noopener"
>&lt;code>cluster.max_shards_per_node&lt;/code>&lt;/a> cluster setting limits the maximum number of open shards for a cluster. This error indicates an action would exceed this limit.&lt;/p>
&lt;/blockquote>
&lt;p>&lt;code>max_shards_per_node&lt;/code>的文档也很怪：&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>&lt;code>cluster.max_shards_per_node&lt;/code>&lt;/strong>&lt;/p>
&lt;p>(&lt;a class="link" href="https://www.elastic.co/guide/en/elasticsearch/reference/8.1/settings.html#dynamic-cluster-setting" target="_blank" rel="noopener"
>Dynamic&lt;/a>) Limits the total number of primary and replica shards for the cluster. Elasticsearch calculates the limit as follows:&lt;/p>
&lt;pre>&lt;code>cluster.max_shards_per_node * number of non-frozen data nodes
&lt;/code>&lt;/pre>&lt;p>Shards for closed indices do not count toward this limit. Defaults to &lt;code>1000&lt;/code>. A cluster with no data nodes is unlimited.&lt;/p>
&lt;/blockquote>
&lt;p>虽然字面上看就是一个节点可以assign的分片数量，但实际算的是 &lt;code>total number of primary and replica shards for cluster&lt;/code>。可以简单算一下，单节点集群显然只有一个 &lt;code>non-frozen data node&lt;/code>，所以集群的分片上限就是 &lt;code>1000 * 1&lt;/code>。线上的 3 节点集群没有 &lt;code>frozen data node&lt;/code>，所以全集群最多有 &lt;code>1000*3&lt;/code> 个分片。&lt;/p>
&lt;p>好了问题来了，&lt;code>max_shards_per_node&lt;/code> 和 &lt;code>total_shards_per_node&lt;/code> 有啥区别？&lt;/p>
&lt;p>&lt;code>total_shards_per_node&lt;/code> 限制的是 &lt;strong>一个节点能分配多少分片&lt;/strong>，&lt;code>max_shards_per_node&lt;/code> 是 &lt;strong>计算全集群能分配多少分片&lt;/strong> 。&lt;/p>
&lt;p>例如一个三节点集群里，&lt;code>total_shards_per_node&lt;/code> 是 &lt;code>100&lt;/code>，但 &lt;code>max_shards_per_node&lt;/code> 是 &lt;code>1000&lt;/code>，可以创建出超过&lt;code>100&lt;/code>个分片，但超出的分片不会被分配（没有实验过，我猜是不会 assign）。&lt;/p>
&lt;p>反过来说 &lt;code>total_shards_per_node&lt;/code> 比 &lt;code>max_shards_per_node&lt;/code> 大的时候，虽然节点还能分配更多分片，但集群分片数已经到上限了，就会出现 &lt;code>this action would add [x] total shards, but this cluster currently has [y]/[z] maximum shards open;&lt;/code> 错误了。&lt;/p>
&lt;h2 id="处理">处理&lt;/h2>
&lt;p>总的来说，既然是集群内的 &lt;code>max_shards_per_node&lt;/code> 配置小了，解决方法就很多：&lt;/p>
&lt;ol>
&lt;li>把 &lt;code>max_shards_per_node&lt;/code> 调大，比如&lt;code>10000&lt;/code>，直接10倍。&lt;/li>
&lt;li>加 es 服务节点。&lt;/li>
&lt;li>删旧的 jaeger 索引。&lt;/li>
&lt;/ol>
&lt;p>改配置显然是有点离谱的想法，等于是看到蟑螂在脚下，你选择铺张地毯，眼不见心不烦。&lt;/p>
&lt;p>加节点只适合不差钱的公司，而且这么选多少是有点看公司人傻钱多的意思。&lt;/p>
&lt;p>删除旧索引就正常很多，算是经典操作。更早些年应该还有个人站长写 crontab 自动删 &lt;code>/var/log&lt;/code> 日志的，删旧索引本质差不多就是这个意思。&lt;/p>
&lt;p>而清理旧索引也有很多做法。&lt;/p>
&lt;h3 id="jaeger-es-rollover">jaeger-es-rollover&lt;/h3>
&lt;h4 id="初始化">初始化&lt;/h4>
&lt;p>&lt;strong>注意，我无法确定是否对未启用&lt;code>--es.use-aliases&lt;/code>时创建的索引有效。&lt;/strong>&lt;/p>
&lt;p>&lt;strong>注意，rollover init 也会创建索引和分片，如果你已经碰到了上面的问题，直接 rollover init 会失败，必须先手动清理。&lt;/strong>&lt;/p>
&lt;p>&lt;strong>如果只想看如何清理旧索引，请跳到 删除 部分，还不行就跳到 curator 小节。&lt;/strong>&lt;/p>
&lt;p>search indices 一节所述，可以使用 jaeger-es-rollover 解决以 es 作为后端存储时的 jaeger 日志轮转问题。我要吐槽下，原文：&lt;/p>
&lt;p>参考 &lt;a class="link" href="https://www.jaegertracing.io/docs/1.32/deployment/#shards-and-replicas-for-elasticsearch-indices" target="_blank" rel="noopener"
>jaeger 部署文档中 shards and replicas for elasticsearch indices 一节所述&lt;/a>，可以使用 &lt;code>jaeger-es-rollover&lt;/code> 解决以 es 作为后端存储时的 jaeger 日志轮转问题。我要吐槽下，原文：&lt;/p>
&lt;blockquote>
&lt;p>Shards and replicas are some configuration values to take special attention to, because this is decided upon index creation. &lt;a class="link" href="https://qbox.io/blog/optimizing-elasticsearch-how-many-shards-per-index" target="_blank" rel="noopener"
>This article&lt;/a> goes into more information about choosing how many shards should be chosen for optimization.&lt;/p>
&lt;/blockquote>
&lt;p>没有任何未配置 es 日志轮转可能产生的问题的警告。我怎么知道&lt;code>take special attention to&lt;/code>是指性能会在特定条件下拉胯，还是直接把 es 服务的 shards 占满，直接搞得 es 没法服务？&lt;code>This article&lt;/code> 这个链接更离谱了，半句没提为什么后面有个 &lt;code>elasticsearch rollover&lt;/code> 小结。&lt;/p>
&lt;p>好闲话少叙。我这里是 kubernetes 平台，docker-compose 用户或者真机部署的自己看着改。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">kubectl create job --image jaegertracing/jaeger-es-rollover:latest jaeger-es-rollover-init -- /go/bin/es-rollover init http://elasticsearch-es-http.elasticsearch.svc.cluster.local:9200 --es.username&lt;span class="o">=&lt;/span>***censored*** --es.password&lt;span class="o">=&lt;/span>***censored***
&lt;/code>&lt;/pre>&lt;/div>&lt;p>换成 docker 命令就是&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">docker run -it --rm --net&lt;span class="o">=&lt;/span>host jaegertracing/jaeger-es-rollover:latest init http://localhost:9200 --es.username&lt;span class="o">=&lt;/span>***censored*** --es.password&lt;span class="o">=&lt;/span>***censored***
&lt;/code>&lt;/pre>&lt;/div>&lt;p>这一步会创建几个新的 index 和别名&lt;/p>
&lt;p>&lt;img src="https://nnnewb.github.io/blog/blog/p/jaeger-with-es-backend-exceeded-maximum-shards-open/image-20220413141559066.png"
width="1842"
height="378"
srcset="https://nnnewb.github.io/blog/blog/p/jaeger-with-es-backend-exceeded-maximum-shards-open/image-20220413141559066_huf31b44a88e85ce036ecd9f25c7699fa0_33804_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/jaeger-with-es-backend-exceeded-maximum-shards-open/image-20220413141559066_huf31b44a88e85ce036ecd9f25c7699fa0_33804_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="rollover init后"
class="gallery-image"
data-flex-grow="487"
data-flex-basis="1169px"
>&lt;/p>
&lt;p>注意图中标记的部分。&lt;/p>
&lt;p>下一步修改 jaeger 的启动参数，我这里直接 &lt;code>kubectl edit -n jaeger deployment jaeger&lt;/code> 编辑。&lt;/p>
&lt;p>&lt;img src="https://nnnewb.github.io/blog/blog/p/jaeger-with-es-backend-exceeded-maximum-shards-open/image-20220413141913088.png"
width="885"
height="169"
srcset="https://nnnewb.github.io/blog/blog/p/jaeger-with-es-backend-exceeded-maximum-shards-open/image-20220413141913088_hu4a18394a943caa248bfd6f08f6042657_22472_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/jaeger-with-es-backend-exceeded-maximum-shards-open/image-20220413141913088_hu4a18394a943caa248bfd6f08f6042657_22472_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="启动参数"
class="gallery-image"
data-flex-grow="523"
data-flex-basis="1256px"
>&lt;/p>
&lt;p>应用后自动更新 pod，注意看下日志有没有错误或者警告。对于 docker-compose 用户改法差不多，如果 jaeger 是直接 &lt;code>docker run&lt;/code> 起来的，那是真的牛啤。自己 &lt;code>docker rm&lt;/code> 再 &lt;code>docker run&lt;/code> 一次吧。真机部署 jaeger 还没见过直接略，无非是改 systemd 配置或者 /etc/init.d 。&lt;/p>
&lt;p>到这里 jaeger 部署的调整就完了，但问题还没解决：要是时间久了，会不会还创建一堆 indices？据我观察，应该不会再每天 2 个 index 的频率高强度创建 index 了（PS：因为第一天动手的时候没注意，jaeger 没加 &lt;code>--es.use-aliases=true&lt;/code>，所以我也不敢说绝对不会，建议自己改了第二天看一眼。），新的 index 会写入到之前看到的 &lt;code>jaeger-span-000001&lt;/code> 这种 index 里。&lt;/p>
&lt;p>文档里给了个从每日创建索引转到 rollover 的迁移方法：&lt;/p>
&lt;p>&lt;strong>这不会删除旧索引，只是把旧索引合并到了别名&lt;code>jaeger-*-read&lt;/code>里，让 jaeger 能查询到旧的日志。&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">curl -ivX POST -H &lt;span class="s2">&amp;#34;Content-Type: application/json&amp;#34;&lt;/span> localhost:9200/_aliases -d &lt;span class="s1">&amp;#39;{&amp;#34;actions&amp;#34; : [{ &amp;#34;add&amp;#34; : { &amp;#34;index&amp;#34; : &amp;#34;jaeger-span-*-*-*&amp;#34;, &amp;#34;alias&amp;#34; : &amp;#34;jaeger-span-read&amp;#34; } }, { &amp;#34;add&amp;#34; : { &amp;#34;index&amp;#34;:&amp;#34;jaeger-service-*-*-*&amp;#34;, &amp;#34;alias&amp;#34; : &amp;#34;jaeger-service-read&amp;#34; }}]}&amp;#39;&lt;/span>
&lt;span class="c1"># archive indices&lt;/span>
curl -ivX POST -H &lt;span class="s2">&amp;#34;Content-Type: application/json&amp;#34;&lt;/span> localhost:9200/_aliases -d &lt;span class="s1">&amp;#39;{&amp;#34;actions&amp;#34; : [{ &amp;#34;add&amp;#34; : { &amp;#34;index&amp;#34; : &amp;#34;jaeger-span-archive&amp;#34;, &amp;#34;alias&amp;#34; : &amp;#34;jaeger-span-archive-read&amp;#34; } }]}&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>注意如果有归档的话用 第二条 curl 的同时还要给 &lt;code>jaeger&lt;/code> 加上启动参数&lt;code>--es.archive.use-aliases=true&lt;/code>。&lt;/p>
&lt;h4 id="轮转">轮转&lt;/h4>
&lt;p>到这里，问题解决了90%，但还有个问题：如果所有 jaeger 数据都放在一个 index 里，过上一段时间，数据量膨胀后会不会产生性能问题？这是很自然的想法，日志这种东西是很容易膨胀的，随时间流逝很可能堆成一座难以清理的大山：就像是你想在MySQL里往一个记录超亿级的表里插数据或删数据一样。&lt;/p>
&lt;p>&lt;code>jaeger-es-rollover&lt;/code> 真正的用途就是这个：轮转日志。一个 index 已经有 100M 了，那就换一个 index 吧。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="c1"># 按 CONDITIONS 指定的规则轮转&lt;/span>
docker run -it --rm --net&lt;span class="o">=&lt;/span>host -e &lt;span class="nv">CONDITIONS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;{&amp;#34;max_age&amp;#34;: &amp;#34;1s&amp;#34;}&amp;#39;&lt;/span> jaegertracing/jaeger-es-rollover:latest rollover http://localhost:9200
&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;p>Rollover lets you configure when to roll over to a new index based on one or more of the following criteria:&lt;/p>
&lt;ul>
&lt;li>&lt;code>max_age&lt;/code> - the maximum age of the index. It uses &lt;a class="link" href="https://www.elastic.co/guide/en/elasticsearch/reference/master/common-options.html#time-units" target="_blank" rel="noopener"
>time units&lt;/a>: &lt;code>d&lt;/code>, &lt;code>h&lt;/code>, &lt;code>m&lt;/code>.&lt;/li>
&lt;li>&lt;code>max_docs&lt;/code> - the maximum documents in the index.&lt;/li>
&lt;li>&lt;code>max_size&lt;/code> - the maximum estimated size of primary shards (since Elasticsearch 6.x). It uses &lt;a class="link" href="https://www.elastic.co/guide/en/elasticsearch/reference/master/common-options.html#byte-units" target="_blank" rel="noopener"
>byte size units&lt;/a> &lt;code>tb&lt;/code>, &lt;code>gb&lt;/code>, &lt;code>mb&lt;/code>.&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>目前支持的条件就只有这些。rollover 并不能让 es &lt;em>替你&lt;/em> 轮转索引，所以这个 rollover 命令只能自己定时执行。&lt;/p>
&lt;p>对于 docker-compose 用户或者 docker 用户我没啥好办法，也许你可以在宿主机里写一个 crontab 跑上面的&lt;code>docker run&lt;/code>。&lt;/p>
&lt;p>对于我这样的 kubernetes 用户则可以选择用 kubernetes 的 cronjob 实现。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">batch/v1beta1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 对于 kubernetes v1.21.x 已经不是 beta 了，改成 batch/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">CronJob&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">jaeger-es-index-rollover&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">jaeger&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">schedule&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;0 0 * * 0&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">jobTemplate&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># see document https://www.jaegertracing.io/docs/1.32/deployment/#remove-old-data&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">jaegertracing/jaeger-es-rollover:latest&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">jaeger-es-rollover&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">env&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">CONDITIONS&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;{&amp;#34;max_age&amp;#34;:&amp;#34;2d&amp;#34;}&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">args&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">rollover&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- --&lt;span class="l">es.username=***censored***&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- --&lt;span class="l">es.password=***censored***&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;http://elasticsearch-es-http.elasticsearch.svc.cluster.local:9200&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">requests&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">cpu&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">100m&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">memory&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">100Mi&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">limits&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">cpu&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">100m&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">memory&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">100Mi&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">restartPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Never&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>好，问题解决99%了！&lt;/p>
&lt;h4 id="删除">删除&lt;/h4>
&lt;p>最后就是删除不再需要的数据了，很简单啦。下面的命令中 &lt;code>14&lt;/code> 表示保留最近14天的日志，同样支持 &lt;code>--es.username&lt;/code>和&lt;code>--es.password&lt;/code>参数。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">docker run -it --rm --net&lt;span class="o">=&lt;/span>host -e &lt;span class="nv">ROLLOVER&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nb">true&lt;/span> jaegertracing/jaeger-es-index-cleaner:latest &lt;span class="m">14&lt;/span> http://localhost:9200
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>注意，虽然文档说 &lt;em>that is also used for daily indices&lt;/em>，但实际发现好像并不会删。&lt;/strong>&lt;/p>
&lt;p>我不确定是不是 &lt;strong>ROLLOVER&lt;/strong> 这个环境变量的影响，建议自己试试。&lt;/p>
&lt;h3 id="elasticsearch-curator">elasticsearch-curator&lt;/h3>
&lt;p>好了，奇技淫巧环节。&lt;a class="link" href="https://github.com/elastic/curator" target="_blank" rel="noopener"
>curator&lt;/a> 是一个 elastic 公司开源的 python 包，介绍比较皮：&lt;/p>
&lt;blockquote>
&lt;p>Have indices in Elasticsearch? This is the tool for you!&lt;/p>
&lt;p>Like a museum curator manages the exhibits and collections on display, Elasticsearch Curator helps you curate, or manage your indices.&lt;/p>
&lt;/blockquote>
&lt;p>对不起，没去过博物馆，也没做过馆长，Get 不到。&lt;/p>
&lt;p>简单地说，curator 是一个 indice 管理的工具，我们用这个工具实现找到旧索引并删除。&lt;/p>
&lt;p>curator 的命令行界面像这样：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">Usage: curator [OPTIONS] ACTION_FILE
Curator for Elasticsearch indices.
See http://elastic.co/guide/en/elasticsearch/client/curator/current
Options:
--config PATH Path to configuration file. Default: ~/.curator/curator.yml
--dry-run Do not perform any changes.
--version Show the version and exit.
--help Show this message and exit.
&lt;/code>&lt;/pre>&lt;/div>&lt;p>关于这个工具，我们主要关注官方文档里的两个部分：&lt;a class="link" href="https://www.elastic.co/guide/en/elasticsearch/client/curator/current/configfile.html" target="_blank" rel="noopener"
>configuration file&lt;/a> 和 &lt;a class="link" href="https://www.elastic.co/guide/en/elasticsearch/client/curator/current/actionfile.html" target="_blank" rel="noopener"
>action file&lt;/a>。&lt;/p>
&lt;p>configuration file 保存的是关于连接 es 所需的配置如地址、用户名密码、验证方法等，以及工具本身的配置如日志。&lt;/p>
&lt;p>action file 保存的是我们希望 curator 帮我们完成的操作。&lt;/p>
&lt;p>action file 的格式如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">actions&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">action&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ACTION1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">OPTIONAL DESCRIPTION&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">options&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">option1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">value1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">...&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">filters&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">filtertype&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="cp">*first*&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">filter_element1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">value1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">...&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">2&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">...&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>其中 &lt;code>action&lt;/code> 是我们希望 curator 做的事，&lt;code>options&lt;/code> 和 &lt;code>filters&lt;/code> 控制 &lt;code>action&lt;/code> 的行为和行为的对象。&lt;code>action&lt;/code>支持&lt;a class="link" href="https://www.elastic.co/guide/en/elasticsearch/client/curator/current/actions.html" target="_blank" rel="noopener"
>很多不同的操作&lt;/a>。&lt;/p>
&lt;p>好了，现在看实例。我们想删除名称符合 &lt;code>jaeger-span-yyyy-mm-dd&lt;/code> 格式的 index，并且&lt;code>yyyy-mm-dd&lt;/code>小于指定的日期。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="w"> &lt;/span>&lt;span class="nt">actions&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">action&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">delete_indices&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">&amp;gt;-&lt;/span>&lt;span class="sd">
&lt;/span>&lt;span class="sd"> &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">delete old jaeger-span indices&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">options&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">ignore_empty_list&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">timeout_override&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">continue_if_exception&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">disable_action&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">False&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">filters&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">filtertype&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pattern&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">prefix&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">jaeger-span&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">exclude&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">filtertype&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">age&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">source&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">name&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">direction&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">older&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">timestring&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;%Y-%m-%d&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">unit&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">days&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">unit_count&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">7&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">exclude&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>动作：&lt;code>delete_indices&lt;/code>；忽略空输入，即使异常也继续执行；要删除的对象以 &lt;code>jaeger-span&lt;/code> 开头，并且名称包含 &lt;code>%Y-%m-%d&lt;/code> 模式的日期，且早于 7 天前。&lt;/p>
&lt;p>done！把上面的配置复制一份套用到 &lt;code>jaeger-service-yyyy-mm-dd&lt;/code> 上，删除 jaeger-span 的任务就算配置好了。&lt;/p>
&lt;p>接下来把删除工作配置成定时任务，这里还是用了 cronjob。&lt;/p>
&lt;p>先把配置保存成 ConfigMap。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># https://kubernetes.io/docs/concepts/configuration/configmap/&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ConfigMap&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">curator-config&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">jaeger&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">data&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">curator.yml&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="sd">
&lt;/span>&lt;span class="sd"> client:
&lt;/span>&lt;span class="sd"> hosts:
&lt;/span>&lt;span class="sd"> - ****
&lt;/span>&lt;span class="sd"> - ****
&lt;/span>&lt;span class="sd"> - ****
&lt;/span>&lt;span class="sd"> port: 9200
&lt;/span>&lt;span class="sd"> username: ***censored***
&lt;/span>&lt;span class="sd"> password: ***censored***
&lt;/span>&lt;span class="sd"> logging:
&lt;/span>&lt;span class="sd"> loglevel: INFO
&lt;/span>&lt;span class="sd"> logformat: default&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">action.yml&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="sd">
&lt;/span>&lt;span class="sd"> actions:
&lt;/span>&lt;span class="sd"> 1:
&lt;/span>&lt;span class="sd"> action: delete_indices
&lt;/span>&lt;span class="sd"> description: &amp;gt;-
&lt;/span>&lt;span class="sd"> delete old jaeger-span indices
&lt;/span>&lt;span class="sd"> options:
&lt;/span>&lt;span class="sd"> ignore_empty_list: True
&lt;/span>&lt;span class="sd"> timeout_override:
&lt;/span>&lt;span class="sd"> continue_if_exception: True
&lt;/span>&lt;span class="sd"> disable_action: False
&lt;/span>&lt;span class="sd"> filters:
&lt;/span>&lt;span class="sd"> - filtertype: pattern
&lt;/span>&lt;span class="sd"> kind: prefix
&lt;/span>&lt;span class="sd"> value: jaeger-span
&lt;/span>&lt;span class="sd"> exclude:
&lt;/span>&lt;span class="sd"> - filtertype: age
&lt;/span>&lt;span class="sd"> source: name
&lt;/span>&lt;span class="sd"> direction: older
&lt;/span>&lt;span class="sd"> timestring: &amp;#39;%Y-%m-%d&amp;#39;
&lt;/span>&lt;span class="sd"> unit: days
&lt;/span>&lt;span class="sd"> unit_count: 7
&lt;/span>&lt;span class="sd"> exclude:
&lt;/span>&lt;span class="sd"> 2:
&lt;/span>&lt;span class="sd"> action: delete_indices
&lt;/span>&lt;span class="sd"> description: &amp;gt;-
&lt;/span>&lt;span class="sd"> delete old jaeger-service indices
&lt;/span>&lt;span class="sd"> options:
&lt;/span>&lt;span class="sd"> ignore_empty_list: True
&lt;/span>&lt;span class="sd"> timeout_override:
&lt;/span>&lt;span class="sd"> continue_if_exception: True
&lt;/span>&lt;span class="sd"> disable_action: False
&lt;/span>&lt;span class="sd"> filters:
&lt;/span>&lt;span class="sd"> - filtertype: pattern
&lt;/span>&lt;span class="sd"> kind: prefix
&lt;/span>&lt;span class="sd"> value: jaeger-service
&lt;/span>&lt;span class="sd"> exclude:
&lt;/span>&lt;span class="sd"> - filtertype: age
&lt;/span>&lt;span class="sd"> source: name
&lt;/span>&lt;span class="sd"> direction: older
&lt;/span>&lt;span class="sd"> timestring: &amp;#39;%Y-%m-%d&amp;#39;
&lt;/span>&lt;span class="sd"> unit: days
&lt;/span>&lt;span class="sd"> unit_count: 7
&lt;/span>&lt;span class="sd"> exclude:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>再编写一个 CronJob&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">batch/v1beta1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">CronJob&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">jaeger-es-index-cleanup&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">jaeger&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">schedule&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;0 0 * * 0&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">jobTemplate&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">curator-config&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">configMap&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">curator-config&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">bitnami/elasticsearch-curator:5.8.4&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">elasticsearch-curator&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">sh&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- -&lt;span class="l">c&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">curator --config /cfg/curator.yml /cfg/action.yml&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeMounts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">mountPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/cfg&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">curator-config&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">requests&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">cpu&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">100m&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">memory&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">100Mi&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">limits&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">cpu&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">100m&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">memory&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">100Mi&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">restartPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Never&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>这里用了 &lt;code>bitnami/elasticsearch-curator&lt;/code> 镜像，如果不信任的话可以自己写个 Dockerfile 也不会很麻烦。我主要看中 bitnami 镜像大小优化还不错（98M），要是我自己随便写一个的话可能就不止这么大了。看了眼镜像的 Dockerfile 没有什么可疑的地方就直接用啦。&lt;/p>
&lt;p>对于需要立刻跑一次的情况，可以把 jobTemplate 下面的内容复制出来单独写个 Job 先跑起来。&lt;/p>
&lt;h3 id="手动">手动&lt;/h3>
&lt;p>手动法我说个思路。首先你得有个 kibana console 可以访问，或者能直接请求到 es 的 9200 端口。&lt;/p>
&lt;p>&lt;code>GET /_cat/indices&lt;/code> 拿到 indices 列表，按名字正则过滤 &lt;code>jaeger-(span|service)-\d{4}-\d{2}-\d{2}&lt;/code>，然后把后面的日期解析一下；或者粗暴点，直接&lt;code>^(2022-04-\d{2})&lt;/code>过滤出本月（4月）以外的所有索引，拿到一个索引列表。&lt;/p>
&lt;p>具体点说，像是 kibana console 拿到的是一个每行格式如 &lt;code>green open jaeger-span-2022-03-01 ....&lt;/code> 这样的纯文本，你可以放到 vscode 里然后用 &lt;code>Filter Lines&lt;/code> 这样的插件快速正则过滤出来，再按 &lt;code>alt+shift+方向键&lt;/code> 多光标，快速编辑出一个索引名称列表。&lt;/p>
&lt;p>&lt;img src="https://nnnewb.github.io/blog/blog/p/jaeger-with-es-backend-exceeded-maximum-shards-open/image-20220413154700392.png"
width="1338"
height="315"
srcset="https://nnnewb.github.io/blog/blog/p/jaeger-with-es-backend-exceeded-maximum-shards-open/image-20220413154700392_huedcedc0cd6515fa937cef755447c928f_26312_480x0_resize_box_3.png 480w, https://nnnewb.github.io/blog/blog/p/jaeger-with-es-backend-exceeded-maximum-shards-open/image-20220413154700392_huedcedc0cd6515fa937cef755447c928f_26312_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="kibana"
class="gallery-image"
data-flex-grow="424"
data-flex-basis="1019px"
>&lt;/p>
&lt;p>然后把索引名前面加上 &lt;code>DELETE /&lt;/code>，产生 &lt;code>DELETE /jaeger-span-2022-03-01&lt;/code> 这样的列表，贴到 kibana console 里，全选运行，done。&lt;/p>
&lt;p>要是没 kibana ，只有 9200 访问，就改成 curl 请求，或者 httpie ，反正总有办法。最后批量执行就好。&lt;/p>
&lt;p>要是都没有，讲道理啊你跟负责人说下要个访问权限好吧&amp;hellip;&amp;hellip;&lt;/p>
&lt;p>要是对自己的脚本编程能力有自信的话，大可直接写个 bash 脚本定时跑，也是 ok 的。&lt;/p>
&lt;h2 id="总结">总结&lt;/h2>
&lt;p>总之，&lt;code>jaeger-es-rollover&lt;/code> 配 &lt;code>jaeger-es-index-cleaner&lt;/code>；或者&lt;code>elasticsearch-curator&lt;/code>都行。手动法无非是手工拿到 indices 然后用各种编辑器批量编辑技巧或者正则替换，拼出个脚本。正则表达式当真是每个开发者的必备良药。&lt;/p>
&lt;p>讲道理地说要不是 jaeger 给我整这一出我可能还想不到拿 es 当 jaeger 后端还会有这种坑。但这也算给我提了个醒，挂在 es 上的数据虽然不多而且都是从 MySQL 同步过去的，es 的一些基本配置如分片啥的还是得关注一下，不能只顾着接 api。这就是所谓的 &lt;em>运维压力&lt;/em> 了吧。&lt;/p>
&lt;p>应该还有不少小公司的开发其实是缺乏能力运维诸如 es 这样的项目的，对 MySQL 也是仅限于精通 &lt;strong>安装和使用&lt;/strong> ，但问起怎么怎么高可用，怎么做主备，怎么做读写分离，怎么分库分表，其实一个也不会（对，我也差不多）。&lt;/p>
&lt;p>k8s 也是个很大的坑，现在甚至有点感觉后端一路走下来真正坑人的都是这些大框架，大概念，比如前段时间流行过的&lt;strong>中台&lt;/strong>，风口上的&lt;strong>云计算&lt;/strong>、&lt;strong>云原生&lt;/strong>，好像沾个&lt;strong>云&lt;/strong>就牛逼起来了。我不是说 k8s 没用嗷，我是说媒体吹的时候个个都是银弹，老板吹的时候各个都是&lt;strong>给我也整一个！&lt;/strong>&lt;/p>
&lt;p>还好压力最后都转化成了见鬼的需求和莫名其妙的技术选型，最底层的开发只要放弃思考就完事了，写什么代码不是写，大家都是给资本服务嘛。&lt;/p></description></item></channel></rss>