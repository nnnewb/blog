<!doctype html><html lang=zh-cn dir=ltr>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="å‰è¨€ æœ¬ç¯‡å°è¯•å­¦ä¹ é€šè¿‡åŠ¨æ‰‹å†™ä¸€ä¸ª LLVM Pass æ¥å­¦ä¹ ç¼–è¯‘é˜¶æ®µè¿›è¡Œä»£ç æ··æ·†çš„æŠ€æœ¯ã€‚ 0x01 ç¯å¢ƒè®¾ç½® LLVM æ˜¯ä¸ªç›¸å½“å¤§çš„é¡¹ç›®ï¼Œåšå¥½ç¯å¢ƒè®¾ç½®æ˜¯é¦–å…ˆè¦åšçš„äº‹æƒ…ã€‚è¿™é‡Œé€‰æ‹© msys2 ä½œ"><title>åŠ å£³åŸç†08ï¼šæ··æ·†æŠ€æœ¯å…¥é—¨</title>
<link rel=canonical href=https://nnnewb.github.io/p/learning-packer-08/>
<link rel=stylesheet href=/scss/style.min.709d4f89582c5a09dc94158a722a16093cdffe24d9a8c77dd3f422c786203c41.css><script src=https://unpkg.com/dayjs@1.8.21/dayjs.min.js></script>
<script src=https://unpkg.com/dayjs@1.8.21/plugin/relativeTime.js></script>
<script src=https://unpkg.com/dayjs@1.8.21/locale/zh-cn.js></script>
<script>dayjs.locale('zh-cn'),dayjs.extend(dayjs_plugin_relativeTime)</script><meta property="og:title" content="åŠ å£³åŸç†08ï¼šæ··æ·†æŠ€æœ¯å…¥é—¨">
<meta property="og:description" content="å‰è¨€ æœ¬ç¯‡å°è¯•å­¦ä¹ é€šè¿‡åŠ¨æ‰‹å†™ä¸€ä¸ª LLVM Pass æ¥å­¦ä¹ ç¼–è¯‘é˜¶æ®µè¿›è¡Œä»£ç æ··æ·†çš„æŠ€æœ¯ã€‚ 0x01 ç¯å¢ƒè®¾ç½® LLVM æ˜¯ä¸ªç›¸å½“å¤§çš„é¡¹ç›®ï¼Œåšå¥½ç¯å¢ƒè®¾ç½®æ˜¯é¦–å…ˆè¦åšçš„äº‹æƒ…ã€‚è¿™é‡Œé€‰æ‹© msys2 ä½œ">
<meta property="og:url" content="https://nnnewb.github.io/p/learning-packer-08/">
<meta property="og:site_name" content="weakptr's ç¬”è®°">
<meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="é€†å‘"><meta property="article:tag" content="windows"><meta property="article:tag" content="c++"><meta property="article:tag" content="llvm"><meta property="article:tag" content="æ±‡ç¼–"><meta property="article:tag" content="security"><meta property="article:tag" content="binary-analysis"><meta property="article:published_time" content="2021-11-03T16:54:00+08:00"><meta property="article:modified_time" content="2021-11-03T16:54:00+08:00"><meta property="og:image" content="https://nnnewb.github.io/p/learning-packer-08/cover.jpg">
<meta name=twitter:title content="åŠ å£³åŸç†08ï¼šæ··æ·†æŠ€æœ¯å…¥é—¨">
<meta name=twitter:description content="å‰è¨€ æœ¬ç¯‡å°è¯•å­¦ä¹ é€šè¿‡åŠ¨æ‰‹å†™ä¸€ä¸ª LLVM Pass æ¥å­¦ä¹ ç¼–è¯‘é˜¶æ®µè¿›è¡Œä»£ç æ··æ·†çš„æŠ€æœ¯ã€‚ 0x01 ç¯å¢ƒè®¾ç½® LLVM æ˜¯ä¸ªç›¸å½“å¤§çš„é¡¹ç›®ï¼Œåšå¥½ç¯å¢ƒè®¾ç½®æ˜¯é¦–å…ˆè¦åšçš„äº‹æƒ…ã€‚è¿™é‡Œé€‰æ‹© msys2 ä½œ"><meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://nnnewb.github.io/p/learning-packer-08/cover.jpg">
</head>
<body class=article-page>
<script>(function(){const a='StackColorScheme';localStorage.setItem(a,"light")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky">
<button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box>
<span class=hamburger-inner></span>
</span>
</button>
<header>
<figure class=site-avatar>
<a href=/>
<img src=/img/avatar_hub37949326d1692892aa1e64434c0dda6_382115_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a>
<span class=emoji>ğŸ‘</span>
</figure>
<div class=site-meta>
<h1 class=site-name><a href=/>weakptr's ç¬”è®°</a></h1>
<h2 class=site-description>å¼ƒèˆ¹ï¼</h2>
</div>
</header><ol class=social-menu>
<li>
<a href=https://github.com/nnnewb/ target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg>
</a>
</li>
</ol><ol class=menu id=main-menu>
<li>
<a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>é¦–é¡µ</span>
</a>
</li>
<li>
<a href=/about><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>å…³äºæˆ‘</span>
</a>
</li>
<li>
<a href=/archive><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>å½’æ¡£</span>
</a>
</li>
<li>
<a href=/categories><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
<span>åˆ†ç±»</span>
</a>
</li>
<li>
<a href=/tags><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11 3l9 9a1.5 1.5.0 010 2l-6 6a1.5 1.5.0 01-2 0L3 11V7a4 4 0 014-4h4"/><circle cx="9" cy="9" r="2"/></svg>
<span>æ ‡ç­¾</span>
</a>
</li>
<li>
<a href=/link><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>å‹é“¾</span>
</a>
</li>
<li>
<a href=/search><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>æœç´¢</span>
</a>
</li>
<div class=menu-bottom-section>
</div>
</ol>
</aside>
<main class="main full-width">
<article class="has-image main-article">
<header class=article-header>
<div class=article-image>
<a href=/p/learning-packer-08/>
<img src=/p/learning-packer-08/cover_hu8b7651a2bda3b235d3ed49f67a1e20bd_99156_800x0_resize_q75_box.jpg srcset="/p/learning-packer-08/cover_hu8b7651a2bda3b235d3ed49f67a1e20bd_99156_800x0_resize_q75_box.jpg 800w, /p/learning-packer-08/cover_hu8b7651a2bda3b235d3ed49f67a1e20bd_99156_1600x0_resize_q75_box.jpg 1600w" width=800 height=390 loading=lazy alt="Featured image of post åŠ å£³åŸç†08ï¼šæ··æ·†æŠ€æœ¯å…¥é—¨">
</a>
</div>
<div class=article-details>
<header class=article-category>
<a href=/categories/%E9%80%86%E5%90%91/>
é€†å‘
</a>
</header>
<div class=article-title-wrapper>
<h2 class=article-title>
<a href=/p/learning-packer-08/>åŠ å£³åŸç†08ï¼šæ··æ·†æŠ€æœ¯å…¥é—¨</a>
</h2>
</div>
<footer class=article-time>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2021-11-03T16:54:00+08:00>2021å¹´ 11æœˆ 3æ—¥</time>
</div>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>
é˜…è¯»æ—¶é•¿: 14 åˆ†é’Ÿ
</time>
</div>
</footer>
</div>
</header>
<section class=article-content>
<h2 id=å‰è¨€>å‰è¨€</h2>
<p>æœ¬ç¯‡å°è¯•å­¦ä¹ é€šè¿‡åŠ¨æ‰‹å†™ä¸€ä¸ª LLVM Pass æ¥å­¦ä¹ ç¼–è¯‘é˜¶æ®µè¿›è¡Œä»£ç æ··æ·†çš„æŠ€æœ¯ã€‚</p>
<h2 id=0x01-ç¯å¢ƒè®¾ç½®>0x01 ç¯å¢ƒè®¾ç½®</h2>
<p>LLVM æ˜¯ä¸ªç›¸å½“å¤§çš„é¡¹ç›®ï¼Œåšå¥½ç¯å¢ƒè®¾ç½®æ˜¯é¦–å…ˆè¦åšçš„äº‹æƒ…ã€‚è¿™é‡Œé€‰æ‹© msys2 ä½œä¸ºé¦–è¦å¼€å‘ç¯å¢ƒï¼Œä¸ç„¶å…‰æ˜¯ MSVC æŠŠ LLVM æºç ç¼–è¯‘ä¸€éå°±å¤Ÿå‘›äº†ã€‚</p>
<p>å®‰è£…å¥½MSYS2ä¹‹åå®‰è£… clang å·¥å…·é“¾ï¼ˆ2021å¹´11æœˆ3æ—¥ï¼Œclang32å·¥å…·é“¾é»˜è®¤ä¸åœ¨msys2çš„æºé‡Œï¼Œéœ€è¦æ‰‹åŠ¨æ”¹ <code>pacman.conf</code> åŠ å…¥ <code>clang32</code> æºï¼Œè¿™é‡Œä»¥ x86_64 çš„ LLVM å·¥å…·é“¾è¿›è¡Œå®è·µï¼‰ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>pacman -Sy mingw-w64-clang-x86_64-toolchain
</code></pre></td></tr></table>
</div>
</div><p>å®Œæˆåæ·»åŠ ç¯å¢ƒå˜é‡ï¼ŒæŠŠ msys2 å®‰è£…ç›®å½•ä¸‹çš„ <code>clang64/bin</code> åŠ å…¥ç¯å¢ƒå˜é‡ï¼Œæ–¹ä¾¿ VSCode + CMake æ‰¾åˆ°å·¥å…·é“¾ã€‚å¦å¤–æ³¨æ„è£…ä¸€ä¸ª Ninjaï¼ŒåŒæ ·åŠ å…¥ Pathã€‚</p>
<p>VSCode é‡Œè£…ä¸Šå¾®è½¯çš„ C/C++ å’Œ clangdï¼Œç¦ç”¨å¾®è½¯ C/C++ çš„ Intellisenseï¼Œå®åœ¨å¤ªæ…¢ã€‚</p>
<p>æ‰‹åŠ¨ç¼–è¯‘æ•´ä¸ªLLVMæºç æ ‘å®åœ¨æ˜¯å¤ªè´¹æ—¶é—´äº†ï¼Œæˆ‘é€‰æ‹©ç”¨MSYS2çš„å·¥å…·é“¾ã€‚å‚è€ƒè¿™ç¯‡æ–‡æ¡£å»é…ç½®ä¸€ä¸ª LLVM æºç æ ‘å¤–çš„ Pass å·¥ç¨‹ï¼š<a class=link href=https://llvm.org/docs/CMake.html#cmake-out-of-source-pass target=_blank rel=noopener>CMake out of source pass - LLVM</a> ã€‚å†™ä¸€ä¸ªç®€å•çš„ CMakeLists.txt ï¼Œè·Ÿç€ <a class=link href=https://llvm.org/docs/WritingAnLLVMPass.html target=_blank rel=noopener>Writing an LLVM Pass - LLVM</a> è¿™ç¯‡æ–‡æ¡£å¿«é€Ÿå®ç°ä¸€ä¸ªéå†å‡½æ•°çš„ Pass ã€‚</p>
<p>ä¸‹é¢æ˜¯ <code>CMakeLists.txt</code> çš„å†…å®¹</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-cmake data-lang=cmake><span class=nb>cmake_minimum_required</span><span class=p>(</span><span class=s>VERSION</span> <span class=s>3.13.4</span><span class=p>)</span><span class=err>
</span><span class=err></span><span class=nb>project</span><span class=p>(</span><span class=s>Hello</span><span class=p>)</span><span class=err>
</span><span class=err></span><span class=nb>find_package</span><span class=p>(</span><span class=s>LLVM</span> <span class=s>REQUIRED</span> <span class=s>CONFIG</span><span class=p>)</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=nb>message</span><span class=p>(</span><span class=s>STATUS</span> <span class=s2>&#34;Found LLVM ${LLVM_PACKAGE_VERSION}&#34;</span><span class=p>)</span><span class=err>
</span><span class=err></span><span class=nb>message</span><span class=p>(</span><span class=s>STATUS</span> <span class=s2>&#34;Using LLVMConfig.cmake in: ${LLVM_DIR}&#34;</span><span class=p>)</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=nb>include_directories</span><span class=p>(</span><span class=o>${</span><span class=nv>LLVM_INCLUDE_DIRS</span><span class=o>}</span><span class=p>)</span><span class=err>
</span><span class=err></span><span class=nb>separate_arguments</span><span class=p>(</span><span class=s>LLVM_DEFINITIONS_LIST</span> <span class=s>NATIVE_COMMAND</span> <span class=o>${</span><span class=nv>LLVM_DEFINITIONS</span><span class=o>}</span><span class=p>)</span><span class=err>
</span><span class=err></span><span class=nb>add_definitions</span><span class=p>(</span><span class=o>${</span><span class=nv>LLVM_DEFINITIONS_LIST</span><span class=o>}</span><span class=p>)</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=nb>list</span><span class=p>(</span><span class=s>APPEND</span> <span class=s>CMAKE_MODULE_PATH</span> <span class=s2>&#34;${LLVM_CMAKE_DIR}&#34;</span><span class=p>)</span><span class=err>
</span><span class=err></span><span class=nb>include</span><span class=p>(</span><span class=s>AddLLVM</span><span class=p>)</span><span class=err>
</span><span class=err></span><span class=nb>add_llvm_library</span><span class=p>(</span><span class=s>Hello</span> <span class=s>MODULE</span> <span class=s>hello.cpp</span> <span class=s>PLUGIN_TOOL</span> <span class=s>opt</span><span class=p>)</span><span class=err>
</span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åæ˜¯å®ç° pass çš„æºç ï¼Œæºç çš„è¯¦ç»†è§£é‡Šç›´æ¥è¯» LLVM ç»™çš„æ–‡æ¡£ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=cp>#include</span> <span class=cpf>&#34;llvm/IR/Function.h&#34;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&#34;llvm/IR/LegacyPassManager.h&#34;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&#34;llvm/Pass.h&#34;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&#34;llvm/Support/raw_ostream.h&#34;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&#34;llvm/Transforms/IPO/PassManagerBuilder.h&#34;</span><span class=cp>
</span><span class=cp></span>
<span class=k>using</span> <span class=k>namespace</span> <span class=n>llvm</span><span class=p>;</span>

<span class=k>namespace</span> <span class=p>{</span>
  <span class=k>struct</span> <span class=nc>Hello</span> <span class=o>:</span> <span class=k>public</span> <span class=n>FunctionPass</span> <span class=p>{</span>
    <span class=k>static</span> <span class=kt>char</span> <span class=n>ID</span><span class=p>;</span>
    <span class=n>Hello</span><span class=p>()</span> <span class=o>:</span> <span class=n>FunctionPass</span><span class=p>(</span><span class=n>ID</span><span class=p>)</span> <span class=p>{}</span>
    <span class=kt>bool</span> <span class=nf>runOnFunction</span><span class=p>(</span><span class=n>Function</span> <span class=o>&amp;</span><span class=n>F</span><span class=p>)</span> <span class=k>override</span> <span class=p>{</span>
      <span class=n>errs</span><span class=p>()</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Hello:&#34;</span><span class=p>;</span>
      <span class=n>errs</span><span class=p>().</span><span class=n>write_escaped</span><span class=p>(</span><span class=n>F</span><span class=p>.</span><span class=n>getName</span><span class=p>())</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>;</span>
      <span class=k>return</span> <span class=nb>false</span><span class=p>;</span>
    <span class=p>}</span>
  <span class=p>};</span>
<span class=p>}</span> <span class=c1>// namespace
</span><span class=c1></span>
<span class=kt>char</span> <span class=n>Hello</span><span class=o>::</span><span class=n>ID</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>

<span class=k>static</span> <span class=n>RegisterPass</span><span class=o>&lt;</span><span class=n>Hello</span><span class=o>&gt;</span> <span class=n>X</span><span class=p>(</span><span class=s>&#34;hello&#34;</span><span class=p>,</span> <span class=s>&#34;hello world pass&#34;</span><span class=p>,</span> <span class=nb>false</span><span class=p>,</span> <span class=nb>false</span><span class=p>);</span>

<span class=k>static</span> <span class=n>RegisterStandardPasses</span> <span class=nf>Y</span><span class=p>(</span><span class=n>PassManagerBuilder</span><span class=o>::</span><span class=n>EP_EarlyAsPossible</span><span class=p>,</span>
                                <span class=p>[](</span><span class=k>const</span> <span class=n>PassManagerBuilder</span> <span class=o>&amp;</span><span class=n>builder</span><span class=p>,</span> <span class=n>legacy</span><span class=o>::</span><span class=n>PassManagerBase</span> <span class=o>&amp;</span><span class=n>pm</span><span class=p>)</span> <span class=p>{</span>
                                  <span class=n>pm</span><span class=p>.</span><span class=n>add</span><span class=p>(</span><span class=k>new</span> <span class=n>Hello</span><span class=p>());</span>
                                <span class=p>});</span>
</code></pre></td></tr></table>
</div>
</div><p>å†å‡†å¤‡ä¸€ä¸ªç®€å•çš„æ ·æœ¬ï¼Œç”¨æ¥å®éªŒ Pass çš„æ•ˆæœã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>printf</span><span class=p>(</span><span class=s>&#34;hello world&#34;</span><span class=p>);</span>
  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>æ¥ç€æ˜¯å®éªŒæ­¥éª¤ï¼š</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>clang -O3 -emit-llvm sample.c -c -o sample.bc
opt -enable-new-pm<span class=o>=</span><span class=m>0</span> -load build/hello.dll -hello sample.bc -o sample.exe
</code></pre></td></tr></table>
</div>
</div><p>å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plain data-lang=plain>Hello:main
</code></pre></td></tr></table>
</div>
</div><p>ä¸é¡ºåˆ©çš„è¯åªèƒ½è‡ªå·±è°·æ­Œã€‚</p>
<h2 id=0x02-ollvm-bcf-æ··æ·†åˆçª¥>0x02 OLLVM bcf æ··æ·†åˆçª¥</h2>
<p>è¿™éƒ¨åˆ†å…ˆçœ‹çœ‹çŸ¥åçš„ OLLVM é¡¹ç›®æ˜¯æ€ä¹ˆåšçš„ï¼Œå…ˆçœ‹ <em>bcf</em> æ··æ·†ï¼Œæºç åœ¨ <code>llvm/lib/Transforms/Obfuscation/BogusControlFlow.cpp</code>ï¼Œ å…¥å£åœ¨ <code>runOnFunction</code> å‡½æ•°ã€‚</p>
<h3 id=21-runonfunction>2.1 runOnFunction</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp>    <span class=cm>/* runOnFunction
</span><span class=cm>     *
</span><span class=cm>     * Overwrite FunctionPass method to apply the transformation
</span><span class=cm>     * to the function. See header for more details.
</span><span class=cm>     */</span>
    <span class=k>virtual</span> <span class=kt>bool</span> <span class=nf>runOnFunction</span><span class=p>(</span><span class=n>Function</span> <span class=o>&amp;</span><span class=n>F</span><span class=p>){</span>
      <span class=c1>// Check if the percentage is correct
</span><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=n>ObfTimes</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>errs</span><span class=p>()</span><span class=o>&lt;&lt;</span><span class=s>&#34;BogusControlFlow application number -bcf_loop=x must be x &gt; 0&#34;</span><span class=p>;</span>
		<span class=k>return</span> <span class=nb>false</span><span class=p>;</span>
      <span class=p>}</span>

      <span class=c1>// Check if the number of applications is correct
</span><span class=c1></span>      <span class=k>if</span> <span class=p>(</span> <span class=o>!</span><span class=p>((</span><span class=n>ObfProbRate</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>ObfProbRate</span> <span class=o>&lt;=</span> <span class=mi>100</span><span class=p>))</span> <span class=p>)</span> <span class=p>{</span>
        <span class=n>errs</span><span class=p>()</span><span class=o>&lt;&lt;</span><span class=s>&#34;BogusControlFlow application basic blocks percentage -bcf_prob=x must be 0 &lt; x &lt;= 100&#34;</span><span class=p>;</span>
		<span class=k>return</span> <span class=nb>false</span><span class=p>;</span>
      <span class=p>}</span>
      <span class=c1>// If fla annotations
</span><span class=c1></span>      <span class=k>if</span><span class=p>(</span><span class=n>toObfuscate</span><span class=p>(</span><span class=n>flag</span><span class=p>,</span><span class=o>&amp;</span><span class=n>F</span><span class=p>,</span><span class=s>&#34;bcf&#34;</span><span class=p>))</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>isInvoke</span><span class=p>(</span><span class=o>&amp;</span><span class=n>F</span><span class=p>))</span> <span class=p>{</span>
          <span class=n>bogus</span><span class=p>(</span><span class=n>F</span><span class=p>);</span>
          <span class=n>doF</span><span class=p>(</span><span class=o>*</span><span class=n>F</span><span class=p>.</span><span class=n>getParent</span><span class=p>());</span>
          <span class=k>return</span> <span class=nb>true</span><span class=p>;</span>
        <span class=p>}</span>
      <span class=p>}</span>

      <span class=k>return</span> <span class=nb>false</span><span class=p>;</span>
    <span class=p>}</span> <span class=c1>// end of runOnFunction()
</span></code></pre></td></tr></table>
</div>
</div><p>å‰ä¸¤ä¸ª <code>if</code> éƒ½æ˜¯åœ¨åˆ¤æ–­å‚æ•°ï¼Œå…ˆå¿½ç•¥ã€‚<code>if(toObfuscate(flag,&F,"bcf"))</code> åˆ¤æ–­æ˜¯å¦æ˜¯å¦éœ€è¦æ··æ·†ï¼Œ<code>if (isInvoke(&F))</code> åˆ¤æ–­èƒ½å¦æ··æ·†ã€‚</p>
<p>çœŸæ­£çš„æ··æ·†é€»è¾‘åœ¨ <code>bogus(F)</code> é‡Œã€‚</p>
<h3 id=22-bogus>2.2 bogus</h3>
<p>è£å‰ªæ‰äº†è°ƒè¯•è¾“å‡ºåçš„ <code>bogus</code> å‡½æ•°å†…å®¹ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=kt>void</span> <span class=nf>bogus</span><span class=p>(</span><span class=n>Function</span> <span class=o>&amp;</span><span class=n>F</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// For statistics and debug
</span><span class=c1></span>  <span class=o>++</span><span class=n>NumFunction</span><span class=p>;</span>
  <span class=kt>int</span> <span class=n>NumBasicBlocks</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
  <span class=kt>bool</span> <span class=n>firstTime</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span> <span class=c1>// First time we do the loop in this function
</span><span class=c1></span>
  <span class=n>NumTimesOnFunctions</span> <span class=o>=</span> <span class=n>ObfTimes</span><span class=p>;</span>
  <span class=kt>int</span> <span class=n>NumObfTimes</span> <span class=o>=</span> <span class=n>ObfTimes</span><span class=p>;</span>

  <span class=c1>// Real begining of the pass
</span><span class=c1></span>  <span class=c1>// Loop for the number of time we run the pass on the function
</span><span class=c1></span>  <span class=k>do</span> <span class=p>{</span>
    <span class=c1>// Put all the function&#39;s block in a list
</span><span class=c1></span>    <span class=n>std</span><span class=o>::</span><span class=n>list</span><span class=o>&lt;</span><span class=n>BasicBlock</span> <span class=o>*&gt;</span> <span class=n>basicBlocks</span><span class=p>;</span>
    <span class=k>for</span> <span class=p>(</span><span class=n>Function</span><span class=o>::</span><span class=n>iterator</span> <span class=n>i</span> <span class=o>=</span> <span class=n>F</span><span class=p>.</span><span class=n>begin</span><span class=p>();</span> <span class=n>i</span> <span class=o>!=</span> <span class=n>F</span><span class=p>.</span><span class=n>end</span><span class=p>();</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>basicBlocks</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=o>&amp;*</span><span class=n>i</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=n>basicBlocks</span><span class=p>.</span><span class=n>empty</span><span class=p>())</span> <span class=p>{</span>
      <span class=n>NumBasicBlocks</span><span class=o>++</span><span class=p>;</span>
      <span class=c1>// Basic Blocks&#39; selection
</span><span class=c1></span>      <span class=k>if</span> <span class=p>((</span><span class=kt>int</span><span class=p>)</span><span class=n>llvm</span><span class=o>::</span><span class=n>cryptoutils</span><span class=o>-&gt;</span><span class=n>get_range</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=n>ObfProbRate</span><span class=p>)</span> <span class=p>{</span>
        <span class=o>++</span><span class=n>NumModifiedBasicBlocks</span><span class=p>;</span>
        <span class=n>NumAddedBasicBlocks</span> <span class=o>+=</span> <span class=mi>3</span><span class=p>;</span>
        <span class=n>FinalNumBasicBlocks</span> <span class=o>+=</span> <span class=mi>3</span><span class=p>;</span>
        <span class=c1>// Add bogus flow to the given Basic Block (see description)
</span><span class=c1></span>        <span class=n>BasicBlock</span> <span class=o>*</span><span class=n>basicBlock</span> <span class=o>=</span> <span class=n>basicBlocks</span><span class=p>.</span><span class=n>front</span><span class=p>();</span>
        <span class=n>addBogusFlow</span><span class=p>(</span><span class=n>basicBlock</span><span class=p>,</span> <span class=n>F</span><span class=p>);</span>
      <span class=p>}</span>
      <span class=c1>// remove the block from the list
</span><span class=c1></span>      <span class=n>basicBlocks</span><span class=p>.</span><span class=n>pop_front</span><span class=p>();</span>

      <span class=k>if</span> <span class=p>(</span><span class=n>firstTime</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// first time we iterate on this function
</span><span class=c1></span>        <span class=o>++</span><span class=n>InitNumBasicBlocks</span><span class=p>;</span>
        <span class=o>++</span><span class=n>FinalNumBasicBlocks</span><span class=p>;</span>
      <span class=p>}</span>
    <span class=p>}</span> <span class=c1>// end of while(!basicBlocks.empty())
</span><span class=c1></span>
    <span class=n>firstTime</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
  <span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=o>--</span><span class=n>NumObfTimes</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>å°è¯•åˆ†æä¸Šé¢çš„å‡½æ•°é€»è¾‘ï¼š</p>
<ol>
<li>å¾ªç¯æ··æ·†ä¸€å®šæ¬¡æ•°ï¼ˆ<code>NumObfTimes</code>ï¼‰
<ol>
<li>éå†åŸå‡½æ•°åŸºæœ¬å—ï¼ˆ<code>basicBlocks</code>ï¼‰
<ol>
<li>é€‰æ‹©åŸºæœ¬å—ï¼ˆ<code>cryptoutils->get_range(100) &lt;= ObfProbRate</code>ï¼‰
<ol>
<li>å„ç§è®¡æ•°è‡ªå¢</li>
<li>æ·»åŠ ä¼ªé€ æ§åˆ¶æµï¼ˆ<code>addBogusFlow(basicBlock, F)</code>ï¼‰</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<p>æ··æ·†æ¬¡æ•°å’ŒåŸºæœ¬å—éå†æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œé€‰æ‹©åŸºæœ¬å—è¿™é‡Œï¼Œ<code>get_range(100)</code> å®é™…ä¸Šæ˜¯ä¸€ä¸ªå®‰å…¨çš„éšæœºæ•°ç”Ÿæˆå™¨ï¼Œ<code>ObfProbRate</code> æ˜¯åŸºæœ¬å—è¢«æ··æ·†çš„æœºç‡ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªå‡½æ•°å†…çš„åŸºæœ¬å—æ˜¯éšæœºè¢«æ··æ·†çš„ï¼ŒåŠ ä¸Šæ··æ·†æ¬¡æ•°çš„è®¾è®¡ï¼Œä¼šå‡ºç°æœ‰çš„åŸºæœ¬å—è¢«æ··æ·†å¤šæ¬¡æœ‰çš„æ²¡æœ‰è¢«æ··æ·†çš„æƒ…å†µã€‚</p>
<h3 id=22-addbogusflow>2.2 addBogusFlow</h3>
<p>æ¥ç€ç»§ç»­çœ‹æ·»åŠ ä¼ªé€ æ§åˆ¶æµçš„é€»è¾‘ï¼ŒåŒæ ·è£å‰ªæ‰äº†è°ƒè¯•è¾“å‡ºã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=cm>/* addBogusFlow
</span><span class=cm>  *
</span><span class=cm>  * Add bogus flow to a given basic block, according to the header&#39;s description
</span><span class=cm>  */</span>
<span class=k>virtual</span> <span class=kt>void</span> <span class=nf>addBogusFlow</span><span class=p>(</span><span class=n>BasicBlock</span> <span class=o>*</span><span class=n>basicBlock</span><span class=p>,</span> <span class=n>Function</span> <span class=o>&amp;</span><span class=n>F</span><span class=p>)</span> <span class=p>{</span>
      <span class=c1>// Split the block: first part with only the phi nodes and debug info and terminator
</span><span class=c1></span>      <span class=c1>//                  created by splitBasicBlock. (-&gt; No instruction)
</span><span class=c1></span>      <span class=c1>//                  Second part with every instructions from the original block
</span><span class=c1></span>      <span class=c1>// We do this way, so we don&#39;t have to adjust all the phi nodes, metadatas and so on
</span><span class=c1></span>      <span class=c1>// for the first block. We have to let the phi nodes in the first part, because they
</span><span class=c1></span>      <span class=c1>// actually are updated in the second part according to them.
</span><span class=c1></span>      <span class=n>BasicBlock</span><span class=o>::</span><span class=n>iterator</span> <span class=n>i1</span> <span class=o>=</span> <span class=n>basicBlock</span><span class=o>-&gt;</span><span class=n>begin</span><span class=p>();</span>
      <span class=k>if</span> <span class=p>(</span><span class=n>basicBlock</span><span class=o>-&gt;</span><span class=n>getFirstNonPHIOrDbgOrLifetime</span><span class=p>())</span>
        <span class=n>i1</span> <span class=o>=</span> <span class=p>(</span><span class=n>BasicBlock</span><span class=o>::</span><span class=n>iterator</span><span class=p>)</span><span class=n>basicBlock</span><span class=o>-&gt;</span><span class=n>getFirstNonPHIOrDbgOrLifetime</span><span class=p>();</span>
      <span class=n>Twine</span> <span class=o>*</span><span class=n>var</span><span class=p>;</span>
      <span class=n>var</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Twine</span><span class=p>(</span><span class=s>&#34;originalBB&#34;</span><span class=p>);</span>
      <span class=n>BasicBlock</span> <span class=o>*</span><span class=n>originalBB</span> <span class=o>=</span> <span class=n>basicBlock</span><span class=o>-&gt;</span><span class=n>splitBasicBlock</span><span class=p>(</span><span class=n>i1</span><span class=p>,</span> <span class=o>*</span><span class=n>var</span><span class=p>);</span>

      <span class=c1>// Creating the altered basic block on which the first basicBlock will jump
</span><span class=c1></span>      <span class=n>Twine</span> <span class=o>*</span><span class=n>var3</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Twine</span><span class=p>(</span><span class=s>&#34;alteredBB&#34;</span><span class=p>);</span>
      <span class=n>BasicBlock</span> <span class=o>*</span><span class=n>alteredBB</span> <span class=o>=</span> <span class=n>createAlteredBasicBlock</span><span class=p>(</span><span class=n>originalBB</span><span class=p>,</span> <span class=o>*</span><span class=n>var3</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>F</span><span class=p>);</span>

      <span class=c1>// Now that all the blocks are created,
</span><span class=c1></span>      <span class=c1>// we modify the terminators to adjust the control flow.
</span><span class=c1></span>      <span class=n>alteredBB</span><span class=o>-&gt;</span><span class=n>getTerminator</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>eraseFromParent</span><span class=p>();</span>
      <span class=n>basicBlock</span><span class=o>-&gt;</span><span class=n>getTerminator</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>eraseFromParent</span><span class=p>();</span>

      <span class=c1>// Preparing a condition..
</span><span class=c1></span>      <span class=c1>// For now, the condition is an always true comparaison between 2 float
</span><span class=c1></span>      <span class=c1>// This will be complicated after the pass (in doFinalization())
</span><span class=c1></span>      <span class=n>Value</span> <span class=o>*</span><span class=n>LHS</span> <span class=o>=</span> <span class=n>ConstantFP</span><span class=o>::</span><span class=n>get</span><span class=p>(</span><span class=n>Type</span><span class=o>::</span><span class=n>getFloatTy</span><span class=p>(</span><span class=n>F</span><span class=p>.</span><span class=n>getContext</span><span class=p>()),</span> <span class=mf>1.0</span><span class=p>);</span>
      <span class=n>Value</span> <span class=o>*</span><span class=n>RHS</span> <span class=o>=</span> <span class=n>ConstantFP</span><span class=o>::</span><span class=n>get</span><span class=p>(</span><span class=n>Type</span><span class=o>::</span><span class=n>getFloatTy</span><span class=p>(</span><span class=n>F</span><span class=p>.</span><span class=n>getContext</span><span class=p>()),</span> <span class=mf>1.0</span><span class=p>);</span>

      <span class=c1>// The always true condition. End of the first block
</span><span class=c1></span>      <span class=n>Twine</span> <span class=o>*</span><span class=n>var4</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Twine</span><span class=p>(</span><span class=s>&#34;condition&#34;</span><span class=p>);</span>
      <span class=n>FCmpInst</span> <span class=o>*</span><span class=n>condition</span> <span class=o>=</span> <span class=k>new</span> <span class=n>FCmpInst</span><span class=p>(</span><span class=o>*</span><span class=n>basicBlock</span><span class=p>,</span> <span class=n>FCmpInst</span><span class=o>::</span><span class=n>FCMP_TRUE</span><span class=p>,</span> <span class=n>LHS</span><span class=p>,</span> <span class=n>RHS</span><span class=p>,</span> <span class=o>*</span><span class=n>var4</span><span class=p>);</span>

      <span class=c1>// Jump to the original basic block if the condition is true or
</span><span class=c1></span>      <span class=c1>// to the altered block if false.
</span><span class=c1></span>      <span class=n>BranchInst</span><span class=o>::</span><span class=n>Create</span><span class=p>(</span><span class=n>originalBB</span><span class=p>,</span> <span class=n>alteredBB</span><span class=p>,</span> <span class=p>(</span><span class=n>Value</span> <span class=o>*</span><span class=p>)</span><span class=n>condition</span><span class=p>,</span> <span class=n>basicBlock</span><span class=p>);</span>

      <span class=c1>// The altered block loop back on the original one.
</span><span class=c1></span>      <span class=n>BranchInst</span><span class=o>::</span><span class=n>Create</span><span class=p>(</span><span class=n>originalBB</span><span class=p>,</span> <span class=n>alteredBB</span><span class=p>);</span>

      <span class=c1>// The end of the originalBB is modified to give the impression that sometimes
</span><span class=c1></span>      <span class=c1>// it continues in the loop, and sometimes it return the desired value
</span><span class=c1></span>      <span class=c1>// (of course it&#39;s always true, so it always use the original terminator..
</span><span class=c1></span>      <span class=c1>//  but this will be obfuscated too;) )
</span><span class=c1></span>
      <span class=c1>// iterate on instruction just before the terminator of the originalBB
</span><span class=c1></span>      <span class=n>BasicBlock</span><span class=o>::</span><span class=n>iterator</span> <span class=n>i</span> <span class=o>=</span> <span class=n>originalBB</span><span class=o>-&gt;</span><span class=n>end</span><span class=p>();</span>

      <span class=c1>// Split at this point (we only want the terminator in the second part)
</span><span class=c1></span>      <span class=n>Twine</span> <span class=o>*</span><span class=n>var5</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Twine</span><span class=p>(</span><span class=s>&#34;originalBBpart2&#34;</span><span class=p>);</span>
      <span class=n>BasicBlock</span> <span class=o>*</span><span class=n>originalBBpart2</span> <span class=o>=</span> <span class=n>originalBB</span><span class=o>-&gt;</span><span class=n>splitBasicBlock</span><span class=p>(</span><span class=o>--</span><span class=n>i</span><span class=p>,</span> <span class=o>*</span><span class=n>var5</span><span class=p>);</span>
      <span class=c1>// the first part go either on the return statement or on the begining
</span><span class=c1></span>      <span class=c1>// of the altered block.. So we erase the terminator created when splitting.
</span><span class=c1></span>      <span class=n>originalBB</span><span class=o>-&gt;</span><span class=n>getTerminator</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>eraseFromParent</span><span class=p>();</span>
      <span class=c1>// We add at the end a new always true condition
</span><span class=c1></span>      <span class=n>Twine</span> <span class=o>*</span><span class=n>var6</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Twine</span><span class=p>(</span><span class=s>&#34;condition2&#34;</span><span class=p>);</span>
      <span class=n>FCmpInst</span> <span class=o>*</span><span class=n>condition2</span> <span class=o>=</span> <span class=k>new</span> <span class=n>FCmpInst</span><span class=p>(</span><span class=o>*</span><span class=n>originalBB</span><span class=p>,</span> <span class=n>CmpInst</span><span class=o>::</span><span class=n>FCMP_TRUE</span><span class=p>,</span> <span class=n>LHS</span><span class=p>,</span> <span class=n>RHS</span><span class=p>,</span> <span class=o>*</span><span class=n>var6</span><span class=p>);</span>
      <span class=n>BranchInst</span><span class=o>::</span><span class=n>Create</span><span class=p>(</span><span class=n>originalBBpart2</span><span class=p>,</span> <span class=n>alteredBB</span><span class=p>,</span> <span class=p>(</span><span class=n>Value</span> <span class=o>*</span><span class=p>)</span><span class=n>condition2</span><span class=p>,</span> <span class=n>originalBB</span><span class=p>);</span>
<span class=p>}</span> <span class=c1>// end of addBogusFlow()
</span></code></pre></td></tr></table>
</div>
</div><p>å°è¯•åˆ†æä¸Šé¢çš„å‡½æ•°é€»è¾‘ï¼š</p>
<ol>
<li>åˆ†å‰²åŸºæœ¬å—ï¼ŒæŠŠ <code>phinode</code> å’Œè°ƒè¯•ä¿¡æ¯ä¹‹ç±»çš„åˆ†å‰²åˆ°åŸå§‹å—ï¼Œæ–°åˆ›å»ºå‡ºæ¥çš„å—ä¸åŒ…å« <code>phinode</code> ä¹‹ç±»çš„ä¸œè¥¿ã€‚ï¼ˆ<code>entry</code>ï¼‰</li>
<li>åˆ›å»ºä¼ªé€ åˆ†æ”¯ã€‚ï¼ˆ<code>altered</code>ï¼‰</li>
<li>åˆ›å»ºæ’çœŸæ¡ä»¶ï¼Œè¿™é‡Œæ˜¯åˆ©ç”¨æµ®ç‚¹æ¯”è¾ƒ <code>FCMP_TRUE</code>ã€‚ï¼ˆ<code>condition</code>ï¼‰</li>
<li>åˆ›å»ºåˆ†æ”¯æŒ‡ä»¤ï¼ŒçœŸè·³è½¬åŸå§‹å—ï¼Œå‡è·³è½¬ä¼ªé€ å—ï¼Œä¼ªé€ å—çš„æœ«å°¾åˆè·³å›åŸå§‹å—ã€‚</li>
<li>åœ¨åŸå§‹å—çš„ç»“æŸéƒ¨åˆ†å†æ¬¡åˆ†å‰²åŸºæœ¬å—ï¼Œåˆ†å‰²åçš„å—åŒ…å«åŸå§‹å—çš„ terminator ï¼ˆ<code>terminator</code>ï¼‰</li>
<li>åˆ›å»ºä¸€ä¸ªæ’çœŸæ¡ä»¶ï¼Œè·³è½¬åˆ°åŸå§‹å—çš„ terminatorï¼Œå‡åˆ™è·³è½¬åˆ°ä¼ªé€ å— ï¼ˆ<code>condition2</code>ï¼‰</li>
</ol>
<p><img src=/p/learning-packer-08/image-20211102160422737.png width=435 height=648 srcset="/p/learning-packer-08/image-20211102160422737_hu1adf2e2db9eba618ac02ebe93739a09a_98722_480x0_resize_box_3.png 480w, /p/learning-packer-08/image-20211102160422737_hu1adf2e2db9eba618ac02ebe93739a09a_98722_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20211102160422737 class=gallery-image data-flex-grow=67 data-flex-basis=161px></p>
<p>æ··æ·†åçš„æ§åˆ¶æµé•¿è¿™æ ·ï¼Œä¸¤ä¸ª condition éƒ½æ˜¯æ’çœŸæ¡ä»¶ï¼ŒåŸå§‹å—è¢«åˆ†æˆäº†ä¸‰ä¸ªéƒ¨åˆ†ï¼Œ<code>entry</code>ã€<code>origin</code>ã€<code>terminator</code> ã€‚å›¾ä¸­çº¢è‰²çš„éƒ¨åˆ†æ˜¯ä¼ªé€ å—ï¼ŒåŒ…å«åƒåœ¾æŒ‡ä»¤ï¼Œç»¿è‰²çš„æ¡ä»¶å—éƒ½æ˜¯æ’çœŸæ¡ä»¶ï¼Œåªæœ‰ç»¿è‰²ç®­å¤´çš„æ§åˆ¶æµèƒ½èµ°é€šã€‚è“è‰²èŠ‚ç‚¹æ˜¯ä»åŸå§‹åŸºæœ¬å—ä¸Šåˆ†å‰²å‡ºæ¥çš„éƒ¨åˆ†ã€‚</p>
<h3 id=23-createalteredbasicblock>2.3 createAlteredBasicBlock</h3>
<p>å†çœ‹ä¼ªé€ å—æ˜¯å¦‚ä½•ç”Ÿæˆçš„ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++>    <span class=cm>/* createAlteredBasicBlock
</span><span class=cm>     *
</span><span class=cm>     * This function return a basic block similar to a given one.
</span><span class=cm>     * It&#39;s inserted just after the given basic block.
</span><span class=cm>     * The instructions are similar but junk instructions are added between
</span><span class=cm>     * the cloned one. The cloned instructions&#39; phi nodes, metadatas, uses and
</span><span class=cm>     * debug locations are adjusted to fit in the cloned basic block and
</span><span class=cm>     * behave nicely.
</span><span class=cm>     */</span>
    <span class=k>virtual</span> <span class=n>BasicBlock</span> <span class=o>*</span><span class=nf>createAlteredBasicBlock</span><span class=p>(</span><span class=n>BasicBlock</span> <span class=o>*</span><span class=n>basicBlock</span><span class=p>,</span> <span class=k>const</span> <span class=n>Twine</span> <span class=o>&amp;</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;gen&#34;</span><span class=p>,</span> <span class=n>Function</span> <span class=o>*</span><span class=n>F</span> <span class=o>=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
      <span class=c1>// Useful to remap the informations concerning instructions.
</span><span class=c1></span>      <span class=n>ValueToValueMapTy</span> <span class=n>VMap</span><span class=p>;</span>
      <span class=n>BasicBlock</span> <span class=o>*</span><span class=n>alteredBB</span> <span class=o>=</span> <span class=n>llvm</span><span class=o>::</span><span class=n>CloneBasicBlock</span><span class=p>(</span><span class=n>basicBlock</span><span class=p>,</span> <span class=n>VMap</span><span class=p>,</span> <span class=n>Name</span><span class=p>,</span> <span class=n>F</span><span class=p>);</span>
      <span class=c1>// Remap operands.
</span><span class=c1></span>      <span class=n>BasicBlock</span><span class=o>::</span><span class=n>iterator</span> <span class=n>ji</span> <span class=o>=</span> <span class=n>basicBlock</span><span class=o>-&gt;</span><span class=n>begin</span><span class=p>();</span>
      <span class=k>for</span> <span class=p>(</span><span class=n>BasicBlock</span><span class=o>::</span><span class=n>iterator</span> <span class=n>i</span> <span class=o>=</span> <span class=n>alteredBB</span><span class=o>-&gt;</span><span class=n>begin</span><span class=p>(),</span> <span class=n>e</span> <span class=o>=</span> <span class=n>alteredBB</span><span class=o>-&gt;</span><span class=n>end</span><span class=p>();</span> <span class=n>i</span> <span class=o>!=</span> <span class=n>e</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// Loop over the operands of the instruction
</span><span class=c1></span>        <span class=k>for</span> <span class=p>(</span><span class=n>User</span><span class=o>::</span><span class=n>op_iterator</span> <span class=n>opi</span> <span class=o>=</span> <span class=n>i</span><span class=o>-&gt;</span><span class=n>op_begin</span><span class=p>(),</span> <span class=n>ope</span> <span class=o>=</span> <span class=n>i</span><span class=o>-&gt;</span><span class=n>op_end</span><span class=p>();</span> <span class=n>opi</span> <span class=o>!=</span> <span class=n>ope</span><span class=p>;</span> <span class=o>++</span><span class=n>opi</span><span class=p>)</span> <span class=p>{</span>
          <span class=c1>// get the value for the operand
</span><span class=c1></span>          <span class=n>Value</span> <span class=o>*</span><span class=n>v</span> <span class=o>=</span> <span class=n>MapValue</span><span class=p>(</span><span class=o>*</span><span class=n>opi</span><span class=p>,</span> <span class=n>VMap</span><span class=p>,</span> <span class=n>RF_None</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
          <span class=k>if</span> <span class=p>(</span><span class=n>v</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=o>*</span><span class=n>opi</span> <span class=o>=</span> <span class=n>v</span><span class=p>;</span>
          <span class=p>}</span>
        <span class=p>}</span>
        <span class=c1>// Remap phi nodes&#39; incoming blocks.
</span><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>PHINode</span> <span class=o>*</span><span class=n>pn</span> <span class=o>=</span> <span class=n>dyn_cast</span><span class=o>&lt;</span><span class=n>PHINode</span><span class=o>&gt;</span><span class=p>(</span><span class=n>i</span><span class=p>))</span> <span class=p>{</span>
          <span class=k>for</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>e</span> <span class=o>=</span> <span class=n>pn</span><span class=o>-&gt;</span><span class=n>getNumIncomingValues</span><span class=p>();</span> <span class=n>j</span> <span class=o>!=</span> <span class=n>e</span><span class=p>;</span> <span class=o>++</span><span class=n>j</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>Value</span> <span class=o>*</span><span class=n>v</span> <span class=o>=</span> <span class=n>MapValue</span><span class=p>(</span><span class=n>pn</span><span class=o>-&gt;</span><span class=n>getIncomingBlock</span><span class=p>(</span><span class=n>j</span><span class=p>),</span> <span class=n>VMap</span><span class=p>,</span> <span class=n>RF_None</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>v</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
              <span class=n>pn</span><span class=o>-&gt;</span><span class=n>setIncomingBlock</span><span class=p>(</span><span class=n>j</span><span class=p>,</span> <span class=n>cast</span><span class=o>&lt;</span><span class=n>BasicBlock</span><span class=o>&gt;</span><span class=p>(</span><span class=n>v</span><span class=p>));</span>
            <span class=p>}</span>
          <span class=p>}</span>
        <span class=p>}</span>
        <span class=c1>// Remap attached metadata.
</span><span class=c1></span>        <span class=n>SmallVector</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>pair</span><span class=o>&lt;</span><span class=kt>unsigned</span><span class=p>,</span> <span class=n>MDNode</span> <span class=o>*&gt;</span><span class=p>,</span> <span class=mi>4</span><span class=o>&gt;</span> <span class=n>MDs</span><span class=p>;</span>
        <span class=n>i</span><span class=o>-&gt;</span><span class=n>getAllMetadata</span><span class=p>(</span><span class=n>MDs</span><span class=p>);</span>
        <span class=c1>// important for compiling with DWARF, using option -g.
</span><span class=c1></span>        <span class=n>i</span><span class=o>-&gt;</span><span class=n>setDebugLoc</span><span class=p>(</span><span class=n>ji</span><span class=o>-&gt;</span><span class=n>getDebugLoc</span><span class=p>());</span>
        <span class=n>ji</span><span class=o>++</span><span class=p>;</span>

      <span class=p>}</span> <span class=c1>// The instructions&#39; informations are now all correct
</span><span class=c1></span>

      <span class=c1>// add random instruction in the middle of the bloc. This part can be improve
</span><span class=c1></span>      <span class=k>for</span> <span class=p>(</span><span class=n>BasicBlock</span><span class=o>::</span><span class=n>iterator</span> <span class=n>i</span> <span class=o>=</span> <span class=n>alteredBB</span><span class=o>-&gt;</span><span class=n>begin</span><span class=p>(),</span> <span class=n>e</span> <span class=o>=</span> <span class=n>alteredBB</span><span class=o>-&gt;</span><span class=n>end</span><span class=p>();</span> <span class=n>i</span> <span class=o>!=</span> <span class=n>e</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// in the case we find binary operator, we modify slightly this part by randomly
</span><span class=c1></span>        <span class=c1>// insert some instructions
</span><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>i</span><span class=o>-&gt;</span><span class=n>isBinaryOp</span><span class=p>())</span> <span class=p>{</span> <span class=c1>// binary instructions
</span><span class=c1></span>          <span class=kt>unsigned</span> <span class=n>opcode</span> <span class=o>=</span> <span class=n>i</span><span class=o>-&gt;</span><span class=n>getOpcode</span><span class=p>();</span>
          <span class=n>BinaryOperator</span> <span class=o>*</span><span class=n>op</span><span class=p>,</span> <span class=o>*</span><span class=n>op1</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
          <span class=n>UnaryOperator</span> <span class=o>*</span><span class=n>op2</span><span class=p>;</span>
          <span class=n>Twine</span> <span class=o>*</span><span class=n>var</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Twine</span><span class=p>(</span><span class=s>&#34;_&#34;</span><span class=p>);</span>
          <span class=c1>// treat differently float or int
</span><span class=c1></span>          <span class=c1>// Binary int
</span><span class=c1></span>          <span class=k>if</span> <span class=p>(</span><span class=n>opcode</span> <span class=o>==</span> <span class=n>Instruction</span><span class=o>::</span><span class=n>Add</span> <span class=o>||</span> <span class=n>opcode</span> <span class=o>==</span> <span class=n>Instruction</span><span class=o>::</span><span class=n>Sub</span> <span class=o>||</span> <span class=n>opcode</span> <span class=o>==</span> <span class=n>Instruction</span><span class=o>::</span><span class=n>Mul</span> <span class=o>||</span>
              <span class=n>opcode</span> <span class=o>==</span> <span class=n>Instruction</span><span class=o>::</span><span class=n>UDiv</span> <span class=o>||</span> <span class=n>opcode</span> <span class=o>==</span> <span class=n>Instruction</span><span class=o>::</span><span class=n>SDiv</span> <span class=o>||</span> <span class=n>opcode</span> <span class=o>==</span> <span class=n>Instruction</span><span class=o>::</span><span class=n>URem</span> <span class=o>||</span>
              <span class=n>opcode</span> <span class=o>==</span> <span class=n>Instruction</span><span class=o>::</span><span class=n>SRem</span> <span class=o>||</span> <span class=n>opcode</span> <span class=o>==</span> <span class=n>Instruction</span><span class=o>::</span><span class=n>Shl</span> <span class=o>||</span> <span class=n>opcode</span> <span class=o>==</span> <span class=n>Instruction</span><span class=o>::</span><span class=n>LShr</span> <span class=o>||</span>
              <span class=n>opcode</span> <span class=o>==</span> <span class=n>Instruction</span><span class=o>::</span><span class=n>AShr</span> <span class=o>||</span> <span class=n>opcode</span> <span class=o>==</span> <span class=n>Instruction</span><span class=o>::</span><span class=n>And</span> <span class=o>||</span> <span class=n>opcode</span> <span class=o>==</span> <span class=n>Instruction</span><span class=o>::</span><span class=n>Or</span> <span class=o>||</span>
              <span class=n>opcode</span> <span class=o>==</span> <span class=n>Instruction</span><span class=o>::</span><span class=n>Xor</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>random</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>llvm</span><span class=o>::</span><span class=n>cryptoutils</span><span class=o>-&gt;</span><span class=n>get_range</span><span class=p>(</span><span class=mi>10</span><span class=p>);</span> <span class=n>random</span> <span class=o>&lt;</span> <span class=mi>10</span><span class=p>;</span> <span class=o>++</span><span class=n>random</span><span class=p>)</span> <span class=p>{</span>
              <span class=k>switch</span> <span class=p>(</span><span class=n>llvm</span><span class=o>::</span><span class=n>cryptoutils</span><span class=o>-&gt;</span><span class=n>get_range</span><span class=p>(</span><span class=mi>4</span><span class=p>))</span> <span class=p>{</span> <span class=c1>// to improve
</span><span class=c1></span>              <span class=k>case</span> <span class=mi>0</span><span class=o>:</span>                                    <span class=c1>// do nothing
</span><span class=c1></span>                <span class=k>break</span><span class=p>;</span>
              <span class=k>case</span> <span class=mi>1</span><span class=o>:</span>
                <span class=n>op</span> <span class=o>=</span> <span class=n>BinaryOperator</span><span class=o>::</span><span class=n>CreateNeg</span><span class=p>(</span><span class=n>i</span><span class=o>-&gt;</span><span class=n>getOperand</span><span class=p>(</span><span class=mi>0</span><span class=p>),</span> <span class=o>*</span><span class=n>var</span><span class=p>,</span> <span class=o>&amp;*</span><span class=n>i</span><span class=p>);</span>
                <span class=n>op1</span> <span class=o>=</span> <span class=n>BinaryOperator</span><span class=o>::</span><span class=n>Create</span><span class=p>(</span><span class=n>Instruction</span><span class=o>::</span><span class=n>Add</span><span class=p>,</span> <span class=n>op</span><span class=p>,</span> <span class=n>i</span><span class=o>-&gt;</span><span class=n>getOperand</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span> <span class=s>&#34;gen&#34;</span><span class=p>,</span> <span class=o>&amp;*</span><span class=n>i</span><span class=p>);</span>
                <span class=k>break</span><span class=p>;</span>
              <span class=k>case</span> <span class=mi>2</span><span class=o>:</span>
                <span class=n>op1</span> <span class=o>=</span> <span class=n>BinaryOperator</span><span class=o>::</span><span class=n>Create</span><span class=p>(</span><span class=n>Instruction</span><span class=o>::</span><span class=n>Sub</span><span class=p>,</span> <span class=n>i</span><span class=o>-&gt;</span><span class=n>getOperand</span><span class=p>(</span><span class=mi>0</span><span class=p>),</span> <span class=n>i</span><span class=o>-&gt;</span><span class=n>getOperand</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span> <span class=o>*</span><span class=n>var</span><span class=p>,</span> <span class=o>&amp;*</span><span class=n>i</span><span class=p>);</span>
                <span class=n>op</span> <span class=o>=</span> <span class=n>BinaryOperator</span><span class=o>::</span><span class=n>Create</span><span class=p>(</span><span class=n>Instruction</span><span class=o>::</span><span class=n>Mul</span><span class=p>,</span> <span class=n>op1</span><span class=p>,</span> <span class=n>i</span><span class=o>-&gt;</span><span class=n>getOperand</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span> <span class=s>&#34;gen&#34;</span><span class=p>,</span> <span class=o>&amp;*</span><span class=n>i</span><span class=p>);</span>
                <span class=k>break</span><span class=p>;</span>
              <span class=k>case</span> <span class=mi>3</span><span class=o>:</span>
                <span class=n>op</span> <span class=o>=</span> <span class=n>BinaryOperator</span><span class=o>::</span><span class=n>Create</span><span class=p>(</span><span class=n>Instruction</span><span class=o>::</span><span class=n>Shl</span><span class=p>,</span> <span class=n>i</span><span class=o>-&gt;</span><span class=n>getOperand</span><span class=p>(</span><span class=mi>0</span><span class=p>),</span> <span class=n>i</span><span class=o>-&gt;</span><span class=n>getOperand</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span> <span class=o>*</span><span class=n>var</span><span class=p>,</span> <span class=o>&amp;*</span><span class=n>i</span><span class=p>);</span>
                <span class=k>break</span><span class=p>;</span>
              <span class=p>}</span>
            <span class=p>}</span>
          <span class=p>}</span>
          <span class=c1>// Binary float
</span><span class=c1></span>          <span class=k>if</span> <span class=p>(</span><span class=n>opcode</span> <span class=o>==</span> <span class=n>Instruction</span><span class=o>::</span><span class=n>FAdd</span> <span class=o>||</span> <span class=n>opcode</span> <span class=o>==</span> <span class=n>Instruction</span><span class=o>::</span><span class=n>FSub</span> <span class=o>||</span> <span class=n>opcode</span> <span class=o>==</span> <span class=n>Instruction</span><span class=o>::</span><span class=n>FMul</span> <span class=o>||</span>
              <span class=n>opcode</span> <span class=o>==</span> <span class=n>Instruction</span><span class=o>::</span><span class=n>FDiv</span> <span class=o>||</span> <span class=n>opcode</span> <span class=o>==</span> <span class=n>Instruction</span><span class=o>::</span><span class=n>FRem</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>random</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>llvm</span><span class=o>::</span><span class=n>cryptoutils</span><span class=o>-&gt;</span><span class=n>get_range</span><span class=p>(</span><span class=mi>10</span><span class=p>);</span> <span class=n>random</span> <span class=o>&lt;</span> <span class=mi>10</span><span class=p>;</span> <span class=o>++</span><span class=n>random</span><span class=p>)</span> <span class=p>{</span>
              <span class=k>switch</span> <span class=p>(</span><span class=n>llvm</span><span class=o>::</span><span class=n>cryptoutils</span><span class=o>-&gt;</span><span class=n>get_range</span><span class=p>(</span><span class=mi>3</span><span class=p>))</span> <span class=p>{</span> <span class=c1>// can be improved
</span><span class=c1></span>              <span class=k>case</span> <span class=mi>0</span><span class=o>:</span>                                    <span class=c1>// do nothing
</span><span class=c1></span>                <span class=k>break</span><span class=p>;</span>
              <span class=k>case</span> <span class=mi>1</span><span class=o>:</span>
                <span class=n>op2</span> <span class=o>=</span> <span class=n>UnaryOperator</span><span class=o>::</span><span class=n>CreateFNeg</span><span class=p>(</span><span class=n>i</span><span class=o>-&gt;</span><span class=n>getOperand</span><span class=p>(</span><span class=mi>0</span><span class=p>),</span> <span class=o>*</span><span class=n>var</span><span class=p>,</span> <span class=o>&amp;*</span><span class=n>i</span><span class=p>);</span>
                <span class=n>op1</span> <span class=o>=</span> <span class=n>BinaryOperator</span><span class=o>::</span><span class=n>Create</span><span class=p>(</span><span class=n>Instruction</span><span class=o>::</span><span class=n>FAdd</span><span class=p>,</span> <span class=n>op2</span><span class=p>,</span> <span class=n>i</span><span class=o>-&gt;</span><span class=n>getOperand</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span> <span class=s>&#34;gen&#34;</span><span class=p>,</span> <span class=o>&amp;*</span><span class=n>i</span><span class=p>);</span>
                <span class=k>break</span><span class=p>;</span>
              <span class=k>case</span> <span class=mi>2</span><span class=o>:</span>
                <span class=n>op</span> <span class=o>=</span> <span class=n>BinaryOperator</span><span class=o>::</span><span class=n>Create</span><span class=p>(</span><span class=n>Instruction</span><span class=o>::</span><span class=n>FSub</span><span class=p>,</span> <span class=n>i</span><span class=o>-&gt;</span><span class=n>getOperand</span><span class=p>(</span><span class=mi>0</span><span class=p>),</span> <span class=n>i</span><span class=o>-&gt;</span><span class=n>getOperand</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span> <span class=o>*</span><span class=n>var</span><span class=p>,</span> <span class=o>&amp;*</span><span class=n>i</span><span class=p>);</span>
                <span class=n>op1</span> <span class=o>=</span> <span class=n>BinaryOperator</span><span class=o>::</span><span class=n>Create</span><span class=p>(</span><span class=n>Instruction</span><span class=o>::</span><span class=n>FMul</span><span class=p>,</span> <span class=n>op</span><span class=p>,</span> <span class=n>i</span><span class=o>-&gt;</span><span class=n>getOperand</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span> <span class=s>&#34;gen&#34;</span><span class=p>,</span> <span class=o>&amp;*</span><span class=n>i</span><span class=p>);</span>
                <span class=k>break</span><span class=p>;</span>
              <span class=p>}</span>
            <span class=p>}</span>
          <span class=p>}</span>
          <span class=k>if</span> <span class=p>(</span><span class=n>opcode</span> <span class=o>==</span> <span class=n>Instruction</span><span class=o>::</span><span class=n>ICmp</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// Condition (with int)
</span><span class=c1></span>            <span class=n>ICmpInst</span> <span class=o>*</span><span class=n>currentI</span> <span class=o>=</span> <span class=p>(</span><span class=n>ICmpInst</span> <span class=o>*</span><span class=p>)(</span><span class=o>&amp;</span><span class=n>i</span><span class=p>);</span>
            <span class=k>switch</span> <span class=p>(</span><span class=n>llvm</span><span class=o>::</span><span class=n>cryptoutils</span><span class=o>-&gt;</span><span class=n>get_range</span><span class=p>(</span><span class=mi>3</span><span class=p>))</span> <span class=p>{</span> <span class=c1>// must be improved
</span><span class=c1></span>            <span class=k>case</span> <span class=mi>0</span><span class=o>:</span>                                    <span class=c1>// do nothing
</span><span class=c1></span>              <span class=k>break</span><span class=p>;</span>
            <span class=k>case</span> <span class=mi>1</span><span class=o>:</span>
              <span class=n>currentI</span><span class=o>-&gt;</span><span class=n>swapOperands</span><span class=p>();</span>
              <span class=k>break</span><span class=p>;</span>
            <span class=k>case</span> <span class=mi>2</span><span class=o>:</span> <span class=c1>// randomly change the predicate
</span><span class=c1></span>              <span class=k>switch</span> <span class=p>(</span><span class=n>llvm</span><span class=o>::</span><span class=n>cryptoutils</span><span class=o>-&gt;</span><span class=n>get_range</span><span class=p>(</span><span class=mi>10</span><span class=p>))</span> <span class=p>{</span>
              <span class=k>case</span> <span class=mi>0</span><span class=o>:</span>
                <span class=n>currentI</span><span class=o>-&gt;</span><span class=n>setPredicate</span><span class=p>(</span><span class=n>ICmpInst</span><span class=o>::</span><span class=n>ICMP_EQ</span><span class=p>);</span>
                <span class=k>break</span><span class=p>;</span> <span class=c1>// equal
</span><span class=c1></span>              <span class=k>case</span> <span class=mi>1</span><span class=o>:</span>
                <span class=n>currentI</span><span class=o>-&gt;</span><span class=n>setPredicate</span><span class=p>(</span><span class=n>ICmpInst</span><span class=o>::</span><span class=n>ICMP_NE</span><span class=p>);</span>
                <span class=k>break</span><span class=p>;</span> <span class=c1>// not equal
</span><span class=c1></span>              <span class=k>case</span> <span class=mi>2</span><span class=o>:</span>
                <span class=n>currentI</span><span class=o>-&gt;</span><span class=n>setPredicate</span><span class=p>(</span><span class=n>ICmpInst</span><span class=o>::</span><span class=n>ICMP_UGT</span><span class=p>);</span>
                <span class=k>break</span><span class=p>;</span> <span class=c1>// unsigned greater than
</span><span class=c1></span>              <span class=k>case</span> <span class=mi>3</span><span class=o>:</span>
                <span class=n>currentI</span><span class=o>-&gt;</span><span class=n>setPredicate</span><span class=p>(</span><span class=n>ICmpInst</span><span class=o>::</span><span class=n>ICMP_UGE</span><span class=p>);</span>
                <span class=k>break</span><span class=p>;</span> <span class=c1>// unsigned greater or equal
</span><span class=c1></span>              <span class=k>case</span> <span class=mi>4</span><span class=o>:</span>
                <span class=n>currentI</span><span class=o>-&gt;</span><span class=n>setPredicate</span><span class=p>(</span><span class=n>ICmpInst</span><span class=o>::</span><span class=n>ICMP_ULT</span><span class=p>);</span>
                <span class=k>break</span><span class=p>;</span> <span class=c1>// unsigned less than
</span><span class=c1></span>              <span class=k>case</span> <span class=mi>5</span><span class=o>:</span>
                <span class=n>currentI</span><span class=o>-&gt;</span><span class=n>setPredicate</span><span class=p>(</span><span class=n>ICmpInst</span><span class=o>::</span><span class=n>ICMP_ULE</span><span class=p>);</span>
                <span class=k>break</span><span class=p>;</span> <span class=c1>// unsigned less or equal
</span><span class=c1></span>              <span class=k>case</span> <span class=mi>6</span><span class=o>:</span>
                <span class=n>currentI</span><span class=o>-&gt;</span><span class=n>setPredicate</span><span class=p>(</span><span class=n>ICmpInst</span><span class=o>::</span><span class=n>ICMP_SGT</span><span class=p>);</span>
                <span class=k>break</span><span class=p>;</span> <span class=c1>// signed greater than
</span><span class=c1></span>              <span class=k>case</span> <span class=mi>7</span><span class=o>:</span>
                <span class=n>currentI</span><span class=o>-&gt;</span><span class=n>setPredicate</span><span class=p>(</span><span class=n>ICmpInst</span><span class=o>::</span><span class=n>ICMP_SGE</span><span class=p>);</span>
                <span class=k>break</span><span class=p>;</span> <span class=c1>// signed greater or equal
</span><span class=c1></span>              <span class=k>case</span> <span class=mi>8</span><span class=o>:</span>
                <span class=n>currentI</span><span class=o>-&gt;</span><span class=n>setPredicate</span><span class=p>(</span><span class=n>ICmpInst</span><span class=o>::</span><span class=n>ICMP_SLT</span><span class=p>);</span>
                <span class=k>break</span><span class=p>;</span> <span class=c1>// signed less than
</span><span class=c1></span>              <span class=k>case</span> <span class=mi>9</span><span class=o>:</span>
                <span class=n>currentI</span><span class=o>-&gt;</span><span class=n>setPredicate</span><span class=p>(</span><span class=n>ICmpInst</span><span class=o>::</span><span class=n>ICMP_SLE</span><span class=p>);</span>
                <span class=k>break</span><span class=p>;</span> <span class=c1>// signed less or equal
</span><span class=c1></span>              <span class=p>}</span>
              <span class=k>break</span><span class=p>;</span>
            <span class=p>}</span>
          <span class=p>}</span>
          <span class=k>if</span> <span class=p>(</span><span class=n>opcode</span> <span class=o>==</span> <span class=n>Instruction</span><span class=o>::</span><span class=n>FCmp</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// Conditions (with float)
</span><span class=c1></span>            <span class=n>FCmpInst</span> <span class=o>*</span><span class=n>currentI</span> <span class=o>=</span> <span class=p>(</span><span class=n>FCmpInst</span> <span class=o>*</span><span class=p>)(</span><span class=o>&amp;</span><span class=n>i</span><span class=p>);</span>
            <span class=k>switch</span> <span class=p>(</span><span class=n>llvm</span><span class=o>::</span><span class=n>cryptoutils</span><span class=o>-&gt;</span><span class=n>get_range</span><span class=p>(</span><span class=mi>3</span><span class=p>))</span> <span class=p>{</span> <span class=c1>// must be improved
</span><span class=c1></span>            <span class=k>case</span> <span class=mi>0</span><span class=o>:</span>                                    <span class=c1>// do nothing
</span><span class=c1></span>              <span class=k>break</span><span class=p>;</span>
            <span class=k>case</span> <span class=mi>1</span><span class=o>:</span>
              <span class=n>currentI</span><span class=o>-&gt;</span><span class=n>swapOperands</span><span class=p>();</span>
              <span class=k>break</span><span class=p>;</span>
            <span class=k>case</span> <span class=mi>2</span><span class=o>:</span> <span class=c1>// randomly change the predicate
</span><span class=c1></span>              <span class=k>switch</span> <span class=p>(</span><span class=n>llvm</span><span class=o>::</span><span class=n>cryptoutils</span><span class=o>-&gt;</span><span class=n>get_range</span><span class=p>(</span><span class=mi>10</span><span class=p>))</span> <span class=p>{</span>
              <span class=k>case</span> <span class=mi>0</span><span class=o>:</span>
                <span class=n>currentI</span><span class=o>-&gt;</span><span class=n>setPredicate</span><span class=p>(</span><span class=n>FCmpInst</span><span class=o>::</span><span class=n>FCMP_OEQ</span><span class=p>);</span>
                <span class=k>break</span><span class=p>;</span> <span class=c1>// ordered and equal
</span><span class=c1></span>              <span class=k>case</span> <span class=mi>1</span><span class=o>:</span>
                <span class=n>currentI</span><span class=o>-&gt;</span><span class=n>setPredicate</span><span class=p>(</span><span class=n>FCmpInst</span><span class=o>::</span><span class=n>FCMP_ONE</span><span class=p>);</span>
                <span class=k>break</span><span class=p>;</span> <span class=c1>// ordered and operands are unequal
</span><span class=c1></span>              <span class=k>case</span> <span class=mi>2</span><span class=o>:</span>
                <span class=n>currentI</span><span class=o>-&gt;</span><span class=n>setPredicate</span><span class=p>(</span><span class=n>FCmpInst</span><span class=o>::</span><span class=n>FCMP_UGT</span><span class=p>);</span>
                <span class=k>break</span><span class=p>;</span> <span class=c1>// unordered or greater than
</span><span class=c1></span>              <span class=k>case</span> <span class=mi>3</span><span class=o>:</span>
                <span class=n>currentI</span><span class=o>-&gt;</span><span class=n>setPredicate</span><span class=p>(</span><span class=n>FCmpInst</span><span class=o>::</span><span class=n>FCMP_UGE</span><span class=p>);</span>
                <span class=k>break</span><span class=p>;</span> <span class=c1>// unordered, or greater than, or equal
</span><span class=c1></span>              <span class=k>case</span> <span class=mi>4</span><span class=o>:</span>
                <span class=n>currentI</span><span class=o>-&gt;</span><span class=n>setPredicate</span><span class=p>(</span><span class=n>FCmpInst</span><span class=o>::</span><span class=n>FCMP_ULT</span><span class=p>);</span>
                <span class=k>break</span><span class=p>;</span> <span class=c1>// unordered or less than
</span><span class=c1></span>              <span class=k>case</span> <span class=mi>5</span><span class=o>:</span>
                <span class=n>currentI</span><span class=o>-&gt;</span><span class=n>setPredicate</span><span class=p>(</span><span class=n>FCmpInst</span><span class=o>::</span><span class=n>FCMP_ULE</span><span class=p>);</span>
                <span class=k>break</span><span class=p>;</span> <span class=c1>// unordered, or less than, or equal
</span><span class=c1></span>              <span class=k>case</span> <span class=mi>6</span><span class=o>:</span>
                <span class=n>currentI</span><span class=o>-&gt;</span><span class=n>setPredicate</span><span class=p>(</span><span class=n>FCmpInst</span><span class=o>::</span><span class=n>FCMP_OGT</span><span class=p>);</span>
                <span class=k>break</span><span class=p>;</span> <span class=c1>// ordered and greater than
</span><span class=c1></span>              <span class=k>case</span> <span class=mi>7</span><span class=o>:</span>
                <span class=n>currentI</span><span class=o>-&gt;</span><span class=n>setPredicate</span><span class=p>(</span><span class=n>FCmpInst</span><span class=o>::</span><span class=n>FCMP_OGE</span><span class=p>);</span>
                <span class=k>break</span><span class=p>;</span> <span class=c1>// ordered and greater than or equal
</span><span class=c1></span>              <span class=k>case</span> <span class=mi>8</span><span class=o>:</span>
                <span class=n>currentI</span><span class=o>-&gt;</span><span class=n>setPredicate</span><span class=p>(</span><span class=n>FCmpInst</span><span class=o>::</span><span class=n>FCMP_OLT</span><span class=p>);</span>
                <span class=k>break</span><span class=p>;</span> <span class=c1>// ordered and less than
</span><span class=c1></span>              <span class=k>case</span> <span class=mi>9</span><span class=o>:</span>
                <span class=n>currentI</span><span class=o>-&gt;</span><span class=n>setPredicate</span><span class=p>(</span><span class=n>FCmpInst</span><span class=o>::</span><span class=n>FCMP_OLE</span><span class=p>);</span>
                <span class=k>break</span><span class=p>;</span> <span class=c1>// ordered or less than, or equal
</span><span class=c1></span>              <span class=p>}</span>
              <span class=k>break</span><span class=p>;</span>
            <span class=p>}</span>
          <span class=p>}</span>
        <span class=p>}</span>
      <span class=p>}</span>
      <span class=k>return</span> <span class=n>alteredBB</span><span class=p>;</span>
    <span class=p>}</span> <span class=c1>// end of createAlteredBasicBlock()
</span></code></pre></td></tr></table>
</div>
</div><p>ä¸»è¦æ˜¯åˆ†ä¸¤éƒ¨åˆ†ï¼š</p>
<ol>
<li>å¤åˆ¶åŸå§‹å—ï¼Œå¹¶ä¿®å¤ä¼ªé€ å—çš„è°ƒè¯•ä¿¡æ¯ä¸å…ƒæ•°æ®</li>
<li>åœ¨ä¼ªé€ å—ä¸­å¯»æ‰¾äºŒå…ƒè¿ç®—ã€æµ®ç‚¹è¿ç®—ã€æ¯”è¾ƒæŒ‡ä»¤ï¼Œåœ¨å…¶ä¸­æ’å…¥åƒåœ¾æŒ‡ä»¤ã€‚</li>
</ol>
<h2 id=0x03-åˆ›å»ºè‡ªå·±çš„æ··æ·†>0x03 åˆ›å»ºè‡ªå·±çš„æ··æ·†</h2>
<p>å¯¹ OLLVM çš„ bcf æ··æ·†æœ‰äº†åˆæ­¥çš„æ˜ åƒä¹‹åï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥ä¾æ ·ç”»è‘«èŠ¦æŠ„ä¸€ä¸ªè‡ªå·±çš„æ··æ·†å‡ºæ¥å•¦ã€‚</p>
<h3 id=31-æ–¹æ¡ˆ>3.1 æ–¹æ¡ˆ</h3>
<p><img src=/p/learning-packer-08/image-20211103105527721.png width=953 height=726 srcset="/p/learning-packer-08/image-20211103105527721_huf9cff02c3a79573b2f021a9808299ab4_137978_480x0_resize_box_3.png 480w, /p/learning-packer-08/image-20211103105527721_huf9cff02c3a79573b2f021a9808299ab4_137978_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20211103105527721 class=gallery-image data-flex-grow=131 data-flex-basis=315px></p>
<p>ä½œä¸ºæ¦‚å¿µéªŒè¯ï¼Œæˆ‘ä»¬çš„ pass å°†åŸå§‹ä»£ç åˆ†å‰²æˆä¸‰ä¸ªåŸºæœ¬å—ï¼Œç§°ä¸º <code>entry</code>ã€<code>original</code>å’Œ<code>terminator</code>ã€‚<code>entry</code> é€šè¿‡ä¸€ä¸ªæ’çœŸåˆ¤æ–­è·³è½¬è‡³ <code>original</code>ï¼Œ<code>original</code> é€šè¿‡æ’çœŸåˆ¤æ–­è·³è½¬è‡³ <code>terminator</code>ã€‚ä¼ªé€ å— <code>altered</code> åˆ™æ˜¯ false åˆ†æ”¯ï¼Œå†…å®¹ä»…å¤åˆ¶ <code>original</code> å—ï¼Œå¹¶åœ¨æœ«å°¾è·³è½¬è‡³ <code>original</code> å—ã€‚</p>
<p>ä¼ªé€ å—åº”è¯¥æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œã€‚</p>
<h3 id=32-llvmç¼–ç¨‹çš„é‡è¦æ¦‚å¿µ>3.2 LLVMç¼–ç¨‹çš„é‡è¦æ¦‚å¿µ</h3>
<p>å‚è€ƒæ–‡ç« ï¼š<a class=link href=https://mukulrathi.com/create-your-own-programming-language/llvm-ir-cpp-api-tutorial/ target=_blank rel=noopener>LLVM IR C++ API Tutorial</a></p>
<h4 id=å…³é”®ç±»å‹>å…³é”®ç±»å‹ï¼š</h4>
<p>æ¸…å•å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>Value</code></li>
<li><code>Module</code></li>
<li><code>Type</code></li>
<li><code>Function</code></li>
<li><code>BasicBlock</code></li>
<li><code>BranchInst</code></li>
</ul>
<p>åˆ—å‡ºçš„è¿™äº›æ˜¯ LLVM C++ æ¥å£å®šä¹‰çš„ç±»ï¼Œå¯ä»¥é€šè¿‡ <code>Module</code> è·å– <code>Function</code>ï¼Œå¯ä»¥ä» <code>Function</code> è·å– <code>BasicBlock</code>ï¼Œä¹Ÿå¯ä»¥ä» <code>BasicBlock</code> åè¿‡æ¥è·å– <code>Function</code>ï¼Œè¿™äº›å®¹å™¨é—´ç»„ç»‡æˆå±‚çº§å…³ç³»ã€‚</p>
<p><code>Module</code>-><code>Function</code>-><code>BasicBlock</code>-><code>Instruction</code></p>
<p><code>Value</code> æ˜¯å…¬å…±åŸºç±»ï¼Œ<code>Function</code>ã€<code>BasicBlock</code>ï¼ŒåŒ…æ‹¬å„ç§æŒ‡ä»¤ç±»éƒ½æ˜¯ä»<code>Value</code>ç»§æ‰¿ã€‚</p>
<h4 id=phinode>PHINodeï¼š</h4>
<p>å‚è€ƒæ–‡ç« ï¼š<a class=link href=http://mayuyu.io/2018/06/04/PhiNode-in-LLVM/ target=_blank rel=noopener>PhiNode in LLVM</a></p>
<p>LLVMçš„æŒ‡ä»¤ç±»å‹ä¸­åŒ…å«ä¸€ç§ç‰¹æ®ŠèŠ‚ç‚¹å« PhiNodeï¼ŒPhiNode çš„å­˜åœ¨æ˜¯ä¸ºäº†è§£å†³ LLVM IR ä¸­å›  SSA ï¼ˆé™æ€å•æ¬¡èµ‹å€¼ï¼‰å¼•èµ·çš„æ¡ä»¶åˆå§‹åŒ–é—®é¢˜ã€‚ç¤ºä¾‹å¦‚ä¸‹ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>int</span> <span class=nf>foooooo</span><span class=p>(</span><span class=kt>int</span> <span class=n>bar</span><span class=p>){</span>
    <span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
    <span class=k>if</span><span class=p>(</span><span class=n>bar</span><span class=o>%</span><span class=mi>2</span><span class=o>==</span><span class=mi>0</span><span class=p>){</span>
        <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span> <span class=c1>//BasicBlock 1
</span><span class=c1></span>    <span class=p>}</span>
    <span class=k>else</span><span class=p>{</span>
        <span class=n>i</span><span class=o>=</span><span class=mi>2</span><span class=p>;</span> <span class=c1>//BasicBlock 2
</span><span class=c1></span>    <span class=p>}</span>
    <span class=k>return</span> <span class=n>i</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬éœ€è¦æŒ‰ <code>bar</code> çš„å–å€¼æ¥åˆå§‹åŒ– <code>i</code>ï¼Œä½† SSA è¦æ±‚ <code>i</code> åªèƒ½è¢«èµ‹å€¼ä¸€æ¬¡ã€‚PhiNode å…è®¸æ ¹æ®åŸºæœ¬å—é€‰æ‹©èµ‹å€¼ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>int</span> <span class=nf>foooooo</span><span class=p>(</span><span class=kt>int</span> <span class=n>bar</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span><span class=p>(</span><span class=n>bar</span><span class=o>%</span><span class=mi>2</span><span class=o>==</span><span class=mi>0</span><span class=p>){</span>
        <span class=c1>//BasicBlock1
</span><span class=c1></span>    <span class=p>}</span>
    <span class=k>else</span><span class=p>{</span>
        <span class=c1>//BasicBlock2
</span><span class=c1></span>    <span class=p>}</span>
    <span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=n>Phi</span><span class=p>([</span><span class=n>BasicBlock1</span><span class=p>,</span><span class=mi>1</span><span class=p>],[</span><span class=n>BasicBlock2</span><span class=p>,</span><span class=mi>2</span><span class=p>]);</span>
    <span class=k>return</span> <span class=n>i</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢çš„ä¾‹å­ä¹Ÿå¯ä»¥æ”¹æˆåœ¨æ ˆæˆ–å †ä¸Šå¼€è¾Ÿç©ºé—´ï¼Œä»¥ç±»ä¼¼æŒ‡é’ˆçš„æ–¹å¼é¿å¼€ SSA çº¦æŸã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>int</span> <span class=nf>foooooo</span><span class=p>(</span><span class=kt>int</span> <span class=n>bar</span><span class=p>)</span> <span class=p>{</span>
    <span class=kt>int</span><span class=o>*</span> <span class=n>i</span><span class=o>=</span><span class=n>malloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=kt>int</span><span class=p>));</span>
    <span class=k>if</span><span class=p>(</span><span class=n>bar</span><span class=o>%</span><span class=mi>2</span><span class=o>==</span><span class=mi>0</span><span class=p>){</span>
        <span class=n>Store</span> <span class=n>Value</span> <span class=mi>1</span> <span class=n>to</span> <span class=n>the</span> <span class=n>memory</span> <span class=n>location</span> <span class=n>pointed</span> <span class=n>to</span> <span class=n>by</span> <span class=n>i</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>else</span><span class=p>{</span>
        <span class=n>Store</span> <span class=n>Value</span> <span class=mi>2</span> <span class=n>to</span> <span class=n>the</span> <span class=n>memory</span> <span class=n>location</span> <span class=n>pointed</span> <span class=n>to</span> <span class=n>by</span> <span class=n>i</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=kt>int</span> <span class=n>j</span><span class=o>=</span><span class=n>load</span> <span class=n>from</span> <span class=n>the</span> <span class=n>address</span> <span class=n>pointed</span> <span class=n>by</span> <span class=n>i</span><span class=p>;</span>
    <span class=k>return</span> <span class=n>j</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id=terminator>Terminator:</h4>
<p>å‚è€ƒæ–‡ç« ï¼š<a class=link href=https://www.quora.com/How-do-Terminators-work-in-the-LLVM-IR target=_blank rel=noopener>How do Terminator work in LLVM IR</a></p>
<p>LLVMä¸­ï¼Œä¸€ä¸ªåŸºæœ¬å— <em>BasicBlock</em> æ€»æ˜¯ä»¥ç»ˆç»“æŒ‡ä»¤ <em>TerminatorInst</em> ç»“æŸçš„ã€‚ç»ˆç»“æŒ‡ä»¤ä¸èƒ½å‡ºç°åœ¨åŸºæœ¬å—æœ«å°¾ä»¥å¤–çš„ä»»ä½•åœ°æ–¹ã€‚ç²—ç•¥åœ°è¯´ï¼Œç»ˆç»“æŒ‡ä»¤æ ‡è¯†æ§åˆ¶æµåœ¨åŸºæœ¬å—ç»“æŸåå»å¾€ä½•æ–¹ã€‚</p>
<p>æ¯ä¸ªç»ˆç»“æŒ‡ä»¤éƒ½åŒ…å«ä¸€å®šçš„åç»§åŸºæœ¬å—ã€‚</p>
<p>å‡ ä¸ªå¸¸è§çš„ç»ˆç»“æŒ‡ä»¤ç±»å‹ï¼š</p>
<ul>
<li>
<p><code>ReturnInst</code> å°±åƒæ˜¯æ™®é€šç¼–ç¨‹ä¸­çš„çš„<code>return</code>è¯­å¥ã€‚</p>
</li>
<li>
<p><code>BranchInst</code> æ˜¯è·³è½¬æŒ‡ä»¤ï¼ŒåŒ…æ‹¬ä¸¤ç±»ï¼š</p>
<ul>
<li>æ¡ä»¶è·³è½¬ï¼Œæ»¡è¶³æ¡ä»¶æ—¶è·³è½¬åˆ†æ”¯1ï¼Œå¦åˆ™è·³è½¬åˆ†æ”¯2ã€‚</li>
<li>éæ¡ä»¶è·³è½¬ï¼Œæ€»æ˜¯è·³è½¬åˆ°æŸä¸ªåˆ†æ”¯ã€‚</li>
</ul>
</li>
<li>
<p><code>SwitchInst</code> ç±»ä¼¼äºæ™®é€šç¼–ç¨‹é‡Œçš„ <code>switch</code> è¯­å¥ï¼Œå¯ä»¥åŒ…å«æ›´å¤šçš„åç»§å—ã€‚</p>
</li>
</ul>
<p>è¿˜æœ‰äº›ä¸é‚£ä¹ˆå¸¸è§çš„ç»ˆç»“æŒ‡ä»¤ï¼š</p>
<ul>
<li><code>invoke</code> å’Œ <code>catchswitch</code></li>
<li><code>unreachable</code></li>
</ul>
<h3 id=33-å·¥å…·é“¾>3.3 å·¥å…·é“¾</h3>
<p>å‚è€ƒæ–‡ç« ï¼š<a class=link href=https://llvm.org/docs/CommandGuide/index.html target=_blank rel=noopener>LLVM Command Guide</a></p>
<p>å®é™…åŠ¨æ‰‹å‰å…ˆäº†è§£ä¸‹ LLVMå·¥å…·é“¾ï¼Œåˆ—å‡ºä¸€äº›ä¼šæ¶‰åŠåˆ°çš„å‘½ä»¤è¡Œå·¥å…·ã€‚</p>
<ul>
<li><code>llc</code> å°†è¾“å…¥çš„ LLVM IR(<code>.ll</code>) ç¼–è¯‘æˆæŒ‡å®šæ¶æ„çš„æ±‡ç¼–ï¼ˆæˆ–äºŒè¿›åˆ¶å¯¹è±¡æ–‡ä»¶ï¼‰</li>
<li><code>lli</code> å°†è¾“å…¥çš„ BitCode(<code>.bc</code>) è§£é‡Šæ‰§è¡Œã€‚</li>
<li><code>llvm-as</code> æ±‡ç¼–å™¨</li>
<li><code>llvm-dis</code> åæ±‡ç¼–å™¨ï¼Œå¯ä»¥åæ±‡ç¼– BitCode</li>
<li><code>opt</code> BITCODE/IR ä¼˜åŒ–å™¨</li>
</ul>
<p>æœ€å¥½å†å®‰è£…ä¸€ä¸ª graphvizï¼Œå› ä¸ºå¾ˆå¤šç¼–ç¨‹è¯­è¨€çš„å‘½ä»¤è¡Œå·¥å…·å¦‚æœæä¾›å›¾å½¢è¾“å‡ºçš„è¯ï¼Œå¤§å¤šæ˜¯ä»¥ dot å½¢å¼æä¾›ï¼ˆæ¯”å¦‚ go çš„ pprof å’Œ LLVM opt çš„ dot-cfgï¼‰ã€‚</p>
<h3 id=33-runonfunction>3.3 runOnFunction</h3>
<p>å‚è€ƒ OLLVM çš„ä»£ç ï¼ŒæŠ„å‡ºè¿‡æ»¤å‡½æ•°ã€‚åŸç†ä¸æ˜æš‚ä¸”ä¸æ·±ç©¶ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=kt>bool</span> <span class=nf>isObfuscateable</span><span class=p>(</span><span class=k>const</span> <span class=n>Function</span> <span class=o>&amp;</span><span class=n>fn</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>fn</span><span class=p>.</span><span class=n>isDeclaration</span><span class=p>())</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nb>false</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>fn</span><span class=p>.</span><span class=n>hasAvailableExternallyLinkage</span><span class=p>())</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nb>false</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isInvoke</span><span class=p>(</span><span class=n>fn</span><span class=p>))</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nb>false</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=nb>true</span><span class=p>;</span>
<span class=p>}</span>

<span class=kt>bool</span> <span class=nf>isInvoke</span><span class=p>(</span><span class=k>const</span> <span class=n>Function</span> <span class=o>&amp;</span><span class=n>fn</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>for</span> <span class=p>(</span><span class=k>const</span> <span class=n>BasicBlock</span> <span class=o>&amp;</span><span class=nl>bb</span> <span class=p>:</span> <span class=n>fn</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>isa</span><span class=o>&lt;</span><span class=n>InvokeInst</span><span class=o>&gt;</span><span class=p>(</span><span class=n>bb</span><span class=p>.</span><span class=n>getTerminator</span><span class=p>()))</span> <span class=p>{</span>
            <span class=k>return</span> <span class=nb>false</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=nb>true</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>ç„¶ååœ¨å…¥å£ç‚¹ç®€å•è¿‡æ»¤æ‰ä¸èƒ½æ··æ·†çš„å‡½æ•°ï¼Œæ¥ç€éå†åŸºæœ¬å—ï¼Œå¯¹æ¯ä¸ªåŸºæœ¬å—éƒ½è¿›è¡Œä¸€æ¬¡æ··æ·†ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=kt>bool</span> <span class=nf>runOnFunction</span><span class=p>(</span><span class=n>Function</span><span class=o>&amp;</span> <span class=n>F</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isObfuscateable</span><span class=p>(</span><span class=n>F</span><span class=p>))</span> <span class=p>{</span>
        <span class=n>errs</span><span class=p>()</span><span class=o>&lt;&lt;</span><span class=s>&#34;function &#34;</span><span class=o>&lt;&lt;</span> <span class=n>F</span><span class=p>.</span><span class=n>getName</span><span class=p>()</span> <span class=o>&lt;&lt;</span><span class=s>&#34; is not obfuscateable</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>;</span>
        <span class=k>return</span> <span class=nb>false</span><span class=p>;</span>
    <span class=p>}</span>
    
    <span class=n>list</span><span class=o>&lt;</span><span class=n>BasicBlock</span> <span class=o>*&gt;</span> <span class=n>blocks</span><span class=p>;</span>
    <span class=k>for</span> <span class=p>(</span><span class=n>BasicBlock</span> <span class=o>&amp;</span><span class=nl>block</span> <span class=p>:</span> <span class=n>F</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>blocks</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=o>&amp;</span><span class=n>block</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>for</span> <span class=p>(</span><span class=n>BasicBlock</span> <span class=o>*</span><span class=nl>block</span> <span class=p>:</span> <span class=n>blocks</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// åŸå§‹å—åˆ†å‰²ä¸ºä¸‰ä¸ªåŸºæœ¬å—ï¼šentryã€originalã€terminator
</span><span class=c1></span>        <span class=c1>// é€šè¿‡ä¸¤ä¸ªæ’çœŸæ¡ä»¶è¿æ¥
</span><span class=c1></span>        <span class=k>auto</span> <span class=n>entryBB</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>block</span><span class=p>;</span>
        <span class=k>auto</span> <span class=n>originalBB</span> <span class=o>=</span> <span class=n>entryBB</span><span class=o>-&gt;</span><span class=n>splitBasicBlock</span><span class=p>(</span><span class=n>entryBB</span><span class=o>-&gt;</span><span class=n>getFirstNonPHIOrDbgOrLifetime</span><span class=p>(),</span> <span class=n>Twine</span><span class=p>(</span><span class=s>&#34;original&#34;</span><span class=p>));</span>
        <span class=k>auto</span> <span class=n>terminatorBB</span> <span class=o>=</span> <span class=n>originalBB</span><span class=o>-&gt;</span><span class=n>splitBasicBlock</span><span class=p>(</span><span class=o>--</span><span class=n>originalBB</span><span class=o>-&gt;</span><span class=n>end</span><span class=p>(),</span> <span class=n>Twine</span><span class=p>(</span><span class=s>&#34;terminator&#34;</span><span class=p>));</span>

        <span class=c1>// æ„é€ ä¼ªé€ å—
</span><span class=c1></span>        <span class=c1>// è¿™ä¸€æ­¥å·²ç»æ„é€ å¥½äº† altered è·³è½¬ original
</span><span class=c1></span>        <span class=k>auto</span> <span class=n>alteredBB</span> <span class=o>=</span> <span class=n>createAlteredBB</span><span class=p>(</span><span class=n>originalBB</span><span class=p>,</span> <span class=n>F</span><span class=p>);</span>

        <span class=c1>// æ¸…ç† terminatorï¼Œé‡æ–°æ„é€ è·³è½¬å…³ç³»
</span><span class=c1></span>        <span class=n>entryBB</span><span class=o>-&gt;</span><span class=n>getTerminator</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>eraseFromParent</span><span class=p>();</span>
        <span class=n>originalBB</span><span class=o>-&gt;</span><span class=n>getTerminator</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>eraseFromParent</span><span class=p>();</span>

        <span class=c1>// æ„é€ æ’çœŸæ¡ä»¶ï¼Œä» entry è·³è½¬åˆ° original
</span><span class=c1></span>        <span class=k>auto</span> <span class=n>lhs</span> <span class=o>=</span> <span class=n>ConstantInt</span><span class=o>::</span><span class=n>get</span><span class=p>(</span><span class=n>Type</span><span class=o>::</span><span class=n>getInt32Ty</span><span class=p>(</span><span class=n>F</span><span class=p>.</span><span class=n>getContext</span><span class=p>()),</span> <span class=mi>1</span><span class=p>);</span>
        <span class=k>auto</span> <span class=n>rhs</span> <span class=o>=</span> <span class=n>ConstantInt</span><span class=o>::</span><span class=n>get</span><span class=p>(</span><span class=n>Type</span><span class=o>::</span><span class=n>getInt32Ty</span><span class=p>(</span><span class=n>F</span><span class=p>.</span><span class=n>getContext</span><span class=p>()),</span> <span class=mi>1</span><span class=p>);</span>
        <span class=k>auto</span> <span class=n>condition</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ICmpInst</span><span class=p>(</span><span class=o>*</span><span class=n>entryBB</span><span class=p>,</span> <span class=n>ICmpInst</span><span class=o>::</span><span class=n>ICMP_EQ</span><span class=p>,</span> <span class=n>lhs</span><span class=p>,</span> <span class=n>rhs</span><span class=p>,</span> <span class=n>Twine</span><span class=p>(</span><span class=s>&#34;condition&#34;</span><span class=p>));</span>
        <span class=n>BranchInst</span><span class=o>::</span><span class=n>Create</span><span class=p>(</span><span class=n>originalBB</span><span class=p>,</span> <span class=n>alteredBB</span><span class=p>,</span> <span class=p>(</span><span class=n>Value</span> <span class=o>*</span><span class=p>)</span><span class=n>condition</span><span class=p>,</span> <span class=n>entryBB</span><span class=p>);</span>

        <span class=c1>// æ„é€ æ’çœŸæ¡ä»¶ï¼Œä» original è·³è½¬åˆ° terminator
</span><span class=c1></span>        <span class=k>auto</span> <span class=n>lhs2</span> <span class=o>=</span> <span class=n>ConstantInt</span><span class=o>::</span><span class=n>get</span><span class=p>(</span><span class=n>Type</span><span class=o>::</span><span class=n>getInt32Ty</span><span class=p>(</span><span class=n>F</span><span class=p>.</span><span class=n>getContext</span><span class=p>()),</span> <span class=mi>1</span><span class=p>);</span>
        <span class=k>auto</span> <span class=n>rhs2</span> <span class=o>=</span> <span class=n>ConstantInt</span><span class=o>::</span><span class=n>get</span><span class=p>(</span><span class=n>Type</span><span class=o>::</span><span class=n>getInt32Ty</span><span class=p>(</span><span class=n>F</span><span class=p>.</span><span class=n>getContext</span><span class=p>()),</span> <span class=mi>1</span><span class=p>);</span>
        <span class=k>auto</span> <span class=n>condition2</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ICmpInst</span><span class=p>(</span><span class=o>*</span><span class=n>originalBB</span><span class=p>,</span> <span class=n>ICmpInst</span><span class=o>::</span><span class=n>ICMP_EQ</span><span class=p>,</span> <span class=n>lhs</span><span class=p>,</span> <span class=n>rhs</span><span class=p>,</span> <span class=n>Twine</span><span class=p>(</span><span class=s>&#34;condition2&#34;</span><span class=p>));</span>
        <span class=n>BranchInst</span><span class=o>::</span><span class=n>Create</span><span class=p>(</span><span class=n>terminatorBB</span><span class=p>,</span> <span class=n>alteredBB</span><span class=p>,</span> <span class=p>(</span><span class=n>Value</span> <span class=o>*</span><span class=p>)</span><span class=n>condition</span><span class=p>,</span> <span class=n>originalBB</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=nb>false</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>æ··æ·†è¿‡ç¨‹éå¸¸ç®€å•ï¼ŒåŸå§‹åŸºæœ¬å—åˆ†å‰²æˆä¸‰ä¸ªéƒ¨åˆ†ï¼Œæ¸…é™¤<code>entry</code>å’Œ<code>original</code>çš„<code>terminator</code>å¹¶åŠ å…¥æ’çœŸæ¡ä»¶è·³è½¬ï¼Œfalse åˆ†æ”¯éƒ½æŒ‡å®šä¸º <code>altered</code> å³å¯ã€‚</p>
<h3 id=34-createalteredbb>3.4 createAlteredBB</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=n>BasicBlock</span> <span class=o>*</span><span class=nf>createAlteredBB</span><span class=p>(</span><span class=n>BasicBlock</span> <span class=o>*</span><span class=n>original</span><span class=p>,</span> <span class=n>Function</span> <span class=o>&amp;</span><span class=n>F</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// æ„é€ ä¼ªé€ å—
</span><span class=c1></span>    <span class=n>ValueToValueMapTy</span> <span class=n>VMap</span><span class=p>;</span>
    <span class=k>auto</span> <span class=n>altered</span> <span class=o>=</span> <span class=n>CloneBasicBlock</span><span class=p>(</span><span class=n>original</span><span class=p>,</span> <span class=n>VMap</span><span class=p>,</span> <span class=n>Twine</span><span class=p>(</span><span class=s>&#34;altered&#34;</span><span class=p>),</span> <span class=o>&amp;</span><span class=n>F</span><span class=p>);</span>

    <span class=c1>// ä¿®å¤ä¼ªé€ å—çš„æŒ‡ä»¤
</span><span class=c1></span>    <span class=k>auto</span> <span class=n>originalInstIt</span> <span class=o>=</span> <span class=n>original</span><span class=o>-&gt;</span><span class=n>begin</span><span class=p>();</span>
    <span class=k>for</span> <span class=p>(</span><span class=k>auto</span> <span class=o>&amp;</span><span class=nl>inst</span> <span class=p>:</span> <span class=o>*</span><span class=n>altered</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// NOTE:
</span><span class=c1></span>        <span class=c1>// å‚è€ƒé“¾æ¥ï¼š https://bbs.pediy.com/thread-266201.htm
</span><span class=c1></span>        <span class=c1>//
</span><span class=c1></span>        <span class=c1>// ... ä½†æ˜¯CloneBasicBlockå‡½æ•°è¿›è¡Œçš„å…‹éš†å¹¶ä¸æ˜¯å®Œå…¨çš„å…‹éš†ï¼Œç¬¬ä¸€ä»–ä¸ä¼šå¯¹æŒ‡ä»¤çš„æ“ä½œæ•°è¿›è¡Œæ›¿æ¢ï¼Œæ¯”å¦‚ï¼š
</span><span class=c1></span>        <span class=c1>//
</span><span class=c1></span>        <span class=c1>// ```
</span><span class=c1></span>        <span class=c1>// orig:
</span><span class=c1></span>        <span class=c1>//   %a = ...
</span><span class=c1></span>        <span class=c1>//   %b = fadd %a, ...
</span><span class=c1></span>        <span class=c1>//
</span><span class=c1></span>        <span class=c1>// clone:
</span><span class=c1></span>        <span class=c1>//   %a.clone = ...
</span><span class=c1></span>        <span class=c1>//   %b.clone = fadd %a, ... ; Note that this references the old %a and
</span><span class=c1></span>        <span class=c1>// not %a.clone!
</span><span class=c1></span>        <span class=c1>// ```
</span><span class=c1></span>        <span class=c1>//
</span><span class=c1></span>        <span class=c1>// åœ¨cloneå‡ºæ¥çš„åŸºæœ¬å—ä¸­ï¼ŒfaddæŒ‡ä»¤çš„æ“ä½œæ•°ä¸æ˜¯%a.cloneï¼Œè€Œæ˜¯%aã€‚
</span><span class=c1></span>        <span class=c1>// æ‰€ä»¥ä¹‹åè¦é€šè¿‡VMapå¯¹æ‰€æœ‰æ“ä½œæ•°è¿›è¡Œæ˜ å°„ï¼Œä½¿å…¶æ¢å¤æ­£å¸¸ï¼š
</span><span class=c1></span>        <span class=c1>//
</span><span class=c1></span>        <span class=k>for</span> <span class=p>(</span><span class=k>auto</span> <span class=n>opi</span> <span class=o>=</span> <span class=n>inst</span><span class=p>.</span><span class=n>op_begin</span><span class=p>();</span> <span class=n>opi</span> <span class=o>!=</span> <span class=n>inst</span><span class=p>.</span><span class=n>op_end</span><span class=p>();</span> <span class=n>opi</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>Value</span> <span class=o>*</span><span class=n>v</span> <span class=o>=</span> <span class=n>MapValue</span><span class=p>(</span><span class=o>*</span><span class=n>opi</span><span class=p>,</span> <span class=n>VMap</span><span class=p>,</span> <span class=n>RF_None</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>v</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                <span class=o>*</span><span class=n>opi</span> <span class=o>=</span> <span class=n>v</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>}</span>

        <span class=c1>// ç¬¬äºŒï¼Œå®ƒä¸ä¼šå¯¹PHI Nodeè¿›è¡Œä»»ä½•å¤„ç†ï¼ŒPHI Nodeçš„å‰é©±å—ä»ç„¶æ˜¯åŸå§‹åŸºæœ¬å—çš„å‰é©±å—ï¼Œ
</span><span class=c1></span>        <span class=c1>// ä½†æ˜¯æ–°å…‹éš†å‡ºæ¥çš„åŸºæœ¬å—å¹¶æ²¡æœ‰ä»»ä½•å‰é©±å—ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å¯¹PHI Nodeçš„å‰é©±å—è¿›è¡Œremapï¼š
</span><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=k>auto</span> <span class=n>pn</span> <span class=o>=</span> <span class=n>dyn_cast</span><span class=o>&lt;</span><span class=n>PHINode</span><span class=o>&gt;</span><span class=p>(</span><span class=o>&amp;</span><span class=n>inst</span><span class=p>))</span> <span class=p>{</span>
            <span class=k>for</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>e</span> <span class=o>=</span> <span class=n>pn</span><span class=o>-&gt;</span><span class=n>getNumIncomingValues</span><span class=p>();</span> <span class=n>j</span> <span class=o>!=</span> <span class=n>e</span><span class=p>;</span> <span class=o>++</span><span class=n>j</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>Value</span> <span class=o>*</span><span class=n>v</span> <span class=o>=</span> <span class=n>MapValue</span><span class=p>(</span><span class=n>pn</span><span class=o>-&gt;</span><span class=n>getIncomingBlock</span><span class=p>(</span><span class=n>j</span><span class=p>),</span> <span class=n>VMap</span><span class=p>,</span> <span class=n>RF_None</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>v</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                    <span class=n>pn</span><span class=o>-&gt;</span><span class=n>setIncomingBlock</span><span class=p>(</span><span class=n>j</span><span class=p>,</span> <span class=n>cast</span><span class=o>&lt;</span><span class=n>BasicBlock</span><span class=o>&gt;</span><span class=p>(</span><span class=n>v</span><span class=p>));</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span>

        <span class=c1>// å…ƒæ•°æ®
</span><span class=c1></span>        <span class=n>SmallVector</span><span class=o>&lt;</span><span class=n>pair</span><span class=o>&lt;</span><span class=kt>unsigned</span><span class=p>,</span> <span class=n>MDNode</span> <span class=o>*&gt;</span><span class=p>,</span> <span class=mi>4</span><span class=o>&gt;</span> <span class=n>MDs</span><span class=p>;</span>
        <span class=n>inst</span><span class=p>.</span><span class=n>getAllMetadata</span><span class=p>(</span><span class=n>MDs</span><span class=p>);</span>

        <span class=c1>// ä¿®å¤è°ƒè¯•
</span><span class=c1></span>        <span class=n>inst</span><span class=p>.</span><span class=n>setDebugLoc</span><span class=p>(</span><span class=n>originalInstIt</span><span class=o>-&gt;</span><span class=n>getDebugLoc</span><span class=p>());</span>
        <span class=o>++</span><span class=n>originalInstIt</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=c1>// æ¸…ç†åŸæ¥çš„ terminatorï¼Œæ— æ¡ä»¶ä» altered è·³è½¬åˆ° original
</span><span class=c1></span>    <span class=n>altered</span><span class=o>-&gt;</span><span class=n>getTerminator</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>eraseFromParent</span><span class=p>();</span>
    <span class=n>BranchInst</span><span class=o>::</span><span class=n>Create</span><span class=p>(</span><span class=n>original</span><span class=p>,</span> <span class=n>altered</span><span class=p>);</span>

    <span class=k>return</span> <span class=n>altered</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>å»é™¤ä¿®å¤æŒ‡ä»¤æ“ä½œæ•°å’Œ PhiNode çš„éƒ¨åˆ†ï¼Œå…¶å®å°±æ˜¯å¤åˆ¶äº†åŸå§‹å—çš„æŒ‡ä»¤ï¼Œç„¶åå°†ç»ˆç»“æŒ‡ä»¤æ”¹æˆè·³è½¬åˆ°åŸå§‹å—è€Œå·²ã€‚</p>
<h3 id=35-ç¼–è¯‘å’Œæµ‹è¯•>3.5 ç¼–è¯‘å’Œæµ‹è¯•</h3>
<p>ä½¿ç”¨ CMake ç¼–è¯‘ï¼Œåœ¨ç¯å¢ƒè®¾ç½®ä¸€èŠ‚ä¸­å·²ç»è¯´æ˜äº†æ€ä¹ˆé…ç½®ï¼Œç¼–è¯‘å¾—åˆ°äº† <code>Hello.dll</code> åç”¨ä¸‹é¢çš„æ¡ˆä¾‹ç¨‹åºæµ‹è¯•ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;hello world&#34;</span><span class=p>);</span>
    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>ç¨‹åºä¿å­˜åœ¨ <code>sample/sample.c</code>ï¼Œæµ‹è¯•å‘½ä»¤å¦‚ä¸‹ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=c1># clang ç¼–è¯‘å¾—åˆ° bitcode</span>
clang -emit-llvm .<span class=se>\s</span>ample<span class=se>\s</span>ample.c -c -o .<span class=se>\s</span>ample<span class=se>\s</span>ample.bc
<span class=c1># opt å¯ç”¨ hello pass åˆ›å»ºæ··æ·†åçš„æ–° bitcode</span>
opt -enable-new-pm<span class=o>=</span><span class=m>0</span> -load .<span class=se>\b</span>uild<span class=se>\H</span>ello.dll -hello .<span class=se>\s</span>ample<span class=se>\s</span>ample.bc -o .<span class=se>\s</span>ample<span class=se>\s</span>ample-optimized.bc
<span class=c1># llvm-dis åæ±‡ç¼–æ··æ·†åçš„ bitcodeï¼Œå¾—åˆ° sample-optimized.ll ï¼Œå¯ä»¥æ‹¿æ¥çœ‹æ··æ·†ç»“æœ</span>
llvm-dis .<span class=se>\s</span>ample<span class=se>\s</span>ample-optimized.bc
<span class=c1># llc å°†æ··æ·†åçš„ bitcode ç¼–è¯‘å‡ºæ±‡ç¼–æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ç¼–è¯‘å‡º obj æ–‡ä»¶ï¼Œç”¨ -filetype=obj å°±è¡Œ</span>
<span class=c1># æ³¨æ„ -O0ï¼Œä¸ç„¶é»˜è®¤ä¼˜åŒ–å°±ä¼šç›´æ¥æŠŠæˆ‘ä»¬ä¼ªé€ çš„åˆ†æ”¯ç»™å¹²æ‰</span>
llc .<span class=se>\s</span>ample<span class=se>\s</span>ample-optimized.bc -O0 -o .<span class=se>\s</span>ample.s
<span class=c1># ç”¨ clang å®Œæˆæœ€åçš„æ±‡ç¼–å’Œé“¾æ¥</span>
clang sample.s -o sample.exe
</code></pre></td></tr></table>
</div>
</div><p>ä¹Ÿå¯ä»¥ç”¨ opt æ¥è·å¾—æ··æ·†åçš„ä»£ç æ§åˆ¶æµè§†å›¾ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>opt -enable-new-pm<span class=o>=</span><span class=m>0</span> -dot-cfg -cfg-func-name<span class=o>=</span>main .<span class=se>\s</span>ample<span class=se>\s</span>ample-optimized.bc
</code></pre></td></tr></table>
</div>
</div><p><img src=/p/learning-packer-08/main.png width=755 height=555 srcset="/p/learning-packer-08/main_hu9fb641053a057b276abc5a630d791922_51045_480x0_resize_box_3.png 480w, /p/learning-packer-08/main_hu9fb641053a057b276abc5a630d791922_51045_1024x0_resize_box_3.png 1024w" loading=lazy alt=main class=gallery-image data-flex-grow=136 data-flex-basis=326px></p>
<p>åœ¨IDAæ‰“å¼€åçœ‹åˆ°çš„ç»“æœå¦‚ä¸‹ã€‚</p>
<p><img src=/p/learning-packer-08/image-20211103141258015.png width=370 height=668 srcset="/p/learning-packer-08/image-20211103141258015_hu6b9a1833094321916938f7c8374d48d6_60703_480x0_resize_box_3.png 480w, /p/learning-packer-08/image-20211103141258015_hu6b9a1833094321916938f7c8374d48d6_60703_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20211103141258015 class=gallery-image data-flex-grow=55 data-flex-basis=132px></p>
<p>å†æ¥ä¸ªæ›´å¤æ‚çš„ä¾‹å­ï¼š<a class=link href=https://github.com/nnnewb/crackmes/blob/main/cm02/main.c target=_blank rel=noopener>main.c</a></p>
<p><img src=/p/learning-packer-08/image-20211103142352174.png width=314 height=638 srcset="/p/learning-packer-08/image-20211103142352174_hu6e7d17f0f44390d3241deebec431bcff_8522_480x0_resize_box_3.png 480w, /p/learning-packer-08/image-20211103142352174_hu6e7d17f0f44390d3241deebec431bcff_8522_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20211103142352174 class=gallery-image data-flex-grow=49 data-flex-basis=118px></p>
<h3 id=36-æ‰©å±•ä¸é€æ˜è°“è¯>3.6 æ‰©å±•ï¼šä¸é€æ˜è°“è¯</h3>
<p>å‚è€ƒæ–‡ç« ï¼š<a class=link href=https://reverseengineering.stackexchange.com/questions/1669/what-is-an-opaque-predicate target=_blank rel=noopener>what is an opaque predicate</a></p>
<p>PSï¼šæœ¬äººæ²¡æœ‰ç›¸å…³å­¦æœ¯èƒŒæ™¯ï¼Œå†…å®¹ä¸œæ‹¼è¥¿å‡‘ï¼Œå¦‚æœå­˜åœ¨ç†è§£é”™è¯¯æˆ–è€…é™ˆè¿°ä¸å‡†ç¡®è¯·æŒ‡å‡ºã€‚</p>
<p>æ¦‚æ‹¬åœ°è¯´ï¼Œä¸é€æ˜è°“è¯å°±æ˜¯â€œæŸç§å¦‚æœç¨‹åºåˆ†æä¸å¤Ÿå……åˆ†ï¼Œå°±å¯èƒ½é”™è¿‡çš„ä¸œè¥¿â€ã€‚å­¦æœ¯ä¸Šè¯´ä¸é€æ˜è°“è¯æ˜¯å§‹ç»ˆåœ¨ä¸€ä¸ªæ–¹å‘ä¸Šæ‰§è¡Œçš„åˆ†æ”¯ï¼Œå¯¹ç¨‹åºåˆ›å»ºè€…å·²çŸ¥ï¼Œå¯¹åˆ†æå™¨æœªçŸ¥ã€‚</p>
<p>ä¾‹å¦‚æˆ‘ä»¬çŸ¥é“ç¨‹åºè¿è¡Œæ—¶ï¼Œ<code>LoadLibraryA</code> åŠ è½½ä¸€ä¸ªä¸å­˜åœ¨çš„åº“ä¼šè¿”å› <code>null</code>ï¼Œä½†åˆ†æå™¨å¹¶ä¸æ¸…æ¥šæˆ‘ä»¬è¿è¡Œçš„ç¯å¢ƒé‡Œæ˜¯å¦çœŸçš„å­˜åœ¨/ä¸å­˜åœ¨è¿™ä¸ªåº“ï¼Œå¯¹äºåˆ†æå™¨æ¥è¯´ç”¨<code>LoadLibraryA</code>æ„é€ å‡ºæ¥çš„æ¡ä»¶è·³è½¬å°±æ˜¯ä¸€ä¸ªä¸é€æ˜è°“è¯ã€‚</p>
<p>é‚£é€æ˜å‘¢ï¼Ÿä¸çŸ¥é“æœ‰æ²¡æœ‰è¿™æ ·çš„è¯´æ³•ï¼Œä¸é€æ˜æ˜¯åˆ†æå™¨å¯èƒ½é”™è¿‡çš„ä¸œè¥¿çš„è¯ï¼Œé€æ˜å°±æ˜¯åˆ†æå™¨ä¸ä¼šé”™è¿‡çš„ä¸œè¥¿ï¼Œæ¯”å¦‚ <code>xor eax,eax</code> å†ç´§è·Ÿç€ <code>test eax,eax</code>ï¼Œé‚£ä¹ˆ<code>jnz</code>çš„èµ°å‘å¯¹åˆ†æå™¨æ¥è¯´å°±æ˜¯å·²çŸ¥çš„â€”â€”é™¤éåˆ†æå™¨æ ¹æœ¬æ²¡è¿™åŠŸèƒ½ã€‚</p>
<h2 id=æ€»ç»“>æ€»ç»“</h2>
<p>é¦–å…ˆæ˜¯å®Œæ•´æ¡ˆä¾‹ä»£ç ï¼š<a class=link href=https://github.com/nnnewb/learning-packer/tree/main/packer8 target=_blank rel=noopener>packer8 - GitHub</a></p>
<p>æ€»ç»“çŸ¥è¯†ç‚¹ï¼š</p>
<ul>
<li>å…³é”®ç±»å‹ï¼š<code>Module</code>ã€<code>Function</code>ã€<code>BasicBlock</code>ã€<code>Instruction</code> &mldr;</li>
<li>PhiNode</li>
<li>ç»ˆç»“æŒ‡ä»¤ï¼Œ<code>BranchInst</code>ã€<code>ReturnInst</code></li>
<li>LLVM å·¥å…·é“¾ï¼š<code>opt</code>ã€<code>llc</code>ã€<code>lli</code>ã€<code>llvm-dis</code></li>
<li>å…³äº new pass manager çš„å‘ï¼š<code>-fno-experimental-new-pass-manager</code>ã€<code>-enable-new-pm=0</code></li>
</ul>
<p>ç”¨ opt å•ç‹¬ææ··æ·†å¾ˆéº»çƒ¦ï¼Œä¹Ÿä¸èƒ½é›†æˆåˆ°å·²æœ‰çš„ cmake/make é¡¹ç›®é‡Œã€‚ç”¨ clang åŠ è½½æ··æ·†å™¨çš„åªéœ€è¦è¿™æ ·ï¼š<code>-Xclang -load -Xclang bcf.dll -fno-experimental-new-pass-manager</code> å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ <code>bcf.dll</code> å‚ä¸æ··æ·†å•¦ã€‚</p>
<p>LLVM 13.x ç‰ˆæœ¬çš„æ–° pass manager å¸¦æ¥äº†å¾ˆå¤šé—®é¢˜ï¼Œä¸»è¦æ˜¯ LLVM çš„æ–‡æ¡£æ²¡å†™æ€ä¹ˆæŠŠ Pass æ³¨å†Œåˆ°æ–°çš„ PM é‡Œï¼Œç»“æœ opt èƒ½è·‘ clang åˆæ²¡è¿è¡Œ pass ï¼Œå°±æœæ¥æœå»èŠ±äº†å¾ˆå¤šæ—¶é—´&mldr;ä¸è¿‡å®é™…åŠ¨æ‰‹å†™è¿‡ä¹‹åä¼šå‘ç° LLVM æ˜¯ä¸ªå¤§å®åº“ï¼Œç‰¹åˆ«é€‚åˆå‘æŒ¥æƒ³è±¡ã€‚Pass æ¥æ‰©å±•ç¼–è¯‘å™¨åŠŸèƒ½è¿˜æ˜¯æŒºæ–¹ä¾¿æ‰©å±•çš„ï¼Œä¹Ÿèƒ½ä¸€çª¥LLVMå†…éƒ¨çš„å¥‡å¦™ä¸–ç•Œã€‚</p>
<p>åŸæœ¬è¿˜æ‰“ç®—çœ‹çœ‹æ§åˆ¶æµæ‰å¹³åŒ–ï¼Œæ¯•ç«ŸOLLVMéƒ½å·²ç»å¼€å§‹çœ‹äº†ï¼Œæ§åˆ¶æµæ‰å¹³åŒ–ä¸çœ‹ä¸€ä¸‹æ„Ÿè§‰æœ‰ç‚¹è¯´ä¸è¿‡å»ã€‚ä½†æ˜¯å®é™…ä¸Šæ‰‹å‘ç°æ²¡è€å¿ƒå†è¯»ä¸€éè¿™ä»£ç äº†=ã€‚=ä¹Ÿè®¸ä¸‹æ¬¡ã€‚OLLVMä»£ç è§£è¯»å¥½åƒæœ‰ä¸å°‘å¸–å­äº†å§ï¼Œä¸çŒ®ä¸‘äº†ã€‚æ§åˆ¶æµæ‰å¹³åŒ–çš„ä»£ç é‡ä¹Ÿä¸æ˜¯å¾ˆå¤šï¼Œæ…¢æ…¢è¯»è¿˜æ˜¯èƒ½æ‹æ¸…æ¥šé€»è¾‘çš„ã€‚</p>
<p>å¦å¤–è¿˜å¯ä»¥å‘æŒ¥æƒ³è±¡ï¼šèƒ½ä¸èƒ½ç”¨ LLVM Pass å¾€ä»£ç é‡Œæ’å…¥èŠ±æŒ‡ä»¤ï¼Ÿ</p>
<p>å‚è€ƒèµ„æ–™ï¼š</p>
<ul>
<li><a class=link href=https://llvm.org/docs/CMake.html#cmake-out-of-source-pass target=_blank rel=noopener>CMake out of source pass - LLVM</a></li>
<li><a class=link href=https://llvm.org/docs/WritingAnLLVMPass.html target=_blank rel=noopener>Writing an LLVM Pass - LLVM</a></li>
<li><a class=link href=https://mukulrathi.com/create-your-own-programming-language/llvm-ir-cpp-api-tutorial/ target=_blank rel=noopener>LLVM IR C++ API Tutorial</a></li>
<li><a class=link href=http://mayuyu.io/2018/06/04/PhiNode-in-LLVM/ target=_blank rel=noopener>PhiNode in LLVM</a></li>
<li><a class=link href=https://www.quora.com/How-do-Terminators-work-in-the-LLVM-IR target=_blank rel=noopener>How do Terminator work in LLVM IR</a></li>
<li><a class=link href=https://llvm.org/docs/CommandGuide/index.html target=_blank rel=noopener>LLVM Command Guide</a></li>
<li><a class=link href=https://bbs.pediy.com/thread-266201.htm target=_blank rel=noopener>OLLVM è™šå‡æ§åˆ¶æµæºç å­¦ä¹ ç¬”è®° - çœ‹é›ªè®ºå›</a></li>
<li><a class=link href=https://github1s.com/0x3f97/ollvm-12.x/blob/HEAD/README.md target=_blank rel=noopener>0x3f97/ollvm-12.x</a></li>
</ul>
</section>
<footer class=article-footer>
<section class=article-tags>
<a href=/tags/%E9%80%86%E5%90%91/>é€†å‘</a>
<a href=/tags/windows/>windows</a>
<a href=/tags/c++/>c++</a>
<a href=/tags/llvm/>llvm</a>
<a href=/tags/%E6%B1%87%E7%BC%96/>æ±‡ç¼–</a>
<a href=/tags/security/>security</a>
<a href=/tags/binary-analysis/>binary-analysis</a>
</section>
<section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
</footer>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css integrity=sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js integrity=sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js integrity=sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.querySelector(`.article-content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script>
</article>
<aside class=related-contents--wrapper>
<h2 class=section-title>ç›¸å…³æ–‡ç« </h2>
<div class=related-contents>
<div class="flex article-list--tile">
<article class=has-image>
<a href=/p/learning-packer-07/>
<div class=article-image>
<img src=/p/learning-packer-07/cover.303a5ee85ad8275c094df5988adf0791_hu8b7651a2bda3b235d3ed49f67a1e20bd_99156_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post åŠ å£³åŸç†07 - èŠ±æŒ‡ä»¤å…¥é—¨" data-key=learning-packer-07 data-hash="md5-MDpe6FrYJ1wJTfWYit8HkQ==">
</div>
<div class=light>
<div class=lamp></div>
</div>
<div class=article-details>
<h2 class=article-title>åŠ å£³åŸç†07 - èŠ±æŒ‡ä»¤å…¥é—¨</h2>
</div>
</a>
</article>
<article class=has-image>
<a href=/p/learning-packer-06/>
<div class=article-image>
<img src=/p/learning-packer-06/cover.303a5ee85ad8275c094df5988adf0791_hu8b7651a2bda3b235d3ed49f67a1e20bd_99156_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post åŠ å£³åŸç†06ï¼šåè°ƒè¯•æŠ€æœ¯å…¥é—¨" data-key=learning-packer-06 data-hash="md5-MDpe6FrYJ1wJTfWYit8HkQ==">
</div>
<div class=light>
<div class=lamp></div>
</div>
<div class=article-details>
<h2 class=article-title>åŠ å£³åŸç†06ï¼šåè°ƒè¯•æŠ€æœ¯å…¥é—¨</h2>
</div>
</a>
</article>
<article class=has-image>
<a href=/p/learning-packer-04-zlib-compression-packer-demo/>
<div class=article-image>
<img src=/p/learning-packer-04-zlib-compression-packer-demo/cover.303a5ee85ad8275c094df5988adf0791_hu8b7651a2bda3b235d3ed49f67a1e20bd_99156_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post åŠ å£³åŸç†04 - zlibå‹ç¼©å£³æ¡ˆä¾‹" data-key=learning-packer-04-zlib-compression-packer-demo data-hash="md5-MDpe6FrYJ1wJTfWYit8HkQ==">
</div>
<div class=light>
<div class=lamp></div>
</div>
<div class=article-details>
<h2 class=article-title>åŠ å£³åŸç†04 - zlibå‹ç¼©å£³æ¡ˆä¾‹</h2>
</div>
</a>
</article>
<article class=has-image>
<a href=/p/learning-packer-03-support-no-relocations/>
<div class=article-image>
<img src=/p/learning-packer-03-support-no-relocations/cover.303a5ee85ad8275c094df5988adf0791_hu8b7651a2bda3b235d3ed49f67a1e20bd_99156_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post åŠ å£³åŸç†03 - æ”¯æŒæ²¡æœ‰é‡å®šä½çš„ç¨‹åº" data-key=learning-packer-03-support-no-relocations data-hash="md5-MDpe6FrYJ1wJTfWYit8HkQ==">
</div>
<div class=light>
<div class=lamp></div>
</div>
<div class=article-details>
<h2 class=article-title>åŠ å£³åŸç†03 - æ”¯æŒæ²¡æœ‰é‡å®šä½çš„ç¨‹åº</h2>
</div>
</a>
</article>
<article class=has-image>
<a href=/p/learning-packer-05/>
<div class=article-image>
<img src=/p/learning-packer-05/cover.303a5ee85ad8275c094df5988adf0791_hu8b7651a2bda3b235d3ed49f67a1e20bd_99156_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post åŠ å£³åŸç†05ï¼šåˆ©ç”¨å›¾ç‰‡éšè—" data-key=learning-packer-05 data-hash="md5-MDpe6FrYJ1wJTfWYit8HkQ==">
</div>
<div class=light>
<div class=lamp></div>
</div>
<div class=article-details>
<h2 class=article-title>åŠ å£³åŸç†05ï¼šåˆ©ç”¨å›¾ç‰‡éšè—</h2>
</div>
</a>
</article>
</div>
</div>
</aside>
<footer class=site-footer>
<section class=copyright>
&copy;
2021 -
2024 weakptr's ç¬”è®°
</section>
<section class=powerby>
<a href=https://beian.miit.gov.cn/>æµ™ICPå¤‡2021032371å·-1</a>
<span style=margin-left:16px></span>
<a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=33032402002231" style=display:inline-block;text-decoration:none;height:20px;line-height:20px>
<img src=/blog/image/beian.png style=float:left>
æµ™å…¬ç½‘å®‰å¤‡ 33032402002231å·
</a>
<br>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
ä¸»é¢˜ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.11.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è®¾è®¡
ï¼Œç”± <a href=https://nnnewb.github.io/blog/>nnnewb</a> ä¿®æ”¹
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main>
<aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div>
<h2 class="widget-title section-title">ç›®å½•</h2>
<div class=widget--toc>
<nav id=TableOfContents>
<ol>
<li><a href=#å‰è¨€>å‰è¨€</a></li>
<li><a href=#0x01-ç¯å¢ƒè®¾ç½®>0x01 ç¯å¢ƒè®¾ç½®</a></li>
<li><a href=#0x02-ollvm-bcf-æ··æ·†åˆçª¥>0x02 OLLVM bcf æ··æ·†åˆçª¥</a>
<ol>
<li><a href=#21-runonfunction>2.1 runOnFunction</a></li>
<li><a href=#22-bogus>2.2 bogus</a></li>
<li><a href=#22-addbogusflow>2.2 addBogusFlow</a></li>
<li><a href=#23-createalteredbasicblock>2.3 createAlteredBasicBlock</a></li>
</ol>
</li>
<li><a href=#0x03-åˆ›å»ºè‡ªå·±çš„æ··æ·†>0x03 åˆ›å»ºè‡ªå·±çš„æ··æ·†</a>
<ol>
<li><a href=#31-æ–¹æ¡ˆ>3.1 æ–¹æ¡ˆ</a></li>
<li><a href=#32-llvmç¼–ç¨‹çš„é‡è¦æ¦‚å¿µ>3.2 LLVMç¼–ç¨‹çš„é‡è¦æ¦‚å¿µ</a>
<ol>
<li><a href=#å…³é”®ç±»å‹>å…³é”®ç±»å‹ï¼š</a></li>
<li><a href=#phinode>PHINodeï¼š</a></li>
<li><a href=#terminator>Terminator:</a></li>
</ol>
</li>
<li><a href=#33-å·¥å…·é“¾>3.3 å·¥å…·é“¾</a></li>
<li><a href=#33-runonfunction>3.3 runOnFunction</a></li>
<li><a href=#34-createalteredbb>3.4 createAlteredBB</a></li>
<li><a href=#35-ç¼–è¯‘å’Œæµ‹è¯•>3.5 ç¼–è¯‘å’Œæµ‹è¯•</a></li>
<li><a href=#36-æ‰©å±•ä¸é€æ˜è°“è¯>3.6 æ‰©å±•ï¼šä¸é€æ˜è°“è¯</a></li>
</ol>
</li>
<li><a href=#æ€»ç»“>æ€»ç»“</a></li>
</ol>
</nav>
</div>
</section>
</aside>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>