<!doctype html><html lang=zh-cn dir=ltr>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="å‰è¨€ è·ç¦»ä¸Šä¸€ç¯‡åŠ å£³åŸç†å·²ç»è¿‡å»æŒºä¹…äº†ï¼Œè¿™æ®µæ—¶é—´ç¨å¾®æŠ˜è…¾äº†ä¸€ä¸‹ nasmï¼Œå°è¯•æ‰‹å·¥åˆ¶ä½œäº† PE32 æ–‡ä»¶ï¼Œç§¯ç´¯äº†ä¸€äº›åŸºæœ¬çš„çŸ¥è¯†å§ã€‚ æ‰€ä»¥ç°åœ¨ç»§ç»­å­¦ä¹ åŠ å£³â€”â€”"><title>åŠ å£³åŸç†03 - æ”¯æŒæ²¡æœ‰é‡å®šä½çš„ç¨‹åº</title>
<link rel=canonical href=https://nnnewb.github.io/blog/p/learning-packer-03-support-no-relocations/>
<link rel=stylesheet href=/blog/scss/style.min.5c88a5bc75732c20b0a5ccc3be5c148f782b1c20e20b6c73b276723850a33d6b.css><script src=https://unpkg.com/dayjs@1.8.21/dayjs.min.js></script>
<script src=https://unpkg.com/dayjs@1.8.21/plugin/relativeTime.js></script>
<script src=https://unpkg.com/dayjs@1.8.21/locale/zh-cn.js></script>
<script>dayjs.locale('zh-cn'),dayjs.extend(dayjs_plugin_relativeTime)</script><meta property="og:title" content="åŠ å£³åŸç†03 - æ”¯æŒæ²¡æœ‰é‡å®šä½çš„ç¨‹åº">
<meta property="og:description" content="å‰è¨€ è·ç¦»ä¸Šä¸€ç¯‡åŠ å£³åŸç†å·²ç»è¿‡å»æŒºä¹…äº†ï¼Œè¿™æ®µæ—¶é—´ç¨å¾®æŠ˜è…¾äº†ä¸€ä¸‹ nasmï¼Œå°è¯•æ‰‹å·¥åˆ¶ä½œäº† PE32 æ–‡ä»¶ï¼Œç§¯ç´¯äº†ä¸€äº›åŸºæœ¬çš„çŸ¥è¯†å§ã€‚ æ‰€ä»¥ç°åœ¨ç»§ç»­å­¦ä¹ åŠ å£³â€”â€”">
<meta property="og:url" content="https://nnnewb.github.io/blog/p/learning-packer-03-support-no-relocations/">
<meta property="og:site_name" content="weakptr's ç¬”è®°">
<meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="é€†å‘"><meta property="article:tag" content="c++"><meta property="article:tag" content="python"><meta property="article:tag" content="æ±‡ç¼–"><meta property="article:tag" content="windows"><meta property="article:published_time" content="2021-10-20T10:25:00+08:00"><meta property="article:modified_time" content="2021-10-20T10:25:00+08:00"><meta property="og:image" content="https://nnnewb.github.io/blog/p/learning-packer-03-support-no-relocations/cover.jpg">
<meta name=twitter:title content="åŠ å£³åŸç†03 - æ”¯æŒæ²¡æœ‰é‡å®šä½çš„ç¨‹åº">
<meta name=twitter:description content="å‰è¨€ è·ç¦»ä¸Šä¸€ç¯‡åŠ å£³åŸç†å·²ç»è¿‡å»æŒºä¹…äº†ï¼Œè¿™æ®µæ—¶é—´ç¨å¾®æŠ˜è…¾äº†ä¸€ä¸‹ nasmï¼Œå°è¯•æ‰‹å·¥åˆ¶ä½œäº† PE32 æ–‡ä»¶ï¼Œç§¯ç´¯äº†ä¸€äº›åŸºæœ¬çš„çŸ¥è¯†å§ã€‚ æ‰€ä»¥ç°åœ¨ç»§ç»­å­¦ä¹ åŠ å£³â€”â€”"><meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://nnnewb.github.io/blog/p/learning-packer-03-support-no-relocations/cover.jpg">
</head>
<body class=article-page>
<script>(function(){const a='StackColorScheme';localStorage.getItem(a)||localStorage.setItem(a,"dark")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky">
<button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box>
<span class=hamburger-inner></span>
</span>
</button>
<header>
<figure class=site-avatar>
<a href=/blog>
<img src=/blog/img/avatar_hub37949326d1692892aa1e64434c0dda6_382115_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a>
<span class=emoji>ğŸ‘</span>
</figure>
<div class=site-meta>
<h1 class=site-name><a href=/blog>weakptr's ç¬”è®°</a></h1>
<h2 class=site-description>å¼ƒèˆ¹ï¼</h2>
</div>
</header><ol class=social-menu>
<li>
<a href=https://github.com/nnnewb/ target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg>
</a>
</li>
</ol><ol class=menu id=main-menu>
<li>
<a href=/blog><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>é¦–é¡µ</span>
</a>
</li>
<li>
<a href=/blog/about><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>å…³äºæˆ‘</span>
</a>
</li>
<li>
<a href=/blog/archive><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>å½’æ¡£</span>
</a>
</li>
<li>
<a href=/blog/categories><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
<span>åˆ†ç±»</span>
</a>
</li>
<li>
<a href=/blog/link><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>å‹é“¾</span>
</a>
</li>
<li>
<a href=/blog/search><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>æœç´¢</span>
</a>
</li>
<div class=menu-bottom-section>
<li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>æš—è‰²æ¨¡å¼</span>
</li>
</div>
</ol>
</aside>
<main class="main full-width">
<article class="has-image main-article">
<header class=article-header>
<div class=article-image>
<a href=/blog/p/learning-packer-03-support-no-relocations/>
<img src=/blog/p/learning-packer-03-support-no-relocations/cover_hu8b7651a2bda3b235d3ed49f67a1e20bd_99156_800x0_resize_q75_box.jpg srcset="/blog/p/learning-packer-03-support-no-relocations/cover_hu8b7651a2bda3b235d3ed49f67a1e20bd_99156_800x0_resize_q75_box.jpg 800w, /blog/p/learning-packer-03-support-no-relocations/cover_hu8b7651a2bda3b235d3ed49f67a1e20bd_99156_1600x0_resize_q75_box.jpg 1600w" width=800 height=390 loading=lazy alt="Featured image of post åŠ å£³åŸç†03 - æ”¯æŒæ²¡æœ‰é‡å®šä½çš„ç¨‹åº">
</a>
</div>
<div class=article-details>
<header class=article-category>
<a href=/blog/categories/%E9%80%86%E5%90%91/>
é€†å‘
</a>
</header>
<div class=article-title-wrapper>
<h2 class=article-title>
<a href=/blog/p/learning-packer-03-support-no-relocations/>åŠ å£³åŸç†03 - æ”¯æŒæ²¡æœ‰é‡å®šä½çš„ç¨‹åº</a>
</h2>
</div>
<footer class=article-time>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2021-10-20T10:25:00+08:00>2021å¹´ 10æœˆ 20æ—¥</time>
</div>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>
é˜…è¯»æ—¶é•¿: 9 åˆ†é’Ÿ
</time>
</div>
</footer>
</div>
</header>
<section class=article-content>
<h2 id=å‰è¨€>å‰è¨€</h2>
<p>è·ç¦»ä¸Šä¸€ç¯‡åŠ å£³åŸç†å·²ç»è¿‡å»æŒºä¹…äº†ï¼Œè¿™æ®µæ—¶é—´ç¨å¾®æŠ˜è…¾äº†ä¸€ä¸‹ nasmï¼Œå°è¯•æ‰‹å·¥åˆ¶ä½œäº† PE32 æ–‡ä»¶ï¼Œç§¯ç´¯äº†ä¸€äº›åŸºæœ¬çš„çŸ¥è¯†å§ã€‚</p>
<p>æ‰€ä»¥ç°åœ¨ç»§ç»­å­¦ä¹ åŠ å£³â€”â€”å¦‚ä½•å¯¹ä¸æ”¯æŒ ASLR çš„ PE32 ç¨‹åºè¿›è¡ŒåŠ å£³ï¼Ÿ</p>
<h2 id=0x01-å…³äºaslr>0x01 å…³äºASLR</h2>
<p>ASLRæ˜¯ä¸€é¡¹å†…å­˜ä¿æŠ¤æŠ€æœ¯ï¼Œç”¨äºé˜²èŒƒå†…å­˜æŸåæ¼æ´ï¼Œæ¯”å¦‚ç¼“å†²åŒºæº¢å‡ºã€‚éœ€è¦æ³¨æ„çš„æ˜¯ ASLR å¹¶ä¸æ˜¯ <em>è§£å†³</em> äº†ç›¸å…³å¨èƒï¼Œè€Œæ˜¯è®©åˆ©ç”¨ç›¸å…³çš„æ¼æ´å˜å¾—æ›´åŠ å›°éš¾å’Œå…·æœ‰æŒ‘æˆ˜æ€§ã€‚</p>
<p>ASLR çš„å…¨åæ˜¯ <em>Address Space Layout Randomization</em> ï¼Œåœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–æŠ€æœ¯ã€‚ä¸€ä¸ªå…¸å‹çš„ PE32 ç¨‹åºåœ¨æ²¡æœ‰ ASLR æ”¯æŒçš„æƒ…å†µä¸‹ï¼Œ åœ°å€ç©ºé—´å¸ƒå±€æ˜¯ç¡®å®šçš„ï¼šç¨‹åºé•œåƒæ€»ä¼šåŠ è½½åˆ°å›ºå®šçš„åœ°å€ã€‚è¿™ä¸ªåœ°å€ä¼šåœ¨æ–‡ä»¶å¤´é‡ŒæŒ‡å®šã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‰¹ç‚¹æ¥æ„é€ æ¶æ„æ•°æ®ï¼Œè®©å­˜åœ¨å†…å­˜æŸåæ¼æ´çš„ç¨‹åºæŒ‰æ”»å‡»è€…æ„å›¾è·³è¿‡æˆ–æ‰§è¡Œç‰¹å®šé€»è¾‘ï¼Œé€ æˆå®‰å…¨å¨èƒã€‚</p>
<p>å¯¹åº” ASLR çš„åœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–ï¼Œç¨‹åºéœ€è¦å†æ¬¡ç¼–è¯‘æ¥æ”¯æŒé‡å®šä½ <em>Relocation</em> ï¼Œåˆ«æ— ä»–æ³•ï¼ˆå¤§æ¦‚ï¼‰ã€‚</p>
<h2 id=0x02-æ€è·¯>0x02 æ€è·¯</h2>
<p>å¯¹äºåŠ å£³ä¸€ä¸ªæ²¡æœ‰é‡å®šä½ï¼Œä¸æ”¯æŒ ASLR çš„ PE32 ç¨‹åºï¼Œå‡è®¾è¿™ä¸ªç¨‹åºçš„åŸºå€æ˜¯ <code>0x04000000</code>ï¼ŒåŸå…ˆçš„ <code>VirtualAlloc</code> æ–¹å¼åˆ†é…å†…å­˜æ˜¯è¡Œä¸é€šçš„ã€‚åŠ å£³åç¨‹åºè‹¥å¼€å¯ ASLRï¼Œåˆ™ <code>0x04000000</code> å¯èƒ½å·²ç»å­˜åœ¨å…¶ä»–æ¨¡å—ï¼Œå¹¶ä¸èƒ½ä¿è¯è¿™ä¸ªåŸºå€å¯ç”¨ã€‚<strong>æ‰€ä»¥åŠ å£³åçš„ç¨‹åºå¿…é¡»ä¹Ÿä½¿ç”¨ <code>0x04000000</code> è¿™ä¸ªåŸºå€ï¼Œè€Œä¸”æ ‡è®°ä¸ºä¸æ”¯æŒ ASLR</strong>ï¼Œé¿å…åŸºå€å·²ç»è¢«å…¶ä»–æ¨¡å—ä½¿ç”¨é€ æˆåŠ è½½å™¨æ— æ³•å·¥ä½œã€‚</p>
<p>å°†åŠ å£³åç¨‹åºçš„åŸºå€è®¾ç½®ä¸ºå›ºå®šçš„ <code>0x04000000</code> åˆä¼šäº§ç”Ÿæ–°çš„é—®é¢˜ï¼šåŠ è½½å™¨çš„ä»£ç æ®µä¸èƒ½æ”¾åœ¨ <code>0x04000000</code> ï¼Œå¦åˆ™åŠ è½½å™¨è¿è¡Œæ—¶å°±ä¼šå‡ºç°è¢«è¢«åŠ è½½çš„ä»£ç è¦†ç›–çš„æƒ…å†µï¼Œå¯¼è‡´ç¨‹åºè·‘é£ã€‚æ‰€ä»¥<strong>ç¼–è¯‘åçš„åŠ è½½å™¨æ‰€æœ‰ Section éƒ½å¿…é¡»æœ‰ä¸€å®šçš„åç§»ï¼Œè¿™ä¸ªåç§»å€¼å°±æ˜¯è¢«åŠ è½½ç¨‹åºçš„ Section å¤§å°ä¹‹å’Œï¼ˆå¯¹é½åï¼‰</strong>ã€‚è€Œå› æ­¤å¤šå‡ºæ¥çš„ç©ºé—´å•ç‹¬åˆ†æˆä¸€ä¸ª Section ï¼Œæ­£å¥½ç”¨æ¥æ”¾è¦åŠ è½½çš„ç¨‹åºã€‚</p>
<p>å¦å¤–ï¼Œè¿˜å¿…é¡»ç¡®è®¤æ–‡ä»¶å¤´å¤§å°æ˜¯å¦ä¸€è‡´ï¼Œå› ä¸º<strong>æˆ‘ä»¬éœ€è¦å°†è¢«åŠ è½½ç¨‹åºçš„æ–‡ä»¶å¤´è¦†ç›–åŠ è½½å™¨çš„æ–‡ä»¶å¤´</strong>ã€‚è€Œ<strong>æœ€å¼€å§‹é¢„ç•™çš„ç©ºé—´å¿…é¡»åˆ†é…ä¸ºä¸€ä¸ª Section</strong>ï¼Œè®© Windows çš„åŠ è½½å™¨èƒ½é¡ºåˆ©åŠ è½½ç¨‹åºè€Œä¸æŠ¥â€œä¸æ˜¯æœ‰æ•ˆçš„Win32ç¨‹åºâ€é”™è¯¯ã€‚</p>
<p>å†…å­˜å¸ƒå±€ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p>
<p><img src=/blog/p/learning-packer-03-support-no-relocations/%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80.png width=1155 height=145 srcset="/blog/p/learning-packer-03-support-no-relocations/%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80_hu26017091af2f4be7bf70029e5d75a3ba_13811_480x0_resize_box_3.png 480w, /blog/p/learning-packer-03-support-no-relocations/%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80_hu26017091af2f4be7bf70029e5d75a3ba_13811_1024x0_resize_box_3.png 1024w" loading=lazy alt=å†…å­˜å¸ƒå±€ class=gallery-image data-flex-grow=796 data-flex-basis=1911px></p>
<p>æ‰€ä»¥åŠ è½½å™¨çš„åŠ è½½æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>å¯»æ‰¾è¢«åŠ è½½çš„ Section ã€‚</li>
<li>å¤åˆ¶æ–‡ä»¶å¤´è¦†ç›–è‡ªå·±çš„æ–‡ä»¶å¤´ã€‚</li>
<li>ä»¥è‡ªå·±çš„åŸºå€ä¸ºè¢«åŠ è½½ç¨‹åºçš„åŸºå€ï¼Œå®ŒæˆåŠ è½½ã€‚</li>
</ol>
<p>åŠ å£³æœºçš„åŠ å£³æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>è§£æè¢«åŠ å£³ç¨‹åºï¼Œè·å– Section å¤§å°ã€æ–‡ä»¶å¤´å¤§å°ã€å¯¹é½å¤§å°ç­‰ä¿¡æ¯ã€‚</li>
<li>ç”ŸæˆåŠ è½½å™¨ç¨‹åºï¼Œæ ¹æ®ä¸Šä¸€æ­¥å–å¾—çš„æ•°æ®è®¡ç®—å‡ºåŠ è½½å™¨ Section çš„åç§»å’Œå¯¹é½ã€‚</li>
<li>åˆå¹¶è¢«åŠ å£³ç¨‹åºå’ŒåŠ è½½å™¨ï¼Œç”Ÿæˆè¢«åŠ å£³ç¨‹åºã€‚</li>
</ol>
<p>æ¡ˆä¾‹ç¨‹åºå¦‚ä¸‹ï¼š</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&lt;Windows.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>MessageBoxA</span><span class=p>(</span><span class=nb>NULL</span><span class=p>,</span> <span class=s>&#34;Hello world!&#34;</span><span class=p>,</span> <span class=s>&#34;MSGBOX&#34;</span><span class=p>,</span> <span class=n>MB_OK</span><span class=p>);</span>
  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id=0x03-åŠ è½½å™¨ä¿®æ”¹>0x03 åŠ è½½å™¨ä¿®æ”¹</h2>
<p>åŠ è½½å™¨éœ€è¦æŠŠ <code>VirtualAlloc</code> æ”¹æˆ <code>GetModuleHandleA</code>ï¼Œå¹¶è§£é™¤å½“å‰ç¨‹åºæ–‡ä»¶å¤´çš„å†™ä¿æŠ¤ï¼Œå¹¶åœ¨éšåçš„å¤åˆ¶ Section é˜¶æ®µåŒæ ·ç”¨ <code>VirtualProtect</code> è§£é™¤å†™ä¿æŠ¤ï¼Œæ·»åŠ æ‰§è¡Œæƒé™ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>void</span> <span class=o>*</span><span class=nf>load_PE</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>PE_data</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>IMAGE_DOS_HEADER</span> <span class=o>*</span><span class=n>p_DOS_header</span> <span class=o>=</span> <span class=p>(</span><span class=n>IMAGE_DOS_HEADER</span> <span class=o>*</span><span class=p>)</span><span class=n>PE_data</span><span class=p>;</span>
  <span class=n>IMAGE_NT_HEADERS</span> <span class=o>*</span><span class=n>p_NT_headers</span> <span class=o>=</span> <span class=p>(</span><span class=n>IMAGE_NT_HEADERS</span> <span class=o>*</span><span class=p>)(</span><span class=n>PE_data</span> <span class=o>+</span> <span class=n>p_DOS_header</span><span class=o>-&gt;</span><span class=n>e_lfanew</span><span class=p>);</span>

  <span class=c1>// extract information from PE header
</span><span class=c1></span>  <span class=n>DWORD</span> <span class=n>size_of_image</span> <span class=o>=</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>OptionalHeader</span><span class=p>.</span><span class=n>SizeOfImage</span><span class=p>;</span>
  <span class=n>DWORD</span> <span class=n>entry_point_RVA</span> <span class=o>=</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>OptionalHeader</span><span class=p>.</span><span class=n>AddressOfEntryPoint</span><span class=p>;</span>
  <span class=n>DWORD</span> <span class=n>size_of_headers</span> <span class=o>=</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>OptionalHeader</span><span class=p>.</span><span class=n>SizeOfHeaders</span><span class=p>;</span>

  <span class=c1>// base address
</span><span class=c1></span>  <span class=kt>char</span> <span class=o>*</span><span class=n>p_image_base</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>GetModuleHandleA</span><span class=p>(</span><span class=nb>NULL</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>p_image_base</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
  <span class=p>}</span>
    
  <span class=c1>// make sure we can write in allocated memory
</span><span class=c1></span>  <span class=n>DWORD</span> <span class=n>oldProtect</span><span class=p>;</span>
  <span class=n>VirtualProtect</span><span class=p>(</span><span class=n>p_image_base</span><span class=p>,</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>OptionalHeader</span><span class=p>.</span><span class=n>SizeOfHeaders</span><span class=p>,</span> <span class=n>PAGE_READWRITE</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>oldProtect</span><span class=p>);</span>

  <span class=c1>// copy PE headers in memory
</span><span class=c1></span>  <span class=n>mymemcpy</span><span class=p>(</span><span class=n>p_image_base</span><span class=p>,</span> <span class=n>PE_data</span><span class=p>,</span> <span class=n>size_of_headers</span><span class=p>);</span>

  <span class=c1>// Section headers starts right after the IMAGE_NT_HEADERS struct, so we do some pointer arithmetic-fu here.
</span><span class=c1></span>  <span class=n>IMAGE_SECTION_HEADER</span> <span class=o>*</span><span class=n>sections</span> <span class=o>=</span> <span class=p>(</span><span class=n>IMAGE_SECTION_HEADER</span> <span class=o>*</span><span class=p>)(</span><span class=n>p_NT_headers</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>

  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>FileHeader</span><span class=p>.</span><span class=n>NumberOfSections</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// calculate the VA we need to copy the content, from the RVA
</span><span class=c1></span>    <span class=c1>// section[i].VirtualAddress is a RVA, mind it
</span><span class=c1></span>    <span class=kt>char</span> <span class=o>*</span><span class=n>dest</span> <span class=o>=</span> <span class=n>p_image_base</span> <span class=o>+</span> <span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>VirtualAddress</span><span class=p>;</span>

    <span class=c1>// check if there is Raw data to copy
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>SizeOfRawData</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
      <span class=c1>// make sure we can write in allocated sections
</span><span class=c1></span>      <span class=n>VirtualProtect</span><span class=p>(</span><span class=n>dest</span><span class=p>,</span> <span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>SizeOfRawData</span><span class=p>,</span> <span class=n>PAGE_READWRITE</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>old_protect</span><span class=p>);</span>
      <span class=c1>// We copy SizeOfRaw data bytes, from the offset PointerToRawData in the file
</span><span class=c1></span>      <span class=n>mymemcpy</span><span class=p>(</span><span class=n>dest</span><span class=p>,</span> <span class=n>PE_data</span> <span class=o>+</span> <span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>PointerToRawData</span><span class=p>,</span> <span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>SizeOfRawData</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
      <span class=n>VirtualProtect</span><span class=p>(</span><span class=n>dest</span><span class=p>,</span> <span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>Misc</span><span class=p>.</span><span class=n>VirtualSize</span><span class=p>,</span> <span class=n>PAGE_READWRITE</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>old_protect</span><span class=p>);</span>
      <span class=k>for</span> <span class=p>(</span><span class=n>size_t</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>Misc</span><span class=p>.</span><span class=n>VirtualSize</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>dest</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>}</span>
    
    <span class=c1>// ...
</span><span class=c1></span><span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>æ­¤å¤–è¿˜æœ‰ä¸€ä¸ªå‘ï¼šä¸çŸ¥é“ä¸ºå•¥ï¼Œæˆ‘ç”¨ lief python ç”Ÿæˆçš„ DataDirectories å®é™…åªæœ‰15ä¸ªå…ƒç´ ï¼ˆåŒ…æ‹¬æœ€åä¸€ä¸ª null å…ƒç´ ï¼‰ï¼Œä½† <code>winnt.h</code> é‡Œå®šä¹‰çš„ DataDirectories æ˜¯å›ºå®šé•¿åº¦ 16 ä¸ªå…ƒç´ ï¼Œæ‰€ä»¥ç›´æ¥ç®— <code>p_NT_header + 1</code> å¾—åˆ°çš„åç§»å€¼ä¼šæ¯”é¢„æœŸçš„å¤§ 8 ä¸ªå­—èŠ‚ï¼Œå¯¼è‡´æŠ¥æ‰¾ä¸åˆ° <code>.packed</code> ã€‚</p>
<p>æ”¹æˆè¿™æ ·ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>int</span> <span class=nf>_start</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
  <span class=kt>char</span> <span class=o>*</span><span class=n>unpacker_VA</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>GetModuleHandleA</span><span class=p>(</span><span class=nb>NULL</span><span class=p>);</span>

  <span class=n>IMAGE_DOS_HEADER</span> <span class=o>*</span><span class=n>p_DOS_header</span> <span class=o>=</span> <span class=p>(</span><span class=n>PIMAGE_DOS_HEADER</span><span class=p>)</span><span class=n>unpacker_VA</span><span class=p>;</span>
  <span class=n>IMAGE_NT_HEADERS</span> <span class=o>*</span><span class=n>p_NT_headers</span> <span class=o>=</span> <span class=p>(</span><span class=n>PIMAGE_NT_HEADERS</span><span class=p>)(</span><span class=n>unpacker_VA</span> <span class=o>+</span> <span class=n>p_DOS_header</span><span class=o>-&gt;</span><span class=n>e_lfanew</span><span class=p>);</span>
  <span class=n>IMAGE_SECTION_HEADER</span> <span class=o>*</span><span class=n>sections</span> <span class=o>=</span> <span class=p>(</span><span class=n>PIMAGE_SECTION_HEADER</span><span class=p>)(</span><span class=n>p_NT_headers</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
  <span class=c1>// æ³¨æ„çœ‹è¿™é‡Œå†è®¡ç®—äº†ä¸€æ¬¡åç§»
</span><span class=c1></span>  <span class=n>sections</span> <span class=o>=</span> <span class=p>(</span><span class=n>PIMAGE_SECTION_HEADER</span><span class=p>)((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>sections</span> <span class=o>-</span> <span class=p>(</span><span class=n>IMAGE_NUMBEROF_DIRECTORY_ENTRIES</span> <span class=o>-</span>
                                                         <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>OptionalHeader</span><span class=p>.</span><span class=n>NumberOfRvaAndSizes</span><span class=p>)</span> <span class=o>*</span>
                                                            <span class=k>sizeof</span><span class=p>(</span><span class=n>IMAGE_DATA_DIRECTORY</span><span class=p>));</span>
</code></pre></td></tr></table>
</div>
</div><h2 id=0x04-åŠ å£³å™¨>0x04 åŠ å£³å™¨</h2>
<p>åŠ å£³å™¨è¿™æ¬¡ç”¨ python å†™ï¼ŒMinGW ä¸‹åˆè¦é‡æ–°ç¼–è¯‘ LIEF å¤ªæŠ˜ç£¨äººäº†ã€‚</p>
<h3 id=41-å·¥å…·å‡½æ•°>4.1 å·¥å…·å‡½æ•°</h3>
<p>å…ˆæ˜¯å¯¼å…¥å’Œå®šä¹‰å¿…è¦çš„å·¥å…·ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>lief</span>

<span class=k>def</span> <span class=nf>align</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>al</span><span class=p>):</span>
    <span class=s2>&#34;&#34;&#34; return &lt;x&gt; aligned to &lt;al&gt; &#34;&#34;&#34;</span>
    <span class=k>return</span> <span class=p>((</span><span class=n>x</span><span class=o>+</span><span class=p>(</span><span class=n>al</span><span class=o>-</span><span class=mi>1</span><span class=p>))</span><span class=o>//</span><span class=n>al</span><span class=p>)</span><span class=o>*</span><span class=n>al</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=42-è§£æ>4.2 è§£æ</h3>
<p>å…ˆåˆ†ææ¡ˆä¾‹ç¨‹åºï¼Œè·å¾—å¿…è¦çš„æ•°æ®ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=n>binary</span> <span class=o>=</span> <span class=n>lief</span><span class=o>.</span><span class=n>PE</span><span class=o>.</span><span class=n>parse</span><span class=p>(</span><span class=s1>&#39;example.exe&#39;</span><span class=p>)</span>

<span class=c1># calculate shift offset and reserved section size</span>
<span class=n>image_base</span> <span class=o>=</span> <span class=n>binary</span><span class=o>.</span><span class=n>optional_header</span><span class=o>.</span><span class=n>imagebase</span>
<span class=n>lowest_rva</span> <span class=o>=</span> <span class=nb>min</span><span class=p>([</span><span class=n>s</span><span class=o>.</span><span class=n>virtual_address</span> <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>binary</span><span class=o>.</span><span class=n>sections</span><span class=p>])</span>
<span class=n>highest_rva</span> <span class=o>=</span> <span class=nb>max</span><span class=p>([</span><span class=n>s</span><span class=o>.</span><span class=n>virtual_address</span> <span class=o>+</span> <span class=n>s</span><span class=o>.</span><span class=n>size</span> <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>binary</span><span class=o>.</span><span class=n>sections</span><span class=p>])</span>
<span class=n>sect_alignment</span> <span class=o>=</span> <span class=n>binary</span><span class=o>.</span><span class=n>optional_header</span><span class=o>.</span><span class=n>section_alignment</span>
<span class=nb>print</span><span class=p>(</span><span class=s1>&#39;[+] analyze origin demo program binary success.&#39;</span><span class=p>)</span>
</code></pre></td></tr></table>
</div>
</div><p>å–å¾—åŸºå€ã€æ‰€æœ‰ section ä¸­æœ€ä½çš„èµ·å§‹ rva å’Œæœ€é«˜çš„ç»“æŸ rvaï¼Œå¾—åˆ°æ•´ä¸ª PE é•œåƒçš„ Sections è¦†ç›–çš„å†…å­˜èŒƒå›´ã€‚</p>
<h3 id=43-æ„é€ åŠ è½½å™¨>4.3 æ„é€ åŠ è½½å™¨</h3>
<p>ä½¿ç”¨ MinGW æ¥å®ŒæˆåŠ è½½å™¨æ„é€ â€”â€”å½“ç„¶æœ‰å…¶ä»–æ›´å¥½çš„åšæ³•ï¼ŒåŠ å£³è¿˜è¦è£…ä¸€ä¸ª MinGW æœªå…å¤ªéº»çƒ¦ï¼Œä½†æˆ‘ä¹Ÿä¸çŸ¥é“è¯¥æ€ä¹ˆåšå°±æ˜¯äº†ï¼ˆæˆ‘çŒœçš„è¯ï¼Œå¤§æ¦‚æ‹¿ nasm åº”è¯¥å°±åˆ‘ã€‚ï¼‰</p>
<p>ç¼–è¯‘å‘½ä»¤åœ¨ Python è„šæœ¬é‡Œç”Ÿæˆå¹¶æ‰§è¡Œã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=c1># compile shifted loader program</span>
<span class=n>compile_args</span> <span class=o>=</span> <span class=p>[</span>
    <span class=s1>&#39;loader.c&#39;</span><span class=p>,</span>
    <span class=s1>&#39;-m32&#39;</span><span class=p>,</span>
    <span class=s1>&#39;-O2&#39;</span><span class=p>,</span>
    <span class=s1>&#39;-Wall&#39;</span><span class=p>,</span>
    <span class=s1>&#39;-Wl,--entry=__start&#39;</span><span class=p>,</span>
    <span class=s1>&#39;-nodefaultlibs&#39;</span><span class=p>,</span>
    <span class=s1>&#39;-nostartfiles&#39;</span><span class=p>,</span>
    <span class=s1>&#39;-lkernel32&#39;</span><span class=p>,</span>
    <span class=s1>&#39;-luser32&#39;</span><span class=p>,</span>
    <span class=sa>f</span><span class=s1>&#39;-Wl,--image-base=</span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>image_base</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>,</span>
    <span class=sa>f</span><span class=s1>&#39;-Wl,--section-start=.text=</span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>align</span><span class=p>(</span><span class=n>image_base</span><span class=o>+</span><span class=n>highest_rva</span><span class=p>,</span><span class=n>sect_alignment</span><span class=p>))</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>,</span>
    <span class=s1>&#39;-o&#39;</span><span class=p>,</span>
    <span class=s1>&#39;shifted-loader.exe&#39;</span>
<span class=p>]</span>

<span class=k>try</span><span class=p>:</span>
    <span class=n>check_output</span><span class=p>(</span><span class=s1>&#39; &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=s1>&#39;gcc&#39;</span><span class=p>,</span> <span class=o>*</span><span class=n>compile_args</span><span class=p>]),</span> <span class=n>shell</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>stderr</span><span class=o>=</span><span class=n>STDOUT</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;[+] compile shifted loader program success.&#39;</span><span class=p>)</span>
<span class=k>except</span> <span class=n>CalledProcessError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;[!] loader compilation failed, </span><span class=si>{</span><span class=n>e</span><span class=o>.</span><span class=n>stdout</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
    <span class=k>raise</span>

<span class=n>shifted_loader</span> <span class=o>=</span> <span class=n>lief</span><span class=o>.</span><span class=n>PE</span><span class=o>.</span><span class=n>parse</span><span class=p>(</span><span class=s1>&#39;shifted-loader.exe&#39;</span><span class=p>)</span>
<span class=n>sect_alignment</span> <span class=o>=</span> <span class=n>shifted_loader</span><span class=o>.</span><span class=n>optional_header</span><span class=o>.</span><span class=n>section_alignment</span>
<span class=n>file_alignment</span> <span class=o>=</span> <span class=n>shifted_loader</span><span class=o>.</span><span class=n>optional_header</span><span class=o>.</span><span class=n>file_alignment</span>
</code></pre></td></tr></table>
</div>
</div><p><code>-luser32</code> æ˜¯å› ä¸ºæˆ‘æ·»åŠ äº†ä¸€ä¸ª <code>MessageBoxA</code> çš„è°ƒç”¨ã€‚</p>
<p><code>-Wl,--image-base=...</code> è®¾ç½®äº†åŠ è½½å™¨çš„åŸºå€ï¼Œç¡®ä¿åŠ è½½å™¨å’Œè¢«åŠ å£³çš„ç¨‹åºè½åœ¨åŒä¸€ä¸ªåŸºå€ä¸Šã€‚</p>
<p><code>-Wl,--section-start=...</code> å› ä¸ºçŸ¥é“ç¬¬ä¸€ä¸ª section ä¸€å®šæ˜¯ <code>.text</code> æ‰€ä»¥åªè®¾ç½®äº†ç¬¬ä¸€ä¸ª section çš„åœ°å€ï¼Œä¹‹åçš„ section ä¼šè‡ªåŠ¨å¾€åæŒªã€‚</p>
<p>å…¶ä»–å‚æ•°ä¸å¤šè§£é‡Šäº†ã€‚</p>
<p>ç¼–è¯‘å®Œæˆåï¼Œå†è§£æå‡ºåŠ è½½å™¨çš„å¯¹é½ä¿¡æ¯ï¼Œå‡†å¤‡ç”¨äºæ„é€ å®Œæ•´çš„è¢«åŠ å£³ç¨‹åºã€‚</p>
<h3 id=44-æ„é€ åŠ å£³ç¨‹åº>4.4 æ„é€ åŠ å£³ç¨‹åº</h3>
<p>åŠ è½½å™¨å’Œè¢«åŠ è½½çš„ç¨‹åºéƒ½å·²ç»å°±ç»ªï¼Œæ¥ä¸‹æ¥å°±æ˜¯æŠŠåŠ è½½å™¨å’Œç¨‹åºåˆå¹¶æˆåŠ å£³åçš„ç¨‹åºäº†ã€‚è¿™ä¸€æ­¥è¿˜æ˜¯å…ˆåœ¨åˆ›å»º lief çš„PE32 å¯¹è±¡ï¼Œç„¶åå¡«å……åŸºå€ã€Section å¯¹é½ã€æ–‡ä»¶å¯¹é½ï¼Œå¹¶ä¸”æŠŠ DLL Characteristics é‡ç½®åˆ° 0ï¼Œç›®çš„æ˜¯å£°æ˜ä¸æ”¯æŒ ASLRã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=c1># create new binary from scratch</span>
<span class=n>output</span> <span class=o>=</span> <span class=n>lief</span><span class=o>.</span><span class=n>PE</span><span class=o>.</span><span class=n>Binary</span><span class=p>(</span><span class=s1>&#39;packed&#39;</span><span class=p>,</span> <span class=n>lief</span><span class=o>.</span><span class=n>PE</span><span class=o>.</span><span class=n>PE_TYPE</span><span class=o>.</span><span class=n>PE32</span><span class=p>)</span>

<span class=c1># copy essential fields from shifted_loader</span>
<span class=n>output</span><span class=o>.</span><span class=n>optional_header</span><span class=o>.</span><span class=n>imagebase</span> <span class=o>=</span> <span class=n>shifted_loader</span><span class=o>.</span><span class=n>optional_header</span><span class=o>.</span><span class=n>imagebase</span>
<span class=n>output</span><span class=o>.</span><span class=n>optional_header</span><span class=o>.</span><span class=n>section_alignment</span> <span class=o>=</span> <span class=n>shifted_loader</span><span class=o>.</span><span class=n>optional_header</span><span class=o>.</span><span class=n>section_alignment</span>
<span class=n>output</span><span class=o>.</span><span class=n>optional_header</span><span class=o>.</span><span class=n>file_alignment</span> <span class=o>=</span> <span class=n>shifted_loader</span><span class=o>.</span><span class=n>optional_header</span><span class=o>.</span><span class=n>file_alignment</span>

<span class=c1># disable ASLR</span>
<span class=n>output</span><span class=o>.</span><span class=n>optional_header</span><span class=o>.</span><span class=n>dll_characteristics</span> <span class=o>=</span> <span class=mi>0</span>
</code></pre></td></tr></table>
</div>
</div><p>å…ˆå‡†å¤‡è¿™äº›æ–‡ä»¶å¤´å­—æ®µï¼Œæ¥ä¸‹æ¥å¼€å§‹å¡«å…… Section ï¼Œæœ€å…ˆå¡«å……çš„å°±æ˜¯å‡†å¤‡ç”¨ä½œè¢«åŠ è½½ç¨‹åºå†…å­˜ç©ºé—´çš„ <code>.alloc</code> èŠ‚ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=c1># add .alloc section</span>
<span class=n>allocate_size</span> <span class=o>=</span> <span class=n>align</span><span class=p>(</span><span class=n>highest_rva</span><span class=o>-</span><span class=n>lowest_rva</span><span class=p>,</span> <span class=n>sect_alignment</span><span class=p>)</span>
<span class=n>allocate_section</span> <span class=o>=</span> <span class=n>lief</span><span class=o>.</span><span class=n>PE</span><span class=o>.</span><span class=n>Section</span><span class=p>(</span><span class=s2>&#34;.alloc&#34;</span><span class=p>)</span>
<span class=n>allocate_section</span><span class=o>.</span><span class=n>virtual_address</span> <span class=o>=</span> <span class=n>lowest_rva</span>
<span class=n>allocate_section</span><span class=o>.</span><span class=n>virtual_size</span> <span class=o>=</span> <span class=n>allocate_size</span>
<span class=n>allocate_section</span><span class=o>.</span><span class=n>characteristics</span> <span class=o>=</span> <span class=p>(</span><span class=n>lief</span><span class=o>.</span><span class=n>PE</span><span class=o>.</span><span class=n>SECTION_CHARACTERISTICS</span><span class=o>.</span><span class=n>MEM_READ</span>
                                    <span class=o>|</span> <span class=n>lief</span><span class=o>.</span><span class=n>PE</span><span class=o>.</span><span class=n>SECTION_CHARACTERISTICS</span><span class=o>.</span><span class=n>MEM_WRITE</span>
                                    <span class=o>|</span> <span class=n>lief</span><span class=o>.</span><span class=n>PE</span><span class=o>.</span><span class=n>SECTION_CHARACTERISTICS</span><span class=o>.</span><span class=n>CNT_UNINITIALIZED_DATA</span><span class=p>)</span>
<span class=n>output</span><span class=o>.</span><span class=n>add_section</span><span class=p>(</span><span class=n>allocate_section</span><span class=p>)</span>
</code></pre></td></tr></table>
</div>
</div><p>å°† <code>.alloc</code> èŠ‚èµ·å§‹ç‚¹æ”¾ç½®åœ¨ä½ä½ï¼Œé•¿åº¦ä¸ºè¢«åŠ è½½ç¨‹åºçš„èŠ‚å¤§å°ä¹‹å’Œå¯¹é½ã€‚</p>
<p>ä¹‹åå¼€å§‹å¤åˆ¶åŠ è½½å™¨çš„èŠ‚ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=c1># copy sections</span>
<span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>shifted_loader</span><span class=o>.</span><span class=n>sections</span><span class=p>:</span>
    <span class=c1># let lief recalculate section offset and sizeof raw data</span>
    <span class=n>s</span><span class=o>.</span><span class=n>offset</span> <span class=o>=</span> <span class=mi>0</span>
    <span class=n>s</span><span class=o>.</span><span class=n>sizeof_raw_data</span> <span class=o>=</span> <span class=mi>0</span>
    <span class=n>output</span><span class=o>.</span><span class=n>add_section</span><span class=p>(</span><span class=n>s</span><span class=p>)</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>éœ€è¦æ³¨æ„</strong> æŠŠ <code>offset</code> å’Œ <code>sizeof_raw_data</code> ç½®é›¶ï¼Œè®© <code>lief</code> å»è®¡ç®—åç§»å’Œå¤§å°ï¼Œåé¢æ·»åŠ çš„ä¸€åº”èŠ‚éƒ½æŒ‰è¿™æ ·æ“ä½œã€‚æ–°åˆ›å»ºçš„ Section è¿˜å¥½ï¼Œå¯¹äºä»åŠ è½½å™¨é‡Œå¤åˆ¶çš„ Sectionï¼Œä¿ç•™ <code>offset</code> å’Œ <code>sizeof_raw_data</code> ä¼šå¯¼è‡´æœ€ç»ˆæˆå“çš„ Section æ•°æ®ä¸æ­£ç¡®ï¼Œé€ æˆ <code>ntdll</code> é‡ŒåŠ è½½PEæ–‡ä»¶æ—¶ï¼Œè¯»å–PEæ•°æ®ç»“æ„æ—¶å‡ºé”™ã€‚å¯ä»¥è‡ªè¡Œç”¨ x32dbg éªŒè¯ã€‚</p>
<p>æœ€åæŠŠè¢«åŠ è½½çš„æ–‡ä»¶æ‰“åŒ…è¿›å»ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=c1># add packed section</span>
<span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;example.exe&#39;</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
    <span class=n>packed_section</span> <span class=o>=</span> <span class=n>lief</span><span class=o>.</span><span class=n>PE</span><span class=o>.</span><span class=n>Section</span><span class=p>(</span><span class=s1>&#39;.packed&#39;</span><span class=p>)</span>
    <span class=n>packed_section</span><span class=o>.</span><span class=n>content</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>())</span>
    <span class=n>packed_section</span><span class=o>.</span><span class=n>characteristics</span> <span class=o>=</span> <span class=p>(</span><span class=n>lief</span><span class=o>.</span><span class=n>PE</span><span class=o>.</span><span class=n>SECTION_CHARACTERISTICS</span><span class=o>.</span><span class=n>MEM_READ</span> <span class=o>|</span>
                                      <span class=n>lief</span><span class=o>.</span><span class=n>PE</span><span class=o>.</span><span class=n>SECTION_CHARACTERISTICS</span><span class=o>.</span><span class=n>CNT_INITIALIZED_DATA</span><span class=p>)</span>
    <span class=n>output</span><span class=o>.</span><span class=n>add_section</span><span class=p>(</span><span class=n>packed_section</span><span class=p>)</span>
</code></pre></td></tr></table>
</div>
</div><p>åŒæ ·ï¼Œè®© lief å»è®¡ç®—åç§»å’Œå¤§å°ã€‚å¤åˆ¶å¥½èŠ‚ï¼Œç»§ç»­å¤åˆ¶ Data Directoriesï¼Œè¿™åˆæœ‰ä¸€ä¸ªå‘ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=c1># copy data directories</span>
<span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>15</span><span class=p>):</span>
    <span class=n>src</span> <span class=o>=</span> <span class=n>shifted_loader</span><span class=o>.</span><span class=n>data_directories</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
    <span class=n>output</span><span class=o>.</span><span class=n>data_directories</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>rva</span> <span class=o>=</span> <span class=n>src</span><span class=o>.</span><span class=n>rva</span>
    <span class=n>output</span><span class=o>.</span><span class=n>data_directories</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>size</span> <span class=o>=</span> <span class=n>src</span><span class=o>.</span><span class=n>size</span>
    
<span class=c1># correct number of data directories</span>
<span class=c1># warning: size of data directories may disagree with IMAGE_NT_HEADERS.DataDirectory in winnt.h</span>
<span class=n>output</span><span class=o>.</span><span class=n>optional_header</span><span class=o>.</span><span class=n>numberof_rva_and_size</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>output</span><span class=o>.</span><span class=n>data_directories</span><span class=p>)</span>
</code></pre></td></tr></table>
</div>
</div><p>éœ€è¦æ³¨æ„åˆ°ï¼Œ<strong>lief çš„æ•°æ®ç»“æ„é‡Œï¼Œå…è®¸çš„ data_directories åªæœ‰ 15 ä¸ª</strong>ï¼<strong>ä½† <code>winnt.h</code> é‡Œå®šä¹‰çš„ DATA_DIRECTORIES æ•°ç»„ï¼Œæ˜¯å›ºå®š16ä¸ªå…ƒç´ </strong>ï¼</p>
<p>å¦‚æœç›´æ¥ <code>range(16)</code> å»éå†ï¼Œä¼šå‡ºç° <code>IndexError</code> ï¼Œå¦‚æœå¿½è§†è¿™ä¸ªé•¿åº¦é—®é¢˜ï¼Œç›´æ¥åœ¨åŠ è½½å™¨é‡Œé‡‡ç”¨ Windows SDK çš„å¤´æ–‡ä»¶å®šä¹‰çš„ç»“æ„ï¼Œä¼šå¯¼è‡´å–èŠ‚è¡¨æŒ‡é’ˆçš„æ—¶å€™æ¯”é¢„æœŸçš„å¤šåç§» 8 ä¸ªå­—èŠ‚ï¼Œé€ æˆé—®é¢˜ã€‚è°ƒè¯•èµ·æ¥ç®€ç›´å¤ªæŠ˜ç£¨äººäº†ã€‚</p>
<p>ä¹‹åå†å¤åˆ¶å…¥å£ç‚¹å’Œé•œåƒå¤§å°ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=c1># copy original address of entrypoint</span>
<span class=n>output</span><span class=o>.</span><span class=n>optional_header</span><span class=o>.</span><span class=n>addressof_entrypoint</span> <span class=o>=</span> <span class=n>shifted_loader</span><span class=o>.</span><span class=n>optional_header</span><span class=o>.</span><span class=n>addressof_entrypoint</span>
<span class=c1># let lief recalculate size of image</span>
<span class=n>output</span><span class=o>.</span><span class=n>optional_header</span><span class=o>.</span><span class=n>sizeof_image</span> <span class=o>=</span> <span class=mi>0</span>
</code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„ï¼Œå…¥å£ç‚¹å’Œé•œåƒå¤§å°çš„å­—æ®µå¿…é¡»åœ¨å¤åˆ¶å®Œ Section ä¹‹åå†å¤åˆ¶ï¼Œä¸ç„¶ lief ä¼šçŠ¯å‚»ï¼ŒåŸå› ä¸æ˜ï¼Œæœ‰å…´è¶£å¯ä»¥è‡ªå·±æ”¹ä¸€æ”¹é¡ºåºçœ‹çœ‹ç»“æœã€‚</p>
<p>åˆ°è¿™é‡Œï¼ŒåŸºæœ¬å‡†å¤‡å°±ç»ªï¼Œå°±å¯ä»¥æŠŠæ„é€ å¥½çš„å¯æ‰§è¡Œæ–‡ä»¶å†™å…¥ç¡¬ç›˜äº†ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=c1># build output binary</span>
<span class=n>builder</span> <span class=o>=</span> <span class=n>lief</span><span class=o>.</span><span class=n>PE</span><span class=o>.</span><span class=n>Builder</span><span class=p>(</span><span class=n>output</span><span class=p>)</span>
<span class=n>builder</span><span class=o>.</span><span class=n>build</span><span class=p>()</span>
<span class=n>builder</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s1>&#39;packed.exe&#39;</span><span class=p>)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=45-å®Œæ•´ä»£ç >4.5 å®Œæ•´ä»£ç </h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=c1># %%</span>
<span class=kn>import</span> <span class=nn>lief</span>
<span class=kn>from</span> <span class=nn>subprocess</span> <span class=kn>import</span> <span class=n>STDOUT</span><span class=p>,</span> <span class=n>CalledProcessError</span><span class=p>,</span> <span class=n>check_output</span>


<span class=k>def</span> <span class=nf>align</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>al</span><span class=p>):</span>
    <span class=s2>&#34;&#34;&#34; return &lt;x&gt; aligned to &lt;al&gt; &#34;&#34;&#34;</span>
    <span class=k>return</span> <span class=p>((</span><span class=n>x</span><span class=o>+</span><span class=p>(</span><span class=n>al</span><span class=o>-</span><span class=mi>1</span><span class=p>))</span><span class=o>//</span><span class=n>al</span><span class=p>)</span><span class=o>*</span><span class=n>al</span>


<span class=c1># %%</span>
<span class=c1># compile origin demo program</span>
<span class=k>try</span><span class=p>:</span>
    <span class=n>check_output</span><span class=p>(</span><span class=s1>&#39;gcc example.c -m32 -O2 -o example.exe&#39;</span><span class=p>,</span> <span class=n>shell</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>stderr</span><span class=o>=</span><span class=n>STDOUT</span><span class=p>)</span>
<span class=k>except</span> <span class=n>CalledProcessError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;[!] demo program compilation failed, </span><span class=si>{</span><span class=n>e</span><span class=o>.</span><span class=n>stdout</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
    <span class=k>raise</span>

<span class=n>binary</span> <span class=o>=</span> <span class=n>lief</span><span class=o>.</span><span class=n>PE</span><span class=o>.</span><span class=n>parse</span><span class=p>(</span><span class=s1>&#39;example.exe&#39;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s1>&#39;[+] compile origin demo program success.&#39;</span><span class=p>)</span>

<span class=c1># %%</span>
<span class=c1># calculate shift offset and reserved section size</span>
<span class=n>image_base</span> <span class=o>=</span> <span class=n>binary</span><span class=o>.</span><span class=n>optional_header</span><span class=o>.</span><span class=n>imagebase</span>
<span class=n>lowest_rva</span> <span class=o>=</span> <span class=nb>min</span><span class=p>([</span><span class=n>s</span><span class=o>.</span><span class=n>virtual_address</span> <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>binary</span><span class=o>.</span><span class=n>sections</span><span class=p>])</span>
<span class=n>highest_rva</span> <span class=o>=</span> <span class=nb>max</span><span class=p>([</span><span class=n>s</span><span class=o>.</span><span class=n>virtual_address</span> <span class=o>+</span> <span class=n>s</span><span class=o>.</span><span class=n>size</span> <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>binary</span><span class=o>.</span><span class=n>sections</span><span class=p>])</span>
<span class=n>sect_alignment</span> <span class=o>=</span> <span class=n>binary</span><span class=o>.</span><span class=n>optional_header</span><span class=o>.</span><span class=n>section_alignment</span>
<span class=nb>print</span><span class=p>(</span><span class=s1>&#39;[+] analyze origin demo program binary success.&#39;</span><span class=p>)</span>

<span class=c1># %%</span>
<span class=c1># compile shifted loader program</span>
<span class=n>compile_args</span> <span class=o>=</span> <span class=p>[</span>
    <span class=s1>&#39;loader.c&#39;</span><span class=p>,</span>
    <span class=s1>&#39;-m32&#39;</span><span class=p>,</span>
    <span class=s1>&#39;-O2&#39;</span><span class=p>,</span>
    <span class=s1>&#39;-Wall&#39;</span><span class=p>,</span>
    <span class=s1>&#39;-Wl,--entry=__start&#39;</span><span class=p>,</span>
    <span class=s1>&#39;-nodefaultlibs&#39;</span><span class=p>,</span>
    <span class=s1>&#39;-nostartfiles&#39;</span><span class=p>,</span>
    <span class=s1>&#39;-lkernel32&#39;</span><span class=p>,</span>
    <span class=s1>&#39;-luser32&#39;</span><span class=p>,</span>
    <span class=sa>f</span><span class=s1>&#39;-Wl,--image-base=</span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>image_base</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>,</span>
    <span class=sa>f</span><span class=s1>&#39;-Wl,--section-start=.text=</span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>align</span><span class=p>(</span><span class=n>image_base</span><span class=o>+</span><span class=n>highest_rva</span><span class=p>,</span><span class=n>sect_alignment</span><span class=p>))</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>,</span>
    <span class=s1>&#39;-o&#39;</span><span class=p>,</span>
    <span class=s1>&#39;shifted-loader.exe&#39;</span>
<span class=p>]</span>

<span class=k>try</span><span class=p>:</span>
    <span class=n>check_output</span><span class=p>(</span><span class=s1>&#39; &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=s1>&#39;gcc&#39;</span><span class=p>,</span> <span class=o>*</span><span class=n>compile_args</span><span class=p>]),</span> <span class=n>shell</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>stderr</span><span class=o>=</span><span class=n>STDOUT</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;[+] compile shifted loader program success.&#39;</span><span class=p>)</span>
<span class=k>except</span> <span class=n>CalledProcessError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;[!] loader compilation failed, </span><span class=si>{</span><span class=n>e</span><span class=o>.</span><span class=n>stdout</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
    <span class=k>raise</span>

<span class=n>shifted_loader</span> <span class=o>=</span> <span class=n>lief</span><span class=o>.</span><span class=n>PE</span><span class=o>.</span><span class=n>parse</span><span class=p>(</span><span class=s1>&#39;shifted-loader.exe&#39;</span><span class=p>)</span>
<span class=n>sect_alignment</span> <span class=o>=</span> <span class=n>shifted_loader</span><span class=o>.</span><span class=n>optional_header</span><span class=o>.</span><span class=n>section_alignment</span>
<span class=n>file_alignment</span> <span class=o>=</span> <span class=n>shifted_loader</span><span class=o>.</span><span class=n>optional_header</span><span class=o>.</span><span class=n>file_alignment</span>

<span class=c1># %%</span>
<span class=c1># create new binary from scratch</span>
<span class=n>output</span> <span class=o>=</span> <span class=n>lief</span><span class=o>.</span><span class=n>PE</span><span class=o>.</span><span class=n>Binary</span><span class=p>(</span><span class=s1>&#39;packed&#39;</span><span class=p>,</span> <span class=n>lief</span><span class=o>.</span><span class=n>PE</span><span class=o>.</span><span class=n>PE_TYPE</span><span class=o>.</span><span class=n>PE32</span><span class=p>)</span>

<span class=c1># copy essential fields from shifted_loader</span>
<span class=n>output</span><span class=o>.</span><span class=n>optional_header</span><span class=o>.</span><span class=n>imagebase</span> <span class=o>=</span> <span class=n>shifted_loader</span><span class=o>.</span><span class=n>optional_header</span><span class=o>.</span><span class=n>imagebase</span>
<span class=n>output</span><span class=o>.</span><span class=n>optional_header</span><span class=o>.</span><span class=n>section_alignment</span> <span class=o>=</span> <span class=n>shifted_loader</span><span class=o>.</span><span class=n>optional_header</span><span class=o>.</span><span class=n>section_alignment</span>
<span class=n>output</span><span class=o>.</span><span class=n>optional_header</span><span class=o>.</span><span class=n>file_alignment</span> <span class=o>=</span> <span class=n>shifted_loader</span><span class=o>.</span><span class=n>optional_header</span><span class=o>.</span><span class=n>file_alignment</span>

<span class=c1># disable ASLR</span>
<span class=n>output</span><span class=o>.</span><span class=n>optional_header</span><span class=o>.</span><span class=n>dll_characteristics</span> <span class=o>=</span> <span class=mi>0</span>

<span class=c1># add .alloc section</span>
<span class=n>allocate_size</span> <span class=o>=</span> <span class=n>align</span><span class=p>(</span><span class=n>highest_rva</span><span class=o>-</span><span class=n>lowest_rva</span><span class=p>,</span> <span class=n>sect_alignment</span><span class=p>)</span>
<span class=n>allocate_section</span> <span class=o>=</span> <span class=n>lief</span><span class=o>.</span><span class=n>PE</span><span class=o>.</span><span class=n>Section</span><span class=p>(</span><span class=s2>&#34;.alloc&#34;</span><span class=p>)</span>
<span class=n>allocate_section</span><span class=o>.</span><span class=n>virtual_address</span> <span class=o>=</span> <span class=n>lowest_rva</span>
<span class=n>allocate_section</span><span class=o>.</span><span class=n>virtual_size</span> <span class=o>=</span> <span class=n>allocate_size</span>
<span class=n>allocate_section</span><span class=o>.</span><span class=n>characteristics</span> <span class=o>=</span> <span class=p>(</span><span class=n>lief</span><span class=o>.</span><span class=n>PE</span><span class=o>.</span><span class=n>SECTION_CHARACTERISTICS</span><span class=o>.</span><span class=n>MEM_READ</span>
                                    <span class=o>|</span> <span class=n>lief</span><span class=o>.</span><span class=n>PE</span><span class=o>.</span><span class=n>SECTION_CHARACTERISTICS</span><span class=o>.</span><span class=n>MEM_WRITE</span>
                                    <span class=o>|</span> <span class=n>lief</span><span class=o>.</span><span class=n>PE</span><span class=o>.</span><span class=n>SECTION_CHARACTERISTICS</span><span class=o>.</span><span class=n>CNT_UNINITIALIZED_DATA</span><span class=p>)</span>
<span class=n>output</span><span class=o>.</span><span class=n>add_section</span><span class=p>(</span><span class=n>allocate_section</span><span class=p>)</span>

<span class=c1># copy sections</span>
<span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>shifted_loader</span><span class=o>.</span><span class=n>sections</span><span class=p>:</span>
    <span class=c1># let lief recalculate section offset and sizeof raw data</span>
    <span class=n>s</span><span class=o>.</span><span class=n>offset</span> <span class=o>=</span> <span class=mi>0</span>
    <span class=n>s</span><span class=o>.</span><span class=n>sizeof_raw_data</span> <span class=o>=</span> <span class=mi>0</span>
    <span class=n>output</span><span class=o>.</span><span class=n>add_section</span><span class=p>(</span><span class=n>s</span><span class=p>)</span>

<span class=c1># add packed section</span>
<span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;example.exe&#39;</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
    <span class=n>packed_section</span> <span class=o>=</span> <span class=n>lief</span><span class=o>.</span><span class=n>PE</span><span class=o>.</span><span class=n>Section</span><span class=p>(</span><span class=s1>&#39;.packed&#39;</span><span class=p>)</span>
    <span class=n>packed_section</span><span class=o>.</span><span class=n>content</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>())</span>
    <span class=n>packed_section</span><span class=o>.</span><span class=n>characteristics</span> <span class=o>=</span> <span class=p>(</span><span class=n>lief</span><span class=o>.</span><span class=n>PE</span><span class=o>.</span><span class=n>SECTION_CHARACTERISTICS</span><span class=o>.</span><span class=n>MEM_READ</span> <span class=o>|</span>
                                      <span class=n>lief</span><span class=o>.</span><span class=n>PE</span><span class=o>.</span><span class=n>SECTION_CHARACTERISTICS</span><span class=o>.</span><span class=n>CNT_INITIALIZED_DATA</span><span class=p>)</span>
    <span class=n>output</span><span class=o>.</span><span class=n>add_section</span><span class=p>(</span><span class=n>packed_section</span><span class=p>)</span>

<span class=c1># copy data directories</span>
<span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>15</span><span class=p>):</span>
    <span class=n>src</span> <span class=o>=</span> <span class=n>shifted_loader</span><span class=o>.</span><span class=n>data_directories</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
    <span class=n>output</span><span class=o>.</span><span class=n>data_directories</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>rva</span> <span class=o>=</span> <span class=n>src</span><span class=o>.</span><span class=n>rva</span>
    <span class=n>output</span><span class=o>.</span><span class=n>data_directories</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>size</span> <span class=o>=</span> <span class=n>src</span><span class=o>.</span><span class=n>size</span>

<span class=c1># correct number of data directories</span>
<span class=c1># warning: size of data directories may disagree with IMAGE_NT_HEADERS.DataDirectory in winnt.h</span>
<span class=n>output</span><span class=o>.</span><span class=n>optional_header</span><span class=o>.</span><span class=n>numberof_rva_and_size</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>output</span><span class=o>.</span><span class=n>data_directories</span><span class=p>)</span>
<span class=c1># copy original address of entrypoint</span>
<span class=n>output</span><span class=o>.</span><span class=n>optional_header</span><span class=o>.</span><span class=n>addressof_entrypoint</span> <span class=o>=</span> <span class=n>shifted_loader</span><span class=o>.</span><span class=n>optional_header</span><span class=o>.</span><span class=n>addressof_entrypoint</span>
<span class=c1># let lief recalculate size of image</span>
<span class=n>output</span><span class=o>.</span><span class=n>optional_header</span><span class=o>.</span><span class=n>sizeof_image</span> <span class=o>=</span> <span class=mi>0</span>

<span class=c1># build output binary</span>
<span class=n>builder</span> <span class=o>=</span> <span class=n>lief</span><span class=o>.</span><span class=n>PE</span><span class=o>.</span><span class=n>Builder</span><span class=p>(</span><span class=n>output</span><span class=p>)</span>
<span class=n>builder</span><span class=o>.</span><span class=n>build</span><span class=p>()</span>
<span class=n>builder</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s1>&#39;packed.exe&#39;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=s1>&#39;[+] create packed binary success.&#39;</span><span class=p>)</span>

</code></pre></td></tr></table>
</div>
</div><p>åªæ”¾ä¸€ä¸‹åŠ è½½å™¨ä»£ç ï¼Œä¸€å…±ä¸‰ä¸ªä»£ç æ–‡ä»¶æ‰˜ç®¡åœ¨ Gist ä¸Šï¼Œéœ€è¦å®‰è£… MinGW å’Œ LIEFï¼Œé…ç½®æ–¹å¼ä¸èµ˜è¿°ã€‚è¿˜ä¸ä¼š C å’Œ Python çš„è¯å»ºè®®å­¦ä¸€ä¸‹å…ˆå‘¢ã€‚</p>
<p><a class=link href=https://gist.github.com/nnnewb/28ca24ed4ee53f446120d64570c7ad01 target=_blank rel=noopener>å®Œæ•´ä»£ç çš„ GIST</a></p>
<h2 id=0x05-æˆæœ>0x05 æˆæœ</h2>
<p>åŠ å£³æœºè¿è¡Œæ•ˆæœã€‚</p>
<p><img src=/blog/%E5%8A%A0%E5%A3%B3%E6%9C%BA.gif loading=lazy alt=åŠ å£³æœº></p>
<p><code>packed.exe</code> çš„èŠ‚è¡¨ä¿¡æ¯å¦‚ä¸‹ã€‚</p>
<p><img src=/blog/p/learning-packer-03-support-no-relocations/image-20211020095008599.png width=507 height=296 srcset="/blog/p/learning-packer-03-support-no-relocations/image-20211020095008599_hu133cb724811b185855f9a631cc001e91_10916_480x0_resize_box_3.png 480w, /blog/p/learning-packer-03-support-no-relocations/image-20211020095008599_hu133cb724811b185855f9a631cc001e91_10916_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20211020095008599 class=gallery-image data-flex-grow=171 data-flex-basis=411px></p>
<h2 id=ç»“è®º>ç»“è®º</h2>
<p>æ•´ä¸ªè¿‡ç¨‹é‡Œè¸©äº†ä¸å°‘å‘ï¼Œå‡ ä¹éƒ½è¦é  x32dbg è°ƒè¯•å’Œ CFF Explorer æŒ¨ä¸ªæ–‡ä»¶å¤´å­—æ®µæ£€æŸ¥ã€‚æœ‰ä¸ªæ¯”è¾ƒå®ç”¨çš„åšæ³•æ˜¯æ‹¿ LIEF è§£æå¥½åŠ å£³åçš„æ–‡ä»¶ï¼ŒæŠŠè¾“å‡ºç»“æœå’ŒåŸå§‹åŠ è½½å™¨å¯¹æ¯”ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>lief</span>

<span class=n>packed</span> <span class=o>=</span> <span class=n>lief</span><span class=o>.</span><span class=n>PE</span><span class=o>.</span><span class=n>parse</span><span class=p>(</span><span class=s1>&#39;packed.exe&#39;</span><span class=p>)</span>
<span class=n>loader</span> <span class=o>=</span> <span class=n>lief</span><span class=o>.</span><span class=n>PE</span><span class=o>.</span><span class=n>parse</span><span class=p>(</span><span class=s1>&#39;shifted-loader.exe&#39;</span><span class=p>)</span>

<span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;packed-analysis.txt&#39;</span><span class=p>,</span> <span class=s1>&#39;w+&#39;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>out</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;-----&#39;</span><span class=o>*</span><span class=mi>20</span><span class=p>,</span> <span class=n>file</span><span class=o>=</span><span class=n>out</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;packed.exe&#39;</span><span class=p>,</span> <span class=n>file</span><span class=o>=</span><span class=n>out</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;-----&#39;</span><span class=o>*</span><span class=mi>20</span><span class=p>,</span> <span class=n>file</span><span class=o>=</span><span class=n>out</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=n>packed</span><span class=o>.</span><span class=n>header</span><span class=p>,</span> <span class=n>file</span><span class=o>=</span><span class=n>out</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=n>packed</span><span class=o>.</span><span class=n>optional_header</span><span class=p>,</span> <span class=n>file</span><span class=o>=</span><span class=n>out</span><span class=p>)</span>

    <span class=k>for</span> <span class=n>entry</span> <span class=ow>in</span> <span class=n>packed</span><span class=o>.</span><span class=n>data_directories</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>entry</span><span class=p>,</span> <span class=n>file</span><span class=o>=</span><span class=n>out</span><span class=p>)</span>

    <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>packed</span><span class=o>.</span><span class=n>sections</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=n>file</span><span class=o>=</span><span class=n>out</span><span class=p>)</span>

<span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;loader-analysis.txt&#39;</span><span class=p>,</span> <span class=s1>&#39;w+&#39;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>out</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;-----&#39;</span><span class=o>*</span><span class=mi>20</span><span class=p>,</span> <span class=n>file</span><span class=o>=</span><span class=n>out</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;shifted-loader.exe&#39;</span><span class=p>,</span> <span class=n>file</span><span class=o>=</span><span class=n>out</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;-----&#39;</span><span class=o>*</span><span class=mi>20</span><span class=p>,</span> <span class=n>file</span><span class=o>=</span><span class=n>out</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=n>loader</span><span class=o>.</span><span class=n>header</span><span class=p>,</span> <span class=n>file</span><span class=o>=</span><span class=n>out</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=n>loader</span><span class=o>.</span><span class=n>optional_header</span><span class=p>,</span> <span class=n>file</span><span class=o>=</span><span class=n>out</span><span class=p>)</span>

    <span class=k>for</span> <span class=n>entry</span> <span class=ow>in</span> <span class=n>loader</span><span class=o>.</span><span class=n>data_directories</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>entry</span><span class=p>,</span> <span class=n>file</span><span class=o>=</span><span class=n>out</span><span class=p>)</span>

    <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>loader</span><span class=o>.</span><span class=n>sections</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=n>file</span><span class=o>=</span><span class=n>out</span><span class=p>)</span>

</code></pre></td></tr></table>
</div>
</div><p>åˆ†æå¥½ä¹‹åå°±å¯ä»¥æ‹¿ vscode å»æ¯”è¾ƒäº†ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>code -n -d packed-analysis.txt loader-analysis.txt
</code></pre></td></tr></table>
</div>
</div><p>æ¯”èµ·ç›´æ¥æ‹¿ CFF Explorer ç¡¬çœ‹å­—æ®µå“ªå„¿ä¸å¯¹ï¼Œå’Œç¼–è¯‘å™¨äº§ç”Ÿçš„æ­£å¸¸æ–‡ä»¶æ¯”è¾ƒèƒ½æ’é™¤æ‰ä¸€äº›æ— å…³çš„å­—æ®µã€‚ä½†ä¹Ÿä¸æ˜¯ä¸‡èƒ½ï¼Œæ¯”å¦‚è¯´ä¹‹å‰æ²¡æœ‰å†™ <code>section.offset=0</code>ï¼Œç»“æœç”Ÿæˆçš„ PE32 æ–‡ä»¶å¯¼å…¥è¡¨å†…å®¹åäº†ï¼Œä¸€ç›´æ²¡æ„è¯†åˆ°ã€‚ç›´åˆ° x32dbg è°ƒè¯•ä¸­å‘ç° ntdll é‡ŒåŠ è½½å¯¼å…¥è¡¨æ—¶ç¢°åˆ°äº†ä¸€ä¸ªæ— æ•ˆåœ°å€ï¼ˆæˆ‘æ€ä¹ˆçŸ¥é“æ˜¯åŠ è½½å¯¼å…¥è¡¨æ—¶å‘¢ï¼Œèƒ†å¤§å¿ƒç»†åŠ ä¸Š99%çš„è¿æ°”&mldr;ï¼‰ï¼Œç„¶åçœ‹ CFF Explorer æ‰å‘ç°å¯¼å…¥è¡¨å®Œå…¨æŒ‚äº†ï¼Œå†å›å¤´çœ‹èŠ‚è¡¨æ‰å‘ç° <code>.idata</code> çš„åç§»å’Œå¤§å°éƒ½æ˜¯åçš„&mldr;</p>
<p>è¿˜æœ‰ data directories çš„å‘ï¼Œä¹Ÿæ˜¯é  x32dbgï¼Œè·³è½¬åˆ°å†…å­˜ï¼Œæ‰å‘ç° <code>(IMAGE_SECTION_HEADER*)(PIMAGE_NT_HEADERS+1)</code> ç®—å‡ºæ¥çš„åç§»å€¼å¤šäº†8å­—èŠ‚ï¼Œå†¥æ€è‹¦æƒ³è¿™8å­—èŠ‚æ€ä¹ˆå›äº‹ï¼Œèƒ¡ä¹±åˆ†æï¼Œç„¶åçªç„¶æ„è¯†åˆ° data directory æ­£å¥½ 8 å­—èŠ‚ï¼ŒåŠ å£³æœºé‡Œåˆæœ‰ä¸ªå¾ˆè¿·æƒ‘çš„ <code>range(0,15)</code>ï¼Œåå¤ç¡®è®¤äº†å‡ æ¬¡æ‰å‘ç°çœŸçš„æ˜¯ LIEF å°±ç»™äº† 15 ä¸ª Data directory â€”â€” ä½† Windows SDK é‡Œ <code>winnt.h</code> å®šä¹‰çš„æ˜¯ <strong>å›ºå®š 16 ä¸ªå…ƒç´ </strong> ï¼Œä¹‹åå»ç¿» PE Format æ–‡æ¡£æ‰å‘ç°å¾®è½¯æ—©å°±æŒ–å¥½äº†è¿™ä¸ªå‘ç­‰ä½ ç¿»æ–‡æ¡£ï¼š</p>
<blockquote>
<p>Note that the number of directories is not fixed. Before looking for a specific directory, check the NumberOfRvaAndSizes field in the optional header.</p>
</blockquote>
<p>åŸå…ˆçš„æ–‡ç« é¢„è®¡æ˜¯è¦åšä¸€ä¸ªå‹ç¼©å£³ï¼Œç®€å•è¯•éªŒäº†ä¸€ä¸‹æ²¡å•¥éš¾åº¦ï¼Œä»£ç éƒ½ä¸ç”¨å‡ è¡Œï¼ˆVS+CMake+VCPKG åŒæ—¶ç”¨ LIEF å’Œ ZLIB/LZO ä»€ä¹ˆçš„æœ‰ç‚¹è´¹åŠ²ï¼Œæ‰€ä»¥ç”¨ Windows Compression APIï¼‰ï¼Œå°±è¿™æ ·æ°´ä¸€ç¯‡æ–‡ç« æœ‰ç‚¹ä¸å¥½æ„æ€ã€‚æ‰€ä»¥å°±å…ˆå»çœ‹æ€ä¹ˆå¯¹ä»˜ä¸èƒ½é‡å®šä½çš„PE32äº†ï¼Œç»“æœæ LIEF çš„å„ç§ç¯å¢ƒç¼–è¯‘ã€æŠ˜è…¾VC++çš„Pragmaã€ç¿» Linker Script æ‰‹å†Œçœ‹èƒ½ä¸èƒ½æ”¹èŠ‚è¡¨åç§»ã€å­¦NASMã€ä»å›½åº†å‘åˆ°ç°åœ¨ã€‚</p>
<p>æœ¬ç¯‡çš„å‚è€ƒæ–‡ç« æ˜¯ï¼šhttps://bidouillesecurity.com/tutorial-writing-a-pe-packer-part-4/</p>
<p>æ–‡ä¸­æœ‰äº›åœ°æ–¹æ¯”è¾ƒæ€ªï¼Œæ¯”å¦‚è¯´å…ˆç¼–è¯‘äº†æ­£å¸¸ loader å†ç¼–è¯‘ shifted_loader å°±è®©äººä¸æ˜¯å¾ˆç†è§£ï¼Œç…§æŠ„æŠ„å‡ºä¸€å †bugã€‚æ‰€ä»¥æœ¬æ–‡çš„è„šæœ¬å’Œå‚è€ƒçš„è„šæœ¬å·²ç»æœ‰ç‚¹å¯¹ä¸ä¸Šäº†ã€‚</p>
<p>å—åˆ¶äºä¸çŸ¥é“æ€ä¹ˆç¼–è¯‘å‡ºæ²¡æœ‰é‡å®šä½çš„ç¨‹åºï¼Œæˆ‘æ‹¿ä¸€ä¸ªæœ‰é‡å®šä½çš„åšäº†å®éªŒï¼ˆç†è®ºä¸Šæ¥è¯´ï¼Œåº”è¯¥æ˜¯ä¸€æ ·çš„å§ï¼Ÿï¼‰ï¼Œæ‰€ä»¥åˆ°å¤´ä¹Ÿä¸ç¡®å®šæ˜¯ä¸æ˜¯çœŸçš„èƒ½æŠŠæ²¡æœ‰é‡å®šä½çš„ç¨‹åºè·‘èµ·æ¥ã€‚</p>
<p>å°±è¿™æ ·å§ï¼Œè¿™ä¸ªç»“è®ºæœ‰ç‚¹é•¿ã€‚åˆ°è¿™å°±å·®ä¸å¤šäº†ã€‚</p>
</section>
<footer class=article-footer>
<section class=article-tags>
<a href=/blog/tags/%E9%80%86%E5%90%91/>é€†å‘</a>
<a href=/blog/tags/c++/>c++</a>
<a href=/blog/tags/python/>python</a>
<a href=/blog/tags/%E6%B1%87%E7%BC%96/>æ±‡ç¼–</a>
<a href=/blog/tags/windows/>windows</a>
</section>
<section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
</footer>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css integrity=sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js integrity=sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js integrity=sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.querySelector(`.article-content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script>
</article>
<aside class=related-contents--wrapper>
<h2 class=section-title>ç›¸å…³æ–‡ç« </h2>
<div class=related-contents>
<div class="flex article-list--tile">
<article class=has-image>
<a href=/blog/p/learning-packer-04-zlib-compression-packer-demo/>
<div class=article-image>
<img src=/blog/p/learning-packer-04-zlib-compression-packer-demo/cover.303a5ee85ad8275c094df5988adf0791_hu8b7651a2bda3b235d3ed49f67a1e20bd_99156_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post åŠ å£³åŸç†04 - zlibå‹ç¼©å£³æ¡ˆä¾‹" data-key=learning-packer-04-zlib-compression-packer-demo data-hash="md5-MDpe6FrYJ1wJTfWYit8HkQ==">
</div>
<div class=article-details>
<h2 class=article-title>åŠ å£³åŸç†04 - zlibå‹ç¼©å£³æ¡ˆä¾‹</h2>
</div>
</a>
</article>
<article class=has-image>
<a href=/blog/p/learning-packer-08/>
<div class=article-image>
<img src=/blog/p/learning-packer-08/cover.303a5ee85ad8275c094df5988adf0791_hu8b7651a2bda3b235d3ed49f67a1e20bd_99156_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post åŠ å£³åŸç†08ï¼šæ··æ·†æŠ€æœ¯å…¥é—¨" data-key=learning-packer-08 data-hash="md5-MDpe6FrYJ1wJTfWYit8HkQ==">
</div>
<div class=article-details>
<h2 class=article-title>åŠ å£³åŸç†08ï¼šæ··æ·†æŠ€æœ¯å…¥é—¨</h2>
</div>
</a>
</article>
<article class=has-image>
<a href=/blog/p/learning-packer-07/>
<div class=article-image>
<img src=/blog/p/learning-packer-07/cover.303a5ee85ad8275c094df5988adf0791_hu8b7651a2bda3b235d3ed49f67a1e20bd_99156_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post åŠ å£³åŸç†07 - èŠ±æŒ‡ä»¤å…¥é—¨" data-key=learning-packer-07 data-hash="md5-MDpe6FrYJ1wJTfWYit8HkQ==">
</div>
<div class=article-details>
<h2 class=article-title>åŠ å£³åŸç†07 - èŠ±æŒ‡ä»¤å…¥é—¨</h2>
</div>
</a>
</article>
<article class=has-image>
<a href=/blog/p/learning-packer-06/>
<div class=article-image>
<img src=/blog/p/learning-packer-06/cover.303a5ee85ad8275c094df5988adf0791_hu8b7651a2bda3b235d3ed49f67a1e20bd_99156_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post åŠ å£³åŸç†06ï¼šåè°ƒè¯•æŠ€æœ¯å…¥é—¨" data-key=learning-packer-06 data-hash="md5-MDpe6FrYJ1wJTfWYit8HkQ==">
</div>
<div class=article-details>
<h2 class=article-title>åŠ å£³åŸç†06ï¼šåè°ƒè¯•æŠ€æœ¯å…¥é—¨</h2>
</div>
</a>
</article>
<article class=has-image>
<a href=/blog/p/learning-packer-05/>
<div class=article-image>
<img src=/blog/p/learning-packer-05/cover.303a5ee85ad8275c094df5988adf0791_hu8b7651a2bda3b235d3ed49f67a1e20bd_99156_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post åŠ å£³åŸç†05ï¼šåˆ©ç”¨å›¾ç‰‡éšè—" data-key=learning-packer-05 data-hash="md5-MDpe6FrYJ1wJTfWYit8HkQ==">
</div>
<div class=article-details>
<h2 class=article-title>åŠ å£³åŸç†05ï¼šåˆ©ç”¨å›¾ç‰‡éšè—</h2>
</div>
</a>
</article>
</div>
</div>
</aside>
<link rel=stylesheet href=https://unpkg.com/vssue/dist/vssue.min.css>
<div id=vssue></div>
<script src=https://unpkg.com/vue@2.6.14/dist/vue.runtime.min.js></script>
<script src=https://unpkg.com/vssue@1.4.8/dist/vssue.github.min.js></script>
<script>new Vue({el:"#vssue",render:a=>a("Vssue",{props:{title:"åŠ å£³åŸç†03 - æ”¯æŒæ²¡æœ‰é‡å®šä½çš„ç¨‹åº",options:{autoCreateIssue:!1,owner:"nnnewb",repo:"blog",clientId:"285910fdc1567a1a23e3",clientSecret:"f00da5438d9ac82c4a86024866c7a916ae411edc"}}})})</script>
<footer class=site-footer>
<section class=copyright>
&copy;
2021 -
2022 weakptr's ç¬”è®°
</section>
<section class=powerby>
GitHub Pages <br>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
ä¸»é¢˜ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.11.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è®¾è®¡
ï¼Œç”± <a href=https://nnnewb.github.io/blog/>nnnewb</a> ä¿®æ”¹
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main>
<aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div>
<h2 class="widget-title section-title">ç›®å½•</h2>
<div class=widget--toc>
<nav id=TableOfContents>
<ol>
<li><a href=#å‰è¨€>å‰è¨€</a></li>
<li><a href=#0x01-å…³äºaslr>0x01 å…³äºASLR</a></li>
<li><a href=#0x02-æ€è·¯>0x02 æ€è·¯</a></li>
<li><a href=#0x03-åŠ è½½å™¨ä¿®æ”¹>0x03 åŠ è½½å™¨ä¿®æ”¹</a></li>
<li><a href=#0x04-åŠ å£³å™¨>0x04 åŠ å£³å™¨</a>
<ol>
<li><a href=#41-å·¥å…·å‡½æ•°>4.1 å·¥å…·å‡½æ•°</a></li>
<li><a href=#42-è§£æ>4.2 è§£æ</a></li>
<li><a href=#43-æ„é€ åŠ è½½å™¨>4.3 æ„é€ åŠ è½½å™¨</a></li>
<li><a href=#44-æ„é€ åŠ å£³ç¨‹åº>4.4 æ„é€ åŠ å£³ç¨‹åº</a></li>
<li><a href=#45-å®Œæ•´ä»£ç >4.5 å®Œæ•´ä»£ç </a></li>
</ol>
</li>
<li><a href=#0x05-æˆæœ>0x05 æˆæœ</a></li>
<li><a href=#ç»“è®º>ç»“è®º</a></li>
</ol>
</nav>
</div>
</section>
</aside>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/blog/ts/main.js defer></script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>