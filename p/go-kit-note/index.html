<!doctype html><html lang=zh-cn dir=ltr>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="å‰è¨€ åˆæ­¥çœ‹äº†ä¸‹ gokit çš„æ¡ˆä¾‹ stringsvcå’Œapigatewayï¼Œè®°å½•ä¸€ä¸‹å¯¹ gokit çš„æ˜ åƒã€‚
gokitå®šä½  Go kit is a programming toolkit for building microservices (or elegant monoliths) in Go. We solve common problems in distributed systems and application architecture so you can focus on delivering business value.
Go has emerged as the language of the server, but it remains underrepresented in so-called &amp;ldquo;modern enterprise&amp;rdquo; companies like Facebook, Twitter, Netflix, and SoundCloud. Many of these organizations have turned to JVM-based stacks for their business logic, owing in large part to libraries and ecosystems that directly support their microservice architectures."><title>go-kit ç¬”è®°</title>
<link rel=canonical href=https://nnnewb.github.io/blog/p/go-kit-note/>
<link rel=stylesheet href=/blog/scss/style.min.b80bf249ce4a22cf55e8d7340a0b37a2f2c10f54f3a9a49cb94b694a2eb0bbea.css><meta property="og:title" content="go-kit ç¬”è®°">
<meta property="og:description" content="å‰è¨€ åˆæ­¥çœ‹äº†ä¸‹ gokit çš„æ¡ˆä¾‹ stringsvcå’Œapigatewayï¼Œè®°å½•ä¸€ä¸‹å¯¹ gokit çš„æ˜ åƒã€‚
gokitå®šä½  Go kit is a programming toolkit for building microservices (or elegant monoliths) in Go. We solve common problems in distributed systems and application architecture so you can focus on delivering business value.
Go has emerged as the language of the server, but it remains underrepresented in so-called &amp;ldquo;modern enterprise&amp;rdquo; companies like Facebook, Twitter, Netflix, and SoundCloud. Many of these organizations have turned to JVM-based stacks for their business logic, owing in large part to libraries and ecosystems that directly support their microservice architectures.">
<meta property="og:url" content="https://nnnewb.github.io/blog/p/go-kit-note/">
<meta property="og:site_name" content="weakptr's ç¬”è®°">
<meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="golang"><meta property="article:tag" content="kubernetes"><meta property="article:tag" content="go-kit"><meta property="article:tag" content="å¾®æœåŠ¡"><meta property="article:published_time" content="2022-03-01T12:30:00+08:00"><meta property="article:modified_time" content="2022-03-01T12:30:00+08:00">
<meta name=twitter:title content="go-kit ç¬”è®°">
<meta name=twitter:description content="å‰è¨€ åˆæ­¥çœ‹äº†ä¸‹ gokit çš„æ¡ˆä¾‹ stringsvcå’Œapigatewayï¼Œè®°å½•ä¸€ä¸‹å¯¹ gokit çš„æ˜ åƒã€‚
gokitå®šä½  Go kit is a programming toolkit for building microservices (or elegant monoliths) in Go. We solve common problems in distributed systems and application architecture so you can focus on delivering business value.
Go has emerged as the language of the server, but it remains underrepresented in so-called &amp;ldquo;modern enterprise&amp;rdquo; companies like Facebook, Twitter, Netflix, and SoundCloud. Many of these organizations have turned to JVM-based stacks for their business logic, owing in large part to libraries and ecosystems that directly support their microservice architectures.">
</head>
<body class=article-page>
<script>(function(){const a='StackColorScheme';localStorage.getItem(a)||localStorage.setItem(a,"dark")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky">
<button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box>
<span class=hamburger-inner></span>
</span>
</button>
<header>
<figure class=site-avatar>
<a href=/blog>
<img src=/blog/img/avatar_hub37949326d1692892aa1e64434c0dda6_382115_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a>
<span class=emoji>ğŸ‘</span>
</figure>
<div class=site-meta>
<h1 class=site-name><a href=/blog>weakptr's ç¬”è®°</a></h1>
<h2 class=site-description>å¼ƒèˆ¹ï¼</h2>
</div>
</header><ol class=menu id=main-menu>
<li>
<a href=/blog><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>é¦–é¡µ</span>
</a>
</li>
<li>
<a href=/blog/about><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>å…³äºæˆ‘</span>
</a>
</li>
<li>
<a href=/blog/archive><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>å½’æ¡£</span>
</a>
</li>
<li>
<a href=/blog/categories><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
<span>åˆ†ç±»</span>
</a>
</li>
<div class=menu-bottom-section>
<li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>æš—è‰²æ¨¡å¼</span>
</li>
</div>
</ol>
</aside>
<main class="main full-width">
<article class=main-article>
<header class=article-header>
<div class=article-details>
<header class=article-category>
<a href=/blog/categories/golang/>
golang
</a>
</header>
<div class=article-title-wrapper>
<h2 class=article-title>
<a href=/blog/p/go-kit-note/>go-kit ç¬”è®°</a>
</h2>
</div>
<footer class=article-time>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2022å¹´ 3æœˆ 1æ—¥</time>
</div>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>
é˜…è¯»æ—¶é•¿: 7 åˆ†é’Ÿ
</time>
</div>
</footer>
</div>
</header>
<section class=article-content>
<h2 id=å‰è¨€>å‰è¨€</h2>
<p>åˆæ­¥çœ‹äº†ä¸‹ gokit çš„æ¡ˆä¾‹ <code>stringsvc</code>å’Œ<code>apigateway</code>ï¼Œè®°å½•ä¸€ä¸‹å¯¹ gokit çš„æ˜ åƒã€‚</p>
<h2 id=gokitå®šä½>gokitå®šä½</h2>
<blockquote>
<p><strong>Go kit</strong> is a <strong>programming toolkit</strong> for building microservices (or elegant monoliths) in Go. We solve common problems in distributed systems and application architecture so you can focus on delivering business value.</p>
<p>Go has emerged as the language of the server, but it remains underrepresented in so-called &ldquo;modern enterprise&rdquo; companies like Facebook, Twitter, Netflix, and SoundCloud. Many of these organizations have turned to JVM-based stacks for their business logic, owing in large part to libraries and ecosystems that directly support their microservice architectures.</p>
<p>To reach its next level of success, Go needs more than simple primitives and idioms. It needs a comprehensive toolkit, for coherent distributed programming in the large. Go kit is a set of packages and best practices, which provide a comprehensive, robust, and trustable way of building microservices for organizations of any size.</p>
</blockquote>
<p>gokit å¤§æ¦‚ç®—æ˜¯æ¡†æ¶ï¼Œå› ä¸ºå’Œ gokit æ‰“äº¤é“åŸºæœ¬ç¦»ä¸å¼€ gokit å®šä¹‰çš„å‡ ä¸ªæ¥å£ç±»å‹ã€‚ç”¨ gokit å¼€å‘æœåŠ¡çš„å¯å®šåˆ¶æ€§å¾ˆå¼ºï¼Œå‡ ä¹æ¯ä¸ªç»†èŠ‚éƒ½å¯ä»¥æ§åˆ¶ã€‚</p>
<p>è€Œå®é™…ä¸Šæ‰‹ä½“éªŒä¸‹æ¥ï¼Œç¼ºç‚¹å¤§æ¦‚å°±æ˜¯æµ·é‡çš„æ ·æ¿ä»£ç ï¼Œå®ç°ä¸€ä¸ªæœåŠ¡éœ€è¦å¤§é‡çš„é€‚é…ä»£ç æ¥æ§åˆ¶ Endpoint ã€‚åˆå› ä¸º Go è¯­è¨€è¡¨ç°åŠ›ä¸è¶³ï¼Œä¹Ÿæ²¡æœ‰è¿è¡Œæ—¶å…ƒç¼–ç¨‹çš„èƒ½åŠ›ï¼Œè¿™äº›æ ·æ¿ä»£ç åªèƒ½é ä»£ç ç”Ÿæˆæ¥è§£å†³ã€‚</p>
<p>è¿˜å¥½ gokit è‡ªå·±ä¹ŸçŸ¥é“ï¼Œåœ¨ä»“åº“é¦–é¡µå°±æä¾›äº†å¾ˆå¤šä»£ç ç”Ÿæˆå™¨çš„é“¾æ¥ã€‚</p>
<p>ç”¨ gokit è¿˜æœ‰ä¸€ä¸ªå¥½å¤„æ˜¯ä¸€å®šç¨‹åº¦ä¸Šé¿å…æŠ€æœ¯æ ˆç»‘å®šåœ¨æŸä¸ªç‰¹å®šå¹³å°æˆ–è€…æ¡†æ¶ä¸Šï¼Œæ¯•ç«Ÿ gokit æ¯”èµ·æ¡†æ¶ï¼Œæ›´åƒæ˜¯ä¸€ä¸ªå·¥å…·ç®±ï¼Œç»„ä»¶ä¹‹é—´æ²¡æœ‰ç‰¹åˆ«çš„ä¾èµ–å…³ç³»ï¼Œé¡ºæ‰‹å°±ç”¨ï¼Œä¸é¡ºæ‰‹å¯ä»¥æ¢ä¸ªé”¤å­ã€‚</p>
<h2 id=æ¡†æ¶æ­å»º>æ¡†æ¶æ­å»º</h2>
<h3 id=é¸Ÿç°>é¸Ÿç°</h3>
<p>gokit ç¼–å†™çš„æœåŠ¡æœ‰å‡ ä¸ªåŸºæœ¬å…ƒç´ ï¼Œè¿™äº›åŸºæœ¬å…ƒç´ éƒ½æ˜¯å›´ç»• <strong>Endpoint</strong> æ¥å£è½¬çš„ï¼Œgokit è‡ªå·±æŠŠ Endpoint ç§°ä¸º <em>æ„å»ºæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çš„åŸºæœ¬å—</em> ã€‚</p>
<p>å‡ ä¸ªåŸºæœ¬å…ƒç´ æ˜¯ï¼š</p>
<ul>
<li>æœåŠ¡æ¥å£å®šä¹‰ <code>type StringService interface { /*...*/ }</code></li>
<li>åº”ç”¨çº§ä¸­é—´ä»¶å®šä¹‰ <code>type AppMiddleware struct {} // implement StringService</code></li>
<li>ä¼ è¾“å±‚æ¥å£å®šä¹‰ï¼ŒåŒ…æ‹¬ <code>Endpoint</code> å®šä¹‰ã€åºåˆ—åŒ–ã€æœåŠ¡å‘ç°ç­‰</li>
<li>ä¼ è¾“å±‚ä¸­é—´ä»¶å®šä¹‰ï¼Œ<code>type Middleware func(Endpoint) Endpoint</code></li>
</ul>
<p>æ­¤å¤–è¿˜æœ‰ä¸€äº›å¯é€‰çš„ç»„ä»¶ï¼š</p>
<ul>
<li><code>tracing</code>ï¼Œåˆ†å¸ƒå¼è·Ÿè¸ª</li>
<li><code>ratelimit</code>ï¼Œé™æµ</li>
<li><code>metrics</code>ï¼ŒæŒ‡æ ‡æ”¶é›†</li>
<li><code>log</code>ï¼Œæ—¥å¿—æ”¶é›†</li>
<li><code>circuitbreaker</code>ï¼Œç†”æ–­</li>
<li><code>auth</code>ï¼Œèº«ä»½è®¤è¯</li>
</ul>
<p>æˆ‘è‡ªå·±æ•´çš„ç›®å½•ç»“æ„å¦‚ä¸‹ã€‚</p>
<p><img src=/blog/p/go-kit-note/image-20220228155029310.png width=234 height=255 srcset="/blog/p/go-kit-note/image-20220228155029310_hu1b61ce4442b934d4130680e952a0c52e_9034_480x0_resize_box_3.png 480w, /blog/p/go-kit-note/image-20220228155029310_hu1b61ce4442b934d4130680e952a0c52e_9034_1024x0_resize_box_3.png 1024w" loading=lazy alt=ç›®å½•ç»“æ„ class=gallery-image data-flex-grow=91 data-flex-basis=220px></p>
<p>æœåŠ¡æœ¬è´¨æ˜¯ä¸€ç³»åˆ—æ¥å£çš„é›†åˆï¼Œgokit çš„ tutorial ä¸­å°†æœåŠ¡æŠ½è±¡æˆäº†ä¸€ä¸ª <code>interface</code> ï¼Œåœ¨è¿™ä¸ªæ¥å£ä¸Šç”¨æˆ·å¯ä»¥æä¾›ä¸åŒå®ç°ã€‚åƒæ˜¯æœåŠ¡ç«¯ã€å®¢æˆ·ç«¯ã€ä¸­é—´ä»¶ï¼Œä¸ç®¡ä¼ è¾“å±‚æ€ä¹ˆå®šä¹‰ï¼Œæœ€ç»ˆå®ç°çš„éƒ½æ˜¯è¿™ä¸ªæ¥å£ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>type</span> <span class=nx>StringService</span> <span class=kd>interface</span> <span class=p>{</span>
	<span class=nf>Uppercase</span><span class=p>(</span><span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
	<span class=nf>Count</span><span class=p>(</span><span class=kt>string</span><span class=p>)</span> <span class=kt>int</span>
<span class=p>}</span>
</code></pre></div><p>å¾®æœåŠ¡çš„å¼€å‘è€…æä¾›è¿™ä¸ªæ¥å£çš„å®ç°ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>type</span> <span class=nx>StringServiceImpl</span> <span class=kd>struct</span><span class=p>{}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>StringServiceImpl</span><span class=p>)</span> <span class=nf>Uppercase</span><span class=p>(</span><span class=nx>arg</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=k>if</span> <span class=nx>arg</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=kc>nil</span>
	<span class=p>}</span>
	<span class=k>return</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>ToUpper</span><span class=p>(</span><span class=nx>arg</span><span class=p>),</span> <span class=kc>nil</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>StringServiceImpl</span><span class=p>)</span> <span class=nf>Count</span><span class=p>(</span><span class=nx>arg</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>int</span> <span class=p>{</span>
	<span class=k>return</span> <span class=nb>len</span><span class=p>(</span><span class=nx>arg</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>ç„¶åé€šè¿‡æŸç§ä¼ è¾“å±‚åè®®æš´éœ²ç»™è°ƒç”¨æ–¹ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=nf>MakeUppercaseEndpoint</span><span class=p>(</span><span class=nx>svc</span> <span class=nx>stringsvc1</span><span class=p>.</span><span class=nx>StringService</span><span class=p>)</span> <span class=nx>endpoint</span><span class=p>.</span><span class=nx>Endpoint</span> <span class=p>{</span>
	<span class=k>return</span> <span class=kd>func</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>request</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>(</span><span class=kd>interface</span><span class=p>{},</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
		<span class=nx>req</span> <span class=o>:=</span> <span class=nx>request</span><span class=p>.(</span><span class=nx>UppercaseRequest</span><span class=p>)</span>
		<span class=nx>v</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>svc</span><span class=p>.</span><span class=nf>Uppercase</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>S</span><span class=p>)</span>
		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
		<span class=p>}</span>

		<span class=k>return</span> <span class=o>&amp;</span><span class=nx>UppercaseResponse</span><span class=p>{</span>
			<span class=nx>V</span><span class=p>:</span> <span class=nx>v</span><span class=p>,</span>
		<span class=p>},</span> <span class=kc>nil</span>
	<span class=p>}</span>
<span class=p>}</span>

<span class=c1>// ... ç•¥
</span><span class=c1></span>
<span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
	<span class=nx>logger</span> <span class=o>:=</span> <span class=nx>log</span><span class=p>.</span><span class=nf>NewLogfmtLogger</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Stderr</span><span class=p>)</span>
	<span class=nx>svc</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>stringsvc1</span><span class=p>.</span><span class=nx>StringServiceImpl</span><span class=p>{}</span>

	<span class=nx>uppercase</span> <span class=o>:=</span> <span class=nx>transport</span><span class=p>.</span><span class=nf>MakeUppercaseEndpoint</span><span class=p>(</span><span class=nx>svc</span><span class=p>)</span>
	<span class=nx>uppercaseHandler</span> <span class=o>:=</span> <span class=nx>httptransport</span><span class=p>.</span><span class=nf>NewServer</span><span class=p>(</span><span class=nx>uppercase</span><span class=p>,</span> <span class=nx>transport</span><span class=p>.</span><span class=nx>DecodeUppercaseRequest</span><span class=p>,</span> <span class=nx>transport</span><span class=p>.</span><span class=nx>EncodeResponse</span><span class=p>)</span>
	<span class=nx>http</span><span class=p>.</span><span class=nf>Handle</span><span class=p>(</span><span class=s>&#34;/uppercase&#34;</span><span class=p>,</span> <span class=nx>uppercaseHandler</span><span class=p>)</span>

	<span class=nx>count</span> <span class=o>:=</span> <span class=nx>transport</span><span class=p>.</span><span class=nf>MakeCountEndpoint</span><span class=p>(</span><span class=nx>svc</span><span class=p>)</span>
	<span class=nx>countHandler</span> <span class=o>:=</span> <span class=nx>httptransport</span><span class=p>.</span><span class=nf>NewServer</span><span class=p>(</span><span class=nx>count</span><span class=p>,</span> <span class=nx>transport</span><span class=p>.</span><span class=nx>DecodeCountRequest</span><span class=p>,</span> <span class=nx>transport</span><span class=p>.</span><span class=nx>EncodeResponse</span><span class=p>)</span>
	<span class=nx>http</span><span class=p>.</span><span class=nf>Handle</span><span class=p>(</span><span class=s>&#34;/count&#34;</span><span class=p>,</span> <span class=nx>countHandler</span><span class=p>)</span>

	<span class=nx>logger</span><span class=p>.</span><span class=nf>Log</span><span class=p>(</span><span class=s>&#34;msg&#34;</span><span class=p>,</span> <span class=s>&#34;HTTP&#34;</span><span class=p>,</span> <span class=s>&#34;addr&#34;</span><span class=p>,</span> <span class=s>&#34;:8080&#34;</span><span class=p>)</span>
	<span class=nx>logger</span><span class=p>.</span><span class=nf>Log</span><span class=p>(</span><span class=s>&#34;err&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>(</span><span class=s>&#34;:8080&#34;</span><span class=p>,</span> <span class=kc>nil</span><span class=p>))</span>
<span class=p>}</span>
</code></pre></div><p>ä¸€ä¸ªç®€å•çš„æœåŠ¡æä¾›æ–¹éœ€è¦åšçš„å°±æ˜¯è¿™äº›ã€‚ä¸‹é¢å…·ä½“çœ‹çœ‹å…¶ä¸­æ¶‰åŠçš„æ¦‚å¿µã€‚</p>
<h3 id=endpoint-è§£æ>endpoint è§£æ</h3>
<p>ä¸€ä¸ªæœ€ç®€å•çš„æœåŠ¡ <code>Endpoint</code> å®šä¹‰å¦‚ä¸‹ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>main</span>

<span class=kn>import</span> <span class=p>(</span>
	<span class=s>&#34;context&#34;</span>
	<span class=s>&#34;encoding/json&#34;</span>
	<span class=s>&#34;net/http&#34;</span>
	<span class=s>&#34;os&#34;</span>
	<span class=s>&#34;strings&#34;</span>

	<span class=nx>httptransport</span> <span class=s>&#34;github.com/go-kit/kit/transport/http&#34;</span>
	<span class=s>&#34;github.com/go-kit/log&#34;</span>
<span class=p>)</span>

<span class=kd>type</span> <span class=nx>uppercaseRequest</span> <span class=kd>struct</span> <span class=p>{</span>
	<span class=nx>S</span> <span class=kt>string</span> <span class=s>`json:&#34;s,omitempty&#34;`</span>
<span class=p>}</span>

<span class=kd>type</span> <span class=nx>uppercaseResponse</span> <span class=kd>struct</span> <span class=p>{</span>
	<span class=nx>S</span> <span class=kt>string</span> <span class=s>`json:&#34;s,omitempty&#34;`</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
	<span class=nx>logger</span> <span class=o>:=</span> <span class=nx>log</span><span class=p>.</span><span class=nf>NewLogfmtLogger</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Stderr</span><span class=p>)</span>

	<span class=nx>http</span><span class=p>.</span><span class=nf>Handle</span><span class=p>(</span><span class=s>&#34;/uppercase&#34;</span><span class=p>,</span> <span class=nx>httptransport</span><span class=p>.</span><span class=nf>NewServer</span><span class=p>(</span>
		<span class=c1>// endpoint å®šä¹‰
</span><span class=c1></span>		<span class=kd>func</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>request</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>(</span><span class=nx>response</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
			<span class=nx>req</span> <span class=o>:=</span> <span class=nx>request</span><span class=p>.(</span><span class=nx>uppercaseRequest</span><span class=p>)</span>
			<span class=k>if</span> <span class=nx>req</span><span class=p>.</span><span class=nx>S</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
				<span class=k>return</span> <span class=nx>uppercaseResponse</span><span class=p>{</span><span class=s>&#34;&#34;</span><span class=p>},</span> <span class=kc>nil</span>
			<span class=p>}</span>
			<span class=k>return</span> <span class=nx>uppercaseResponse</span><span class=p>{</span><span class=nx>strings</span><span class=p>.</span><span class=nf>ToUpper</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>S</span><span class=p>)},</span> <span class=kc>nil</span>
		<span class=p>},</span>
		<span class=c1>// è¯·æ±‚ decoder
</span><span class=c1></span>		<span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>(</span><span class=kd>interface</span><span class=p>{},</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
			<span class=kd>var</span> <span class=nx>request</span> <span class=nx>uppercaseRequest</span>
			<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>NewDecoder</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Body</span><span class=p>).</span><span class=nf>Decode</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>request</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
				<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
			<span class=p>}</span>
			<span class=k>return</span> <span class=nx>request</span><span class=p>,</span> <span class=kc>nil</span>
		<span class=p>},</span>
		<span class=c1>// å“åº” encoder
</span><span class=c1></span>		<span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>response</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>error</span> <span class=p>{</span>
			<span class=k>return</span> <span class=nx>json</span><span class=p>.</span><span class=nf>NewEncoder</span><span class=p>(</span><span class=nx>w</span><span class=p>).</span><span class=nf>Encode</span><span class=p>(</span><span class=nx>response</span><span class=p>)</span>
		<span class=p>},</span>
	<span class=p>))</span>

	<span class=nx>logger</span><span class=p>.</span><span class=nf>Log</span><span class=p>(</span><span class=s>&#34;msg&#34;</span><span class=p>,</span> <span class=s>&#34;HTTP&#34;</span><span class=p>,</span> <span class=s>&#34;addr&#34;</span><span class=p>,</span> <span class=s>&#34;:8080&#34;</span><span class=p>)</span>
	<span class=nx>logger</span><span class=p>.</span><span class=nf>Log</span><span class=p>(</span><span class=s>&#34;err&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>(</span><span class=s>&#34;:8080&#34;</span><span class=p>,</span> <span class=kc>nil</span><span class=p>))</span>
<span class=p>}</span>

</code></pre></div><p><code>Endpoint</code> æœ¬è´¨æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œç±»å‹ç­¾åå¦‚ä¸‹ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// Endpoint is the fundamental building block of servers and clients.
</span><span class=c1>// It represents a single RPC method.
</span><span class=c1></span><span class=kd>type</span> <span class=nx>Endpoint</span> <span class=kd>func</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>request</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>(</span><span class=nx>response</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span>
</code></pre></div><p><code>Endpoint</code> æŠ½è±¡äº† RPC è°ƒç”¨ï¼Œéšè—äº†è°ƒç”¨å¯¹è±¡æ˜¯â€œæœ¬åœ°â€è¿˜æ˜¯â€œè¿œç¨‹â€çš„ã€‚åƒæ˜¯ä¸Šé¢çš„æ¡ˆä¾‹é‡Œï¼Œ<code>Endpoint</code> èƒŒåæ˜¯æœ¬åœ°çš„ä»£ç ã€‚è€Œåœ¨å®¢æˆ·ç«¯ä½¿ç”¨<code>Endpoint</code>æ—¶ï¼Œ<code>Endpoint</code>çš„èƒŒåå¾€å¾€æ˜¯ä¼ è¾“å±‚ä»£ç ï¼Œå‘èµ·äº†ä¸€æ¬¡è¿œç¨‹è°ƒç”¨ã€‚</p>
<p><code>Endpoint</code> æœ¬èº«ä¸åšè¯·æ±‚/å“åº”çš„ç¼–è§£ç å·¥ä½œï¼Œè¿›å…¥ <code>Endpoint</code> çš„éƒ½æ˜¯å·²ç»å‡†å¤‡å¥½çš„ç»“æ„åŒ–æ•°æ®ã€‚</p>
<h3 id=endpointmiddleware-è§£æ>endpoint.Middleware è§£æ</h3>
<p><code>endpoint.Middleware</code> æ˜¯åœ¨ <code>Endpoint</code> ä¸ŠåŒ…è£…çš„ä¸­é—´ä»¶ï¼Œç­¾åå¦‚ä¸‹ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// Middleware is a chainable behavior modifier for endpoints.
</span><span class=c1></span><span class=kd>type</span> <span class=nx>Middleware</span> <span class=kd>func</span><span class=p>(</span><span class=nx>Endpoint</span><span class=p>)</span> <span class=nx>Endpoint</span>
</code></pre></div><p>å’Œ <code>gin</code> ä¹‹ç±»çš„æ¡†æ¶ä¸­é—´ä»¶ä½“ç³»å¾ˆç›¸ä¼¼ï¼Œéƒ½æ˜¯åŸºäºé«˜é˜¶å‡½æ•°çš„æ–¹å¼ã€‚ä¸€ä¸ªç®€å•çš„æ—¥å¿—ä¸­é—´ä»¶å®ç°å¦‚ä¸‹ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kn>import</span> <span class=p>(</span>
	<span class=s>&#34;context&#34;</span>

	<span class=s>&#34;github.com/go-kit/kit/endpoint&#34;</span>
	<span class=s>&#34;github.com/go-kit/log&#34;</span>
<span class=p>)</span>

<span class=kd>func</span> <span class=nf>LoggingMiddleware</span><span class=p>(</span><span class=nx>logger</span> <span class=nx>log</span><span class=p>.</span><span class=nx>Logger</span><span class=p>)</span> <span class=nx>endpoint</span><span class=p>.</span><span class=nx>Middleware</span> <span class=p>{</span>
	<span class=k>return</span> <span class=kd>func</span><span class=p>(</span><span class=nx>next</span> <span class=nx>endpoint</span><span class=p>.</span><span class=nx>Endpoint</span><span class=p>)</span> <span class=nx>endpoint</span><span class=p>.</span><span class=nx>Endpoint</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kd>func</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>request</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>(</span><span class=kd>interface</span><span class=p>{},</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
			<span class=nx>logger</span><span class=p>.</span><span class=nf>Log</span><span class=p>(</span><span class=s>&#34;msg&#34;</span><span class=p>,</span> <span class=s>&#34;calling endpoint&#34;</span><span class=p>)</span>
			<span class=k>defer</span> <span class=nx>logger</span><span class=p>.</span><span class=nf>Log</span><span class=p>(</span><span class=s>&#34;msg&#34;</span><span class=p>,</span> <span class=s>&#34;called endpoint&#34;</span><span class=p>)</span>
			<span class=k>return</span> <span class=nf>next</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>request</span><span class=p>)</span>
		<span class=p>}</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>åƒè¿™æ ·å®šä¹‰çš„ä¸­é—´ä»¶ç”¨æ³•ä¹Ÿå¾ˆç®€å•ï¼Œä»¥ <code>Endpoint</code> ä¸ºå‚æ•°è°ƒç”¨å³å¯ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=nf>LoggingMiddleware</span><span class=p>(</span><span class=nx>log</span><span class=p>.</span><span class=nf>With</span><span class=p>(</span><span class=nx>logger</span><span class=p>,</span> <span class=s>&#34;method&#34;</span><span class=p>,</span> <span class=s>&#34;method-name&#34;</span><span class=p>))(</span><span class=nx>endpoint</span><span class=p>)</span>
</code></pre></div><p>è¯´èµ·è¿™ä¸ªæˆ‘å°±æ€€å¿µ python çš„è£…é¥°å™¨ã€‚</p>
<h3 id=åº”ç”¨ä¸­é—´ä»¶>åº”ç”¨ä¸­é—´ä»¶</h3>
<p>åº”ç”¨ä¸­é—´ä»¶ä¸ç®—æ˜¯ gokit çš„ä¸€éƒ¨åˆ†ï¼Œgokit çš„ç¤ºä¾‹ä¸­ç»™å‡ºäº†<a class=link href=http://gokit.io/examples/stringsvc.html#application-logging target=_blank rel=noopener>åº”ç”¨çº§ä¸­é—´ä»¶çš„åšæ³•</a>ã€‚å®è¯è¯´æˆ‘ä¸å–œæ¬¢ã€‚</p>
<p>æ‰€è°“çš„åº”ç”¨ä¸­é—´ä»¶åšæ³•å…¶å®å°±æ˜¯å†å®šä¹‰ä¸€ä¸ªç»“æ„ï¼Œå®ç°ä½ çš„æœåŠ¡æ¥å£ï¼Œç„¶ååœ¨å®ç°çš„æœåŠ¡æ¥å£é‡ŒåŠ ä¸Šéœ€è¦çš„ä¸­é—´ä»¶ä»£ç ã€‚</p>
<p>å¦‚æœè¦è¯´æœ‰ä»€ä¹ˆå¥½å¤„çš„è¯ï¼Œå°±æ˜¯æ»¡è¶³äº†ç±»å‹çº¦æŸï¼Œå…å»äº†ç”¨ <code>reflect</code>ã€‚<code>Endpoint</code>ä¸€çº§çš„ä¸­é—´ä»¶åªèƒ½æ‹¿åˆ°ä¸€ä¸ª <code>request interface{}</code> ï¼Œä½†ä¸‹é¢è¿™æ ·å†™çš„è¯ï¼Œå‚æ•°å°±æ˜¯å·²ç»å¡«å¥½çš„äº†ï¼ŒæœåŠ¡å®ç°é‡Œæ‹¿åˆ°ä»€ä¹ˆå‚æ•°è¿™ä¸ªä¸­é—´ä»¶å°±æ‹¿åˆ°ä»€ä¹ˆå‚æ•°ã€‚ä½†é—®é¢˜ä¹Ÿå¾ˆæ˜æ˜¾â€”â€”ä¸ºäº†æ»¡è¶³ <code>type Service interface</code> çš„çº¦æŸï¼Œè¿™æ ·çš„ä¸­é—´ä»¶å¿…é¡»æŠŠæœåŠ¡çš„æ‰€æœ‰æ¥å£éƒ½å†™ä¸ª stub ã€‚å°±ç®—æ˜¯ç”¨ç¼–è¾‘å™¨çš„ <code>generate interface stubs</code> åŠŸèƒ½ä¹Ÿæ²¡æ³•ç›´æ¥å¸®ä½ å¡«å¥½è½¬å‘å‚æ•°çš„ä»£ç å•Š&mldr;</p>
<p>æˆ‘è‡ªå·±å€’æ˜¯æŠ˜è…¾å‡ºä¸€ä¸ªæœ‰ç‚¹æ€ªçš„è§£æ³•ï¼Œåˆ©ç”¨ go çš„ embed å­—æ®µå’ŒåŠ¨æ€åˆ†å‘æœºåˆ¶ï¼Œéƒ¨åˆ†å®ç°äº†æœ‰ç»§æ‰¿çš„è¯­è¨€é‡Œçš„ override ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kn>import</span> <span class=p>(</span>
	<span class=s>&#34;play/stringsvc1&#34;</span>

	<span class=s>&#34;github.com/go-kit/log&#34;</span>
<span class=p>)</span>

<span class=kd>type</span> <span class=nx>LoggingMiddleware</span> <span class=kd>struct</span> <span class=p>{</span>
	<span class=nx>stringsvc1</span><span class=p>.</span><span class=nx>StringService</span> <span class=c1>// LoggingMiddleware è‡ªå·±æ²¡æœ‰å®ç°å…¨éƒ¨çš„ stringsvc1.StringService æ¥å£ï¼Œä½†è¿™ä¸ª embed å­—æ®µå®ç°äº†
</span><span class=c1></span>	<span class=nx>Logger</span> <span class=nx>log</span><span class=p>.</span><span class=nx>Logger</span>
<span class=p>}</span>

<span class=c1>// è¿™ä¸ªå®ç°è¦†ç›–æ‰äº†ç»“æ„é‡Œçš„ stringsvc1.StringService.Uppercase æš´éœ²çš„å®ç°
</span><span class=c1>// ç„¶åå†…éƒ¨åˆä½¿ç”¨äº† `.StringService.Uppercase` è¿™ç§è¯­æ³•æ¥è°ƒç”¨ç»“æ„é‡Œçš„ 
</span><span class=c1>// stringsvc1.StringService.Uppercase å®ç°
</span><span class=c1>// å°±åƒæ˜¯æœ‰ç»§æ‰¿çš„è¯­è¨€é‡Œå­ç±»é€šè¿‡ super() æˆ–è€… ParentClass::Uppercase è¿™æ ·çš„æ–¹å¼è°ƒç”¨çˆ¶ç±»å®ç°ä¸€æ ·ã€‚
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>m</span> <span class=o>*</span><span class=nx>LoggingMiddleware</span><span class=p>)</span> <span class=nf>Uppercase</span><span class=p>(</span><span class=nx>s</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>m</span><span class=p>.</span><span class=nx>Logger</span><span class=p>.</span><span class=nf>Log</span><span class=p>(</span><span class=s>&#34;msg&#34;</span><span class=p>,</span> <span class=s>&#34;call endpoint&#34;</span><span class=p>,</span> <span class=s>&#34;arg&#34;</span><span class=p>,</span> <span class=nx>s</span><span class=p>)</span>
	<span class=k>defer</span> <span class=nx>m</span><span class=p>.</span><span class=nx>Logger</span><span class=p>.</span><span class=nf>Log</span><span class=p>(</span><span class=s>&#34;msg&#34;</span><span class=p>,</span> <span class=s>&#34;called endpoint&#34;</span><span class=p>,</span> <span class=s>&#34;arg&#34;</span><span class=p>,</span> <span class=nx>s</span><span class=p>)</span>
	<span class=k>return</span> <span class=nx>m</span><span class=p>.</span><span class=nx>StringService</span><span class=p>.</span><span class=nf>Uppercase</span><span class=p>(</span><span class=nx>s</span><span class=p>)</span>
<span class=p>}</span>

</code></pre></div><p>é€šè¿‡è¿™ç§åŠæ³•å€’æ˜¯å®ç°äº†åº”ç”¨çº§çš„ç‰¹å®šæ¥å£ä¸­é—´ä»¶ã€‚ä½†è¿˜è¦å¦å¤–å®šä¹‰ä¸€ä¸ª <code>struct</code> ä¹Ÿæ¯”è¾ƒéº»çƒ¦ã€‚</p>
<p>è´´ä¸€ä¸‹ç¤ºä¾‹é‡Œçš„ä»£ç ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// middleware.go
</span><span class=c1></span><span class=kd>type</span> <span class=nx>loggingMiddleware</span> <span class=kd>struct</span> <span class=p>{</span>
	<span class=nx>logger</span> <span class=nx>log</span><span class=p>.</span><span class=nx>Logger</span>
	<span class=nx>next</span>   <span class=nx>StringService</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>mw</span> <span class=nx>loggingMiddleware</span><span class=p>)</span> <span class=nf>Uppercase</span><span class=p>(</span><span class=nx>s</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>output</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=k>defer</span> <span class=kd>func</span><span class=p>(</span><span class=nx>begin</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>)</span> <span class=p>{</span>
		<span class=nx>mw</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nf>Log</span><span class=p>(</span>
			<span class=s>&#34;method&#34;</span><span class=p>,</span> <span class=s>&#34;uppercase&#34;</span><span class=p>,</span>
			<span class=s>&#34;input&#34;</span><span class=p>,</span> <span class=nx>s</span><span class=p>,</span>
			<span class=s>&#34;output&#34;</span><span class=p>,</span> <span class=nx>output</span><span class=p>,</span>
			<span class=s>&#34;err&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>,</span>
			<span class=s>&#34;took&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Since</span><span class=p>(</span><span class=nx>begin</span><span class=p>),</span>
		<span class=p>)</span>
	<span class=p>}(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>())</span>

	<span class=nx>output</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>mw</span><span class=p>.</span><span class=nx>next</span><span class=p>.</span><span class=nf>Uppercase</span><span class=p>(</span><span class=nx>s</span><span class=p>)</span>
	<span class=k>return</span>
<span class=p>}</span>
</code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// main.go
</span><span class=c1></span><span class=kn>import</span> <span class=p>(</span>
	<span class=s>&#34;os&#34;</span>

	<span class=s>&#34;github.com/go-kit/kit/log&#34;</span>
	<span class=nx>httptransport</span> <span class=s>&#34;github.com/go-kit/kit/transport/http&#34;</span>
<span class=p>)</span>

<span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
	<span class=nx>logger</span> <span class=o>:=</span> <span class=nx>log</span><span class=p>.</span><span class=nf>NewLogfmtLogger</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Stderr</span><span class=p>)</span>

	<span class=kd>var</span> <span class=nx>svc</span> <span class=nx>StringService</span>
	<span class=nx>svc</span> <span class=p>=</span> <span class=nx>stringService</span><span class=p>{}</span>
	<span class=nx>svc</span> <span class=p>=</span> <span class=nx>loggingMiddleware</span><span class=p>{</span><span class=nx>logger</span><span class=p>,</span> <span class=nx>svc</span><span class=p>}</span>

	<span class=c1>// ...
</span><span class=c1></span>
	<span class=nx>uppercaseHandler</span> <span class=o>:=</span> <span class=nx>httptransport</span><span class=p>.</span><span class=nf>NewServer</span><span class=p>(</span>
		<span class=nf>makeUppercaseEndpoint</span><span class=p>(</span><span class=nx>svc</span><span class=p>),</span>
		<span class=c1>// ...
</span><span class=c1></span>	<span class=p>)</span>
<span class=p>}</span>
</code></pre></div><h3 id=å®¢æˆ·ç«¯å®ç°>å®¢æˆ·ç«¯å®ç°</h3>
<p>å®¢æˆ·ç«¯å®ç°å¯ä»¥å¾ˆç®€å•ï¼ŒåŒæ ·æœ‰å¾ˆå¼ºçš„æ‰©å±•æ€§ã€‚æ¯”å¦‚è¯´å¯ä»¥ç»“åˆæœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€é¢‘ç‡é™åˆ¶ã€ç†”æ–­å™¨å®ç°ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„å®¢æˆ·ç«¯ã€‚</p>
<p>å…ˆä»ç®€å•çš„å¼€å§‹ã€‚ä¸€èˆ¬è€ƒè™‘å®¢æˆ·ç«¯å®ç°çš„è¯ï¼Œä¼šå‡†å¤‡ä¸€ä¸ªç‰¹æ®Šçš„ç»“æ„æ¥ä¿å­˜æœåŠ¡çš„ <code>Endpoint</code>ï¼Œå†å¯¹è¿™ä¸ªç»“æ„å®ç°æœåŠ¡å®šä¹‰çš„æ¥å£ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// https://github.com/go-kit/examples/blob/master/addsvc/pkg/addendpoint/set.go
</span><span class=c1></span>
<span class=c1>// Set collects all of the endpoints that compose an add service. It&#39;s meant to
</span><span class=c1>// be used as a helper struct, to collect all of the endpoints into a single
</span><span class=c1>// parameter.
</span><span class=c1></span><span class=kd>type</span> <span class=nx>Set</span> <span class=kd>struct</span> <span class=p>{</span>
	<span class=nx>SumEndpoint</span>    <span class=nx>endpoint</span><span class=p>.</span><span class=nx>Endpoint</span>
	<span class=nx>ConcatEndpoint</span> <span class=nx>endpoint</span><span class=p>.</span><span class=nx>Endpoint</span>
<span class=p>}</span>

<span class=c1>// Sum implements the service interface, so Set may be used as a service.
</span><span class=c1>// This is primarily useful in the context of a client library.
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=nx>Set</span><span class=p>)</span> <span class=nf>Sum</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>a</span><span class=p>,</span> <span class=nx>b</span> <span class=kt>int</span><span class=p>)</span> <span class=p>(</span><span class=kt>int</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>resp</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>SumEndpoint</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>SumRequest</span><span class=p>{</span><span class=nx>A</span><span class=p>:</span> <span class=nx>a</span><span class=p>,</span> <span class=nx>B</span><span class=p>:</span> <span class=nx>b</span><span class=p>})</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>
	<span class=nx>response</span> <span class=o>:=</span> <span class=nx>resp</span><span class=p>.(</span><span class=nx>SumResponse</span><span class=p>)</span>
	<span class=k>return</span> <span class=nx>response</span><span class=p>.</span><span class=nx>V</span><span class=p>,</span> <span class=nx>response</span><span class=p>.</span><span class=nx>Err</span>
<span class=p>}</span>

<span class=c1>// ... ç•¥
</span></code></pre></div><p>è¿™ä¹ˆåšçš„å¥½å¤„æ˜¯å¯ä»¥åƒæ˜¯è°ƒç”¨ Go æ–¹æ³•ä¸€æ ·å»è°ƒç”¨ RPC å‡½æ•°ï¼Œæ¯”èµ· <code>grpc</code> ä¸€ç±»çš„è°ƒç”¨æ–¹å¼æ¥è¯´æ›´ç›´è§‚äº†ã€‚</p>
<p>å®¢æˆ·ç«¯çš„ <code>Endpoint</code> çš„æ„é€ æ–¹å¼å’ŒæœåŠ¡å™¨ä¸ä¸€æ ·ï¼Œéšè—åœ¨ <code>Endpoint</code> èƒŒåçš„ä¸æ˜¯æœ¬åœ°ä»£ç ï¼Œè€Œæ˜¯ä¸€ä¸ªç½‘ç»œè¯·æ±‚ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// Each individual endpoint is an http/transport.Client (which implements
</span><span class=c1>// endpoint.Endpoint) that gets wrapped with various middlewares. If you
</span><span class=c1>// made your own client library, you&#39;d do this work there, so your server
</span><span class=c1>// could rely on a consistent set of client behavior.
</span><span class=c1></span><span class=kd>var</span> <span class=nx>sumEndpoint</span>  <span class=p>=</span> <span class=nx>httptransport</span><span class=p>.</span><span class=nf>NewClient</span><span class=p>(</span>
    <span class=s>&#34;POST&#34;</span><span class=p>,</span>
    <span class=nf>copyURL</span><span class=p>(</span><span class=nx>u</span><span class=p>,</span> <span class=s>&#34;/sum&#34;</span><span class=p>),</span>
    <span class=nx>encodeHTTPGenericRequest</span><span class=p>,</span>
    <span class=nx>decodeHTTPSumResponse</span><span class=p>,</span>
<span class=p>).</span><span class=nf>Endpoint</span><span class=p>()</span>
</code></pre></div><p><code>github.com/go-kit/kit/transport</code> è¿™ä¸ªåŒ…æä¾›äº†å¾ˆå¤šæœ‰ç”¨çš„åŠ©æ‰‹å‡½æ•°æ¥å¸®åŠ©æ„é€  <code>Endpoint</code> ï¼Œä»¥åŠé»åˆæœåŠ¡ç«¯çš„ <code>Endpoint</code> åˆ°ä¼ è¾“å±‚ä»£ç ã€‚ï¼ˆPSï¼šè¯·å›é¡¾å‰æ–‡ä¸­ä½¿ç”¨çš„ <code>httptransport.NewServer</code>ï¼‰</p>
<h3 id=æœåŠ¡å‘ç°>æœåŠ¡å‘ç°</h3>
<p>å‚è€ƒ <a class=link href=https://github.com/go-kit/examples/blob/master/apigateway/main.go target=_blank rel=noopener>apigateway</a> çš„ä»£ç ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// Each method gets constructed with a factory. Factories take an
</span><span class=c1>// instance string, and return a specific endpoint. In the factory we
</span><span class=c1>// dial the instance string we get from Consul, and then leverage an
</span><span class=c1>// addsvc client package to construct a complete service. We can then
</span><span class=c1>// leverage the addsvc.Make{Sum,Concat}Endpoint constructors to convert
</span><span class=c1>// the complete service to specific endpoint.
</span><span class=c1></span><span class=kd>var</span> <span class=p>(</span>
    <span class=nx>tags</span>        <span class=p>=</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{}</span>
    <span class=nx>passingOnly</span> <span class=p>=</span> <span class=kc>true</span>
    <span class=nx>endpoints</span>   <span class=p>=</span> <span class=nx>addendpoint</span><span class=p>.</span><span class=nx>Set</span><span class=p>{}</span>
    <span class=nx>instancer</span>   <span class=p>=</span> <span class=nx>consulsd</span><span class=p>.</span><span class=nf>NewInstancer</span><span class=p>(</span><span class=nx>client</span><span class=p>,</span> <span class=nx>logger</span><span class=p>,</span> <span class=s>&#34;addsvc&#34;</span><span class=p>,</span> <span class=nx>tags</span><span class=p>,</span> <span class=nx>passingOnly</span><span class=p>)</span>
<span class=p>)</span>
<span class=p>{</span>
    <span class=nx>factory</span> <span class=o>:=</span> <span class=nf>addsvcFactory</span><span class=p>(</span><span class=nx>addendpoint</span><span class=p>.</span><span class=nx>MakeSumEndpoint</span><span class=p>,</span> <span class=nx>tracer</span><span class=p>,</span> <span class=nx>zipkinTracer</span><span class=p>,</span> <span class=nx>logger</span><span class=p>)</span>
    <span class=nx>endpointer</span> <span class=o>:=</span> <span class=nx>sd</span><span class=p>.</span><span class=nf>NewEndpointer</span><span class=p>(</span><span class=nx>instancer</span><span class=p>,</span> <span class=nx>factory</span><span class=p>,</span> <span class=nx>logger</span><span class=p>)</span>
    <span class=nx>balancer</span> <span class=o>:=</span> <span class=nx>lb</span><span class=p>.</span><span class=nf>NewRoundRobin</span><span class=p>(</span><span class=nx>endpointer</span><span class=p>)</span>
    <span class=nx>retry</span> <span class=o>:=</span> <span class=nx>lb</span><span class=p>.</span><span class=nf>Retry</span><span class=p>(</span><span class=o>*</span><span class=nx>retryMax</span><span class=p>,</span> <span class=o>*</span><span class=nx>retryTimeout</span><span class=p>,</span> <span class=nx>balancer</span><span class=p>)</span>
    <span class=nx>endpoints</span><span class=p>.</span><span class=nx>SumEndpoint</span> <span class=p>=</span> <span class=nx>retry</span>
<span class=p>}</span>
</code></pre></div><p><img src=/blog/p/go-kit-note/image-20220228171821569.png width=925 height=573 srcset="/blog/p/go-kit-note/image-20220228171821569_hude2acf9d66679c44454b1c6e5dc1473c_66465_480x0_resize_box_3.png 480w, /blog/p/go-kit-note/image-20220228171821569_hude2acf9d66679c44454b1c6e5dc1473c_66465_1024x0_resize_box_3.png 1024w" loading=lazy alt=ç¤ºæ„å›¾ class=gallery-image data-flex-grow=161 data-flex-basis=387px></p>
<p>æ€»å¾—æ¥è¯´ï¼Œgo kit çš„æœåŠ¡å‘ç°æœºåˆ¶é å®¢æˆ·ç«¯ä»¥ç‰¹å®šçš„æ–¹å¼æ„é€  <code>Endpoint</code> ï¼Œè¿™å’Œåå‘ä»£ç†æˆ–è€… side-car ä»£ç†å®ç°çš„æœåŠ¡å‘ç°ä¸ä¸€æ ·ã€‚</p>
<p>æ¯”å¦‚è¯´ kubernetes çš„ ClusterIP åŸºäº kube-proxyï¼Œåç«¯æœ‰å¤šä¸ª POD çš„æ—¶å€™ kube-proxy ä¼šè‡ªåŠ¨è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œä½†ç®—æ³•æ˜¯ kube-proxy å®ç°å†³å®šçš„ï¼Œä¸å¯ä¾èµ–ã€‚</p>
<p>å†æ¯”å¦‚ nginx ä¹Ÿèƒ½ä¸€å®šç¨‹åº¦å®ç°æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ã€‚</p>
<p>å†æ¯”å¦‚ï¼Œlinkerd è¿™æ ·çš„ service meshï¼Œéä¾µå…¥ï¼Œæä¾›è´Ÿè½½å‡è¡¡ã€æœåŠ¡å‘ç°ã€é‡è¯•è¿™äº›åŠŸèƒ½ã€‚</p>
<p>go kit çš„å·¥å…·ç®±é‡Œæä¾›çš„æ˜¯å®¢æˆ·ç«¯çš„è´Ÿè½½å‡è¡¡æœºåˆ¶ã€‚ä¸Šå›¾é‡Œçš„ä»£ç å¯ä»¥ç”¨ä¸‹å›¾è¡¨ç¤ºã€‚</p>
<p><img src=/blog/p/go-kit-note/image-20220228172730622.png width=574 height=626 srcset="/blog/p/go-kit-note/image-20220228172730622_hu7c2f12e783b3c572c3387446a921feeb_14775_480x0_resize_box_3.png 480w, /blog/p/go-kit-note/image-20220228172730622_hu7c2f12e783b3c572c3387446a921feeb_14775_1024x0_resize_box_3.png 1024w" loading=lazy alt=è´Ÿè½½å‡è¡¡ class=gallery-image data-flex-grow=91 data-flex-basis=220px></p>
<h3 id=å¤šä¼ è¾“å±‚å®ç°>å¤šä¼ è¾“å±‚å®ç°</h3>
<p>è¿™é‡Œå°è¯•å®ç° <code>http</code> å’Œ <code>grpc</code> ä¸¤ç§ rpc ä¼ è¾“å±‚åè®®ã€‚é¦–å…ˆä¸ºäº†ä¿è¯æœ€å¤§åŒ–å¤ç”¨ä»£ç ï¼Œåœ¨ <code>http</code> å®ç°ä¸­å®šä¹‰çš„ç»“æ„å’Œ endpoint è‚¯å®šæ˜¯è¦å¤ç”¨èµ·æ¥çš„ï¼Œä¸ç„¶æ¯ä¸ªä¼ è¾“å±‚éƒ½æ¥ä¸€æ¬¡çš„è¯æ²¡codegenéå¾—æ‰‹æŒ‡æ•²æ–­ä¸å¯ã€‚</p>
<p>å…ˆæå– <code>makeXXXEndpoint</code> ä»£ç å’Œ <code>XXXRequest</code> è¿™æ ·çš„ç»“æ„åˆ°å•ç‹¬çš„æ–‡ä»¶é‡Œã€‚</p>
<p><img src=/blog/p/go-kit-note/image-20220301115635464.png width=1920 height=1040 srcset="/blog/p/go-kit-note/image-20220301115635464_hu2db5290091178b734e80b60459e1fef9_216608_480x0_resize_box_3.png 480w, /blog/p/go-kit-note/image-20220301115635464_hu2db5290091178b734e80b60459e1fef9_216608_1024x0_resize_box_3.png 1024w" loading=lazy alt=æå–å®šä¹‰ class=gallery-image data-flex-grow=184 data-flex-basis=443px></p>
<p>æ€è·¯ä¸Šéƒ¨åˆ†å‚è€ƒçš„ gokit æ¡ˆä¾‹ä¸­ <code>addsvc</code>ï¼Œ<a class=link href=https://github.com/go-kit/examples/blob/master/addsvc/README.md target=_blank rel=noopener>é“¾æ¥</a>ã€‚</p>
<p>proto æ–‡ä»¶å¦‚ä¸‹ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=c1>// play/stringsvc/transport/pb/stringsvc.proto
</span><span class=c1></span><span class=n>syntax</span> <span class=o>=</span> <span class=s>&#34;proto3&#34;</span><span class=p>;</span><span class=err>
</span><span class=err></span><span class=k>option</span> <span class=n>go_package</span> <span class=o>=</span> <span class=s>&#34;play/stringsvc/transport/pb&#34;</span><span class=p>;</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=kd>message</span> <span class=nc>UppercaseRequest</span> <span class=p>{</span> <span class=kt>string</span> <span class=n>s</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=p>}</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=kd>message</span> <span class=nc>UppercaseResponse</span> <span class=p>{</span> <span class=kt>string</span> <span class=n>v</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=p>}</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=kd>message</span> <span class=nc>CountRequest</span> <span class=p>{</span> <span class=kt>string</span> <span class=n>s</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=p>}</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=kd>message</span> <span class=nc>CountResponse</span> <span class=p>{</span> <span class=kt>int32</span> <span class=n>n</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=p>}</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=kd>service</span> <span class=n>StringService</span> <span class=p>{</span><span class=err>
</span><span class=err></span>  <span class=k>rpc</span> <span class=n>Uppercase</span><span class=p>(</span><span class=n>UppercaseRequest</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>UppercaseResponse</span><span class=p>);</span><span class=err>
</span><span class=err></span>  <span class=k>rpc</span> <span class=n>Count</span><span class=p>(</span><span class=n>CountRequest</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>CountResponse</span><span class=p>);</span><span class=err>
</span><span class=err></span><span class=p>}</span><span class=err>
</span></code></pre></div><p>ç„¶åä½¿ç”¨ protoc ç”Ÿæˆ go æºç ï¼Œå…·ä½“å‚è€ƒ <a class=link href=https://www.grpc.io/docs/languages/go/quickstart/ target=_blank rel=noopener>gRPC çš„å®˜æ–¹æ–‡æ¡£</a>ã€‚ç»§ç»­ä¸‹ä¸€æ­¥ä¹‹å‰è¦å…ˆäº†è§£ go è¯­è¨€çš„ gRPC æœåŠ¡æ¡†æ¶åœ¨ä¸€èˆ¬æƒ…å†µä¸‹æ€ä¹ˆå®ç°ã€‚åŒæ ·å»ºè®®ç›´æ¥çœ‹æ–‡æ¡£ã€‚ç®€å•è¯´å°±æ˜¯å†™ä¸€ä¸ªç»“æ„ï¼Œå®ç° protoc æ ¹æ®ä½ çš„ proto æ–‡ä»¶ç”Ÿæˆçš„æ¥å£ï¼Œæœ€åè°ƒç”¨æ³¨å†Œæ–¹æ³•æŠŠä½ çš„å®ç°æ³¨å†Œåˆ° gRPC æœåŠ¡å™¨ä¸Šå°±å¯ä»¥äº†ã€‚</p>
<p>å†è€ƒè™‘è¯·æ±‚è¿›å…¥æˆ‘ä»¬çš„æœåŠ¡ä»£ç è¦ç»è¿‡çš„æµç¨‹ï¼ŒgRPC æ¥å£çš„å®ç°è¦åšäº‹æƒ…å…¶å®å°±æ˜¯æŠŠ proto å®šä¹‰çš„ç»“æ„è½¬æ¢æˆæˆ‘ä»¬ä¹‹å‰å®šä¹‰çš„ç»“æ„ï¼Œå†è°ƒç”¨ä¹‹å‰å®šä¹‰çš„ <code>Endpoint</code> ã€‚</p>
<p><img src=/blog/p/go-kit-note/image-20220301134821969.png width=437 height=488 srcset="/blog/p/go-kit-note/image-20220301134821969_huf9fd1139fbbfdafdb0f01166b9d50a9e_18354_480x0_resize_box_3.png 480w, /blog/p/go-kit-note/image-20220301134821969_huf9fd1139fbbfdafdb0f01166b9d50a9e_18354_1024x0_resize_box_3.png 1024w" loading=lazy alt=gRPCä½œä¸ºä¼ è¾“å±‚åè®®çš„äº¤äº’æµç¨‹ class=gallery-image data-flex-grow=89 data-flex-basis=214px></p>
<p>å…¶ä¸­å¯¹è¯·æ±‚ç¼–è§£ç æ˜¯ä¸ªå¾ˆæ— èŠçš„è¿‡ç¨‹ï¼Œå­—æ®µä¸€ä¸€èµ‹å€¼å³å¯ã€‚endpoint ç»§ç»­å¤ç”¨å…ˆå‰ http çš„ç‰ˆæœ¬ã€‚gRPC å®ç°æ¯”è¾ƒå–å·§ï¼Œæˆ‘ä»¬æŠŠæ‰€æœ‰ <code>Endpoint</code> æ”¾åˆ°ä¸€ä¸ªç»“æ„é‡Œä¿å­˜ï¼Œç„¶åå®ç° gRPC çš„æ¥å£ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kn>import</span> <span class=p>(</span>
	<span class=s>&#34;context&#34;</span>
	<span class=s>&#34;play/stringsvc&#34;</span>
	<span class=s>&#34;play/stringsvc/transport/pb&#34;</span>

	<span class=nx>grpctransport</span> <span class=s>&#34;github.com/go-kit/kit/transport/grpc&#34;</span>
<span class=p>)</span>

<span class=kd>type</span> <span class=nx>set</span> <span class=kd>struct</span> <span class=p>{</span>
	<span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>UnimplementedStringServiceServer</span>
	<span class=nx>uppercase</span> <span class=nx>grpctransport</span><span class=p>.</span><span class=nx>Handler</span>
	<span class=nx>count</span>     <span class=nx>grpctransport</span><span class=p>.</span><span class=nx>Handler</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>NewGRPCServer</span><span class=p>(</span><span class=nx>svc</span> <span class=nx>stringsvc</span><span class=p>.</span><span class=nx>StringService</span><span class=p>)</span> <span class=o>*</span><span class=nx>set</span> <span class=p>{</span>
	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>set</span><span class=p>{</span>
		<span class=nx>uppercase</span><span class=p>:</span> <span class=nx>grpctransport</span><span class=p>.</span><span class=nf>NewServer</span><span class=p>(</span><span class=nf>MakeUppercaseEndpoint</span><span class=p>(</span><span class=nx>svc</span><span class=p>),</span> <span class=nx>decodeUppercaseRequestGRPC</span><span class=p>,</span> <span class=nx>encodeUppercaseResponseGRPC</span><span class=p>),</span>
		<span class=nx>count</span><span class=p>:</span>     <span class=nx>grpctransport</span><span class=p>.</span><span class=nf>NewServer</span><span class=p>(</span><span class=nf>MakeCountEndpoint</span><span class=p>(</span><span class=nx>svc</span><span class=p>),</span> <span class=nx>decodeCountRequestGRPC</span><span class=p>,</span> <span class=nx>encodeCountResponseGRPC</span><span class=p>),</span>
	<span class=p>}</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>set</span><span class=p>)</span> <span class=nf>Uppercase</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>req</span> <span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>UppercaseRequest</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>UppercaseResponse</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>_</span><span class=p>,</span> <span class=nx>resp</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>uppercase</span><span class=p>.</span><span class=nf>ServeGRPC</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>req</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>
	<span class=k>return</span> <span class=nx>resp</span><span class=p>.(</span><span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>UppercaseResponse</span><span class=p>),</span> <span class=kc>nil</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>set</span><span class=p>)</span> <span class=nf>Count</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>req</span> <span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>CountRequest</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>CountResponse</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>_</span><span class=p>,</span> <span class=nx>resp</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>count</span><span class=p>.</span><span class=nf>ServeGRPC</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>req</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>
	<span class=k>return</span> <span class=nx>resp</span><span class=p>.(</span><span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>CountResponse</span><span class=p>),</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></div><p>è¿™é‡Œåˆ©ç”¨äº†ä¸€ä¸ª <code>github.com/go-kit/kit/transport/grpc</code> çš„å¸®åŠ©ç»“æ„ï¼Œ<code>grpctransport.NewServer</code> åˆ›å»ºçš„ <code>grpctransport.Server</code>ã€‚è¿™ä¸ªç»“æ„çš„ç”¨é€”å’Œ <code>httptransport.NewServer</code>ä¸€æ ·ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªé€‚é…å™¨ï¼ŒæŠŠ gRPC çš„è¾“å…¥é€‚é…åˆ°æˆ‘ä»¬å®šä¹‰çš„æœåŠ¡æ¥å£ã€‚ç†è®ºä¸Šæ¥è¯´ä¸ç”¨è¿™ç©æ„å„¿ä¹Ÿæ²¡äº‹ï¼Œä½†å®ç°ä»£ç é‡Œå°±è¦æ˜¾å¼è°ƒç”¨ <code>Decode</code>å’Œ<code>Encode</code>ã€‚ä»è§£è€¦çš„è§’åº¦æ¥è¯´è¿™ç§è®¾è®¡ä¼šæ›´å¥½ã€‚</p>
<h2 id=æ€»ç»“>æ€»ç»“</h2>
<p>ä¹‹æ‰€ä»¥è¯´ gokit å¤§æ¦‚ç®—æ˜¯æ¡†æ¶ï¼Œæ˜¯å› ä¸º gokit æä¾›çš„è¿™äº›å·¥å…·å…¶å®æœ‰ä¸€å¥—è‡ªå·±çš„æœ€ä½³å®è·µï¼Œä½†å¹¶ä¸å¼ºè¿«éµå¾ªã€‚æ¯”å¦‚ transport å¹¶ä¸æ˜¯ä¸€å®šè¦ç”¨ gokit çš„ transport ï¼Œå®Œå…¨å¯ä»¥è‡ªå·±å†™ <code>http.Handler</code> ï¼ŒæŠŠ encode/decode å†™åˆ°ä¸€èµ·ã€‚ä¹Ÿå¯ä»¥æŠŠå…¶ä»–æ–¹å¼ç¼–å†™çš„ RPC å°è£…æˆ <code>Endpoint</code>ï¼Œè·å¾— gokit æä¾›çš„ä¸€ç³»åˆ—æ”¯æŒã€‚</p>
<p>gokit æä¾›äº†å¾ˆå¤šæœ‰ç”¨çš„å·¥å…·ï¼Œè§£å†³ä¸€äº›è¯¸å¦‚æœåŠ¡å‘ç°ã€ç†”æ–­å™¨ã€åˆ†å¸ƒå¼è·Ÿè¸ªå’Œå¯è§‚æµ‹æ€§è¿™æ ·çš„é—®é¢˜ã€‚gokit çš„æ¡ˆä¾‹ä»£ç ç¤ºèŒƒçš„å®è·µæ–¹å¼ä¹Ÿå¾ˆæœ‰å¯å‘æ€§ã€‚</p>
</section>
<footer class=article-footer>
<section class=article-tags>
<a href=/blog/tags/golang/>golang</a>
<a href=/blog/tags/kubernetes/>kubernetes</a>
<a href=/blog/tags/go-kit/>go-kit</a>
<a href=/blog/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/>å¾®æœåŠ¡</a>
</section>
<section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
</footer>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css integrity=sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js integrity=sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js integrity=sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.querySelector(`.article-content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script>
</article>
<aside class=related-contents--wrapper>
<h2 class=section-title>ç›¸å…³æ–‡ç« </h2>
<div class=related-contents>
<div class="flex article-list--tile">
<article>
<a href=/blog/p/my-opinion-of-gokit-architecture/>
<div class=article-details>
<h2 class=article-title>gokit æ¶æ„ä¹‹æˆ‘è§</h2>
</div>
</a>
</article>
<article>
<a href=/blog/p/grpc-gateway-used-as-multiple-grpc-server-gateway/>
<div class=article-details>
<h2 class=article-title>gRPC-Gateway ç”¨ä½œå¤šä¸ª gRPC æœåŠ¡çš„ç½‘å…³</h2>
</div>
</a>
</article>
<article>
<a href=/blog/p/gotypes-for-codegen/>
<div class=article-details>
<h2 class=article-title>codegen åˆ©å™¨ go/types</h2>
</div>
</a>
</article>
<article>
<a href=/blog/p/unsafe-jwt/>
<div class=article-details>
<h2 class=article-title>ä¸å®‰å…¨çš„ jwt</h2>
</div>
</a>
</article>
<article>
<a href=/blog/p/refactoring-transaction-and-config-management-note/>
<div class=article-details>
<h2 class=article-title>è®°ä¸€æ¬¡é‡æ„äº‹åŠ¡ç®¡ç†å’Œé…ç½®ç®¡ç†</h2>
</div>
</a>
</article>
</div>
</div>
</aside>
<link rel=stylesheet href=https://unpkg.com/vssue/dist/vssue.min.css>
<div id=vssue></div>
<script src=https://unpkg.com/vue@2.6.14/dist/vue.runtime.min.js></script>
<script src=https://unpkg.com/vssue@1.4.8/dist/vssue.github.min.js></script>
<script>new Vue({el:"#vssue",render:a=>a("Vssue",{props:{title:"go-kit ç¬”è®°",options:{autoCreateIssue:!1,owner:"nnnewb",repo:"blog",clientId:"285910fdc1567a1a23e3",clientSecret:"f00da5438d9ac82c4a86024866c7a916ae411edc"}}})})</script>
<footer class=site-footer>
<section class=copyright>
&copy;
2021 -
2022 weakptr's ç¬”è®°
</section>
<section class=powerby>
GitHub Pages <br>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.10.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a>
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main>
<aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div>
<h2 class="widget-title section-title">ç›®å½•</h2>
<div class=widget--toc>
<nav id=TableOfContents>
<ol>
<li><a href=#å‰è¨€>å‰è¨€</a></li>
<li><a href=#gokitå®šä½>gokitå®šä½</a></li>
<li><a href=#æ¡†æ¶æ­å»º>æ¡†æ¶æ­å»º</a>
<ol>
<li><a href=#é¸Ÿç°>é¸Ÿç°</a></li>
<li><a href=#endpoint-è§£æ>endpoint è§£æ</a></li>
<li><a href=#endpointmiddleware-è§£æ>endpoint.Middleware è§£æ</a></li>
<li><a href=#åº”ç”¨ä¸­é—´ä»¶>åº”ç”¨ä¸­é—´ä»¶</a></li>
<li><a href=#å®¢æˆ·ç«¯å®ç°>å®¢æˆ·ç«¯å®ç°</a></li>
<li><a href=#æœåŠ¡å‘ç°>æœåŠ¡å‘ç°</a></li>
<li><a href=#å¤šä¼ è¾“å±‚å®ç°>å¤šä¼ è¾“å±‚å®ç°</a></li>
</ol>
</li>
<li><a href=#æ€»ç»“>æ€»ç»“</a></li>
</ol>
</nav>
</div>
</section>
</aside>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/blog/ts/main.js defer></script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>