<!doctype html><html lang=zh-cn dir=ltr>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="前言 jaeger 是一个比较常用的分布式追踪服务，后端可以选 es、cassandra 等存储，我司线上就是用了 es 作为 jaeger 存储。 jaeger 用 es 做查询后端的时候有个坏毛"><title>记一次 jaeger es 后端出现 maximum shards open 错误排查</title>
<link rel=canonical href=https://nnnewb.github.io/blog/p/jaeger-with-es-backend-exceeded-maximum-shards-open/>
<link rel=stylesheet href=/blog/scss/style.min.5c88a5bc75732c20b0a5ccc3be5c148f782b1c20e20b6c73b276723850a33d6b.css><script src=https://unpkg.com/dayjs@1.8.21/dayjs.min.js></script>
<script src=https://unpkg.com/dayjs@1.8.21/plugin/relativeTime.js></script>
<script src=https://unpkg.com/dayjs@1.8.21/locale/zh-cn.js></script>
<script>dayjs.locale('zh-cn'),dayjs.extend(dayjs_plugin_relativeTime)</script><meta property="og:title" content="记一次 jaeger es 后端出现 maximum shards open 错误排查">
<meta property="og:description" content="前言 jaeger 是一个比较常用的分布式追踪服务，后端可以选 es、cassandra 等存储，我司线上就是用了 es 作为 jaeger 存储。 jaeger 用 es 做查询后端的时候有个坏毛">
<meta property="og:url" content="https://nnnewb.github.io/blog/p/jaeger-with-es-backend-exceeded-maximum-shards-open/">
<meta property="og:site_name" content="weakptr's 笔记">
<meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="elasticsearch"><meta property="article:tag" content="kubernetes"><meta property="article:tag" content="jaeger"><meta property="article:published_time" content="2022-04-12T13:00:00+08:00"><meta property="article:modified_time" content="2022-04-12T13:00:00+08:00">
<meta name=twitter:title content="记一次 jaeger es 后端出现 maximum shards open 错误排查">
<meta name=twitter:description content="前言 jaeger 是一个比较常用的分布式追踪服务，后端可以选 es、cassandra 等存储，我司线上就是用了 es 作为 jaeger 存储。 jaeger 用 es 做查询后端的时候有个坏毛">
</head>
<body class=article-page>
<script>(function(){const a='StackColorScheme';localStorage.getItem(a)||localStorage.setItem(a,"dark")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky">
<button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box>
<span class=hamburger-inner></span>
</span>
</button>
<header>
<figure class=site-avatar>
<a href=/blog>
<img src=/blog/img/avatar_hub37949326d1692892aa1e64434c0dda6_382115_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a>
<span class=emoji>🍑</span>
</figure>
<div class=site-meta>
<h1 class=site-name><a href=/blog>weakptr's 笔记</a></h1>
<h2 class=site-description>弃船！</h2>
</div>
</header><ol class=social-menu>
<li>
<a href=https://github.com/nnnewb/ target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg>
</a>
</li>
</ol><ol class=menu id=main-menu>
<li>
<a href=/blog><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>首页</span>
</a>
</li>
<li>
<a href=/blog/about><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于我</span>
</a>
</li>
<li>
<a href=/blog/archive><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span>
</a>
</li>
<li>
<a href=/blog/categories><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
<span>分类</span>
</a>
</li>
<li>
<a href=/blog/link><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>友链</span>
</a>
</li>
<li>
<a href=/blog/search><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索</span>
</a>
</li>
<div class=menu-bottom-section>
<li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span>
</li>
</div>
</ol>
</aside>
<main class="main full-width">
<article class=main-article>
<header class=article-header>
<div class=article-details>
<header class=article-category>
<a href=/blog/categories/elasticsearch/>
elasticsearch
</a>
</header>
<div class=article-title-wrapper>
<h2 class=article-title>
<a href=/blog/p/jaeger-with-es-backend-exceeded-maximum-shards-open/>记一次 jaeger es 后端出现 maximum shards open 错误排查</a>
</h2>
</div>
<footer class=article-time>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2022-04-12T13:00:00+08:00>2022年 4月 12日</time>
</div>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>
阅读时长: 10 分钟
</time>
</div>
</footer>
</div>
</header>
<section class=article-content>
<h2 id=前言>前言</h2>
<p>jaeger 是一个比较常用的分布式追踪服务，后端可以选 es、cassandra 等存储，我司线上就是用了 es 作为 jaeger 存储。</p>
<p>jaeger 用 es 做查询后端的时候有个坏毛病：它会自动按日期分割日志 span，一天一个 index。直接结果就是一段时间没管线上的 jaeger，过一段时间就会发现 jaege 里啥也查不出来了。翻 jaeger 的日志就会看到下面的内容：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span>
    <span class=nt>&#34;level&#34;</span><span class=p>:</span> <span class=s2>&#34;error&#34;</span><span class=p>,</span>
    <span class=nt>&#34;ts&#34;</span><span class=p>:</span> <span class=mf>1649751249.9240348</span><span class=p>,</span>
    <span class=nt>&#34;caller&#34;</span><span class=p>:</span> <span class=s2>&#34;config/config.go:141&#34;</span><span class=p>,</span>
    <span class=nt>&#34;msg&#34;</span><span class=p>:</span> <span class=s2>&#34;Elasticsearch part of bulk request failed&#34;</span><span class=p>,</span>
    <span class=nt>&#34;map-key&#34;</span><span class=p>:</span> <span class=s2>&#34;index&#34;</span><span class=p>,</span>
    <span class=nt>&#34;response&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;_index&#34;</span><span class=p>:</span> <span class=s2>&#34;jaeger-span-2022-04-12&#34;</span><span class=p>,</span>
        <span class=nt>&#34;_type&#34;</span><span class=p>:</span> <span class=s2>&#34;_doc&#34;</span><span class=p>,</span>
        <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=mi>400</span><span class=p>,</span>
        <span class=nt>&#34;error&#34;</span><span class=p>:</span> <span class=p>{</span>
            <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;illegal_argument_exception&#34;</span><span class=p>,</span>
            <span class=nt>&#34;reason&#34;</span><span class=p>:</span> <span class=s2>&#34;Validation Failed: 1: this action would add [10] total shards, but this cluster currently has [2998]/[3000] maximum shards open;&#34;</span>
        <span class=p>}</span>
    <span class=p>},</span>
    <span class=nt>&#34;stacktrace&#34;</span><span class=p>:</span> <span class=s2>&#34;github.com/jaegertracing/jaeger/pkg/es/config.(*Configuration).NewClient.func2\n\tgithub.com/jaegertracing/jaeger/pkg/es/config/config.go:141\ngithub.com/olivere/elastic.(*bulkWorker).commit\n\tgithub.com/olivere/elastic@v6.2.35+incompatible/bulk_processor.go:588\ngithub.com/olivere/elastic.(*bulkWorker).work\n\tgithub.com/olivere/elastic@v6.2.35+incompatible/bulk_processor.go:501&#34;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>此时检查 <code>GET /_cat/shards</code> 或 <code>GET /_cat/allocation</code> 都能看到分片数量达到了日志里记录的 <code>2998</code> 个。</p>
<h2 id=原因>原因</h2>
<h3 id=jaeger产生大量分片>jaeger产生大量分片</h3>
<p><a class=link href=https://www.elastic.co/guide/en/elasticsearch/reference/current/size-your-shards.html target=_blank rel=noopener>elasticsearch 官方文档指出</a>，每个 index 会被切分成1或多个分片(shards)，每个分片都可能在节点间复制，以防硬件故障。</p>
<blockquote>
<p>Each index in Elasticsearch is divided into one or more shards, each of which may be replicated across multiple nodes to protect against hardware failures.</p>
</blockquote>
<p>而据我观察（sorry，没有文档），jaeger 每天创建的 index 都包含至少 5 个 primary 分片，一个 replica 分片。可以通过请求<code>index/_settings</code>这个api端点来检查索引会分配的分片和冗余数量。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span> <span class=m>200</span> <span class=ne>OK</span>
<span class=n>content-encoding</span><span class=o>:</span> <span class=l>gzip</span>
<span class=n>content-length</span><span class=o>:</span> <span class=l>239</span>
<span class=n>content-type</span><span class=o>:</span> <span class=l>application/json; charset=UTF-8</span>

<span class=p>{</span>
    <span class=nt>&#34;jaeger-span-2022-04-12&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;settings&#34;</span><span class=p>:</span> <span class=p>{</span>
            <span class=nt>&#34;index&#34;</span><span class=p>:</span> <span class=p>{</span>
                <span class=nt>&#34;creation_date&#34;</span><span class=p>:</span> <span class=s2>&#34;1649749148182&#34;</span><span class=p>,</span>
                <span class=nt>&#34;mapping&#34;</span><span class=p>:</span> <span class=p>{</span>
                    <span class=nt>&#34;nested_fields&#34;</span><span class=p>:</span> <span class=p>{</span>
                        <span class=nt>&#34;limit&#34;</span><span class=p>:</span> <span class=s2>&#34;50&#34;</span>
                    <span class=p>}</span>
                <span class=p>},</span>
                <span class=nt>&#34;number_of_replicas&#34;</span><span class=p>:</span> <span class=s2>&#34;1&#34;</span><span class=p>,</span>
                <span class=nt>&#34;number_of_shards&#34;</span><span class=p>:</span> <span class=s2>&#34;5&#34;</span><span class=p>,</span>
                <span class=nt>&#34;provided_name&#34;</span><span class=p>:</span> <span class=s2>&#34;jaeger-span-2022-04-12&#34;</span><span class=p>,</span>
                <span class=nt>&#34;requests&#34;</span><span class=p>:</span> <span class=p>{</span>
                    <span class=nt>&#34;cache&#34;</span><span class=p>:</span> <span class=p>{</span>
                        <span class=nt>&#34;enable&#34;</span><span class=p>:</span> <span class=s2>&#34;true&#34;</span>
                    <span class=p>}</span>
                <span class=p>},</span>
                <span class=nt>&#34;uuid&#34;</span><span class=p>:</span> <span class=s2>&#34;s2i5GZtpTzm3Kp4fIldwrQ&#34;</span><span class=p>,</span>
                <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=p>{</span>
                    <span class=nt>&#34;created&#34;</span><span class=p>:</span> <span class=s2>&#34;7090199&#34;</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>而检查 <code>GET /_cat/indices</code> 可以发现，<code>jaeger</code> 创建的 index 包括 <code>jaeger-service-yyyy-mm-dd</code> 和 <code>jaeger-span-yyyy-mm-dd</code> 两种，很容易算出预期每月可能产生 336~372 个新的分片。</p>
<h3 id=es每个节点分片数量受限>es每个节点分片数量受限</h3>
<p>关于节点分片数量限制，<a class=link href=https://www.elastic.co/guide/en/elasticsearch/reference/current/allocation-total-shards.html target=_blank rel=noopener>官方文档的说法</a>是这样的：</p>
<blockquote>
<p><strong><code>index.routing.allocation.total_shards_per_node</code></strong></p>
<p>The maximum number of shards (replicas and primaries) that will be allocated to a single node. Defaults to unbounded.</p>
<p>&mldr;</p>
<p><strong><code>cluster.routing.allocation.total_shards_per_node</code></strong></p>
<p>(<a class=link href=https://www.elastic.co/guide/en/elasticsearch/reference/current/settings.html#dynamic-cluster-setting target=_blank rel=noopener>Dynamic</a>) Maximum number of primary and replica shards allocated to each node. Defaults to <code>-1</code> (unlimited).</p>
<p>&mldr;</p>
</blockquote>
<p>也就是默认不限制，但显然我们遇到的情况不是这样，要是 shards 数量不限制的话就根本没现在的问题了。</p>
<p>所以在东翻西找了一轮之后，我发现还有另一个设置项。这个设置项用 <code>shards per node limits</code> 当关键词搜索的时候没找到，在 <code>GET /_cluster/settings?include_defaults</code> 里翻出来了：<code>max_shards_per_node</code>。</p>
<p>然后我在文档里搜了下，发现官方文档其实已经做了SEO，我要是直接把错误信息贴进谷歌搜的话说不定早发现这个配置项了&mldr;</p>
<blockquote>
<p>this action would add [x] total shards, but this cluster currently has [y]/[z] maximum shards open;</p>
<p>The <a class=link href=https://www.elastic.co/guide/en/elasticsearch/reference/8.1/modules-cluster.html#cluster-max-shards-per-node target=_blank rel=noopener><code>cluster.max_shards_per_node</code></a> cluster setting limits the maximum number of open shards for a cluster. This error indicates an action would exceed this limit.</p>
</blockquote>
<p><code>max_shards_per_node</code>的文档也很怪：</p>
<blockquote>
<p><strong><code>cluster.max_shards_per_node</code></strong></p>
<p>(<a class=link href=https://www.elastic.co/guide/en/elasticsearch/reference/8.1/settings.html#dynamic-cluster-setting target=_blank rel=noopener>Dynamic</a>) Limits the total number of primary and replica shards for the cluster. Elasticsearch calculates the limit as follows:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>cluster.max_shards_per_node * number of non-frozen data nodes
</code></pre></td></tr></table>
</div>
</div><p>Shards for closed indices do not count toward this limit. Defaults to <code>1000</code>. A cluster with no data nodes is unlimited.</p>
</blockquote>
<p>虽然字面上看就是一个节点可以assign的分片数量，但实际算的是 <code>total number of primary and replica shards for cluster</code>。可以简单算一下，单节点集群显然只有一个 <code>non-frozen data node</code>，所以集群的分片上限就是 <code>1000 * 1</code>。线上的 3 节点集群没有 <code>frozen data node</code>，所以全集群最多有 <code>1000*3</code> 个分片。</p>
<p>好了问题来了，<code>max_shards_per_node</code> 和 <code>total_shards_per_node</code> 有啥区别？</p>
<p><code>total_shards_per_node</code> 限制的是 <strong>一个节点能分配多少分片</strong>，<code>max_shards_per_node</code> 是 <strong>计算全集群能分配多少分片</strong> 。</p>
<p>例如一个三节点集群里，<code>total_shards_per_node</code> 是 <code>100</code>，但 <code>max_shards_per_node</code> 是 <code>1000</code>，可以创建出超过<code>100</code>个分片，但超出的分片不会被分配（没有实验过，我猜是不会 assign）。</p>
<p>反过来说 <code>total_shards_per_node</code> 比 <code>max_shards_per_node</code> 大的时候，虽然节点还能分配更多分片，但集群分片数已经到上限了，就会出现 <code>this action would add [x] total shards, but this cluster currently has [y]/[z] maximum shards open;</code> 错误了。</p>
<h2 id=处理>处理</h2>
<p>总的来说，既然是集群内的 <code>max_shards_per_node</code> 配置小了，解决方法就很多：</p>
<ol>
<li>把 <code>max_shards_per_node</code> 调大，比如<code>10000</code>，直接10倍。</li>
<li>加 es 服务节点。</li>
<li>删旧的 jaeger 索引。</li>
</ol>
<p>改配置显然是有点离谱的想法，等于是看到蟑螂在脚下，你选择铺张地毯，眼不见心不烦。</p>
<p>加节点只适合不差钱的公司，而且这么选多少是有点看公司人傻钱多的意思。</p>
<p>删除旧索引就正常很多，算是经典操作。更早些年应该还有个人站长写 crontab 自动删 <code>/var/log</code> 日志的，删旧索引本质差不多就是这个意思。</p>
<p>而清理旧索引也有很多做法。</p>
<h3 id=jaeger-es-rollover>jaeger-es-rollover</h3>
<h4 id=初始化>初始化</h4>
<p><strong>注意，我无法确定是否对未启用<code>--es.use-aliases</code>时创建的索引有效。</strong></p>
<p><strong>注意，rollover init 也会创建索引和分片，如果你已经碰到了上面的问题，直接 rollover init 会失败，必须先手动清理。</strong></p>
<p><strong>如果只想看如何清理旧索引，请跳到 删除 部分，还不行就跳到 curator 小节。</strong></p>
<p>search indices 一节所述，可以使用 jaeger-es-rollover 解决以 es 作为后端存储时的 jaeger 日志轮转问题。我要吐槽下，原文：</p>
<p>参考 <a class=link href=https://www.jaegertracing.io/docs/1.32/deployment/#shards-and-replicas-for-elasticsearch-indices target=_blank rel=noopener>jaeger 部署文档中 shards and replicas for elasticsearch indices 一节所述</a>，可以使用 <code>jaeger-es-rollover</code> 解决以 es 作为后端存储时的 jaeger 日志轮转问题。我要吐槽下，原文：</p>
<blockquote>
<p>Shards and replicas are some configuration values to take special attention to, because this is decided upon index creation. <a class=link href=https://qbox.io/blog/optimizing-elasticsearch-how-many-shards-per-index target=_blank rel=noopener>This article</a> goes into more information about choosing how many shards should be chosen for optimization.</p>
</blockquote>
<p>没有任何未配置 es 日志轮转可能产生的问题的警告。我怎么知道<code>take special attention to</code>是指性能会在特定条件下拉胯，还是直接把 es 服务的 shards 占满，直接搞得 es 没法服务？<code>This article</code> 这个链接更离谱了，半句没提为什么后面有个 <code>elasticsearch rollover</code> 小结。</p>
<p>好闲话少叙。我这里是 kubernetes 平台，docker-compose 用户或者真机部署的自己看着改。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>kubectl create job --image jaegertracing/jaeger-es-rollover:latest jaeger-es-rollover-init -- /go/bin/es-rollover init http://elasticsearch-es-http.elasticsearch.svc.cluster.local:9200 --es.username<span class=o>=</span>***censored*** --es.password<span class=o>=</span>***censored***
</code></pre></td></tr></table>
</div>
</div><p>换成 docker 命令就是</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>docker run -it --rm --net<span class=o>=</span>host jaegertracing/jaeger-es-rollover:latest init http://localhost:9200 --es.username<span class=o>=</span>***censored*** --es.password<span class=o>=</span>***censored***
</code></pre></td></tr></table>
</div>
</div><p>这一步会创建几个新的 index 和别名</p>
<p><img src=/blog/p/jaeger-with-es-backend-exceeded-maximum-shards-open/image-20220413141559066.png width=1842 height=378 srcset="/blog/p/jaeger-with-es-backend-exceeded-maximum-shards-open/image-20220413141559066_huf31b44a88e85ce036ecd9f25c7699fa0_33804_480x0_resize_box_3.png 480w, /blog/p/jaeger-with-es-backend-exceeded-maximum-shards-open/image-20220413141559066_huf31b44a88e85ce036ecd9f25c7699fa0_33804_1024x0_resize_box_3.png 1024w" loading=lazy alt="rollover init后" class=gallery-image data-flex-grow=487 data-flex-basis=1169px></p>
<p>注意图中标记的部分。</p>
<p>下一步修改 jaeger 的启动参数，我这里直接 <code>kubectl edit -n jaeger deployment jaeger</code> 编辑。</p>
<p><img src=/blog/p/jaeger-with-es-backend-exceeded-maximum-shards-open/image-20220413141913088.png width=885 height=169 srcset="/blog/p/jaeger-with-es-backend-exceeded-maximum-shards-open/image-20220413141913088_hu4a18394a943caa248bfd6f08f6042657_22472_480x0_resize_box_3.png 480w, /blog/p/jaeger-with-es-backend-exceeded-maximum-shards-open/image-20220413141913088_hu4a18394a943caa248bfd6f08f6042657_22472_1024x0_resize_box_3.png 1024w" loading=lazy alt=启动参数 class=gallery-image data-flex-grow=523 data-flex-basis=1256px></p>
<p>应用后自动更新 pod，注意看下日志有没有错误或者警告。对于 docker-compose 用户改法差不多，如果 jaeger 是直接 <code>docker run</code> 起来的，那是真的牛啤。自己 <code>docker rm</code> 再 <code>docker run</code> 一次吧。真机部署 jaeger 还没见过直接略，无非是改 systemd 配置或者 /etc/init.d 。</p>
<p>到这里 jaeger 部署的调整就完了，但问题还没解决：要是时间久了，会不会还创建一堆 indices？据我观察，应该不会再每天 2 个 index 的频率高强度创建 index 了（PS：因为第一天动手的时候没注意，jaeger 没加 <code>--es.use-aliases=true</code>，所以我也不敢说绝对不会，建议自己改了第二天看一眼。），新的 index 会写入到之前看到的 <code>jaeger-span-000001</code> 这种 index 里。</p>
<p>文档里给了个从每日创建索引转到 rollover 的迁移方法：</p>
<p><strong>这不会删除旧索引，只是把旧索引合并到了别名<code>jaeger-*-read</code>里，让 jaeger 能查询到旧的日志。</strong></p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>curl -ivX POST -H <span class=s2>&#34;Content-Type: application/json&#34;</span> localhost:9200/_aliases -d <span class=s1>&#39;{&#34;actions&#34; : [{ &#34;add&#34; : { &#34;index&#34; : &#34;jaeger-span-*-*-*&#34;, &#34;alias&#34; : &#34;jaeger-span-read&#34; } }, { &#34;add&#34; : { &#34;index&#34;:&#34;jaeger-service-*-*-*&#34;, &#34;alias&#34; : &#34;jaeger-service-read&#34; }}]}&#39;</span>
<span class=c1># archive indices</span>
curl -ivX POST -H <span class=s2>&#34;Content-Type: application/json&#34;</span> localhost:9200/_aliases -d <span class=s1>&#39;{&#34;actions&#34; : [{ &#34;add&#34; : { &#34;index&#34; : &#34;jaeger-span-archive&#34;, &#34;alias&#34; : &#34;jaeger-span-archive-read&#34; } }]}&#39;</span>
</code></pre></td></tr></table>
</div>
</div><p>注意如果有归档的话用 第二条 curl 的同时还要给 <code>jaeger</code> 加上启动参数<code>--es.archive.use-aliases=true</code>。</p>
<h4 id=轮转>轮转</h4>
<p>到这里，问题解决了90%，但还有个问题：如果所有 jaeger 数据都放在一个 index 里，过上一段时间，数据量膨胀后会不会产生性能问题？这是很自然的想法，日志这种东西是很容易膨胀的，随时间流逝很可能堆成一座难以清理的大山：就像是你想在MySQL里往一个记录超亿级的表里插数据或删数据一样。</p>
<p><code>jaeger-es-rollover</code> 真正的用途就是这个：轮转日志。一个 index 已经有 100M 了，那就换一个 index 吧。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=c1># 按 CONDITIONS 指定的规则轮转</span>
docker run -it --rm --net<span class=o>=</span>host -e <span class=nv>CONDITIONS</span><span class=o>=</span><span class=s1>&#39;{&#34;max_age&#34;: &#34;1s&#34;}&#39;</span> jaegertracing/jaeger-es-rollover:latest rollover  http://localhost:9200
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Rollover lets you configure when to roll over to a new index based on one or more of the following criteria:</p>
<ul>
<li><code>max_age</code> - the maximum age of the index. It uses <a class=link href=https://www.elastic.co/guide/en/elasticsearch/reference/master/common-options.html#time-units target=_blank rel=noopener>time units</a>: <code>d</code>, <code>h</code>, <code>m</code>.</li>
<li><code>max_docs</code> - the maximum documents in the index.</li>
<li><code>max_size</code> - the maximum estimated size of primary shards (since Elasticsearch 6.x). It uses <a class=link href=https://www.elastic.co/guide/en/elasticsearch/reference/master/common-options.html#byte-units target=_blank rel=noopener>byte size units</a> <code>tb</code>, <code>gb</code>, <code>mb</code>.</li>
</ul>
</blockquote>
<p>目前支持的条件就只有这些。rollover 并不能让 es <em>替你</em> 轮转索引，所以这个 rollover 命令只能自己定时执行。</p>
<p>对于 docker-compose 用户或者 docker 用户我没啥好办法，也许你可以在宿主机里写一个 crontab 跑上面的<code>docker run</code>。</p>
<p>对于我这样的 kubernetes 用户则可以选择用 kubernetes 的 cronjob 实现。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>batch/v1beta1</span><span class=w> </span><span class=c># 对于 kubernetes v1.21.x 已经不是 beta 了，改成 batch/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>CronJob</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>jaeger-es-index-rollover</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>jaeger</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>schedule</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0 0 * * 0&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>jobTemplate</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=c># see document https://www.jaegertracing.io/docs/1.32/deployment/#remove-old-data</span><span class=w>
</span><span class=w>          </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>jaegertracing/jaeger-es-rollover:latest</span><span class=w>
</span><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>jaeger-es-rollover</span><span class=w>
</span><span class=w>            </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span><span class=w>              </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>CONDITIONS</span><span class=w>
</span><span class=w>                </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;{&#34;max_age&#34;:&#34;2d&#34;}&#39;</span><span class=w>
</span><span class=w>            </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span><span class=w>              </span>- <span class=l>rollover</span><span class=w>
</span><span class=w>              </span>- --<span class=l>es.username=***censored***</span><span class=w>
</span><span class=w>              </span>- --<span class=l>es.password=***censored***</span><span class=w>
</span><span class=w>              </span>- <span class=s2>&#34;http://elasticsearch-es-http.elasticsearch.svc.cluster.local:9200&#34;</span><span class=w>
</span><span class=w>            </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span><span class=w>                </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span><span class=w>                </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>100Mi</span><span class=w>
</span><span class=w>              </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span><span class=w>                </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span><span class=w>                </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>100Mi</span><span class=w>
</span><span class=w>          </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>好，问题解决99%了！</p>
<h4 id=删除>删除</h4>
<p>最后就是删除不再需要的数据了，很简单啦。下面的命令中 <code>14</code> 表示保留最近14天的日志，同样支持 <code>--es.username</code>和<code>--es.password</code>参数。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>docker run -it --rm --net<span class=o>=</span>host -e <span class=nv>ROLLOVER</span><span class=o>=</span><span class=nb>true</span> jaegertracing/jaeger-es-index-cleaner:latest <span class=m>14</span> http://localhost:9200
</code></pre></td></tr></table>
</div>
</div><p><strong>注意，虽然文档说 <em>that is also used for daily indices</em>，但实际发现好像并不会删。</strong></p>
<p>我不确定是不是 <strong>ROLLOVER</strong> 这个环境变量的影响，建议自己试试。</p>
<h3 id=elasticsearch-curator>elasticsearch-curator</h3>
<p>好了，奇技淫巧环节。<a class=link href=https://github.com/elastic/curator target=_blank rel=noopener>curator</a> 是一个 elastic 公司开源的 python 包，介绍比较皮：</p>
<blockquote>
<p>Have indices in Elasticsearch? This is the tool for you!</p>
<p>Like a museum curator manages the exhibits and collections on display, Elasticsearch Curator helps you curate, or manage your indices.</p>
</blockquote>
<p>对不起，没去过博物馆，也没做过馆长，Get 不到。</p>
<p>简单地说，curator 是一个 indice 管理的工具，我们用这个工具实现找到旧索引并删除。</p>
<p>curator 的命令行界面像这样：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext>Usage: curator [OPTIONS] ACTION_FILE

  Curator for Elasticsearch indices.

  See http://elastic.co/guide/en/elasticsearch/client/curator/current

Options:
  --config PATH  Path to configuration file. Default: ~/.curator/curator.yml
  --dry-run      Do not perform any changes.
  --version      Show the version and exit.
  --help         Show this message and exit.
</code></pre></td></tr></table>
</div>
</div><p>关于这个工具，我们主要关注官方文档里的两个部分：<a class=link href=https://www.elastic.co/guide/en/elasticsearch/client/curator/current/configfile.html target=_blank rel=noopener>configuration file</a> 和 <a class=link href=https://www.elastic.co/guide/en/elasticsearch/client/curator/current/actionfile.html target=_blank rel=noopener>action file</a>。</p>
<p>configuration file 保存的是关于连接 es 所需的配置如地址、用户名密码、验证方法等，以及工具本身的配置如日志。</p>
<p>action file 保存的是我们希望 curator 帮我们完成的操作。</p>
<p>action file 的格式如下：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>actions</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>1</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>ACTION1</span><span class=w>
</span><span class=w>    </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=l>OPTIONAL DESCRIPTION</span><span class=w>
</span><span class=w>    </span><span class=nt>options</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>option1</span><span class=p>:</span><span class=w> </span><span class=l>value1</span><span class=w>
</span><span class=w>      </span><span class=l>...</span><span class=w>
</span><span class=w>    </span><span class=nt>filters</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>filtertype</span><span class=p>:</span><span class=w> </span><span class=cp>*first*</span><span class=w>
</span><span class=w>      </span><span class=nt>filter_element1</span><span class=p>:</span><span class=w> </span><span class=l>value1</span><span class=w>
</span><span class=w>      </span><span class=l>...</span><span class=w>
</span><span class=w>  </span><span class=nt>2</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=l>...</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>其中 <code>action</code> 是我们希望 curator 做的事，<code>options</code> 和 <code>filters</code> 控制 <code>action</code> 的行为和行为的对象。<code>action</code>支持<a class=link href=https://www.elastic.co/guide/en/elasticsearch/client/curator/current/actions.html target=_blank rel=noopener>很多不同的操作</a>。</p>
<p>好了，现在看实例。我们想删除名称符合 <code>jaeger-span-yyyy-mm-dd</code> 格式的 index，并且<code>yyyy-mm-dd</code>小于指定的日期。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=w>    </span><span class=nt>actions</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>1</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>delete_indices</span><span class=w>
</span><span class=w>        </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=p>&gt;-</span><span class=sd>
</span><span class=sd>          </span><span class=w>          </span><span class=l>delete old jaeger-span indices</span><span class=w>
</span><span class=w>        </span><span class=nt>options</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>ignore_empty_list</span><span class=p>:</span><span class=w> </span><span class=kc>True</span><span class=w>
</span><span class=w>          </span><span class=nt>timeout_override</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>continue_if_exception</span><span class=p>:</span><span class=w> </span><span class=kc>True</span><span class=w>
</span><span class=w>          </span><span class=nt>disable_action</span><span class=p>:</span><span class=w> </span><span class=kc>False</span><span class=w>
</span><span class=w>        </span><span class=nt>filters</span><span class=p>:</span><span class=w>
</span><span class=w>          </span>- <span class=nt>filtertype</span><span class=p>:</span><span class=w> </span><span class=l>pattern</span><span class=w>
</span><span class=w>            </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>prefix</span><span class=w>
</span><span class=w>            </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>jaeger-span</span><span class=w>
</span><span class=w>            </span><span class=nt>exclude</span><span class=p>:</span><span class=w>
</span><span class=w>          </span>- <span class=nt>filtertype</span><span class=p>:</span><span class=w> </span><span class=l>age</span><span class=w>
</span><span class=w>            </span><span class=nt>source</span><span class=p>:</span><span class=w> </span><span class=l>name</span><span class=w>
</span><span class=w>            </span><span class=nt>direction</span><span class=p>:</span><span class=w> </span><span class=l>older</span><span class=w>
</span><span class=w>            </span><span class=nt>timestring</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;%Y-%m-%d&#39;</span><span class=w>
</span><span class=w>            </span><span class=nt>unit</span><span class=p>:</span><span class=w> </span><span class=l>days</span><span class=w>
</span><span class=w>            </span><span class=nt>unit_count</span><span class=p>:</span><span class=w> </span><span class=m>7</span><span class=w>
</span><span class=w>            </span><span class=nt>exclude</span><span class=p>:</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>动作：<code>delete_indices</code>；忽略空输入，即使异常也继续执行；要删除的对象以 <code>jaeger-span</code> 开头，并且名称包含 <code>%Y-%m-%d</code> 模式的日期，且早于 7 天前。</p>
<p>done！把上面的配置复制一份套用到 <code>jaeger-service-yyyy-mm-dd</code> 上，删除 jaeger-span 的任务就算配置好了。</p>
<p>接下来把删除工作配置成定时任务，这里还是用了 cronjob。</p>
<p>先把配置保存成 ConfigMap。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=c># https://kubernetes.io/docs/concepts/configuration/configmap/</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>curator-config</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>jaeger</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>curator.yml</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span><span class=sd>    client:
</span><span class=sd>      hosts:
</span><span class=sd>        - ****
</span><span class=sd>        - ****
</span><span class=sd>        - ****
</span><span class=sd>      port: 9200
</span><span class=sd>      username: ***censored***
</span><span class=sd>      password: ***censored***
</span><span class=sd>    logging:
</span><span class=sd>      loglevel: INFO
</span><span class=sd>      logformat: default</span><span class=w>    
</span><span class=w>  </span><span class=nt>action.yml</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span><span class=sd>    actions:
</span><span class=sd>      1:
</span><span class=sd>        action: delete_indices
</span><span class=sd>        description: &gt;-
</span><span class=sd>          delete old jaeger-span indices
</span><span class=sd>        options:
</span><span class=sd>          ignore_empty_list: True
</span><span class=sd>          timeout_override:
</span><span class=sd>          continue_if_exception: True
</span><span class=sd>          disable_action: False
</span><span class=sd>        filters:
</span><span class=sd>          - filtertype: pattern
</span><span class=sd>            kind: prefix
</span><span class=sd>            value: jaeger-span
</span><span class=sd>            exclude:
</span><span class=sd>          - filtertype: age
</span><span class=sd>            source: name
</span><span class=sd>            direction: older
</span><span class=sd>            timestring: &#39;%Y-%m-%d&#39;
</span><span class=sd>            unit: days
</span><span class=sd>            unit_count: 7
</span><span class=sd>            exclude:
</span><span class=sd>      2:
</span><span class=sd>        action: delete_indices
</span><span class=sd>        description: &gt;-
</span><span class=sd>          delete old jaeger-service indices
</span><span class=sd>        options:
</span><span class=sd>          ignore_empty_list: True
</span><span class=sd>          timeout_override:
</span><span class=sd>          continue_if_exception: True
</span><span class=sd>          disable_action: False
</span><span class=sd>        filters:
</span><span class=sd>          - filtertype: pattern
</span><span class=sd>            kind: prefix
</span><span class=sd>            value: jaeger-service
</span><span class=sd>            exclude:
</span><span class=sd>          - filtertype: age
</span><span class=sd>            source: name
</span><span class=sd>            direction: older
</span><span class=sd>            timestring: &#39;%Y-%m-%d&#39;
</span><span class=sd>            unit: days
</span><span class=sd>            unit_count: 7
</span><span class=sd>            exclude:</span><span class=w>    
</span></code></pre></td></tr></table>
</div>
</div><p>再编写一个 CronJob</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>batch/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>CronJob</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>jaeger-es-index-cleanup</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>jaeger</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>schedule</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0 0 * * 0&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>jobTemplate</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>              </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>curator-config</span><span class=w>
</span><span class=w>                </span><span class=nt>configMap</span><span class=p>:</span><span class=w>
</span><span class=w>                  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>curator-config</span><span class=w>
</span><span class=w>            </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>bitnami/elasticsearch-curator:5.8.4</span><span class=w>
</span><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>elasticsearch-curator</span><span class=w>
</span><span class=w>              </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span><span class=w>                </span>- <span class=l>sh</span><span class=w>
</span><span class=w>                </span>- -<span class=l>c</span><span class=w>
</span><span class=w>                </span>- <span class=l>curator --config /cfg/curator.yml /cfg/action.yml</span><span class=w>
</span><span class=w>              </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span><span class=w>                </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/cfg</span><span class=w>
</span><span class=w>                  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>curator-config</span><span class=w>
</span><span class=w>              </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>                </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span><span class=w>                  </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span><span class=w>                  </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>100Mi</span><span class=w>
</span><span class=w>                </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span><span class=w>                  </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span><span class=w>                  </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>100Mi</span><span class=w>
</span><span class=w>            </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>这里用了 <code>bitnami/elasticsearch-curator</code> 镜像，如果不信任的话可以自己写个 Dockerfile 也不会很麻烦。我主要看中 bitnami 镜像大小优化还不错（98M），要是我自己随便写一个的话可能就不止这么大了。看了眼镜像的 Dockerfile 没有什么可疑的地方就直接用啦。</p>
<p>对于需要立刻跑一次的情况，可以把 jobTemplate 下面的内容复制出来单独写个 Job 先跑起来。</p>
<h3 id=手动>手动</h3>
<p>手动法我说个思路。首先你得有个 kibana console 可以访问，或者能直接请求到 es 的 9200 端口。</p>
<p><code>GET /_cat/indices</code> 拿到 indices 列表，按名字正则过滤 <code>jaeger-(span|service)-\d{4}-\d{2}-\d{2}</code>，然后把后面的日期解析一下；或者粗暴点，直接<code>^(2022-04-\d{2})</code>过滤出本月（4月）以外的所有索引，拿到一个索引列表。</p>
<p>具体点说，像是 kibana console 拿到的是一个每行格式如 <code>green open jaeger-span-2022-03-01 ....</code> 这样的纯文本，你可以放到 vscode 里然后用 <code>Filter Lines</code> 这样的插件快速正则过滤出来，再按 <code>alt+shift+方向键</code> 多光标，快速编辑出一个索引名称列表。</p>
<p><img src=/blog/p/jaeger-with-es-backend-exceeded-maximum-shards-open/image-20220413154700392.png width=1338 height=315 srcset="/blog/p/jaeger-with-es-backend-exceeded-maximum-shards-open/image-20220413154700392_huedcedc0cd6515fa937cef755447c928f_26312_480x0_resize_box_3.png 480w, /blog/p/jaeger-with-es-backend-exceeded-maximum-shards-open/image-20220413154700392_huedcedc0cd6515fa937cef755447c928f_26312_1024x0_resize_box_3.png 1024w" loading=lazy alt=kibana class=gallery-image data-flex-grow=424 data-flex-basis=1019px></p>
<p>然后把索引名前面加上 <code>DELETE /</code>，产生 <code>DELETE /jaeger-span-2022-03-01</code> 这样的列表，贴到 kibana console 里，全选运行，done。</p>
<p>要是没 kibana ，只有 9200 访问，就改成 curl 请求，或者 httpie ，反正总有办法。最后批量执行就好。</p>
<p>要是都没有，讲道理啊你跟负责人说下要个访问权限好吧&mldr;&mldr;</p>
<p>要是对自己的脚本编程能力有自信的话，大可直接写个 bash 脚本定时跑，也是 ok 的。</p>
<h2 id=总结>总结</h2>
<p>总之，<code>jaeger-es-rollover</code> 配 <code>jaeger-es-index-cleaner</code>；或者<code>elasticsearch-curator</code>都行。手动法无非是手工拿到 indices 然后用各种编辑器批量编辑技巧或者正则替换，拼出个脚本。正则表达式当真是每个开发者的必备良药。</p>
<p>讲道理地说要不是 jaeger 给我整这一出我可能还想不到拿 es 当 jaeger 后端还会有这种坑。但这也算给我提了个醒，挂在 es 上的数据虽然不多而且都是从 MySQL 同步过去的，es 的一些基本配置如分片啥的还是得关注一下，不能只顾着接 api。这就是所谓的 <em>运维压力</em> 了吧。</p>
<p>应该还有不少小公司的开发其实是缺乏能力运维诸如 es 这样的项目的，对 MySQL 也是仅限于精通 <strong>安装和使用</strong> ，但问起怎么怎么高可用，怎么做主备，怎么做读写分离，怎么分库分表，其实一个也不会（对，我也差不多）。</p>
<p>k8s 也是个很大的坑，现在甚至有点感觉后端一路走下来真正坑人的都是这些大框架，大概念，比如前段时间流行过的<strong>中台</strong>，风口上的<strong>云计算</strong>、<strong>云原生</strong>，好像沾个<strong>云</strong>就牛逼起来了。我不是说 k8s 没用嗷，我是说媒体吹的时候个个都是银弹，老板吹的时候各个都是<strong>给我也整一个！</strong></p>
<p>还好压力最后都转化成了见鬼的需求和莫名其妙的技术选型，最底层的开发只要放弃思考就完事了，写什么代码不是写，大家都是给资本服务嘛。</p>
</section>
<footer class=article-footer>
<section class=article-tags>
<a href=/blog/tags/elasticsearch/>elasticsearch</a>
<a href=/blog/tags/kubernetes/>kubernetes</a>
<a href=/blog/tags/jaeger/>jaeger</a>
</section>
<section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
</footer>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css integrity=sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js integrity=sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js integrity=sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.querySelector(`.article-content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script>
</article>
<aside class=related-contents--wrapper>
<h2 class=section-title>相关文章</h2>
<div class=related-contents>
<div class="flex article-list--tile">
<article>
<a href=/blog/p/simple-eck-cluster-deployment/>
<div class=article-details>
<h2 class=article-title>简单的ECK部署</h2>
</div>
</a>
</article>
</div>
</div>
</aside>
<link rel=stylesheet href=https://unpkg.com/vssue/dist/vssue.min.css>
<div id=vssue></div>
<script src=https://unpkg.com/vue@2.6.14/dist/vue.runtime.min.js></script>
<script src=https://unpkg.com/vssue@1.4.8/dist/vssue.github.min.js></script>
<script>new Vue({el:"#vssue",render:a=>a("Vssue",{props:{title:"记一次 jaeger es 后端出现 maximum shards open 错误排查",options:{autoCreateIssue:!1,owner:"nnnewb",repo:"blog",clientId:"285910fdc1567a1a23e3",clientSecret:"f00da5438d9ac82c4a86024866c7a916ae411edc"}}})})</script>
<footer class=site-footer>
<section class=copyright>
&copy;
2021 -
2022 weakptr's 笔记
</section>
<section class=powerby>
GitHub Pages <br>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.11.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计
，由 <a href=https://nnnewb.github.io/blog/>nnnewb</a> 修改
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main>
<aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div>
<h2 class="widget-title section-title">目录</h2>
<div class=widget--toc>
<nav id=TableOfContents>
<ol>
<li><a href=#前言>前言</a></li>
<li><a href=#原因>原因</a>
<ol>
<li><a href=#jaeger产生大量分片>jaeger产生大量分片</a></li>
<li><a href=#es每个节点分片数量受限>es每个节点分片数量受限</a></li>
</ol>
</li>
<li><a href=#处理>处理</a>
<ol>
<li><a href=#jaeger-es-rollover>jaeger-es-rollover</a>
<ol>
<li><a href=#初始化>初始化</a></li>
<li><a href=#轮转>轮转</a></li>
<li><a href=#删除>删除</a></li>
</ol>
</li>
<li><a href=#elasticsearch-curator>elasticsearch-curator</a></li>
<li><a href=#手动>手动</a></li>
</ol>
</li>
<li><a href=#总结>总结</a></li>
</ol>
</nav>
</div>
</section>
</aside>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/blog/ts/main.js defer></script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>