<!doctype html><html lang=zh-cn dir=ltr>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="å‰è¨€ çœ‹Bæ ‘çš„æ—¶å€™å‘ç°å¯¹ç¼“å­˜è¿˜æ˜¯ä¸å¤Ÿäº†è§£ï¼Œä½† cache line åˆå¾ˆç¥å¥‡ã€‚è¦æ˜¯æœ‰äº›æ¯”è¾ƒåƒCPUçš„ä»£ç æ”¹ä¸€ä¸‹ç»“æ„å’Œè®¿é—®æ–¹å¼å•¥çš„å°±èƒ½ç™½å«–ä¸ª50%æ€§èƒ½æå‡é‚£å²‚ä¸æ˜¯ç¾"><title>CPUç¼“å­˜ã€ç¼ºé¡µå’Œä¼ªå…±äº«</title>
<link rel=canonical href=https://nnnewb.github.io/blog/p/cpu-cache-page-fault-and-false-sharing/>
<link rel=stylesheet href=/blog/scss/style.min.709d4f89582c5a09dc94158a722a16093cdffe24d9a8c77dd3f422c786203c41.css><script src=https://unpkg.com/dayjs@1.8.21/dayjs.min.js></script>
<script src=https://unpkg.com/dayjs@1.8.21/plugin/relativeTime.js></script>
<script src=https://unpkg.com/dayjs@1.8.21/locale/zh-cn.js></script>
<script>dayjs.locale('zh-cn'),dayjs.extend(dayjs_plugin_relativeTime)</script><meta property="og:title" content="CPUç¼“å­˜ã€ç¼ºé¡µå’Œä¼ªå…±äº«">
<meta property="og:description" content="å‰è¨€ çœ‹Bæ ‘çš„æ—¶å€™å‘ç°å¯¹ç¼“å­˜è¿˜æ˜¯ä¸å¤Ÿäº†è§£ï¼Œä½† cache line åˆå¾ˆç¥å¥‡ã€‚è¦æ˜¯æœ‰äº›æ¯”è¾ƒåƒCPUçš„ä»£ç æ”¹ä¸€ä¸‹ç»“æ„å’Œè®¿é—®æ–¹å¼å•¥çš„å°±èƒ½ç™½å«–ä¸ª50%æ€§èƒ½æå‡é‚£å²‚ä¸æ˜¯ç¾">
<meta property="og:url" content="https://nnnewb.github.io/blog/p/cpu-cache-page-fault-and-false-sharing/">
<meta property="og:site_name" content="weakptr's ç¬”è®°">
<meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="c++"><meta property="article:published_time" content="2022-02-15T17:11:00+08:00"><meta property="article:modified_time" content="2022-02-15T17:11:00+08:00">
<meta name=twitter:title content="CPUç¼“å­˜ã€ç¼ºé¡µå’Œä¼ªå…±äº«">
<meta name=twitter:description content="å‰è¨€ çœ‹Bæ ‘çš„æ—¶å€™å‘ç°å¯¹ç¼“å­˜è¿˜æ˜¯ä¸å¤Ÿäº†è§£ï¼Œä½† cache line åˆå¾ˆç¥å¥‡ã€‚è¦æ˜¯æœ‰äº›æ¯”è¾ƒåƒCPUçš„ä»£ç æ”¹ä¸€ä¸‹ç»“æ„å’Œè®¿é—®æ–¹å¼å•¥çš„å°±èƒ½ç™½å«–ä¸ª50%æ€§èƒ½æå‡é‚£å²‚ä¸æ˜¯ç¾">
</head>
<body class=article-page>
<script>(function(){const a='StackColorScheme';localStorage.setItem(a,"dark")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky">
<button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box>
<span class=hamburger-inner></span>
</span>
</button>
<header>
<figure class=site-avatar>
<a href=/blog>
<img src=/blog/img/avatar_hub37949326d1692892aa1e64434c0dda6_382115_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a>
<span class=emoji>ğŸ‘</span>
</figure>
<div class=site-meta>
<h1 class=site-name><a href=/blog>weakptr's ç¬”è®°</a></h1>
<h2 class=site-description>å¼ƒèˆ¹ï¼</h2>
</div>
</header><ol class=social-menu>
<li>
<a href=https://github.com/nnnewb/ target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg>
</a>
</li>
</ol><ol class=menu id=main-menu>
<li>
<a href=/blog><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>é¦–é¡µ</span>
</a>
</li>
<li>
<a href=/blog/about><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>å…³äºæˆ‘</span>
</a>
</li>
<li>
<a href=/blog/archive><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>å½’æ¡£</span>
</a>
</li>
<li>
<a href=/blog/categories><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
<span>åˆ†ç±»</span>
</a>
</li>
<li>
<a href=/blog/tags><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11 3l9 9a1.5 1.5.0 010 2l-6 6a1.5 1.5.0 01-2 0L3 11V7a4 4 0 014-4h4"/><circle cx="9" cy="9" r="2"/></svg>
<span>æ ‡ç­¾</span>
</a>
</li>
<li>
<a href=/blog/link><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>å‹é“¾</span>
</a>
</li>
<li>
<a href=/blog/search><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>æœç´¢</span>
</a>
</li>
<div class=menu-bottom-section>
</div>
</ol>
</aside>
<main class="main full-width">
<article class=main-article>
<header class=article-header>
<div class=article-details>
<header class=article-category>
<a href=/blog/categories/c++/>
c++
</a>
</header>
<div class=article-title-wrapper>
<h2 class=article-title>
<a href=/blog/p/cpu-cache-page-fault-and-false-sharing/>CPUç¼“å­˜ã€ç¼ºé¡µå’Œä¼ªå…±äº«</a>
</h2>
</div>
<footer class=article-time>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2022-02-15T17:11:00+08:00>2022å¹´ 2æœˆ 15æ—¥</time>
</div>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>
é˜…è¯»æ—¶é•¿: 9 åˆ†é’Ÿ
</time>
</div>
</footer>
</div>
</header>
<section class=article-content>
<h2 id=å‰è¨€>å‰è¨€</h2>
<p>çœ‹Bæ ‘çš„æ—¶å€™å‘ç°å¯¹ç¼“å­˜è¿˜æ˜¯ä¸å¤Ÿäº†è§£ï¼Œä½† cache line åˆå¾ˆç¥å¥‡ã€‚è¦æ˜¯æœ‰äº›æ¯”è¾ƒåƒCPUçš„ä»£ç æ”¹ä¸€ä¸‹ç»“æ„å’Œè®¿é—®æ–¹å¼å•¥çš„å°±èƒ½ç™½å«–ä¸ª50%æ€§èƒ½æå‡é‚£å²‚ä¸æ˜¯ç¾å“‰ã€‚ç»“åˆä¸‹é¢çš„å‚è€ƒæ–‡ç« å¤§æ¦‚èŠä¸€ä¸‹ã€‚</p>
<ul>
<li><a class=link href=http://igoro.com/archive/gallery-of-processor-cache-effects/ target=_blank rel=noopener>Gallery of Processor Cache Effects</a></li>
</ul>
<h2 id=ç¼“å­˜è¡Œ>ç¼“å­˜è¡Œ</h2>
<h3 id=ä»‹ç»>ä»‹ç»</h3>
<p>é¦–å…ˆï¼Œç¼“å­˜è¡Œ<strong>ä¸æ˜¯</strong>â€œè¡Œâ€ï¼Œè¿™æ˜¯å¯¹ <em>cache line</em> çš„ç›´è¯‘ï¼Œ<em>cache line</em> å’Œ <em>cache block</em> æ˜¯åŒä¹‰çš„ï¼Œå¿½ç•¥è¿™ä¸ªâ€œè¡Œâ€å­—å³å¯ã€‚</p>
<p>cache line æŒ‡çš„æ˜¯ CPU é«˜é€Ÿç¼“å­˜ï¼ˆL1~L3ï¼‰ä¸­çš„ä¸€ä¸ªç¼“å­˜å—ï¼Œé€šå¸¸å¤§å°åœ¨ 32/64/128 bytes ï¼Œç°åœ¨å¸¸è§çš„åº”è¯¥æ˜¯ 64 bytes ã€‚cache line ä¹‹æ‰€ä»¥é‡è¦ï¼Œæ˜¯å› ä¸ºè¿™æ˜¯ CPU è®¿é—®ä¸»å­˜çš„å¿…ç»ä¹‹è·¯ï¼Œé¢‘ç¹è®¿é—®ä¸»å­˜æ•°æ®çš„åœºåˆï¼Œæˆ–è€…å¹¶å‘ç¼–ç¨‹æ—¶ï¼Œcache line çš„å½±å“è¿˜æ˜¯ä¸å®¹å¿½è§†çš„ã€‚</p>
<h3 id=ç®€å•çš„åŸºå‡†æµ‹è¯•>ç®€å•çš„åŸºå‡†æµ‹è¯•</h3>
<p>å…‰æ˜¯è¯´ cache line å¤šé‡è¦æ²¡æœ‰åµç”¨ï¼Œå†™ä¸ª demo çœ‹çœ‹ cache line çš„å½±å“æ›´ç›´è§‚ã€‚æ¥ä¸€ä¸ªæœ€ç®€å•ä¸è¿‡çš„å•é“¾è¡¨éå†ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=cp>#include</span> <span class=cpf>&lt;chrono&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;cstddef&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;functional&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;iostream&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;iterator&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;ostream&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;string&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=k>using</span> <span class=k>namespace</span> <span class=n>std</span><span class=p>;</span>
<span class=k>using</span> <span class=k>namespace</span> <span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=p>;</span>

<span class=k>typedef</span> <span class=k>struct</span> <span class=nc>_data</span> <span class=p>{</span>
  <span class=k>struct</span> <span class=nc>_data</span> <span class=o>*</span><span class=n>next</span><span class=p>;</span>
  <span class=kt>int</span> <span class=n>value</span><span class=p>;</span>
<span class=p>}</span> <span class=n>mydata</span><span class=p>;</span>

<span class=kt>void</span> <span class=nf>time_it</span><span class=p>(</span><span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>name</span><span class=p>,</span> <span class=n>function</span><span class=o>&lt;</span><span class=kt>void</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=o>&gt;</span> <span class=n>fn</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>auto</span> <span class=n>start</span> <span class=o>=</span> <span class=n>system_clock</span><span class=o>::</span><span class=n>now</span><span class=p>();</span>
  <span class=n>fn</span><span class=p>();</span>
  <span class=k>auto</span> <span class=n>stop</span> <span class=o>=</span> <span class=n>system_clock</span><span class=o>::</span><span class=n>now</span><span class=p>();</span>
  <span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=n>name</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;: &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>duration_cast</span><span class=o>&lt;</span><span class=n>milliseconds</span><span class=o>&gt;</span><span class=p>(</span><span class=n>stop</span> <span class=o>-</span> <span class=n>start</span><span class=p>).</span><span class=n>count</span><span class=p>()</span>
       <span class=o>&lt;&lt;</span> <span class=s>&#34;ms&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>endl</span><span class=p>;</span>
<span class=p>}</span>

<span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// ä¸€æ¬¡åˆ†é…ï¼Œå†…å­˜è¿ç»­
</span><span class=c1></span>  <span class=k>auto</span> <span class=n>list1</span> <span class=o>=</span> <span class=k>new</span> <span class=n>mydata</span><span class=p>[</span><span class=mi>1024</span> <span class=o>*</span> <span class=mi>1024</span> <span class=o>*</span> <span class=mi>64</span><span class=p>];</span>
  <span class=k>auto</span> <span class=n>cur</span> <span class=o>=</span> <span class=n>list1</span><span class=p>;</span>
  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>1024</span> <span class=o>*</span> <span class=mi>1024</span> <span class=o>*</span> <span class=mi>64</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>cur</span><span class=o>-&gt;</span><span class=n>next</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>list1</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>];</span>
    <span class=n>cur</span> <span class=o>=</span> <span class=n>cur</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=n>list1</span><span class=p>[</span><span class=mi>1024</span> <span class=o>*</span> <span class=mi>1024</span> <span class=o>-</span> <span class=mi>1</span><span class=p>].</span><span class=n>next</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>

  <span class=c1>// åˆ†åˆ«åˆ†é…ï¼Œå†…å­˜ä¸è¿ç»­
</span><span class=c1></span>  <span class=k>auto</span> <span class=n>list2</span> <span class=o>=</span> <span class=k>new</span> <span class=n>mydata</span><span class=p>();</span>
  <span class=k>auto</span> <span class=n>cur2</span> <span class=o>=</span> <span class=n>list2</span><span class=p>;</span>
  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>1024</span> <span class=o>*</span> <span class=mi>1024</span> <span class=o>*</span> <span class=mi>64</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>cur2</span><span class=o>-&gt;</span><span class=n>next</span> <span class=o>=</span> <span class=k>new</span> <span class=n>mydata</span><span class=p>();</span>
    <span class=n>cur2</span> <span class=o>=</span> <span class=n>cur2</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=c1>// éå†è¿ç»­çš„é“¾è¡¨
</span><span class=c1></span>  <span class=n>time_it</span><span class=p>(</span><span class=s>&#34;first&#34;</span><span class=p>,</span> <span class=p>[</span><span class=o>&amp;</span><span class=p>]()</span> <span class=p>{</span>
    <span class=k>for</span> <span class=p>(</span><span class=k>auto</span> <span class=n>ptr</span> <span class=o>=</span> <span class=n>list1</span><span class=p>;</span> <span class=n>ptr</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>;</span> <span class=n>ptr</span> <span class=o>=</span> <span class=n>ptr</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>ptr</span><span class=o>-&gt;</span><span class=n>value</span> <span class=o>*=</span> <span class=mi>3</span><span class=p>;</span>
    <span class=p>}</span>
  <span class=p>});</span>

  <span class=c1>// éå†ä¸è¿ç»­çš„é“¾è¡¨
</span><span class=c1></span>  <span class=n>time_it</span><span class=p>(</span><span class=s>&#34;second&#34;</span><span class=p>,</span> <span class=p>[</span><span class=o>&amp;</span><span class=p>]()</span> <span class=p>{</span>
    <span class=k>for</span> <span class=p>(</span><span class=k>auto</span> <span class=n>ptr</span> <span class=o>=</span> <span class=n>list2</span><span class=p>;</span> <span class=n>ptr</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>;</span> <span class=n>ptr</span> <span class=o>=</span> <span class=n>ptr</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>ptr</span><span class=o>-&gt;</span><span class=n>value</span> <span class=o>*=</span> <span class=mi>3</span><span class=p>;</span>
    <span class=p>}</span>
  <span class=p>});</span>
  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>ä¸ºäº†ä½“ç°å‡ºå·®å¼‚ï¼Œä¸€å…±éå†äº† <code>1024*1024*64</code>ä¸ªå…ƒç´ ï¼Œæ¯ä¸ªå…ƒç´  8 ä¸ªå­—èŠ‚ï¼Œä¸€å…±æ˜¯512Mæ•°æ®ã€‚</p>
<p>ç»“æœå¦‚ä¸‹ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext>weakptr î‚° æ•°æ®ç»“æ„ î‚° â™¥ 09:42 î‚° clang++.exe -m32 -O2 main.cpp -o main.exe
î‚¶weakptr î‚° æ•°æ®ç»“æ„ î‚° â™¥ 09:43 î‚° ./main.exe
first: 2ms
second: 239ms
</code></pre></td></tr></table>
</div>
</div><p>å¯ç”¨äº†<code>O2</code>çº§åˆ«ä¼˜åŒ–çš„æƒ…å†µä¸‹ï¼Œéå†è¿ç»­åˆ†é…å’Œä¸è¿ç»­åˆ†é…çš„é“¾è¡¨æ—¶ï¼Œé€Ÿåº¦ç›¸å·®è¾¾åˆ°äº†æƒŠäººçš„ä¸€ç™¾å¤šå€ã€‚</p>
<p>æ˜¯<code>O2</code>ä¼˜åŒ–æ‰äº†ç¬¬ä¸€ç§è¿ç»­åˆ†é…çš„é“¾è¡¨éå†å—ï¼Ÿ<code>-O0</code> ç¦æ­¢ä¼˜åŒ–çœ‹çœ‹ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext>î‚¶weakptr î‚° æ•°æ®ç»“æ„ î‚° â™¥ 09:44 î‚° clang++.exe -m32 -O0 main.cpp -o main.exe
î‚¶weakptr î‚° æ•°æ®ç»“æ„ î‚° â™¥ 09:45 î‚° ./main.exe
first: 3ms
second: 262ms
</code></pre></td></tr></table>
</div>
</div><p>å¹¶æ²¡æœ‰ä»»ä½•æ”¹å–„ã€‚</p>
<p>å› ä¸ºè€ƒè™‘æ˜¯å’Œå†…å­˜ç›¸å…³ï¼Œå½±å“å†…å­˜è®¿é—®æ€§èƒ½çš„å› ç´ å¯ä»¥å¾ˆè‡ªç„¶æƒ³åˆ°ç¼“å­˜å’Œç¼ºé¡µè¿™ä¸¤æ¡ã€‚</p>
<p>ç¼“å­˜æŒ‡çš„æ˜¯ cache lineï¼Œä¸€èˆ¬è¯´ false sharing çš„æ—¶å€™æåŠ  padding å¯¹é½æ¯”è¾ƒå¤šã€‚å¦ä¸€ä¸ªæƒ…å†µå°±æ˜¯éå†çš„æ—¶å€™ï¼Œå¦‚æœæ•°æ®æ¯”è¾ƒå¯†é›†ï¼Œé‚£ä»ä¸»å­˜åˆ·æ–° cache line å°±ä¼šæ›´å°‘ï¼Œç¼“å­˜åˆ©ç”¨æ›´å……åˆ†ã€‚æ‰€ä»¥åƒæ˜¯æ•°ç»„è¿™æ ·çš„è¿ç»­å†…å­˜éå†é€Ÿåº¦é€šå¸¸è¿œæ¯”é“¾è¡¨ä¹‹ç±»çš„ç»“æ„å¿«ã€‚</p>
<p>ç¼ºé¡µåˆæ˜¯å¦ä¸€ä¸ªé—®é¢˜ï¼Œç¼ºé¡µå¼‚å¸¸å‘ç”Ÿçš„å‡ ä¸ªå¸¸è§åœºæ™¯åŒ…æ‹¬ï¼šç¬¬ä¸€æ¬¡è®¿é—®åˆ†é…å¥½çš„å†…å­˜ï¼Œè®¿é—®è¢«äº¤æ¢åˆ°ç¡¬ç›˜ä¸Šçš„å†…å­˜ï¼Œ<code>mmap</code> ï¼Œä»¥åŠ<code>SIGSEGV</code>ç­‰æƒ…å†µã€‚ä¸€èˆ¬æ¥è¯´çš„è¯ï¼Œè¿ç»­çš„å†…å­˜åˆ†é…ä¸‹ä¸€æ¬¡ç¼ºé¡µå¯ä»¥å¾—åˆ°è¿ç»­çš„Nä¸ªå…ƒç´ ï¼Œä¸è¿ç»­çš„åˆ†é…ç¬¬ä¸€æ¬¡è®¿é—®Nä¸ªå…ƒç´ ï¼Œæœ€åçš„æƒ…å†µä¸‹å¯èƒ½å°±è¦Næ¬¡ç¼ºé¡µå¼‚å¸¸ã€‚</p>
<h3 id=ç¼ºé¡µå¼‚å¸¸>ç¼ºé¡µå¼‚å¸¸</h3>
<p>å…ˆçœ‹ç¼ºé¡µã€‚è¿™é‡Œä½¿ç”¨å¾®è½¯çš„ Process Explorer æ¥è§‚å¯Ÿ Page Fault çš„å‡ºç°æƒ…å†µã€‚ä¸ºäº†æœ‰æ•ˆè§‚å¯Ÿåˆ°page faultå‘ç”Ÿï¼Œæˆ‘ä¿®æ”¹äº†ä¸€ä¸‹ä»£ç ï¼Œåœ¨ <code>time_it</code> å‡½æ•°é‡Œæ·»åŠ ä¸Šäº†ç®€å•çš„ page fault è§‚æµ‹ã€‚</p>
<p><em>æç¤ºï¼Œä¹Ÿå¯ä»¥ç”¨ Process Explorer ç­‰å·¥å…·è§‚æµ‹ç¨‹åºè¿è¡Œæ—¶çš„ Page Fault æ•°é‡ï¼Œä½†ç›´æ¥åœ¨ä»£ç é‡ŒåµŒå…¥è§‚æµ‹è¿˜æ˜¯æœ€å‡†ç¡®çš„ã€‚å¦‚æœæœ‰æ›´å¥½ç”¨çš„æ€§èƒ½åˆ†æå·¥å…·çš„è¯å½“ç„¶æ›´å¥½ã€‚</em></p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=n>DWORD</span> <span class=nf>getPageFaultCount</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>auto</span> <span class=n>proc</span> <span class=o>=</span> <span class=n>GetCurrentProcess</span><span class=p>();</span>
    <span class=n>PROCESS_MEMORY_COUNTERS</span> <span class=n>counters</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>GetProcessMemoryInfo</span><span class=p>(</span><span class=n>proc</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>counters</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>counters</span><span class=p>))</span> <span class=o>==</span> <span class=n>FALSE</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>cerr</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;GetProcessMemoryInfo failed, error &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>GetLastError</span><span class=p>()</span> <span class=o>&lt;&lt;</span> <span class=n>endl</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=n>counters</span><span class=p>.</span><span class=n>PageFaultCount</span><span class=p>;</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=nf>time_it</span><span class=p>(</span><span class=k>const</span> <span class=n>string</span> <span class=n>name</span><span class=p>,</span> <span class=n>function</span><span class=o>&lt;</span><span class=kt>void</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=o>&gt;</span> <span class=n>fn</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>auto</span> <span class=n>before</span> <span class=o>=</span> <span class=n>getPageFaultCount</span><span class=p>();</span>
    <span class=k>auto</span> <span class=n>start</span> <span class=o>=</span> <span class=n>system_clock</span><span class=o>::</span><span class=n>now</span><span class=p>();</span>
    <span class=n>fn</span><span class=p>();</span>
    <span class=k>auto</span> <span class=n>stop</span> <span class=o>=</span> <span class=n>system_clock</span><span class=o>::</span><span class=n>now</span><span class=p>();</span>
    <span class=k>auto</span> <span class=n>after</span> <span class=o>=</span> <span class=n>getPageFaultCount</span><span class=p>();</span>
    <span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=n>name</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;: &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>duration_cast</span><span class=o>&lt;</span><span class=n>milliseconds</span><span class=o>&gt;</span><span class=p>(</span><span class=n>stop</span> <span class=o>-</span> <span class=n>start</span><span class=p>).</span><span class=n>count</span><span class=p>()</span>
         <span class=o>&lt;&lt;</span> <span class=s>&#34;ms, page fault count: &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>after</span> <span class=o>-</span> <span class=n>before</span> <span class=o>&lt;&lt;</span> <span class=n>endl</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>ç„¶åå¯¹ä¸¤ä¸ªç”¨ä¾‹è¿›è¡Œæµ‹è¯•ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext>initialization-1: 337ms, page fault count: 131329
initialization-2: 3591ms, page fault count: 265660
iteration-1: 3ms, page fault count: 0
iteration-2: 294ms, page fault count: 0
</code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°ï¼Œåœ¨é“¾è¡¨çš„åˆå§‹åŒ–é˜¶æ®µï¼Œéè¿ç»­åˆ†é…çš„é“¾è¡¨äº§ç”Ÿäº†è¿ç»­åˆ†é…çš„é“¾è¡¨å·®ä¸å¤šä¸¤å€çš„ page faultï¼Œè€—æ—¶æ¥è¿‘åå€â€”â€”æˆ‘è¿˜å¾—æ¾„æ¸…ä¸€ä¸‹è¿™ä¸æ˜¯åœ¨æš—ç¤ºåå€çš„è€—æ—¶éƒ½æ˜¯ page fault é€ æˆçš„ï¼Œä½† page fault åœ¨å…¶ä¸­ä¹Ÿæ¶ˆè€—äº†ä¸€éƒ¨åˆ†èµ„æºæ€»å½’æ˜¯æ¯«æ— ç–‘é—®çš„ã€‚</p>
<p>ä½†éšåçš„è¿­ä»£é˜¶æ®µé‡Œå¹¶æ²¡æœ‰æ–°çš„ page fault äº§ç”Ÿï¼Œå› ä¸º ä¸¤æ¬¡ 512M çš„åˆ†é…å†åŠ ä¸Šå¾ªç¯newï¼Œå †ç»´æŠ¤æŒ‡é’ˆçš„å¼€é”€ï¼Œå·®ä¸å¤š1.5Gï¼Œè¿˜æ²¡æœ‰è€—å°½å¯ç”¨å†…å­˜ã€‚</p>
<p>æ’é™¤ page fault çš„å½±å“åï¼Œç°åœ¨è€ƒè™‘å¦ä¸€ä¸ªå½±å“å› ç´ ï¼šç¼“å­˜ã€‚</p>
<h3 id=ç¼“å­˜è¡Œ-1>ç¼“å­˜è¡Œ</h3>
<p>å…³äºç¼“å­˜çš„åˆ†æè¿™é‡Œä½¿ç”¨äº† Intel VTune Profiler ä½œä¸ºåˆ†æå·¥å…·ï¼Œæ¥æå–ç¼“å­˜å‘½ä¸­æƒ…å†µã€‚ä¸ºäº†è®©VTuneæŠ“å–æ›´å¤šä¿¡æ¯æ¥åˆ†æï¼Œå¯¹benchmarkä»£ç å†æ¬¡ä¿®æ”¹ï¼Œéå†ä¸€æ¬¡æ”¹æˆéå†100æ¬¡ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>100</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>time_it</span><span class=p>(</span><span class=s>&#34;iteration-2&#34;</span><span class=p>,</span> <span class=p>[</span><span class=o>&amp;</span><span class=n>list2</span><span class=p>]()</span> <span class=p>{</span>
        <span class=k>for</span> <span class=p>(</span><span class=k>auto</span> <span class=n>ptr</span> <span class=o>=</span> <span class=n>list2</span><span class=p>;</span> <span class=n>ptr</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>;</span> <span class=n>ptr</span> <span class=o>=</span> <span class=n>ptr</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>ptr</span><span class=o>-&gt;</span><span class=n>value</span> <span class=o>*=</span> <span class=mi>3</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>});</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>å¹¶å°†è¿ç»­å†…å­˜åˆ†é…å’Œä¸è¿ç»­åˆ†é…åˆ†æˆ<code>benchmark1.cpp</code>å’Œ<code>benchmark2.cpp</code>ï¼Œåˆ†åˆ«ç”¨<code>-m32 -O0 -g</code> å‚æ•°ç¼–è¯‘ï¼Œæ”¾è¿› VTune åˆ†æå†…å­˜è®¿é—®æ€§èƒ½ã€‚</p>
<p><img src=/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215141503328.png width=507 height=332 srcset="/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215141503328_hu3571708b5c5bc5793cda86111950dfc6_32684_480x0_resize_box_3.png 480w, /blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215141503328_hu3571708b5c5bc5793cda86111950dfc6_32684_1024x0_resize_box_3.png 1024w" loading=lazy alt=benchmark1 class=gallery-image data-flex-grow=152 data-flex-basis=366px></p>
<p><img src=/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215141525825.png width=551 height=340 srcset="/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215141525825_hu652bea774cd469a5f99b0baeb69059e1_36904_480x0_resize_box_3.png 480w, /blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215141525825_hu652bea774cd469a5f99b0baeb69059e1_36904_1024x0_resize_box_3.png 1024w" loading=lazy alt=benchmark2 class=gallery-image data-flex-grow=162 data-flex-basis=388px></p>
<p>è§‚å¯Ÿå›¾ä¸­çš„ LLC Miss Count å¯ä»¥å‘ç°ï¼ŒBenchmark2 çš„ç¼“å­˜æœªå‘½ä¸­æ¬¡æ•°è¿œå¤§äº benchmark1 ï¼Œå¹³å‡æ—¶å»¶ Average Latency é«˜å‡º 13 ä¸ªcycles ã€‚è¿™å¦‚ä½•å½±å“æ€§èƒ½å‘¢ï¼Ÿç»§ç»­è§‚å¯Ÿä¸‹å›¾ Bottom-up ä¸­çš„åˆ†æã€‚</p>
<p><img src=/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215141832599.png width=1559 height=121 srcset="/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215141832599_huaeb1369d8df5f047d5d55e74be805100_32485_480x0_resize_box_3.png 480w, /blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215141832599_huaeb1369d8df5f047d5d55e74be805100_32485_1024x0_resize_box_3.png 1024w" loading=lazy alt=benchmark1 class=gallery-image data-flex-grow=1288 data-flex-basis=3092px></p>
<p><img src=/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215141933956.png width=1562 height=91 srcset="/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215141933956_hu1b3074ff876521e620d7b28b0f9399ed_27911_480x0_resize_box_3.png 480w, /blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215141933956_hu1b3074ff876521e620d7b28b0f9399ed_27911_1024x0_resize_box_3.png 1024w" loading=lazy alt=benchmark2 class=gallery-image data-flex-grow=1716 data-flex-basis=4119px></p>
<p>èƒ½å‘ç°ï¼Œåœ¨benchmark1ï¼ˆè¿ç»­åˆ†é…é“¾è¡¨éå†æµ‹è¯•ï¼‰ä¸­ï¼Œåˆå§‹åŒ–è€—æ—¶å’Œéå†è€—æ—¶ç›¸ä»¿ï¼Œéƒ½åœ¨300mså·¦å³ã€‚åˆå§‹åŒ–è€—æ—¶å¯èƒ½ä¸»è¦æ¥è‡ªç¼ºé¡µï¼Œæ¯æ¬¡éå†æ•´ä¸ªé“¾è¡¨ä»…3mså·¦å³ï¼ŒLLC Miss Count ä¸º 0ã€‚è¿™è¯´æ˜ç¼“å­˜å®Œç¾åœ°å‘æŒ¥äº†ä½œç”¨ã€‚</p>
<p>åœ¨ benchmark2 ï¼ˆå¾ªç¯åˆ†é…èŠ‚ç‚¹ï¼Œä¸è¿ç»­ï¼‰ä¸­ï¼Œåˆå§‹åŒ–è€—æ—¶1.4ç§’ï¼Œ100æ¬¡éå†è€—æ—¶26.461ç§’ï¼Œè€Œä¸”æ³¨æ„ï¼ŒLLC Miss Count é«˜è¾¾ 47,603,332 ã€‚å°†è¿™ä¸ªæ•°å­—é™¤ä»¥å¾ªç¯æ¬¡æ•°ï¼Œå¤§çº¦ç­‰äºæ¯ä¸ªèŠ‚ç‚¹è®¿é—®éƒ½ä¼šäº§ç”Ÿ 0.7 ä¸ª LLC Miss ã€‚</p>
<p>ä¸ºä»€ä¹ˆä¼šå‘ç”Ÿè¿™ç§äº‹ï¼Ÿ</p>
<p>benchmark1 ä¸€æ¬¡ new å‡ºè¿ç»­çš„ <code>1024 * 1024 * 64</code> ä¸ªå…ƒç´ ï¼Œæ¯ä¸ªå…ƒç´  8 ä¸ªå­—èŠ‚ï¼Œè¿ç»­æ’åˆ—ï¼Œè€Œä¸”æ„é€ é“¾è¡¨æ—¶æ˜¯æŒ‰é¡ºåºå¤´å°¾ç›¸è¿çš„ã€‚æ‰€ä»¥éå† benchmark1 çš„é“¾è¡¨æ—¶ï¼Œå¡«å……å¥½çš„ cache line (è®¾ä¸º 64å­—èŠ‚)ä¸€å…±æœ‰8ä¸ªé“¾è¡¨å…ƒç´ ä¸”è¿ç»­ï¼Œé¢„å–æœºåˆ¶åŒæ—¶æ‹¿äº†ä¸‹ä¸€ä¸ª cache line ï¼Œå› æ­¤ CPU å‡ ä¹ä¸ç”¨å‚»ç­‰ä¸»å­˜ç»™æ•°æ®ï¼Œåªéœ€è¦ä¸æ–­ä¸€ä¸ª cache line æ¥ä¸€ä¸ª cache line è¯»å†™å³å¯ï¼Œæ•ˆç‡æé«˜ã€‚</p>
<p>è€Œ benchmark2 ç›¸åï¼Œå› ä¸ºé“¾è¡¨ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ç‹¬ç«‹åˆ†é…çš„ï¼Œä¾æ® allocator ç®—æ³•ä¸åŒè¡¨ç°ä¼šæœ‰åŒºåˆ«ï¼Œä½†æ¯”è¾ƒæ˜ç¡®çš„æ˜¯å…ƒç´ ä¸å¤§å¯èƒ½æ˜¯åœ¨å†…å­˜ä¸­è¿ç»­åˆ†é…ã€‚åœ¨éå†é“¾è¡¨æ—¶ï¼Œå–ä¸‹ä¸€ä¸ªé“¾è¡¨å…ƒç´  <code>cur=cur->next </code> åï¼Œ<code>cur</code> æŒ‡å‘çš„åœ°å€å¤§æ¦‚ç‡å¹¶ä¸åœ¨å·²ç¼“å­˜çš„ cache line ä¸­ï¼Œå› æ­¤æ¯æ¬¡å¾ªç¯é‡Œ CPU éƒ½ä¸å¾—ä¸ä»ä¸»å­˜å–æ•°ã€‚å¯æ˜¯ä¸»å­˜å–æ•°æ˜¯L1/L2 ç¼“å­˜å–æ•°è€—æ—¶çš„æˆç™¾ä¸Šåƒå€ï¼Œæ•ˆç‡æä½ã€‚</p>
<h3 id=ä¼ªå…±äº«>ä¼ªå…±äº«</h3>
<p>ç»§ç»­ä¹‹å‰å†è¯´è¯´ä¼ªå…±äº«ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=cp>#include</span> <span class=cpf>&lt;cstddef&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;iostream&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;thread&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;functional&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;chrono&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=k>using</span> <span class=k>namespace</span> <span class=n>std</span><span class=p>;</span>
<span class=k>using</span> <span class=k>namespace</span> <span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=p>;</span>

<span class=kt>void</span> <span class=nf>time_it</span><span class=p>(</span><span class=k>const</span> <span class=n>string</span> <span class=n>name</span><span class=p>,</span> <span class=n>function</span><span class=o>&lt;</span><span class=kt>void</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=o>&gt;</span> <span class=n>fn</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>auto</span> <span class=n>start</span> <span class=o>=</span> <span class=n>system_clock</span><span class=o>::</span><span class=n>now</span><span class=p>();</span>
    <span class=n>fn</span><span class=p>();</span>
    <span class=k>auto</span> <span class=n>stop</span> <span class=o>=</span> <span class=n>system_clock</span><span class=o>::</span><span class=n>now</span><span class=p>();</span>
    <span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=n>name</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;: &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>duration_cast</span><span class=o>&lt;</span><span class=n>milliseconds</span><span class=o>&gt;</span><span class=p>(</span><span class=n>stop</span> <span class=o>-</span> <span class=n>start</span><span class=p>).</span><span class=n>count</span><span class=p>()</span>
         <span class=o>&lt;&lt;</span> <span class=s>&#34;ms&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>endl</span><span class=p>;</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=nf>f</span><span class=p>(</span><span class=kt>int</span> <span class=o>*</span><span class=n>data</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>10000000</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=o>*</span><span class=n>data</span> <span class=o>+=</span> <span class=mi>100</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>100</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>time_it</span><span class=p>(</span><span class=s>&#34;iteration&#34;</span><span class=p>,</span> <span class=p>[]()</span> <span class=p>{</span>
            <span class=kt>int</span> <span class=n>a</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>b</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>c</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>d</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
            <span class=kr>thread</span> <span class=o>*</span><span class=n>threads</span><span class=p>[</span><span class=mi>4</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
                <span class=k>new</span> <span class=kr>thread</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>a</span><span class=p>),</span>
                <span class=k>new</span> <span class=kr>thread</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>b</span><span class=p>),</span>
                <span class=k>new</span> <span class=kr>thread</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>c</span><span class=p>),</span>
                <span class=k>new</span> <span class=kr>thread</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>d</span><span class=p>),</span>
            <span class=p>};</span>

            <span class=k>for</span> <span class=p>(</span><span class=k>auto</span> <span class=nl>t</span> <span class=p>:</span> <span class=n>threads</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>t</span><span class=o>-&gt;</span><span class=n>join</span><span class=p>();</span>
            <span class=p>}</span>
        <span class=p>});</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>

</code></pre></td></tr></table>
</div>
</div><p>ä¾ç„¶æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„ benchmarkï¼Œè¾“å‡ºå¦‚ä¸‹ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext>iteration: 172ms
iteration: 176ms
iteration: 181ms
iteration: 177ms
iteration: 182ms
iteration: 179ms
... ç•¥
</code></pre></td></tr></table>
</div>
</div><p>ä¸€ä¸ªéå¸¸ç®€å•çš„æ“ä½œï¼Œ4çº¿ç¨‹æ— é”ï¼Œæ—  <code>volatile</code> é€’å¢ä¸åŒçš„å››ä¸ªå˜é‡ï¼Œå‡ ä¹çœ‹ä¸å‡ºæœ‰ä»€ä¹ˆçº¦æŸå¯¼è‡´æ€§èƒ½ä½ä¸‹çš„é—®é¢˜ã€‚æˆ‘ä»¬é€šè¿‡ Intel VTune æ¥çœ‹çœ‹ã€‚</p>
<p><img src=/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215163719690.png width=1453 height=740 srcset="/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215163719690_hu046c5a587cbc915571865660d4965e46_142205_480x0_resize_box_3.png 480w, /blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215163719690_hu046c5a587cbc915571865660d4965e46_142205_1024x0_resize_box_3.png 1024w" loading=lazy alt="false sharing - intel VTune" class=gallery-image data-flex-grow=196 data-flex-basis=471px></p>
<p><img src=/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215163847953.png width=1453 height=740 srcset="/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215163847953_hu63d8a1f13a9b918520d7739e38733940_101530_480x0_resize_box_3.png 480w, /blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215163847953_hu63d8a1f13a9b918520d7739e38733940_101530_1024x0_resize_box_3.png 1024w" loading=lazy alt=stall class=gallery-image data-flex-grow=196 data-flex-basis=471px></p>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒVTune æç¤ºCPUèŠ±è´¹äº†å¤§é‡æ—¶é—´åœ¨å‚»ç­‰ cache line å†™å…¥ä¸»å­˜ã€‚</p>
<p><img src=/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215164012789.png width=1101 height=62 srcset="/blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215164012789_hua004026a68d2e492c13f4a22525e40fe_14051_480x0_resize_box_3.png 480w, /blog/p/cpu-cache-page-fault-and-false-sharing/image-20220215164012789_hua004026a68d2e492c13f4a22525e40fe_14051_1024x0_resize_box_3.png 1024w" loading=lazy alt="hot spot" class=gallery-image data-flex-grow=1775 data-flex-basis=4261px></p>
<p>å‡½æ•° f å‡ºç°äº†æµ·é‡çš„ loads/store æ“ä½œã€‚</p>
<p>åœ¨å‰æ–‡ä¸­æˆ‘ä»¬èŠäº† cache line çš„ä½œç”¨ï¼Œè¿™é‡Œä¹Ÿèƒ½çœ‹åˆ° LLC Miss ä¸º 0ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆè¿è¡Œæ€§èƒ½ä¼šè¿™ä¹ˆå·®å‘¢ï¼Ÿ</p>
<p>è¿™ä¸ªé—®é¢˜è¿˜å¾—å›åˆ° cache line ä¸Šã€‚åœ¨å¤šæ ¸ç³»ç»Ÿä¸­ï¼Œcache line è¿˜è¦æ±‚ <strong>ä¸€è‡´æ€§</strong> ï¼Œä¸€æ—¦å†™ cache line ä¸­çš„ä»»æ„å­—èŠ‚ï¼Œéƒ½ä¼šè®© <strong>æ•´ä¸ª</strong> cache line æ ‡è®°ä¸ºå¤±æ•ˆã€‚åœ¨åŸºå‡†æµ‹è¯•ä»£ç é‡Œï¼Œå››ä¸ª int å˜é‡è¢«è¿ç»­åˆ†é…åœ¨æ ˆä¸Šï¼Œä¹Ÿå°±æ˜¯è¯´ cache line ææœ‰å¯èƒ½å°†è¿™å››ä¸ªå˜é‡ä¸­çš„å¤šä¸ªä¿å­˜åœ¨åŒä¸€ cache line å†…ã€‚ä»»æ„ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†å…¶ä¸­ä¸€ä¸ªå˜é‡ï¼Œéƒ½ä¼šå¯¼è‡´ cache line è¢«æ ‡ä¸ºå¤±æ•ˆï¼Œå…¶ä»–çº¿ç¨‹æˆ–æ ¸å¿ƒæƒ³è¦è®¿é—®è¿™å››ä¸ªå˜é‡ä¹‹ä¸€éƒ½ä¸å¾—ä¸ä»ä¸»å­˜é‡æ–°å–æ•°ã€‚</p>
<p>è¿™ä¹ˆåšçš„åŸå› æ˜¯ä¸ºäº†ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚CPU0 ä¿®æ”¹äº† cache line ä¸­çš„æ•°æ®ï¼Œè¿˜æ²¡æœ‰å†™å›ä¸»å­˜ï¼Œå…¶ä»– CPU éƒ½ä¸æ¸…æ¥š CPU0 åšäº†ä»€ä¹ˆä¿®æ”¹ï¼Œåªèƒ½ç­‰å¾… CPU0 å†™å›ä¸»å­˜ï¼ˆæˆ–è€…L3ï¼‰ï¼Œå†é‡æ–°ä»ä¸»å­˜ï¼ˆæˆ–L3ï¼‰å–æ•°ã€‚ä½†æˆ‘ä»¬éƒ½çŸ¥é“aã€bã€cã€då¹¶ä¸æ˜¯å…±äº«çš„ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½åªè®¿é—®è‡ªå·±çš„é‚£ä¸ªå˜é‡ã€‚è¿™ç§é—®é¢˜è¢«ç§°ä½œ<strong>ä¼ªå…±äº«</strong>ã€‚</p>
<p>åœ¨ VTune ä¸­çš„è¡¨ç°ï¼Œå°±æ˜¯ä¸Šå›¾ä¸­æµ·é‡çš„ Loads/Stores æ“ä½œã€‚</p>
<p>å¦‚ä½•è§£å†³å‘¢ï¼Ÿ</p>
<p>å¾ˆç®€å•ï¼Œè®©æ¯ä¸ªçº¿ç¨‹è¦æ“ä½œçš„å˜é‡å¡«æ»¡æ•´ä¸ª cache lineï¼Œé˜²æ­¢å› ä¸ºcache line é‡Œæ··å…¥å’Œå…¶ä»–çº¿ç¨‹è¦ä¿®æ”¹çš„å˜é‡é€ æˆä¼ªå…±äº«ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
    <span class=kt>int8_t</span> <span class=n>_before</span><span class=p>[</span><span class=mi>60</span><span class=p>];</span>
    <span class=kt>int32_t</span> <span class=n>value</span><span class=p>;</span>
    <span class=kt>int8_t</span> <span class=n>_after</span><span class=p>[</span><span class=mi>60</span><span class=p>];</span>
<span class=p>}</span> <span class=n>value</span><span class=p>;</span>

<span class=kt>void</span> <span class=nf>f</span><span class=p>(</span><span class=n>value</span> <span class=o>*</span><span class=n>data</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>10000000</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>data</span><span class=o>-&gt;</span><span class=n>value</span> <span class=o>+=</span> <span class=mi>100</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>100</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>time_it</span><span class=p>(</span><span class=s>&#34;iteration&#34;</span><span class=p>,</span> <span class=p>[]()</span> <span class=p>{</span>
            <span class=n>value</span> <span class=n>a</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>},</span> <span class=n>b</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>},</span> <span class=n>c</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>},</span> <span class=n>d</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
            <span class=kr>thread</span> <span class=o>*</span><span class=n>threads</span><span class=p>[</span><span class=mi>4</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
                <span class=k>new</span> <span class=kr>thread</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>a</span><span class=p>),</span>
                <span class=k>new</span> <span class=kr>thread</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>b</span><span class=p>),</span>
                <span class=k>new</span> <span class=kr>thread</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>c</span><span class=p>),</span>
                <span class=k>new</span> <span class=kr>thread</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>d</span><span class=p>),</span>
            <span class=p>};</span>

            <span class=k>for</span> <span class=p>(</span><span class=k>auto</span> <span class=nl>t</span> <span class=p>:</span> <span class=n>threads</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>t</span><span class=o>-&gt;</span><span class=n>join</span><span class=p>();</span>
            <span class=p>}</span>
        <span class=p>});</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>å°†åŸæœ¬çš„ int æ”¹æˆå‰åå„æœ‰ 60 å­—èŠ‚å¡«å……çš„ç»“æ„ï¼ˆå‰60å­—èŠ‚é˜²æ­¢ value æ··å…¥åˆ«äººçš„ cache lineï¼Œå60å­—èŠ‚é˜²æ­¢valueåçš„å˜é‡æ··å…¥cache lineï¼Œ124å­—èŠ‚ï¼Œå¯¹é½å128å­—èŠ‚ï¼‰ã€‚è¿™ä¸ªè§£å†³æ–¹æ³•æ˜¯å…¸å‹çš„ <strong>ç”¨ç©ºé—´æ¢æ—¶é—´</strong> ã€‚å†æ¬¡è¿è¡ŒåŸºå‡†æµ‹è¯•ï¼Œå¯ä»¥çœ‹åˆ°è¿è¡Œæ—¶é—´ç¼©çŸ­äº†æ•°å€ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext>iteration: 15ms
iteration: 21ms
iteration: 20ms
iteration: 18ms
iteration: 20ms
iteration: 22ms
iteration: 20ms
iteration: 19ms
iteration: 20ms
iteration: 20ms
... ç•¥
</code></pre></td></tr></table>
</div>
</div><h3 id=cache-line-åŸç†>cache line åŸç†</h3>
<p>Intel åœ¨ 2016 å¹´å‘è¡¨çš„ä¸€ç¯‡æ–‡ç« ï¼Œ<a class=link href=https://www.intel.com/content/www/us/en/developer/articles/technical/how-memory-is-accessed.html target=_blank rel=noopener>How Memory Is Accessed</a>è¿™æ ·å†™é“ã€‚</p>
<blockquote>
<p>Programming modern computers rarely requires an understanding of underlying hardware and software; consequently, most programmers do not know how the memory subsystem works.</p>
<p>However, such lack of knowledge can ultimately produce a 10x or worse slowdown in application performance â€“ especially since the arrival of <a class=link href=http://software.intel.com/en-us/articles/what-s-new-about-modern-hardware target=_blank rel=noopener>new hardware technologies</a>.</p>
<p>&mldr;</p>
<p>The accesses propagating through the memory subsystem are a combination of a specific request and the needed physical addresses and, perhaps, data.</p>
<p>Data moves around most of the memory subsystem in 64-byte quantities called <em>cache lines</em>. A <em>cache entry</em>, which is some transistors that can store a physical address and a cache line, is filled when a cache line is copied into it. Pages are evenly divided into cache lines â€“ the first 64 bytes of a 4096-byte page is a cache line, with the 64 bytes stored together in a cache entry; the next 64 bytes is the next cache line, etc.</p>
<p>Each cache line may:</p>
<ul>
<li>Not be cached</li>
<li>Occupy an entry in one cache</li>
<li>Be duplicated in several caches</li>
</ul>
<p>Cores, I/O devices, and other devices send requests to caches to either read or write a cache entry for a physical address. The lowest six bits of the physical address are not sent â€“ they are used by the core to select the bytes within the cache line. The core sends separate requests for each cache line it needs.</p>
<ul>
<li><strong>Reads</strong> â€“ If a cache has the requested physical address in a cache entry, the cache returns the data. If not, the cache requests the data from deeper in the memory subsystem and evicts some cache entry to make room. If the evicted cache entry has been modified, it must be written to the deeper memory subsystem as part of this eviction. This means a stream of reads may slow down because an earlier set of writes must be pushed deeper into the memory subsystem. A small queue of written data buffers the communication from the sender to the receiver.</li>
<li><strong>Writes</strong> â€“ If the cache does not have the cache line in a cache entry, the cache reads it from deeper in the memory subsystem. It evicts some other physical address from its cache entry to make room for this cache line. The read is necessary to get all the 64 bytes, because the write is probably changing only some of them. The first time a cache entry is written, the cache entries of this physical address in all other caches are invalidated. This action makes the first write on a cache entry more expensive than later writes.</li>
</ul>
</blockquote>
<p>CPUè®¿é—®ä¸»å­˜æ—¶å¹¶ä¸æ˜¯ç›´æ¥ä»ä¸»å­˜å–æ•°ï¼Œè€Œæ˜¯å…ˆè¯»å…¥é«˜é€Ÿç¼“å­˜ï¼Œä¹Ÿå°±æ˜¯åœ¨CPUçš„è§„æ ¼è¯´æ˜ä¸­æåˆ°çš„ L1/L2/L3 ç¼“å­˜ã€‚è€Œä¸”ï¼ŒCPUä¹Ÿä¸ä¼šå‚»ä¹ä¹åœ°åªä»ä¸»å­˜å–ä¸€ä¸ªå­—èŠ‚ã€4ä¸ªå­—èŠ‚æˆ–8ä¸ªå­—èŠ‚ï¼Œè€Œæ˜¯å–æ›´å¤šæ•°æ®æ”¾å…¥ç¼“å­˜ã€‚</p>
<p>ä¸ºä»€ä¹ˆï¼Ÿå› ä¸º <em>å±€éƒ¨æ€§åŸç†</em> ã€‚CPUè®¾è®¡è€…å‡è®¾ç¨‹åºè®¿é—®ä¸€ä¸ªåœ°å€ï¼Œåˆ™å¾ˆå¿«ä¹Ÿä¼šè®¿é—®è¿™ä¸ªåœ°å€é™„è¿‘çš„å…¶ä»–åœ°å€ã€‚</p>
<p>è¿™å„¿æœ‰ä¸ªè¡¨æ ¼ <em>Numbers everyone should know</em>ï¼š</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext>           0.5 ns - CPU L1 dCACHE reference
           1   ns - speed-of-light (a photon) travel a 1 ft (30.5cm) distance
           5   ns - CPU L1 iCACHE Branch mispredict
           7   ns - CPU L2  CACHE reference
          71   ns - CPU cross-QPI/NUMA best  case on XEON E5-46*
         100   ns - MUTEX lock/unlock
         100   ns - own DDR MEMORY reference
         135   ns - CPU cross-QPI/NUMA best  case on XEON E7-*
         202   ns - CPU cross-QPI/NUMA worst case on XEON E7-*
         325   ns - CPU cross-QPI/NUMA worst case on XEON E5-46*
      10,000   ns - Compress 1K bytes with Zippy PROCESS
      20,000   ns - Send 2K bytes over 1 Gbps NETWORK
     250,000   ns - Read 1 MB sequentially from MEMORY
     500,000   ns - Round trip within a same DataCenter
  10,000,000   ns - DISK seek
  10,000,000   ns - Read 1 MB sequentially from NETWORK
  30,000,000   ns - Read 1 MB sequentially from DISK
 150,000,000   ns - Send a NETWORK packet CA -&gt; Netherlands
|   |   |   |
|   |   | ns|
|   | us|
| ms|
</code></pre></td></tr></table>
</div>
</div><p>å…·ä½“æ•°å­—ä¾èµ–äºå…·ä½“çš„ç¡¬ä»¶å¹³å°ï¼Œè¿™ä¸ªè¡¨æ ¼å¯ä»¥å¯¹è®¿é—®é€Ÿåº¦å»ºç«‹å¤§æ¦‚çš„æ˜ åƒã€‚å½“ L1/L2 ç¼“å­˜æœªå‘½ä¸­ï¼ŒCPUä¸å¾—ä¸ç»§ç»­å‘æ›´è¿œã€å»¶æ—¶æ›´é•¿çš„è®¾å¤‡å¯»æ±‚æ•°æ®ï¼Œæ¯ä¸ª LLC Miss éƒ½æ„å‘³ç€ CPU ä¸å¾—ä¸èŠ±ä¸Šæˆç™¾ä¸Šåƒå€çš„æ—¶é—´ç­‰å¾…å¡«å…… cache lineã€‚è€Œ LLC Miss å‡ºç°çš„é¢‘ç‡è¶Šé«˜ï¼Œåˆ™æ„å‘³ç€ CPU æ‰§è¡Œçš„æ•ˆç‡è¶Šä½â€”â€”ç»å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨ç­‰å¾…ä¸»å­˜çš„æ•°æ®ã€‚</p>
<p>æ›´ç³Ÿç³•çš„æ˜¯ï¼Œæœ‰æ—¶å€™ CPU çœŸçš„å°±æ˜¯å‚»ç­‰(stall)ï¼Œä¸ä¸“é—¨åˆ†æç”šè‡³éƒ½ä¸çŸ¥é“ç¨‹åºæ ¹æœ¬æ²¡è·‘å‡ºåº”æœ‰çš„é€Ÿåº¦ã€‚</p>
<blockquote>
<p>Modern cores use both <a class=link href=https://en.wikipedia.org/wiki/Out-of-order_execution target=_blank rel=noopener>out-of-order execution</a> and <a class=link href=https://en.wikipedia.org/wiki/Hyper-threading target=_blank rel=noopener>hyperthreading</a> to find and to do something useful while other instructions wait for data to be fetched.</p>
<p>If nothing useful can be done, the core stalls. Unfortunately, the OS is almost unaware of the stall: the application appears to be running, and it is hard to tell if the application is slower than it should be. You need tools to examine <a class=link href=https://en.wikipedia.org/wiki/Hardware_performance_counter target=_blank rel=noopener>hardware performance counters</a> to see stall details.</p>
</blockquote>
<p>å›é¡¾åŸºå‡†æµ‹è¯•ä»£ç ï¼Œä»…ä»…æ˜¯è¿ç»­åˆ†é…å†…å­˜å°±å¯ä»¥è·å¾—ç™¾å€çš„æ€§èƒ½æ”¹å–„ï¼Œè¶…å€¼ã€‚</p>
<p>å¼•ç”¨å‰æ–‡æ¥ç»™ cache line å°èŠ‚ç»“å°¾ï¼š</p>
<blockquote>
<p>However, such lack of knowledge can ultimately produce a 10x or worse slowdown in application performance â€“ especially since the arrival of <a class=link href=http://software.intel.com/en-us/articles/what-s-new-about-modern-hardware target=_blank rel=noopener>new hardware technologies</a>.</p>
</blockquote>
<h2 id=æ€»ç»“>æ€»ç»“</h2>
<p>ä»€ä¹ˆæ˜¯ cache lineï¼Ÿ</p>
<blockquote>
<p>Data moves around most of the memory subsystem in 64-byte quantities called <em>cache lines</em>.</p>
</blockquote>
<p>cache line å¦‚ä½•å½±å“æ€§èƒ½ï¼Ÿ</p>
</section>
<footer class=article-footer>
<section class=article-tags>
<a href=/blog/tags/c++/>c++</a>
</section>
<section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
</footer>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css integrity=sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js integrity=sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js integrity=sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.querySelector(`.article-content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script>
</article>
<aside class=related-contents--wrapper>
<h2 class=section-title>ç›¸å…³æ–‡ç« </h2>
<div class=related-contents>
<div class="flex article-list--tile">
<article>
<a href=/blog/p/how-branch-prediction-effects-executoin-performance-and-security/>
<div class=light>
<div class=lamp></div>
</div>
<div class=article-details>
<h2 class=article-title>åˆ†æ”¯é¢„æµ‹å¯¹æ‰§è¡Œæ•ˆç‡å’Œå®‰å…¨çš„å½±å“</h2>
</div>
</a>
</article>
<article>
<a href=/blog/p/how-to-compile-lief-on-windows/>
<div class=light>
<div class=lamp></div>
</div>
<div class=article-details>
<h2 class=article-title>ç¼–è¯‘LIEFçš„å„ç§å§¿åŠ¿</h2>
</div>
</a>
</article>
<article>
<a href=/blog/p/%E5%9C%A8c-%E4%B8%AD%E5%B5%8C%E5%85%A5python%E8%A7%A3%E9%87%8A%E5%99%A8/>
<div class=light>
<div class=lamp></div>
</div>
<div class=article-details>
<h2 class=article-title>åœ¨C++ä¸­åµŒå…¥Pythonè§£é‡Šå™¨</h2>
</div>
</a>
</article>
<article>
<a href=/blog/p/gamehollywood-%E9%9D%A2%E8%AF%95%E7%AC%94%E8%AE%B0/>
<div class=light>
<div class=lamp></div>
</div>
<div class=article-details>
<h2 class=article-title>GameHollywood é¢è¯•ç¬”è®°</h2>
</div>
</a>
</article>
<article>
<a href=/blog/p/%E5%8F%AF%E9%87%8D%E5%85%A5%E5%92%8C%E5%BC%82%E6%AD%A5%E5%AE%89%E5%85%A8/>
<div class=light>
<div class=lamp></div>
</div>
<div class=article-details>
<h2 class=article-title>å¯é‡å…¥å’Œå¼‚æ­¥å®‰å…¨</h2>
</div>
</a>
</article>
</div>
</div>
</aside>
<footer class=site-footer>
<section class=copyright>
&copy;
2021 -
2023 weakptr's ç¬”è®°
</section>
<section class=powerby>
GitHub Pages <br>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
ä¸»é¢˜ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.11.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è®¾è®¡
ï¼Œç”± <a href=https://nnnewb.github.io/blog/>nnnewb</a> ä¿®æ”¹
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main>
<aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div>
<h2 class="widget-title section-title">ç›®å½•</h2>
<div class=widget--toc>
<nav id=TableOfContents>
<ol>
<li><a href=#å‰è¨€>å‰è¨€</a></li>
<li><a href=#ç¼“å­˜è¡Œ>ç¼“å­˜è¡Œ</a>
<ol>
<li><a href=#ä»‹ç»>ä»‹ç»</a></li>
<li><a href=#ç®€å•çš„åŸºå‡†æµ‹è¯•>ç®€å•çš„åŸºå‡†æµ‹è¯•</a></li>
<li><a href=#ç¼ºé¡µå¼‚å¸¸>ç¼ºé¡µå¼‚å¸¸</a></li>
<li><a href=#ç¼“å­˜è¡Œ-1>ç¼“å­˜è¡Œ</a></li>
<li><a href=#ä¼ªå…±äº«>ä¼ªå…±äº«</a></li>
<li><a href=#cache-line-åŸç†>cache line åŸç†</a></li>
</ol>
</li>
<li><a href=#æ€»ç»“>æ€»ç»“</a></li>
</ol>
</nav>
</div>
</section>
</aside>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/blog/ts/main.js defer></script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>