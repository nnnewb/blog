<!doctype html><html lang=zh-cn>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="说起来也不算什么新鲜的东西，现成的工具拼拼凑凑就搞定了，单纯算是点亮了新的技能。
待破解应用的名字不透露了，避免引火烧身。
需要准备的工具包括
 mumu 模拟器(或者别的什么有 root 权限、能装 xposed 的模拟器) FDex2 脱壳 jadx 反编译 dex 源码 apktools 拆解 apk mitmproxy 中间人拦截网络请求  0x01 目标和方向选择 首要的目标是破解这个软件的 api 加密。
使用 mitmproxy 抓到 https 流量，发现请求体全部是 base64 ，解码发现乱码。基本断定是加密了。
 mitmproxy 怎么抓 https 流量不多说了，基本流程就是装证书，然后配置代理。能看到有流量进 mitmproxy 就算成功了。
直接参考 mitmproxy 的文档快一点。
 搜了一圈没有什么现成的对这个 App 的破解的文章，于是决定自己动手。
0x02 解包和脱壳 先确认下电脑上装了 JDK 或者 JRE ，没有的话就装好。
推荐一个 vscode 的插件，apklab。会帮你装好 jadx 和 apktools / signer 这些工具。
接下来直接用 apklab 打开需要破解的 apk 文件。
apklab 会自动用 apktools 和 jadx 完成拆包和反编译。"><title>一个安卓应用的逆向分析</title>
<link rel=canonical href=https://nnnewb.github.io/blog/p/%E4%B8%80%E4%B8%AA%E5%AE%89%E5%8D%93%E5%BA%94%E7%94%A8%E7%9A%84%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/>
<link rel=stylesheet href=/blog/scss/style.min.css><meta property="og:title" content="一个安卓应用的逆向分析">
<meta property="og:description" content="说起来也不算什么新鲜的东西，现成的工具拼拼凑凑就搞定了，单纯算是点亮了新的技能。
待破解应用的名字不透露了，避免引火烧身。
需要准备的工具包括
 mumu 模拟器(或者别的什么有 root 权限、能装 xposed 的模拟器) FDex2 脱壳 jadx 反编译 dex 源码 apktools 拆解 apk mitmproxy 中间人拦截网络请求  0x01 目标和方向选择 首要的目标是破解这个软件的 api 加密。
使用 mitmproxy 抓到 https 流量，发现请求体全部是 base64 ，解码发现乱码。基本断定是加密了。
 mitmproxy 怎么抓 https 流量不多说了，基本流程就是装证书，然后配置代理。能看到有流量进 mitmproxy 就算成功了。
直接参考 mitmproxy 的文档快一点。
 搜了一圈没有什么现成的对这个 App 的破解的文章，于是决定自己动手。
0x02 解包和脱壳 先确认下电脑上装了 JDK 或者 JRE ，没有的话就装好。
推荐一个 vscode 的插件，apklab。会帮你装好 jadx 和 apktools / signer 这些工具。
接下来直接用 apklab 打开需要破解的 apk 文件。
apklab 会自动用 apktools 和 jadx 完成拆包和反编译。">
<meta property="og:url" content="https://nnnewb.github.io/blog/p/%E4%B8%80%E4%B8%AA%E5%AE%89%E5%8D%93%E5%BA%94%E7%94%A8%E7%9A%84%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/">
<meta property="og:site_name" content="weakptr's 笔记">
<meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="逆向"><meta property="article:tag" content="Java"><meta property="article:tag" content="C++"><meta property="article:tag" content="Android"><meta property="article:published_time" content="2020-12-29T14:04:02+08:00"><meta property="article:modified_time" content="2020-12-29T14:04:02+08:00">
<meta name=twitter:title content="一个安卓应用的逆向分析">
<meta name=twitter:description content="说起来也不算什么新鲜的东西，现成的工具拼拼凑凑就搞定了，单纯算是点亮了新的技能。
待破解应用的名字不透露了，避免引火烧身。
需要准备的工具包括
 mumu 模拟器(或者别的什么有 root 权限、能装 xposed 的模拟器) FDex2 脱壳 jadx 反编译 dex 源码 apktools 拆解 apk mitmproxy 中间人拦截网络请求  0x01 目标和方向选择 首要的目标是破解这个软件的 api 加密。
使用 mitmproxy 抓到 https 流量，发现请求体全部是 base64 ，解码发现乱码。基本断定是加密了。
 mitmproxy 怎么抓 https 流量不多说了，基本流程就是装证书，然后配置代理。能看到有流量进 mitmproxy 就算成功了。
直接参考 mitmproxy 的文档快一点。
 搜了一圈没有什么现成的对这个 App 的破解的文章，于是决定自己动手。
0x02 解包和脱壳 先确认下电脑上装了 JDK 或者 JRE ，没有的话就装好。
推荐一个 vscode 的插件，apklab。会帮你装好 jadx 和 apktools / signer 这些工具。
接下来直接用 apklab 打开需要破解的 apk 文件。
apklab 会自动用 apktools 和 jadx 完成拆包和反编译。">
</head>
<body class="article-page has-toc">
<script>(function(){const a='StackColorScheme';localStorage.getItem(a)||localStorage.setItem(a,"auto")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex
extended">
<div id=article-toolbar>
<a href=https://nnnewb.github.io/blog class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg>
<span>返回</span>
</a>
</div>
<main class="main full-width">
<article class=main-article>
<header class=article-header>
<div class=article-details>
<header class=article-category>
<a href=/blog/categories/%E9%80%86%E5%90%91/>
逆向
</a>
</header>
<h2 class=article-title>
<a href=/blog/p/%E4%B8%80%E4%B8%AA%E5%AE%89%E5%8D%93%E5%BA%94%E7%94%A8%E7%9A%84%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/>一个安卓应用的逆向分析</a>
</h2>
<footer class=article-time>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2020年 12月 29日</time>
</div>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>
阅读时长: 2 分钟
</time>
</div>
</footer>
</div>
</header>
<section class=article-content>
<p>说起来也不算什么新鲜的东西，现成的工具拼拼凑凑就搞定了，单纯算是点亮了新的技能。</p>
<p>待破解应用的名字不透露了，避免引火烧身。</p>
<p>需要准备的工具包括</p>
<ul>
<li>mumu 模拟器(或者别的什么有 root 权限、能装 xposed 的模拟器)</li>
<li>FDex2 脱壳</li>
<li>jadx 反编译 dex 源码</li>
<li>apktools 拆解 apk</li>
<li>mitmproxy 中间人拦截网络请求</li>
</ul>
<h2 id=0x01-目标和方向选择>0x01 目标和方向选择</h2>
<p>首要的目标是破解这个软件的 api 加密。</p>
<p>使用 mitmproxy 抓到 https 流量，发现请求体全部是 base64 ，解码发现乱码。基本断定是加密了。</p>
<blockquote>
<p>mitmproxy 怎么抓 https 流量不多说了，基本流程就是装证书，然后配置代理。能看到有流量进 mitmproxy 就算成功了。</p>
<p>直接参考 mitmproxy 的文档快一点。</p>
</blockquote>
<p><img src=/blog/image/Just-crack-an-android-app/01.png alt=01></p>
<p>搜了一圈没有什么现成的对这个 App 的破解的文章，于是决定自己动手。</p>
<h2 id=0x02-解包和脱壳>0x02 解包和脱壳</h2>
<p>先确认下电脑上装了 JDK 或者 JRE ，没有的话就装好。</p>
<p>推荐一个 vscode 的插件，<code>apklab</code>。会帮你装好 jadx 和 apktools / signer 这些工具。</p>
<p>接下来直接用 <code>apklab</code> 打开需要破解的 apk 文件。</p>
<p><img src=/blog/image/Just-crack-an-android-app/02.png alt=02></p>
<p><img src=/blog/image/Just-crack-an-android-app/03.png alt=03></p>
<p><img src=/blog/image/Just-crack-an-android-app/04.png alt=04></p>
<p>apklab 会自动用 apktools 和 jadx 完成拆包和反编译。</p>
<p>然后简单观察&mldr;</p>
<p><img src=/blog/image/Just-crack-an-android-app/05.png alt=05></p>
<p>应该是被 360 加固了。</p>
<p>apk 加固的基本原理就是把易被反编译的 java 字节码转译或者加密后保存，运行的时候再释放出来。用过 upx 一类的软件应该会联想到，就是加壳、反调试什么的这一套。</p>
<p>xposed 提供了一个<a class=link href=https://api.xposed.info/reference/de/robv/android/xposed/IXposedHookLoadPackage.html target=_blank rel=noopener>在安卓包加载时设置钩子的机会</a>，将 ClassLoader Hook 掉，以此获得真正的应用字节码。</p>
<p>代码看参考资料。</p>
<p>安装 xposed 框架和 FDex2 之后启动目标应用，即可获得对应的字节码 dex 文件。</p>
<p><img src=/blog/image/Just-crack-an-android-app/06.png alt=06></p>
<p><img src=/blog/image/Just-crack-an-android-app/07.png alt=07></p>
<p>接着把这些 dex 文件复制出来，即可使用 jadx 反编译到 java 了。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>jadx -d out *.dex
</code></pre></div><p>将反编译的结果用 vscode 打开，可以看到目标已经被我们脱干净了。</p>
<p><img src=/blog/image/Just-crack-an-android-app/08.png alt=08></p>
<h2 id=0x03-寻找加解密代码>0x03 寻找加解密代码</h2>
<p>目标是解密 Api 请求的内容，所以下一步就是找到哪里保存了加密代码。</p>
<p>幸运的是这个 App 没有做过混淆，完成脱壳后就已经是全身赤裸的站在我们面前了。</p>
<p>直接在代码里搜索之前我们观察到的 url：<code>index_des.php</code>，仅有一个结果。</p>
<p><img src=/blog/image/Just-crack-an-android-app/09.png alt=09></p>
<p>相关函数非常短，这个 HTTP 框架我没有使用过，不过从函数名看应该是一个中间件模式，对所有 Web 请求进行加密处理。</p>
<p><img src=/blog/image/Just-crack-an-android-app/10.png alt=10></p>
<p><code>getOverPost2</code> 源码如下</p>
<p><img src=/blog/image/Just-crack-an-android-app/11.png alt=11></p>
<p>从代码里可以得出：</p>
<ul>
<li>g 的含义是 Get 请求的参数，应该就是 QueryString。函数名 <code>getOverPost2</code> 字面意义就是把 GET 请求以 POST 方式发送出去。</li>
<li>p 的含义大概就是 Post 的参数了。</li>
<li>加密代码在 <code>encryptByte</code></li>
</ul>
<p>如此看来已经接近终点了，再点开 <code>encryptByte</code> 的定义</p>
<p><img src=/blog/image/Just-crack-an-android-app/12.png alt=12></p>
<p>密钥保存在 <code>DesLib.sharedInstance().getAuthKey()</code> 中。</p>
<p>接着点开 <code>getAuthKey</code> 的定义:</p>
<p><img src=/blog/image/Just-crack-an-android-app/13.png alt=13></p>
<p><code>native</code> 关键字一出，得，白高兴了。差点劝退成功。</p>
<p>还是先看下怎么加密的。</p>
<p><img src=/blog/image/Just-crack-an-android-app/14.png alt=14></p>
<p>再往回翻一下响应解密的代码，免得拆除密钥来又白高兴一场。</p>
<p><img src=/blog/image/Just-crack-an-android-app/15.png alt=15></p>
<p><img src=/blog/image/Just-crack-an-android-app/16.png alt=16></p>
<p>很好，也是 DES 。</p>
<p>其实到这一步已经基本完成解密了，唯一欠缺的就是密钥。</p>
<p>抱着试一试的心情，还是找到了 <code>libencry.so</code> ，用 IDA 打开分析了一下。</p>
<p><img src=/blog/image/Just-crack-an-android-app/17.png alt=17></p>
<p>一通操作猛如虎，结果发现看不懂汇编。=w=</p>
<p>按下 F5，看看伪代码。</p>
<p><img src=/blog/image/Just-crack-an-android-app/18.png alt=18></p>
<p>还是看不懂。这都调的什么函数&mldr; <code>a1 + 668</code> 这个蜜汁偏移也不知道是在算什么。</p>
<p>网上搜索了一圈，说道可以手动改一下函数签名，IDA 就能提示出函数了。试试看。</p>
<p>先把函数签名纠正</p>
<p><img src=/blog/image/Just-crack-an-android-app/19.png alt=19></p>
<p><img src=/blog/image/Just-crack-an-android-app/20.png alt=20></p>
<p>再关掉类型转换</p>
<p><img src=/blog/image/Just-crack-an-android-app/21.png alt=21></p>
<p>最终关键代码清晰了很多，看起来就是个直接返回字符串常量的函数。</p>
<p><img src=/blog/image/Just-crack-an-android-app/22.png alt=22></p>
<p>比较具有迷惑性的是上面的 v5-v9，可以看到 v5-v9 地址是增长、连续的，只有 v5 和 v6 有值。v7/v8/v9 都是 0 。而 v5 的地址被用作 <code>NewStringUTF</code> 函数的参数。查阅 JNI 接口也可以看到这个参数应该是 <code>const char*</code> 类型。</p>
<p>所以 &mldr;</p>
<p>把数值转换成 16 进制再做观察。</p>
<p><img src=/blog/image/Just-crack-an-android-app/23.png alt=23></p>
<p>发现很有规律，每个字节的值都在 ASCII 范围内。于是右键转换成字符串，再按字节序翻转一下，即可得到密钥。</p>
<p>到此，解密方法的探索已经完成。</p>
<h2 id=0x04-mitmproxy-解密>0x04 mitmproxy 解密</h2>
<p>mitmproxy 支持使用 python 脚本扩展，用法很简单就是 <code>mitmweb.exe -s decrypt.py</code></p>
<p>可以参考 mitmproxy 的<a class=link href=https://github.com/mitmproxy/mitmproxy/blob/master/examples/addons/contentview.py target=_blank rel=noopener>例子</a></p>
<p>最终效果应该是这样</p>
<p><img src=/blog/image/Just-crack-an-android-app/25.png alt=24></p>
<p>核心的解密代码就一句，利用 mitmproxy 的扩展即可对每个请求进行统一的处理。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>from</span> <span class=nn>pyDes</span> <span class=kn>import</span> <span class=n>des</span><span class=p>,</span> <span class=n>PAD_PKCS5</span>

<span class=k>def</span> <span class=nf>decrypt</span><span class=p>(</span><span class=n>data</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>bytes</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>bytes</span><span class=p>:</span>
    <span class=k>return</span> <span class=n>des</span><span class=p>(</span><span class=n>key</span><span class=p>)</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>padmode</span><span class=o>=</span><span class=n>PAD_PKCS5</span><span class=p>)</span>
</code></pre></div><h2 id=0x05-结语>0x05 结语</h2>
<p>这个破解的最大意义还是完成了一次完整的安卓逆向，算是点亮了新技能。</p>
<p>以后再遇到一些傻逼软件或者强制推广的东西就可以用这一手技能来研究吐槽下都什么傻逼代码了。</p>
<p>当然非法的事情是不可能做的。</p>
<p>这玩意儿破解完之后发现有泄露隐私、被脱裤的严重漏洞，我也给市政平台发了件。</p>
<p>所以明年如果再硬推一次的话，到时候再拆了看看是不是有点长进。当然，没人管应该才是常态。</p>
</section>
<footer class=article-footer>
<section class=article-tags>
<a href=/blog/tags/%E9%80%86%E5%90%91/>逆向</a>
<a href=/blog/tags/java/>Java</a>
<a href=/blog/tags/c++/>c++</a>
<a href=/blog/tags/android/>Android</a>
</section>
<section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
</footer>
</article>
<aside class=related-contents--wrapper>
<h2 class=section-title>相关文章</h2>
<div class=related-contents>
<div class="flex article-list--tile">
<article>
<a href=/blog/p/learning-packer-02/>
<div class=article-details>
<h2 class=article-title>加壳原理02 - 简单加壳机</h2>
</div>
</a>
</article>
<article>
<a href=/blog/p/learning-packer-01-windows-program-load-and-execution/>
<div class=article-details>
<h2 class=article-title>加壳原理01 - Windows 程序的加载和运行</h2>
</div>
</a>
</article>
<article>
<a href=/blog/p/crackme-03/>
<div class=article-details>
<h2 class=article-title>自娱自乐 crackme-03</h2>
</div>
</a>
</article>
<article>
<a href=/blog/p/crackme-02/>
<div class=article-details>
<h2 class=article-title>自娱自乐 crackme-02</h2>
</div>
</a>
</article>
<article>
<a href=/blog/p/crackme-01/>
<div class=article-details>
<h2 class=article-title>自娱自乐 CrackMe-1</h2>
</div>
</a>
</article>
</div>
</div>
</aside>
<footer class=site-footer>
<section class=copyright>
&copy;
2021 weakptr's 笔记
</section>
<section class=powerby>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.1.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a>
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main>
<aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div>
<h2 class="widget-title section-title">目录</h2>
<div class=widget--toc>
<nav id=TableOfContents>
<ol>
<li><a href=#0x01-目标和方向选择>0x01 目标和方向选择</a></li>
<li><a href=#0x02-解包和脱壳>0x02 解包和脱壳</a></li>
<li><a href=#0x03-寻找加解密代码>0x03 寻找加解密代码</a></li>
<li><a href=#0x04-mitmproxy-解密>0x04 mitmproxy 解密</a></li>
<li><a href=#0x05-结语>0x05 结语</a></li>
</ol>
</nav>
</div>
</section>
</aside>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=/blog/ts/main.js defer></script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>