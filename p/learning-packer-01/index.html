<!doctype html><html lang=zh-cn dir=ltr>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="å‰è¨€ æœ¬æ–‡ç”±å¤šç¯‡ç›¸å…³æ–‡ç« ç¿»è¯‘æ•´åˆå¾—æ¥ï¼Œå‚è€ƒæ–‡ç« å’Œä¹¦ç›®æ–‡æœ«ç»™å‡ºã€‚ 0x01 PEæ–‡ä»¶ç»“æ„ 1.1 ä» PE-COFF æ ¼å¼è¯´èµ· &amp;hellip; ç°åœ¨PCå¹³å°æµè¡Œçš„ å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ï¼ˆExecutab"><title>åŠ å£³åŸç†01 - Windows ç¨‹åºçš„åŠ è½½å’Œè¿è¡Œ</title>
<link rel=canonical href=https://nnnewb.github.io/blog/p/learning-packer-01/>
<link rel=stylesheet href=/blog/scss/style.min.450926226e724574a6b936335ea06111f8aeb253d932c86cb2cc807341cd2889.css><meta property="og:title" content="åŠ å£³åŸç†01 - Windows ç¨‹åºçš„åŠ è½½å’Œè¿è¡Œ">
<meta property="og:description" content="å‰è¨€ æœ¬æ–‡ç”±å¤šç¯‡ç›¸å…³æ–‡ç« ç¿»è¯‘æ•´åˆå¾—æ¥ï¼Œå‚è€ƒæ–‡ç« å’Œä¹¦ç›®æ–‡æœ«ç»™å‡ºã€‚ 0x01 PEæ–‡ä»¶ç»“æ„ 1.1 ä» PE-COFF æ ¼å¼è¯´èµ· &amp;hellip; ç°åœ¨PCå¹³å°æµè¡Œçš„ å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ï¼ˆExecutab">
<meta property="og:url" content="https://nnnewb.github.io/blog/p/learning-packer-01/">
<meta property="og:site_name" content="weakptr's ç¬”è®°">
<meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="é€†å‘"><meta property="article:tag" content="æ±‡ç¼–"><meta property="article:tag" content="windows"><meta property="article:published_time" content="2021-09-27T14:51:00+08:00"><meta property="article:modified_time" content="2021-09-27T14:51:00+08:00"><meta property="og:image" content="https://nnnewb.github.io/blog/p/learning-packer-01/cover.jpg">
<meta name=twitter:title content="åŠ å£³åŸç†01 - Windows ç¨‹åºçš„åŠ è½½å’Œè¿è¡Œ">
<meta name=twitter:description content="å‰è¨€ æœ¬æ–‡ç”±å¤šç¯‡ç›¸å…³æ–‡ç« ç¿»è¯‘æ•´åˆå¾—æ¥ï¼Œå‚è€ƒæ–‡ç« å’Œä¹¦ç›®æ–‡æœ«ç»™å‡ºã€‚ 0x01 PEæ–‡ä»¶ç»“æ„ 1.1 ä» PE-COFF æ ¼å¼è¯´èµ· &amp;hellip; ç°åœ¨PCå¹³å°æµè¡Œçš„ å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ï¼ˆExecutab"><meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://nnnewb.github.io/blog/p/learning-packer-01/cover.jpg">
</head>
<body class=article-page>
<script>(function(){const a='StackColorScheme';localStorage.getItem(a)||localStorage.setItem(a,"dark")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky">
<button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box>
<span class=hamburger-inner></span>
</span>
</button>
<header>
<figure class=site-avatar>
<a href=/blog>
<img src=/blog/img/avatar_hub37949326d1692892aa1e64434c0dda6_382115_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a>
<span class=emoji>ğŸ‘</span>
</figure>
<div class=site-meta>
<h1 class=site-name><a href=/blog>weakptr's ç¬”è®°</a></h1>
<h2 class=site-description>å¼ƒèˆ¹ï¼</h2>
</div>
</header><ol class=social-menu>
<li>
<a href=https://github.com/nnnewb/ target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg>
</a>
</li>
</ol><ol class=menu id=main-menu>
<li>
<a href=/blog><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>é¦–é¡µ</span>
</a>
</li>
<li>
<a href=/blog/about><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>å…³äºæˆ‘</span>
</a>
</li>
<li>
<a href=/blog/archive><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>å½’æ¡£</span>
</a>
</li>
<li>
<a href=/blog/categories><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
<span>åˆ†ç±»</span>
</a>
</li>
<li>
<a href=/blog/link><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>å‹é“¾</span>
</a>
</li>
<li>
<a href=/blog/search><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>æœç´¢</span>
</a>
</li>
<div class=menu-bottom-section>
<li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>æš—è‰²æ¨¡å¼</span>
</li>
</div>
</ol>
</aside>
<main class="main full-width">
<article class="has-image main-article">
<header class=article-header>
<div class=article-image>
<a href=/blog/p/learning-packer-01/>
<img src=/blog/p/learning-packer-01/cover_hu8b7651a2bda3b235d3ed49f67a1e20bd_99156_800x0_resize_q75_box.jpg srcset="/blog/p/learning-packer-01/cover_hu8b7651a2bda3b235d3ed49f67a1e20bd_99156_800x0_resize_q75_box.jpg 800w, /blog/p/learning-packer-01/cover_hu8b7651a2bda3b235d3ed49f67a1e20bd_99156_1600x0_resize_q75_box.jpg 1600w" width=800 height=390 loading=lazy alt="Featured image of post åŠ å£³åŸç†01 - Windows ç¨‹åºçš„åŠ è½½å’Œè¿è¡Œ">
</a>
</div>
<div class=article-details>
<header class=article-category>
<a href=/blog/categories/%E9%80%86%E5%90%91/>
é€†å‘
</a>
</header>
<div class=article-title-wrapper>
<h2 class=article-title>
<a href=/blog/p/learning-packer-01/>åŠ å£³åŸç†01 - Windows ç¨‹åºçš„åŠ è½½å’Œè¿è¡Œ</a>
</h2>
</div>
<footer class=article-time>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2021å¹´ 9æœˆ 27æ—¥</time>
</div>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>
é˜…è¯»æ—¶é•¿: 20 åˆ†é’Ÿ
</time>
</div>
</footer>
</div>
</header>
<section class=article-content>
<h2 id=å‰è¨€>å‰è¨€</h2>
<p>æœ¬æ–‡ç”±å¤šç¯‡ç›¸å…³æ–‡ç« ç¿»è¯‘æ•´åˆå¾—æ¥ï¼Œå‚è€ƒæ–‡ç« å’Œä¹¦ç›®æ–‡æœ«ç»™å‡ºã€‚</p>
<h2 id=0x01-peæ–‡ä»¶ç»“æ„>0x01 PEæ–‡ä»¶ç»“æ„</h2>
<p><img src=/blog/p/learning-packer-01/PE_Format.png width=2048 height=1526 srcset="/blog/p/learning-packer-01/PE_Format_hu1d6972d7cbd2497cb5e2be07eb52e9a7_686257_480x0_resize_box_3.png 480w, /blog/p/learning-packer-01/PE_Format_hu1d6972d7cbd2497cb5e2be07eb52e9a7_686257_1024x0_resize_box_3.png 1024w" loading=lazy alt=PE_Format class=gallery-image data-flex-grow=134 data-flex-basis=322px></p>
<h3 id=11-ä»-pe-coff-æ ¼å¼è¯´èµ·>1.1 ä» PE-COFF æ ¼å¼è¯´èµ·</h3>
<blockquote>
<p>&mldr; ç°åœ¨PCå¹³å°æµè¡Œçš„ <strong>å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ï¼ˆExecutableï¼‰</strong> ä¸»è¦æ˜¯ Windows ä¸‹çš„ PE ï¼ˆPortable Executableï¼‰ å’Œ Linux çš„ ELF ï¼ˆExecutable Linkable Formatï¼‰ï¼Œå®ƒä»¬éƒ½æ˜¯ COFFï¼ˆCommon Object File Formatï¼‰æ ¼å¼çš„å˜ç§ã€‚ç›®æ ‡æ–‡ä»¶å°±æ˜¯æºä»£ç ç¼–è¯‘åä½†æœªè¿›è¡Œé“¾æ¥çš„é‚£äº›ä¸­é—´æ–‡ä»¶ï¼ˆWindows çš„ .obj å’Œ Linux ä¸‹çš„ .oï¼‰ï¼Œå®ƒå’Œå¯æ‰§è¡Œæ–‡ä»¶çš„å†…å®¹å’Œç»“æ„å¾ˆç›¸ä¼¼ï¼Œæ‰€ä»¥ä¸€èˆ¬è·Ÿå¯æ‰§è¡Œæ–‡ä»¶ä¸€èµ·é‡‡ç”¨ä¸€ç§æ ¼å¼å­˜å‚¨ã€‚ä»å¹¿ä¹‰ä¸Šçœ‹ï¼Œç›®æ ‡æ–‡ä»¶ä¸å¯æ‰§è¡Œæ–‡ä»¶çš„æ ¼å¼å…¶å®å‡ ä¹æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¹¿ä¹‰åœ°å°†ç›®æ ‡æ–‡ä»¶ä¸å¯æ‰§è¡Œæ–‡ä»¶çœ‹æˆæ˜¯åŒä¸€ç§ç±»å‹çš„æ–‡ä»¶ï¼Œåœ¨ Windows ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ç»Ÿç§°å®ƒä»¬ä¸º PE-COFF æ–‡ä»¶æ ¼å¼ã€‚åœ¨ Linux ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒä»¬ç»Ÿç§°ä¸º ELF æ–‡ä»¶ã€‚</p>
<p>&mldr; ä¸å…‰æ˜¯ <strong>å¯æ‰§è¡Œæ–‡ä»¶</strong> ï¼ˆWindows çš„ .exe å’Œ Linux ä¸‹çš„ ELF å¯æ‰§è¡Œæ–‡ä»¶ï¼‰æŒ‰ç…§å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼å­˜å‚¨ã€‚<strong>åŠ¨æ€é“¾æ¥åº“ï¼ˆDLLï¼ŒDynamic Linking Libraryï¼‰</strong> ï¼ˆWindows çš„ DLL å’Œ Linux ä¸‹çš„ .so ï¼‰ä»¥åŠ<strong>é™æ€é“¾æ¥åº“ ï¼ˆStatic Linking Libraryï¼‰</strong> ï¼ˆWindows çš„ .lib å’Œ Linux ä¸‹çš„ .aï¼‰æ–‡ä»¶éƒ½æŒ‰ç…§å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼å­˜å‚¨ã€‚å®ƒä»¬åœ¨ Windows ä¸‹éƒ½æŒ‰ç…§ PE-COFF æ ¼å¼å­˜å‚¨ï¼ŒLinux ä¸‹æŒ‰ç…§ ELF æ ¼å¼å­˜å‚¨ã€‚é™æ€é“¾æ¥åº“ç¨æœ‰ä¸åŒï¼Œå®ƒæ˜¯æŠŠå¾ˆå¤šç›®æ ‡æ–‡ä»¶æ†ç»‘åœ¨ä¸€èµ·å½¢æˆä¸€ä¸ªæ–‡ä»¶ï¼Œå†åŠ ä¸Šä¸€äº›ç´¢å¼•ï¼Œå¯ä»¥ç®€å•ç†è§£ä¸ºä¸€ä¸ªåŒ…å«å¾ˆå¤šç›®æ ‡æ–‡ä»¶çš„æ–‡ä»¶åŒ…ã€‚</p>
<p>&mldr; COFF çš„ä¸»è¦è´¡çŒ®æ˜¯åœ¨ç›®æ ‡æ–‡ä»¶å¼•å…¥äº†â€œæ®µâ€çš„æœºåˆ¶ï¼Œä¸åŒçš„ç›®æ ‡æ–‡ä»¶å¯ä»¥æ‹¥æœ‰ä¸åŒæ•°é‡åŠä¸åŒç±»å‹çš„â€œæ®µâ€ã€‚å¦å¤–ï¼Œå®ƒè¿˜å®šä¹‰äº†è°ƒè¯•æ•°æ®çš„æ ¼å¼ã€‚</p>
<p>â€”â€”ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»â€”â€”é“¾æ¥ã€è£…è½½ä¸åº“ã€‹</p>
</blockquote>
<p>è¿™é‡Œè®¨è®ºå¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ï¼Œç›®æ ‡æ–‡ä»¶ã€é™æ€åº“ã€åŠ¨æ€åº“éƒ½å…ˆæš‚æ—¶ä¸è€ƒè™‘ã€‚btwï¼Œå¼•æ–‡ä¸­çš„â€œæ®µâ€å…¶å®è¯´çš„æ—¢æ˜¯Sectionä¹Ÿæ˜¯Segmentï¼Œæ ¹æ®ä¸Šä¸‹æ–‡è‡ªå·±ç†è§£ã€‚</p>
<h3 id=12-pe-æ–‡ä»¶å¤´ä¸€è§ˆ>1.2 PE æ–‡ä»¶å¤´ä¸€è§ˆ</h3>
<p>PEæ ¼å¼åœ¨ Wiki ä¸Šæœ‰å¼ æŒºæ¼‚äº®çš„å›¾ã€‚</p>
<p><img src=/blog/p/learning-packer-01/Portable_Executable_32_bit_Structure_in_SVG_fixed.png width=2980 height=4213 srcset="/blog/p/learning-packer-01/Portable_Executable_32_bit_Structure_in_SVG_fixed_hu17a376e08455c311f7e43d421ffa5e76_295222_480x0_resize_box_3.png 480w, /blog/p/learning-packer-01/Portable_Executable_32_bit_Structure_in_SVG_fixed_hu17a376e08455c311f7e43d421ffa5e76_295222_1024x0_resize_box_3.png 1024w" loading=lazy alt=Portable_Executable_32_bit_Structure_in_SVG_fixed class=gallery-image data-flex-grow=70 data-flex-basis=169px></p>
<p>å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå¾®è½¯çš„å…¼å®¹åŒ…è¢±æ˜¯çœŸçš„é‡ï¼ˆä¸æ˜¯ï¼‰ã€‚</p>
<p>PEæ–‡ä»¶å¤´å·²ç»åŒ…å«äº†æµ·é‡çš„ä¿¡æ¯ï¼Œå¤§éƒ¨åˆ†æˆ‘ä»¬ä¸å…³æ³¨ï¼ˆæˆ–è€…è¯´å¾ˆå°‘å…³æ³¨ï¼Ÿï¼‰ï¼Œä»åšä¸ªç®€å•å£³çš„ç›®çš„å‡ºå‘ï¼Œäº†è§£äº†PE-COFFæ ¼å¼çš„ä¸€ç‚¹é€šè¯†å’Œå†å²åå°±å¯ä»¥ç»§ç»­äº†ã€‚</p>
<p>è¯»æ‡‚è¿™å›¾éœ€è¦äº†è§£ä¸‹å…³äºPEæ–‡ä»¶ä¸­å‡ ç§â€œåœ°å€â€çš„æ¦‚å¿µï¼š</p>
<ul>
<li><em>raw addresses</em>ï¼Œæˆ–è€…æ–‡ä»¶åç§» <em>file offset</em>ï¼Œè¿™ç§åœ°å€æŒ‡çš„æ˜¯ <strong>PE æ–‡ä»¶ä¸­çš„åç§»</strong>ã€‚</li>
<li><em>virtual addresses</em>ï¼Œè™šæ‹Ÿåœ°å€ï¼ŒæŒ‡åœ¨ RAM ä¸­çš„åœ°å€ï¼Œå°±æ˜¯ä¸€èˆ¬å¸¸è¯´çš„è¿›ç¨‹åœ°å€ç©ºé—´é‡Œçš„åœ°å€ã€‚</li>
<li><em>relative virtual addresses</em>ï¼Œç›¸å¯¹é•œåƒåŸºå€ï¼ˆImage Baseï¼‰çš„è™šæ‹Ÿåœ°å€ï¼Œä¸è€ƒè™‘ ASLR çš„æƒ…å†µä¸‹ï¼Œç›¸å¯¹åœ°å€è®¡ç®—å°±æ˜¯åŸºå€+RVAã€‚</li>
</ul>
<p>å¯ä»¥ç†è§£æˆï¼ŒVA å°±æ˜¯åŸºå€+RVAï¼ŒRVAå°±æ˜¯VA-åŸºå€ã€‚</p>
<p>VA/RVA è½¬æ–‡ä»¶åç§»å°±éº»çƒ¦å¾ˆå¤šï¼Œè¦æ ¹æ®èŠ‚è¡¨ <em>Section Table</em> è®¡ç®—ã€‚</p>
<p>ä¸Šè¿°é•œåƒåŸºå€ <em>Image Base</em> å’ŒèŠ‚è¡¨ <em>Section Table</em> éƒ½å¯ä»¥åœ¨å›¾é‡Œæ‰¾åˆ°ã€‚</p>
<h3 id=13-dos-æ–‡ä»¶å¤´>1.3 DOS æ–‡ä»¶å¤´</h3>
<p>æˆ‘ä»¬å¯ä»¥ç”¨åœ¨ Python REPL ä¸­ç”¨ <a class=link href=https://pypi.org/project/pefile target=_blank rel=noopener>pefile</a> æ¥å¿«é€Ÿåˆ†æå’ŒæŸ¥çœ‹PEæ–‡ä»¶ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>pefile</span>
<span class=n>pe</span> <span class=o>=</span> <span class=n>pefile</span><span class=o>.</span><span class=n>PE</span><span class=p>(</span><span class=s1>&#39;cm04.exe&#39;</span><span class=p>)</span> <span class=c1># cm04 æ˜¯C++å†™çš„å¸¦ç•Œé¢ Hello worldï¼Œä½ ä¹Ÿå¯ä»¥ç”¨è®¡ç®—å™¨ï¼ŒC:\Windows\System32\calc.exe</span>
<span class=nb>print</span><span class=p>(</span><span class=n>pe</span><span class=o>.</span><span class=n>DOS_HEADERS</span><span class=p>)</span>
</code></pre></td></tr></table>
</div>
</div><p>ç»“æœå¦‚ä¸‹</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>[IMAGE_DOS_HEADER]
0x0        0x0   e_magic:                       0x5A4D
0x2        0x2   e_cblp:                        0x90
0x4        0x4   e_cp:                          0x3
0x6        0x6   e_crlc:                        0x0
0x8        0x8   e_cparhdr:                     0x4
0xA        0xA   e_minalloc:                    0x0
0xC        0xC   e_maxalloc:                    0xFFFF
0xE        0xE   e_ss:                          0x0
0x10       0x10  e_sp:                          0xB8
0x12       0x12  e_csum:                        0x0
0x14       0x14  e_ip:                          0x0
0x16       0x16  e_cs:                          0x0
0x18       0x18  e_lfarlc:                      0x40
0x1A       0x1A  e_ovno:                        0x0
0x1C       0x1C  e_res:
0x24       0x24  e_oemid:                       0x0
0x26       0x26  e_oeminfo:                     0x0
0x28       0x28  e_res2:
0x3C       0x3C  e_lfanew:                      0x108
</code></pre></td></tr></table>
</div>
</div><p>ç¬¬ä¸€åˆ—æ˜¯æ–‡ä»¶åç§»ï¼Œç¬¬äºŒåˆ—æ˜¯ç»“æ„å†…çš„ç›¸å¯¹åç§»ï¼Œç¬¬ä¸‰åˆ—æ˜¯å­—æ®µåï¼Œç¬¬å››åˆ—æ˜¯å€¼ã€‚</p>
<p>DOSæ–‡ä»¶å¤´é‡ŒåŸºæœ¬éƒ½æ˜¯ä¸ºå…¼å®¹ä¿ç•™çš„å­—æ®µï¼Œæ²¡æœ‰æˆ‘ä»¬éœ€è¦çš„ä¿¡æ¯ã€‚éœ€è¦å…³æ³¨çš„ä¸»è¦æ˜¯å¼€å¤´çš„<code>e_magic</code>ï¼Œå›ºå®šä¸º<code>0x5A4D</code>ï¼Œä¹Ÿå°±æ˜¯ASCIIç¼–ç çš„<code>MZ</code>ï¼›è¿˜æœ‰æœ«å°¾çš„<code>e_lfanew</code>ï¼Œè¿™ä¸ªå­—æ®µä¿å­˜çš„æ˜¯NTæ–‡ä»¶å¤´çš„æ–‡ä»¶åç§»ï¼Œå¯¹ç…§ä¸Šæ–‡çš„å›¾ç‰‡ï¼Œå°±æ˜¯ç»¿è‰² COFF Header å¼€å¤´çš„ Signatureã€‚</p>
<h3 id=14-ntfilecoff-æ–‡ä»¶å¤´>1.4 NT/File/COFF æ–‡ä»¶å¤´</h3>
<p>è¿™éƒ¨åˆ†å¼€å§‹ï¼Œæ•°æ®ç»“æ„å®šä¹‰å’Œä¸Šæ–‡ä¸­çš„PEæ–‡ä»¶å¤´å›¾æœ‰ç‚¹å·®å¼‚ï¼ˆä¸»è¦æ˜¯å­—æ®µåˆ’åˆ†å½’ç±»ä¸Šï¼‰ï¼Œç¼–ç¨‹çš„æ—¶å€™æŒ‰å®é™…æ•°æ®ç»“æ„å†™ï¼Œçœ‹ç†è®ºçš„æ—¶å€™éµç…§æ–‡æ¡£è¯´æ³•æ¥çµæ´»ç†è§£å§ã€‚ä¹‹åCç»“æ„å®šä¹‰åœ¨å­—æ®µå½’ç±»ä¸Šä¹Ÿæœ‰ç‚¹å·®åˆ«çš„ã€‚æ€»ä¹‹ï¼Œå‚è€ƒå­—æ®µå¤§å°é¡ºåºï¼Œåˆ«å¤ªåœ¨æ„ç»“æ„æ€ä¹ˆå†™çš„ã€‚</p>
<p>ç”¨ <code>print(pe.NT_HEADERS)</code> å¯ä»¥çœ‹åˆ°åªè¾“å‡ºäº†ä¸€ä¸ª Signatureã€‚å‰©ä½™çš„ COFF Header å¯ä»¥ç”¨ <code>pe.FILE_HEADER</code> æŸ¥çœ‹ï¼ˆåœ¨å¾®è½¯ <a class=link href=https://docs.microsoft.com/en-us/windows/win32/debug/pe-format#file-headers target=_blank rel=noopener>PE Format æ–‡æ¡£</a>ä¸­ï¼ŒSignature ä¸æ˜¯ COFF File Header çš„ç»„æˆéƒ¨åˆ†ï¼Œå’Œ Wiki çš„å›¾ä¸ä¸€è‡´ï¼‰ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>In [4]: print(pe.FILE_HEADER)
[IMAGE_FILE_HEADER]
0x10C      0x0   Machine:                       0x14C
0x10E      0x2   NumberOfSections:              0x7
0x110      0x4   TimeDateStamp:                 0x61501513 [Sun Sep 26 06:37:07 2021 UTC]
0x114      0x8   PointerToSymbolTable:          0x0
0x118      0xC   NumberOfSymbols:               0x0
0x11C      0x10  SizeOfOptionalHeader:          0xE0
0x11E      0x12  Characteristics:               0x102
</code></pre></td></tr></table>
</div>
</div><p>åœ¨è¿™éƒ¨åˆ†æ–‡ä»¶å¤´ä¸­æœ‰å‡ ä¸ªé‡è¦å­—æ®µï¼š<code>NumberOfSections</code>ï¼ŒPEæ–‡ä»¶ä¸­èŠ‚çš„æ•°é‡ï¼›ä»¥åŠ <code>Characteristics</code>ï¼Œ16æ¯”ç‰¹æ ‡å¿—ä½å­—æ®µï¼Œæ ‡è¯†PEæ–‡ä»¶çš„ä¸€äº›åŸºæœ¬å±æ€§ã€‚<a class=link href=https://docs.microsoft.com/en-us/windows/win32/debug/pe-format#characteristics target=_blank rel=noopener>å¯ç”¨çš„å±æ€§æ¸…å•é“¾æ¥</a>ã€‚</p>
<h3 id=15-å¯é€‰æ–‡ä»¶å¤´>1.5 å¯é€‰æ–‡ä»¶å¤´</h3>
<p>è™½ç„¶å«å¯é€‰æ–‡ä»¶å¤´ï¼ˆOptional Headerï¼‰ï¼Œä½†å¹¶ä¸å¯é€‰ã€‚å¯ä»¥ç…§ä¾‹è¾“å‡ºçœ‹çœ‹ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>In [5]: print(pe.OPTIONAL_HEADER)
[IMAGE_OPTIONAL_HEADER]
0x120      0x0   Magic:                         0x10B
0x122      0x2   MajorLinkerVersion:            0xE
0x123      0x3   MinorLinkerVersion:            0x1D
0x124      0x4   SizeOfCode:                    0x6800
0x128      0x8   SizeOfInitializedData:         0xD000
0x12C      0xC   SizeOfUninitializedData:       0x0
0x130      0x10  AddressOfEntryPoint:           0x1005
0x134      0x14  BaseOfCode:                    0x1000
0x138      0x18  BaseOfData:                    0x8000
0x13C      0x1C  ImageBase:                     0x400000
0x140      0x20  SectionAlignment:              0x1000
0x144      0x24  FileAlignment:                 0x200
0x148      0x28  MajorOperatingSystemVersion:   0x6
0x14A      0x2A  MinorOperatingSystemVersion:   0x0
0x14C      0x2C  MajorImageVersion:             0x0
0x14E      0x2E  MinorImageVersion:             0x0
0x150      0x30  MajorSubsystemVersion:         0x6
0x152      0x32  MinorSubsystemVersion:         0x0
0x154      0x34  Reserved1:                     0x0
0x158      0x38  SizeOfImage:                   0x19000
0x15C      0x3C  SizeOfHeaders:                 0x400
0x160      0x40  CheckSum:                      0x0
0x164      0x44  Subsystem:                     0x2
0x166      0x46  DllCharacteristics:            0x8140
0x168      0x48  SizeOfStackReserve:            0x100000
0x16C      0x4C  SizeOfStackCommit:             0x1000
0x170      0x50  SizeOfHeapReserve:             0x100000
0x174      0x54  SizeOfHeapCommit:              0x1000
0x178      0x58  LoaderFlags:                   0x0
0x17C      0x5C  NumberOfRvaAndSizes:           0x10
</code></pre></td></tr></table>
</div>
</div><p>å…¶ä¸­å¤§éƒ¨åˆ†å­—æ®µè¦ä¸ç„¶æ˜¯æ²¡ç”¨åˆ°ï¼Œè¦ä¸ç„¶å°±æ˜¯å›ºå®šå€¼ä¸å˜ã€‚å‡ ä¸ªå€¼å¾—å…³æ³¨çš„å­—æ®µå¦‚ä¸‹ã€‚</p>
<ul>
<li><code>Magic</code>ï¼ŒåŒºåˆ† PE32/PE64 æ ¼å¼ã€‚å¾®è½¯æ–‡æ¡£ç»™å‡ºçš„æ˜¯ <code>0x10b</code> å¯¹åº” <code>PE32</code>ï¼Œ<code>0x20b</code> å¯¹åº” <code>PE32+</code>ã€‚</li>
<li><code>AddressOfEntryPoint</code>ï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶åŠ è½½åè¦æ‰§è¡Œçš„ç¬¬ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œç¨‹åºçš„å…¥å£ç‚¹ï¼Œ<strong>æ³¨æ„æ˜¯RVA</strong>ã€‚</li>
<li><code>ImageBase</code>ï¼Œåå¥½çš„é•œåƒåŸºå€ã€‚RVAå’Œè¿™ä¸ªåŸºå€ç›¸åŠ å¾—åˆ°VAã€‚æ³¨æ„å› ä¸ºASLRçš„å­˜åœ¨ï¼ŒçœŸå®åŸºå€åœ¨è¿è¡Œå‰å¹¶ä¸ç¡®å®šã€‚</li>
<li><code>SizeOfImage</code>ï¼Œé•œåƒçš„ <em>è™šæ‹Ÿå¤§å°</em> ï¼Œæ˜¯åŠ è½½å¯æ‰§è¡Œæ–‡ä»¶åˆ°å†…å­˜æ—¶éœ€è¦ç”³è¯·çš„å†…å­˜å¤§å°ã€‚</li>
<li><code>SizeOfHeaders</code>ï¼Œæ‰€æœ‰æ–‡ä»¶å¤´ï¼ˆDOSã€NTã€COFFã€Optional &mldr;ï¼‰çš„æ€»å¤§å°ã€‚</li>
<li><code>DLLCharacteristics</code>ï¼Œå„ç§æ ‡å¿—ä½ï¼Œæœ€æœ‰ç”¨çš„æ˜¯<code>IMAGE_DLLCHARACTERISTICS_DYNAMIC_BASE</code> ï¼ŒæŒ‡å®šé•œåƒåŸºå€æ˜¯å¦å¯ç§»åŠ¨ï¼ˆä¹Ÿå°±æ˜¯èƒ½ä¸èƒ½å¼€å¯ASLR åŸºå€éšæœºåŒ–ï¼‰ã€‚</li>
</ul>
<h2 id=0x02-åŠ è½½pe>0x02 åŠ è½½PE</h2>
<p>å¯¹PEæ ¼å¼æœ‰äº†åŸºæœ¬äº†è§£åï¼Œå°±å¯ä»¥å¼€å§‹å°è¯•åŠ è½½ PE æ–‡ä»¶åˆ°å†…å­˜é‡Œäº†ã€‚</p>
<h3 id=21-åŠ è½½å’Œå†…å­˜åˆå§‹åŒ–>2.1 åŠ è½½å’Œå†…å­˜åˆå§‹åŒ–</h3>
<p>PEæ–‡ä»¶å¤´æ€»æ˜¯åŠ è½½åˆ°é•œåƒåŸºå€å¤„ã€‚å…ˆå†™ä¸€ä¸ªç®€å•çš„Cç¨‹åºï¼ŒæŠŠ PE æ–‡ä»¶è¯»å–ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=cp>#include</span> <span class=cpf>&lt;Windows.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;winnt.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=k>const</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;missing path argument</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
    <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=n>FILE</span> <span class=o>*</span><span class=n>exe_file</span> <span class=o>=</span> <span class=n>fopen</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=s>&#34;rb&#34;</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>exe_file</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;error opening file</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
    <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=c1>// Get file size : put pointer at the end
</span><span class=c1></span>  <span class=n>fseek</span><span class=p>(</span><span class=n>exe_file</span><span class=p>,</span> <span class=mi>0L</span><span class=p>,</span> <span class=n>SEEK_END</span><span class=p>);</span>
  <span class=c1>// and read its position
</span><span class=c1></span>  <span class=kt>long</span> <span class=kt>int</span> <span class=n>file_size</span> <span class=o>=</span> <span class=n>ftell</span><span class=p>(</span><span class=n>exe_file</span><span class=p>);</span>
  <span class=c1>// put the pointer back at the beginning
</span><span class=c1></span>  <span class=n>fseek</span><span class=p>(</span><span class=n>exe_file</span><span class=p>,</span> <span class=mi>0L</span><span class=p>,</span> <span class=n>SEEK_SET</span><span class=p>);</span>

  <span class=c1>// allocate memory and read the whole file
</span><span class=c1></span>  <span class=kt>char</span> <span class=o>*</span><span class=n>exe_file_data</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=n>file_size</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>

  <span class=c1>// read whole file
</span><span class=c1></span>  <span class=n>size_t</span> <span class=n>n_read</span> <span class=o>=</span> <span class=n>fread</span><span class=p>(</span><span class=n>exe_file_data</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>file_size</span><span class=p>,</span> <span class=n>exe_file</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>n_read</span> <span class=o>!=</span> <span class=n>file_size</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;reading error (%d)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>n_read</span><span class=p>);</span>
    <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=c1>// load the PE in memory
</span><span class=c1></span>  <span class=n>printf</span><span class=p>(</span><span class=s>&#34;[+] Loading PE file</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>

  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>å…ˆå†™è¿™ä¹ˆå¤šï¼Œå†…å®¹åªæœ‰ç®€å•åœ°æ–‡ä»¶IOï¼Œè¯»å–PEæ–‡ä»¶åˆ°å†…å­˜ï¼Œæ¥ä¸‹æ¥å†™ä¸€ä¸ª <code>void* load_PE(char* PE_data)</code> å‡½æ•°ï¼ŒåŠ è½½PEæ–‡ä»¶å†…å®¹åˆ°å†…å­˜ç©ºé—´ï¼Œè¿”å›åŠ è½½åçš„é•œåƒåŸºå€ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>void</span> <span class=o>*</span><span class=nf>load_PE</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>PE_data</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>IMAGE_DOS_HEADER</span> <span class=o>*</span><span class=n>p_DOS_header</span> <span class=o>=</span> <span class=p>(</span><span class=n>IMAGE_DOS_HEADER</span> <span class=o>*</span><span class=p>)</span><span class=n>PE_data</span><span class=p>;</span>
  <span class=n>IMAGE_NT_HEADERS</span> <span class=o>*</span><span class=n>p_NT_headers</span> <span class=o>=</span> <span class=p>(</span><span class=n>IMAGE_NT_HEADERS</span> <span class=o>*</span><span class=p>)(</span><span class=n>PE_data</span> <span class=o>+</span> <span class=n>p_DOS_header</span><span class=o>-&gt;</span><span class=n>e_lfanew</span><span class=p>);</span>

  <span class=c1>// extract information from PE header
</span><span class=c1></span>  <span class=n>DWORD</span> <span class=n>size_of_image</span> <span class=o>=</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>OptionalHeader</span><span class=p>.</span><span class=n>SizeOfImage</span><span class=p>;</span>
  <span class=n>DWORD</span> <span class=n>entry_point_RVA</span> <span class=o>=</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>OptionalHeader</span><span class=p>.</span><span class=n>AddressOfEntryPoint</span><span class=p>;</span>
  <span class=n>DWORD</span> <span class=n>size_of_headers</span> <span class=o>=</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>OptionalHeader</span><span class=p>.</span><span class=n>SizeOfHeaders</span><span class=p>;</span>

  <span class=c1>// allocate memory
</span><span class=c1></span>  <span class=c1>// https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc
</span><span class=c1></span>  <span class=kt>char</span> <span class=o>*</span><span class=n>p_image_base</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>VirtualAlloc</span><span class=p>(</span><span class=nb>NULL</span><span class=p>,</span> <span class=n>size_of_image</span><span class=p>,</span> <span class=n>MEM_RESERVE</span> <span class=o>|</span> <span class=n>MEM_COMMIT</span><span class=p>,</span> <span class=n>PAGE_READWRITE</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>p_image_base</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=c1>// copy PE headers in memory
</span><span class=c1></span>  <span class=n>memcpy</span><span class=p>(</span><span class=n>p_image_base</span><span class=p>,</span> <span class=n>PE_data</span><span class=p>,</span> <span class=n>size_of_headers</span><span class=p>);</span>

  <span class=c1>// Section headers starts right after the IMAGE_NT_HEADERS struct, so we do some pointer arithmetic-fu here.
</span><span class=c1></span>  <span class=n>IMAGE_SECTION_HEADER</span> <span class=o>*</span><span class=n>sections</span> <span class=o>=</span> <span class=p>(</span><span class=n>IMAGE_SECTION_HEADER</span> <span class=o>*</span><span class=p>)(</span><span class=n>p_NT_headers</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>

  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>FileHeader</span><span class=p>.</span><span class=n>NumberOfSections</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// calculate the VA we need to copy the content, from the RVA
</span><span class=c1></span>    <span class=c1>// section[i].VirtualAddress is a RVA, mind it
</span><span class=c1></span>    <span class=kt>char</span> <span class=o>*</span><span class=n>dest</span> <span class=o>=</span> <span class=n>p_image_base</span> <span class=o>+</span> <span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>VirtualAddress</span><span class=p>;</span>

    <span class=c1>// check if there is Raw data to copy
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>SizeOfRawData</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
      <span class=c1>// We copy SizeOfRaw data bytes, from the offset PointerToRawData in the file
</span><span class=c1></span>      <span class=n>memcpy</span><span class=p>(</span><span class=n>dest</span><span class=p>,</span> <span class=n>PE_data</span> <span class=o>+</span> <span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>PointerToRawData</span><span class=p>,</span> <span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>SizeOfRawData</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
      <span class=n>memset</span><span class=p>(</span><span class=n>dest</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>Misc</span><span class=p>.</span><span class=n>VirtualSize</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=k>return</span> <span class=n>p_image_base</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>å‰å‡ å¥èµ‹å€¼éƒ½æ˜¯åœ¨ç”¨æŒ‡é’ˆè¿ç®—å–PEæ–‡ä»¶å¤´é‡Œçš„å­—æ®µã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c>  <span class=n>IMAGE_DOS_HEADER</span> <span class=o>*</span><span class=n>p_DOS_header</span> <span class=o>=</span> <span class=p>(</span><span class=n>IMAGE_DOS_HEADER</span> <span class=o>*</span><span class=p>)</span><span class=n>PE_data</span><span class=p>;</span>
  <span class=n>IMAGE_NT_HEADERS</span> <span class=o>*</span><span class=n>p_NT_headers</span> <span class=o>=</span> <span class=p>(</span><span class=n>IMAGE_NT_HEADERS</span> <span class=o>*</span><span class=p>)(</span><span class=n>PE_data</span> <span class=o>+</span> <span class=n>p_DOS_header</span><span class=o>-&gt;</span><span class=n>e_lfanew</span><span class=p>);</span>

  <span class=c1>// extract information from PE header
</span><span class=c1></span>  <span class=n>DWORD</span> <span class=n>size_of_image</span> <span class=o>=</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>OptionalHeader</span><span class=p>.</span><span class=n>SizeOfImage</span><span class=p>;</span>
  <span class=n>DWORD</span> <span class=n>entry_point_RVA</span> <span class=o>=</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>OptionalHeader</span><span class=p>.</span><span class=n>AddressOfEntryPoint</span><span class=p>;</span>
  <span class=n>DWORD</span> <span class=n>size_of_headers</span> <span class=o>=</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>OptionalHeader</span><span class=p>.</span><span class=n>SizeOfHeaders</span><span class=p>;</span>
</code></pre></td></tr></table>
</div>
</div><p>å…ˆæå–äº† DOS æ–‡ä»¶å¤´å’Œ NT æ–‡ä»¶å¤´ï¼ˆæ³¨æ„ï¼Œ File Header å’Œ Optional Header éƒ½åµŒåœ¨ NT æ–‡ä»¶å¤´ç»“æ„é‡Œï¼Œè¿™å°±æ˜¯ä¸ºå•¥æˆ‘è¯´ç»“æ„å®šä¹‰ä¼šå’Œä¸Šé¢çš„ wiki å›¾ä¸å¤§ä¸€æ ·ï¼‰ã€‚æ¥ç€ä»æ–‡ä»¶å¤´ç»“æ„é‡Œå–é•œåƒå¤§å°ã€å…¥å£ç‚¹RVAã€æ–‡ä»¶å¤´æ€»å¤§å°ï¼Œç”¨äºåç»­åˆ†é…å†…å­˜å’ŒæŒ‡é’ˆè¿ç®—ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c>  <span class=c1>// allocate memory
</span><span class=c1></span>  <span class=c1>// https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc
</span><span class=c1></span>  <span class=kt>char</span> <span class=o>*</span><span class=n>p_image_base</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>VirtualAlloc</span><span class=p>(</span><span class=nb>NULL</span><span class=p>,</span> <span class=n>size_of_image</span><span class=p>,</span> <span class=n>MEM_RESERVE</span> <span class=o>|</span> <span class=n>MEM_COMMIT</span><span class=p>,</span> <span class=n>PAGE_READWRITE</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>p_image_base</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
  <span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>ç´§æ¥ç€ç”¨ Win32 API åˆ†é…äº†ä¸€ç‰‡å†…å­˜ç©ºé—´ï¼Œå¤§å°ç”± PE æ–‡ä»¶å¤´çš„é•œåƒå¤§å°æŒ‡å®šã€‚ç”¨è¿™ä¸ªAPIçš„åŸå› æ˜¯ä¹‹åæˆ‘ä»¬éœ€è¦è®¾ç½®è¿™ç‰‡å†…å­˜ä¸ºå¯æ‰§è¡Œã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c>  <span class=c1>// copy PE headers in memory
</span><span class=c1></span>  <span class=n>memcpy</span><span class=p>(</span><span class=n>p_image_base</span><span class=p>,</span> <span class=n>PE_data</span><span class=p>,</span> <span class=n>size_of_headers</span><span class=p>);</span>
</code></pre></td></tr></table>
</div>
</div><p>PEæ–‡ä»¶å¤´æ€»æ˜¯åœ¨é•œåƒåŸºå€å¼€å§‹çš„ä½ç½®ï¼Œç›´æ¥å¤åˆ¶è¿‡å»ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c>  <span class=c1>// Section headers starts right after the IMAGE_NT_HEADERS struct, so we do some pointer arithmetic-fu here.
</span><span class=c1></span>  <span class=n>IMAGE_SECTION_HEADER</span> <span class=o>*</span><span class=n>sections</span> <span class=o>=</span> <span class=p>(</span><span class=n>IMAGE_SECTION_HEADER</span> <span class=o>*</span><span class=p>)(</span><span class=n>p_NT_headers</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</code></pre></td></tr></table>
</div>
</div><p>å–å·§çš„æ–¹å¼è·å¾—èŠ‚è¡¨æŒ‡é’ˆã€‚è¿™æ˜¯ä¸ªç®€å•çš„cæŒ‡é’ˆè¿ç®—ï¼Œ<code>p_NT_headers+1</code>å…¶å®å°±æ˜¯<code>(char*)p_NT_headers + sizeof(IMAGE_NT_HEADERS)</code>ï¼Œä¹Ÿå°±æ˜¯NT_HEADERS ç»“æ„ç´§é‚»çš„ä¸‹ä¸€ä¸ªå­—èŠ‚ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c>  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>FileHeader</span><span class=p>.</span><span class=n>NumberOfSections</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// calculate the VA we need to copy the content, from the RVA
</span><span class=c1></span>    <span class=c1>// section[i].VirtualAddress is a RVA, mind it
</span><span class=c1></span>    <span class=kt>char</span> <span class=o>*</span><span class=n>dest</span> <span class=o>=</span> <span class=n>p_image_base</span> <span class=o>+</span> <span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>VirtualAddress</span><span class=p>;</span>

    <span class=c1>// check if there is Raw data to copy
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>SizeOfRawData</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
      <span class=c1>// We copy SizeOfRaw data bytes, from the offset PointerToRawData in the file
</span><span class=c1></span>      <span class=n>memcpy</span><span class=p>(</span><span class=n>dest</span><span class=p>,</span> <span class=n>PE_data</span> <span class=o>+</span> <span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>PointerToRawData</span><span class=p>,</span> <span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>SizeOfRawData</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
      <span class=n>memset</span><span class=p>(</span><span class=n>dest</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>Misc</span><span class=p>.</span><span class=n>VirtualSize</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>æ¥ç€å°±æ˜¯éå†èŠ‚è¡¨ï¼Œå–èŠ‚çš„åŸºåœ°å€ï¼ŒPEæ–‡ä»¶ä¸­èŠ‚åŒ…å«æ•°æ®çš„è¯ï¼Œå°±å¤åˆ¶èŠ‚æ•°æ®åˆ°å†…å­˜ï¼Œå¦åˆ™æŠŠèŠ‚åˆå§‹åŒ–ä¸º0ã€‚</p>
<p>æ¥ç€è¡¥å……å¯æ‰§è¡Œæƒé™ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c>  <span class=c1>// Set permission for the PE hader to read only
</span><span class=c1></span>  <span class=n>DWORD</span> <span class=n>oldProtect</span><span class=p>;</span>
  <span class=n>VirtualProtect</span><span class=p>(</span><span class=n>p_image_base</span><span class=p>,</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>OptionalHeader</span><span class=p>.</span><span class=n>SizeOfHeaders</span><span class=p>,</span> <span class=n>PAGE_READONLY</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>oldProtect</span><span class=p>);</span>

  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>FileHeader</span><span class=p>.</span><span class=n>NumberOfSections</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
    <span class=kt>char</span> <span class=o>*</span><span class=n>dest</span> <span class=o>=</span> <span class=n>p_image_base</span> <span class=o>+</span> <span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>VirtualAddress</span><span class=p>;</span>
    <span class=n>DWORD</span> <span class=n>s_perm</span> <span class=o>=</span> <span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>Characteristics</span><span class=p>;</span>
    <span class=n>DWORD</span> <span class=n>v_perm</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=c1>// flags are not the same between virtal protect and the section header
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>s_perm</span> <span class=o>&amp;</span> <span class=n>IMAGE_SCN_MEM_EXECUTE</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>v_perm</span> <span class=o>=</span> <span class=p>(</span><span class=n>s_perm</span> <span class=o>&amp;</span> <span class=n>IMAGE_SCN_MEM_WRITE</span><span class=p>)</span> <span class=o>?</span> <span class=nl>PAGE_EXECUTE_READWRITE</span> <span class=p>:</span> <span class=n>PAGE_EXECUTE_READ</span><span class=p>;</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
      <span class=n>v_perm</span> <span class=o>=</span> <span class=p>(</span><span class=n>s_perm</span> <span class=o>&amp;</span> <span class=n>IMAGE_SCN_MEM_WRITE</span><span class=p>)</span> <span class=o>?</span> <span class=nl>PAGE_READWRITE</span> <span class=p>:</span> <span class=n>PAGE_READONLY</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=n>VirtualProtect</span><span class=p>(</span><span class=n>dest</span><span class=p>,</span> <span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>Misc</span><span class=p>.</span><span class=n>VirtualSize</span><span class=p>,</span> <span class=n>v_perm</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>oldProtect</span><span class=p>);</span>
  <span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>å…ˆæŠŠæ•´ä¸ªPEå¤´è®¾ç½®ä¸ºåªè¯»ï¼Œç„¶åéå†èŠ‚è¡¨ï¼Œå–èŠ‚åŸºåœ°å€å’Œæ ‡å¿—ä½ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=k>if</span> <span class=p>(</span><span class=n>s_perm</span> <span class=o>&amp;</span> <span class=n>IMAGE_SCN_MEM_EXECUTE</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>v_perm</span> <span class=o>=</span> <span class=p>(</span><span class=n>s_perm</span> <span class=o>&amp;</span> <span class=n>IMAGE_SCN_MEM_WRITE</span><span class=p>)</span> <span class=o>?</span> <span class=nl>PAGE_EXECUTE_READWRITE</span> <span class=p>:</span> <span class=n>PAGE_EXECUTE_READ</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>æ ¹æ®PEå¤´ä¸­èŠ‚çš„å¯å†™ã€å¯æ‰§è¡Œæ ‡å¿—ä½ï¼Œè®¾ç½®å†…å­˜ç©ºé—´ä¿æŠ¤æ–¹å¼ã€‚</p>
<p>æœ€åè¿”å›å…¥å£ç‚¹åœ°å€ï¼Œåœ¨ main å‡½æ•°é‡Œè·³è½¬ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c>  <span class=k>return</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)(</span><span class=n>p_image_base</span> <span class=o>+</span> <span class=n>entry_point_RVA</span><span class=p>);</span>
</code></pre></td></tr></table>
</div>
</div><p>å®Œæ•´ä»£ç å¦‚ä¸‹ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span><span class=lnt>96
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=cp>#include</span> <span class=cpf>&lt;Windows.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;winnt.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=k>const</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;missing path argument</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
    <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=n>FILE</span> <span class=o>*</span><span class=n>exe_file</span> <span class=o>=</span> <span class=n>fopen</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=s>&#34;rb&#34;</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>exe_file</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;error opening file</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
    <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=c1>// Get file size : put pointer at the end
</span><span class=c1></span>  <span class=n>fseek</span><span class=p>(</span><span class=n>exe_file</span><span class=p>,</span> <span class=mi>0L</span><span class=p>,</span> <span class=n>SEEK_END</span><span class=p>);</span>
  <span class=c1>// and read its position
</span><span class=c1></span>  <span class=kt>long</span> <span class=kt>int</span> <span class=n>file_size</span> <span class=o>=</span> <span class=n>ftell</span><span class=p>(</span><span class=n>exe_file</span><span class=p>);</span>
  <span class=c1>// put the pointer back at the beginning
</span><span class=c1></span>  <span class=n>fseek</span><span class=p>(</span><span class=n>exe_file</span><span class=p>,</span> <span class=mi>0L</span><span class=p>,</span> <span class=n>SEEK_SET</span><span class=p>);</span>

  <span class=c1>// allocate memory and read the whole file
</span><span class=c1></span>  <span class=kt>char</span> <span class=o>*</span><span class=n>exe_file_data</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=n>file_size</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>

  <span class=c1>// read whole file
</span><span class=c1></span>  <span class=n>size_t</span> <span class=n>n_read</span> <span class=o>=</span> <span class=n>fread</span><span class=p>(</span><span class=n>exe_file_data</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>file_size</span><span class=p>,</span> <span class=n>exe_file</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>n_read</span> <span class=o>!=</span> <span class=n>file_size</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;reading error (%d)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>n_read</span><span class=p>);</span>
    <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=c1>// load the PE in memory
</span><span class=c1></span>  <span class=n>printf</span><span class=p>(</span><span class=s>&#34;[+] Loading PE file</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>

  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=o>*</span><span class=nf>load_PE</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>PE_data</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>IMAGE_DOS_HEADER</span> <span class=o>*</span><span class=n>p_DOS_header</span> <span class=o>=</span> <span class=p>(</span><span class=n>IMAGE_DOS_HEADER</span> <span class=o>*</span><span class=p>)</span><span class=n>PE_data</span><span class=p>;</span>
  <span class=n>IMAGE_NT_HEADERS</span> <span class=o>*</span><span class=n>p_NT_headers</span> <span class=o>=</span> <span class=p>(</span><span class=n>IMAGE_NT_HEADERS</span> <span class=o>*</span><span class=p>)(</span><span class=n>PE_data</span> <span class=o>+</span> <span class=n>p_DOS_header</span><span class=o>-&gt;</span><span class=n>e_lfanew</span><span class=p>);</span>

  <span class=c1>// extract information from PE header
</span><span class=c1></span>  <span class=n>DWORD</span> <span class=n>size_of_image</span> <span class=o>=</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>OptionalHeader</span><span class=p>.</span><span class=n>SizeOfImage</span><span class=p>;</span>
  <span class=n>DWORD</span> <span class=n>entry_point_RVA</span> <span class=o>=</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>OptionalHeader</span><span class=p>.</span><span class=n>AddressOfEntryPoint</span><span class=p>;</span>
  <span class=n>DWORD</span> <span class=n>size_of_headers</span> <span class=o>=</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>OptionalHeader</span><span class=p>.</span><span class=n>SizeOfHeaders</span><span class=p>;</span>

  <span class=c1>// allocate memory
</span><span class=c1></span>  <span class=c1>// https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc
</span><span class=c1></span>  <span class=kt>char</span> <span class=o>*</span><span class=n>p_image_base</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>VirtualAlloc</span><span class=p>(</span><span class=nb>NULL</span><span class=p>,</span> <span class=n>size_of_image</span><span class=p>,</span> <span class=n>MEM_RESERVE</span> <span class=o>|</span> <span class=n>MEM_COMMIT</span><span class=p>,</span> <span class=n>PAGE_READWRITE</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>p_image_base</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=c1>// copy PE headers in memory
</span><span class=c1></span>  <span class=n>memcpy</span><span class=p>(</span><span class=n>p_image_base</span><span class=p>,</span> <span class=n>PE_data</span><span class=p>,</span> <span class=n>size_of_headers</span><span class=p>);</span>

  <span class=c1>// Section headers starts right after the IMAGE_NT_HEADERS struct, so we do some pointer arithmetic-fu here.
</span><span class=c1></span>  <span class=n>IMAGE_SECTION_HEADER</span> <span class=o>*</span><span class=n>sections</span> <span class=o>=</span> <span class=p>(</span><span class=n>IMAGE_SECTION_HEADER</span> <span class=o>*</span><span class=p>)(</span><span class=n>p_NT_headers</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>

  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>FileHeader</span><span class=p>.</span><span class=n>NumberOfSections</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// calculate the VA we need to copy the content, from the RVA
</span><span class=c1></span>    <span class=c1>// section[i].VirtualAddress is a RVA, mind it
</span><span class=c1></span>    <span class=kt>char</span> <span class=o>*</span><span class=n>dest</span> <span class=o>=</span> <span class=n>p_image_base</span> <span class=o>+</span> <span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>VirtualAddress</span><span class=p>;</span>

    <span class=c1>// check if there is Raw data to copy
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>SizeOfRawData</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
      <span class=c1>// We copy SizeOfRaw data bytes, from the offset PointerToRawData in the file
</span><span class=c1></span>      <span class=n>memcpy</span><span class=p>(</span><span class=n>dest</span><span class=p>,</span> <span class=n>PE_data</span> <span class=o>+</span> <span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>PointerToRawData</span><span class=p>,</span> <span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>SizeOfRawData</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
      <span class=n>memset</span><span class=p>(</span><span class=n>dest</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>Misc</span><span class=p>.</span><span class=n>VirtualSize</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=c1>// Set permission for the PE hader to read only
</span><span class=c1></span>  <span class=n>DWORD</span> <span class=n>oldProtect</span><span class=p>;</span>
  <span class=n>VirtualProtect</span><span class=p>(</span><span class=n>p_image_base</span><span class=p>,</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>OptionalHeader</span><span class=p>.</span><span class=n>SizeOfHeaders</span><span class=p>,</span> <span class=n>PAGE_READONLY</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>oldProtect</span><span class=p>);</span>

  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>FileHeader</span><span class=p>.</span><span class=n>NumberOfSections</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
    <span class=kt>char</span> <span class=o>*</span><span class=n>dest</span> <span class=o>=</span> <span class=n>p_image_base</span> <span class=o>+</span> <span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>VirtualAddress</span><span class=p>;</span>
    <span class=n>DWORD</span> <span class=n>s_perm</span> <span class=o>=</span> <span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>Characteristics</span><span class=p>;</span>
    <span class=n>DWORD</span> <span class=n>v_perm</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=c1>// flags are not the same between virtal protect and the section header
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>s_perm</span> <span class=o>&amp;</span> <span class=n>IMAGE_SCN_MEM_EXECUTE</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>v_perm</span> <span class=o>=</span> <span class=p>(</span><span class=n>s_perm</span> <span class=o>&amp;</span> <span class=n>IMAGE_SCN_MEM_WRITE</span><span class=p>)</span> <span class=o>?</span> <span class=nl>PAGE_EXECUTE_READWRITE</span> <span class=p>:</span> <span class=n>PAGE_EXECUTE_READ</span><span class=p>;</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
      <span class=n>v_perm</span> <span class=o>=</span> <span class=p>(</span><span class=n>s_perm</span> <span class=o>&amp;</span> <span class=n>IMAGE_SCN_MEM_WRITE</span><span class=p>)</span> <span class=o>?</span> <span class=nl>PAGE_READWRITE</span> <span class=p>:</span> <span class=n>PAGE_READONLY</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=n>VirtualProtect</span><span class=p>(</span><span class=n>dest</span><span class=p>,</span> <span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>Misc</span><span class=p>.</span><span class=n>VirtualSize</span><span class=p>,</span> <span class=n>v_perm</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>oldProtect</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=k>return</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)(</span><span class=n>p_image_base</span> <span class=o>+</span> <span class=n>entry_point_RVA</span><span class=p>);</span>
<span class=p>}</span>

</code></pre></td></tr></table>
</div>
</div><p>åˆ°æ­¤ï¼Œçœ‹èµ·æ¥è¿™ä¸ªåŠ è½½å…¶ä»–ç¨‹åºè¿è¡Œçš„ç¨‹åºå¯ä»¥è¿è¡Œäº†ï¼Œä½†å…¶å®è¿˜ä¸è¡Œã€‚å…¶ä¸»è¦åŸå› ä¹‹ä¸€å°±æ˜¯ç¼ºä¹å¿…è¦çš„å¯¼å…¥ä¿¡æ¯ã€‚ä¸‹æ–‡è¯¦è¿°ã€‚</p>
<h2 id=0x03-å¯¼å…¥è¡¨>0x03 å¯¼å…¥è¡¨</h2>
<h3 id=31-å¯¼å…¥è¡¨ä»‹ç»>3.1 å¯¼å…¥è¡¨ä»‹ç»</h3>
<p>åœ¨Windowsä¸Šï¼Œæ¯ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆ.exeï¼‰éƒ½éœ€è¦ä¸€äº›å¤–éƒ¨å‡½æ•°æ¥æ”¯æŒå…¶æ­£å¸¸è¿ä½œã€‚è¿™äº›å¤–éƒ¨å‡½æ•°é€šå¸¸åœ¨æˆ‘ä»¬ç†Ÿæ‚‰çš„<code>.dll</code>æ–‡ä»¶é‡Œã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œ<code>calc.exe</code>ï¼ˆè®¡ç®—å™¨ç¨‹åºï¼‰éœ€è¦å¤–éƒ¨å‡½æ•°æ¥æ”¯æŒæ‰“å¼€çª—å£ã€æ˜¾ç¤ºæŒ‰é’®ç­‰ã€‚</p>
<p>ä»¥<code>ShellExecuteW</code>ä¸ºä¾‹ï¼ˆåœ¨<code>calc.exe</code>è®¡ç®—å™¨ä¸­è¢«å¯¼å…¥ï¼‰ï¼Œ<code>calc.exe</code>éœ€è¦è¿™ä¸ªå‡½æ•°æ¥æ”¯æŒå®ƒæ­£å¸¸å·¥ä½œï¼ˆå½“ç„¶ï¼Œ<code>calc.exe</code>éœ€è¦ä¸æ­¢è¿™ä¸€ä¸ªå¤–éƒ¨å‡½æ•°ï¼‰ï¼Œæ‰€ä»¥<code>calc.exe</code>éœ€è¦çŸ¥é“<code>ShellExecuteW</code>è¿™ä¸ªå‡½æ•°çš„ä»£ç ï¼ˆæœºå™¨ç ï¼‰åœ¨å“ªå„¿ã€‚</p>
<p>ä½†äº‹å®ä¸Šï¼Œ<code>.dll</code> åªä¼šåœ¨è¿è¡Œæ—¶è¢«åŠ è½½ï¼Œè€Œä¸”åŠ è½½ååœ¨å†…å­˜ä¸­çš„ä½ç½®å¹¶ä¸ç¡®å®šã€‚è¿™æ„å‘³ç€ç¼–è¯‘å™¨ç¼–è¯‘æ—¶æ— ä»å¾—çŸ¥<code>ShellExecuteW</code>çš„åœ°å€ï¼ˆå¼€å¯ASLRçš„è¯å°±æ›´ä¸å¯èƒ½äº†ï¼‰ï¼Œä¹Ÿå°±æ— æ³•ç»™è°ƒç”¨è¯¥å‡½æ•°çš„<code>call</code>æŒ‡ä»¤æä¾›æ­£ç¡®çš„ç«‹å³æ•°åœ°å€ã€‚</p>
<p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆç¼–è¯‘å™¨è¦åˆ›å»ºå¯¼å…¥è¡¨ï¼Œå› ä¸ºå®ƒæœŸæœ›ä¸€æ—¦åŠ¨æ€é“¾æ¥åº“åŠ è½½å®Œæˆï¼Œå®ƒå°±å¯ä»¥æŸ¥æ‰¾åˆ°<code>ShellExecuteW</code>çš„åœ°å€ï¼Œå¹¶åœ¨éœ€è¦çš„æ—¶å€™è°ƒç”¨ã€‚</p>
<p>åœ¨è°ƒè¯•å™¨é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™æ ·çš„æ±‡ç¼–æŒ‡ä»¤ã€‚</p>
<p><img src=/blog/p/learning-packer-01/call_IAT.jpg width=543 height=125 srcset="/blog/p/learning-packer-01/call_IAT_hu889b99c9eb0c20be37b0dc63e7aa4f3e_34329_480x0_resize_q75_box.jpg 480w, /blog/p/learning-packer-01/call_IAT_hu889b99c9eb0c20be37b0dc63e7aa4f3e_34329_1024x0_resize_q75_box.jpg 1024w" loading=lazy alt="import address table" class=gallery-image data-flex-grow=434 data-flex-basis=1042px></p>
<p>ç¬¬ä¸€æ¡<code>call</code>æŒ‡ä»¤æ˜¯å†…éƒ¨è°ƒç”¨ï¼Œè°ƒç”¨å¯¹è±¡æ˜¯åŒä¸€ä¸ªæ¨¡å—å†…çš„å‡½æ•°ã€‚ç¼–è¯‘å™¨çŸ¥é“è¢«è°ƒç”¨å‡½æ•°çš„åœ°å€ï¼Œå¹¶ä½¿ç”¨<code>E8</code> opcode ã€‚è¿™è¡¨ç¤º <em>relative call</em> ã€‚å½“è°ƒç”¨å¤–éƒ¨æ¨¡å—æ—¶ï¼Œå®ƒè°ƒç”¨äº†ä»IATè¯»å–çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯å›¾ä¸­<code>ds:[&lt;&ShellExecuteW>]</code>ã€‚</p>
<p>x86 çš„ call åˆ† 4 ç±»ã€‚</p>
<ul>
<li>Near, relative (opcode E8) (<code>call func</code>)</li>
<li>Far, absolute (opcode 9A) (<code>call 0x12:0x12345678</code>)</li>
<li>Near, absolute, indirect (opcode FF /2) (<code>call [edi]</code>)</li>
<li>Far, absolute, indirect (opcode FF /3) (<code>call far [edi]</code>)</li>
</ul>
<p>å…·ä½“é—®æœç´¢å¼•æ“ã€‚</p>
<p>è¡¥å……ï¼Œå‡½æ•°å¯ä»¥é€šè¿‡åå­—ï¼ˆASCIIç¼–ç çš„Cå­—ç¬¦ä¸²ï¼‰æˆ–DLLå¯¼å‡ºè¡¨ä¸­çš„åºå· <em>ordinal</em> å¯¼å…¥ã€‚</p>
<h3 id=32-data-directory-å’Œ-idt>3.2 Data Directory å’Œ IDT</h3>
<p>è¯´äº†è¿™ä¹ˆå¤šIATï¼Œé‚£ä¹ˆIATåˆ°åº•åœ¨å“ªå„¿ï¼Ÿä»¥ä»€ä¹ˆå½¢å¼ä¿å­˜ï¼Ÿè¿˜æ˜¯ç”¨<code>pefile</code>ï¼Œå…ˆçœ‹çœ‹ PE æ–‡ä»¶å¤´ä¸­çš„ <code>OPTIONAL_HEADER .DATA_DIRECTORY</code>ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>In [10]: pe.OPTIONAL_HEADER.DATA_DIRECTORY
Out[10]:
[&lt;Structure: [IMAGE_DIRECTORY_ENTRY_EXPORT] 0x180 0x0 VirtualAddress: 0x0 0x184 0x4 Size: 0x0&gt;,
 &lt;Structure: [IMAGE_DIRECTORY_ENTRY_IMPORT] 0x188 0x0 VirtualAddress: 0xDAA0 0x18C 0x4 Size: 0xC8&gt;,
 &lt;Structure: [IMAGE_DIRECTORY_ENTRY_RESOURCE] 0x190 0x0 VirtualAddress: 0x16000 0x194 0x4 Size: 0x5D0&gt;,
 &lt;Structure: [IMAGE_DIRECTORY_ENTRY_EXCEPTION] 0x198 0x0 VirtualAddress: 0x0 0x19C 0x4 Size: 0x0&gt;,
 &lt;Structure: [IMAGE_DIRECTORY_ENTRY_SECURITY] 0x1A0 0x0 VirtualAddress: 0x0 0x1A4 0x4 Size: 0x0&gt;,
 &lt;Structure: [IMAGE_DIRECTORY_ENTRY_BASERELOC] 0x1A8 0x0 VirtualAddress: 0x17000 0x1AC 0x4 Size: 0xE0C&gt;,
 &lt;Structure: [IMAGE_DIRECTORY_ENTRY_DEBUG] 0x1B0 0x0 VirtualAddress: 0x98E0 0x1B4 0x4 Size: 0x38&gt;,
 &lt;Structure: [IMAGE_DIRECTORY_ENTRY_COPYRIGHT] 0x1B8 0x0 VirtualAddress: 0x0 0x1BC 0x4 Size: 0x0&gt;,
 &lt;Structure: [IMAGE_DIRECTORY_ENTRY_GLOBALPTR] 0x1C0 0x0 VirtualAddress: 0x0 0x1C4 0x4 Size: 0x0&gt;,
 &lt;Structure: [IMAGE_DIRECTORY_ENTRY_TLS] 0x1C8 0x0 VirtualAddress: 0x0 0x1CC 0x4 Size: 0x0&gt;,
 &lt;Structure: [IMAGE_DIRECTORY_ENTRY_LOAD_CONFIG] 0x1D0 0x0 VirtualAddress: 0x9918 0x1D4 0x4 Size: 0x40&gt;,
 &lt;Structure: [IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT] 0x1D8 0x0 VirtualAddress: 0x0 0x1DC 0x4 Size: 0x0&gt;,
 &lt;Structure: [IMAGE_DIRECTORY_ENTRY_IAT] 0x1E0 0x0 VirtualAddress: 0xD000 0x1E4 0x4 Size: 0xAA0&gt;,
 &lt;Structure: [IMAGE_DIRECTORY_ENTRY_DELAY_IMPORT] 0x1E8 0x0 VirtualAddress: 0x0 0x1EC 0x4 Size: 0x0&gt;,
 &lt;Structure: [IMAGE_DIRECTORY_ENTRY_COM_DESCRIPTOR] 0x1F0 0x0 VirtualAddress: 0x0 0x1F4 0x4 Size: 0x0&gt;,
 &lt;Structure: [IMAGE_DIRECTORY_ENTRY_RESERVED] 0x1F8 0x0 VirtualAddress: 0x0 0x1FC 0x4 Size: 0x0&gt;]
</code></pre></td></tr></table>
</div>
</div><p><code>Data directory</code> å®é™…å°±æ˜¯15ä¸ªç»“æ„ç»„æˆçš„æ•°ç»„ï¼ˆå¿½ç•¥æœ€åä¸€ä¸ªreservedï¼‰ï¼Œæ¯ä¸ªç»“æ„åŒ…å«å¯¹åº”çš„RVAåœ°å€å’Œå¤§å°ï¼ˆRVAå’Œå¤§å°çš„å…·ä½“å«ä¹‰ä¹‹åè®¨è®ºï¼‰ã€‚è¿™ä¸ªç»“æ„é‡Œæˆ‘ä»¬å…³æ³¨çš„æœ‰<code>IMAGE_DIRECTORY_ENTRY_IMPORT</code>å’Œ<code>IMAGE_DIRECTORY_ENTRY_IAT</code>ï¼Œåˆ†åˆ«æŒ‡å‘çš„æ˜¯ <em>Import Directory Table</em> ï¼Œ<em>IDT</em> ï¼Œå’Œ <em>Import Address Table</em> ï¼Œ <em>IAT</em> ã€‚</p>
<p>åŸºæœ¬æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥è¿™ä¹ˆè¯´ï¼Œ <em>IDT</em> æŒ‡ç¤ºéœ€è¦å¯¼å…¥å“ªäº›å‡½æ•°ï¼Œè¿™äº›å‡½æ•°å¯¼å…¥åï¼Œåœ°å€å­˜å…¥ <em>IAT</em> ã€‚ <em>IDT</em> æ˜¯æˆ‘ä»¬è¦å¯¼å…¥ä»€ä¹ˆï¼Œ <em>IAT</em> æ˜¯æˆ‘ä»¬å¯¼å…¥åæŠŠåœ°å€æ”¾åœ¨å“ªå„¿ã€‚</p>
<p><img src=/blog/p/learning-packer-01/IDT-IAT.drawio.png width=650 height=1012 srcset="/blog/p/learning-packer-01/IDT-IAT.drawio_hu519af53fd6ddb5dd0f68ecccb2a04fc7_77938_480x0_resize_box_3.png 480w, /blog/p/learning-packer-01/IDT-IAT.drawio_hu519af53fd6ddb5dd0f68ecccb2a04fc7_77938_1024x0_resize_box_3.png 1024w" loading=lazy alt=IDT-IAT class=gallery-image data-flex-grow=64 data-flex-basis=154px></p>
<p><em>Import Directory</em> æŒ‡å‘çš„æ˜¯ä¸€ä¸ª <code>NULL</code> ç»“å°¾çš„<code>IMAGE_IMPORT_DESCRIPTOR</code>ç»“æ„æ•°ç»„ã€‚ä¹‹ååœ¨ä»£ç é‡Œä¼šç”¨åˆ°ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_IMAGE_IMPORT_DESCRIPTOR</span>
<span class=p>{</span> <span class=n>_ANONYMOUS_UNION</span> <span class=k>union</span>
  <span class=p>{</span> <span class=n>DWORD</span>         <span class=n>Characteristics</span><span class=p>;</span>
    <span class=n>DWORD</span>         <span class=n>OriginalFirstThunk</span><span class=p>;</span> <span class=c1>// pointer to dword[]
</span><span class=c1></span>  <span class=p>}</span>         <span class=n>DUMMYUNIONNAME</span><span class=p>;</span>
  <span class=n>DWORD</span>         <span class=n>TimeDateStamp</span><span class=p>;</span>
  <span class=n>DWORD</span>         <span class=n>ForwarderChain</span><span class=p>;</span>
  <span class=n>DWORD</span>         <span class=n>Name</span><span class=p>;</span> <span class=c1>// pointer to dll name
</span><span class=c1></span>  <span class=n>DWORD</span>         <span class=n>FirstThunk</span><span class=p>;</span> <span class=c1>// pointer to dword[]
</span><span class=c1></span><span class=p>}</span> <span class=n>IMAGE_IMPORT_DESCRIPTOR</span><span class=p>,</span> <span class=o>*</span><span class=n>PIMAGE_IMPORT_DESCRIPTOR</span><span class=p>;</span>
</code></pre></td></tr></table>
</div>
</div><p><code>OriginalFirstThunk</code> å’Œ <code>FirstThunk</code> éƒ½æ˜¯æŒ‡å‘ä¸€ä¸ª NULL ç»“å°¾çš„ DWORD æ•°ç»„ã€‚<code>OriginalFirstThunk</code> æ˜¯æŒ‡å‘ <em>IDT</em> <code>DWORD</code> æ•°ç»„çš„ RVA æŒ‡é’ˆã€‚</p>
<p>å…¶ä¸­æ•°ç»„å…ƒç´ ï¼š</p>
<ul>
<li>å¦‚æœé¦–æ¯”ç‰¹æ˜¯1ï¼Œåˆ™è¿™ä¸ªDWORDæ˜¯ <em>ordinal</em> ï¼Œå‡½æ•°çš„å¯¼å‡ºè¡¨åºå·ã€‚</li>
<li>å¦åˆ™æ˜¯æŒ‡å‘ <code>IMAGE_IMPORT_BY_NAME</code> ç»“æ„çš„ RVA åœ°å€ã€‚</li>
</ul>
<p><code>FirstThunk</code>æŒ‡å‘çš„æ˜¯ <em>IAT</em> ï¼Œå’Œ <em>IDT</em> ç»“æ„ç›¸åŒï¼Œå½“æˆ‘ä»¬å¾—åˆ°å¯¼å…¥å‡½æ•°çš„åœ°å€åï¼Œéœ€è¦æŠŠåœ°å€æ”¾è¿› <em>IDT</em> å¯¹åº”çš„ <em>IAT</em> ä¸­ã€‚</p>
<h3 id=33--å¡«å……å¯¼å…¥è¡¨>3.3 å¡«å……å¯¼å…¥è¡¨</h3>
<p>ä¸‹é¢å®é™…ç¼–å†™ä¸€ä¸‹å¡«å…… <em>IAT</em> çš„ä»£ç ã€‚è¦æ³¨æ„å¡«å…… IAT çš„ä»£ç å¿…é¡»åœ¨åŠ è½½ PE å¤´å’Œ Sections ä¹‹åï¼Œæ—©äºè®¾ç½®å†…å­˜ä¿æŠ¤æ‰§è¡Œã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c>  <span class=n>IMAGE_DATA_DIRECTORY</span> <span class=o>*</span><span class=n>data_directory</span> <span class=o>=</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>OptionalHeader</span><span class=p>.</span><span class=n>DataDirectory</span><span class=p>;</span>

  <span class=c1>// load the address of the import descriptors array
</span><span class=c1></span>  <span class=n>IMAGE_IMPORT_DESCRIPTOR</span> <span class=o>*</span><span class=n>import_descriptors</span> <span class=o>=</span>
      <span class=p>(</span><span class=n>IMAGE_IMPORT_DESCRIPTOR</span> <span class=o>*</span><span class=p>)(</span><span class=n>p_image_base</span> <span class=o>+</span> <span class=n>data_directory</span><span class=p>[</span><span class=n>IMAGE_DIRECTORY_ENTRY_IMPORT</span><span class=p>].</span><span class=n>VirtualAddress</span><span class=p>);</span>
</code></pre></td></tr></table>
</div>
</div><p>ä»æ–‡ä»¶å¤´æå–åˆ° Import Directory çš„åœ°å€ï¼ˆRVAï¼‰åï¼Œå’Œé•œåƒåŸºå€ç›¸åŠ ç®—å‡ºå®é™…ç»“æ„åœ°å€ã€‚æ¥ä¸‹æ¥å¼€å§‹éå†è¿™ä¸ªç»“æ„ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c>  <span class=c1>// this array is null terminated
</span><span class=c1></span>  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>import_descriptors</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>OriginalFirstThunk</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„æ­¤å¤„æ‰€è¯´çš„ <em>null terminated</em> æŒ‡çš„æ˜¯æœ€åä¸€ä¸ªæ•°ç»„å…ƒç´ å¡«å……äº†0ï¼Œæ•…ç”¨ <code>OriginalFirstThunk</code> åˆ¤æ–­ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=c1>// Get the name of the dll, and import it
</span><span class=c1></span><span class=kt>char</span> <span class=o>*</span><span class=n>module_name</span> <span class=o>=</span> <span class=n>p_image_base</span> <span class=o>+</span> <span class=n>import_descriptors</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>Name</span><span class=p>;</span>
<span class=n>HMODULE</span> <span class=n>import_module</span> <span class=o>=</span> <span class=n>LoadLibraryA</span><span class=p>(</span><span class=n>module_name</span><span class=p>);</span>
<span class=k>if</span> <span class=p>(</span><span class=n>import_module</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;import module is null&#34;</span><span class=p>);</span>
    <span class=n>abort</span><span class=p>();</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>import_descriptors[i].Name</code> ä¾ç„¶æ˜¯ä¸€ä¸ª RVAï¼ŒæŒ‡å‘å¸¸é‡å­—ç¬¦ä¸²ã€‚åœ¨è¿™ä¸€æ­¥ä¹‹å‰å¿…é¡»å…ˆå®Œæˆ section åŠ è½½ï¼Œä¸ç„¶å–ä¸åˆ°å­—ç¬¦ä¸²ã€‚è¿™é‡Œç”¨ <code>LoadLibraryA</code> åŠ è½½äº† DLL åˆ°å†…å­˜ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=c1>// the lookup table points to function names or ordinals =&gt; it is the IDT
</span><span class=c1></span><span class=n>IMAGE_THUNK_DATA</span> <span class=o>*</span><span class=n>lookup_table</span> <span class=o>=</span> <span class=p>(</span><span class=n>IMAGE_THUNK_DATA</span> <span class=o>*</span><span class=p>)(</span><span class=n>p_image_base</span> <span class=o>+</span> <span class=n>import_descriptors</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>OriginalFirstThunk</span><span class=p>);</span>
</code></pre></td></tr></table>
</div>
</div><p>æ¥ç€å– <code>OriginalFirstThunk</code> è½¬ä¸º <code>IMAGE_THUNK_DATA</code> æŒ‡é’ˆï¼Œè¿™å°±æ˜¯ <em>IDT</em> äº†ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=c1>// the address table is a copy of the lookup table at first
</span><span class=c1>// but we put the addresses of the loaded function inside =&gt; that&#39;s the IAT
</span><span class=c1></span><span class=n>IMAGE_THUNK_DATA</span> <span class=o>*</span><span class=n>address_table</span> <span class=o>=</span> <span class=p>(</span><span class=n>IMAGE_THUNK_DATA</span> <span class=o>*</span><span class=p>)(</span><span class=n>p_image_base</span> <span class=o>+</span> <span class=n>import_descriptors</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>FirstThunk</span><span class=p>);</span>
</code></pre></td></tr></table>
</div>
</div><p>å†å– <code>FirstThunk</code> è½¬ä¸º <code>IMAGE_THUNK_DATA</code> æŒ‡é’ˆï¼Œè¿™æ˜¯ <em>IAT</em>ï¼Œä¹‹ååŠ è½½çš„å‡½æ•°åœ°å€ä¼šå­˜æ”¾åˆ°è¿™é‡Œã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=c1>// null terminated array, again
</span><span class=c1></span><span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>lookup_table</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>u1</span><span class=p>.</span><span class=n>AddressOfData</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span>
</code></pre></td></tr></table>
</div>
</div><p>ç„¶åéå† <em>IDT</em> ï¼Œå’Œéå† <code>import_descriptors</code> æ—¶ä¸€æ ·ï¼Œæ³¨æ„ <code>null terminated</code> æŒ‡çš„æ˜¯æœ€åä¸€ä¸ªå…ƒç´ ç”¨0å¡«å……ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>void</span> <span class=o>*</span><span class=n>function_handle</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>

<span class=c1>// Check the lookup table for the adresse of the function name to import
</span><span class=c1></span><span class=n>DWORD</span> <span class=n>lookup_addr</span> <span class=o>=</span> <span class=n>lookup_table</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>u1</span><span class=p>.</span><span class=n>AddressOfData</span><span class=p>;</span>

<span class=k>if</span> <span class=p>((</span><span class=n>lookup_addr</span> <span class=o>&amp;</span> <span class=n>IMAGE_ORDINAL_FLAG</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// if first bit is not 1
</span><span class=c1></span>    <span class=c1>// import by name : get the IMAGE_IMPORT_BY_NAME struct
</span><span class=c1></span>    <span class=n>IMAGE_IMPORT_BY_NAME</span> <span class=o>*</span><span class=n>image_import</span> <span class=o>=</span> <span class=p>(</span><span class=n>IMAGE_IMPORT_BY_NAME</span> <span class=o>*</span><span class=p>)(</span><span class=n>p_image_base</span> <span class=o>+</span> <span class=n>lookup_addr</span><span class=p>);</span>
    <span class=c1>// this struct points to the ASCII function name
</span><span class=c1></span>    <span class=kt>char</span> <span class=o>*</span><span class=n>funct_name</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=p>(</span><span class=n>image_import</span><span class=o>-&gt;</span><span class=n>Name</span><span class=p>);</span>
    <span class=c1>// get that function address from it&#39;s module and name
</span><span class=c1></span>    <span class=n>function_handle</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>GetProcAddress</span><span class=p>(</span><span class=n>import_module</span><span class=p>,</span> <span class=n>funct_name</span><span class=p>);</span>
<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=c1>// import by ordinal, directly
</span><span class=c1></span>    <span class=n>function_handle</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>GetProcAddress</span><span class=p>(</span><span class=n>import_module</span><span class=p>,</span> <span class=p>(</span><span class=n>LPSTR</span><span class=p>)</span><span class=n>lookup_addr</span><span class=p>);</span>
<span class=p>}</span>

<span class=k>if</span> <span class=p>(</span><span class=n>function_handle</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;function handle is null&#34;</span><span class=p>);</span>
    <span class=n>abort</span><span class=p>();</span>
<span class=p>}</span>

<span class=c1>// change the IAT, and put the function address inside.
</span><span class=c1></span><span class=n>address_table</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>u1</span><span class=p>.</span><span class=n>Function</span> <span class=o>=</span> <span class=p>(</span><span class=n>DWORD</span><span class=p>)</span><span class=n>function_handle</span><span class=p>;</span>
</code></pre></td></tr></table>
</div>
</div><p>å¯¹æ¯ä¸ª <em>IDT</em> å…ƒç´ ï¼Œæ ¹æ® <em>IDT</em> ä¸­ä¿å­˜çš„å…ƒç´ ç¡®å®šåŠ è½½æ–¹å¼ï¼ˆå­—ç¬¦ä¸²æˆ–è€… <em>ordinal</em>ï¼‰ï¼Œè°ƒç”¨ <code>GetProcAddress</code> åŠ è½½åçš„åœ°å€å­˜å…¥ <em>IAT</em> ã€‚</p>
<p>è‡³æ­¤ï¼Œ<em>IAT</em> å¡«å……å®Œæˆã€‚</p>
<p>å®Œæ•´ä»£ç å¦‚ä¸‹ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>void</span> <span class=nf>fix_iat</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>p_image_base</span><span class=p>,</span> <span class=n>IMAGE_NT_HEADERS</span> <span class=o>*</span><span class=n>p_NT_headers</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>IMAGE_DATA_DIRECTORY</span> <span class=o>*</span><span class=n>data_directory</span> <span class=o>=</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>OptionalHeader</span><span class=p>.</span><span class=n>DataDirectory</span><span class=p>;</span>

  <span class=c1>// load the address of the import descriptors array
</span><span class=c1></span>  <span class=n>IMAGE_IMPORT_DESCRIPTOR</span> <span class=o>*</span><span class=n>import_descriptors</span> <span class=o>=</span>
      <span class=p>(</span><span class=n>IMAGE_IMPORT_DESCRIPTOR</span> <span class=o>*</span><span class=p>)(</span><span class=n>p_image_base</span> <span class=o>+</span> <span class=n>data_directory</span><span class=p>[</span><span class=n>IMAGE_DIRECTORY_ENTRY_IMPORT</span><span class=p>].</span><span class=n>VirtualAddress</span><span class=p>);</span>

  <span class=c1>// this array is null terminated
</span><span class=c1></span>  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>import_descriptors</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>OriginalFirstThunk</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// Get the name of the dll, and import it
</span><span class=c1></span>    <span class=kt>char</span> <span class=o>*</span><span class=n>module_name</span> <span class=o>=</span> <span class=n>p_image_base</span> <span class=o>+</span> <span class=n>import_descriptors</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>Name</span><span class=p>;</span>
    <span class=n>HMODULE</span> <span class=n>import_module</span> <span class=o>=</span> <span class=n>LoadLibraryA</span><span class=p>(</span><span class=n>module_name</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>import_module</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>printf</span><span class=p>(</span><span class=s>&#34;import module is null&#34;</span><span class=p>);</span>
      <span class=n>abort</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=c1>// the lookup table points to function names or ordinals =&gt; it is the IDT
</span><span class=c1></span>    <span class=n>IMAGE_THUNK_DATA</span> <span class=o>*</span><span class=n>lookup_table</span> <span class=o>=</span> <span class=p>(</span><span class=n>IMAGE_THUNK_DATA</span> <span class=o>*</span><span class=p>)(</span><span class=n>p_image_base</span> <span class=o>+</span> <span class=n>import_descriptors</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>OriginalFirstThunk</span><span class=p>);</span>

    <span class=c1>// the address table is a copy of the lookup table at first
</span><span class=c1></span>    <span class=c1>// but we put the addresses of the loaded function inside =&gt; that&#39;s the IAT
</span><span class=c1></span>    <span class=n>IMAGE_THUNK_DATA</span> <span class=o>*</span><span class=n>address_table</span> <span class=o>=</span> <span class=p>(</span><span class=n>IMAGE_THUNK_DATA</span> <span class=o>*</span><span class=p>)(</span><span class=n>p_image_base</span> <span class=o>+</span> <span class=n>import_descriptors</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>FirstThunk</span><span class=p>);</span>

    <span class=c1>// null terminated array, again
</span><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>lookup_table</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>u1</span><span class=p>.</span><span class=n>AddressOfData</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
      <span class=kt>void</span> <span class=o>*</span><span class=n>function_handle</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>

      <span class=c1>// Check the lookup table for the adresse of the function name to import
</span><span class=c1></span>      <span class=n>DWORD</span> <span class=n>lookup_addr</span> <span class=o>=</span> <span class=n>lookup_table</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>u1</span><span class=p>.</span><span class=n>AddressOfData</span><span class=p>;</span>

      <span class=k>if</span> <span class=p>((</span><span class=n>lookup_addr</span> <span class=o>&amp;</span> <span class=n>IMAGE_ORDINAL_FLAG</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// if first bit is not 1
</span><span class=c1></span>        <span class=c1>// import by name : get the IMAGE_IMPORT_BY_NAME struct
</span><span class=c1></span>        <span class=n>IMAGE_IMPORT_BY_NAME</span> <span class=o>*</span><span class=n>image_import</span> <span class=o>=</span> <span class=p>(</span><span class=n>IMAGE_IMPORT_BY_NAME</span> <span class=o>*</span><span class=p>)(</span><span class=n>p_image_base</span> <span class=o>+</span> <span class=n>lookup_addr</span><span class=p>);</span>
        <span class=c1>// this struct points to the ASCII function name
</span><span class=c1></span>        <span class=kt>char</span> <span class=o>*</span><span class=n>funct_name</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=p>(</span><span class=n>image_import</span><span class=o>-&gt;</span><span class=n>Name</span><span class=p>);</span>
        <span class=c1>// get that function address from it&#39;s module and name
</span><span class=c1></span>        <span class=n>function_handle</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>GetProcAddress</span><span class=p>(</span><span class=n>import_module</span><span class=p>,</span> <span class=n>funct_name</span><span class=p>);</span>
      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=c1>// import by ordinal, directly
</span><span class=c1></span>        <span class=n>function_handle</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>GetProcAddress</span><span class=p>(</span><span class=n>import_module</span><span class=p>,</span> <span class=p>(</span><span class=n>LPSTR</span><span class=p>)</span><span class=n>lookup_addr</span><span class=p>);</span>
      <span class=p>}</span>

      <span class=k>if</span> <span class=p>(</span><span class=n>function_handle</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;function handle is null&#34;</span><span class=p>);</span>
        <span class=n>abort</span><span class=p>();</span>
      <span class=p>}</span>

      <span class=c1>// change the IAT, and put the function address inside.
</span><span class=c1></span>      <span class=n>address_table</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>u1</span><span class=p>.</span><span class=n>Function</span> <span class=o>=</span> <span class=p>(</span><span class=n>DWORD</span><span class=p>)</span><span class=n>function_handle</span><span class=p>;</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id=0x04-é‡å®šä½>0x04 é‡å®šä½</h2>
<h3 id=41-é‡å®šä½ä»‹ç»>4.1 é‡å®šä½ä»‹ç»</h3>
<p>å›é¡¾ä¸‹å‰æ–‡æˆ‘ä»¬åšçš„äº‹æƒ…ï¼š</p>
<ol>
<li>æ‰“å¼€ calc.exe ï¼Œè¯»å–å®ƒçš„æ–‡ä»¶å¤´ã€‚</li>
<li>calc.exe æ–‡ä»¶å¤´ä¸­æœ‰ä¸€ä¸ª <code>ImageBase</code> ï¼Œä¿å­˜å®ƒå€¾å‘äºä½¿ç”¨çš„å†…å­˜åŸºå€ã€‚</li>
<li>calc.exe å¯ç”¨äº† ASLR æŠ€æœ¯ï¼Œæ‰€ä»¥ç†è®ºä¸Šæˆ‘ä»¬å¯ä»¥æŠŠå®ƒæ”¾åˆ°å†…å­˜ä¸­ä»»æ„ä½ç½®ã€‚</li>
<li>æˆ‘ä»¬ç”¨ <code>VirtualAlloc</code> åˆ†é…äº†å†…å­˜ï¼Œä»¥<code>NULL</code>ä½œä¸ºé¦–å‚æ•°ï¼Œè®©æ“ä½œç³»ç»Ÿå†³å®šåœ¨å“ªå„¿åˆ†é…ï¼Œç»“æœç”¨ä½œé•œåƒåŸºå€ã€‚</li>
<li>æˆ‘ä»¬å¯¼å…¥äº†å¿…è¦çš„å‡½æ•°å¹¶æŠŠåœ°å€å­˜æ”¾åœ¨ IAT é‡Œã€‚</li>
</ol>
<p>ç„¶åç°åœ¨ï¼ŒæŸæ—¶æŸåˆ»ï¼Œcalc.exe éœ€è¦è°ƒç”¨è¢«å¯¼å…¥çš„å‡½æ•°ï¼Œç”¨æˆ‘ä»¬ä¹‹å‰æè¿‡çš„æ–¹æ³•ã€‚</p>
<p><img src=/blog/p/learning-packer-01/call_IAT.jpg width=543 height=125 srcset="/blog/p/learning-packer-01/call_IAT_hu889b99c9eb0c20be37b0dc63e7aa4f3e_34329_480x0_resize_q75_box.jpg 480w, /blog/p/learning-packer-01/call_IAT_hu889b99c9eb0c20be37b0dc63e7aa4f3e_34329_1024x0_resize_q75_box.jpg 1024w" loading=lazy alt=call_IAT class=gallery-image data-flex-grow=434 data-flex-basis=1042px></p>
<p>ä»”ç»†è§‚å¯Ÿå›¾ä¸­çš„ opcodeï¼š<code>FF15</code>ï¼Œç´§è·Ÿç€çš„æ˜¯å°ç«¯åºçš„<code>0x004b3038</code>ï¼Œä¸€ä¸ªç»å¯¹åœ°å€ï¼ˆå‰æ–‡æ‰€è¿°çš„VAï¼‰ï¼ŒæŒ‡å‘ <em>IAT</em> ä¸­ <code>ShellExecuteW</code> å‡½æ•°çš„åœ°å€ã€‚è¿™å¯¹äºä¸€ä¸ªé¢„æœŸè‡ªå·±ä¼šè¢«æ˜ å°„åˆ°éšæœºåŸºå€ä¸Šçš„PEæ–‡ä»¶æ¥è¯´ï¼Œæ˜¯ä¸€ä¸ªå·¨å¤§çš„é—®é¢˜ã€‚</p>
<p>æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬æŠŠ calc.exe æ”¾ç½®åœ¨ <code>0x00500000</code> è€Œä¸æ˜¯æ–‡ä»¶å¤´ä¸­â€åå¥½â€œçš„é•œåƒåŸºå€ <code>0x00400000</code>ï¼Œè¿™æ¡ <code>call</code> æŒ‡ä»¤è¿˜ä¿æŒä¸å˜çš„è¯ï¼Œå®ƒä¼šå°è¯•å»è®¿é—®åœ°å€ <code>0x004b3038</code> â€”â€”ä½†è¿™ä¸æ˜¯ calc.exe çš„å†…å­˜ç©ºé—´ï¼é‚£å„¿å¯èƒ½æœ‰ä»»ä½•ä¸œè¥¿ï¼Œä¹Ÿå¯èƒ½ä»€ä¹ˆä¹Ÿæ²¡æœ‰ã€‚</p>
<p>æˆ‘ä»¬è¿™é‡Œçœ‹åˆ°çš„æ˜¯ï¼Œå½“æˆ‘ä»¬ç§»åŠ¨äº† PE æ–‡ä»¶åœ¨å†…å­˜ä¸­çš„åŸºå€ï¼Œæ±‡ç¼–ä»£ç ä¹Ÿéœ€è¦åœ¨è¿è¡Œæ—¶ä¿®è¡¥ï¼Œæ¥å“åº”åŸºå€çš„å˜åŒ–ã€‚è¿™å°±æ˜¯é‡å®šä½æ‰€å…³æ³¨çš„äº‹æƒ…ã€‚</p>
<h3 id=42-peé‡å®šä½ç»“æ„>4.2 PEé‡å®šä½ç»“æ„</h3>
<p>é‡å®šä½ç»“æ„æ¯”å¯¼å…¥è¡¨ç®€å•å¾—å¤šã€‚</p>
<p>åŒæ ·çš„ï¼Œåœ¨ Data Directory é‡Œæœ‰ä¸€ä¸ªé‡å®šä½è¡¨ï¼Œç»“æ„å’Œå¯¼å…¥è¡¨ç±»ä¼¼ï¼Œçœ‹å›¾ã€‚</p>
<p><img src=/blog/p/learning-packer-01/basereloc.png width=980 height=793 srcset="/blog/p/learning-packer-01/basereloc_hu4e0f540e5f0dc51830fd117d9f67457f_361570_480x0_resize_box_3.png 480w, /blog/p/learning-packer-01/basereloc_hu4e0f540e5f0dc51830fd117d9f67457f_361570_1024x0_resize_box_3.png 1024w" loading=lazy alt=image-20210927134554770 class=gallery-image data-flex-grow=123 data-flex-basis=296px></p>
<p>å®é™…ä¸Šæ¯ä¸ª<code>IMAGE_BASE_RELOCATION</code>ååº”çš„å°±æ˜¯ä¸€ä¸ª Windows é¡µï¼ˆå› ä¸ºæ¯ä¸ª<code>fixup</code>çš„åç§»æœ€å¤§å–å€¼åªæœ‰ 12bitsï¼Œ0x1000ï¼Œ4KBï¼‰ã€‚</p>
<p>å…¶ä¸­æ¯ä¸ª <code>fixup</code> éƒ½æ˜¯ä¸€ä¸ª <code>WORD</code> ï¼Œå‰ 4bits è¡¨ç¤ºé‡å®šä½ç±»å‹ï¼Œå 12bits è¡¨ç¤ºç›¸å¯¹ <code>IMAGE_BASE_RELOCATION.VirtualAddress</code> çš„åç§»å€¼ï¼Œåç§»å¤„éœ€è¦åº”ç”¨é‡å®šä½ï¼ˆå°±æ˜¯åŠ ä¸ŠçœŸå®åŸºåœ°å€å’ŒPEå¤´ä¸­åŸºåœ°å€çš„å·®ï¼‰ã€‚</p>
<h3 id=43-ä¿®å¤é‡å®šä½>4.3 ä¿®å¤é‡å®šä½</h3>
<p>ä¿®å¤é‡å®šä½å¿…é¡»åœ¨PEå¤´å’ŒSectionsåŠ è½½åˆ°å†…å­˜ä¹‹åï¼Œè®¾ç½®å†…å­˜ä¿æŠ¤ä¹‹å‰è¿›è¡Œã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=n>IMAGE_DATA_DIRECTORY</span> <span class=o>*</span><span class=n>data_directory</span> <span class=o>=</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>OptionalHeader</span><span class=p>.</span><span class=n>DataDirectory</span><span class=p>;</span>

<span class=c1>// this is how much we shifted the ImageBase
</span><span class=c1></span><span class=n>DWORD</span> <span class=n>delta_VA_reloc</span> <span class=o>=</span> <span class=p>((</span><span class=n>DWORD</span><span class=p>)</span><span class=n>p_image_base</span><span class=p>)</span> <span class=o>-</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>OptionalHeader</span><span class=p>.</span><span class=n>ImageBase</span><span class=p>;</span>

<span class=c1>// if there is a relocation table, and we actually shitfted the ImageBase
</span><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=n>data_directory</span><span class=p>[</span><span class=n>IMAGE_DIRECTORY_ENTRY_BASERELOC</span><span class=p>].</span><span class=n>VirtualAddress</span> <span class=o>!=</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>delta_VA_reloc</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</code></pre></td></tr></table>
</div>
</div><p>åœ¨ä»£ç çš„å¼€å§‹ï¼Œéœ€è¦ç¡®è®¤æ˜¯ä¸æ˜¯æœ‰å¿…è¦åšé‡å®šä½ã€‚å¦‚æœåŸºåœ°å€å’ŒPEæ–‡ä»¶å¤´ä¸­ç»™å‡ºçš„åŸºåœ°å€ç›¸åŒï¼Œé‚£å°±ä¸ç”¨è€ƒè™‘é‡å®šä½äº†ã€‚åˆ¤æ–­æ–¹å¼æ˜¯æ‹¿çœŸå®åŸºåœ°å€å‡å»æ–‡ä»¶å¤´é‡Œç»™å‡ºçš„åŸºåœ°å€ï¼Œé0åˆ™è¯´æ˜åŸºåœ°å€éœ€è¦é‡å®šä½ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=c1>// calculate the relocation table address
</span><span class=c1></span><span class=n>IMAGE_BASE_RELOCATION</span> <span class=o>*</span><span class=n>p_reloc</span> <span class=o>=</span>
    <span class=p>(</span><span class=n>IMAGE_BASE_RELOCATION</span> <span class=o>*</span><span class=p>)(</span><span class=n>p_image_base</span> <span class=o>+</span> <span class=n>data_directory</span><span class=p>[</span><span class=n>IMAGE_DIRECTORY_ENTRY_BASERELOC</span><span class=p>].</span><span class=n>VirtualAddress</span><span class=p>);</span>
</code></pre></td></tr></table>
</div>
</div><p>ä»RVAå¾—åˆ°é‡å®šä½è¡¨æŒ‡é’ˆï¼Œç„¶åå°±æ˜¯éå†ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=c1>// once again, a null terminated array
</span><span class=c1></span><span class=k>while</span> <span class=p>(</span><span class=n>p_reloc</span><span class=o>-&gt;</span><span class=n>VirtualAddress</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// ...
</span><span class=c1></span>
    <span class=c1>// switch to the next relocation block, based on the size
</span><span class=c1></span>    <span class=n>p_reloc</span> <span class=o>=</span> <span class=p>(</span><span class=n>IMAGE_BASE_RELOCATION</span> <span class=o>*</span><span class=p>)(((</span><span class=n>DWORD</span><span class=p>)</span><span class=n>p_reloc</span><span class=p>)</span> <span class=o>+</span> <span class=n>p_reloc</span><span class=o>-&gt;</span><span class=n>SizeOfBlock</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>SizeOfBlock</code>å…¶å®æ˜¯åŒ…æ‹¬<code>IMAGE_BASE_RELOCATION</code>ï¼ˆHeaderï¼‰å’Œå±äºè¿™ä¸ªå—çš„æ‰€æœ‰ <em>fixup</em> ç»„æˆçš„æ€»å¤§å°ï¼Œè¿™é‡Œå¼ºåˆ¶è½¬æ¢æˆ DWORD åç›¸åŠ å°±å¾—åˆ°äº†ä¸‹ä¸€ä¸ª <code>IMAGE_BASE_RELOCATION</code> ç»“æ„çš„åœ°å€ã€‚</p>
<p>åŒæ ·çš„ï¼Œè¿™ä¹Ÿæ˜¯å‰æ–‡æ‰€è¿°çš„ <code>null terminated array</code> ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=c1>// how any relocation in this block
</span><span class=c1>// ie the total size, minus the size of the &#34;header&#34;, divided by 2 (those are words, so 2 bytes for each)
</span><span class=c1></span><span class=n>DWORD</span> <span class=n>size</span> <span class=o>=</span> <span class=p>(</span><span class=n>p_reloc</span><span class=o>-&gt;</span><span class=n>SizeOfBlock</span> <span class=o>-</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>IMAGE_BASE_RELOCATION</span><span class=p>))</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
<span class=c1>// the first relocation element in the block, right after the header (using pointer arithmetic again)
</span><span class=c1></span><span class=n>WORD</span> <span class=o>*</span><span class=n>fixups</span> <span class=o>=</span> <span class=p>(</span><span class=n>WORD</span> <span class=o>*</span><span class=p>)(</span><span class=n>p_reloc</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</code></pre></td></tr></table>
</div>
</div><p>åœ¨å¾ªç¯ä½“å†…ï¼Œå…ˆè®¡ç®—å‡ºäº†å…ƒç´ æ€»æ•°ï¼ˆ(æ€»å¤§å°(å­—èŠ‚) - <code>IMAGE_BASE_RELOCATION</code> ç»“æ„å¤§å°(å­—èŠ‚)) / 2 ï¼‰ï¼Œç„¶åç”¨æŒ‡é’ˆç®—æœ¯å–å¾—ç¬¬ä¸€ä¸ªå…ƒç´ çš„åœ°å€ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// type is the first 4 bits of the relocation word
</span><span class=c1></span>    <span class=kt>int</span> <span class=n>type</span> <span class=o>=</span> <span class=n>fixups</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;&gt;</span> <span class=mi>12</span><span class=p>;</span>
    <span class=c1>// offset is the last 12 bits
</span><span class=c1></span>    <span class=kt>int</span> <span class=n>offset</span> <span class=o>=</span> <span class=n>fixups</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&amp;</span> <span class=mh>0x0fff</span><span class=p>;</span>
    <span class=c1>// this is the address we are going to change
</span><span class=c1></span>    <span class=n>DWORD</span> <span class=o>*</span><span class=n>change_addr</span> <span class=o>=</span> <span class=p>(</span><span class=n>DWORD</span> <span class=o>*</span><span class=p>)(</span><span class=n>p_image_base</span> <span class=o>+</span> <span class=n>p_reloc</span><span class=o>-&gt;</span><span class=n>VirtualAddress</span> <span class=o>+</span> <span class=n>offset</span><span class=p>);</span>

    <span class=c1>// there is only one type used that needs to make a change
</span><span class=c1></span>    <span class=k>switch</span> <span class=p>(</span><span class=n>type</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>case</span> <span class=nl>IMAGE_REL_BASED_HIGHLOW</span><span class=p>:</span>
            <span class=o>*</span><span class=n>change_addr</span> <span class=o>+=</span> <span class=n>delta_VA_reloc</span><span class=p>;</span>
            <span class=k>break</span><span class=p>;</span>
        <span class=k>default</span><span class=o>:</span>
            <span class=k>break</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>éå†æ‰€æœ‰å…ƒç´ ã€‚å¦‚ä¸Šæ–‡æ‰€è¿°çš„ï¼ŒæŠŠæ¯ä¸ª <code>fixup</code> å–é«˜ä½4æ¯”ç‰¹å’Œä½ä½12æ¯”ç‰¹ï¼Œè®¡ç®—å‡ºè¦ä¿®è¡¥çš„åœ°å€ã€‚å†æ ¹æ®ä¿®è¡¥çš„ç±»å‹æ¥åº”ç”¨ã€‚</p>
<p>å‚è€ƒ<a class=link href=https://docs.microsoft.com/en-us/windows/win32/debug/pe-format#base-relocation-types target=_blank rel=noopener>å¾®è½¯æ–‡æ¡£çš„Base Relocation Types</a>ã€‚å€¼å¾—æ³¨æ„ type å°±ä¸¤ä¸ªï¼š<code>IMAGE_REL_BASED_HIGHLOW</code> å’Œ <code>IMAGE_REL_BASED_DIR64</code> ï¼Œåˆ†åˆ«æ˜¯ 32ä½å’Œ64ä½çš„é‡å®šå‘ã€‚å…¶ä»–16ä½é‡å®šå‘ä¸å¤šè¯´äº†ã€‚</p>
<p>å®Œæ•´ä»£ç å¦‚ä¸‹ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>void</span> <span class=nf>fix_base_reloc</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>p_image_base</span><span class=p>,</span> <span class=n>IMAGE_NT_HEADERS</span> <span class=o>*</span><span class=n>p_NT_headers</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>IMAGE_DATA_DIRECTORY</span> <span class=o>*</span><span class=n>data_directory</span> <span class=o>=</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>OptionalHeader</span><span class=p>.</span><span class=n>DataDirectory</span><span class=p>;</span>

  <span class=c1>// this is how much we shifted the ImageBase
</span><span class=c1></span>  <span class=n>DWORD</span> <span class=n>delta_VA_reloc</span> <span class=o>=</span> <span class=p>((</span><span class=n>DWORD</span><span class=p>)</span><span class=n>p_image_base</span><span class=p>)</span> <span class=o>-</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>OptionalHeader</span><span class=p>.</span><span class=n>ImageBase</span><span class=p>;</span>

  <span class=c1>// if there is a relocation table, and we actually shitfted the ImageBase
</span><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>data_directory</span><span class=p>[</span><span class=n>IMAGE_DIRECTORY_ENTRY_BASERELOC</span><span class=p>].</span><span class=n>VirtualAddress</span> <span class=o>!=</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>delta_VA_reloc</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>

    <span class=c1>// calculate the relocation table address
</span><span class=c1></span>    <span class=n>IMAGE_BASE_RELOCATION</span> <span class=o>*</span><span class=n>p_reloc</span> <span class=o>=</span>
        <span class=p>(</span><span class=n>IMAGE_BASE_RELOCATION</span> <span class=o>*</span><span class=p>)(</span><span class=n>p_image_base</span> <span class=o>+</span> <span class=n>data_directory</span><span class=p>[</span><span class=n>IMAGE_DIRECTORY_ENTRY_BASERELOC</span><span class=p>].</span><span class=n>VirtualAddress</span><span class=p>);</span>

    <span class=c1>// once again, a null terminated array
</span><span class=c1></span>    <span class=k>while</span> <span class=p>(</span><span class=n>p_reloc</span><span class=o>-&gt;</span><span class=n>VirtualAddress</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>

      <span class=c1>// how any relocation in this block
</span><span class=c1></span>      <span class=c1>// ie the total size, minus the size of the &#34;header&#34;, divided by 2 (those are words, so 2 bytes for each)
</span><span class=c1></span>      <span class=n>DWORD</span> <span class=n>size</span> <span class=o>=</span> <span class=p>(</span><span class=n>p_reloc</span><span class=o>-&gt;</span><span class=n>SizeOfBlock</span> <span class=o>-</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>IMAGE_BASE_RELOCATION</span><span class=p>))</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
      <span class=c1>// the first relocation element in the block, right after the header (using pointer arithmetic again)
</span><span class=c1></span>      <span class=n>WORD</span> <span class=o>*</span><span class=n>fixups</span> <span class=o>=</span> <span class=p>(</span><span class=n>WORD</span> <span class=o>*</span><span class=p>)(</span><span class=n>p_reloc</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
      <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// type is the first 4 bits of the relocation word
</span><span class=c1></span>        <span class=kt>int</span> <span class=n>type</span> <span class=o>=</span> <span class=n>fixups</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;&gt;</span> <span class=mi>12</span><span class=p>;</span>
        <span class=c1>// offset is the last 12 bits
</span><span class=c1></span>        <span class=kt>int</span> <span class=n>offset</span> <span class=o>=</span> <span class=n>fixups</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&amp;</span> <span class=mh>0x0fff</span><span class=p>;</span>
        <span class=c1>// this is the address we are going to change
</span><span class=c1></span>        <span class=n>DWORD</span> <span class=o>*</span><span class=n>change_addr</span> <span class=o>=</span> <span class=p>(</span><span class=n>DWORD</span> <span class=o>*</span><span class=p>)(</span><span class=n>p_image_base</span> <span class=o>+</span> <span class=n>p_reloc</span><span class=o>-&gt;</span><span class=n>VirtualAddress</span> <span class=o>+</span> <span class=n>offset</span><span class=p>);</span>

        <span class=c1>// there is only one type used that needs to make a change
</span><span class=c1></span>        <span class=k>switch</span> <span class=p>(</span><span class=n>type</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>case</span> <span class=nl>IMAGE_REL_BASED_HIGHLOW</span><span class=p>:</span>
          <span class=o>*</span><span class=n>change_addr</span> <span class=o>+=</span> <span class=n>delta_VA_reloc</span><span class=p>;</span>
          <span class=k>break</span><span class=p>;</span>
        <span class=k>default</span><span class=o>:</span>
          <span class=k>break</span><span class=p>;</span>
        <span class=p>}</span>
      <span class=p>}</span>

      <span class=c1>// switch to the next relocation block, based on the size
</span><span class=c1></span>      <span class=n>p_reloc</span> <span class=o>=</span> <span class=p>(</span><span class=n>IMAGE_BASE_RELOCATION</span> <span class=o>*</span><span class=p>)(((</span><span class=n>DWORD</span><span class=p>)</span><span class=n>p_reloc</span><span class=p>)</span> <span class=o>+</span> <span class=n>p_reloc</span><span class=o>-&gt;</span><span class=n>SizeOfBlock</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id=0x05-å®Œæ•´-loader-ç¨‹åº>0x05 å®Œæ•´ Loader ç¨‹åº</h2>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=cp>#include</span> <span class=cpf>&lt;Windows.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;winnt.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=kt>void</span> <span class=o>*</span><span class=nf>load_PE</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>PE_data</span><span class=p>);</span>
<span class=kt>void</span> <span class=nf>fix_iat</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>,</span> <span class=n>IMAGE_NT_HEADERS</span> <span class=o>*</span><span class=p>);</span>
<span class=kt>void</span> <span class=nf>fix_base_reloc</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>p_image_base</span><span class=p>,</span> <span class=n>IMAGE_NT_HEADERS</span> <span class=o>*</span><span class=n>p_NT_headers</span><span class=p>);</span>

<span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=k>const</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;missing path argument</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
    <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=n>FILE</span> <span class=o>*</span><span class=n>exe_file</span> <span class=o>=</span> <span class=n>fopen</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=s>&#34;rb&#34;</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>exe_file</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;error opening file</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
    <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=c1>// Get file size : put pointer at the end
</span><span class=c1></span>  <span class=n>fseek</span><span class=p>(</span><span class=n>exe_file</span><span class=p>,</span> <span class=mi>0L</span><span class=p>,</span> <span class=n>SEEK_END</span><span class=p>);</span>
  <span class=c1>// and read its position
</span><span class=c1></span>  <span class=kt>long</span> <span class=kt>int</span> <span class=n>file_size</span> <span class=o>=</span> <span class=n>ftell</span><span class=p>(</span><span class=n>exe_file</span><span class=p>);</span>
  <span class=c1>// put the pointer back at the beginning
</span><span class=c1></span>  <span class=n>fseek</span><span class=p>(</span><span class=n>exe_file</span><span class=p>,</span> <span class=mi>0L</span><span class=p>,</span> <span class=n>SEEK_SET</span><span class=p>);</span>

  <span class=c1>// allocate memory and read the whole file
</span><span class=c1></span>  <span class=kt>char</span> <span class=o>*</span><span class=n>exe_file_data</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=n>file_size</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>

  <span class=c1>// read whole file
</span><span class=c1></span>  <span class=n>size_t</span> <span class=n>n_read</span> <span class=o>=</span> <span class=n>fread</span><span class=p>(</span><span class=n>exe_file_data</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>file_size</span><span class=p>,</span> <span class=n>exe_file</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>n_read</span> <span class=o>!=</span> <span class=n>file_size</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;reading error (%d)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>n_read</span><span class=p>);</span>
    <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=c1>// load the PE in memory
</span><span class=c1></span>  <span class=n>printf</span><span class=p>(</span><span class=s>&#34;[+] Loading PE file</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
  <span class=kt>void</span> <span class=o>*</span><span class=n>entry</span> <span class=o>=</span> <span class=n>load_PE</span><span class=p>(</span><span class=n>exe_file_data</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>entry</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// call its entrypoint
</span><span class=c1></span>    <span class=p>((</span><span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=p>)(</span><span class=kt>void</span><span class=p>))</span><span class=n>entry</span><span class=p>)();</span>
  <span class=p>}</span>

  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=o>*</span><span class=nf>load_PE</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>PE_data</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>IMAGE_DOS_HEADER</span> <span class=o>*</span><span class=n>p_DOS_header</span> <span class=o>=</span> <span class=p>(</span><span class=n>IMAGE_DOS_HEADER</span> <span class=o>*</span><span class=p>)</span><span class=n>PE_data</span><span class=p>;</span>
  <span class=n>IMAGE_NT_HEADERS</span> <span class=o>*</span><span class=n>p_NT_headers</span> <span class=o>=</span> <span class=p>(</span><span class=n>IMAGE_NT_HEADERS</span> <span class=o>*</span><span class=p>)(</span><span class=n>PE_data</span> <span class=o>+</span> <span class=n>p_DOS_header</span><span class=o>-&gt;</span><span class=n>e_lfanew</span><span class=p>);</span>

  <span class=c1>// extract information from PE header
</span><span class=c1></span>  <span class=n>DWORD</span> <span class=n>size_of_image</span> <span class=o>=</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>OptionalHeader</span><span class=p>.</span><span class=n>SizeOfImage</span><span class=p>;</span>
  <span class=n>DWORD</span> <span class=n>entry_point_RVA</span> <span class=o>=</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>OptionalHeader</span><span class=p>.</span><span class=n>AddressOfEntryPoint</span><span class=p>;</span>
  <span class=n>DWORD</span> <span class=n>size_of_headers</span> <span class=o>=</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>OptionalHeader</span><span class=p>.</span><span class=n>SizeOfHeaders</span><span class=p>;</span>

  <span class=c1>// allocate memory
</span><span class=c1></span>  <span class=c1>// https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc
</span><span class=c1></span>  <span class=kt>char</span> <span class=o>*</span><span class=n>p_image_base</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>VirtualAlloc</span><span class=p>(</span><span class=nb>NULL</span><span class=p>,</span> <span class=n>size_of_image</span><span class=p>,</span> <span class=n>MEM_RESERVE</span> <span class=o>|</span> <span class=n>MEM_COMMIT</span><span class=p>,</span> <span class=n>PAGE_READWRITE</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>p_image_base</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=c1>// copy PE headers in memory
</span><span class=c1></span>  <span class=n>memcpy</span><span class=p>(</span><span class=n>p_image_base</span><span class=p>,</span> <span class=n>PE_data</span><span class=p>,</span> <span class=n>size_of_headers</span><span class=p>);</span>

  <span class=c1>// Section headers starts right after the IMAGE_NT_HEADERS struct, so we do some pointer arithmetic-fu here.
</span><span class=c1></span>  <span class=n>IMAGE_SECTION_HEADER</span> <span class=o>*</span><span class=n>sections</span> <span class=o>=</span> <span class=p>(</span><span class=n>IMAGE_SECTION_HEADER</span> <span class=o>*</span><span class=p>)(</span><span class=n>p_NT_headers</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>

  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>FileHeader</span><span class=p>.</span><span class=n>NumberOfSections</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// calculate the VA we need to copy the content, from the RVA
</span><span class=c1></span>    <span class=c1>// section[i].VirtualAddress is a RVA, mind it
</span><span class=c1></span>    <span class=kt>char</span> <span class=o>*</span><span class=n>dest</span> <span class=o>=</span> <span class=n>p_image_base</span> <span class=o>+</span> <span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>VirtualAddress</span><span class=p>;</span>

    <span class=c1>// check if there is Raw data to copy
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>SizeOfRawData</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
      <span class=c1>// We copy SizeOfRaw data bytes, from the offset PointerToRawData in the file
</span><span class=c1></span>      <span class=n>memcpy</span><span class=p>(</span><span class=n>dest</span><span class=p>,</span> <span class=n>PE_data</span> <span class=o>+</span> <span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>PointerToRawData</span><span class=p>,</span> <span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>SizeOfRawData</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
      <span class=n>memset</span><span class=p>(</span><span class=n>dest</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>Misc</span><span class=p>.</span><span class=n>VirtualSize</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=n>fix_iat</span><span class=p>(</span><span class=n>p_image_base</span><span class=p>,</span> <span class=n>p_NT_headers</span><span class=p>);</span>
  <span class=n>fix_base_reloc</span><span class=p>(</span><span class=n>p_image_base</span><span class=p>,</span> <span class=n>p_NT_headers</span><span class=p>);</span>

  <span class=c1>// Set permission for the PE header to read only
</span><span class=c1></span>  <span class=n>DWORD</span> <span class=n>oldProtect</span><span class=p>;</span>
  <span class=n>VirtualProtect</span><span class=p>(</span><span class=n>p_image_base</span><span class=p>,</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>OptionalHeader</span><span class=p>.</span><span class=n>SizeOfHeaders</span><span class=p>,</span> <span class=n>PAGE_READONLY</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>oldProtect</span><span class=p>);</span>

  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>FileHeader</span><span class=p>.</span><span class=n>NumberOfSections</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
    <span class=kt>char</span> <span class=o>*</span><span class=n>dest</span> <span class=o>=</span> <span class=n>p_image_base</span> <span class=o>+</span> <span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>VirtualAddress</span><span class=p>;</span>
    <span class=n>DWORD</span> <span class=n>s_perm</span> <span class=o>=</span> <span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>Characteristics</span><span class=p>;</span>
    <span class=n>DWORD</span> <span class=n>v_perm</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=c1>// flags are not the same between virtal protect and the section header
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>s_perm</span> <span class=o>&amp;</span> <span class=n>IMAGE_SCN_MEM_EXECUTE</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>v_perm</span> <span class=o>=</span> <span class=p>(</span><span class=n>s_perm</span> <span class=o>&amp;</span> <span class=n>IMAGE_SCN_MEM_WRITE</span><span class=p>)</span> <span class=o>?</span> <span class=nl>PAGE_EXECUTE_READWRITE</span> <span class=p>:</span> <span class=n>PAGE_EXECUTE_READ</span><span class=p>;</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
      <span class=n>v_perm</span> <span class=o>=</span> <span class=p>(</span><span class=n>s_perm</span> <span class=o>&amp;</span> <span class=n>IMAGE_SCN_MEM_WRITE</span><span class=p>)</span> <span class=o>?</span> <span class=nl>PAGE_READWRITE</span> <span class=p>:</span> <span class=n>PAGE_READONLY</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=n>VirtualProtect</span><span class=p>(</span><span class=n>dest</span><span class=p>,</span> <span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>Misc</span><span class=p>.</span><span class=n>VirtualSize</span><span class=p>,</span> <span class=n>v_perm</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>oldProtect</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=k>return</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)(</span><span class=n>p_image_base</span> <span class=o>+</span> <span class=n>entry_point_RVA</span><span class=p>);</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=nf>fix_iat</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>p_image_base</span><span class=p>,</span> <span class=n>IMAGE_NT_HEADERS</span> <span class=o>*</span><span class=n>p_NT_headers</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>IMAGE_DATA_DIRECTORY</span> <span class=o>*</span><span class=n>data_directory</span> <span class=o>=</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>OptionalHeader</span><span class=p>.</span><span class=n>DataDirectory</span><span class=p>;</span>

  <span class=c1>// load the address of the import descriptors array
</span><span class=c1></span>  <span class=n>IMAGE_IMPORT_DESCRIPTOR</span> <span class=o>*</span><span class=n>import_descriptors</span> <span class=o>=</span>
      <span class=p>(</span><span class=n>IMAGE_IMPORT_DESCRIPTOR</span> <span class=o>*</span><span class=p>)(</span><span class=n>p_image_base</span> <span class=o>+</span> <span class=n>data_directory</span><span class=p>[</span><span class=n>IMAGE_DIRECTORY_ENTRY_IMPORT</span><span class=p>].</span><span class=n>VirtualAddress</span><span class=p>);</span>

  <span class=c1>// this array is null terminated
</span><span class=c1></span>  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>import_descriptors</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>OriginalFirstThunk</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// Get the name of the dll, and import it
</span><span class=c1></span>    <span class=kt>char</span> <span class=o>*</span><span class=n>module_name</span> <span class=o>=</span> <span class=n>p_image_base</span> <span class=o>+</span> <span class=n>import_descriptors</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>Name</span><span class=p>;</span>
    <span class=n>HMODULE</span> <span class=n>import_module</span> <span class=o>=</span> <span class=n>LoadLibraryA</span><span class=p>(</span><span class=n>module_name</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>import_module</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>printf</span><span class=p>(</span><span class=s>&#34;import module is null&#34;</span><span class=p>);</span>
      <span class=n>abort</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=c1>// the lookup table points to function names or ordinals =&gt; it is the IDT
</span><span class=c1></span>    <span class=n>IMAGE_THUNK_DATA</span> <span class=o>*</span><span class=n>lookup_table</span> <span class=o>=</span> <span class=p>(</span><span class=n>IMAGE_THUNK_DATA</span> <span class=o>*</span><span class=p>)(</span><span class=n>p_image_base</span> <span class=o>+</span> <span class=n>import_descriptors</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>OriginalFirstThunk</span><span class=p>);</span>

    <span class=c1>// the address table is a copy of the lookup table at first
</span><span class=c1></span>    <span class=c1>// but we put the addresses of the loaded function inside =&gt; that&#39;s the IAT
</span><span class=c1></span>    <span class=n>IMAGE_THUNK_DATA</span> <span class=o>*</span><span class=n>address_table</span> <span class=o>=</span> <span class=p>(</span><span class=n>IMAGE_THUNK_DATA</span> <span class=o>*</span><span class=p>)(</span><span class=n>p_image_base</span> <span class=o>+</span> <span class=n>import_descriptors</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>FirstThunk</span><span class=p>);</span>

    <span class=c1>// null terminated array, again
</span><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>lookup_table</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>u1</span><span class=p>.</span><span class=n>AddressOfData</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
      <span class=kt>void</span> <span class=o>*</span><span class=n>function_handle</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>

      <span class=c1>// Check the lookup table for the adresse of the function name to import
</span><span class=c1></span>      <span class=n>DWORD</span> <span class=n>lookup_addr</span> <span class=o>=</span> <span class=n>lookup_table</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>u1</span><span class=p>.</span><span class=n>AddressOfData</span><span class=p>;</span>

      <span class=k>if</span> <span class=p>((</span><span class=n>lookup_addr</span> <span class=o>&amp;</span> <span class=n>IMAGE_ORDINAL_FLAG</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// if first bit is not 1
</span><span class=c1></span>        <span class=c1>// import by name : get the IMAGE_IMPORT_BY_NAME struct
</span><span class=c1></span>        <span class=n>IMAGE_IMPORT_BY_NAME</span> <span class=o>*</span><span class=n>image_import</span> <span class=o>=</span> <span class=p>(</span><span class=n>IMAGE_IMPORT_BY_NAME</span> <span class=o>*</span><span class=p>)(</span><span class=n>p_image_base</span> <span class=o>+</span> <span class=n>lookup_addr</span><span class=p>);</span>
        <span class=c1>// this struct points to the ASCII function name
</span><span class=c1></span>        <span class=kt>char</span> <span class=o>*</span><span class=n>funct_name</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=p>(</span><span class=n>image_import</span><span class=o>-&gt;</span><span class=n>Name</span><span class=p>);</span>
        <span class=c1>// get that function address from it&#39;s module and name
</span><span class=c1></span>        <span class=n>function_handle</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>GetProcAddress</span><span class=p>(</span><span class=n>import_module</span><span class=p>,</span> <span class=n>funct_name</span><span class=p>);</span>
      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=c1>// import by ordinal, directly
</span><span class=c1></span>        <span class=n>function_handle</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>GetProcAddress</span><span class=p>(</span><span class=n>import_module</span><span class=p>,</span> <span class=p>(</span><span class=n>LPSTR</span><span class=p>)</span><span class=n>lookup_addr</span><span class=p>);</span>
      <span class=p>}</span>

      <span class=k>if</span> <span class=p>(</span><span class=n>function_handle</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;function handle is null&#34;</span><span class=p>);</span>
        <span class=n>abort</span><span class=p>();</span>
      <span class=p>}</span>

      <span class=c1>// change the IAT, and put the function address inside.
</span><span class=c1></span>      <span class=n>address_table</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>u1</span><span class=p>.</span><span class=n>Function</span> <span class=o>=</span> <span class=p>(</span><span class=n>DWORD</span><span class=p>)</span><span class=n>function_handle</span><span class=p>;</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=nf>fix_base_reloc</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>p_image_base</span><span class=p>,</span> <span class=n>IMAGE_NT_HEADERS</span> <span class=o>*</span><span class=n>p_NT_headers</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>IMAGE_DATA_DIRECTORY</span> <span class=o>*</span><span class=n>data_directory</span> <span class=o>=</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>OptionalHeader</span><span class=p>.</span><span class=n>DataDirectory</span><span class=p>;</span>

  <span class=c1>// this is how much we shifted the ImageBase
</span><span class=c1></span>  <span class=n>DWORD</span> <span class=n>delta_VA_reloc</span> <span class=o>=</span> <span class=p>((</span><span class=n>DWORD</span><span class=p>)</span><span class=n>p_image_base</span><span class=p>)</span> <span class=o>-</span> <span class=n>p_NT_headers</span><span class=o>-&gt;</span><span class=n>OptionalHeader</span><span class=p>.</span><span class=n>ImageBase</span><span class=p>;</span>

  <span class=c1>// if there is a relocation table, and we actually shitfted the ImageBase
</span><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>data_directory</span><span class=p>[</span><span class=n>IMAGE_DIRECTORY_ENTRY_BASERELOC</span><span class=p>].</span><span class=n>VirtualAddress</span> <span class=o>!=</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>delta_VA_reloc</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>

    <span class=c1>// calculate the relocation table address
</span><span class=c1></span>    <span class=n>IMAGE_BASE_RELOCATION</span> <span class=o>*</span><span class=n>p_reloc</span> <span class=o>=</span>
        <span class=p>(</span><span class=n>IMAGE_BASE_RELOCATION</span> <span class=o>*</span><span class=p>)(</span><span class=n>p_image_base</span> <span class=o>+</span> <span class=n>data_directory</span><span class=p>[</span><span class=n>IMAGE_DIRECTORY_ENTRY_BASERELOC</span><span class=p>].</span><span class=n>VirtualAddress</span><span class=p>);</span>

    <span class=c1>// once again, a null terminated array
</span><span class=c1></span>    <span class=k>while</span> <span class=p>(</span><span class=n>p_reloc</span><span class=o>-&gt;</span><span class=n>VirtualAddress</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>

      <span class=c1>// how any relocation in this block
</span><span class=c1></span>      <span class=c1>// ie the total size, minus the size of the &#34;header&#34;, divided by 2 (those are words, so 2 bytes for each)
</span><span class=c1></span>      <span class=n>DWORD</span> <span class=n>size</span> <span class=o>=</span> <span class=p>(</span><span class=n>p_reloc</span><span class=o>-&gt;</span><span class=n>SizeOfBlock</span> <span class=o>-</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>IMAGE_BASE_RELOCATION</span><span class=p>))</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
      <span class=c1>// the first relocation element in the block, right after the header (using pointer arithmetic again)
</span><span class=c1></span>      <span class=n>WORD</span> <span class=o>*</span><span class=n>fixups</span> <span class=o>=</span> <span class=p>(</span><span class=n>WORD</span> <span class=o>*</span><span class=p>)(</span><span class=n>p_reloc</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
      <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// type is the first 4 bits of the relocation word
</span><span class=c1></span>        <span class=kt>int</span> <span class=n>type</span> <span class=o>=</span> <span class=n>fixups</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;&gt;</span> <span class=mi>12</span><span class=p>;</span>
        <span class=c1>// offset is the last 12 bits
</span><span class=c1></span>        <span class=kt>int</span> <span class=n>offset</span> <span class=o>=</span> <span class=n>fixups</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&amp;</span> <span class=mh>0x0fff</span><span class=p>;</span>
        <span class=c1>// this is the address we are going to change
</span><span class=c1></span>        <span class=n>DWORD</span> <span class=o>*</span><span class=n>change_addr</span> <span class=o>=</span> <span class=p>(</span><span class=n>DWORD</span> <span class=o>*</span><span class=p>)(</span><span class=n>p_image_base</span> <span class=o>+</span> <span class=n>p_reloc</span><span class=o>-&gt;</span><span class=n>VirtualAddress</span> <span class=o>+</span> <span class=n>offset</span><span class=p>);</span>

        <span class=c1>// there is only one type used that needs to make a change
</span><span class=c1></span>        <span class=k>switch</span> <span class=p>(</span><span class=n>type</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>case</span> <span class=nl>IMAGE_REL_BASED_HIGHLOW</span><span class=p>:</span>
          <span class=o>*</span><span class=n>change_addr</span> <span class=o>+=</span> <span class=n>delta_VA_reloc</span><span class=p>;</span>
          <span class=k>break</span><span class=p>;</span>
        <span class=k>default</span><span class=o>:</span>
          <span class=k>break</span><span class=p>;</span>
        <span class=p>}</span>
      <span class=p>}</span>

      <span class=c1>// switch to the next relocation block, based on the size
</span><span class=c1></span>      <span class=n>p_reloc</span> <span class=o>=</span> <span class=p>(</span><span class=n>IMAGE_BASE_RELOCATION</span> <span class=o>*</span><span class=p>)(((</span><span class=n>DWORD</span><span class=p>)</span><span class=n>p_reloc</span><span class=p>)</span> <span class=o>+</span> <span class=n>p_reloc</span><span class=o>-&gt;</span><span class=n>SizeOfBlock</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id=0x06-ç»“è®º>0x06 ç»“è®º</h2>
<p>æœ¬æ–‡çš„èƒŒæ™¯çŸ¥è¯†åŸºæœ¬æ˜¯å‚è€ƒç›¸å…³ä¹¦ç±ï¼Œç¼–å†™ Loader çš„éƒ¨åˆ†åˆ™æ¥è‡ª <a class=link href=https://bidouillesecurity.com/ target=_blank rel=noopener>BidouilleSecurity</a> ã€‚å…³äºåŠ å£³è„±å£³åŸç†ï¼Œä¸ä¹å½¢è±¡ç›´è§‚çš„æè¿°ï¼Œä¹Ÿæœ‰å¾ˆå¤šè„±å£³ç›¸å…³æ–‡ç« ï¼Œä½†é€‚åˆèŒæ–°ä¸Šæ‰‹ã€èƒ½ç…§ç€æ’¸å‡ºä»£ç çš„æ–‡ç« å°±å¾ˆå°‘ï¼Œç”šè‡³å¯ä»¥è¯´æ²¡åœ°æ–¹æ‰¾ã€‚æŠ›å¼€åŠ å£³è„±å£³è¿™äº›ç‰¹å®šé¢†åŸŸè¯é¢˜ä¸è°ˆï¼Œç¨‹åºçš„åŠ è½½åˆ°æ‰§è¡Œæœ¬èº«å¯¹æœ‰å¥½å¥‡å¿ƒçš„ç å†œä¹Ÿæ˜¯å¾ˆå€¼å¾—ä¸€èŠçš„å†…å®¹ã€‚</p>
<p>ç›®å‰è®¨è®ºçš„èŒƒå›´åŒ…æ‹¬äº†å¦‚ä½•åŠ è½½å¹¶è¿è¡Œä¸€ä¸ªWindowsç¨‹åºï¼ˆ32ä½ï¼‰ï¼Œå¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>è¯»å–æ–‡ä»¶åˆ°å†…å­˜</li>
<li>æ˜ å°„æ–‡ä»¶å¤´åˆ°åŸºåœ°å€</li>
<li>æ˜ å°„Sections</li>
<li>å¡«å……IAT</li>
<li>é‡å®šä½</li>
<li>è·³è½¬åˆ°å…¥å£ç‚¹å¼€å§‹æ‰§è¡Œã€‚</li>
</ul>
<p>åœ¨å¯¹è¿™äº›çŸ¥è¯†æœ‰äº†è¶³å¤Ÿäº†è§£åï¼Œå·²ç»èƒ½å†™å‡ºåŸºæœ¬çš„å£³ç¨‹åºäº†ã€‚ä¹Ÿè®¸ä¸‹ä¸€ç¯‡æ–‡ç« ä¼šè°ˆã€‚</p>
<p>å‚è€ƒèµ„æ–™ï¼š</p>
<ul>
<li>
<p><a class=link href=https://bidouillesecurity.com/tutorial-writing-a-pe-packer-part-1/ target=_blank rel=noopener>writing a PE packer - Part 1 : Load a PE in memory</a></p>
</li>
<li>
<p><a class=link href=https://bidouillesecurity.com/tutorial-writing-a-pe-packer-part-2/ target=_blank rel=noopener>writing a PE packer - Part 2 : Imports and relocations</a></p>
</li>
<li>
<p><a class=link href=https://book.douban.com/subject/3652388/ target=_blank rel=noopener>ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»â€”â€”é“¾æ¥ã€è£…è½½ä¸åº“ã€‹</a></p>
</li>
<li>
<p><a class=link href=https://docs.microsoft.com/en-us/windows/win32/debug/pe-format target=_blank rel=noopener>å¾®è½¯æ–‡æ¡£ - PE Format</a></p>
</li>
</ul>
</section>
<footer class=article-footer>
<section class=article-tags>
<a href=/blog/tags/%E9%80%86%E5%90%91/>é€†å‘</a>
<a href=/blog/tags/%E6%B1%87%E7%BC%96/>æ±‡ç¼–</a>
<a href=/blog/tags/windows/>windows</a>
</section>
<section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
</footer>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css integrity=sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js integrity=sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js integrity=sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.querySelector(`.article-content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script>
</article>
<aside class=related-contents--wrapper>
<h2 class=section-title>ç›¸å…³æ–‡ç« </h2>
<div class=related-contents>
<div class="flex article-list--tile">
<article class=has-image>
<a href=/blog/p/learning-packer-08/>
<div class=article-image>
<img src=/blog/p/learning-packer-08/cover.303a5ee85ad8275c094df5988adf0791_hu8b7651a2bda3b235d3ed49f67a1e20bd_99156_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post åŠ å£³åŸç†08ï¼šæ··æ·†æŠ€æœ¯å…¥é—¨" data-key=learning-packer-08 data-hash="md5-MDpe6FrYJ1wJTfWYit8HkQ==">
</div>
<div class=article-details>
<h2 class=article-title>åŠ å£³åŸç†08ï¼šæ··æ·†æŠ€æœ¯å…¥é—¨</h2>
</div>
</a>
</article>
<article class=has-image>
<a href=/blog/p/learning-packer-07/>
<div class=article-image>
<img src=/blog/p/learning-packer-07/cover.303a5ee85ad8275c094df5988adf0791_hu8b7651a2bda3b235d3ed49f67a1e20bd_99156_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post åŠ å£³åŸç†07 - èŠ±æŒ‡ä»¤å…¥é—¨" data-key=learning-packer-07 data-hash="md5-MDpe6FrYJ1wJTfWYit8HkQ==">
</div>
<div class=article-details>
<h2 class=article-title>åŠ å£³åŸç†07 - èŠ±æŒ‡ä»¤å…¥é—¨</h2>
</div>
</a>
</article>
<article class=has-image>
<a href=/blog/p/learning-packer-06/>
<div class=article-image>
<img src=/blog/p/learning-packer-06/cover.303a5ee85ad8275c094df5988adf0791_hu8b7651a2bda3b235d3ed49f67a1e20bd_99156_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post åŠ å£³åŸç†06ï¼šåè°ƒè¯•æŠ€æœ¯å…¥é—¨" data-key=learning-packer-06 data-hash="md5-MDpe6FrYJ1wJTfWYit8HkQ==">
</div>
<div class=article-details>
<h2 class=article-title>åŠ å£³åŸç†06ï¼šåè°ƒè¯•æŠ€æœ¯å…¥é—¨</h2>
</div>
</a>
</article>
<article class=has-image>
<a href=/blog/p/learning-packer-04-zlib-compression-packer-demo/>
<div class=article-image>
<img src=/blog/p/learning-packer-04-zlib-compression-packer-demo/cover.303a5ee85ad8275c094df5988adf0791_hu8b7651a2bda3b235d3ed49f67a1e20bd_99156_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post åŠ å£³åŸç†04 - zlibå‹ç¼©å£³æ¡ˆä¾‹" data-key=learning-packer-04-zlib-compression-packer-demo data-hash="md5-MDpe6FrYJ1wJTfWYit8HkQ==">
</div>
<div class=article-details>
<h2 class=article-title>åŠ å£³åŸç†04 - zlibå‹ç¼©å£³æ¡ˆä¾‹</h2>
</div>
</a>
</article>
<article class=has-image>
<a href=/blog/p/learning-packer-03-support-no-relocations/>
<div class=article-image>
<img src=/blog/p/learning-packer-03-support-no-relocations/cover.303a5ee85ad8275c094df5988adf0791_hu8b7651a2bda3b235d3ed49f67a1e20bd_99156_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post åŠ å£³åŸç†03 - æ”¯æŒæ²¡æœ‰é‡å®šä½çš„ç¨‹åº" data-key=learning-packer-03-support-no-relocations data-hash="md5-MDpe6FrYJ1wJTfWYit8HkQ==">
</div>
<div class=article-details>
<h2 class=article-title>åŠ å£³åŸç†03 - æ”¯æŒæ²¡æœ‰é‡å®šä½çš„ç¨‹åº</h2>
</div>
</a>
</article>
</div>
</div>
</aside>
<link rel=stylesheet href=https://unpkg.com/vssue/dist/vssue.min.css>
<div id=vssue></div>
<script src=https://unpkg.com/vue@2.6.14/dist/vue.runtime.min.js></script>
<script src=https://unpkg.com/vssue@1.4.8/dist/vssue.github.min.js></script>
<script>new Vue({el:"#vssue",render:a=>a("Vssue",{props:{title:"åŠ å£³åŸç†01 - Windows ç¨‹åºçš„åŠ è½½å’Œè¿è¡Œ",options:{autoCreateIssue:!1,owner:"nnnewb",repo:"blog",clientId:"285910fdc1567a1a23e3",clientSecret:"f00da5438d9ac82c4a86024866c7a916ae411edc"}}})})</script>
<footer class=site-footer>
<section class=copyright>
&copy;
2021 -
2022 weakptr's ç¬”è®°
</section>
<section class=powerby>
GitHub Pages <br>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
ä¸»é¢˜ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.11.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è®¾è®¡
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main>
<aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div>
<h2 class="widget-title section-title">ç›®å½•</h2>
<div class=widget--toc>
<nav id=TableOfContents>
<ol>
<li><a href=#å‰è¨€>å‰è¨€</a></li>
<li><a href=#0x01-peæ–‡ä»¶ç»“æ„>0x01 PEæ–‡ä»¶ç»“æ„</a>
<ol>
<li><a href=#11-ä»-pe-coff-æ ¼å¼è¯´èµ·>1.1 ä» PE-COFF æ ¼å¼è¯´èµ·</a></li>
<li><a href=#12-pe-æ–‡ä»¶å¤´ä¸€è§ˆ>1.2 PE æ–‡ä»¶å¤´ä¸€è§ˆ</a></li>
<li><a href=#13-dos-æ–‡ä»¶å¤´>1.3 DOS æ–‡ä»¶å¤´</a></li>
<li><a href=#14-ntfilecoff-æ–‡ä»¶å¤´>1.4 NT/File/COFF æ–‡ä»¶å¤´</a></li>
<li><a href=#15-å¯é€‰æ–‡ä»¶å¤´>1.5 å¯é€‰æ–‡ä»¶å¤´</a></li>
</ol>
</li>
<li><a href=#0x02-åŠ è½½pe>0x02 åŠ è½½PE</a>
<ol>
<li><a href=#21-åŠ è½½å’Œå†…å­˜åˆå§‹åŒ–>2.1 åŠ è½½å’Œå†…å­˜åˆå§‹åŒ–</a></li>
</ol>
</li>
<li><a href=#0x03-å¯¼å…¥è¡¨>0x03 å¯¼å…¥è¡¨</a>
<ol>
<li><a href=#31-å¯¼å…¥è¡¨ä»‹ç»>3.1 å¯¼å…¥è¡¨ä»‹ç»</a></li>
<li><a href=#32-data-directory-å’Œ-idt>3.2 Data Directory å’Œ IDT</a></li>
<li><a href=#33--å¡«å……å¯¼å…¥è¡¨>3.3 å¡«å……å¯¼å…¥è¡¨</a></li>
</ol>
</li>
<li><a href=#0x04-é‡å®šä½>0x04 é‡å®šä½</a>
<ol>
<li><a href=#41-é‡å®šä½ä»‹ç»>4.1 é‡å®šä½ä»‹ç»</a></li>
<li><a href=#42-peé‡å®šä½ç»“æ„>4.2 PEé‡å®šä½ç»“æ„</a></li>
<li><a href=#43-ä¿®å¤é‡å®šä½>4.3 ä¿®å¤é‡å®šä½</a></li>
</ol>
</li>
<li><a href=#0x05-å®Œæ•´-loader-ç¨‹åº>0x05 å®Œæ•´ Loader ç¨‹åº</a></li>
<li><a href=#0x06-ç»“è®º>0x06 ç»“è®º</a></li>
</ol>
</nav>
</div>
</section>
</aside>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/blog/ts/main.js defer></script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>