<!doctype html><html lang=zh-cn>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="得有个前言 总之上一个 crackme-01 还过得去，稍微加强一点，把密码隐藏起来，不要随便被看到。
0x01 源码 #include &amp;lt;stdio.h&amp;gt;#include &amp;lt;stdlib.h&amp;gt;#include &amp;lt;string.h&amp;gt; size_t getline(char **lineptr, size_t *n, FILE *stream) { char *bufptr = NULL; char *p = bufptr; size_t size; int c; if (lineptr == NULL) { return -1; } if (stream == NULL) { return -1; } if (n == NULL) { return -1; } bufptr = *lineptr; size = *n; c = fgetc(stream); if (c == EOF) { return -1; } if (bufptr == NULL) { bufptr = malloc(128); if (bufptr == NULL) { return -1; } size = 128; } p = bufptr; while (c !"><title>自娱自乐 crackme-02</title>
<link rel=canonical href=https://nnnewb.github.io/blog/p/crackme-02/>
<link rel=stylesheet href=/blog/scss/style.min.css><meta property="og:title" content="自娱自乐 crackme-02">
<meta property="og:description" content="得有个前言 总之上一个 crackme-01 还过得去，稍微加强一点，把密码隐藏起来，不要随便被看到。
0x01 源码 #include &amp;lt;stdio.h&amp;gt;#include &amp;lt;stdlib.h&amp;gt;#include &amp;lt;string.h&amp;gt; size_t getline(char **lineptr, size_t *n, FILE *stream) { char *bufptr = NULL; char *p = bufptr; size_t size; int c; if (lineptr == NULL) { return -1; } if (stream == NULL) { return -1; } if (n == NULL) { return -1; } bufptr = *lineptr; size = *n; c = fgetc(stream); if (c == EOF) { return -1; } if (bufptr == NULL) { bufptr = malloc(128); if (bufptr == NULL) { return -1; } size = 128; } p = bufptr; while (c !">
<meta property="og:url" content="https://nnnewb.github.io/blog/p/crackme-02/">
<meta property="og:site_name" content="weakptr's 笔记">
<meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="汇编"><meta property="article:tag" content="逆向"><meta property="article:published_time" content="2021-09-15T15:43:00+08:00"><meta property="article:modified_time" content="2021-09-15T15:43:00+08:00">
<meta name=twitter:title content="自娱自乐 crackme-02">
<meta name=twitter:description content="得有个前言 总之上一个 crackme-01 还过得去，稍微加强一点，把密码隐藏起来，不要随便被看到。
0x01 源码 #include &amp;lt;stdio.h&amp;gt;#include &amp;lt;stdlib.h&amp;gt;#include &amp;lt;string.h&amp;gt; size_t getline(char **lineptr, size_t *n, FILE *stream) { char *bufptr = NULL; char *p = bufptr; size_t size; int c; if (lineptr == NULL) { return -1; } if (stream == NULL) { return -1; } if (n == NULL) { return -1; } bufptr = *lineptr; size = *n; c = fgetc(stream); if (c == EOF) { return -1; } if (bufptr == NULL) { bufptr = malloc(128); if (bufptr == NULL) { return -1; } size = 128; } p = bufptr; while (c !">
</head>
<body class="article-page has-toc">
<script>(function(){const a='StackColorScheme';localStorage.getItem(a)||localStorage.setItem(a,"auto")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex
extended">
<div id=article-toolbar>
<a href=https://nnnewb.github.io/blog class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg>
<span>返回</span>
</a>
</div>
<main class="main full-width">
<article class=main-article>
<header class=article-header>
<div class=article-details>
<header class=article-category>
<a href=/blog/categories/%E9%80%86%E5%90%91/>
逆向
</a>
</header>
<h2 class=article-title>
<a href=/blog/p/crackme-02/>自娱自乐 crackme-02</a>
</h2>
<footer class=article-time>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2021年 9月 15日</time>
</div>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>
阅读时长: 9 分钟
</time>
</div>
</footer>
</div>
</header>
<section class=article-content>
<h2 id=得有个前言>得有个前言</h2>
<p>总之上一个 crackme-01 还过得去，稍微加强一点，把密码隐藏起来，不要随便被看到。</p>
<h2 id=0x01-源码>0x01 源码</h2>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=n>size_t</span> <span class=nf>getline</span><span class=p>(</span><span class=kt>char</span> <span class=o>**</span><span class=n>lineptr</span><span class=p>,</span> <span class=n>size_t</span> <span class=o>*</span><span class=n>n</span><span class=p>,</span> <span class=n>FILE</span> <span class=o>*</span><span class=n>stream</span><span class=p>)</span> <span class=p>{</span>
  <span class=kt>char</span> <span class=o>*</span><span class=n>bufptr</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
  <span class=kt>char</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=n>bufptr</span><span class=p>;</span>
  <span class=n>size_t</span> <span class=n>size</span><span class=p>;</span>
  <span class=kt>int</span> <span class=n>c</span><span class=p>;</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>lineptr</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>stream</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>n</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=n>bufptr</span> <span class=o>=</span> <span class=o>*</span><span class=n>lineptr</span><span class=p>;</span>
  <span class=n>size</span> <span class=o>=</span> <span class=o>*</span><span class=n>n</span><span class=p>;</span>

  <span class=n>c</span> <span class=o>=</span> <span class=n>fgetc</span><span class=p>(</span><span class=n>stream</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>c</span> <span class=o>==</span> <span class=n>EOF</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>bufptr</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>bufptr</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=mi>128</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>bufptr</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=n>size</span> <span class=o>=</span> <span class=mi>128</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=n>p</span> <span class=o>=</span> <span class=n>bufptr</span><span class=p>;</span>
  <span class=k>while</span> <span class=p>(</span><span class=n>c</span> <span class=o>!=</span> <span class=n>EOF</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>((</span><span class=n>p</span> <span class=o>-</span> <span class=n>bufptr</span><span class=p>)</span> <span class=o>&gt;</span> <span class=p>(</span><span class=n>size</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span> <span class=p>{</span>
      <span class=n>size</span> <span class=o>=</span> <span class=n>size</span> <span class=o>+</span> <span class=mi>128</span><span class=p>;</span>
      <span class=n>bufptr</span> <span class=o>=</span> <span class=n>realloc</span><span class=p>(</span><span class=n>bufptr</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>
      <span class=k>if</span> <span class=p>(</span><span class=n>bufptr</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
      <span class=p>}</span>
    <span class=p>}</span>
    <span class=o>*</span><span class=n>p</span><span class=o>++</span> <span class=o>=</span> <span class=n>c</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>c</span> <span class=o>==</span> <span class=sc>&#39;\n&#39;</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>break</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=n>c</span> <span class=o>=</span> <span class=n>fgetc</span><span class=p>(</span><span class=n>stream</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=o>*</span><span class=n>p</span><span class=o>++</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
  <span class=o>*</span><span class=n>lineptr</span> <span class=o>=</span> <span class=n>bufptr</span><span class=p>;</span>
  <span class=o>*</span><span class=n>n</span> <span class=o>=</span> <span class=n>size</span><span class=p>;</span>

  <span class=k>return</span> <span class=n>p</span> <span class=o>-</span> <span class=n>bufptr</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
<span class=p>}</span>

<span class=n>size_t</span> <span class=nf>r_trim</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>str</span><span class=p>,</span> <span class=n>size_t</span> <span class=n>len</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>size_t</span> <span class=n>slen</span> <span class=o>=</span> <span class=n>strnlen</span><span class=p>(</span><span class=n>str</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>
  <span class=k>for</span> <span class=p>(</span><span class=n>size_t</span> <span class=n>i</span> <span class=o>=</span> <span class=n>slen</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>str</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>==</span> <span class=sc>&#39; &#39;</span> <span class=o>||</span> <span class=n>str</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>==</span> <span class=sc>&#39;\n&#39;</span> <span class=o>||</span> <span class=n>str</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>==</span> <span class=sc>&#39;\r&#39;</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>str</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
      <span class=k>break</span><span class=p>;</span>
    <span class=p>}</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=n>strnlen</span><span class=p>(</span><span class=n>str</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>
<span class=p>}</span>

<span class=kt>char</span> <span class=o>*</span><span class=nf>calculate</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>username</span><span class=p>,</span> <span class=k>const</span> <span class=n>size_t</span> <span class=n>username_len</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// 初始化固定8字节计算密钥的空间
</span><span class=c1></span>  <span class=k>const</span> <span class=n>size_t</span> <span class=n>input_buf_len</span> <span class=o>=</span> <span class=mi>8</span><span class=p>;</span>
  <span class=kt>char</span> <span class=o>*</span><span class=n>input_buf</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=n>input_buf_len</span><span class=p>);</span>
  <span class=k>for</span> <span class=p>(</span><span class=n>size_t</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>input_buf_len</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>input_buf</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mh>0x52</span> <span class=o>+</span> <span class=n>i</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=c1>// 用用户输入替换初始化的数据
</span><span class=c1></span>  <span class=n>memcpy_s</span><span class=p>(</span><span class=n>input_buf</span><span class=p>,</span> <span class=n>input_buf_len</span><span class=p>,</span> <span class=n>username</span><span class=p>,</span> <span class=n>username_len</span><span class=p>);</span>

  <span class=c1>// 异或处理
</span><span class=c1></span>  <span class=k>for</span> <span class=p>(</span><span class=n>size_t</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>input_buf_len</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>input_buf</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>^=</span> <span class=mh>0x25</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=c1>// 初始化 Hex 输出
</span><span class=c1></span>  <span class=k>const</span> <span class=n>size_t</span> <span class=n>output_buf_len</span> <span class=o>=</span> <span class=mi>17</span><span class=p>;</span>
  <span class=kt>char</span> <span class=o>*</span><span class=n>output_buf</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=n>output_buf_len</span><span class=p>);</span>

  <span class=c1>// 转为可读字符串
</span><span class=c1></span>  <span class=k>for</span> <span class=p>(</span><span class=n>size_t</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>input_buf_len</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>sprintf</span><span class=p>(</span><span class=o>&amp;</span><span class=n>output_buf</span><span class=p>[</span><span class=n>i</span> <span class=o>*</span> <span class=mi>2</span><span class=p>],</span> <span class=s>&#34;%02x&#34;</span><span class=p>,</span> <span class=n>input_buf</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
  <span class=p>}</span>

  <span class=n>output_buf</span><span class=p>[</span><span class=mi>16</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
  <span class=n>free</span><span class=p>(</span><span class=n>input_buf</span><span class=p>);</span>
  <span class=k>return</span> <span class=n>output_buf</span><span class=p>;</span>
<span class=p>}</span>

<span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>while</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
    <span class=kt>char</span> <span class=o>*</span><span class=n>username</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
    <span class=n>size_t</span> <span class=n>username_len</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=kt>char</span> <span class=o>*</span><span class=n>serial</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
    <span class=n>size_t</span> <span class=n>serial_len</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=n>size_t</span> <span class=n>linesize</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>

    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;username:&#34;</span><span class=p>);</span>
    <span class=n>linesize</span> <span class=o>=</span> <span class=n>getline</span><span class=p>(</span><span class=o>&amp;</span><span class=n>username</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>username_len</span><span class=p>,</span> <span class=n>stdin</span><span class=p>);</span>
    <span class=n>username_len</span> <span class=o>=</span> <span class=n>r_trim</span><span class=p>(</span><span class=n>username</span><span class=p>,</span> <span class=n>linesize</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>username_len</span> <span class=o>&gt;</span> <span class=mi>8</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>free</span><span class=p>(</span><span class=n>username</span><span class=p>);</span>
      <span class=n>puts</span><span class=p>(</span><span class=s>&#34;username less than 8 letter&#34;</span><span class=p>);</span>
      <span class=k>continue</span><span class=p>;</span>
    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>username_len</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>free</span><span class=p>(</span><span class=n>username</span><span class=p>);</span>
      <span class=k>continue</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;serial:&#34;</span><span class=p>);</span>
    <span class=n>linesize</span> <span class=o>=</span> <span class=n>getline</span><span class=p>(</span><span class=o>&amp;</span><span class=n>serial</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>serial_len</span><span class=p>,</span> <span class=n>stdin</span><span class=p>);</span>
    <span class=n>serial_len</span> <span class=o>=</span> <span class=n>r_trim</span><span class=p>(</span><span class=n>serial</span><span class=p>,</span> <span class=n>linesize</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>serial_len</span> <span class=o>!=</span> <span class=mi>16</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>free</span><span class=p>(</span><span class=n>username</span><span class=p>);</span>
      <span class=n>free</span><span class=p>(</span><span class=n>serial</span><span class=p>);</span>
      <span class=n>puts</span><span class=p>(</span><span class=s>&#34;serial has 16 letters&#34;</span><span class=p>);</span>
      <span class=k>continue</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=kt>char</span> <span class=o>*</span><span class=n>correct</span> <span class=o>=</span> <span class=n>calculate</span><span class=p>(</span><span class=n>username</span><span class=p>,</span> <span class=n>username_len</span><span class=p>);</span>
    <span class=kt>int</span> <span class=n>rc</span> <span class=o>=</span> <span class=n>strncmp</span><span class=p>(</span><span class=n>serial</span><span class=p>,</span> <span class=n>correct</span><span class=p>,</span> <span class=mi>16</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>rc</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>free</span><span class=p>(</span><span class=n>correct</span><span class=p>);</span>
      <span class=n>puts</span><span class=p>(</span><span class=s>&#34;Good job!&#34;</span><span class=p>);</span>
      <span class=k>break</span><span class=p>;</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
      <span class=n>puts</span><span class=p>(</span><span class=s>&#34;wrong pwd!&#34;</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=n>free</span><span class=p>(</span><span class=n>username</span><span class=p>);</span>
    <span class=n>free</span><span class=p>(</span><span class=n>serial</span><span class=p>);</span>
    <span class=n>free</span><span class=p>(</span><span class=n>correct</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>编译方式是</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-batch data-lang=batch>clang main.c -o cm02-easy.exe -Wall -m32 -O0
clang main.c -o cm02-normal.exe -Wall -m32 -O1
clang main.c -o cm02-hard.exe -Wall -m32 -O2
</code></pre></div><h2 id=0x02-观察>0x02 观察</h2>
<p>启动后观察行为（不截图了。）</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext>weakptr in cm02 ❯ .\cm02-easy.exe
username:abc
serial:123456
serial 长度为16
username:abc
serial:123456789012345 
wrong pwd!
username:
serial:
serial 长度为16
username:abc
serial:aaaaaaaaaaaaaaa
wrong pwd!
</code></pre></div><p>这次的目标是：</p>
<ol>
<li>得到某个用户名对应的序列号（<code>serial</code>）。</li>
<li>破解，总是正确或对任何输入都提示正确。</li>
<li>注册机。</li>
</ol>
<h2 id=0x03-静态分析---easy>0x03 静态分析 - easy</h2>
<h3 id=31-主循环>3.1 主循环</h3>
<p>在公司没IDA，用 <a class=link href=image/crackme-02/https://cutter.re/>Cutter</a> 打开，在上方输入框输入 <code>main</code> 跳转到 <code>main</code> 函数。</p>
<p><img src=/blog/image/crackme-02/cm02-easy-1.png alt=image-20210914114426600></p>
<p>然后点击 <em>图表（main）</em> 进入类似 IDA 的控制流视图。</p>
<p><img src=/blog/image/crackme-02/cm02-easy-2.png alt=image-20210914114547128></p>
<p>之后就能看到下面的控制流了。</p>
<p><img src=/blog/image/crackme-02/cm02-easy-3.png alt></p>
<p>easy难度下没有开启任何编译器优化，控制流和原始代码能直接对应上。瞧着困难很多对吧？</p>
<p>先简单扫一眼，会发现很多分支直接跳回了<code>0x0040139d</code>，也就是从上往下数第二个代码块，基本每个跳转都是下一个块或跳回这个块。按照 <a class=link href=https://nnnewb.github.io/blog/p/crackme-01/ target=_blank rel=noopener>cm01</a>的经验，我们先找到关键的一跳。可以直接搜索字符串引用（<code>wrong pwd!</code>），也可以逐个代码块看下去。</p>
<p>很快，右下角的关键跳出现在眼前。</p>
<p><img src=/blog/image/crackme-02/cm02-easy-4.png alt=image-20210914152834262></p>
<p>接着回头看跳转条件。</p>
<p><img src=/blog/image/crackme-02/cm02-easy-5.png alt=image-20210914153728179></p>
<p>虽然没有名字，但<code>fcn.00403ef4</code> 是老熟人了。三个参数，<code>ecx</code>、<code>eax</code>、<code>0x10</code>，返回结果和<code>0</code>做比较，<code>jne</code>条件跳转。</p>
<ul>
<li><code>cmp</code>指令，操作数相减（<code>dest</code>-<code>src</code>），结果存入标志位 <code>SF</code>和<code>ZF</code>。
<ul>
<li>结果是负数（<code>dest</code>&lt;<code>src</code>），<code>SF</code>也就是结果符号位设置为1。</li>
<li>结果是正数（<code>dest</code>><code>src</code>），<code>SF</code>也就是结果符号位设置为0。</li>
<li>结果是0（<code>dest</code>=<code>src</code>），<code>ZF</code>设置为1。</li>
</ul>
</li>
<li><code>jne</code>或<code>jnz</code>指令，非零跳转。<code>ZF</code>标志位为<code>1</code>时跳转。</li>
</ul>
<p>猜测这个函数应该是<code>strncmp</code>。继续往回看参数是怎么来的。</p>
<p><img src=/blog/image/crackme-02/cm02-easy-6.png alt=image-20210914155544252></p>
<p><code>eax</code>来自<code>sub.02x_40298c</code>这个函数，后面两个脱裤子放屁的<code>mov</code>忽略。<code>ecx</code>则来来自<code>mov ecx,dword [ebp-10h]</code>这一行。</p>
<p>先不着急分析函数，继续往回找，找到<code>[ebp-10h]</code>的来源。</p>
<p><img src=/blog/image/crackme-02/cm02-easy-7.png alt=image-20210914161814604></p>
<p>在入口点附近，看到<code>[ebp-10]</code>被初始化成了0。</p>
<p>因为没有很明确的路径，手动计算栈上偏移又非常麻烦，这里本应该掏出调试器——但出于学习练手的目的，还是先尝试计算下。首先回顾下简化的栈内存布局，从上往下增长，如图。</p>
<p><img src=/blog/image/crackme-02/cm02-easy-8.png alt=stack-layout></p>
<p>接下来从<code>mov ebp,esp</code>开始，往下列出所有函数调用，捋一捋逻辑。</p>
<p><img src=/blog/image/crackme-02/cm02-easy-9.png alt=image-20210914214920437></p>
<p>第一个框，<code>[esp+2ch+Ix]</code> 计算结果是 <code>[esp]</code>，也就是栈顶，栈顶设置为字符串 <code>username:</code>，接着调用一个未知函数。从参数判断我们先认为是一个输出字符串的函数。</p>
<p>再看第二个框，<code>acrt_iob_func</code>，百度一下就会发现，<code>__acrt_iob_func</code>函数是定义于 c 运行库里的函数，作用是返回 <code>stdin/stdout/stderr</code> 。栈顶设置为0，所以获得的是 <code>stdin</code>。</p>
<p>再看第三个框，<code>edx</code>和<code>ecx</code>赋值为栈上两个变量的地址，再为参数。按顺序就是<code>f(edx,ecx,stdin)</code>。暂时不明。函数返回值被赋值回了<code>[ebp-18h]</code>。</p>
<p>第四个框，从第三个框得到的返回值被当参数传给一个未知函数。<code>f([ebp-8h], [ebp-18h])</code>，返回值被赋值回 <code>[ebp-0Ch]</code>。</p>
<p>结合最后的 <code>cmp</code> 和 <code>jbe</code> 指令分析，人肉反编译后用伪代码表示，就是下面这样。<code>jbe</code>指令只在<code>cmp</code>左操作数小于等于右操作数时执行跳转（<code>CF</code>标志位和<code>ZF</code>标志位其中一个为1时）。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=n>var</span> <span class=n>var_8</span> <span class=c1># 偏移值 ebp-8h</span>
<span class=n>var</span> <span class=n>var_0C</span> <span class=c1># 偏移值 ebp-0Ch</span>
<span class=n>var</span> <span class=n>var_18</span> <span class=c1># 偏移值 ebp-18h</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&#34;username:&#34;</span><span class=p>)</span>
<span class=n>var_18</span> <span class=o>=</span> <span class=n>unknown_func1</span><span class=p>(</span><span class=o>&amp;</span><span class=n>var_8</span><span class=p>,</span><span class=o>&amp;</span><span class=n>var_0c</span><span class=p>,</span><span class=n>stdin</span><span class=p>)</span>
<span class=n>var_0c</span> <span class=o>=</span> <span class=n>unknown_func2</span><span class=p>(</span><span class=n>var_8</span><span class=p>,</span> <span class=n>var_18</span><span class=p>)</span>
<span class=k>if</span> <span class=n>var_0c</span> <span class=o>&lt;=</span> <span class=mi>8</span><span class=p>:</span>
    <span class=o>...</span> <span class=c1># jbe 跳转执行</span>
</code></pre></div><p><img src=/blog/image/crackme-02/cm02-easy-10.png alt=image-20210914223919137></p>
<p>可以看出，当 <code>var_0c</code> 小于 8 时，提示 <code>username less than 8 letter</code> 。因此可以确定 <code>[ebp-0Ch]</code> 这个变量就是 <code>username</code> 字符串的长度，上一个函数会计算字符串长度返回。我们再根据这个发现修改下伪代码。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=n>var</span> <span class=n>var_8</span> <span class=c1># 偏移值 ebp-8h</span>
<span class=n>var</span> <span class=n>username_len</span> <span class=c1># 偏移值 ebp-0Ch</span>
<span class=n>var</span> <span class=n>var_18</span> <span class=c1># 偏移值 ebp-18h</span>

<span class=nb>print</span><span class=p>(</span><span class=s2>&#34;username:&#34;</span><span class=p>)</span>
<span class=n>var_18</span> <span class=o>=</span> <span class=n>unknown_func1</span><span class=p>(</span><span class=o>&amp;</span><span class=n>var_8</span><span class=p>,</span><span class=o>&amp;</span><span class=n>username_len</span><span class=p>,</span><span class=n>stdin</span><span class=p>)</span> <span class=c1># var_8 可能是 username 指针</span>
<span class=n>username_len</span> <span class=o>=</span> <span class=n>unknown_func2</span><span class=p>(</span><span class=n>var_8</span><span class=p>,</span> <span class=n>var_18</span><span class=p>)</span> <span class=c1># 计算字符串长度</span>
<span class=k>if</span> <span class=n>username_len</span> <span class=o>&lt;=</span> <span class=mi>8</span><span class=p>:</span>
    <span class=o>...</span> <span class=c1># jbe 跳转执行</span>
<span class=k>else</span><span class=p>:</span>
    <span class=c1># jmp 到开头</span>

</code></pre></div><p>第一个未知函数看起来已经呼之欲出了，<code>stdin</code>和<code>&username_len</code>作为参数，<code>var_8</code> 有极大可能就是<code>username</code>字符串指针。不过在进入调试器前，还不能马上下结论，继续看正确跳转的代码。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=nf>cmp</span> <span class=p>[</span><span class=no>ebp-0Ch</span><span class=p>],</span> <span class=mi>0</span>
<span class=nf>jnz</span> <span class=no>...</span>
</code></pre></div><p>这次是比较用户名长度和0，非0跳转。</p>
<p><img src=/blog/image/crackme-02/cm02-easy-11.png alt=image-20210914224625891></p>
<p>可以看到为零时，经过一个未知函数 <code>sub_4036FC(var_8)</code> 后，跳回开头。</p>
<p>继续看正确流程，<code>jmp $+5</code> ，<code>$</code> 表示当前正在执行的代码在代码段内的偏移量，+5就是从当前代码开始往后跳过5个字节，我们直接看IDA分析好的跳转位置。</p>
<p><img src=/blog/image/crackme-02/cm02-easy-12.png alt=image-20210914225052452></p>
<p>又是非常熟悉的代码，和读取 <code>username</code> 的分析方式相同，以相同的顺序调用相同的函数，可以得到<code>var_14</code>是<code>serial_len</code>，<code>Str1</code>可能是<code>serial</code>字符串指针。不做重复分析，继续往下看。</p>
<p><img src=/blog/image/crackme-02/cm02-easy-13.png alt=image-20210914225322787></p>
<p>右边的代码块是关于长度的判断，分析方法不再重复。左侧代码就是我们的关键跳转了，其中出现两个函数调用。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=nf>mov</span>     <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>ebp</span><span class=err>+</span><span class=no>var_C</span><span class=p>]</span>
<span class=nf>mov</span>     <span class=no>ecx</span><span class=p>,</span> <span class=p>[</span><span class=no>ebp</span><span class=err>+</span><span class=no>Block</span><span class=p>]</span>
<span class=nf>mov</span>     <span class=p>[</span><span class=no>esp</span><span class=err>+</span><span class=mi>2</span><span class=no>Ch</span><span class=err>+</span><span class=no>Ix</span><span class=p>],</span> <span class=no>ecx</span> <span class=c>; void *
</span><span class=c></span><span class=no>mov</span>     <span class=p>[</span><span class=no>esp</span><span class=err>+</span><span class=mi>2</span><span class=no>Ch</span><span class=err>+</span><span class=no>Str2</span><span class=p>],</span> <span class=no>eax</span> <span class=c>; size_t
</span><span class=c></span><span class=no>call</span>    <span class=no>sub_401250</span>
<span class=nf>mov</span>     <span class=p>[</span><span class=no>ebp</span><span class=err>+</span><span class=no>var_1C</span><span class=p>],</span> <span class=no>eax</span>
</code></pre></div><p><code>var_c</code>先前被判断是<code>username_len</code>，<code>Block</code>就是<code>var_8</code>，先前被怀疑是用户键入的用户名字符串指针。未知函数的返回值保存在 <code>[ebp-1ch]</code>中。</p>
<p>这个<code>1c</code>在随后的代码中立刻被用到。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=nf>mov</span>     <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>ebp</span><span class=err>+</span><span class=no>var_1C</span><span class=p>]</span>
<span class=nf>mov</span>     <span class=no>ecx</span><span class=p>,</span> <span class=p>[</span><span class=no>ebp</span><span class=err>+</span><span class=no>Str1</span><span class=p>]</span>
<span class=nf>mov</span>     <span class=p>[</span><span class=no>esp</span><span class=err>+</span><span class=mi>2</span><span class=no>Ch</span><span class=err>+</span><span class=no>Ix</span><span class=p>],</span> <span class=no>ecx</span> <span class=c>; Str1
</span><span class=c></span><span class=no>mov</span>     <span class=p>[</span><span class=no>esp</span><span class=err>+</span><span class=mi>2</span><span class=no>Ch</span><span class=err>+</span><span class=no>Str2</span><span class=p>],</span> <span class=no>eax</span> <span class=c>; Str2
</span><span class=c></span><span class=no>mov</span>     <span class=p>[</span><span class=no>esp</span><span class=err>+</span><span class=mi>2</span><span class=no>Ch</span><span class=err>+</span><span class=no>MaxCount</span><span class=p>],</span> <span class=mi>10</span><span class=no>h</span> <span class=c>; MaxCount
</span><span class=c></span><span class=no>call</span>    <span class=no>_strncmp</span>
<span class=nf>mov</span>     <span class=p>[</span><span class=no>ebp</span><span class=err>+</span><span class=no>var_20</span><span class=p>],</span> <span class=no>eax</span>
</code></pre></div><p><code>Str1</code>在<code>serial</code>输入这一步被怀疑是用户输入的序列号字符串指针，它和上一个函数调用返回的<code>var_1c</code>被作为参数传递给<code>strncmp</code>，字符串长度最大16字节。由此可见，<code>var_1c</code>基本可以确定是正确序列号的指针，之前的未知函数可能就是生成序列号的函数。</p>
<p>下一步分析序列号生成函数。</p>
<h3 id=32-生成序列号>3.2 生成序列号</h3>
<p>先看下控制流全览，能依稀分辨出三个循环。</p>
<p><img src=/blog/image/crackme-02/cm02-easy-14.png alt=generate></p>
<p>自动分析出的变量表</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=c>; var uint32_t var_1ch @ ebp-0x1c
</span><span class=c>; var int32_t var_18h @ ebp-0x18
</span><span class=c>; var int32_t var_14h @ ebp-0x14
</span><span class=c>; var uint32_t var_10h @ ebp-0x10
</span><span class=c>; var uint32_t var_ch @ ebp-0xc
</span><span class=c>; var int32_t var_8h @ ebp-0x8
</span><span class=c>; var int32_t var_4h @ ebp-0x4
</span><span class=c>; arg uint32_t arg_8h @ ebp+0x8
</span><span class=c>; arg int32_t arg_ch @ ebp+0xc
</span><span class=c>; var int32_t var_sp_4h @ esp+0x4
</span><span class=c>; var int32_t var_sp_8h @ esp+0x8
</span><span class=c>; var int32_t var_sp_ch @ esp+0xc
</span></code></pre></div><p>先看循环外的代码，简单按用途划一下分隔线。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=err>0</span><span class=nf>x004071f0</span>      <span class=no>push</span>    <span class=no>ebp</span>
<span class=err>0</span><span class=nf>x004071f1</span>      <span class=no>mov</span>     <span class=no>ebp</span><span class=p>,</span> <span class=no>esp</span>
<span class=err>0</span><span class=nf>x004071f3</span>      <span class=no>sub</span>     <span class=no>esp</span><span class=p>,</span> <span class=mi>0x2c</span>
<span class=c>; ---
</span><span class=c></span><span class=err>0</span><span class=nf>x004071f6</span>      <span class=no>mov</span>     <span class=no>eax</span><span class=p>,</span> <span class=no>dword</span> <span class=p>[</span><span class=no>arg_ch</span><span class=p>]</span>
<span class=err>0</span><span class=nf>x004071f9</span>      <span class=no>mov</span>     <span class=no>eax</span><span class=p>,</span> <span class=no>dword</span> <span class=p>[</span><span class=no>arg_8h</span><span class=p>]</span>
<span class=c>; ---
</span><span class=c></span><span class=err>0</span><span class=nf>x004071fc</span>      <span class=no>mov</span>     <span class=no>dword</span> <span class=p>[</span><span class=no>var_4h</span><span class=p>],</span> <span class=mi>8</span>
<span class=c>; ---
</span><span class=c></span><span class=err>0</span><span class=nf>x00407203</span>      <span class=no>mov</span>     <span class=no>dword</span> <span class=p>[</span><span class=no>esp</span><span class=p>],</span> <span class=mi>8</span>
<span class=err>0</span><span class=nf>x0040720a</span>      <span class=no>call</span>    <span class=no>fcn.00401302</span>
<span class=err>0</span><span class=nf>x0040720f</span>      <span class=no>mov</span>     <span class=no>dword</span> <span class=p>[</span><span class=no>var_8h</span><span class=p>],</span> <span class=no>eax</span>
<span class=c>; ---
</span><span class=c></span><span class=err>0</span><span class=nf>x00407212</span>      <span class=no>mov</span>     <span class=no>dword</span> <span class=p>[</span><span class=no>var_ch</span><span class=p>],</span> <span class=mi>0</span>
</code></pre></div><p>开头是惯例的两句栈帧准备动作，随后开辟 0x2c 大小的栈空间。</p>
<p>两个没用的 <code>mov eax,...</code>，之后是<code>[ebp-4h]</code>设置为8，再把8作为参数调用了一个未知函数，返回值赋值给<code>[ebp-8h]</code>，再初始化<code>[ebp-ch]</code>为 0。伪代码表示就是下面这样。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>int</span> <span class=n>var_4h</span><span class=p>,</span> <span class=n>var_8h</span><span class=err>，</span> <span class=n>var_ch</span><span class=p>;</span> <span class=c1>// ebp-4h, ebp-8h, ebp-ch
</span><span class=c1></span><span class=n>var_4h</span> <span class=o>=</span> <span class=mh>0x8</span><span class=p>;</span>
<span class=n>var_8h</span> <span class=o>=</span> <span class=n>unknown_func</span><span class=p>(</span><span class=mh>0x8</span><span class=p>);</span>
<span class=n>var_ch</span> <span class=o>=</span> <span class=mh>0x0</span><span class=p>;</span>
</code></pre></div><p>然后是一个条件跳转。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=err>0</span><span class=nf>x00407219</span>      <span class=no>cmp</span>     <span class=no>dword</span> <span class=p>[</span><span class=no>var_ch</span><span class=p>],</span> <span class=mi>8</span>
<span class=err>0</span><span class=nf>x0040721d</span>      <span class=no>jae</span>     <span class=mi>0x407242</span>
</code></pre></div><p>学习下<code>jae</code>指令。<code>jae</code>指令和<code>jnc</code>指令相同，<code>CF=0</code>则跳转。<code>jae</code> 可以看作 <em>Jump if above or equals</em>。上一句 <code>cmp</code> 计算 <code>var_ch - 0x8</code> ，对相关标志位赋值。<code>jae</code>指令根据<code>CF</code>标志位判断，由于<code>cmp</code>指令是减法，所以判断的是减法中有没有出现 <em>借位</em> 。</p>
<p>简单的描述就是，<code>cmp ax, bx</code>，如果<code>ax &lt; bx</code> 则 <code>CF=1</code>，如果 <code>ax >= bx</code> 则 <code>CF=0</code>。</p>
<p>因为我们知道 <code>var_ch</code> 刚被初始化成了0，不成立，继续看不成立的分支。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=err>0</span><span class=nf>x00407223</span>      <span class=no>mov</span>     <span class=no>eax</span><span class=p>,</span> <span class=no>dword</span> <span class=p>[</span><span class=no>var_ch</span><span class=p>]</span>
<span class=err>0</span><span class=nf>x00407226</span>      <span class=no>add</span>     <span class=no>eax</span><span class=p>,</span> <span class=mi>0x52</span>  <span class=c>; 82
</span><span class=c></span><span class=mi>0x00407229</span>      <span class=no>mov</span>     <span class=no>dl</span><span class=p>,</span> <span class=no>al</span>
<span class=c>; ---
</span><span class=c></span><span class=err>0</span><span class=nf>x0040722b</span>      <span class=no>mov</span>     <span class=no>eax</span><span class=p>,</span> <span class=no>dword</span> <span class=p>[</span><span class=no>var_8h</span><span class=p>]</span>
<span class=err>0</span><span class=nf>x0040722e</span>      <span class=no>mov</span>     <span class=no>ecx</span><span class=p>,</span> <span class=no>dword</span> <span class=p>[</span><span class=no>var_ch</span><span class=p>]</span>
<span class=err>0</span><span class=nf>x00407231</span>      <span class=no>mov</span>     <span class=no>byte</span> <span class=p>[</span><span class=no>eax</span> <span class=err>+</span> <span class=no>ecx</span><span class=p>],</span> <span class=no>dl</span>
<span class=c>; ---
</span><span class=c></span><span class=err>0</span><span class=nf>x00407234</span>      <span class=no>mov</span>     <span class=no>eax</span><span class=p>,</span> <span class=no>dword</span> <span class=p>[</span><span class=no>var_ch</span><span class=p>]</span>
<span class=err>0</span><span class=nf>x00407237</span>      <span class=no>add</span>     <span class=no>eax</span><span class=p>,</span> <span class=mi>1</span>
<span class=err>0</span><span class=nf>x0040723a</span>      <span class=no>mov</span>     <span class=no>dword</span> <span class=p>[</span><span class=no>var_ch</span><span class=p>],</span> <span class=no>eax</span>
<span class=err>0</span><span class=nf>x0040723d</span>      <span class=no>jmp</span>     <span class=mi>0x407219</span>
</code></pre></div><p>把<code>var_ch</code>移入寄存器<code>eax</code>后，加上<code>0x52</code>，又移动<code>al</code>到<code>dl</code>。后续<code>eax</code>被用作别的用途，这一番操作其实就是给<code>dl</code>赋值了一个<code>(int16_t)0x52+var_ch</code>。</p>
<p>随后把<code>var_8h</code>和<code>var_ch</code>相加后的地址赋值 <code>dl</code>，也就是<code>0x52</code>。</p>
<p>接着<code>var_ch</code>自增1，跳回 <code>jae</code>判断前的 <code>cmp</code>，形成循环，我们用伪代码表示。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>int</span> <span class=n>var_4h</span><span class=p>,</span> <span class=n>var_8h</span><span class=err>，</span> <span class=n>var_ch</span><span class=p>;</span> <span class=c1>// ebp-4h, ebp-8h, ebp-ch
</span><span class=c1></span><span class=n>var_4h</span> <span class=o>=</span> <span class=mh>0x8</span><span class=p>;</span>
<span class=n>var_8h</span> <span class=o>=</span> <span class=n>unknown_func</span><span class=p>(</span><span class=mh>0x8</span><span class=p>);</span>
<span class=n>var_ch</span> <span class=o>=</span> <span class=mh>0x0</span><span class=p>;</span>
<span class=k>while</span><span class=p>(</span><span class=n>var_ch</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>)</span> <span class=p>{</span>
    <span class=o>*</span><span class=p>(</span><span class=n>var_8h</span> <span class=o>+</span> <span class=n>var_ch</span><span class=p>)</span> <span class=o>=</span> <span class=mh>0x52</span> <span class=o>+</span> <span class=n>var_ch</span><span class=p>;</span>
    <span class=n>var_ch</span><span class=o>++</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>从结构上看，是一个典型的 for 循环。 <code>var_8h</code> 是一个未知函数返回的指针。我们稍微改下伪代码。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>int</span> <span class=n>var_4h</span><span class=p>,</span> <span class=n>var_8h</span><span class=p>;</span> <span class=c1>// ebp-4h, ebp-8h
</span><span class=c1></span><span class=n>var_4h</span> <span class=o>=</span> <span class=mh>0x8</span><span class=p>;</span>
<span class=n>var_8h</span> <span class=o>=</span> <span class=n>unknown_func</span><span class=p>(</span><span class=mh>0x8</span><span class=p>);</span>

<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>var_ch</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>var_ch</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>;</span> <span class=n>var_ch</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// var_ch -&gt; ebp-ch
</span><span class=c1></span>    <span class=n>var_8h</span><span class=p>[</span><span class=n>var_ch</span><span class=p>]</span> <span class=o>=</span> <span class=mh>0x52</span> <span class=o>+</span> <span class=n>var_ch</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>接着继续看循环结束后的代码。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=err>0</span><span class=nf>x00407242</span>      <span class=no>mov</span>     <span class=no>eax</span><span class=p>,</span> <span class=no>dword</span> <span class=p>[</span><span class=no>arg_ch</span><span class=p>]</span> <span class=c>; ebp+ch 函数右往左数第二个入参
</span><span class=c></span><span class=mi>0x00407245</span>      <span class=no>mov</span>     <span class=no>ecx</span><span class=p>,</span> <span class=no>dword</span> <span class=p>[</span><span class=no>arg_8h</span><span class=p>]</span> <span class=c>; ebp+8h 函数右往左数第一个入参
</span><span class=c></span><span class=mi>0x00407248</span>      <span class=no>mov</span>     <span class=no>edx</span><span class=p>,</span> <span class=no>dword</span> <span class=p>[</span><span class=no>var_8h</span><span class=p>]</span> <span class=c>; ebp-8h
</span><span class=c>; ---
</span><span class=c></span><span class=mi>0x0040724b</span>      <span class=no>mov</span>     <span class=no>dword</span> <span class=p>[</span><span class=no>esp</span><span class=p>],</span> <span class=no>edx</span>
<span class=err>0</span><span class=nf>x0040724e</span>      <span class=no>mov</span>     <span class=no>dword</span> <span class=p>[</span><span class=no>var_sp_4h</span><span class=p>],</span> <span class=mi>8</span>
<span class=err>0</span><span class=nf>x00407256</span>      <span class=no>mov</span>     <span class=no>dword</span> <span class=p>[</span><span class=no>var_sp_8h</span><span class=p>],</span> <span class=no>ecx</span>
<span class=err>0</span><span class=nf>x0040725a</span>      <span class=no>mov</span>     <span class=no>dword</span> <span class=p>[</span><span class=no>var_sp_ch</span><span class=p>],</span> <span class=no>eax</span>
<span class=err>0</span><span class=nf>x0040725e</span>      <span class=no>call</span>    <span class=no>fcn.00407310</span>
<span class=err>0</span><span class=nf>x00407263</span>      <span class=no>mov</span>     <span class=no>dword</span> <span class=p>[</span><span class=no>var_10h</span><span class=p>],</span> <span class=mi>0</span>
</code></pre></div><p>从之前分析主循环的代码，我们可以发现 <code>arg_8h</code> 其实是用户名字符串指针，<code>arg_ch</code>是用户名字符串长度。</p>
<p>接着这两个入参，和 <code>var_8h</code>，也就是之前得到指针，传入一个未知函数，随后再初始化了一个变量 <code>var_10h</code>。</p>
<p>伪代码如下。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=n>unknown_func</span><span class=p>(</span><span class=n>var_8h</span><span class=p>,</span> <span class=mh>0x8</span><span class=p>,</span> <span class=n>username</span><span class=p>,</span> <span class=n>username_len</span><span class=p>);</span> <span class=c1>// 猜测的函数签名 func(void*, int, void*, int)
</span><span class=c1></span><span class=kt>int</span> <span class=n>var_10h</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</code></pre></div><p>接着又是一个条件跳转。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=err>0</span><span class=nf>x0040726a</span>      <span class=no>cmp</span>     <span class=no>dword</span> <span class=p>[</span><span class=no>var_10h</span><span class=p>],</span> <span class=mi>8</span>
<span class=err>0</span><span class=nf>x0040726e</span>      <span class=no>jae</span>     <span class=mi>0x407292</span>
</code></pre></div><p>和先前的循环相同，不作重复分析，直接进入循环体。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=err>0</span><span class=nf>x00407274</span>      <span class=no>mov</span>     <span class=no>eax</span><span class=p>,</span> <span class=no>dword</span> <span class=p>[</span><span class=no>var_8h</span><span class=p>]</span>
<span class=err>0</span><span class=nf>x00407277</span>      <span class=no>mov</span>     <span class=no>ecx</span><span class=p>,</span> <span class=no>dword</span> <span class=p>[</span><span class=no>var_10h</span><span class=p>]</span>
<span class=err>0</span><span class=nf>x0040727a</span>      <span class=no>movsx</span>   <span class=no>edx</span><span class=p>,</span> <span class=no>byte</span> <span class=p>[</span><span class=no>eax</span> <span class=err>+</span> <span class=no>ecx</span><span class=p>]</span>
<span class=err>0</span><span class=nf>x0040727e</span>      <span class=no>xor</span>     <span class=no>edx</span><span class=p>,</span> <span class=mi>0x25</span>  <span class=c>; 37
</span><span class=c></span><span class=mi>0x00407281</span>      <span class=no>mov</span>     <span class=no>byte</span> <span class=p>[</span><span class=no>eax</span> <span class=err>+</span> <span class=no>ecx</span><span class=p>],</span> <span class=no>dl</span>
<span class=c>; ---
</span><span class=c></span><span class=err>0</span><span class=nf>x00407284</span>      <span class=no>mov</span>     <span class=no>eax</span><span class=p>,</span> <span class=no>dword</span> <span class=p>[</span><span class=no>var_10h</span><span class=p>]</span>
<span class=err>0</span><span class=nf>x00407287</span>      <span class=no>add</span>     <span class=no>eax</span><span class=p>,</span> <span class=mi>1</span>
<span class=err>0</span><span class=nf>x0040728a</span>      <span class=no>mov</span>     <span class=no>dword</span> <span class=p>[</span><span class=no>var_10h</span><span class=p>],</span> <span class=no>eax</span>
<span class=c>; ---
</span><span class=c></span><span class=err>0</span><span class=nf>x0040728d</span>      <span class=no>jmp</span>     <span class=mi>0x40726a</span>
</code></pre></div><p>前两条指令没什么可说的，<code>movsx</code>还是第一次见，学习下。</p>
<p><code>movsx</code> 从来源取数，不足的部分用来源的符号位填充，这里取的是<code>var_8h[var_10h]</code>，一字节，到 <code>edx</code> 寄存器。<code>movsx</code>的好处是可以保留符号位，加载不同大小的数据时（比如来源是 <code>word</code>，目标是 <code>dword</code>），如果来源是负数，则填充符号位可以正确表示补码形式表示的负数。</p>
<p>从<code>var_8h[var_10h]</code>取数移入<code>edx</code> 后，之后是一句简单的 <code>xor</code>，逻辑异或运算。之后将<code>xor</code>运算结果取低位1字节（<code>dl</code>寄存器）移回<code>var_8h[var_10h]</code>。</p>
<p>之后自增，跳转循环，和之前的循环一样。将分析过的部分用伪代码表示如下。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>int</span> <span class=n>var_4h</span><span class=p>,</span> <span class=n>var_8h</span><span class=p>;</span> <span class=c1>// ebp-4h, ebp-8h
</span><span class=c1></span><span class=n>var_4h</span> <span class=o>=</span> <span class=mh>0x8</span><span class=p>;</span>
<span class=n>var_8h</span> <span class=o>=</span> <span class=n>unknown_func</span><span class=p>(</span><span class=mh>0x8</span><span class=p>);</span>

<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>var_ch</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>var_ch</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>;</span> <span class=n>var_ch</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// var_ch -&gt; ebp-ch
</span><span class=c1></span>    <span class=n>var_8h</span><span class=p>[</span><span class=n>var_ch</span><span class=p>]</span> <span class=o>=</span> <span class=mh>0x52</span> <span class=o>+</span> <span class=n>var_ch</span><span class=p>;</span>
<span class=p>}</span>

<span class=n>unknown_func</span><span class=p>(</span><span class=n>var_8h</span><span class=p>,</span> <span class=mh>0x8</span><span class=p>,</span> <span class=n>username</span><span class=p>,</span> <span class=n>username_len</span><span class=p>);</span> <span class=c1>// 猜测的函数签名 func(void*, int, void*, int)
</span><span class=c1></span><span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>var_10h</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>var_10h</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>;</span> <span class=n>var_10h</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// var_10h -&gt; ebp-10h
</span><span class=c1></span>    <span class=n>var_8h</span><span class=p>[</span><span class=n>var_10h</span><span class=p>]</span> <span class=o>^=</span> <span class=mh>0x25</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>继续看循环结束后的动作。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=err>0</span><span class=nf>x00407292</span>      <span class=no>mov</span>     <span class=no>dword</span> <span class=p>[</span><span class=no>var_14h</span><span class=p>],</span> <span class=mi>0x11</span> <span class=c>; 17
</span><span class=c></span><span class=mi>0x00407299</span>      <span class=no>mov</span>     <span class=no>dword</span> <span class=p>[</span><span class=no>esp</span><span class=p>],</span> <span class=mi>0x11</span> <span class=c>; [0x11:4]=-1 ; 17
</span><span class=c></span><span class=mi>0x004072a0</span>      <span class=no>call</span>    <span class=no>fcn.00401302</span>
<span class=err>0</span><span class=nf>x004072a5</span>      <span class=no>mov</span>     <span class=no>dword</span> <span class=p>[</span><span class=no>var_18h</span><span class=p>],</span> <span class=no>eax</span>
<span class=err>0</span><span class=nf>x004072a8</span>      <span class=no>mov</span>     <span class=no>dword</span> <span class=p>[</span><span class=no>var_1ch</span><span class=p>],</span> <span class=mi>0</span>
</code></pre></div><p>调用一个函数，返回值赋值给<code>var_18h</code>，同时初始化<code>var_1ch</code>为 0。伪代码表示如下。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>int</span> <span class=n>var_14h</span> <span class=o>=</span> <span class=mh>0x11</span><span class=p>;</span>
<span class=n>var_18h</span> <span class=o>=</span> <span class=n>unknown_func</span><span class=p>(</span><span class=mh>0x11</span><span class=p>);</span>
<span class=kt>int</span> <span class=n>var_1ch</span> <span class=o>=</span> <span class=mh>0x0</span><span class=p>;</span>
</code></pre></div><p>接下来又是一个循环。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=err>0</span><span class=nf>x004072af</span>      <span class=no>cmp</span>     <span class=no>dword</span> <span class=p>[</span><span class=no>var_1ch</span><span class=p>],</span> <span class=mi>8</span>
<span class=err>0</span><span class=nf>x004072b3</span>      <span class=no>jae</span>     <span class=mi>0x4072f2</span>
</code></pre></div><p>不重复分析，进入循环体。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=err>0</span><span class=nf>x004072b9</span>      <span class=no>mov</span>     <span class=no>eax</span><span class=p>,</span> <span class=no>dword</span> <span class=p>[</span><span class=no>var_8h</span><span class=p>]</span>
<span class=err>0</span><span class=nf>x004072bc</span>      <span class=no>mov</span>     <span class=no>ecx</span><span class=p>,</span> <span class=no>dword</span> <span class=p>[</span><span class=no>var_1ch</span><span class=p>]</span>
<span class=err>0</span><span class=nf>x004072bf</span>      <span class=no>movsx</span>   <span class=no>eax</span><span class=p>,</span> <span class=no>byte</span> <span class=p>[</span><span class=no>eax</span> <span class=err>+</span> <span class=no>ecx</span><span class=p>]</span>
<span class=err>0</span><span class=nf>x004072c3</span>      <span class=no>mov</span>     <span class=no>edx</span><span class=p>,</span> <span class=no>dword</span> <span class=p>[</span><span class=no>var_18h</span><span class=p>]</span>
<span class=err>0</span><span class=nf>x004072c6</span>      <span class=no>mov</span>     <span class=no>ecx</span><span class=p>,</span> <span class=no>dword</span> <span class=p>[</span><span class=no>var_1ch</span><span class=p>]</span>
<span class=c>; ---
</span><span class=c></span><span class=err>0</span><span class=nf>x004072c9</span>      <span class=no>shl</span>     <span class=no>ecx</span><span class=p>,</span> <span class=mi>1</span>
<span class=err>0</span><span class=nf>x004072cc</span>      <span class=no>add</span>     <span class=no>edx</span><span class=p>,</span> <span class=no>ecx</span>
<span class=c>; ---
</span><span class=c></span><span class=err>0</span><span class=nf>x004072ce</span>      <span class=no>lea</span>     <span class=no>ecx</span><span class=p>,</span> <span class=no>str.02x</span> <span class=c>; 0x45de50，内容是 %02x
</span><span class=c>; ---
</span><span class=c></span><span class=mi>0x004072d4</span>      <span class=no>mov</span>     <span class=no>dword</span> <span class=p>[</span><span class=no>esp</span><span class=p>],</span> <span class=no>edx</span>
<span class=err>0</span><span class=nf>x004072d7</span>      <span class=no>mov</span>     <span class=no>dword</span> <span class=p>[</span><span class=no>var_sp_4h</span><span class=p>],</span> <span class=no>ecx</span>
<span class=err>0</span><span class=nf>x004072db</span>      <span class=no>mov</span>     <span class=no>dword</span> <span class=p>[</span><span class=no>var_sp_8h</span><span class=p>],</span> <span class=no>eax</span>
<span class=err>0</span><span class=nf>x004072df</span>      <span class=no>call</span>    <span class=no>fcn.00403dcd</span>
<span class=c>; ---
</span><span class=c></span><span class=err>0</span><span class=nf>x004072e4</span>      <span class=no>mov</span>     <span class=no>eax</span><span class=p>,</span> <span class=no>dword</span> <span class=p>[</span><span class=no>var_1ch</span><span class=p>]</span>
<span class=err>0</span><span class=nf>x004072e7</span>      <span class=no>add</span>     <span class=no>eax</span><span class=p>,</span> <span class=mi>1</span>
<span class=err>0</span><span class=nf>x004072ea</span>      <span class=no>mov</span>     <span class=no>dword</span> <span class=p>[</span><span class=no>var_1ch</span><span class=p>],</span> <span class=no>eax</span>
<span class=err>0</span><span class=nf>x004072ed</span>      <span class=no>jmp</span>     <span class=mi>0x4072af</span>
</code></pre></div><p>依然是从 <code>var_8h[var_1ch]</code> 取数，之后把 <code>var_18h</code> 和 <code>var_1ch</code> 也取数，分别放到 <code>eax</code>、<code>edx</code>、<code>ecx</code>。</p>
<p>接着是一个没见过的命令，<code>shl</code>，学习下。</p>
<p><code>shl</code>是逻辑左移，和 c 中的 <code>&lt;&lt;</code> 运算符一样，两个操作数，命令格式<code>shl 寄存器,立即数</code>。</p>
<p>这里做的就是 <code>ecx</code>，也就是 <code>var_1ch</code> 的值左移1位，众所周知左移n位可以看作乘上2^n^ ，所以这句 <code>shl</code> 其实就是 <code>var_1ch*2</code>。左移后结果加到了<code>edx</code>，<code>edx</code>是<code>var_18h</code>。</p>
<p>之后是一个<code>lea</code>，加载地址，内容是常量字符串 <code>%02x</code>，看起来是一个 c 格式化字符串。</p>
<p>接着压栈传参，调用未知函数，结果忽略。伪代码表示如下。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=n>unknown_func</span><span class=p>(</span><span class=n>var_18h</span> <span class=o>+</span> <span class=n>var_1ch</span> <span class=o>*</span> <span class=mi>2</span><span class=p>,</span> <span class=s>&#34;%02x&#34;</span><span class=p>,</span> <span class=n>var_8h</span><span class=p>[</span><span class=n>var_1ch</span><span class=p>]);</span>
</code></pre></div><p>随后是变量自增，跳转回循环开头。</p>
<p>我们把分析出来的伪代码再合并下。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>int</span> <span class=n>var_4h</span><span class=p>,</span> <span class=n>var_8h</span><span class=p>;</span> <span class=c1>// ebp-4h, ebp-8h
</span><span class=c1></span><span class=n>var_4h</span> <span class=o>=</span> <span class=mh>0x8</span><span class=p>;</span>
<span class=n>var_8h</span> <span class=o>=</span> <span class=n>unknown_func</span><span class=p>(</span><span class=mh>0x8</span><span class=p>);</span>

<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>var_ch</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>var_ch</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>;</span> <span class=n>var_ch</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// var_ch -&gt; ebp-ch
</span><span class=c1></span>    <span class=n>var_8h</span><span class=p>[</span><span class=n>var_ch</span><span class=p>]</span> <span class=o>=</span> <span class=mh>0x52</span> <span class=o>+</span> <span class=n>var_ch</span><span class=p>;</span>
<span class=p>}</span>

<span class=n>unknown_func</span><span class=p>(</span><span class=n>var_8h</span><span class=p>,</span> <span class=mh>0x8</span><span class=p>,</span> <span class=n>username</span><span class=p>,</span> <span class=n>username_len</span><span class=p>);</span> <span class=c1>// 猜测的函数签名 func(void*, int, void*, int)
</span><span class=c1></span><span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>var_10h</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>var_10h</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>;</span> <span class=n>var_10h</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// var_10h -&gt; ebp-10h
</span><span class=c1></span>    <span class=n>var_8h</span><span class=p>[</span><span class=n>var_10h</span><span class=p>]</span> <span class=o>^=</span> <span class=mh>0x25</span><span class=p>;</span>
<span class=p>}</span>

<span class=kt>int</span> <span class=n>var_14h</span> <span class=o>=</span> <span class=mh>0x11</span><span class=p>;</span>
<span class=n>var_18h</span> <span class=o>=</span> <span class=n>unknown_func</span><span class=p>(</span><span class=mh>0x11</span><span class=p>);</span>
<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>var_1ch</span> <span class=o>=</span> <span class=mh>0x0</span><span class=p>;</span> <span class=n>var_1ch</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>;</span> <span class=n>var_1ch</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>unknown_func</span><span class=p>(</span><span class=n>var_18h</span> <span class=o>+</span> <span class=n>var_1ch</span> <span class=o>*</span> <span class=mi>2</span><span class=p>,</span> <span class=s>&#34;%02x&#34;</span><span class=p>,</span> <span class=n>var_8h</span><span class=p>[</span><span class=n>var_1ch</span><span class=p>]);</span>
<span class=p>}</span>
</code></pre></div><p>最后是循环结束后的代码。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=err>0</span><span class=nf>x004072f2</span>      <span class=no>mov</span>     <span class=no>eax</span><span class=p>,</span> <span class=no>dword</span> <span class=p>[</span><span class=no>var_18h</span><span class=p>]</span>
<span class=err>0</span><span class=nf>x004072f5</span>      <span class=no>mov</span>     <span class=no>byte</span> <span class=p>[</span><span class=no>eax</span> <span class=err>+</span> <span class=mi>0x10</span><span class=p>],</span> <span class=mi>0</span>
<span class=c>; ---
</span><span class=c></span><span class=err>0</span><span class=nf>x004072f9</span>      <span class=no>mov</span>     <span class=no>eax</span><span class=p>,</span> <span class=no>dword</span> <span class=p>[</span><span class=no>var_8h</span><span class=p>]</span>
<span class=err>0</span><span class=nf>x004072fc</span>      <span class=no>mov</span>     <span class=no>dword</span> <span class=p>[</span><span class=no>esp</span><span class=p>],</span> <span class=no>eax</span>
<span class=err>0</span><span class=nf>x004072ff</span>      <span class=no>call</span>    <span class=no>fcn.00402a36</span>
<span class=c>; ---
</span><span class=c></span><span class=err>0</span><span class=nf>x00407304</span>      <span class=no>mov</span>     <span class=no>eax</span><span class=p>,</span> <span class=no>dword</span> <span class=p>[</span><span class=no>var_18h</span><span class=p>]</span>
<span class=c>; ---
</span><span class=c></span><span class=err>0</span><span class=nf>x00407307</span>      <span class=no>add</span>     <span class=no>esp</span><span class=p>,</span> <span class=mi>0x2c</span>
<span class=err>0</span><span class=nf>x0040730a</span>      <span class=no>pop</span>     <span class=no>ebp</span>
<span class=err>0</span><span class=nf>x0040730b</span>      <span class=no>ret</span>
</code></pre></div><p>首先是把<code>var_18h[0x10]</code> 的值设为0。</p>
<p>接着<code>var_8h</code>做参数调未知函数。</p>
<p>把<code>var_18h</code>移到<code>eax</code>，也就是<code>cdecl</code>约定下的返回值位置。</p>
<p>最后平栈，恢复<code>ebp</code>，返回，函数结束。我们把所有内容的伪代码合并起来。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>int</span> <span class=n>var_4h</span> <span class=o>=</span> <span class=mh>0x8</span><span class=p>;</span> <span class=c1>// ebp-4h
</span><span class=c1></span><span class=kt>void</span><span class=o>*</span> <span class=n>var_8h</span> <span class=o>=</span> <span class=n>unknown_func</span><span class=p>(</span><span class=mh>0x8</span><span class=p>);</span> <span class=c1>// ebp-8h
</span><span class=c1></span>
<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>var_ch</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>var_ch</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>;</span> <span class=n>var_ch</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// var_ch -&gt; ebp-ch
</span><span class=c1></span>    <span class=n>var_8h</span><span class=p>[</span><span class=n>var_ch</span><span class=p>]</span> <span class=o>=</span> <span class=mh>0x52</span> <span class=o>+</span> <span class=n>var_ch</span><span class=p>;</span>
<span class=p>}</span>

<span class=n>unknown_func</span><span class=p>(</span><span class=n>var_8h</span><span class=p>,</span> <span class=mh>0x8</span><span class=p>,</span> <span class=n>username</span><span class=p>,</span> <span class=n>username_len</span><span class=p>);</span> <span class=c1>// 猜测的函数签名 func(void*, int, void*, int)
</span><span class=c1></span><span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>var_10h</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>var_10h</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>;</span> <span class=n>var_10h</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// var_10h -&gt; ebp-10h
</span><span class=c1></span>    <span class=n>var_8h</span><span class=p>[</span><span class=n>var_10h</span><span class=p>]</span> <span class=o>^=</span> <span class=mh>0x25</span><span class=p>;</span>
<span class=p>}</span>

<span class=kt>int</span> <span class=n>var_14h</span> <span class=o>=</span> <span class=mh>0x11</span><span class=p>;</span>
<span class=n>var_18h</span> <span class=o>=</span> <span class=n>unknown_func</span><span class=p>(</span><span class=mh>0x11</span><span class=p>);</span>
<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>var_1ch</span> <span class=o>=</span> <span class=mh>0x0</span><span class=p>;</span> <span class=n>var_1ch</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>;</span> <span class=n>var_1ch</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>unknown_func</span><span class=p>(</span><span class=n>var_18h</span> <span class=o>+</span> <span class=n>var_1ch</span> <span class=o>*</span> <span class=mi>2</span><span class=p>,</span> <span class=s>&#34;%02x&#34;</span><span class=p>,</span> <span class=n>var_8h</span><span class=p>[</span><span class=n>var_1ch</span><span class=p>]);</span>
<span class=p>}</span>
<span class=n>var_18h</span><span class=p>[</span><span class=mh>0x10</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>

<span class=n>unknown_func</span><span class=p>(</span><span class=n>var_8h</span><span class=p>);</span>
<span class=k>return</span> <span class=n>var_18h</span><span class=p>;</span>
</code></pre></div><p>从这我们已经能看出具体算法了，未知函数可以猜测调试看看。</p>
<h2 id=0x04-调试器---easy>0x04 调试器 - easy</h2>
<p>调试的目标是确认生成序列号的算法，把分析出的伪代码中还不清楚用途的未知函数，分析出作用。</p>
<h3 id=41-x32dbg>4.1 x32dbg</h3>
<p>打开调试器后，先找到关键跳，在工具栏点击字符串工具图标，在下方搜索栏输入<code>wrong pwd!</code></p>
<p><img src=/blog/image/crackme-02/cm02-easy-15.png alt=image-20210915140718400></p>
<p>跳到引用位置。</p>
<p><img src=/blog/image/crackme-02/cm02-easy-18.png alt=image-20210915111455604></p>
<p><img src=/blog/image/crackme-02/cm02-easy-19.png alt=image-20210915111621678></p>
<p>之后可以按g，进入控制流视图，不过这个控制流视图有点不好看，我们也可以直接参考静态分析中的汇编，直接找到函数，并在入口下断点。</p>
<p><img src=/blog/image/crackme-02/cm02-easy-20.png alt=image-20210915112358449></p>
<p>尝试随便输入一点内容，调试器命中。</p>
<p><img src=/blog/image/crackme-02/cm02-easy-21.png alt=image-20210915112552389></p>
<p>接下来就可以用左上角的单步调试了。</p>
<p><img src=/blog/image/crackme-02/cm02-easy-22.png alt=image-20210915140939909></p>
<p>不做更多介绍，汇编的分析已经进行过一次。这次我们找到对输入 &ldquo;abc&rdquo; 的正确序列号，完成一次解密。</p>
<p>只需要在断点处点击<img src=/blog/image/crackme-02/cm02-easy-23.png alt=image-20210915141120060>按钮，然后观察<code>eax</code>寄存器。</p>
<p><img src=/blog/image/crackme-02/cm02-easy-24.png alt=image-20210915141405302></p>
<p>抄出来（居然不能右键复制后面的字符串），内容是<code>4447467073727d7c</code>。</p>
<p>接着继续运行，再把抄出来的答案复制进去看看。</p>
<p><img src=/blog/image/crackme-02/cm02-easy-25.png alt=image-20210915141838395></p>
<p>到这里，我们拿到了一个可以用的序列号。</p>
<h2 id=0x05-注册机>0x05 注册机</h2>
<h3 id=51-python-脚本注册机>5.1 Python 脚本注册机</h3>
<p>先把前面的伪代码贴一下。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>int</span> <span class=n>var_4h</span> <span class=o>=</span> <span class=mh>0x8</span><span class=p>;</span> <span class=c1>// ebp-4h
</span><span class=c1></span><span class=kt>void</span><span class=o>*</span> <span class=n>var_8h</span> <span class=o>=</span> <span class=n>unknown_func</span><span class=p>(</span><span class=mh>0x8</span><span class=p>);</span> <span class=c1>// ebp-8h
</span><span class=c1></span>
<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>var_ch</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>var_ch</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>;</span> <span class=n>var_ch</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// var_ch -&gt; ebp-ch
</span><span class=c1></span>    <span class=n>var_8h</span><span class=p>[</span><span class=n>var_ch</span><span class=p>]</span> <span class=o>=</span> <span class=mh>0x52</span> <span class=o>+</span> <span class=n>var_ch</span><span class=p>;</span>
<span class=p>}</span>

<span class=n>unknown_func</span><span class=p>(</span><span class=n>var_8h</span><span class=p>,</span> <span class=mh>0x8</span><span class=p>,</span> <span class=n>username</span><span class=p>,</span> <span class=n>username_len</span><span class=p>);</span> <span class=c1>// 猜测的函数签名 func(void*, int, void*, int)
</span><span class=c1></span><span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>var_10h</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>var_10h</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>;</span> <span class=n>var_10h</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// var_10h -&gt; ebp-10h
</span><span class=c1></span>    <span class=n>var_8h</span><span class=p>[</span><span class=n>var_10h</span><span class=p>]</span> <span class=o>^=</span> <span class=mh>0x25</span><span class=p>;</span>
<span class=p>}</span>

<span class=kt>int</span> <span class=n>var_14h</span> <span class=o>=</span> <span class=mh>0x11</span><span class=p>;</span>
<span class=n>var_18h</span> <span class=o>=</span> <span class=n>unknown_func</span><span class=p>(</span><span class=mh>0x11</span><span class=p>);</span>
<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>var_1ch</span> <span class=o>=</span> <span class=mh>0x0</span><span class=p>;</span> <span class=n>var_1ch</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>;</span> <span class=n>var_1ch</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>unknown_func</span><span class=p>(</span><span class=n>var_18h</span> <span class=o>+</span> <span class=n>var_1ch</span> <span class=o>*</span> <span class=mi>2</span><span class=p>,</span> <span class=s>&#34;%02x&#34;</span><span class=p>,</span> <span class=n>var_8h</span><span class=p>[</span><span class=n>var_1ch</span><span class=p>]);</span>
<span class=p>}</span>
<span class=n>var_18h</span><span class=p>[</span><span class=mh>0x10</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>

<span class=n>unknown_func</span><span class=p>(</span><span class=n>var_8h</span><span class=p>);</span>
<span class=k>return</span> <span class=n>var_18h</span><span class=p>;</span>
</code></pre></div><p>里面的未知函数（失策，clang默认静态链接了libcmt，很多库函数在x32dbg里认不出来）猜一猜吧。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=n>username</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s1>&#39;username:&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>
<span class=n>username_len</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>username</span><span class=p>)</span>

<span class=n>var_4h</span> <span class=o>=</span> <span class=mi>8</span>
<span class=n>var_8h</span> <span class=o>=</span> <span class=nb>bytearray</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span>

<span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>8</span><span class=p>):</span>
    <span class=n>var_8h</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mh>0x52</span> <span class=o>+</span> <span class=n>i</span>

<span class=c1># 这里的未知函数通过调试器可以看出，把入参复制到了 var_8h 里</span>
<span class=n>var_8h</span><span class=p>[:</span><span class=n>username_len</span><span class=p>]</span> <span class=o>=</span> <span class=n>username</span>

<span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>8</span><span class=p>):</span>
    <span class=n>var_8h</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>^=</span> <span class=mh>0x25</span>

<span class=c1># for(int var_1ch = 0x0; var_1ch &lt; 8; var_1ch++) {</span>
<span class=c1>#     unknown_func(var_18h + var_1ch * 2, &#34;%02x&#34;, var_8h[var_1ch]);</span>
<span class=c1># }</span>
<span class=c1>#</span>
<span class=c1># 最后的那个循环中，函数判断为 sprintf 或其他啥，格式化明确是2位小写16进制数</span>
<span class=c1># 前面的计算看作是算偏移，一个 var_8h 的字节对应 2 字节16进制表示，所以 var_18h 加上 NUL 一共是 0x11 也就是 17 个字节</span>
<span class=c1># 循环的作用是把 var_8h 这个字节数组转换成16进制表示的字符串。</span>
<span class=c1>#</span>
<span class=c1># 在 python 里用 hex() 就行了。</span>
<span class=nb>print</span><span class=p>(</span><span class=n>var_8h</span><span class=o>.</span><span class=n>hex</span><span class=p>())</span>
</code></pre></div><p>运行脚本，输入<code>abc</code>，输出<code>4447467073727d7c</code>，确认注册机可以生成序列号。</p>
<h2 id=0x06-修改-exe>0x06 修改 exe</h2>
<h3 id=61-x32dbg-修改关键跳>6.1 x32dbg 修改关键跳</h3>
<p>用调试器打开后找到决定serial是否正确的关键跳转，右键二进制选择用NOP填充，确认即可。</p>
<p><img src=/blog/image/crackme-02/cm02-easy-26.png alt=image-20210915150907420></p>
<p>修改后效果如图。</p>
<p><img src=/blog/image/crackme-02/cm02-easy-27.png alt=image-20210915150953046></p>
<p>接着把修改后的exe保存下来，在文件菜单里选择补丁。</p>
<p><img src=/blog/image/crackme-02/cm02-easy-28.png alt=image-20210915151220354></p>
<p>全选，点修补文件，选择路径保存。</p>
<p><img src=/blog/image/crackme-02/cm02-easy-29.png alt=image-20210915151322628></p>
<p>我保存在<code>cm02-easy-patched.exe</code>，接着我们试试运行。</p>
<p><img src=/blog/image/crackme-02/cm02-easy-30.png alt=image-20210915151903611></p>
<p>遗憾的是被x32dbg补丁功能导出的文件需要管理员权限运行，为了能截到图，图中用了名为<code>sudo</code>的工具命令，可以用<code>scoop install sudo</code>来安装<code>sudo</code>，点击去<a class=link href=https://scoop.sh target=_blank rel=noopener>scoop首页</a>。</p>
<h3 id=62-反编译器修改关键跳>6.2 反编译器修改关键跳</h3>
<p>以Cutter为例，找到<code>jne</code>指令后，右键修改为<code>nop</code>即可。记得先备份。</p>
<p><img src=/blog/image/crackme-02/cm02-easy-31.png alt=image-20210915152428449></p>
<p><img src=/blog/image/crackme-02/cm02-easy-32.png alt=image-20210915152609774></p>
<p>修改后也能实现和x32导出一样的效果，而且不用管理员权限。</p>
<h2 id=结论>结论</h2>
<p>总得有个结论。</p>
<p>这次逆向应该能帮助学到下面的东西：</p>
<ul>
<li>栈帧结构和函数调用</li>
<li><code>cmp</code>指令</li>
<li><code>jne</code>、<code>jbe</code>、<code>jnz</code>、<code>jae</code>指令</li>
<li><code>movsx</code>指令</li>
<li><code>shl</code>指令</li>
</ul>
<p>库函数因为静态链接的缘故已经变成了文中的未知函数，造成了分析上的障碍。老实说如果不是自己写的源码，能不能这么顺利逆向出注册机还真不好说。</p>
<p>开启优化的 <em>normal</em> 和 <em>hard</em> 难度就不进一步分析了，有兴趣可以看看。</p>
</section>
<footer class=article-footer>
<section class=article-tags>
<a href=/blog/tags/%E6%B1%87%E7%BC%96/>汇编</a>
<a href=/blog/tags/%E9%80%86%E5%90%91/>逆向</a>
</section>
<section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
</footer>
</article>
<aside class=related-contents--wrapper>
<h2 class=section-title>相关文章</h2>
<div class=related-contents>
<div class="flex article-list--tile">
<article>
<a href=/blog/p/learning-packer-04-zlib-compression-packer-demo/>
<div class=article-details>
<h2 class=article-title>加壳原理04 - zlib压缩壳案例</h2>
</div>
</a>
</article>
<article>
<a href=/blog/p/learning-packer-03-support-no-relocations/>
<div class=article-details>
<h2 class=article-title>加壳原理03 - 支持没有重定位的程序</h2>
</div>
</a>
</article>
<article>
<a href=/blog/p/find-kernel32-in-memory/>
<div class=article-details>
<h2 class=article-title>关于在内存里找kernel32这件事</h2>
</div>
</a>
</article>
<article>
<a href=/blog/p/learning-packer-02/>
<div class=article-details>
<h2 class=article-title>加壳原理02 - 简单加壳机</h2>
</div>
</a>
</article>
<article>
<a href=/blog/p/learning-packer-01-windows-program-load-and-execution/>
<div class=article-details>
<h2 class=article-title>加壳原理01 - Windows 程序的加载和运行</h2>
</div>
</a>
</article>
</div>
</div>
</aside>
<footer class=site-footer>
<section class=copyright>
&copy;
2021 weakptr's 笔记
</section>
<section class=powerby>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.1.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a>
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main>
<aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div>
<h2 class="widget-title section-title">目录</h2>
<div class=widget--toc>
<nav id=TableOfContents>
<ol>
<li><a href=#得有个前言>得有个前言</a></li>
<li><a href=#0x01-源码>0x01 源码</a></li>
<li><a href=#0x02-观察>0x02 观察</a></li>
<li><a href=#0x03-静态分析---easy>0x03 静态分析 - easy</a>
<ol>
<li><a href=#31-主循环>3.1 主循环</a></li>
<li><a href=#32-生成序列号>3.2 生成序列号</a></li>
</ol>
</li>
<li><a href=#0x04-调试器---easy>0x04 调试器 - easy</a>
<ol>
<li><a href=#41-x32dbg>4.1 x32dbg</a></li>
</ol>
</li>
<li><a href=#0x05-注册机>0x05 注册机</a>
<ol>
<li><a href=#51-python-脚本注册机>5.1 Python 脚本注册机</a></li>
</ol>
</li>
<li><a href=#0x06-修改-exe>0x06 修改 exe</a>
<ol>
<li><a href=#61-x32dbg-修改关键跳>6.1 x32dbg 修改关键跳</a></li>
<li><a href=#62-反编译器修改关键跳>6.2 反编译器修改关键跳</a></li>
</ol>
</li>
<li><a href=#结论>结论</a></li>
</ol>
</nav>
</div>
</section>
</aside>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=/blog/ts/main.js defer></script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>