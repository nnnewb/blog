<!doctype html><html lang=zh-cn dir=ltr>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="å‰è¨€ æ€»å¾—æœ‰ä¸ªå‰è¨€ã€‚
ç”¨ nasm æ‰‹å·¥æ‰“é€ äº†ä¸€ä¸ª PE æ–‡ä»¶åï¼Œè¿™ä¸ª PE æ–‡ä»¶è¿˜æ²¡ä»€ä¹ˆåµç”¨ã€‚å¦‚æœè¦åŠ¨ IATï¼Œåˆå«Œéº»çƒ¦ã€‚ç½‘ä¸Šå†²æµªæ‰¾åˆ°ä¸€ç¯‡å…³äº shellcode çš„æ–‡ç« ï¼Œè®²å¦‚ä½•åœ¨å†…å­˜é‡Œæ‰¾åˆ° kernel32.dll å¹¶è°ƒç”¨ WinExec å‡½æ•°ï¼Œäºæ˜¯å°±æƒ³å®è·µä¸€ä¸‹çœ‹çœ‹ï¼Œå®é™…æŠ„ä»£ç ç¢°åˆ°ä¸å°‘å‘ã€‚å¯¹æ±‡ç¼–åˆç†Ÿæ‚‰äº†ä¸€ç‚¹ã€‚
0x01 å¯»æ‰¾ kernel32 å¾®è½¯æœ‰ä¸€ç¯‡å¾ˆç®€çŸ­çš„æ–‡ç« ã€‚
 The Thread Environment Block (TEB structure) holds context information for a thread.
In the following versions of Windows, the offset of the 32-bit TEB address within the 64-bit TEB is 0. This can be used to directly access the 32-bit TEB of a WOW64 thread. This might change in later versions of Windows"><title>å…³äºåœ¨å†…å­˜é‡Œæ‰¾kernel32è¿™ä»¶äº‹</title>
<link rel=canonical href=https://nnnewb.github.io/blog/p/find-kernel32-in-memory/>
<link rel=stylesheet href=/blog/scss/style.min.b80bf249ce4a22cf55e8d7340a0b37a2f2c10f54f3a9a49cb94b694a2eb0bbea.css><meta property="og:title" content="å…³äºåœ¨å†…å­˜é‡Œæ‰¾kernel32è¿™ä»¶äº‹">
<meta property="og:description" content="å‰è¨€ æ€»å¾—æœ‰ä¸ªå‰è¨€ã€‚
ç”¨ nasm æ‰‹å·¥æ‰“é€ äº†ä¸€ä¸ª PE æ–‡ä»¶åï¼Œè¿™ä¸ª PE æ–‡ä»¶è¿˜æ²¡ä»€ä¹ˆåµç”¨ã€‚å¦‚æœè¦åŠ¨ IATï¼Œåˆå«Œéº»çƒ¦ã€‚ç½‘ä¸Šå†²æµªæ‰¾åˆ°ä¸€ç¯‡å…³äº shellcode çš„æ–‡ç« ï¼Œè®²å¦‚ä½•åœ¨å†…å­˜é‡Œæ‰¾åˆ° kernel32.dll å¹¶è°ƒç”¨ WinExec å‡½æ•°ï¼Œäºæ˜¯å°±æƒ³å®è·µä¸€ä¸‹çœ‹çœ‹ï¼Œå®é™…æŠ„ä»£ç ç¢°åˆ°ä¸å°‘å‘ã€‚å¯¹æ±‡ç¼–åˆç†Ÿæ‚‰äº†ä¸€ç‚¹ã€‚
0x01 å¯»æ‰¾ kernel32 å¾®è½¯æœ‰ä¸€ç¯‡å¾ˆç®€çŸ­çš„æ–‡ç« ã€‚
 The Thread Environment Block (TEB structure) holds context information for a thread.
In the following versions of Windows, the offset of the 32-bit TEB address within the 64-bit TEB is 0. This can be used to directly access the 32-bit TEB of a WOW64 thread. This might change in later versions of Windows">
<meta property="og:url" content="https://nnnewb.github.io/blog/p/find-kernel32-in-memory/">
<meta property="og:site_name" content="weakptr's ç¬”è®°">
<meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="æ±‡ç¼–"><meta property="article:tag" content="é€†å‘"><meta property="article:tag" content="Windows"><meta property="article:published_time" content="2021-10-14T16:31:00+08:00"><meta property="article:modified_time" content="2021-10-14T16:31:00+08:00">
<meta name=twitter:title content="å…³äºåœ¨å†…å­˜é‡Œæ‰¾kernel32è¿™ä»¶äº‹">
<meta name=twitter:description content="å‰è¨€ æ€»å¾—æœ‰ä¸ªå‰è¨€ã€‚
ç”¨ nasm æ‰‹å·¥æ‰“é€ äº†ä¸€ä¸ª PE æ–‡ä»¶åï¼Œè¿™ä¸ª PE æ–‡ä»¶è¿˜æ²¡ä»€ä¹ˆåµç”¨ã€‚å¦‚æœè¦åŠ¨ IATï¼Œåˆå«Œéº»çƒ¦ã€‚ç½‘ä¸Šå†²æµªæ‰¾åˆ°ä¸€ç¯‡å…³äº shellcode çš„æ–‡ç« ï¼Œè®²å¦‚ä½•åœ¨å†…å­˜é‡Œæ‰¾åˆ° kernel32.dll å¹¶è°ƒç”¨ WinExec å‡½æ•°ï¼Œäºæ˜¯å°±æƒ³å®è·µä¸€ä¸‹çœ‹çœ‹ï¼Œå®é™…æŠ„ä»£ç ç¢°åˆ°ä¸å°‘å‘ã€‚å¯¹æ±‡ç¼–åˆç†Ÿæ‚‰äº†ä¸€ç‚¹ã€‚
0x01 å¯»æ‰¾ kernel32 å¾®è½¯æœ‰ä¸€ç¯‡å¾ˆç®€çŸ­çš„æ–‡ç« ã€‚
 The Thread Environment Block (TEB structure) holds context information for a thread.
In the following versions of Windows, the offset of the 32-bit TEB address within the 64-bit TEB is 0. This can be used to directly access the 32-bit TEB of a WOW64 thread. This might change in later versions of Windows">
</head>
<body class=article-page>
<script>(function(){const a='StackColorScheme';localStorage.getItem(a)||localStorage.setItem(a,"dark")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky">
<button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box>
<span class=hamburger-inner></span>
</span>
</button>
<header>
<figure class=site-avatar>
<a href=/blog>
<img src=/blog/img/avatar_hub37949326d1692892aa1e64434c0dda6_382115_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a>
<span class=emoji>ğŸ‘</span>
</figure>
<div class=site-meta>
<h1 class=site-name><a href=/blog>weakptr's ç¬”è®°</a></h1>
<h2 class=site-description>å¼ƒèˆ¹ï¼</h2>
</div>
</header><ol class=menu id=main-menu>
<li>
<a href=/blog><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>é¦–é¡µ</span>
</a>
</li>
<li>
<a href=/blog/about><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>å…³äºæˆ‘</span>
</a>
</li>
<li>
<a href=/blog/archive><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>å½’æ¡£</span>
</a>
</li>
<li>
<a href=/blog/categories><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
<span>åˆ†ç±»</span>
</a>
</li>
<div class=menu-bottom-section>
<li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>æš—è‰²æ¨¡å¼</span>
</li>
</div>
</ol>
</aside>
<main class="main full-width">
<article class=main-article>
<header class=article-header>
<div class=article-details>
<header class=article-category>
<a href=/blog/categories/%E9%80%86%E5%90%91/>
é€†å‘
</a>
</header>
<div class=article-title-wrapper>
<h2 class=article-title>
<a href=/blog/p/find-kernel32-in-memory/>å…³äºåœ¨å†…å­˜é‡Œæ‰¾kernel32è¿™ä»¶äº‹</a>
</h2>
</div>
<footer class=article-time>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2021å¹´ 10æœˆ 14æ—¥</time>
</div>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>
é˜…è¯»æ—¶é•¿: 12 åˆ†é’Ÿ
</time>
</div>
</footer>
</div>
</header>
<section class=article-content>
<h2 id=å‰è¨€>å‰è¨€</h2>
<p>æ€»å¾—æœ‰ä¸ªå‰è¨€ã€‚</p>
<p>ç”¨ nasm æ‰‹å·¥æ‰“é€ äº†ä¸€ä¸ª PE æ–‡ä»¶åï¼Œè¿™ä¸ª PE æ–‡ä»¶è¿˜æ²¡ä»€ä¹ˆåµç”¨ã€‚å¦‚æœè¦åŠ¨ IATï¼Œåˆå«Œéº»çƒ¦ã€‚ç½‘ä¸Šå†²æµªæ‰¾åˆ°<a class=link href=https://www.ired.team/offensive-security/code-injection-process-injection/finding-kernel32-base-and-function-addresses-in-shellcode#finding-kernel32-base-address target=_blank rel=noopener>ä¸€ç¯‡å…³äº shellcode çš„æ–‡ç« </a>ï¼Œè®²å¦‚ä½•åœ¨å†…å­˜é‡Œæ‰¾åˆ° kernel32.dll å¹¶è°ƒç”¨ WinExec å‡½æ•°ï¼Œäºæ˜¯å°±æƒ³å®è·µä¸€ä¸‹çœ‹çœ‹ï¼Œå®é™…æŠ„ä»£ç ç¢°åˆ°ä¸å°‘å‘ã€‚å¯¹æ±‡ç¼–åˆç†Ÿæ‚‰äº†ä¸€ç‚¹ã€‚</p>
<h2 id=0x01-å¯»æ‰¾-kernel32>0x01 å¯»æ‰¾ kernel32</h2>
<p>å¾®è½¯æœ‰ä¸€ç¯‡å¾ˆ<a class=link href=https://docs.microsoft.com/en-us/windows/win32/debug/thread-environment-block--debugging-notes- target=_blank rel=noopener>ç®€çŸ­çš„æ–‡ç« </a>ã€‚</p>
<blockquote>
<p>The Thread Environment Block (<a class=link href=https://docs.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-teb target=_blank rel=noopener><strong>TEB structure</strong></a>) holds context information for a thread.</p>
<p>In the following versions of Windows, the offset of the 32-bit TEB address within the 64-bit TEB is 0. This can be used to directly access the 32-bit TEB of a WOW64 thread. This might change in later versions of Windows</p>
</blockquote>
<p>å¦å¤–åœ¨<a class=link href=https://en.wikipedia.org/wiki/Win32_Thread_Information_Block target=_blank rel=noopener>ç»´åŸºç™¾ç§‘é¡µé¢</a>ä¹Ÿæœ‰ä¸€ç‚¹æ¦‚è¿°ï¼Œ<em>TIB</em> å°±æ˜¯ <em>TEB</em> ã€‚<em>TIB</em> å…¨ç§°æ˜¯ <em>Thread Information Block</em> ï¼Œ<em>TEB</em> æ˜¯ <em>Thread Environment Block</em> ã€‚</p>
<p>å…³äº <em>TIB</em> å’Œ <em>TEB</em> çš„å¾®è½¯å®˜æ–¹æ–‡æ¡£å’Œæ–‡ç« é“¾æ¥å¾ˆå¤šéƒ½å¤±æ•ˆäº†ï¼Œèƒ½æ‰¾åˆ°çš„ç›¸å…³ä¿¡æ¯ä¸å¤šã€‚ä½†æ˜¯å¾®è½¯è‡³å°‘è¿˜<a class=link href=https://docs.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-teb target=_blank rel=noopener>ç»™å‡ºäº† TEB çš„ç»“æ„å®šä¹‰</a>å§ï¼ˆåœ¨Windows SDK é‡Œï¼‰ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=k>typedef</span> <span class=k>struct</span> <span class=nc>_TEB</span> <span class=p>{</span>
  <span class=n>PVOID</span> <span class=n>Reserved1</span><span class=p>[</span><span class=mi>12</span><span class=p>];</span>
  <span class=n>PPEB</span>  <span class=n>ProcessEnvironmentBlock</span><span class=p>;</span>
  <span class=n>PVOID</span> <span class=n>Reserved2</span><span class=p>[</span><span class=mi>399</span><span class=p>];</span>
  <span class=n>BYTE</span>  <span class=n>Reserved3</span><span class=p>[</span><span class=mi>1952</span><span class=p>];</span>
  <span class=n>PVOID</span> <span class=n>TlsSlots</span><span class=p>[</span><span class=mi>64</span><span class=p>];</span>
  <span class=n>BYTE</span>  <span class=n>Reserved4</span><span class=p>[</span><span class=mi>8</span><span class=p>];</span>
  <span class=n>PVOID</span> <span class=n>Reserved5</span><span class=p>[</span><span class=mi>26</span><span class=p>];</span>
  <span class=n>PVOID</span> <span class=n>ReservedForOle</span><span class=p>;</span>
  <span class=n>PVOID</span> <span class=n>Reserved6</span><span class=p>[</span><span class=mi>4</span><span class=p>];</span>
  <span class=n>PVOID</span> <span class=n>TlsExpansionSlots</span><span class=p>;</span>
<span class=p>}</span> <span class=n>TEB</span><span class=p>,</span> <span class=o>*</span><span class=n>PTEB</span><span class=p>;</span>
</code></pre></div><p>å¤§é‡çš„åˆºçœ¼çš„ <code>Reserved</code> ã€‚ä¸è¿‡è¿˜å¥½ï¼ŒèŠ±äº†ç‚¹æ—¶é—´è¿˜æ˜¯è°·æ­Œå‡ºäº†æ‰€è°“çš„<code>Undocumented</code>çš„ç›¸å…³ä¿¡æ¯ã€‚<a class=link href="http://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented%20Functions%2FNT%20Objects%2FThread%2FTEB.html" target=_blank rel=noopener>NTAPI Undocumented Function</a>ã€‚ä¹Ÿå¯ä»¥åƒæˆ‘çœ‹çš„é‚£ç¯‡æ–‡ç« ä¸€æ ·ï¼Œç”¨ <code>WinDbg Preview</code> å»å®é™…çœ‹çœ‹å†…å­˜é‡Œçš„ç»“æ„ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=k>typedef</span> <span class=k>struct</span> <span class=nc>_TEB</span> <span class=p>{</span>
  <span class=n>NT_TIB</span>                  <span class=n>Tib</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>EnvironmentPointer</span><span class=p>;</span>
  <span class=n>CLIENT_ID</span>               <span class=n>Cid</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>ActiveRpcInfo</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>ThreadLocalStoragePointer</span><span class=p>;</span>
  <span class=n>PPEB</span>                    <span class=n>Peb</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>LastErrorValue</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>CountOfOwnedCriticalSections</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>CsrClientThread</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>Win32ThreadInfo</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>Win32ClientInfo</span><span class=p>[</span><span class=mh>0x1F</span><span class=p>];</span>
  <span class=n>PVOID</span>                   <span class=n>WOW32Reserved</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>CurrentLocale</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>FpSoftwareStatusRegister</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>SystemReserved1</span><span class=p>[</span><span class=mh>0x36</span><span class=p>];</span>
  <span class=n>PVOID</span>                   <span class=n>Spare1</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>ExceptionCode</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>SpareBytes1</span><span class=p>[</span><span class=mh>0x28</span><span class=p>];</span>
  <span class=n>PVOID</span>                   <span class=n>SystemReserved2</span><span class=p>[</span><span class=mh>0xA</span><span class=p>];</span>
  <span class=n>ULONG</span>                   <span class=n>GdiRgn</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>GdiPen</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>GdiBrush</span><span class=p>;</span>
  <span class=n>CLIENT_ID</span>               <span class=n>RealClientId</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>GdiCachedProcessHandle</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>GdiClientPID</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>GdiClientTID</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>GdiThreadLocaleInfo</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>UserReserved</span><span class=p>[</span><span class=mi>5</span><span class=p>];</span>
  <span class=n>PVOID</span>                   <span class=n>GlDispatchTable</span><span class=p>[</span><span class=mh>0x118</span><span class=p>];</span>
  <span class=n>ULONG</span>                   <span class=n>GlReserved1</span><span class=p>[</span><span class=mh>0x1A</span><span class=p>];</span>
  <span class=n>PVOID</span>                   <span class=n>GlReserved2</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>GlSectionInfo</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>GlSection</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>GlTable</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>GlCurrentRC</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>GlContext</span><span class=p>;</span>
  <span class=n>NTSTATUS</span>                <span class=n>LastStatusValue</span><span class=p>;</span>
  <span class=n>UNICODE_STRING</span>          <span class=n>StaticUnicodeString</span><span class=p>;</span>
  <span class=n>WCHAR</span>                   <span class=n>StaticUnicodeBuffer</span><span class=p>[</span><span class=mh>0x105</span><span class=p>];</span>
  <span class=n>PVOID</span>                   <span class=n>DeallocationStack</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>TlsSlots</span><span class=p>[</span><span class=mh>0x40</span><span class=p>];</span>
  <span class=n>LIST_ENTRY</span>              <span class=n>TlsLinks</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>Vdm</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>ReservedForNtRpc</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>DbgSsReserved</span><span class=p>[</span><span class=mh>0x2</span><span class=p>];</span>
  <span class=n>ULONG</span>                   <span class=n>HardErrorDisabled</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>Instrumentation</span><span class=p>[</span><span class=mh>0x10</span><span class=p>];</span>
  <span class=n>PVOID</span>                   <span class=n>WinSockData</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>GdiBatchCount</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>Spare2</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>Spare3</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>Spare4</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>ReservedForOle</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>WaitingOnLoaderLock</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>StackCommit</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>StackCommitMax</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>StackReserved</span><span class=p>;</span>
<span class=p>}</span> <span class=n>TEB</span><span class=p>,</span> <span class=o>*</span><span class=n>PTEB</span><span class=p>;</span>
</code></pre></div><p>ä¸è¿‡ä¾ç„¶æ²¡ä»€ä¹ˆåµç”¨ï¼Œå› ä¸ºåœ¨ä¹çš„åªæœ‰ PPEB è¿™ä¸ªå­—æ®µã€‚å¥½å§ï¼Œç‚¹åˆ°ä¸ºæ­¢ã€‚</p>
<p>åœ¨é‚£ç¯‡æ–‡ç« çš„åŸæ–‡é‡Œï¼Œç»™å‡ºçš„æ‰¾åˆ° kernel32.dll çš„æŸ¥æ‰¾è·¯å¾„æ˜¯è¿™æ ·çš„ï¼š<code>TEB->PEB->Ldr->InMemoryOrderLoadList->currentProgram->ntdll->kernel32.BaseDll</code></p>
<h3 id=11--process-environment-block>1.1 Process Environment Block</h3>
<p>ä» TEB å‡ºå‘ï¼Œæ‰¾åˆ° PEB <code>(12*sizeof PVOID)==48==0x30</code> ã€‚PEB çš„ç»“æ„å¦‚ä¸‹ï¼Œæ–‡æ¡£å‚è€ƒ<a class=link href="http://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented%20Functions%2FNT%20Objects%2FProcess%2FPEB.html" target=_blank rel=noopener>è¿™ä¸ª</a>ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=k>typedef</span> <span class=k>struct</span> <span class=nc>_PEB</span> <span class=p>{</span>
  <span class=n>BOOLEAN</span>                 <span class=n>InheritedAddressSpace</span><span class=p>;</span>
  <span class=n>BOOLEAN</span>                 <span class=n>ReadImageFileExecOptions</span><span class=p>;</span>
  <span class=n>BOOLEAN</span>                 <span class=n>BeingDebugged</span><span class=p>;</span>
  <span class=n>BOOLEAN</span>                 <span class=n>Spare</span><span class=p>;</span>
  <span class=n>HANDLE</span>                  <span class=n>Mutant</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>ImageBaseAddress</span><span class=p>;</span>
  <span class=n>PPEB_LDR_DATA</span>           <span class=n>LoaderData</span><span class=p>;</span>
  <span class=n>PRTL_USER_PROCESS_PARAMETERS</span> <span class=n>ProcessParameters</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>SubSystemData</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>ProcessHeap</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>FastPebLock</span><span class=p>;</span>
  <span class=n>PPEBLOCKROUTINE</span>         <span class=n>FastPebLockRoutine</span><span class=p>;</span>
  <span class=n>PPEBLOCKROUTINE</span>         <span class=n>FastPebUnlockRoutine</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>EnvironmentUpdateCount</span><span class=p>;</span>
  <span class=n>PPVOID</span>                  <span class=n>KernelCallbackTable</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>EventLogSection</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>EventLog</span><span class=p>;</span>
  <span class=n>PPEB_FREE_BLOCK</span>         <span class=n>FreeList</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>TlsExpansionCounter</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>TlsBitmap</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>TlsBitmapBits</span><span class=p>[</span><span class=mh>0x2</span><span class=p>];</span>
  <span class=n>PVOID</span>                   <span class=n>ReadOnlySharedMemoryBase</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>ReadOnlySharedMemoryHeap</span><span class=p>;</span>
  <span class=n>PPVOID</span>                  <span class=n>ReadOnlyStaticServerData</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>AnsiCodePageData</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>OemCodePageData</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>UnicodeCaseTableData</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>NumberOfProcessors</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>NtGlobalFlag</span><span class=p>;</span>
  <span class=n>BYTE</span>                    <span class=n>Spare2</span><span class=p>[</span><span class=mh>0x4</span><span class=p>];</span>
  <span class=n>LARGE_INTEGER</span>           <span class=n>CriticalSectionTimeout</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>HeapSegmentReserve</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>HeapSegmentCommit</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>HeapDeCommitTotalFreeThreshold</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>HeapDeCommitFreeBlockThreshold</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>NumberOfHeaps</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>MaximumNumberOfHeaps</span><span class=p>;</span>
  <span class=n>PPVOID</span>                  <span class=o>*</span><span class=n>ProcessHeaps</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>GdiSharedHandleTable</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>ProcessStarterHelper</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>GdiDCAttributeList</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>LoaderLock</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>OSMajorVersion</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>OSMinorVersion</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>OSBuildNumber</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>OSPlatformId</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>ImageSubSystem</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>ImageSubSystemMajorVersion</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>ImageSubSystemMinorVersion</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>GdiHandleBuffer</span><span class=p>[</span><span class=mh>0x22</span><span class=p>];</span>
  <span class=n>ULONG</span>                   <span class=n>PostProcessInitRoutine</span><span class=p>;</span>
  <span class=n>ULONG</span>                   <span class=n>TlsExpansionBitmap</span><span class=p>;</span>
  <span class=n>BYTE</span>                    <span class=n>TlsExpansionBitmapBits</span><span class=p>[</span><span class=mh>0x80</span><span class=p>];</span>
  <span class=n>ULONG</span>                   <span class=n>SessionId</span><span class=p>;</span>
<span class=p>}</span> <span class=n>PEB</span><span class=p>,</span> <span class=o>*</span><span class=n>PPEB</span><span class=p>;</span>
</code></pre></div><p>æ¥ç€ä» PEB æ‰¾åˆ° <code>Ldr</code>ï¼Œä½ç½®æ˜¯ <code>(sizeof(BOOLEAN)*4+sizeof(HANDLE)+sizeof(PVOID))==12==0xc</code>ã€‚</p>
<h3 id=12-peb_ldr_data>1.2 PEB_LDR_DATA</h3>
<p>æ¥ç€ä» <code>PEB_LDR_DATA</code> ç»“æ„é‡Œæ‰¾ <code>InMemoryOrderModuleList</code> è¿™ä¸ªå­—æ®µï¼Œ<code>PEB_LDR_DATA</code> ç»“æ„å¦‚ä¸‹ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=k>typedef</span> <span class=k>struct</span> <span class=nc>_PEB_LDR_DATA</span> <span class=p>{</span>
  <span class=n>ULONG</span>                   <span class=n>Length</span><span class=p>;</span>
  <span class=n>BOOLEAN</span>                 <span class=n>Initialized</span><span class=p>;</span>
  <span class=n>PVOID</span>                   <span class=n>SsHandle</span><span class=p>;</span>
  <span class=n>LIST_ENTRY</span>              <span class=n>InLoadOrderModuleList</span><span class=p>;</span>
  <span class=n>LIST_ENTRY</span>              <span class=n>InMemoryOrderModuleList</span><span class=p>;</span>
  <span class=n>LIST_ENTRY</span>              <span class=n>InInitializationOrderModuleList</span><span class=p>;</span>
<span class=p>}</span> <span class=n>PEB_LDR_DATA</span><span class=p>,</span> <span class=o>*</span><span class=n>PPEB_LDR_DATA</span><span class=p>;</span>
</code></pre></div><p>æ‰¾åˆ°<code>InMemoryOrderModuleList</code>å­—æ®µï¼Œä½ç½®æ˜¯<code>(sizeof(ULONG)+sizeof(BOOLEAN)+sizeof(PVOID)+sizeof(LIST_ENTRY))==20==0x14</code></p>
<p>æ³¨æ„ <code>sizeof(BOOLEAN)</code> æ˜¯ <code>BYTE</code> ç±»å‹ï¼Œä½†è¿™ä¸ªç»“æ„ä½“æ˜¯è¢«å¯¹é½åˆ°äº†4å­—èŠ‚çš„ï¼Œæ‰€ä»¥ BOOLEAN å­—æ®µåé¢å®é™…æœ‰3ä¸ªå­—èŠ‚çš„ paddingã€‚åˆèµ·æ¥å°±æ˜¯ä¸‰ä¸ª DWORD ã€‚</p>
<h3 id=13-ldr_data_table_entry>1.3 LDR_DATA_TABLE_ENTRY</h3>
<p>ä¹‹åå°±æ˜¯ LIST_ENTRY è¿™ä¸ªç»“æ„äº†ï¼Œç”¨ WinDbg æŸ¥äº†ä¸‹ç»“æ„ï¼š</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain>0:000&gt; dt _LIST_ENTRY
ntdll!_LIST_ENTRY
   +0x000 Flink            : Ptr32 _LIST_ENTRY
   +0x004 Blink            : Ptr32 _LIST_ENTRY
</code></pre></div><p>æ ¹æ®ä¸Šé¢ <em>Undocumented</em> æ–‡æ¡£å’ŒåŸæ–‡ç« çš„å™è¿°æ¥çœ‹ï¼Œè¿™åº”è¯¥å°±æ˜¯ä¸ªæŒ‡å‘ <code>_LDR_DATA_TABLE_ENTRY</code> ç»“æ„ï¼ˆåŒå‘é“¾è¡¨ï¼‰çš„æŒ‡é’ˆã€‚<code>_LIST_ENTRY</code>ç»“æ„æœ¬èº«æ˜¯åŒ…å«ä¸¤ä¸ªæŒ‡é’ˆï¼Œä¸€ä¸ª<code>Forward</code>æ­£å‘æŒ‡é’ˆï¼Œä¸€ä¸ª<code>Backward</code>ã€‚æ‰€ä»¥æˆ‘ä»¬å–<code>Flink</code>å­—æ®µå°±å¯ä»¥ï¼Œè·³è¿‡<code>InLoadOrderModuleList</code>è¿™ä¸ªå­—æ®µåï¼Œä¸€å…±åç§» <code>0x14</code> å°±æ˜¯æˆ‘ä»¬è¦çš„ <code>Flink</code> æŒ‡é’ˆäº†ï¼ŒæŒ‡å‘çš„åº”è¯¥æ˜¯ <code>_LDR_DATA_TABLE_ENTRY</code> è¿™ä¸ªç»“æ„ä½“ä¸­çš„ <code>InMemoryOrderLinks</code> å­—æ®µã€‚ä¸‹é¢ç»™å‡º<code>_LDR_DATA_TABLE_ENTRY</code>çš„ç»“æ„ï¼ˆWinDbgï¼‰ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain>0:000&gt; dt _ldr_data_table_entry
ntdll!_LDR_DATA_TABLE_ENTRY
   +0x000 InLoadOrderLinks : _LIST_ENTRY
   +0x008 InMemoryOrderLinks : _LIST_ENTRY
   +0x010 InInitializationOrderLinks : _LIST_ENTRY
   +0x018 DllBase          : Ptr32 Void
   +0x01c EntryPoint       : Ptr32 Void
   +0x020 SizeOfImage      : Uint4B
   +0x024 FullDllName      : _UNICODE_STRING
   +0x02c BaseDllName      : _UNICODE_STRING
   +0x034 FlagGroup        : [4] UChar
   +0x034 Flags            : Uint4B
   +0x034 PackagedBinary   : Pos 0, 1 Bit
   +0x034 MarkedForRemoval : Pos 1, 1 Bit
   +0x034 ImageDll         : Pos 2, 1 Bit
   +0x034 LoadNotificationsSent : Pos 3, 1 Bit
   +0x034 TelemetryEntryProcessed : Pos 4, 1 Bit
   +0x034 ProcessStaticImport : Pos 5, 1 Bit
   +0x034 InLegacyLists    : Pos 6, 1 Bit
   +0x034 InIndexes        : Pos 7, 1 Bit
   +0x034 ShimDll          : Pos 8, 1 Bit
   +0x034 InExceptionTable : Pos 9, 1 Bit
   +0x034 ReservedFlags1   : Pos 10, 2 Bits
   +0x034 LoadInProgress   : Pos 12, 1 Bit
   +0x034 LoadConfigProcessed : Pos 13, 1 Bit
   +0x034 EntryProcessed   : Pos 14, 1 Bit
   +0x034 ProtectDelayLoad : Pos 15, 1 Bit
   +0x034 ReservedFlags3   : Pos 16, 2 Bits
   +0x034 DontCallForThreads : Pos 18, 1 Bit
   +0x034 ProcessAttachCalled : Pos 19, 1 Bit
   +0x034 ProcessAttachFailed : Pos 20, 1 Bit
   +0x034 CorDeferredValidate : Pos 21, 1 Bit
   +0x034 CorImage         : Pos 22, 1 Bit
   +0x034 DontRelocate     : Pos 23, 1 Bit
   +0x034 CorILOnly        : Pos 24, 1 Bit
   +0x034 ChpeImage        : Pos 25, 1 Bit
   +0x034 ReservedFlags5   : Pos 26, 2 Bits
   +0x034 Redirected       : Pos 28, 1 Bit
   +0x034 ReservedFlags6   : Pos 29, 2 Bits
   +0x034 CompatDatabaseProcessed : Pos 31, 1 Bit
   +0x038 ObsoleteLoadCount : Uint2B
   +0x03a TlsIndex         : Uint2B
   +0x03c HashLinks        : _LIST_ENTRY
   +0x044 TimeDateStamp    : Uint4B
   +0x048 EntryPointActivationContext : Ptr32 _ACTIVATION_CONTEXT
   +0x04c Lock             : Ptr32 Void
   +0x050 DdagNode         : Ptr32 _LDR_DDAG_NODE
   +0x054 NodeModuleLink   : _LIST_ENTRY
   +0x05c LoadContext      : Ptr32 _LDRP_LOAD_CONTEXT
   +0x060 ParentDllBase    : Ptr32 Void
   +0x064 SwitchBackContext : Ptr32 Void
   +0x068 BaseAddressIndexNode : _RTL_BALANCED_NODE
   +0x074 MappingInfoIndexNode : _RTL_BALANCED_NODE
   +0x080 OriginalBase     : Uint4B
   +0x088 LoadTime         : _LARGE_INTEGER
   +0x090 BaseNameHashValue : Uint4B
   +0x094 LoadReason       : _LDR_DLL_LOAD_REASON
   +0x098 ImplicitPathOptions : Uint4B
   +0x09c ReferenceCount   : Uint4B
   +0x0a0 DependentLoadFlags : Uint4B
   +0x0a4 SigningLevel     : UChar
</code></pre></div><p>è¦æ³¨æ„åˆ° <code>_LDR_DATA_TABLE_ENTRY</code> ç»“æ„ä¸­çš„ <code>InMemoryOrderLinks</code> å¹¶ä¸æ˜¯åœ¨ç»“æ„å¼€å¤´ï¼Œæ‰€ä»¥å–å¾—çš„åœ°å€å¿…é¡»å…ˆå‡å»è¿™ä¸ªåç§»å€¼ï¼ˆ8å­—èŠ‚ï¼‰å†è½¬æ¢ç±»å‹æ‰æ˜¯æ­£ç¡®çš„ç»“æ„ã€‚</p>
<h3 id=14-æ¨¡å—åŸºå€>1.4 æ¨¡å—åŸºå€</h3>
<p>æ¥ç€ä» WinDbg å¯ä»¥å®é™…å‘ç°ï¼Œè¿™ä¸ªé“¾è¡¨é‡Œï¼Œæˆ‘ä»¬çš„ç¨‹åºä¹‹åå°±æ˜¯<code>ntdll.dll</code>ï¼Œå†ä¹‹åå°±æ˜¯<code>kernel32.dll</code>ï¼Œä¸å†æ¼”ç¤ºã€‚åæ­£å°±å½“<code>kernel32.dll</code>å›ºå®šåœ¨è¿™ä¸ªé“¾è¡¨çš„ç¬¬ä¸‰ä¸ªå…ƒç´ å°±æ˜¯äº†ã€‚çœŸè¦é«˜é²æ£’æ€§çš„è¯å°±å¾—éå†è¿™ä¸ªé“¾è¡¨ï¼ŒæŒ‰åå­—æ‰¾å‡º <code>kernel32.dll</code> å¯¹åº”çš„ç»“æ„ï¼Œå†å–åœ°å€â€”â€”éº»çƒ¦æ­»äº†ã€‚</p>
<p>å–å¾— <code>kernel32.dll</code> å¯¹åº”çš„ <code>_LDR_DATA_TABLE_ENTRY</code> ç»“æ„åï¼Œå°±å¯ä»¥æå–å…¶ä¸­çš„ <code>DllBase</code> å­—æ®µäº†ï¼Œè¿™ä¸ªå­—æ®µå°±æ˜¯ <code>kernel32.dll</code> çš„åŸºå€ã€‚</p>
<h3 id=15-teb-çš„ä½ç½®>1.5 TEB çš„ä½ç½®</h3>
<p>è°·æ­Œä¸€ä¸‹ä¸éš¾æ‰¾åˆ°ï¼ŒWin32ç¨‹åºè¿›ç¨‹åœ°å€ç©ºé—´é‡Œï¼ŒTEBçš„åœ°å€å°±åœ¨ <code>[fs:0]</code> è¿™ä¸ªåœ°å€ä¸Šã€‚</p>
<h3 id=16-è·å–-kernel-32-åŸºå€>1.6 è·å– kernel 32 åŸºå€</h3>
<p>é‚£å°±å¼€å§‹å†™æ±‡ç¼–ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=nf>section</span> <span class=no>.text</span>
    <span class=nf>global</span> <span class=no>_main</span>
<span class=nl>_main:</span>
    <span class=nf>push</span> <span class=no>ebp</span>
    <span class=nf>mov</span> <span class=no>ebp</span><span class=p>,</span><span class=no>esp</span>

    <span class=c>; è·å– kernel32.dll åŸºå€
</span><span class=c></span>    <span class=nf>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>fs</span><span class=p>:</span><span class=mi>30</span><span class=no>h</span><span class=p>]</span>           <span class=c>; eax = TEB-&gt;PEB
</span><span class=c></span>    <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>eax</span><span class=err>+</span><span class=mi>0</span><span class=no>ch</span><span class=p>]</span>          <span class=c>; eax = PEB-&gt;Ldr
</span><span class=c></span>    <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>eax</span><span class=err>+</span><span class=mi>14</span><span class=no>h</span><span class=p>]</span>          <span class=c>; eax = PEB_LDR_DATA-&gt;InMemoryOrderModuleList.Flink (å½“å‰ç¨‹åº)
</span><span class=c></span>    <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>eax</span><span class=p>]</span>              <span class=c>; eax = &amp;_LDR_DATA_TABLE_ENTRY.InMemoryOrderModuleList.Flink (ç°åœ¨æ˜¯ ntdll.dll)
</span><span class=c></span>    <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>eax</span><span class=p>]</span>              <span class=c>; eax = &amp;_LDR_DATA_TABLE_ENTRY.InMemoryOrderModuleList.Flink (ç°åœ¨æ˜¯ kernel32.dll)
</span><span class=c></span>    <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>eax-8h</span><span class=err>+</span><span class=mi>18</span><span class=no>h</span><span class=p>]</span>       <span class=c>; eax = &amp;_LDR_DATA_TABLE_ENTRY.DllBase (kernel32.dll åŸºå€)
</span><span class=c></span>
    <span class=nf>xor</span> <span class=no>eax</span><span class=p>,</span><span class=no>eax</span>
    <span class=nf>pop</span> <span class=no>ebp</span>
    <span class=nf>retn</span>
</code></pre></div><p>ç”¨ MinGW ç¼–è¯‘ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>nasm main.asm -f win32 -o main.o
gcc main.o -nostartfiles -nodefaultlibs -o main.exe
</code></pre></div><p>ç¬¬ä¸€æ­¥ <code>[fs:30h]</code> è¿™ä¸ªåœ°å€å°±æ˜¯ TEB ä¸­çš„ PEB æŒ‡é’ˆï¼Œå°†æŒ‡é’ˆä¿å­˜çš„åœ°å€ç§»å…¥ <code>eax</code> å¯„å­˜å™¨ã€‚ç°åœ¨ <code>eax</code> å¯„å­˜å™¨æŒ‡å‘çš„å°±æ˜¯ PEB ç»“æ„äº†ã€‚</p>
<p>ç¬¬äºŒæ­¥å– <code>PEB->Ldr</code> æŒ‡é’ˆã€‚</p>
<p>ç¬¬ä¸‰æ­¥å– <code>PEB_LDR_DATA->InMemoryOrderModuleList.Flink</code> æŒ‡é’ˆï¼Œè¿™ä¸ªæŒ‡é’ˆæŒ‡å‘çš„æ˜¯å½“å‰ç¨‹åºçš„ <code>_LDR_DATA_TABLE_ENTRY.InMemoryOrderModuleList.Flink</code> ã€‚æ­¤æ—¶æˆ‘ä»¬å·²ç»å¼€å§‹éå†é“¾è¡¨ã€‚</p>
<p>ç¬¬å››æ­¥æ˜¯å–é“¾è¡¨çš„ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œæˆ‘ä»¬è®¤ä¸ºæ˜¯ <code>ntdll.dll</code> ï¼Œå†å–ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œå¾—åˆ° <code>kernel32.dll</code>ã€‚</p>
<p>æ­¤æ—¶çš„ <code>eax</code> æŒ‡å‘çš„è¿˜æ˜¯ <code>_LDR_DATA_TABLE_ENTRY.InMemoryOrderModuleList.Flink</code> è¯·æ³¨æ„ï¼Œè®¡ç®—åç§»çš„æ—¶å€™è¦å…ˆç§»å›ç»“æ„çš„é¦–éƒ¨ï¼ˆ<code>-0x08</code>ï¼‰å†è®¡ç®—ã€‚</p>
<p>ç¬¬äº”æ­¥å°±æ˜¯ä» <code>kernel32.dll</code> çš„ <code>_LDR_DATA_TABLE_ENTRY</code> ç»“æ„é‡Œï¼Œå– <code>DllBase</code> å­—æ®µçš„å€¼äº†ã€‚<code>eax - 8h + 18h</code> å¾—åˆ° <code>DllBase</code> å­—æ®µçš„åç§»åœ°å€ï¼Œæ‰§è¡Œåå¾—åˆ°çš„å°±æ˜¯ <code>kernel32.dll</code> çš„åŸºå€æŒ‡é’ˆäº†ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ç”¨ WinDbg Preview éªŒè¯ä¸‹ã€‚</p>
<p>&mldr;.</p>
<p>ä¸çŸ¥é“ä¸ºå•¥ WinDbg Preview ä¸èƒ½æ­£ç¡®è°ƒè¯•ï¼Œè¿˜æ˜¯ç”¨å› x32dbg ã€‚</p>
<p><img src=/blog/image/%e5%85%b3%e4%ba%8e%e5%9c%a8%e5%86%85%e5%ad%98%e9%87%8c%e6%89%bekernel32%e8%bf%99%e4%bb%b6%e4%ba%8b/image-20211014143628806.png loading=lazy alt=image-20211014143628806></p>
<p>æ³¨æ„æ­¤æ—¶ EAX çš„å€¼æ˜¯ <code>75B30000</code> ï¼Œå†…å®¹è¢«è°ƒè¯•å™¨è¯†åˆ«ä¸º <code>MZ?</code> ï¼Œæ˜¾ç„¶æ˜¯ä¸ª DOS æ–‡ä»¶å¤´ã€‚</p>
<p><img src=/blog/image/%e5%85%b3%e4%ba%8e%e5%9c%a8%e5%86%85%e5%ad%98%e9%87%8c%e6%89%bekernel32%e8%bf%99%e4%bb%b6%e4%ba%8b/image-20211014143759203.png loading=lazy alt=image-20211014143759203></p>
<p>åœ¨è°ƒè¯•å™¨çš„å†…å­˜å¸ƒå±€çª—å£å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªåœ°å€æ­£å¥½å°±æ˜¯ <code>kernel32.dll</code> çš„é•œåƒåŸºå€ã€‚</p>
<p>åˆ°æ­¤ï¼Œæˆ‘ä»¬å·²ç»æ‰¾åˆ°äº† <code>kernel32.dll</code> çš„é•œåƒåŸºå€ï¼Œæ‰¾åˆ°äº†é•œåƒåŸºå€åï¼Œæ ¹æ®ä¹‹å‰å­¦ä¹ çš„å¯¹ PE æ–‡ä»¶æ ¼å¼çš„äº†è§£ï¼Œå°±æœ‰æœºä¼šè‡ªå·±è§£æå¯¼å‡ºè¡¨ï¼Œè°ƒç”¨ <code>kernel32.dll</code> å†…çš„å‡½æ•°å•¦ã€‚</p>
<h2 id=0x02-å¯»æ‰¾-winexec-å‡½æ•°>0x02 å¯»æ‰¾ WinExec å‡½æ•°</h2>
<p>ä½œä¸ºå®è·µçš„ç›®æ ‡ï¼Œè¿™æ¬¡å¸Œæœ›åœ¨ <code>kernel32.dll</code> é‡Œæ‰¾å‡º <code>WinExec</code> å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°çš„æ–‡æ¡£åœ¨<a class=link href=https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-winexec target=_blank rel=noopener>è¿™é‡Œ</a>ã€‚å‡½æ•°ç­¾åå¦‚ä¸‹ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=n>UINT</span> <span class=nf>WinExec</span><span class=p>(</span>
  <span class=p>[</span><span class=n>in</span><span class=p>]</span> <span class=n>LPCSTR</span> <span class=n>lpCmdLine</span><span class=p>,</span>
  <span class=p>[</span><span class=n>in</span><span class=p>]</span> <span class=n>UINT</span>   <span class=n>uCmdShow</span>
<span class=p>);</span>
</code></pre></div><p>æ–‡æ¡£è¯´æˆ‘ä»¬åº”è¯¥ç”¨ <code>CreateProcess</code> ä½†æ˜¯é‚£ä¸ªå‡½æ•°å‚æ•°å¤šçš„ä¸€æ‰¹ï¼Œç‹—éƒ½ä¸çœ‹ã€‚å¾®è½¯å°±æ²¡ç‚¹13æ•°ä¹ˆã€‚</p>
<h3 id=21-å¯»æ‰¾å¯¼å‡ºè¡¨>2.1 å¯»æ‰¾å¯¼å‡ºè¡¨</h3>
<p>æœ‰äº† <code>kernel32.dll</code> çš„åŸºå€ï¼Œä¸‹ä¸€æ­¥å°±æ˜¯å¯»æ‰¾å¯¼å‡ºè¡¨çš„ä½ç½®äº†ã€‚</p>
<p>ä¾æ®æˆ‘ä»¬å¯¹ PE æ–‡ä»¶æ ¼å¼çš„äº†è§£ï¼Œé¦–å…ˆå¾—åœ¨ Data Directories é‡Œæ‰¾åˆ° <em>Export Directory</em> ã€‚</p>
<p>åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæš‚å­˜ä¸€ä¸‹ <code>kernel32.dll</code> åŸºå€ä»¥å¤‡åç”¨ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm>	<span class=nf>mov</span> <span class=no>ebx</span><span class=p>,</span> <span class=no>eax</span>
</code></pre></div><p>ç„¶åå¼€å§‹å¯»æ‰¾ dos æ–‡ä»¶å¤´é‡Œçš„ <code>lfanew</code> ã€‚ç›¸å¯¹æ–‡ä»¶å¤´çš„åç§»æ˜¯ <code>3ch</code> ï¼Œå†…å®¹æ˜¯ç›¸å¯¹æ–‡ä»¶å¤´çš„åç§»å€¼ï¼Œæˆ‘ä»¬è¿™æ ·è®¡ç®—ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm>	<span class=nf>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>ebx</span><span class=err>+</span><span class=mi>3</span><span class=no>ch</span><span class=p>]</span>
	<span class=nf>add</span> <span class=no>eax</span><span class=p>,</span> <span class=no>ebx</span>
</code></pre></div><p>ç°åœ¨ eax æŒ‡å‘çš„å°±æ˜¯ pe æ–‡ä»¶å¤´äº†ã€‚</p>
<p>ç„¶åæˆ‘ä»¬æ‰¾åˆ° <code>ExportDirectory.VirtualAddress</code> çš„åç§»ï¼Œå®ƒåœ¨ç›¸å¯¹ PE æ–‡ä»¶å¤´ <code>78h</code> åç§»çš„åœ°æ–¹ã€‚å¦‚æœè¿˜è®°å¾— 16 ä¸ªå…ƒç´ çš„ Data Directories ç»“æ„çš„è¯ï¼Œæé†’ä¸‹ ExportDirectory å°±æ˜¯æ‰€æœ‰ Data Directories é‡Œæ’ç¬¬ä¸€ä¸ªçš„ç»“æ„ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm>    <span class=nf>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>eax</span><span class=err>+</span><span class=mi>78</span><span class=no>h</span><span class=p>]</span>                                  <span class=c>; eax = ExportDirectory.VirtualAddress
</span></code></pre></div><p>å¾—åˆ°çš„æ˜¯ RVA ï¼ŒåŠ ä¸ŠåŸºå€ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm>    <span class=nf>add</span> <span class=no>eax</span><span class=p>,</span> <span class=no>ebx</span>                                        <span class=c>; eax = &amp;ExportDirectoryTable
</span></code></pre></div><p>æ¥ä¸‹æ¥è¦å¼€å§‹è§£æ ExportDirectoryTable ç»“æ„äº†ï¼Œå‚è€ƒ<a class=link href=https://docs.microsoft.com/en-us/windows/win32/debug/pe-format#export-directory-table target=_blank rel=noopener>å¾®è½¯çš„æ–‡æ¡£</a>ã€‚</p>
<p>å› ä¸ºéœ€è¦æš‚å­˜å¾ˆå¤šå˜é‡ï¼Œæˆ‘ä»¬å…ˆç»™è¿™äº›å˜é‡åœ¨æ ˆä¸Šåˆ†é…ç©ºé—´ã€‚</p>
<h3 id=22-åˆ†é…æ ˆå˜é‡>2.2 åˆ†é…æ ˆå˜é‡</h3>
<p>å…ˆå›åˆ°å¼€å¤´ï¼Œå®šä¹‰å¥½æ ˆå¦‚ä½•åˆ†é…ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=err>%</span><span class=nf>define</span> <span class=no>kernel32_base</span> <span class=mi>0x04</span>
<span class=err>%</span><span class=nf>define</span> <span class=no>numberof_export_entries</span> <span class=mi>0x08</span>
<span class=err>%</span><span class=nf>define</span> <span class=no>address_of_ordinal_table</span> <span class=mi>0x0c</span>
<span class=err>%</span><span class=nf>define</span> <span class=no>address_of_func_address_table</span> <span class=mi>0x10</span>
<span class=err>%</span><span class=nf>define</span> <span class=no>address_of_export_directory_table</span> <span class=mi>0x14</span>
<span class=err>%</span><span class=nf>define</span> <span class=no>address_of_name_table</span> <span class=mi>0x18</span>
<span class=err>%</span><span class=nf>define</span> <span class=no>ordinal_base</span> <span class=mi>0x1c</span>
</code></pre></div><p>ç„¶ååœ¨å…¥å£ç‚¹å¤„ï¼Œæ·»åŠ  <code>sub esp, 0x1c</code>ï¼Œåˆ†é…æ ˆç©ºé—´ã€‚ä¹‹åå°±å¯ä»¥ä½¿ç”¨ <code>[ebp-å˜é‡]</code> çš„å½¢å¼æ¥ä½¿ç”¨è¿™äº›å˜é‡äº†ã€‚ä¿®æ”¹åçš„ä»£ç å¦‚ä¸‹ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=err>%</span><span class=nf>define</span> <span class=no>kernel32_base</span> <span class=mi>0x04</span>
<span class=err>%</span><span class=nf>define</span> <span class=no>numberof_export_entries</span> <span class=mi>0x08</span>
<span class=err>%</span><span class=nf>define</span> <span class=no>address_of_ordinal_table</span> <span class=mi>0x0c</span>
<span class=err>%</span><span class=nf>define</span> <span class=no>address_of_func_address_table</span> <span class=mi>0x10</span>
<span class=err>%</span><span class=nf>define</span> <span class=no>address_of_export_directory_table</span> <span class=mi>0x14</span>
<span class=err>%</span><span class=nf>define</span> <span class=no>address_of_name_table</span> <span class=mi>0x18</span>
<span class=err>%</span><span class=nf>define</span> <span class=no>ordinal_base</span> <span class=mi>0x1c</span>

<span class=nf>section</span> <span class=no>.text</span>
    <span class=nf>global</span> <span class=no>_main</span>
<span class=nl>_main:</span>
    <span class=nf>push</span> <span class=no>ebp</span>
    <span class=nf>mov</span> <span class=no>ebp</span><span class=p>,</span> <span class=no>esp</span>
    <span class=nf>sub</span> <span class=no>esp</span><span class=p>,</span> <span class=mi>1</span><span class=no>ch</span>

    <span class=c>; è·å– kernel32.dll åŸºå€
</span><span class=c></span>    <span class=nf>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>fs</span><span class=p>:</span><span class=mi>30</span><span class=no>h</span><span class=p>]</span>               <span class=c>; eax = TEB-&gt;PEB
</span><span class=c></span>    <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>eax</span><span class=err>+</span><span class=mi>0</span><span class=no>ch</span><span class=p>]</span>              <span class=c>; eax = PEB-&gt;Ldr
</span><span class=c></span>    <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>eax</span><span class=err>+</span><span class=mi>14</span><span class=no>h</span><span class=p>]</span>              <span class=c>; eax = PEB_LDR_DATA-&gt;InMemoryOrderModuleList.Flink (å½“å‰ç¨‹åº)
</span><span class=c></span>    <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>eax</span><span class=p>]</span>                  <span class=c>; eax = &amp;_LDR_DATA_TABLE_ENTRY.InMemoryOrderModuleList.Flink (ç°åœ¨æ˜¯ ntdll.dll)
</span><span class=c></span>    <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>eax</span><span class=p>]</span>                  <span class=c>; eax = &amp;_LDR_DATA_TABLE_ENTRY.InMemoryOrderModuleList.Flink (ç°åœ¨æ˜¯ kernel32.dll)
</span><span class=c></span>    <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>eax-8h</span><span class=err>+</span><span class=mi>18</span><span class=no>h</span><span class=p>]</span>           <span class=c>; eax = &amp;_LDR_DATA_TABLE_ENTRY.DllBase (kernel32.dll åŸºå€)
</span><span class=c></span>
    <span class=nf>mov</span> <span class=no>ebx</span><span class=p>,</span> <span class=no>eax</span>                    <span class=c>; ebx -&gt; kernel32.dll åŸºå€
</span><span class=c></span>    <span class=no>mov</span> <span class=p>[</span><span class=no>ebp-kernel32_base</span><span class=p>],</span> <span class=no>eax</span>    <span class=c>; kernel32_base -&gt; kernel32.dll åŸºå€
</span><span class=c></span>
    <span class=nf>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>ebx</span><span class=err>+</span><span class=mi>3</span><span class=no>ch</span><span class=p>]</span>
    <span class=nf>add</span> <span class=no>eax</span><span class=p>,</span> <span class=no>ebx</span>                    <span class=c>; eax -&gt; kernel32.dll çš„ pe æ–‡ä»¶å¤´
</span><span class=c></span>
    <span class=nf>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>eax</span><span class=err>+</span><span class=mi>78</span><span class=no>h</span><span class=p>]</span>              <span class=c>; eax -&gt; ExportDirectory.VirtualAddress
</span><span class=c></span>    <span class=no>add</span> <span class=no>eax</span><span class=p>,</span> <span class=no>ebx</span>                    <span class=c>; eax -&gt; Export Directory Table
</span><span class=c></span>
    <span class=nf>xor</span> <span class=no>eax</span><span class=p>,</span> <span class=no>eax</span>
    <span class=nf>add</span> <span class=no>esp</span><span class=p>,</span> <span class=mi>1</span><span class=no>ch</span>
    <span class=nf>pop</span> <span class=no>ebp</span>
    <span class=nf>retn</span>
</code></pre></div><p>æ¥ç€ä» <code>xor eax,eax</code> ä¹‹å‰ç»§ç»­ã€‚</p>
<h3 id=23-åˆ†æ-export-directory-table>2.3 åˆ†æ Export Directory Table</h3>
<p>å…ˆç»™å‡ºå®šä¹‰ã€‚</p>
<div class=table-wrapper><table>
<thead>
<tr>
<th style=text-align:left>Offset</th>
<th style=text-align:left>Size</th>
<th style=text-align:left>Field</th>
<th style=text-align:left>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left>0</td>
<td style=text-align:left>4</td>
<td style=text-align:left>Export Flags</td>
<td style=text-align:left>Reserved, must be 0.</td>
</tr>
<tr>
<td style=text-align:left>4</td>
<td style=text-align:left>4</td>
<td style=text-align:left>Time/Date Stamp</td>
<td style=text-align:left>The time and date that the export data was created.</td>
</tr>
<tr>
<td style=text-align:left>8</td>
<td style=text-align:left>2</td>
<td style=text-align:left>Major Version</td>
<td style=text-align:left>The major version number. The major and minor version numbers can be set by the user.</td>
</tr>
<tr>
<td style=text-align:left>10</td>
<td style=text-align:left>2</td>
<td style=text-align:left>Minor Version</td>
<td style=text-align:left>The minor version number.</td>
</tr>
<tr>
<td style=text-align:left>12</td>
<td style=text-align:left>4</td>
<td style=text-align:left>Name RVA</td>
<td style=text-align:left>The address of the ASCII string that contains the name of the DLL. This address is relative to the image base.</td>
</tr>
<tr>
<td style=text-align:left>16</td>
<td style=text-align:left>4</td>
<td style=text-align:left>Ordinal Base</td>
<td style=text-align:left>The starting ordinal number for exports in this image. This field specifies the starting ordinal number for the export address table. It is usually set to 1.</td>
</tr>
<tr>
<td style=text-align:left>20</td>
<td style=text-align:left>4</td>
<td style=text-align:left>Address Table Entries</td>
<td style=text-align:left>The number of entries in the export address table.</td>
</tr>
<tr>
<td style=text-align:left>24</td>
<td style=text-align:left>4</td>
<td style=text-align:left>Number of Name Pointers</td>
<td style=text-align:left>The number of entries in the name pointer table. This is also the number of entries in the ordinal table.</td>
</tr>
<tr>
<td style=text-align:left>28</td>
<td style=text-align:left>4</td>
<td style=text-align:left>Export Address Table RVA</td>
<td style=text-align:left>The address of the export address table, relative to the image base.</td>
</tr>
<tr>
<td style=text-align:left>32</td>
<td style=text-align:left>4</td>
<td style=text-align:left>Name Pointer RVA</td>
<td style=text-align:left>The address of the export name pointer table, relative to the image base. The table size is given by the Number of Name Pointers field.</td>
</tr>
<tr>
<td style=text-align:left>36</td>
<td style=text-align:left>4</td>
<td style=text-align:left>Ordinal Table RVA</td>
<td style=text-align:left>The address of the ordinal table, relative to the image base.</td>
</tr>
</tbody>
</table></div>
<p>æ³¨æ„ offset æ˜¯ 10 è¿›åˆ¶ï¼Œä¹‹åç¼–å†™çš„ä»£ç é‡Œä¼šç”¨ 16 è¿›åˆ¶ã€‚</p>
<p>æˆ‘ä»¬æŠŠè¿™ä¸ªç»“æ„é‡Œï¼Œæˆ‘ä»¬å…³æ³¨çš„å­—æ®µä¿å­˜åˆ°æ ˆä¸Šã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm>    <span class=nf>mov</span> <span class=no>ecx</span><span class=p>,</span> <span class=no>eax</span>                                        <span class=c>; æš‚å­˜å¯¼å‡ºè¡¨ç»“æ„åŸºå€ç”¨æ¥è¿ç®—
</span><span class=c></span>    <span class=no>mov</span> <span class=p>[</span><span class=no>ebp-address_of_export_directory_table</span><span class=p>],</span> <span class=no>eax</span>    <span class=c>; ä¿å­˜å¯¼å‡ºè¡¨ç»“æ„åŸºå€åˆ°æ ˆå˜é‡
</span><span class=c></span>    <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>eax</span><span class=err>+</span><span class=mi>1</span><span class=no>ch</span><span class=p>]</span>
    <span class=nf>add</span> <span class=no>eax</span><span class=p>,</span> <span class=no>ebx</span>
    <span class=nf>mov</span> <span class=p>[</span><span class=no>ebp-address_of_func_address_table</span><span class=p>],</span> <span class=no>eax</span>        <span class=c>; ä¿å­˜å¯¼å‡ºå‡½æ•°è¡¨åœ°å€åˆ°æ ˆå˜é‡
</span><span class=c></span>    <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=no>ecx</span>
    <span class=nf>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>eax</span><span class=err>+</span><span class=mi>24</span><span class=no>h</span><span class=p>]</span>
    <span class=nf>add</span> <span class=no>eax</span><span class=p>,</span> <span class=no>ebx</span>
    <span class=nf>mov</span> <span class=p>[</span><span class=no>ebp-address_of_ordinal_table</span><span class=p>],</span> <span class=no>eax</span>             <span class=c>; ä¿å­˜ordinalè¡¨åœ°å€åˆ°æ ˆå˜é‡
</span><span class=c></span>    <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=no>ecx</span>
    <span class=nf>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>eax</span><span class=err>+</span><span class=mi>18</span><span class=no>h</span><span class=p>]</span>
    <span class=nf>mov</span> <span class=p>[</span><span class=no>ebp-numberof_export_entries</span><span class=p>],</span> <span class=no>eax</span>              <span class=c>; ä¿å­˜å¯¼å‡ºè¡¨(name)æ•°é‡åˆ°æ ˆå˜é‡
</span><span class=c></span>    <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=no>ecx</span>
    <span class=nf>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>eax</span><span class=err>+</span><span class=mi>20</span><span class=no>h</span><span class=p>]</span>                                  <span class=c>; eax=ç¬¬ä¸€ä¸ªå‡½æ•°åç§°çš„ RVA
</span><span class=c></span>    <span class=no>mov</span> <span class=p>[</span><span class=no>ebp-address_of_name_table</span><span class=p>],</span> <span class=no>eax</span>                <span class=c>; ä¿å­˜å¯¼å‡ºå‡½æ•°çš„åç§°è¡¨åˆ°æ ˆå˜é‡
</span><span class=c></span>    <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=no>ecx</span>
    <span class=nf>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>eax</span><span class=err>+</span><span class=mi>10</span><span class=no>h</span><span class=p>]</span>
    <span class=nf>mov</span> <span class=p>[</span><span class=no>ebp-ordinal_base</span><span class=p>],</span> <span class=no>eax</span>                         <span class=c>; ä¿å­˜ ordinal base ç”¨äºè®¡ç®—å¯¼å‡ºå‡½æ•°çš„åœ°å€
</span></code></pre></div><p>åº”è¯¥ä¸éš¾ç†è§£ã€‚</p>
<p>æ¥ä¸‹æ¥è¦ä»è¿™ä¸ªç»“æ„é‡Œæ‰¾å‡º <code>WinExec</code> å‡½æ•°çš„åœ°å€ã€‚</p>
<h3 id=24-å¯¼å‡ºè¡¨å’Œå‡½æ•°åœ°å€>2.4 å¯¼å‡ºè¡¨å’Œå‡½æ•°åœ°å€</h3>
<p>ä¸€äº›å‰ç½®çŸ¥è¯†ã€‚</p>
<p>å¯¼å‡ºå‡½æ•°çš„åœ°å€è¡¨æ˜¯ç”¨ Ordinal åšç´¢å¼•çš„ï¼Œæ‰€ä»¥å¿…é¡»å…ˆå–å¾— Ordinal æ‰èƒ½æ­£ç¡®å–å¾—åœ°å€ã€‚</p>
<blockquote>
<p>The export address table contains the address of exported entry points and exported data and absolutes. An ordinal number is used as an index into the export address table.</p>
</blockquote>
<p>æ³¨æ„ä» Ordinal Base å–å‡ºçš„å€¼æ˜¯ <strong>unbiased indexes</strong>ï¼Œä» Ordinal Table é‡Œå–å‡ºçš„ Ordinal å€¼å¹¶ä¸éœ€è¦å‡å» Ordinal Base ã€‚ä½†æ˜¯ DUMPBIN ä¹‹ç±»çš„å·¥å…·ä¼¼ä¹ä¼šç»™å‡ºåŠ ä¸Šäº† Ordinal Base çš„ Ordinal å€¼ï¼Œä¹Ÿå°±æ˜¯å¾®è½¯æ–‡æ¡£ä¸­è¯´çš„ Biased Ordinal ã€‚</p>
<p>è¿™ä»½æ–‡æ¡£æ›¾ç»æ˜¯é”™è¯¯çš„ï¼Œ<a class=link href=https://stackoverflow.com/questions/39996742/how-can-kernel32-dll-export-an-ordinal-of-0-when-its-ordinalbase-field-is-s target=_blank rel=noopener>è§çˆ†æ ˆçš„è¿™ä¸ªé—®é¢˜</a>ã€‚è¦æ˜¯çœ‹äº†ä»€ä¹ˆä¸çŸ¥é“ä»å“ªå„¿å¤åˆ¶ç²˜è´´æ¥çš„åšå®¢å¯èƒ½ä¼šæœ‰è¯¯è§£ï¼Œä½†ç°åœ¨çš„æ–‡æ¡£é‡Œæ˜¯æ˜ç¡®è¯´äº†æ˜¯ <strong>unbiased indexes</strong> ã€‚å–å¾— Ordinal ä¹‹åç›´æ¥å½“ä¸‹æ ‡å»è®¿é—®å°±è¡Œäº†ã€‚</p>
<blockquote>
<p>The export ordinal table is an array of <strong>16-bit unbiased indexes</strong> into the export address table. Ordinals are biased by the Ordinal Base field of the export directory table. In other words, the ordinal base must be subtracted from the ordinals to obtain true indexes into the export address table.</p>
</blockquote>
<p>æ–‡æ¡£ä¹Ÿæ˜ç¡®æŒ‡å‡ºï¼Œä½ å¯ä»¥æŠŠåç§°è¡¨å’Œordinalè¡¨å½“æˆä¸€ä¸ªè¡¨ï¼Œä¸‹æ ‡æ˜¯å…±é€šçš„ã€‚ä¹Ÿå°±æ˜¯åç§°è¡¨çš„ç¬¬1ä¸ªå…ƒç´ å¯¹åº”ordinalè¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p>
<blockquote>
<p>The export name pointer table and the export ordinal table form two parallel arrays that are separated to allow natural field alignment. These two tables, in effect, operate as one table, in which the Export Name Pointer column points to a public (exported) name and the Export Ordinal column gives the corresponding ordinal for that public name. A member of the export name pointer table and a member of the export ordinal table are associated by having the same position (index) in their respective arrays.</p>
</blockquote>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å¼€å§‹å¤„ç†è¿™å‡ ä¸ªè¡¨äº†ã€‚</p>
<h3 id=25-éå†åç§°è¡¨>2.5 éå†åç§°è¡¨</h3>
<p>å­—ç¬¦ä¸²å¸¸é‡è¦è®°å¾—å…ˆå®šä¹‰å¥½ï¼Œä¹‹åç”¨ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=nf>section</span> <span class=no>.data</span>
    <span class=nl>str_winexec:</span>
	    <span class=nf>db</span> <span class=err>&#39;</span><span class=no>WinExec</span><span class=err>&#39;</span><span class=p>,</span> <span class=mi>0</span>
    <span class=nl>str_calcexe:</span>
	    <span class=nf>db</span> <span class=err>&#39;</span><span class=no>calc.exe</span><span class=err>&#39;</span><span class=p>,</span> <span class=mi>0</span>
</code></pre></div><p>é¦–å…ˆä»åç§°è¡¨é‡Œæ‰¾å‡º <code>WinExec</code> è¿™ä¸ªå­—ç¬¦ä¸²ã€‚ä¹‹åä¼šæ‹¿ <code>eax</code> ä¿å­˜ä¸‹æ ‡ï¼Œ<code>ecx</code> ç”¨äº <code>repe cmpsb</code> æŒ‡ä»¤ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªå­—æ®µæˆ‘ä»¬å…ˆæ¸…ç©ºã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm>    <span class=nf>xor</span> <span class=no>eax</span><span class=p>,</span> <span class=no>eax</span>
    <span class=nf>xor</span> <span class=no>ecx</span><span class=p>,</span> <span class=no>ecx</span>
</code></pre></div><p>æ¥ç€å†™ä¸€ä¸ªå¾ªç¯ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=nl>.findWinExecLocation:</span>
    <span class=nf>mov</span> <span class=no>esi</span><span class=p>,</span> <span class=no>str_winexec</span>                    <span class=c>; å‡†å¤‡æ¯”è¾ƒï¼Œesi=å¸¸é‡å­—ç¬¦ä¸²
</span><span class=c></span>    <span class=no>mov</span> <span class=no>edi</span><span class=p>,</span> <span class=p>[</span><span class=no>ebp-address_of_name_table</span><span class=p>]</span>    <span class=c>; å‡†å¤‡æ¯”è¾ƒï¼Œedi=åç§°è¡¨é¦–å…ƒç´ ï¼Œæ³¨æ„åç§°è¡¨æ˜¯ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ éƒ½æ˜¯ DWORD RVA
</span><span class=c></span>    <span class=no>cld</span>                                     <span class=c>; æ¸…é™¤ df æ ‡å¿—ä½
</span><span class=c></span>
    <span class=nf>mov</span> <span class=no>ecx</span><span class=p>,</span> <span class=no>eax</span>                            <span class=c>; æš‚å­˜ä¸‹ eaxï¼Œæ¥ä¸‹æ¥ eax è¦ç®—ä¸‹æ ‡
</span><span class=c></span>    <span class=no>shl</span> <span class=no>eax</span><span class=p>,</span> <span class=mi>2</span><span class=no>h</span>                             <span class=c>; å·¦ç§» 2 ä½ï¼Œç­‰äº eax *= 4
</span><span class=c></span>    <span class=no>add</span> <span class=no>edi</span><span class=p>,</span> <span class=no>eax</span>                            <span class=c>; å•°å—¦è¿™ä¹ˆå¤šå°±æ˜¯ä¸ºäº† edi = edi + eax * 4
</span><span class=c></span>    <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=no>ecx</span>                            <span class=c>; æ¢å¤ eax çš„å€¼
</span><span class=c></span>    
    <span class=no>mov</span> <span class=no>edi</span><span class=p>,</span> <span class=p>[</span><span class=no>ebx</span> <span class=err>+</span> <span class=no>edi</span><span class=p>]</span>                    <span class=c>; edi = *(åŸºå€+åç§°è¡¨RVA[ä¸‹æ ‡])ï¼Œæ³¨æ„æ­¤æ—¶æ‹¿åˆ°çš„è¿˜æ˜¯ä¸€ä¸ª RVA ï¼ŒæŒ‡å‘å¯¼å‡ºå‡½æ•°åå­—ç¬¦ä¸²
</span><span class=c></span>    <span class=no>add</span> <span class=no>edi</span><span class=p>,</span> <span class=no>ebx</span>                            <span class=c>; å°† RVA åŠ ä¸ŠåŸºå€ï¼Œå¾—åˆ°å®Œæ•´çš„åœ°å€
</span><span class=c></span>    <span class=no>mov</span> <span class=no>cx</span><span class=p>,</span> <span class=mi>8</span>                               <span class=c>; repe cmpsb ä½¿ç”¨ cx å¯„å­˜å™¨æ¥è®¡æ•°ï¼ŒWinExec é•¿åº¦æ˜¯ 7ï¼ŒåŠ ä¸Š NUL å°±æ˜¯ 8 ä¸ªå­—ç¬¦
</span><span class=c></span>    <span class=no>repe</span> <span class=no>cmpsb</span>                              <span class=c>; å­—ç¬¦ä¸²æ¯”è¾ƒ
</span><span class=c></span>    
    <span class=no>jz</span> <span class=no>.found</span>                               <span class=c>; å¦‚æœ repe cmpsb å¾—åˆ°çš„ç»“æœæ˜¯ç›¸åŒï¼Œé‚£ä¹ˆå½“å‰ä¸‹æ ‡ eax å°±æ˜¯ WinExec äº†ï¼Œè·³è½¬å‡ºå¾ªç¯
</span><span class=c></span>    <span class=no>inc</span> <span class=no>eax</span>                                 <span class=c>; å¦åˆ™ä¸‹æ ‡è‡ªå¢
</span><span class=c></span>    <span class=no>cmp</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>ebp-numberof_export_entries</span><span class=p>]</span>  <span class=c>; å¦‚æœå½“å‰ä¸‹æ ‡è¿˜ä¸ç­‰äºå¯¼å‡ºæ€»æ•°
</span><span class=c></span>    <span class=no>jne</span> <span class=no>.findWinExecLocation</span>                <span class=c>; ç»§ç»­å¾ªç¯
</span><span class=c></span>    
<span class=no>.found</span><span class=p>:</span>
</code></pre></div><p>æœ€å¤æ‚çš„éƒ¨åˆ†å°±æ˜¯ç®—åç§»ï¼Œåœ¨ C ä¸­ä¸€ä¸ªä¸‹æ ‡è¿ç®—åˆæˆ–è€…æŒ‡é’ˆè§£å¼•ç”¨çš„äº‹æƒ…åœ¨æ±‡ç¼–é‡Œå°±å¾ˆè›‹ç–¼ã€‚</p>
<h3 id=26-å–-ordinal-å’Œå‡½æ•°åœ°å€>2.6 å– Ordinal å’Œå‡½æ•°åœ°å€</h3>
<p>å¾—åˆ°æ­£ç¡®ä¸‹æ ‡åå°±å¯ä»¥å– Ordinal äº†ã€‚å…ˆæŠŠ ordinal è¡¨çš„åœ°å€å’Œ å‡½æ•°åœ°å€è¡¨çš„åœ°å€æ”¾è¿›å¯„å­˜å™¨ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm>    <span class=nf>mov</span> <span class=no>ecx</span><span class=p>,</span> <span class=p>[</span><span class=no>ebp-address_of_ordinal_table</span><span class=p>]</span>
    <span class=nf>mov</span> <span class=no>edx</span><span class=p>,</span> <span class=p>[</span><span class=no>ebp-address_of_func_address_table</span><span class=p>]</span>
</code></pre></div><p>ç„¶åç”¨ eax åšä¸‹æ ‡ï¼Œå– ordinal å€¼ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm>    <span class=nf>mov</span> <span class=no>ax</span><span class=p>,</span> <span class=p>[</span><span class=no>ecx</span><span class=err>+</span><span class=no>eax</span><span class=p>*</span><span class=mi>2</span><span class=p>]</span>                                 <span class=c>; ax(ordinal) = ((WORD*)ordinal_table)[eax]
</span></code></pre></div><p>å†æ‹¿ Ordinal å€¼åšä¸‹æ ‡ï¼Œå–å‡½æ•°åœ°å€ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm>    <span class=nf>mov</span> <span class=no>eax</span><span class=p>,[</span><span class=no>edx</span><span class=err>+</span><span class=no>eax</span><span class=p>*</span><span class=mi>4</span><span class=p>]</span>                                 <span class=c>; eax = ((DWORD*)address_table)[eax]
</span></code></pre></div><p>æœ€åæŠŠå‡½æ•°åœ°å€ï¼ˆRVAï¼‰åŠ ä¸ŠåŸºå€ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm>    <span class=nf>add</span> <span class=no>eax</span><span class=p>,</span> <span class=no>ebx</span>                                        <span class=c>; eax=WinExec å‡½æ•°çš„åœ°å€
</span></code></pre></div><p>å¾—åˆ° <code>WinExec</code> å‡½æ•°åœ¨å†…å­˜ä¸­çš„åœ°å€ã€‚</p>
<h3 id=27-è°ƒç”¨-winexec-å‡½æ•°>2.7 è°ƒç”¨ WinExec å‡½æ•°</h3>
<p>Windows API éƒ½æ˜¯ <em>stdcall</em> è°ƒç”¨çº¦å®šï¼Œæˆ‘ä»¬ä¸ç”¨ç®¡æ¸…æ ˆï¼Œç›´æ¥å‹å‚æ•°å°±å¥½ã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm>    <span class=nf>push</span> <span class=mi>10</span>                                             <span class=c>; SW_SHOWDEFAULT
</span><span class=c></span>    <span class=no>push</span> <span class=no>str_calcexe</span>                                    <span class=c>; å­—ç¬¦ä¸² calc.exe
</span><span class=c></span>    <span class=no>call</span> <span class=no>eax</span>                                            <span class=c>; __stdcall WinExec
</span></code></pre></div><p>åˆ°è¿™é‡Œï¼Œåº”è¯¥å°±æˆåŠŸè°ƒç”¨äº† <code>WinExec</code> å‡½æ•°äº†ã€‚</p>
<h3 id=28-æ¸…ç†å’Œé€€å‡º>2.8 æ¸…ç†å’Œé€€å‡º</h3>
<p>å†™å®Œäº†ä¸»è¦åŠŸèƒ½ï¼Œæ¥ä¸‹æ¥å°±è¦ç»™è‡ªå·±æ“¦å±è‚¡äº†ï¼Œå¹³æ ˆã€‚</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm>    <span class=nf>add</span> <span class=no>esp</span><span class=p>,</span> <span class=mi>1</span><span class=no>ch</span>
    <span class=nf>pop</span> <span class=no>ebp</span>
    <span class=nf>xor</span> <span class=no>eax</span><span class=p>,</span> <span class=no>eax</span>
    <span class=nf>retn</span>
</code></pre></div><p>æ”¶å·¥ï¼</p>
<h3 id=29-å®Œæ•´ä»£ç >2.9 å®Œæ•´ä»£ç </h3>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=err>%</span><span class=nf>define</span> <span class=no>kernel32_base</span> <span class=mi>0x04</span>
<span class=err>%</span><span class=nf>define</span> <span class=no>numberof_export_entries</span> <span class=mi>0x08</span>
<span class=err>%</span><span class=nf>define</span> <span class=no>address_of_ordinal_table</span> <span class=mi>0x0c</span>
<span class=err>%</span><span class=nf>define</span> <span class=no>address_of_func_address_table</span> <span class=mi>0x10</span>
<span class=err>%</span><span class=nf>define</span> <span class=no>address_of_export_directory_table</span> <span class=mi>0x14</span>
<span class=err>%</span><span class=nf>define</span> <span class=no>address_of_name_table</span> <span class=mi>0x18</span>
<span class=err>%</span><span class=nf>define</span> <span class=no>ordinal_base</span> <span class=mi>0x1c</span>

<span class=nf>section</span> <span class=no>.text</span>
    <span class=nf>global</span> <span class=no>_main</span>
<span class=nl>_main:</span>
    <span class=nf>push</span> <span class=no>ebp</span>
    <span class=nf>mov</span> <span class=no>ebp</span><span class=p>,</span> <span class=no>esp</span>
    <span class=nf>sub</span> <span class=no>esp</span><span class=p>,</span> <span class=mi>1</span><span class=no>ch</span>

    <span class=c>; è·å– kernel32.dll åŸºå€
</span><span class=c></span>    <span class=nf>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>fs</span><span class=p>:</span><span class=mi>30</span><span class=no>h</span><span class=p>]</span>               <span class=c>; eax = TEB-&gt;PEB
</span><span class=c></span>    <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>eax</span><span class=err>+</span><span class=mi>0</span><span class=no>ch</span><span class=p>]</span>              <span class=c>; eax = PEB-&gt;Ldr
</span><span class=c></span>    <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>eax</span><span class=err>+</span><span class=mi>14</span><span class=no>h</span><span class=p>]</span>              <span class=c>; eax = PEB_LDR_DATA-&gt;InMemoryOrderModuleList.Flink (å½“å‰ç¨‹åº)
</span><span class=c></span>    <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>eax</span><span class=p>]</span>                  <span class=c>; eax = &amp;_LDR_DATA_TABLE_ENTRY.InMemoryOrderModuleList.Flink (ç°åœ¨æ˜¯ ntdll.dll)
</span><span class=c></span>    <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>eax</span><span class=p>]</span>                  <span class=c>; eax = &amp;_LDR_DATA_TABLE_ENTRY.InMemoryOrderModuleList.Flink (ç°åœ¨æ˜¯ kernel32.dll)
</span><span class=c></span>    <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>eax-8h</span><span class=err>+</span><span class=mi>18</span><span class=no>h</span><span class=p>]</span>           <span class=c>; eax = &amp;_LDR_DATA_TABLE_ENTRY.DllBase (kernel32.dll åŸºå€)
</span><span class=c></span>
    <span class=nf>mov</span> <span class=no>ebx</span><span class=p>,</span> <span class=no>eax</span>                    <span class=c>; ebx -&gt; kernel32.dll åŸºå€
</span><span class=c></span>    <span class=no>mov</span> <span class=p>[</span><span class=no>ebp-kernel32_base</span><span class=p>],</span> <span class=no>eax</span>    <span class=c>; kernel32_base -&gt; kernel32.dll åŸºå€
</span><span class=c></span>
    <span class=nf>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>ebx</span><span class=err>+</span><span class=mi>3</span><span class=no>ch</span><span class=p>]</span>
    <span class=nf>add</span> <span class=no>eax</span><span class=p>,</span> <span class=no>ebx</span>                    <span class=c>; eax -&gt; kernel32.dll çš„ pe æ–‡ä»¶å¤´
</span><span class=c></span>
    <span class=nf>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>eax</span><span class=err>+</span><span class=mi>78</span><span class=no>h</span><span class=p>]</span>              <span class=c>; eax -&gt; ExportDirectory.VirtualAddress
</span><span class=c></span>    <span class=no>add</span> <span class=no>eax</span><span class=p>,</span> <span class=no>ebx</span>                    <span class=c>; eax -&gt; Export Directory Table
</span><span class=c></span>
    <span class=nf>mov</span> <span class=no>ecx</span><span class=p>,</span> <span class=no>eax</span>                                        <span class=c>; æš‚å­˜å¯¼å‡ºè¡¨ç»“æ„åŸºå€ç”¨æ¥è¿ç®—
</span><span class=c></span>    <span class=no>mov</span> <span class=p>[</span><span class=no>ebp-address_of_export_directory_table</span><span class=p>],</span> <span class=no>eax</span>    <span class=c>; ä¿å­˜å¯¼å‡ºè¡¨ç»“æ„åŸºå€åˆ°æ ˆå˜é‡
</span><span class=c></span>    <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>eax</span><span class=err>+</span><span class=mi>1</span><span class=no>ch</span><span class=p>]</span>
    <span class=nf>add</span> <span class=no>eax</span><span class=p>,</span> <span class=no>ebx</span>
    <span class=nf>mov</span> <span class=p>[</span><span class=no>ebp-address_of_func_address_table</span><span class=p>],</span> <span class=no>eax</span>        <span class=c>; ä¿å­˜å¯¼å‡ºå‡½æ•°è¡¨åœ°å€åˆ°æ ˆå˜é‡
</span><span class=c></span>    <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=no>ecx</span>
    <span class=nf>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>eax</span><span class=err>+</span><span class=mi>24</span><span class=no>h</span><span class=p>]</span>
    <span class=nf>add</span> <span class=no>eax</span><span class=p>,</span> <span class=no>ebx</span>
    <span class=nf>mov</span> <span class=p>[</span><span class=no>ebp-address_of_ordinal_table</span><span class=p>],</span> <span class=no>eax</span>             <span class=c>; ä¿å­˜ordinalè¡¨åœ°å€åˆ°æ ˆå˜é‡
</span><span class=c></span>    <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=no>ecx</span>
    <span class=nf>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>eax</span><span class=err>+</span><span class=mi>18</span><span class=no>h</span><span class=p>]</span>
    <span class=nf>mov</span> <span class=p>[</span><span class=no>ebp-numberof_export_entries</span><span class=p>],</span> <span class=no>eax</span>              <span class=c>; ä¿å­˜å¯¼å‡ºè¡¨(name)æ•°é‡åˆ°æ ˆå˜é‡
</span><span class=c></span>    <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=no>ecx</span>
    <span class=nf>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>eax</span><span class=err>+</span><span class=mi>20</span><span class=no>h</span><span class=p>]</span>                                  <span class=c>; eax=ç¬¬ä¸€ä¸ªå‡½æ•°åç§°çš„ RVA
</span><span class=c></span>    <span class=no>mov</span> <span class=p>[</span><span class=no>ebp-address_of_name_table</span><span class=p>],</span> <span class=no>eax</span>                <span class=c>; ä¿å­˜å¯¼å‡ºå‡½æ•°çš„åç§°è¡¨åˆ°æ ˆå˜é‡
</span><span class=c></span>    <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=no>ecx</span>
    <span class=nf>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>eax</span><span class=err>+</span><span class=mi>10</span><span class=no>h</span><span class=p>]</span>
    <span class=nf>mov</span> <span class=p>[</span><span class=no>ebp-ordinal_base</span><span class=p>],</span> <span class=no>eax</span>                         <span class=c>; ä¿å­˜ ordinal base ç”¨äºè®¡ç®—å¯¼å‡ºå‡½æ•°çš„åœ°å€
</span><span class=c></span>
    <span class=nf>xor</span> <span class=no>eax</span><span class=p>,</span><span class=no>eax</span>
    <span class=nf>xor</span> <span class=no>ecx</span><span class=p>,</span><span class=no>ecx</span>
<span class=nl>.findWinExecLocation:</span>
    <span class=nf>mov</span> <span class=no>esi</span><span class=p>,</span> <span class=no>str_winexec</span>                    <span class=c>; å‡†å¤‡æ¯”è¾ƒï¼Œesi=å¸¸é‡å­—ç¬¦ä¸²
</span><span class=c></span>    <span class=no>mov</span> <span class=no>edi</span><span class=p>,</span> <span class=p>[</span><span class=no>ebp-address_of_name_table</span><span class=p>]</span>    <span class=c>; å‡†å¤‡æ¯”è¾ƒï¼Œedi=åç§°è¡¨é¦–å…ƒç´ 
</span><span class=c></span>    <span class=no>cld</span>                                     <span class=c>; æ¸…é™¤ df æ ‡å¿—ä½
</span><span class=c></span>
    <span class=nf>mov</span> <span class=no>ecx</span><span class=p>,</span> <span class=no>eax</span>                            <span class=c>; æš‚å­˜ä¸‹ eaxï¼Œæ¥ä¸‹æ¥ eax è¦ç®—ä¸‹æ ‡
</span><span class=c></span>    <span class=no>shl</span> <span class=no>eax</span><span class=p>,</span> <span class=mi>2</span><span class=no>h</span>                             <span class=c>; å·¦ç§» 2 ä½ï¼Œç­‰äº eax *= 4
</span><span class=c></span>    <span class=no>add</span> <span class=no>edi</span><span class=p>,</span> <span class=no>eax</span>                            <span class=c>; å•°å—¦è¿™ä¹ˆå¤šå°±æ˜¯ä¸ºäº† edi = edi + eax * 4
</span><span class=c></span>    <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span> <span class=no>ecx</span>                            <span class=c>; æ¢å¤ eax çš„å€¼
</span><span class=c></span>
    <span class=nf>mov</span> <span class=no>edi</span><span class=p>,</span> <span class=p>[</span><span class=no>ebx</span> <span class=err>+</span> <span class=no>edi</span><span class=p>]</span>                    <span class=c>; edi = *(åŸºå€+åç§°è¡¨RVA[ä¸‹æ ‡])ï¼Œæ³¨æ„æ­¤æ—¶æ‹¿åˆ°çš„è¿˜æ˜¯ä¸€ä¸ª RVA ï¼ŒæŒ‡å‘å¯¼å‡ºå‡½æ•°åå­—ç¬¦ä¸²
</span><span class=c></span>    <span class=no>add</span> <span class=no>edi</span><span class=p>,</span> <span class=no>ebx</span>                            <span class=c>; å°† RVA åŠ ä¸ŠåŸºå€ï¼Œå¾—åˆ°å®Œæ•´çš„åœ°å€
</span><span class=c></span>    <span class=no>mov</span> <span class=no>cx</span><span class=p>,</span> <span class=mi>8</span>                               <span class=c>; repe cmpsb ä½¿ç”¨ cx å¯„å­˜å™¨æ¥è®¡æ•°ï¼ŒWinExec é•¿åº¦æ˜¯ 7ï¼ŒåŠ ä¸Š NUL å°±æ˜¯ 8 ä¸ªå­—ç¬¦
</span><span class=c></span>    <span class=no>repe</span> <span class=no>cmpsb</span>                              <span class=c>; å­—ç¬¦ä¸²æ¯”è¾ƒ
</span><span class=c></span>
    <span class=nf>jz</span> <span class=no>.found</span>                               <span class=c>; å¦‚æœ repe cmpsb å¾—åˆ°çš„ç»“æœæ˜¯ç›¸åŒï¼Œé‚£ä¹ˆå½“å‰ä¸‹æ ‡ eax å°±æ˜¯ WinExec äº†ï¼Œè·³è½¬å‡ºå¾ªç¯
</span><span class=c></span>    <span class=no>inc</span> <span class=no>eax</span>                                 <span class=c>; å¦åˆ™ä¸‹æ ‡è‡ªå¢
</span><span class=c></span>    <span class=no>cmp</span> <span class=no>eax</span><span class=p>,</span> <span class=p>[</span><span class=no>ebp-numberof_export_entries</span><span class=p>]</span>  <span class=c>; å¦‚æœå½“å‰ä¸‹æ ‡è¿˜ä¸ç­‰äºå¯¼å‡ºæ€»æ•°
</span><span class=c></span>    <span class=no>jne</span> <span class=no>.findWinExecLocation</span>                <span class=c>; ç»§ç»­å¾ªç¯
</span><span class=c></span>
<span class=nl>.found:</span>
    <span class=nf>mov</span> <span class=no>ecx</span><span class=p>,</span> <span class=p>[</span><span class=no>ebp-address_of_ordinal_table</span><span class=p>]</span>
    <span class=nf>mov</span> <span class=no>edx</span><span class=p>,</span> <span class=p>[</span><span class=no>ebp-address_of_func_address_table</span><span class=p>]</span>

    <span class=nf>mov</span> <span class=no>ax</span><span class=p>,</span> <span class=p>[</span><span class=no>ecx</span><span class=err>+</span><span class=no>eax</span><span class=p>*</span><span class=mi>2</span><span class=p>]</span>                                 <span class=c>; ax(ordinal) = ((WORD*)ordinal_table)[eax]
</span><span class=c></span>    <span class=no>mov</span> <span class=no>eax</span><span class=p>,[</span><span class=no>edx</span><span class=err>+</span><span class=no>eax</span><span class=p>*</span><span class=mi>4</span><span class=p>]</span>                                 <span class=c>; eax = ((DWORD*)address_table)[eax]
</span><span class=c></span>    <span class=no>add</span> <span class=no>eax</span><span class=p>,</span> <span class=no>ebx</span>                                        <span class=c>; eax=WinExec å‡½æ•°çš„åœ°å€
</span><span class=c></span>
    <span class=nf>push</span> <span class=mi>10</span>                                             <span class=c>; SW_SHOWDEFAULT
</span><span class=c></span>    <span class=no>push</span> <span class=no>str_calcexe</span>                                    <span class=c>; å­—ç¬¦ä¸² calc.exe
</span><span class=c></span>    <span class=no>call</span> <span class=no>eax</span>                                            <span class=c>; __stdcall WinExec
</span><span class=c></span>
    <span class=nf>add</span> <span class=no>esp</span><span class=p>,</span> <span class=mi>1</span><span class=no>ch</span>
    <span class=nf>pop</span> <span class=no>ebp</span>
    <span class=nf>xor</span> <span class=no>eax</span><span class=p>,</span> <span class=no>eax</span>
    <span class=nf>retn</span>

<span class=nf>section</span> <span class=no>.data</span>
    <span class=nl>str_winexec:</span>
        <span class=nf>db</span> <span class=err>&#39;</span><span class=no>WinExec</span><span class=err>&#39;</span><span class=p>,</span> <span class=mi>0</span>
    <span class=nl>str_calcexe:</span>
        <span class=nf>db</span> <span class=err>&#39;</span><span class=no>calc.exe</span><span class=err>&#39;</span><span class=p>,</span> <span class=mi>0</span>
</code></pre></div><h2 id=0x03-éªŒè¯>0x03 éªŒè¯</h2>
<p>éªŒè¯æ–¹æ³•å¾ˆç®€å•ï¼Œæˆ‘ä»¬ç¼–è¯‘ä¹‹ï¼Œè¿è¡Œï¼Œç„¶åå°±å¥½å•¦ï¼</p>
<p><img src=/blog/image/%e5%85%b3%e4%ba%8e%e5%9c%a8%e5%86%85%e5%ad%98%e9%87%8c%e6%89%bekernel32%e8%bf%99%e4%bb%b6%e4%ba%8b/image-20211014161140486.png loading=lazy alt=image-20211014161140486></p>
<p><code>WinExec</code> çš„è¿”å›å€¼åœ¨ eax é‡Œï¼Œå¾®è½¯çš„æ–‡æ¡£è¯´è¿”å›å€¼å¤§äº 31 å°±æ˜¯ OJBKï¼Œ0x21 æ˜¯10è¿›åˆ¶çš„33ï¼Œæ‰€ä»¥å®Œå…¨ OJBK ã€‚</p>
<h2 id=æ€»ç»“>æ€»ç»“</h2>
<p>è¿™æ˜¯å†™ shellcode çš„æŠ€æœ¯å§ï¼Œä¸œä¸€æ¦”å¤´è¥¿ä¸€æ£’å­å°±æ˜¯æˆ‘äº†ã€‚è¯è¯´ shellcode çš„å…·ä½“å®šä¹‰æ˜¯å•¥æ¥ç€ï¼Ÿæˆ‘åªå‰©èœäº†.jpg</p>
<p>æœ€ç»ˆä½“ä¼šå°±æ˜¯å†™è¿‡æ±‡ç¼–æ‰çŸ¥é“ C çœŸçš„æ˜¯å¾ˆé«˜çº§çš„è¯­è¨€äº†ï¼ˆ</p>
<p>çœŸè¦ç®—åœ°å€ç®—åç§»ä¸€ç®—ä¸€æ•´å¤©ï¼Œ365å¤©å¯¹ç€16è¿›åˆ¶æ•°åšåŠ å‡ä¹˜é™¤é‚£çœŸå°±æ˜¯æŠ˜ç£¨ã€‚</p>
<p>Windows æœªå…¬å¼€çš„æ•°æ®ç»“æ„ä¹Ÿä¸çŸ¥é“ç½‘ä¸Šçš„å¤§ä½¬éƒ½æ˜¯æ€ä¹ˆç ”ç©¶å‡ºæ¥çš„ï¼Œæ¯•ç«Ÿç†è®ºä¸Šæ¥è¯´æè¿™ä¸ªæ²¡æœ‰ä»»ä½•ä»·å€¼ï¼Œåœ¨é€†å‘ç ”ç©¶å‡ºç»“æœä¹‹å‰è°ä¹Ÿä¸çŸ¥é“è¿™äº›ä¸œè¥¿èƒ½å¸¦æ¥ä»€ä¹ˆä»·å€¼ï¼Œç”šè‡³ä½ æå®Œäº†ä¹Ÿä¸çŸ¥é“æœ‰ä»€ä¹ˆä»·å€¼ï¼Œç›´åˆ°æœ‰ä¸€å¤©è¢«æ­£å¥½æœ‰éœ€è¦çš„äººå‘ç°ï¼ˆå¤§é»‘é˜”ï¼šç°æˆçš„æ´ï¼Œå¥½è€¶ï¼‰ã€‚</p>
<p>å—¯ï¼Œè¿™ä¸ªæƒ³æ³•å°±è®©äººæ¯”è¾ƒå…´å¥‹ï¼Œé¡¿æ—¶æ„Ÿè§‰è‡ªå·±é—²å‡ºå±æ‘¸é±¼ä¹Ÿæ˜¯åœ¨ä¸ºç¤¾ä¼šåˆ›é€ ä»·å€¼äº†å‘¢~</p>
<p>å¦å¤–å…³äºå¦‚ä½•ç”¨ C å†™ shellcodeï¼Œå…¶å®æˆ‘æƒ³äº†ä¸‹ï¼Œä¹Ÿè®¸å¯ä»¥è®©ç¼–è¯‘å™¨æŠŠæ±‡ç¼–åå‡ºæ¥ï¼Œç„¶åä»é‡Œé¢æ‹¿å’±éœ€è¦çš„ä»£ç ï¼Ÿä¸è¿‡è¿™ä¹Ÿä¸çŸ¥é“æ€ä¹ˆç¼–è¯‘å™¨åå‡ºèƒ½è®© nasm æ¥å—çš„æ±‡ç¼–ã€‚æˆ–è€…æœ‰å•¥æ¯”è¾ƒä¸šç•Œé€šè¡Œçš„è¯­æ³•æ ‡å‡†ï¼ŸåªçŸ¥é“æœ‰ AT&T å’Œ Intel ä¸¤ç§é£æ ¼ï¼Œä½†éè¦è¯´çš„è¯ nasm å’Œ masm éƒ½æœ‰äº›ä¸å…¼å®¹ï¼Œå°½ç®¡éƒ½æ˜¯ Intel é£æ ¼ï¼ˆå¤§æ¦‚ï¼‰ã€‚æˆ–è€…å°±æ˜¯è®©ç¼–è¯‘å™¨åä¸ª obj æ–‡ä»¶å‡ºæ¥ï¼Œç„¶åè§£æè¿™ä¸ª obj ï¼Œæå–é‡Œé¢çš„äºŒè¿›åˆ¶ä»£ç å°±å¥½ã€‚</p>
<p>å¥½äº†çbbå®Œæ¯•ã€‚æ”¶å·¥å•¦ã€‚</p>
</section>
<footer class=article-footer>
<section class=article-tags>
<a href=/blog/tags/%E6%B1%87%E7%BC%96/>æ±‡ç¼–</a>
<a href=/blog/tags/%E9%80%86%E5%90%91/>é€†å‘</a>
<a href=/blog/tags/windows/>windows</a>
</section>
<section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
</footer>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css integrity=sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js integrity=sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js integrity=sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.querySelector(`.article-content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script>
</article>
<aside class=related-contents--wrapper>
<h2 class=section-title>ç›¸å…³æ–‡ç« </h2>
<div class=related-contents>
<div class="flex article-list--tile">
<article class=has-image>
<a href=/blog/p/learning-packer-02/>
<div class=article-image>
<img src=/blog/p/learning-packer-02/cover.303a5ee85ad8275c094df5988adf0791_hu8b7651a2bda3b235d3ed49f67a1e20bd_99156_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post åŠ å£³åŸç†02 - ç®€å•åŠ å£³æœº" data-key=learning-packer-02 data-hash="md5-MDpe6FrYJ1wJTfWYit8HkQ==">
</div>
<div class=article-details>
<h2 class=article-title>åŠ å£³åŸç†02 - ç®€å•åŠ å£³æœº</h2>
</div>
</a>
</article>
<article class=has-image>
<a href=/blog/p/learning-packer-08/>
<div class=article-image>
<img src=/blog/p/learning-packer-08/cover.303a5ee85ad8275c094df5988adf0791_hu8b7651a2bda3b235d3ed49f67a1e20bd_99156_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post åŠ å£³åŸç†08ï¼šæ··æ·†æŠ€æœ¯å…¥é—¨" data-key=learning-packer-08 data-hash="md5-MDpe6FrYJ1wJTfWYit8HkQ==">
</div>
<div class=article-details>
<h2 class=article-title>åŠ å£³åŸç†08ï¼šæ··æ·†æŠ€æœ¯å…¥é—¨</h2>
</div>
</a>
</article>
<article class=has-image>
<a href=/blog/p/learning-packer-07/>
<div class=article-image>
<img src=/blog/p/learning-packer-07/cover.303a5ee85ad8275c094df5988adf0791_hu8b7651a2bda3b235d3ed49f67a1e20bd_99156_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post åŠ å£³åŸç†07 - èŠ±æŒ‡ä»¤å…¥é—¨" data-key=learning-packer-07 data-hash="md5-MDpe6FrYJ1wJTfWYit8HkQ==">
</div>
<div class=article-details>
<h2 class=article-title>åŠ å£³åŸç†07 - èŠ±æŒ‡ä»¤å…¥é—¨</h2>
</div>
</a>
</article>
<article class=has-image>
<a href=/blog/p/learning-packer-06/>
<div class=article-image>
<img src=/blog/p/learning-packer-06/cover.303a5ee85ad8275c094df5988adf0791_hu8b7651a2bda3b235d3ed49f67a1e20bd_99156_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post åŠ å£³åŸç†06ï¼šåè°ƒè¯•æŠ€æœ¯å…¥é—¨" data-key=learning-packer-06 data-hash="md5-MDpe6FrYJ1wJTfWYit8HkQ==">
</div>
<div class=article-details>
<h2 class=article-title>åŠ å£³åŸç†06ï¼šåè°ƒè¯•æŠ€æœ¯å…¥é—¨</h2>
</div>
</a>
</article>
<article class=has-image>
<a href=/blog/p/learning-packer-04-zlib-compression-packer-demo/>
<div class=article-image>
<img src=/blog/p/learning-packer-04-zlib-compression-packer-demo/cover.303a5ee85ad8275c094df5988adf0791_hu8b7651a2bda3b235d3ed49f67a1e20bd_99156_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post åŠ å£³åŸç†04 - zlibå‹ç¼©å£³æ¡ˆä¾‹" data-key=learning-packer-04-zlib-compression-packer-demo data-hash="md5-MDpe6FrYJ1wJTfWYit8HkQ==">
</div>
<div class=article-details>
<h2 class=article-title>åŠ å£³åŸç†04 - zlibå‹ç¼©å£³æ¡ˆä¾‹</h2>
</div>
</a>
</article>
</div>
</div>
</aside>
<link rel=stylesheet href=https://unpkg.com/vssue/dist/vssue.min.css>
<div id=vssue></div>
<script src=https://unpkg.com/vue@2.6.14/dist/vue.runtime.min.js></script>
<script src=https://unpkg.com/vssue@1.4.8/dist/vssue.github.min.js></script>
<script>new Vue({el:"#vssue",render:a=>a("Vssue",{props:{title:"å…³äºåœ¨å†…å­˜é‡Œæ‰¾kernel32è¿™ä»¶äº‹",options:{autoCreateIssue:!0,owner:"nnnewb",repo:"blog",clientId:"285910fdc1567a1a23e3",clientSecret:"f00da5438d9ac82c4a86024866c7a916ae411edc"}}})})</script>
<footer class=site-footer>
<section class=copyright>
&copy;
2021 -
2022 weakptr's ç¬”è®°
</section>
<section class=powerby>
GitHub Pages <br>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.10.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a>
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main>
<aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div>
<h2 class="widget-title section-title">ç›®å½•</h2>
<div class=widget--toc>
<nav id=TableOfContents>
<ol>
<li><a href=#å‰è¨€>å‰è¨€</a></li>
<li><a href=#0x01-å¯»æ‰¾-kernel32>0x01 å¯»æ‰¾ kernel32</a>
<ol>
<li><a href=#11--process-environment-block>1.1 Process Environment Block</a></li>
<li><a href=#12-peb_ldr_data>1.2 PEB_LDR_DATA</a></li>
<li><a href=#13-ldr_data_table_entry>1.3 LDR_DATA_TABLE_ENTRY</a></li>
<li><a href=#14-æ¨¡å—åŸºå€>1.4 æ¨¡å—åŸºå€</a></li>
<li><a href=#15-teb-çš„ä½ç½®>1.5 TEB çš„ä½ç½®</a></li>
<li><a href=#16-è·å–-kernel-32-åŸºå€>1.6 è·å– kernel 32 åŸºå€</a></li>
</ol>
</li>
<li><a href=#0x02-å¯»æ‰¾-winexec-å‡½æ•°>0x02 å¯»æ‰¾ WinExec å‡½æ•°</a>
<ol>
<li><a href=#21-å¯»æ‰¾å¯¼å‡ºè¡¨>2.1 å¯»æ‰¾å¯¼å‡ºè¡¨</a></li>
<li><a href=#22-åˆ†é…æ ˆå˜é‡>2.2 åˆ†é…æ ˆå˜é‡</a></li>
<li><a href=#23-åˆ†æ-export-directory-table>2.3 åˆ†æ Export Directory Table</a></li>
<li><a href=#24-å¯¼å‡ºè¡¨å’Œå‡½æ•°åœ°å€>2.4 å¯¼å‡ºè¡¨å’Œå‡½æ•°åœ°å€</a></li>
<li><a href=#25-éå†åç§°è¡¨>2.5 éå†åç§°è¡¨</a></li>
<li><a href=#26-å–-ordinal-å’Œå‡½æ•°åœ°å€>2.6 å– Ordinal å’Œå‡½æ•°åœ°å€</a></li>
<li><a href=#27-è°ƒç”¨-winexec-å‡½æ•°>2.7 è°ƒç”¨ WinExec å‡½æ•°</a></li>
<li><a href=#28-æ¸…ç†å’Œé€€å‡º>2.8 æ¸…ç†å’Œé€€å‡º</a></li>
<li><a href=#29-å®Œæ•´ä»£ç >2.9 å®Œæ•´ä»£ç </a></li>
</ol>
</li>
<li><a href=#0x03-éªŒè¯>0x03 éªŒè¯</a></li>
<li><a href=#æ€»ç»“>æ€»ç»“</a></li>
</ol>
</nav>
</div>
</section>
</aside>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/blog/ts/main.js defer></script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>